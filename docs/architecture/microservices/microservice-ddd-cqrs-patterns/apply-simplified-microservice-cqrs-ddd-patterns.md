---
title: Применение упрощенных шаблонов CQRS и DDD в микрослужбах
description: Архитектура микрослужб .NET для контейнерных приложений .NET | Понимание отношения между шаблонами CQRS и DDD.
ms.date: 01/13/2021
ms.openlocfilehash: c1a990689a446e2efba48beafe4b55d614b54427
ms.sourcegitcommit: a4cecb7389f02c27e412b743f9189bd2a6dea4d6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98188963"
---
# <a name="apply-simplified-cqrs-and-ddd-patterns-in-a-microservice"></a><span data-ttu-id="caff6-103">Применение в микрослужбе упрощенных шаблонов CQRS и DDD</span><span class="sxs-lookup"><span data-stu-id="caff6-103">Apply simplified CQRS and DDD patterns in a microservice</span></span>

<span data-ttu-id="caff6-104">CQRS — это шаблон архитектуры, который разделяет модели для чтения и записи данных.</span><span class="sxs-lookup"><span data-stu-id="caff6-104">CQRS is an architectural pattern that separates the models for reading and writing data.</span></span> <span data-ttu-id="caff6-105">Соответствующее понятие [Разделение команд и запросов (CQS)](https://martinfowler.com/bliki/CommandQuerySeparation.html) было дано Бертраном Мейером в его книге *Объектно-ориентированное конструирование программных систем*.</span><span class="sxs-lookup"><span data-stu-id="caff6-105">The related term [Command Query Separation (CQS)](https://martinfowler.com/bliki/CommandQuerySeparation.html) was originally defined by Bertrand Meyer in his book *Object-Oriented Software Construction*.</span></span> <span data-ttu-id="caff6-106">Базовая идея состоит в том, что вы можете разделить операции системы на две четкие категории:</span><span class="sxs-lookup"><span data-stu-id="caff6-106">The basic idea is that you can divide a system's operations into two sharply separated categories:</span></span>

- <span data-ttu-id="caff6-107">Запросы.</span><span class="sxs-lookup"><span data-stu-id="caff6-107">Queries.</span></span> <span data-ttu-id="caff6-108">Возвращают результат, не изменяют состояние системы и не обладают побочными эффектами.</span><span class="sxs-lookup"><span data-stu-id="caff6-108">These queries return a result and do not change the state of the system, and they are free of side effects.</span></span>

- <span data-ttu-id="caff6-109">Команды.</span><span class="sxs-lookup"><span data-stu-id="caff6-109">Commands.</span></span> <span data-ttu-id="caff6-110">Изменяют состояние системы.</span><span class="sxs-lookup"><span data-stu-id="caff6-110">These commands change the state of a system.</span></span>

<span data-ttu-id="caff6-111">CQS — простое понятие. Оно означает, что методы в одном и том же объекте должны быть либо запросами, либо командами.</span><span class="sxs-lookup"><span data-stu-id="caff6-111">CQS is a simple concept: it is about methods within the same object being either queries or commands.</span></span> <span data-ttu-id="caff6-112">Каждый метод возвращает состояние или изменяет состояние, но не делает и то, и другое одновременно.</span><span class="sxs-lookup"><span data-stu-id="caff6-112">Each method either returns state or mutates state, but not both.</span></span> <span data-ttu-id="caff6-113">Объект шаблона даже одного репозитория может соответствовать CQS.</span><span class="sxs-lookup"><span data-stu-id="caff6-113">Even a single repository pattern object can comply with CQS.</span></span> <span data-ttu-id="caff6-114">CQS может считаться фундаментальным принципом CQRS.</span><span class="sxs-lookup"><span data-stu-id="caff6-114">CQS can be considered a foundational principle for CQRS.</span></span>

<span data-ttu-id="caff6-115">Принцип [разделения ответственности команд и запросов (CQRS)](https://martinfowler.com/bliki/CQRS.html) был введен Грегом Янгом и активно распространяется Уди Даханом и другими.</span><span class="sxs-lookup"><span data-stu-id="caff6-115">[Command and Query Responsibility Segregation (CQRS)](https://martinfowler.com/bliki/CQRS.html) was introduced by Greg Young and strongly promoted by Udi Dahan and others.</span></span> <span data-ttu-id="caff6-116">Он основан на принципе CQS, но более детален.</span><span class="sxs-lookup"><span data-stu-id="caff6-116">It is based on the CQS principle, although it is more detailed.</span></span> <span data-ttu-id="caff6-117">Его можно рассматривать как шаблон, основанный на командах и событиях с возможностью использовать асинхронные сообщения.</span><span class="sxs-lookup"><span data-stu-id="caff6-117">It can be considered a pattern based on commands and events plus optionally on asynchronous messages.</span></span> <span data-ttu-id="caff6-118">Во многих случаях CQRS относится к более сложным сценариям, например, использование отдельных баз данных для операций чтения (запросов) и для операций записи (обновлений).</span><span class="sxs-lookup"><span data-stu-id="caff6-118">In many cases, CQRS is related to more advanced scenarios, like having a different physical database for reads (queries) than for writes (updates).</span></span> <span data-ttu-id="caff6-119">Кроме того, в более сложной системе CQRS можно реализовать [Использование событий в качестве источников (ES)](https://martinfowler.com/eaaDev/EventSourcing.html) и хранить в модели предметной области только события вместо данных о текущем состоянии.</span><span class="sxs-lookup"><span data-stu-id="caff6-119">Moreover, a more evolved CQRS system might implement [Event-Sourcing (ES)](https://martinfowler.com/eaaDev/EventSourcing.html) for your updates database, so you would only store events in the domain model instead of storing the current-state data.</span></span> <span data-ttu-id="caff6-120">Однако в данном руководстве этот подход не применяется.</span><span class="sxs-lookup"><span data-stu-id="caff6-120">However, this approach is not used in this guide.</span></span> <span data-ttu-id="caff6-121">Здесь используем простой подход CQRS, который включает только отделение запросов от команд.</span><span class="sxs-lookup"><span data-stu-id="caff6-121">This guide uses the simplest CQRS approach, which consists of just separating the queries from the commands.</span></span>

<span data-ttu-id="caff6-122">Это отделение в CQRS достигается за счет группирования операций запроса на одном уровне и команд на другом уровне.</span><span class="sxs-lookup"><span data-stu-id="caff6-122">The separation aspect of CQRS is achieved by grouping query operations in one layer and commands in another layer.</span></span> <span data-ttu-id="caff6-123">На каждом уровне есть собственная модель данных (обратите внимание, что понятие "модель" не всегда означает другую базу данных), и она создается с использованием собственного сочетания шаблонов и технологий.</span><span class="sxs-lookup"><span data-stu-id="caff6-123">Each layer has its own data model (note that we say model, not necessarily a different database) and is built using its own combination of patterns and technologies.</span></span> <span data-ttu-id="caff6-124">Более того, эти два уровня могут находиться в пределах одного уровня или одной микрослужбы, как показано в примере, используемом в этом руководстве (микрослужба сортировки).</span><span class="sxs-lookup"><span data-stu-id="caff6-124">More importantly, the two layers can be within the same tier or microservice, as in the example (ordering microservice) used for this guide.</span></span> <span data-ttu-id="caff6-125">Или они могут быть реализованы в различных микрослужбах или процессах, чтобы их можно было оптимизировать и масштабировать отдельно, так чтобы они не влияли друг на друга.</span><span class="sxs-lookup"><span data-stu-id="caff6-125">Or they could be implemented on different microservices or processes so they can be optimized and scaled out separately without affecting one another.</span></span>

<span data-ttu-id="caff6-126">В CQRS для операций чтения и записи используются два объекта, а в других контекстах — один.</span><span class="sxs-lookup"><span data-stu-id="caff6-126">CQRS means having two objects for a read/write operation where in other contexts there is one.</span></span> <span data-ttu-id="caff6-127">База данных с денормализованными операциями чтения может быть удобной в некоторых ситуациях. О них можно узнать из более сложной литературы по CQRS.</span><span class="sxs-lookup"><span data-stu-id="caff6-127">There are reasons to have a denormalized reads database, which you can learn about in more advanced CQRS literature.</span></span> <span data-ttu-id="caff6-128">Но мы не будем использовать этот подход, так как наша цель — получить большую гибкость в запросах, а не ограничивать их из-за ограничений, присущих шаблонам DDD, таким как агрегаты.</span><span class="sxs-lookup"><span data-stu-id="caff6-128">But we are not using that approach here, where the goal is to have more flexibility in the queries instead of limiting the queries with constraints from DDD patterns like aggregates.</span></span>

<span data-ttu-id="caff6-129">Примером такого рода службы является микрослужба сортировки из примера приложения eShopOnContainers.</span><span class="sxs-lookup"><span data-stu-id="caff6-129">An example of this kind of service is the ordering microservice from the eShopOnContainers reference application.</span></span> <span data-ttu-id="caff6-130">Эта служба реализует микрослужбу на основе упрощенного подхода CQRS.</span><span class="sxs-lookup"><span data-stu-id="caff6-130">This service implements a microservice based on a simplified CQRS approach.</span></span> <span data-ttu-id="caff6-131">В нем используется один источник данных или база данных, но две логических модели, а также шаблоны DDD для транзакционного домена, как показано на рис. 7-2.</span><span class="sxs-lookup"><span data-stu-id="caff6-131">It uses a single data source or database, but two logical models plus DDD patterns for the transactional domain, as shown in Figure 7-2.</span></span>

![Схема, на которой показаны упрощенная микрослужба CQRS и DDD высокого уровня.](./media/apply-simplified-microservice-cqrs-ddd-patterns/simplified-cqrs-ddd-microservice.png)

<span data-ttu-id="caff6-133">**Рис. 7-2**.</span><span class="sxs-lookup"><span data-stu-id="caff6-133">**Figure 7-2**.</span></span> <span data-ttu-id="caff6-134">Упрощенная микрослужба на основе CQRS и DDD</span><span class="sxs-lookup"><span data-stu-id="caff6-134">Simplified CQRS- and DDD-based microservice</span></span>

<span data-ttu-id="caff6-135">Логическая микрослужба заказа включает свою базу данных заказа, которая может находиться в том же узле Docker.</span><span class="sxs-lookup"><span data-stu-id="caff6-135">The Logical "Ordering" Microservice includes its Ordering database, which can be, but doesn't have to be, the same Docker host.</span></span> <span data-ttu-id="caff6-136">Наличие базы данных в том же узле Docker хорошо подходит для разработки, но не подходит для рабочей среды.</span><span class="sxs-lookup"><span data-stu-id="caff6-136">Having the database in the same Docker host is good for development, but not for production.</span></span>

<span data-ttu-id="caff6-137">В качестве уровня приложения можно использовать само веб-API.</span><span class="sxs-lookup"><span data-stu-id="caff6-137">The application layer can be the Web API itself.</span></span> <span data-ttu-id="caff6-138">Важный аспект создания такой архитектуры состоит в том, что в соответствии с шаблоном CQRS микрослужба отделила запросы и модели представлений (модели данных, созданные специально для клиентских приложений) от команд, модели предметной области и транзакций.</span><span class="sxs-lookup"><span data-stu-id="caff6-138">The important design aspect here is that the microservice has split the queries and ViewModels (data models especially created for the client applications) from the commands, domain model, and transactions following the CQRS pattern.</span></span> <span data-ttu-id="caff6-139">Этот подход позволяет сохранить независимость запросов от ограничений шаблонов DDD, которые имеют смысл только для транзакций и обновлений, как описано в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="caff6-139">This approach keeps the queries independent from restrictions and constraints coming from DDD patterns that only make sense for transactions and updates, as explained in later sections.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="caff6-140">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="caff6-140">Additional resources</span></span>

- <span data-ttu-id="caff6-141">**Грег Янг (Greg Young). Управление версиями в системе источника событий** (бесплатная электронная книга) </span><span class="sxs-lookup"><span data-stu-id="caff6-141">**Greg Young. Versioning in an Event Sourced System** (Free to read online e-book) </span></span>\
   <https://leanpub.com/esversioning/read>

>[!div class="step-by-step"]
><span data-ttu-id="caff6-142">[Назад](index.md)
>[Вперед](eshoponcontainers-cqrs-ddd-microservice.md)</span><span class="sxs-lookup"><span data-stu-id="caff6-142">[Previous](index.md)
[Next](eshoponcontainers-cqrs-ddd-microservice.md)</span></span>
