---
title: Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers
description: Архитектура микрослужб .NET для контейнерных приложений .NET | Реализация CQRS в микрослужбе заказов в eShopOnContainers.
ms.date: 01/13/2021
ms.openlocfilehash: 0c07ecad0fb2dfdaea85d47b519b858e0519f6bd
ms.sourcegitcommit: a4cecb7389f02c27e412b743f9189bd2a6dea4d6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98188261"
---
# <a name="apply-cqrs-and-cqs-approaches-in-a-ddd-microservice-in-eshoponcontainers"></a><span data-ttu-id="5590b-103">Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers</span><span class="sxs-lookup"><span data-stu-id="5590b-103">Apply CQRS and CQS approaches in a DDD microservice in eShopOnContainers</span></span>

<span data-ttu-id="5590b-104">Проект микрослужбы заказов эталонного приложения eShopOnContainers построен на принципах CQRS.</span><span class="sxs-lookup"><span data-stu-id="5590b-104">The design of the ordering microservice at the eShopOnContainers reference application is based on CQRS principles.</span></span> <span data-ttu-id="5590b-105">Однако в нем применяется простейший подход, который просто разделяет запросы и команды и использует одну и ту же базу данных для обоих действий.</span><span class="sxs-lookup"><span data-stu-id="5590b-105">However, it uses the simplest approach, which is just separating the queries from the commands and using the same database for both actions.</span></span>

<span data-ttu-id="5590b-106">Важная отличительная особенность этих шаблонов — идемпотентность запросов. Это означает, что состояние системы не изменяется, независимо от количества запросов к ней.</span><span class="sxs-lookup"><span data-stu-id="5590b-106">The essence of those patterns, and the important point here, is that queries are idempotent: no matter how many times you query a system, the state of that system won't change.</span></span> <span data-ttu-id="5590b-107">Другими словами, выполнение запросов не влечет за собой возможные проблемы.</span><span class="sxs-lookup"><span data-stu-id="5590b-107">In other words, queries are side-effect free.</span></span>

<span data-ttu-id="5590b-108">Следовательно, вы можете использовать для чтения другую модель данных, отличающуюся от модели предметной области записи транзакционной логики, хотя микрослужбы размещения заказов используют ту же базу данных.</span><span class="sxs-lookup"><span data-stu-id="5590b-108">Therefore, you could use a different "reads" data model than the transactional logic "writes" domain model, even though the ordering microservices are using the same database.</span></span> <span data-ttu-id="5590b-109">Следовательно, такой подход CQRS является упрощенным.</span><span class="sxs-lookup"><span data-stu-id="5590b-109">Hence, this is a simplified CQRS approach.</span></span>

<span data-ttu-id="5590b-110">С другой стороны, команды, которые инициируют транзакции и обновления данных, изменяют состояние в системе.</span><span class="sxs-lookup"><span data-stu-id="5590b-110">On the other hand, commands, which trigger transactions and data updates, change state in the system.</span></span> <span data-ttu-id="5590b-111">При использовании команд необходимо соблюдать осторожность, имея дело со сложными и постоянно меняющимися бизнес-правилами.</span><span class="sxs-lookup"><span data-stu-id="5590b-111">With commands, you need to be careful when dealing with complexity and ever-changing business rules.</span></span> <span data-ttu-id="5590b-112">Здесь стоит применять методику DDD, чтобы наилучшим образом смоделировать систему.</span><span class="sxs-lookup"><span data-stu-id="5590b-112">This is where you want to apply DDD techniques to have a better modeled system.</span></span>

<span data-ttu-id="5590b-113">Шаблоны DDD, представленные в настоящем руководстве, не должны применяться универсально.</span><span class="sxs-lookup"><span data-stu-id="5590b-113">The DDD patterns presented in this guide should not be applied universally.</span></span> <span data-ttu-id="5590b-114">Они вводят в ваш проект ограничения.</span><span class="sxs-lookup"><span data-stu-id="5590b-114">They introduce constraints on your design.</span></span> <span data-ttu-id="5590b-115">Эти ограничения обеспечивают такие преимущества, как повышение качества с течением времени, особенно в командах и другом коде, который изменяет состояние системы.</span><span class="sxs-lookup"><span data-stu-id="5590b-115">Those constraints provide benefits such as higher quality over time, especially in commands and other code that modifies system state.</span></span> <span data-ttu-id="5590b-116">Однако эти ограничения увеличивают сложность с минимумом преимуществ для чтения и запросов данных.</span><span class="sxs-lookup"><span data-stu-id="5590b-116">However, those constraints add complexity with fewer benefits for reading and querying data.</span></span>

<span data-ttu-id="5590b-117">Одним из таких шаблонов является шаблон агрегата, который мы подробно рассмотрим в последующих разделах.</span><span class="sxs-lookup"><span data-stu-id="5590b-117">One such pattern is the Aggregate pattern, which we examine more in later sections.</span></span> <span data-ttu-id="5590b-118">Вкратце, в шаблоне агрегата (Aggregate) многие объекты предметной области обрабатываются как единое целое в результате их связей в предметной области.</span><span class="sxs-lookup"><span data-stu-id="5590b-118">Briefly, in the Aggregate pattern, you treat many domain objects as a single unit as a result of their relationship in the domain.</span></span> <span data-ttu-id="5590b-119">В запросах не всегда удается извлечь преимущества из этого шаблона; он может увеличить сложность логики запроса.</span><span class="sxs-lookup"><span data-stu-id="5590b-119">You might not always gain advantages from this pattern in queries; it can increase the complexity of query logic.</span></span> <span data-ttu-id="5590b-120">В запросах только на чтение вы не получите никаких преимуществ от обработки нескольких объектов как единого агрегата.</span><span class="sxs-lookup"><span data-stu-id="5590b-120">For read-only queries, you do not get the advantages of treating multiple objects as a single Aggregate.</span></span> <span data-ttu-id="5590b-121">Вы получите только сложность.</span><span class="sxs-lookup"><span data-stu-id="5590b-121">You only get the complexity.</span></span>

<span data-ttu-id="5590b-122">Как показано на рис. 7-2 в предыдущем разделе, в данном руководстве предлагается использовать шаблоны DDD только в области транзакций или обновлений вашей микрослужбы (то есть в том, что инициируется командами).</span><span class="sxs-lookup"><span data-stu-id="5590b-122">As shown in Figure 7-2 in the previous section, this guide suggests using DDD patterns only in the transactional/updates area of your microservice (that is, as triggered by commands).</span></span> <span data-ttu-id="5590b-123">Для запросов можно использовать более простой подход, и согласно концепции CQRS их следует отделить от команд.</span><span class="sxs-lookup"><span data-stu-id="5590b-123">Queries can follow a simpler approach and should be separated from commands, following a CQRS approach.</span></span>

<span data-ttu-id="5590b-124">Для реализации "стороны запросов" вы можете выбирать между подходами, включая полнофункциональные ORM, например EF Core, проекции AutoMapper, хранимые процедуры, представления, материализованные представления и micro ORM.</span><span class="sxs-lookup"><span data-stu-id="5590b-124">For implementing the "queries side", you can choose between many approaches, from your full-blown ORM like EF Core, AutoMapper projections, stored procedures, views, materialized views or a micro ORM.</span></span>

<span data-ttu-id="5590b-125">В данном руководстве и в приложении eShopOnContainers (в частности, в микрослужбе заказов) мы решили реализовать прямые запросы с помощью micro ORM, например [Dapper](https://github.com/StackExchange/dapper-dot-net).</span><span class="sxs-lookup"><span data-stu-id="5590b-125">In this guide and in eShopOnContainers (specifically the ordering microservice) we chose to implement straight queries using a micro ORM like [Dapper](https://github.com/StackExchange/dapper-dot-net).</span></span> <span data-ttu-id="5590b-126">Это позволяет реализовать любой запрос на основе инструкций SQL для получения наилучшей производительности благодаря облегченной инфраструктуре с небольшими накладными расходами.</span><span class="sxs-lookup"><span data-stu-id="5590b-126">This guide lets you implement any query based on SQL statements to get the best performance, thanks to a light framework with little overhead.</span></span>

<span data-ttu-id="5590b-127">Когда вы используете этот подход, для любых обновлений модели, влияющих на то, как сущности сохраняются в базе данных SQL, также требуются отдельные обновления запросов SQL, используемых Dapper или любым другим отдельным (не EF) подходом к запросам.</span><span class="sxs-lookup"><span data-stu-id="5590b-127">When you use this approach, any updates to your model that impact how entities are persisted to a SQL database also need separate updates to SQL queries used by Dapper or any other separate (non-EF) approaches to querying.</span></span>

## <a name="cqrs-and-ddd-patterns-are-not-top-level-architectures"></a><span data-ttu-id="5590b-128">Шаблоны DDD и CQRS не относятся к архитектурам верхнего уровня</span><span class="sxs-lookup"><span data-stu-id="5590b-128">CQRS and DDD patterns are not top-level architectures</span></span>

<span data-ttu-id="5590b-129">Важно понимать, что CQRS и большинство шаблонов DDD (например, слои DDD или модель предметной области с агрегатами) являются не архитектурными стилями, а лишь архитектурными шаблонами.</span><span class="sxs-lookup"><span data-stu-id="5590b-129">It's important to understand that CQRS and most DDD patterns (like DDD layers or a domain model with aggregates) are not architectural styles, but only architecture patterns.</span></span> <span data-ttu-id="5590b-130">Примерами архитектурных стилей являются микрослужбы, SOA и событийно-управляемая архитектура (EDA).</span><span class="sxs-lookup"><span data-stu-id="5590b-130">Microservices, SOA, and event-driven architecture (EDA) are examples of architectural styles.</span></span> <span data-ttu-id="5590b-131">Они описывают систему, состоящую из множества компонентов, например из множества микрослужб.</span><span class="sxs-lookup"><span data-stu-id="5590b-131">They describe a system of many components, such as many microservices.</span></span> <span data-ttu-id="5590b-132">Шаблоны DDD и CQRS описывают нечто внутри одной системы или компонента; в данном случае — нечто внутри микрослужбы.</span><span class="sxs-lookup"><span data-stu-id="5590b-132">CQRS and DDD patterns describe something inside a single system or component; in this case, something inside a microservice.</span></span>

<span data-ttu-id="5590b-133">Разные ограниченные контексты (BC) будут использовать разные шаблоны.</span><span class="sxs-lookup"><span data-stu-id="5590b-133">Different Bounded Contexts (BCs) will employ different patterns.</span></span> <span data-ttu-id="5590b-134">Они имеют разные сферы ответственности, что ведет к разным решениям.</span><span class="sxs-lookup"><span data-stu-id="5590b-134">They have different responsibilities, and that leads to different solutions.</span></span> <span data-ttu-id="5590b-135">Стоит подчеркнуть, что повсеместное применение одного и того же шаблона приводит к неудаче.</span><span class="sxs-lookup"><span data-stu-id="5590b-135">It is worth emphasizing that forcing the same pattern everywhere leads to failure.</span></span> <span data-ttu-id="5590b-136">Не используйте шаблоны DDD и CQRS повсюду.</span><span class="sxs-lookup"><span data-stu-id="5590b-136">Do not use CQRS and DDD patterns everywhere.</span></span> <span data-ttu-id="5590b-137">Многие подсистемы, ограниченные контексты или микрослужбы довольно простые, и их можно реализовать более просто с помощью служб CRUD или другого метода.</span><span class="sxs-lookup"><span data-stu-id="5590b-137">Many subsystems, BCs, or microservices are simpler and can be implemented more easily using simple CRUD services or using another approach.</span></span>

<span data-ttu-id="5590b-138">Имеется только одна архитектура приложения: архитектура разрабатываемой системы или комплексного приложения (например, архитектура микрослужб).</span><span class="sxs-lookup"><span data-stu-id="5590b-138">There is only one application architecture: the architecture of the system or end-to-end application you are designing (for example, the microservices architecture).</span></span> <span data-ttu-id="5590b-139">Однако структура каждого ограниченного контекста или микрослужбы в этом приложении отражает их собственные компромиссы и внутренние проектные решения на уровне архитектурных шаблонов.</span><span class="sxs-lookup"><span data-stu-id="5590b-139">However, the design of each Bounded Context or microservice within that application reflects its own tradeoffs and internal design decisions at an architecture patterns level.</span></span> <span data-ttu-id="5590b-140">Не пытайтесь везде применять одни и те же архитектурные шаблоны, такие как CQRS или DDD.</span><span class="sxs-lookup"><span data-stu-id="5590b-140">Do not try to apply the same architectural patterns as CQRS or DDD everywhere.</span></span>

### <a name="additional-resources"></a><span data-ttu-id="5590b-141">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="5590b-141">Additional resources</span></span>

- <span data-ttu-id="5590b-142">**Мартин Фоулер (Martin Fowler). CQRS** </span><span class="sxs-lookup"><span data-stu-id="5590b-142">**Martin Fowler. CQRS** </span></span>\
  <https://martinfowler.com/bliki/CQRS.html>

- <span data-ttu-id="5590b-143">**Грег Янг (Greg Young). Документы по CQRS**  </span><span class="sxs-lookup"><span data-stu-id="5590b-143">**Greg Young. CQRS Documents** </span></span>\
  <https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf>

- <span data-ttu-id="5590b-144">**Уди Дахан (Udi Dahan). Пояснения к CQRS** </span><span class="sxs-lookup"><span data-stu-id="5590b-144">**Udi Dahan. Clarified CQRS** </span></span>\
  <https://udidahan.com/2009/12/09/clarified-cqrs/>

>[!div class="step-by-step"]
><span data-ttu-id="5590b-145">[Назад](apply-simplified-microservice-cqrs-ddd-patterns.md)
>[Вперед](cqrs-microservice-reads.md)</span><span class="sxs-lookup"><span data-stu-id="5590b-145">[Previous](apply-simplified-microservice-cqrs-ddd-patterns.md)
[Next](cqrs-microservice-reads.md)</span></span>
