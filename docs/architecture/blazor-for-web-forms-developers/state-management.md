---
title: Управление состоянием
description: Узнайте о различных подходах к управлению состоянием в ASP.NET Web Forms и Блазор.
author: csharpfritz
ms.author: jefritz
ms.date: 05/15/2020
ms.openlocfilehash: bac2f00330113725f09259ca31bdf857a8769f24
ms.sourcegitcommit: 7476c20d2f911a834a00b8a7f5e8926bae6804d9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88062344"
---
# <a name="state-management"></a>Управление состоянием

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

Управление состоянием — это ключевая концепция приложений веб-форм, которая упрощает работу с состоянием просмотра, состоянием сеанса, состоянием приложения и обратной передачей. Эти функции платформы с отслеживанием состояния позволяют скрыть управление состоянием, необходимое для приложения, и позволить разработчикам приложений сосредоточиться на предоставлении их функциональности. При использовании ASP.NET Core и Блазор некоторые из этих функций были перемещены, а некоторые из них были удалены полностью. В этой главе рассматриваются способы поддержания состояния и предоставления тех же функций с помощью новых функций в Блазор.

## <a name="request-state-management-with-viewstate"></a>Запрос управления состоянием с ViewState

При обсуждении управления состоянием в приложении веб-форм многие разработчики сразу же считают ViewState. В Web Forms ViewState управляет состоянием содержимого между запросами HTTP, отправляя большой кодированный блок текста назад и вперед в браузер. Поле ViewState может быть перегружено содержимым страницы, содержащей много элементов, что может увеличиться до нескольких мегабайт.

При использовании Блазор Server приложение сохраняет текущее подключение к серверу. Состояние приложения, называемое *цепью*, хранится в памяти сервера, пока подключение считается активным. Состояние будет удалено только при переходе пользователя из приложения или определенной страницы в приложении. Все члены активных компонентов доступны между взаимодействием с сервером.

Существует несколько преимуществ этой функции.

- Состояние компонента легко доступно и не перестраивается между взаимодействиями.
- Состояние не передается в браузер.

Однако существуют некоторые недостатки сохранения состояния компонента в памяти для того, чтобы иметь в виду следующее.

- Если сервер перезапускается между запросами, состояние теряется.
- Решение для балансировки нагрузки веб-сервера приложения должно включать прикрепленные сеансы, чтобы все запросы из одного браузера возвращались на один и тот же сервер. Если запрос переходит на другой сервер, состояние будет потеряно.
- Сохранение состояния компонента на сервере может привести к нехватке памяти на веб-сервере.

По этим причинам не следует полагаться на то, что компонент должен находиться в памяти на сервере. Приложение также должно включать в себя резервное хранилище данных для данных между запросами. Вот несколько простых примеров этой стратегии:

- В приложении корзины для покупок сохраняет содержимое новых элементов, добавленных в корзину, в записи базы данных. Если состояние на сервере потеряно, его можно восстановить из записей базы данных.
- В многокомпонентной веб-форме пользователи хотят, чтобы ваше приложение запомнило значения между каждым запросом. Запишите данные между каждой записью пользователя в хранилище данных, чтобы их можно было извлечь и собрать в итоговую структуру ответа формы при завершении многокомпонентной формы.

Дополнительные сведения об управлении состоянием в приложениях Блазор см. в разделе [ASP.NET Core блазор State Management](/aspnet/core/blazor/state-management).

## <a name="maintain-state-with-session"></a>Поддержание состояния с сеансом

Разработчики веб-форм могут хранить сведения о текущем пользователе, который является <xref:Microsoft.AspNetCore.Http.ISession?displayProperty=nameWithType> объектом Dictionary. Достаточно просто добавить объект со строковым ключом в `Session` , и этот объект будет доступен позже во время взаимодействия пользователя с приложением. При попытке исключить управление взаимодействием с HTTP `Session` объект сделал простоту поддерживать состояние.

Подпись объекта .NET Framework не совпадает с сигнатурой `Session` `Session` объекта ASP.NET Core. Рассмотрите [документацию по новому сеансу ASP.NET Core](/dotnet/api/microsoft.aspnetcore.http.isession) , прежде чем принимать решение о переносе и использовании новой функции состояния сеанса.

Сеанс доступен в ASP.NET Core и сервере Блазор, но не рекомендуется использовать в качестве соответствующего хранилища данных. Состояние сеанса также не работает, если посетители ототклоняют использование файлов cookie HTTP в приложении из-за проблем с конфиденциальностью.

Конфигурация ASP.NET Core и состояние сеанса доступны в [ASP.NET Core статье Управление сеансами и состояниями](/aspnet/core/fundamentals/app-state#session-state).

## <a name="application-state"></a>Состояние приложения

`Application`Объект в платформе веб-форм предоставляет обширный репозиторий между запросами для взаимодействия с конфигурацией и состоянием области приложения. Состояние приложения было идеальным местом для хранения различных свойств конфигурации приложения, на которые могут ссылаться все запросы, независимо от пользователя, выполняющего запрос. Проблема с объектом заключается в `Application` том, что данные не сохранялись на нескольких серверах. Состояние объекта приложения было потеряно между перезапусками.

Как и в `Session` случае, рекомендуется перемещать данные в постоянное резервное хранилище, доступное нескольким экземплярам сервера. Если есть постоянные данные, к которым вы хотите получить доступ по запросам и пользователям, вы можете легко сохранить их в одноэлементной службе, которую можно внедрить в компоненты, требующие этой информации или взаимодействия.

Создание объекта для поддержки состояния приложения и его потребления может напоминать следующую реализацию:

```csharp
public class MyApplicationState
{
    public int VisitorCounter { get; private set; } = 0;

    public void IncrementCounter() => VisitorCounter += 1;
}
```

```csharp
app.AddSingleton<MyApplicationState>();
```

```razor
@inject MyApplicationState AppState

<label>Total Visitors: @AppState.VisitorCounter</label>
```

`MyApplicationState`Объект создается на сервере только один раз, и значение `VisitorCounter` извлекается и выводится в метке компонента. `VisitorCounter`Значение должно сохраняться и извлекаться из резервного хранилища данных для обеспечения устойчивости и масштабируемости.

## <a name="in-the-browser"></a>В браузере

Данные приложений также могут храниться на стороне клиента на устройстве пользователя, чтобы они были доступны позже. Существует две функции браузера, позволяющие сохранять данные в разных областях браузера пользователя:

- `localStorage`— область действия для всего браузера пользователя. Если страница перезагружена, браузер закрывается и открывается повторно, либо открывается другая вкладка с тем же URL-адресом, что и в `localStorage` браузере.
- `sessionStorage`— область ограничена текущей вкладкой браузера пользователя. Если вкладка перезагружена, состояние сохраняется. Однако если пользователь откроет другую вкладку для приложения или закроет и снова откроет браузер, состояние будет потеряно.

Вы можете написать специальный код JavaScript для взаимодействия с этими функциями, или существует ряд пакетов NuGet, которые можно использовать для предоставления этих функций. Одним из таких пакетов является [Microsoft. AspNetCore. протектедбровсерстораже](https://www.nuget.org/packages/Microsoft.AspNetCore.ProtectedBrowserStorage).

Инструкции по использованию этого пакета для взаимодействия с `localStorage` и `sessionStorage` см. в статье [Управление состоянием блазор](/aspnet/core/blazor/state-management#protected-browser-storage-experimental-package) .

>[!div class="step-by-step"]
>[Назад](pages-routing-layouts.md)
>[Вперед](forms-validation.md)
