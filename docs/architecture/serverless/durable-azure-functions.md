---
title: Устойчивые функции Azure — бессерверные приложения
description: Устойчивые функции Azure расширяют среду выполнения функций Azure, чтобы включить рабочие процессы с отслеживанием состояния в коде.
author: cecilphillip
ms.author: cephilli
ms.date: 06/26/2018
ms.openlocfilehash: f7ee74926d6658042120113b49dc763383881423
ms.sourcegitcommit: f20dd18dbcf2275513281f5d9ad7ece6a62644b4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/30/2019
ms.locfileid: "69577517"
---
# <a name="durable-azure-functions"></a>Устойчивые функции Azure

При создании бессерверных приложений с помощью функций Azure операции обычно будут выполняться без сохранения состояния. Причина этого варианта проектирования заключается в том, что при масштабировании платформы становится трудно определить, на каких серверах выполняется код. Также трудно понять, сколько экземпляров активно в любой заданной точке. Однако существуют классы приложений, которым требуется знать текущее состояние процесса. Рассмотрим процесс отправки заказа в Интернет-магазин. Операция извлечения может быть рабочим процессом, состоящим из нескольких операций, которым необходимо знать состояние процесса. Такие сведения могут включать в себя инвентаризацию продукта, если у клиента есть кредиты по своей учетной записи, а также результаты обработки кредитной карты. Эти операции могут легко быть собственными внутренними рабочими процессами или даже службами сторонних систем.

В настоящее время существуют различные шаблоны, помогающие обеспечить координацию состояния приложения между внутренними и внешними системами. Часто приходится использовать решения, использующие централизованные системы очередей, распределенные хранилища значений ключей или общие базы данных для управления этим состоянием. Однако это все дополнительные ресурсы, которые теперь необходимо подготовить и контролировать. В бессерверной среде ваш код может оказаться громоздким, пытаясь координировать эти ресурсы вручную. Функции Azure предлагают альтернативу созданию функций с отслеживанием состояния, которые называются Устойчивые функции.

Устойчивые функции является расширением среды выполнения функций Azure, позволяющей определение рабочих процессов с отслеживанием состояния в коде. Разбивая потоки операций на действия, расширение Устойчивые функции может управлять состоянием, создавать контрольные точки хода выполнения и обрабатывать распределение вызовов функций между серверами. В фоновом режиме используется учетная запись хранения Azure для сохранения журнала выполнения, планирования функций действий и получения ответов. Код без сервера не должен взаимодействовать с сохраненными сведениями в этой учетной записи хранения. обычно это не то, что необходимо для взаимодействия с разработчиками.

## <a name="triggering-a-stateful-workflow"></a>Запуск рабочего процесса с отслеживанием состояния

Рабочие процессы с отслеживанием состояния в Устойчивые функции можно разделить на два встроенных компонента. триггеры оркестрации и действий. Триггеры и привязки — это основные компоненты, используемые функциями Azure, которые позволяют получать уведомления о запуске, получении входных данных и возврате результатов в бессерверных функциях.

### <a name="working-with-the-orchestration-client"></a>Работа с клиентом оркестрации

Согласованность является уникальной по сравнению с другими стилями активированных операций в функциях Azure. Устойчивые функции позволяет выполнять функции, выполнение которых может занять несколько часов или даже дней. Этот тип поведения имеет потребность в проверке состояния выполняющегося оркестрации, преждевременного завершения или отправки уведомлений о внешних событиях.

В таких случаях расширение устойчивые функции предоставляет `DurableOrchestrationClient` класс, который позволяет взаимодействовать с управляемыми функциями. Получить доступ к клиенту оркестрации можно с помощью `OrchestrationClientAttribute` привязки. Как правило, этот атрибут следует включать в другой тип триггера, например `HttpTrigger` или. `ServiceBusTrigger` После активации исходной функции клиент оркестрации можно использовать для запуска функции Orchestrator.

```csharp
[FunctionName("KickOff")]
public static async Task<HttpResponseMessage> Run(
    [HttpTrigger(AuthorizationLevel.Function, "POST")]HttpRequestMessage req,
    [OrchestrationClient ] DurableOrchestrationClient<orchestrationClient>)
{
    OrderRequestData data = await req.Content.ReadAsAsync<OrderRequestData>();

    string instanceId = await orchestrationClient.StartNewAsync("PlaceOrder", data);

    return orchestrationClient.CreateCheckStatusResponse(req, instanceId);
}
```

### <a name="the-orchestrator-function"></a>Функция Orchestrator

Аннотирование функции с помощью Орчестратионтригжераттрибуте в функциях Azure помечает функции как функцию Orchestrator. Он отвечает за управление различными действиями, которые составляют рабочий процесс с отслеживанием состояния.

Функции Orchestrator не могут использовать привязки, отличные от Орчестратионтригжераттрибуте. Этот атрибут может использоваться только с типом параметра DurableOrchestrationContext. Другие входные данные не могут использоваться, так как десериализация входных данных в сигнатуре функции не поддерживается. Чтобы получить входные данные, предоставляемые клиентом оркестрации, необходимо использовать\<метод\> oninput T.

Кроме того, возвращаемые типы функций оркестрации должны быть либо void, либо задачей, либо сериализуемым значением JSON.

> *Код обработки ошибок был оставлен для краткости*

```csharp
[FunctionName("PlaceOrder")]
public static async Task<string> PlaceOrder([OrchestrationTrigger] DurableOrchestrationContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    await context.CallActivityAsync<bool>("CheckAndReserveInventory", orderData);
    await context.CallActivityAsync<string>("ProcessPayment", orderData);

    string trackingNumber = await context.CallActivityAsync<string>("ScheduleShipping", orderData);
    await context.CallActivityAsync<string>("EmailCustomer", trackingNumber);

    return trackingNumber;
}
```

Несколько экземпляров оркестрации могут быть запущены и запущены в одно и то же время. При вызове `StartNewAsync` метода в запускается`DurableOrchestrationClient` новый экземпляр оркестрации. Метод возвращает объект `Task<string>` , который завершается при запуске оркестрации. Исключение типа `TimeoutException` возникает, если оркестрации не начата в течение 30 секунд.

Элемент Completed `Task<string>` `StartNewAsync` должен содержать уникальный идентификатор экземпляра оркестрации. Этот идентификатор экземпляра можно использовать для вызова операций с этим конкретным согласованием. Для запроса состояния или отправки уведомлений о событиях можно использовать согласование.

### <a name="the-activity-functions"></a>Функции действий

Функции действий — это дискретные операции, которые объединяются в функцию оркестрации для создания рабочего процесса. Ниже показано, где будет выполняться большая часть реальной работы. Они представляют бизнес-логику, долгосрочные процессы и элементы головоломки для более крупного решения.

Используется для добавления аннотации в параметр функции типа `DurableActivityContext`. `ActivityTriggerAttribute` С помощью аннотации информирует среду выполнения о том, что функция предназначена для использования в качестве функции действия. Входные значения для функций действий извлекаются `GetInput<T>` с помощью метода `DurableActivityContext` параметра.

Как и в случае с функциями оркестрации, возвращаемые типы функций действий должны быть либо void, либо задачей, либо сериализуемым значением JSON.

Все необработанные исключения, которые вызываются в функциях действий, будут отправлены в вызывающую функцию Orchestrator и представлены `TaskFailedException`в виде. На этом этапе ошибка может быть перехвачена и зарегистрирована в Orchestrator, и действие можно повторить.

```csharp
[FunctionName("CheckAndReserveInventory")]
public static bool CheckAndReserveInventory([ActivityTrigger] DurableActivityContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    // Connect to inventory system and try to reserve items
    return true;
}
```

## <a name="recommended-resources"></a>Рекомендуемые ресурсы

* [Устойчивые функции](https://docs.microsoft.com/azure/azure-functions/durable-functions-overview)
* [Привязки для Устойчивые функции](https://docs.microsoft.com/azure/azure-functions/durable-functions-bindings)
* [Управление экземплярами в Устойчивые функции](https://docs.microsoft.com/azure/azure-functions/durable-functions-instance-management)

>[!div class="step-by-step"]
>[Назад](event-grid.md)
>[Вперед](orchestration-patterns.md)
