---
title: Устойчивые функции Azure — бессерверные приложения
description: Устойчивые функции Azure расширяют среду выполнения Функций Azure, чтобы реализовать рабочие процессы с отслеживанием состояния в коде.
author: cecilphillip
ms.author: cephilli
ms.date: 06/26/2018
ms.openlocfilehash: c3ee628b5c2239cd13395fda7714b38b06efa058
ms.sourcegitcommit: f99115e12a5eb75638abe45072e023a3ce3351ac
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2020
ms.locfileid: "94557159"
---
# <a name="durable-azure-functions"></a>Устойчивые функции Azure

При создании бессерверных приложений с помощью Функций Azure операции обычно проектируются таким образом, чтобы выполняться без отслеживания состояния. Причина выбора этого варианта проектирования заключается в том, что при масштабировании платформы становится трудно определить, на каких серверах выполняется код. Кроме того, сложно понять, сколько экземпляров активно в любой момент. Однако существуют классы приложений, которым требуется знать текущее состояние процесса. Рассмотрим процесс отправки заказа в интернет-магазин. Операция проверки может быть рабочим процессом, состоящим из нескольких операций, которым необходимо знать состояние процесса. Такие сведения могут включать в себя запасы продукта, если ли у клиента кредиты по своей учетной записи, а также результаты обработки кредитной карты. Эти операции могут быть внутренними рабочими процессами или даже службами сторонних систем.

В настоящее время существуют различные шаблоны, которые помогают обеспечить координацию состояния приложения между внутренними и внешними системами. Часто встречаются решения, использующие для управления этим состоянием централизованные системы постановки в очередь, распределенные хранилища пар "ключ — значение" или общие базы данных. Однако все эти дополнительные ресурсы теперь необходимо подготовить к работе и управлять ими. Если вы будете пытаться вручную координировать эти ресурсы в бессерверной среде, код может стать громоздким. Функции Azure предлагают альтернативу для создания функций с отслеживанием состояния, которые называются Устойчивыми функциями.

Устойчивые функции являются расширением среды выполнения Функций Azure, которое обеспечивает внедрение определения рабочих процессов с отслеживанием состояния в коде. Разбивая рабочие процессы на действия, расширение Устойчивые функции может управлять состоянием, создавать контрольные точки выполнения и обрабатывать распределение вызовов функций между серверами. В фоновом режиме используется учетная запись службы хранилища Azure для сохранения журнала выполнения, планирования функций действий и получения ответов. Ваш бессерверный код не должен взаимодействовать с сохраненными сведениями в этой учетной записи хранения, и, как правило, разработчикам это не нужно.

## <a name="triggering-a-stateful-workflow"></a>Активация рабочего процесса с отслеживанием состояния

Рабочие процессы с отслеживанием состояния в Устойчивых функциях можно разделить на два встроенных компонента: оркестрация и триггеры действия. Триггеры и привязки — это основные компоненты, используемые Функциями Azure для уведомления бессерверных функций о необходимости запуска, получении входных данных и возврате результатов.

### <a name="working-with-the-orchestration-client"></a>Работа с клиентом оркестрации

В Функциях Azure оркестрация является уникальной операцией по сравнению с другими стилями активируемых операций. Устойчивые функции позволяют запускать функции, выполнение которых может занять несколько часов или даже дней. Такому типу поведения нужна возможность проверять состояние выполняющейся оркестрации, преждевременно завершать и отправлять уведомления о внешних событиях.

В таких случаях расширение "Устойчивые функции" предоставляет класс `DurableOrchestrationClient`, который позволяет взаимодействовать с оркестрируемыми функциями. Получить доступ к клиенту оркестрации можно с помощью привязки `OrchestrationClientAttribute`. Обычно, этот атрибут следует включать в другой тип триггера, например `HttpTrigger` или `ServiceBusTrigger`. После активации исходной функции клиент оркестрации можно использовать для запуска функции оркестратора.

```csharp
[FunctionName("KickOff")]
public static async Task<HttpResponseMessage> Run(
    [HttpTrigger(AuthorizationLevel.Function, "POST")]HttpRequestMessage req,
    [OrchestrationClient ] DurableOrchestrationClient<orchestrationClient>)
{
    OrderRequestData data = await req.Content.ReadAsAsync<OrderRequestData>();

    string instanceId = await orchestrationClient.StartNewAsync("PlaceOrder", data);

    return orchestrationClient.CreateCheckStatusResponse(req, instanceId);
}
```

### <a name="the-orchestrator-function"></a>Функция оркестратора

Чтобы пометить функцию как функцию оркестратора, нужно аннотировать ее с помощью атрибута OrchestrationTriggerAttribute в Функциях Azure. Она отвечает за управление различными действиями, которые составляют рабочий процесс с отслеживанием состояния.

Функции оркестратора не могут использовать привязки, отличные от OrchestrationTriggerAttribute. Этот атрибут может использоваться только с типом параметра DurableOrchestrationContext. Другие входные данные не могут использоваться, так как десериализация входных данных в сигнатуре функции не поддерживается. Чтобы получить входные данные, предоставляемые клиентом оркестрации, необходимо использовать метод GetInput\<T\>.

Кроме того, типы возвращаемых значений функций оркестрации должны иметь значение void, Task или сериализуемое значение JSON.

> *Код обработки ошибок опущен для краткости*.

```csharp
[FunctionName("PlaceOrder")]
public static async Task<string> PlaceOrder([OrchestrationTrigger] DurableOrchestrationContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    await context.CallActivityAsync<bool>("CheckAndReserveInventory", orderData);
    await context.CallActivityAsync<string>("ProcessPayment", orderData);

    string trackingNumber = await context.CallActivityAsync<string>("ScheduleShipping", orderData);
    await context.CallActivityAsync<string>("EmailCustomer", trackingNumber);

    return trackingNumber;
}
```

Несколько экземпляров оркестрации могут быть запущены и выполняться в одно и то же время. Вызов метода `StartNewAsync` в классе `DurableOrchestrationClient` запускает новый экземпляр оркестрации. Метод возвращает задачу `Task<string>`, которая завершается при запуске оркестрации. Исключение типа `TimeoutException` возникает, если оркестрация не начата в течение 30 секунд.

Завершенная задача `Task<string>` из метода `StartNewAsync` должна содержать уникальный идентификатор экземпляра оркестрации. Этот идентификатор экземпляра можно использовать, чтобы вызвать операции для конкретной оркестрации. Оркестрацию можно использовать для запроса состояния или отправки уведомлений о событиях.

### <a name="the-activity-functions"></a>Функции действий

Функции действий — это отдельные операции, которые объединяются в функцию оркестрации для создания рабочего процесса. Здесь выполняется большая часть реальной работы. Они представляют собой бизнес-логику, длительные процессы и элементы головоломки, формирующие более крупное решение.

`ActivityTriggerAttribute` используется для добавления аннотации в параметр функции типа `DurableActivityContext`. С помощью аннотации среда выполнения информируется о том, что функция предназначена для использования в качестве функции действия. Входные значения для функций действий извлекаются с помощью метода `GetInput<T>` параметра `DurableActivityContext`.

Подобно функциям оркестрации типы возвращаемых значений функций действий должны иметь значение void, Task или сериализуемое значение JSON.

Все необработанные исключения, которые вызываются в функциях действий, будут отправлены в вызывающую функцию оркестратора и представлены как `TaskFailedException`. На этом этапе ошибка может быть перехвачена и зарегистрирована в оркестраторе, и действие можно повторить.

```csharp
[FunctionName("CheckAndReserveInventory")]
public static bool CheckAndReserveInventory([ActivityTrigger] DurableActivityContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    // Connect to inventory system and try to reserve items
    return true;
}
```

## <a name="recommended-resources"></a>Рекомендуемые ресурсы

- [Цепочки функций в устойчивых функциях — пример последовательности Hello](/azure/azure-functions/durable-functions-overview)
- [Привязки для Устойчивых функций (Функции Azure)](/azure/azure-functions/durable-functions-bindings)
- [Управление экземплярами в Устойчивых функциях в Azure](/azure/azure-functions/durable-functions-instance-management)

>[!div class="step-by-step"]
>[Назад](event-grid.md)
>[Вперед](orchestration-patterns.md)
