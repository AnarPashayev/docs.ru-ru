---
title: Шаблоны устойчивости приложения
description: Создание архитектуры облачных приложений .NET для Azure | Шаблоны устойчивости приложений
ms.date: 06/30/2019
ms.openlocfilehash: 6805603f349578655b2535c7346af368c5ce1841
ms.sourcegitcommit: 5988e9a29cedb8757320817deda3c08c6f44a6aa
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2020
ms.locfileid: "82199694"
---
# <a name="application-resiliency-patterns"></a>Шаблоны устойчивости приложения

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

Первой линией обороны является устойчивость приложений с поддержкой программного обеспечения.

Хотя вы можете вкладывать значительное время в собственную платформу устойчивости, такие продукты уже существуют. Например, [Polly](http://www.thepollyproject.org/) — это комплексная библиотека устойчивости и обработки временных ошибок .NET, которая позволяет разработчикам выразить политики устойчивости в свободном и потокобезопасным способах. Polly предназначен для приложений, созданных с помощью полной .NET Framework или .NET Core. На рис. 6-2 показаны политики устойчивости (т. е. функциональность), доступные из библиотеки Polly. Эти политики можно применять по отдельности или совместно.

![Polly Framework](./media/polly-resiliency-framework.png)

**Рис. 6-2**. Функции платформы устойчивости Polly

Обратите внимание, как на предыдущем рисунке политики устойчивости применяются к сообщениям запроса независимо от того, поступает ли он от внешнего клиента или другой серверной службы. Цель — компенсировать запрос службы, которая может быть недоступна мгновенно. Эти короткие перерывы, как правило, переводят себя с кодом состояния HTTP, показанным на рис. 6-3.

![Коды состояния HTTP для повторной попытки](./media/http-status-codes.png)

**Рис. 6-3**. Коды состояния HTTP для повторной попытки

Вопрос. можно ли повторить код состояния HTTP 403-запрещено? Нет. В этом случае система работает правильно, но сообщает вызывающему объекту, что он не имеет прав для выполнения запрошенной операции. Необходимо соблюдать осторожность, чтобы повторить только операции, вызванные сбоями.

Как мы рекомендуем в главе 1, разработчики Майкрософт, создающие облачные приложения, должны ориентироваться на .NET Core. В версии 2,1 появилась библиотека [хттпклиентфактори](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) для создания экземпляров клиентов HTTP для взаимодействия с ресурсами на основе URL-адресов. Заменяя исходный класс HTTPClient, класс фабрики поддерживает множество улучшенных функций, одна из которых [тесно интегрируется](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) с библиотекой устойчивости Polly. С его помощью можно легко определить политики устойчивости в классе запуска приложения для решения частичных сбоев и проблем с подключением.

Теперь давайте разберем шаблоны повтора и повторного запуска.

### <a name="retry-pattern"></a>Шаблон повторов

В распределенной облачной среде вызовы служб и облачных ресурсов могут завершаться сбоем из-за временных сбоев (кратковременных), которые обычно исправляются по истечении короткого периода времени. Реализация стратегии повторных попыток позволяет облачной службе справиться с этими сценариями.

[Шаблон повторных попыток](https://docs.microsoft.com/azure/architecture/patterns/retry) позволяет службе повторить операцию невыполненного запроса (настраивается) количество раз с экспоненциально увеличивающимся временем ожидания. На рис. 6-4 показана повторная попытка в действии.

![Шаблон повторных попыток в действии](./media/retry-pattern.png)

**Рис. 6-4**. Шаблон повторных попыток в действии

На предыдущем рисунке для операции запроса был реализован шаблон повтора. Он разрешает до четырех повторных попыток, прежде чем завершать работу с интервалом перехода (время ожидания), начиная с двух секунд, экспоненциально удваивается при каждой последующей попытке.

- При первом вызове происходит сбой и возвращается код состояния HTTP 500. Приложение ожидает две секунды и повторяет вызов.
- Второй вызов также завершается ошибкой и возвращает код состояния HTTP 500. Теперь приложение удваивает интервал отхода до четырех секунд и повторяет вызов.
- Наконец, третий вызов будет выполнен.
- В этом сценарии операция повтора попыталась выполнить до четырех повторных попыток, не выполняя при этом вызов.

Важно увеличить период отсрочки перед повторным выполнением вызова, чтобы разрешить время службы самостоятельно. Рекомендуется реализовать экспоненциальное увеличение задержки (удвоение периода при каждой повторной попытке), чтобы обеспечить адекватное время исправления.

## <a name="circuit-breaker-pattern"></a>Шаблон автоматического выключения

Хотя шаблон повторных попыток может помочь в восстановлении запроса, запутанными в частичный сбой, бывают ситуации, когда сбои могут быть вызваны непредвиденными событиями, требующими более длительных периодов времени для разрешения. Такие сбои могут быть различной степени серьезности: от частичной потери соединения до полного отказа службы. В таких ситуациях приложение не позволяет постоянно повторять операцию, которая вряд ли будет выполнена.

Чтобы сделать что-то хуже, выполнение непрерывных операций повтора в службе, не поддерживающей реагирование, может переместить вас в неуправляемый сценарий отказа в обслуживании, когда вы перейдете в службу, используя непрерывные вызовы, такие как память, потоки и подключения к базе данных, что приведет к сбою в работе несвязанных частей системы, использующих те же ресурсы.

В таких ситуациях было бы предпочтительнее выполнить операцию неудачно и попытаться вызвать службу только в случае ее удачного завершения.

[Шаблон](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) автоматического выключения может помешать приложению многократно пытаться выполнить операцию, которая, скорее всего, завершится ошибкой. Он также наблюдает за приложением периодическим вызовом пробной версии, чтобы определить, устранена ли ошибка. На рис. 6-5 показан шаблон автоматического выключения цепи в действии.

![Шаблон автоматического прерывания в действии](./media/circuit-breaker-pattern.png)

**Рис. 6-5**. Шаблон автоматического прерывания в действии

На предыдущем рисунке к исходному шаблону повтора добавлен шаблон автоматического выключения. Обратите внимание, что после 10 неудачных запросов автоматическое открытие отключено и больше не разрешает вызовы службы. Значение ЧеккЦиркуит, заданное в течение 30 секунд, указывает, как часто библиотека разрешает выполнение одного запроса к службе. Если этот вызов завершается, канал закрывается, а служба снова становится доступной для трафика.

Помните, что цель шаблона автоматического выключения *отличается* от цели шаблона повторного выполнения. Шаблон повторных попыток позволяет приложению повторить операцию в ожидании, что оно будет выполняться. Шаблон автоматического выключения не позволяет приложению выполнить операцию, которая, скорее всего, завершится ошибкой. Часто приложение *объединяет* эти два шаблона, используя шаблон повтора для вызова операции через автоматическое выключение. Однако логика повторных попыток должна быть чувствительна к любым исключениям, возвращаемым средством автоматического выключения, и повторять попытки, если автоматическое выключение указывает на то, что сбой не является временным.

Устойчивость приложений является обязательной для обработки проблемно запрашиваемых операций. Но это лишь половина истории. Далее мы рассмотрим функции устойчивости, доступные в облаке Azure.

>[!div class="step-by-step"]
>[Назад](resiliency.md)
>[Вперед](infrastructure-resiliency-azure.md)
