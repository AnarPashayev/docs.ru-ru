---
title: Шаблоны устойчивости приложения
description: Создание архитектуры облачных приложений .NET для Azure | Шаблоны устойчивости приложений
author: robvet
ms.date: 05/13/2020
ms.openlocfilehash: e81d6e1d6b95cf0053de3ba557068ff458a59dc9
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91161156"
---
# <a name="application-resiliency-patterns"></a>Шаблоны устойчивости приложения

Первой линией обороны является устойчивость приложений.

Хотя вы можете вкладывать значительное время в собственную платформу устойчивости, такие продукты уже существуют. [Polly](http://www.thepollyproject.org/) — это комплексная библиотека устойчивости и обработки временных ошибок .NET, которая позволяет разработчикам выразить политики устойчивости в свободном и безопасном для потоков режиме. Polly предназначен для приложений, созданных с помощью .NET Framework или .NET Core. В следующей таблице описаны функции устойчивости, которые называются `policies` доступными в библиотеке Polly. Они могут быть применены по отдельности или сгруппированы вместе.

| Политика | Взаимодействие |
| :-------- | :-------- |
| Повторить попытку | Настраивает операции повтора для указанных операций. |
| Автоматическое выключение | Блокирует запрошенные операции для предопределенного периода, когда ошибки превышают заданное пороговое значение |
| Время ожидания | Размещает ограничение на продолжительность времени, в течение которого вызывающий объект может ожидать ответа. |
| Распределительный блок | Ограничивает действия пулом ресурсов фиксированного размера, чтобы предотвратить неудачные вызовы из перегрузки ресурса. |
| Кэш | Сохраняет ответы автоматически. |
| Резервирование | Определяет структурированное поведение при сбое. |

Обратите внимание, как на предыдущем рисунке политики устойчивости применяются к сообщениям запроса независимо от того, поступает ли от внешнего клиента или серверной службы. Цель — компенсировать запрос службы, которая может быть недоступна мгновенно. Эти кратковременные перерывы обычно проводят себя с кодом состояния HTTP, приведенным в следующей таблице.

| Код состояния HTTP| Причина |
| :-------- | :-------- |
| 404 | Не найдено |
| 408 | Время ожидания запроса |
| 429 | Слишком много запросов (вы, скорее всего, отрегулированы) |
| 502 | Недопустимый шлюз |
| 503 | Служба недоступна |
| 504 | Время ожидания шлюза |

Вопрос. можно ли повторить код состояния HTTP 403-запрещено? Нет. В этом случае система работает правильно, но сообщает вызывающему объекту, что он не имеет прав для выполнения запрошенной операции. Необходимо соблюдать осторожность, чтобы повторить только операции, вызванные сбоями.

Как мы рекомендуем в главе 1, разработчики Майкрософт, создающие облачные приложения, должны ориентироваться на платформу .NET Core. В версии 2,1 появилась библиотека [хттпклиентфактори](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) для создания экземпляров клиентов HTTP для взаимодействия с ресурсами на основе URL-адресов. Заменяя исходный класс HTTPClient, класс фабрики поддерживает множество улучшенных функций, одна из которых [тесно интегрируется](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) с библиотекой устойчивости Polly. С его помощью можно легко определить политики устойчивости в классе запуска приложения для решения частичных сбоев и проблем с подключением.

Теперь давайте разберем шаблоны повтора и повторного запуска.

### <a name="retry-pattern"></a>Шаблон повторов

В распределенной облачной среде вызовы служб и облачных ресурсов могут завершаться сбоем из-за временных сбоев (кратковременных), которые обычно исправляются по истечении короткого периода времени. Реализация стратегии повторных попыток помогает облачной службе снизить эти сценарии.

[Шаблон повторных попыток](/azure/architecture/patterns/retry) позволяет службе повторить операцию невыполненного запроса (настраивается) количество раз с экспоненциально увеличивающимся временем ожидания. На рис. 6-2 показана повторная попытка в действии.

![Шаблон повторных попыток в действии](./media/retry-pattern.png)

**Рис. 6-2**. Шаблон повторных попыток в действии

На предыдущем рисунке для операции запроса был реализован шаблон повтора. Он разрешает до четырех повторных попыток, прежде чем завершать работу с интервалом перехода (время ожидания), начиная с двух секунд, экспоненциально удваивается при каждой последующей попытке.

- При первом вызове происходит сбой и возвращается код состояния HTTP 500. Приложение ожидает две секунды и повторяет вызов.
- Второй вызов также завершается ошибкой и возвращает код состояния HTTP 500. Теперь приложение удваивает интервал отхода до четырех секунд и повторяет вызов.
- Наконец, третий вызов будет выполнен.
- В этом сценарии операция повтора попыталась выполнить до четырех повторных попыток, не выполняя при этом вызов.
- Если не удалось выполнить четвертую попытку повтора, будет вызвана политика резервного использования для корректной работы этой проблемы.

Важно увеличить период отсрочки перед повторным выполнением вызова, чтобы разрешить время службы самостоятельно. Рекомендуется реализовать экспоненциальное увеличение задержки (удвоение периода при каждой повторной попытке), чтобы обеспечить адекватное время исправления.

## <a name="circuit-breaker-pattern"></a>Шаблон автоматического выключения

Хотя шаблон повторных попыток может помочь в восстановлении запроса, запутанными в частичный сбой, бывают ситуации, когда сбои могут быть вызваны непредвиденными событиями, требующими более длительных периодов времени для разрешения. Такие сбои могут быть различной степени серьезности: от частичной потери соединения до полного отказа службы. В таких ситуациях приложение не позволяет постоянно повторять операцию, которая вряд ли будет выполнена.

Чтобы сделать что-то хуже, выполнение непрерывных операций повтора в службе, не поддерживающей реагирование, может переместить вас в неуправляемый сценарий отказа в обслуживании, когда вы перейдете в службу, используя непрерывные вызовы, такие как память, потоки и подключения к базе данных, что приведет к сбою в работе несвязанных частей системы, использующих те же ресурсы.

В таких ситуациях было бы предпочтительнее выполнить операцию неудачно и попытаться вызвать службу только в случае ее удачного завершения.

[Шаблон](/azure/architecture/patterns/circuit-breaker) автоматического выключения может помешать приложению многократно пытаться выполнить операцию, которая, скорее всего, завершится ошибкой. После определенного числа неудачных вызовов он блокирует весь трафик к службе. Периодически это позволяет вызываемому пробному вызову определить, устранена ли ошибка. На рис. 6-3 показан шаблон автоматического выключения цепи в действии.

![Шаблон автоматического прерывания в действии](./media/circuit-breaker-pattern.png)

**Рис. 6-3**. Шаблон автоматического прерывания в действии

На предыдущем рисунке к исходному шаблону повтора добавлен шаблон автоматического выключения. Обратите внимание, что после 100 неудачных запросов автоматически открываются вызовы, которые больше не допускают обращения к службе. Значение ЧеккЦиркуит, заданное в течение 30 секунд, указывает, как часто библиотека разрешает выполнение одного запроса к службе. Если этот вызов завершается, канал закрывается, а служба снова становится доступной для трафика.

Помните, что цель шаблона автоматического выключения *отличается* от цели шаблона повторного выполнения. Шаблон повторных попыток позволяет приложению повторить операцию в ожидании, что оно будет выполняться. Шаблон автоматического выключения не позволяет приложению выполнить операцию, которая, скорее всего, завершится ошибкой. Как правило, приложение *объединяет* эти два шаблона, используя шаблон повтора для вызова операции через автоматическое выключение.

## <a name="testing-for-resiliency"></a>Тестирование отказоустойчивости

Проверка устойчивости не всегда выполняется точно так же, как тестирование функциональности приложения (путем выполнения модульных тестов, интеграционных тестов и т. д.). Вместо этого вы должны проверить, как сквозная рабочая нагрузка выполняется в условиях сбоя, которые происходят только периодически. Например: Вставка сбоев с помощью процессов аварийного завершения, просроченных сертификатов, недоступность зависимых служб и т. д. Такие платформы, как [Chaos-обезьяна](https://github.com/Netflix/chaosmonkey) , можно использовать для такого тестирования Chaos.

Устойчивость приложений является обязательной для обработки проблемно запрашиваемых операций. Но это лишь половина истории. Далее мы рассмотрим функции устойчивости, доступные в облаке Azure.

>[!div class="step-by-step"]
>[Назад](resiliency.md)
>[Вперед](infrastructure-resiliency-azure.md)
