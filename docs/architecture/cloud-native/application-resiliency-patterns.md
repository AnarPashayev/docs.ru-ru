---
title: Шаблоны устойчивости приложения
description: Создание архитектуры облачных приложений .NET для Azure | Шаблоны устойчивости приложений
ms.date: 06/30/2019
ms.openlocfilehash: 13811efaa88e0bd2824add1c8712b78b18d46375
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73841891"
---
# <a name="application-resiliency-patterns"></a><span data-ttu-id="42e92-103">Шаблоны устойчивости приложения</span><span class="sxs-lookup"><span data-stu-id="42e92-103">Application resiliency patterns</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="42e92-104">Первой линией обороны является устойчивость приложений с поддержкой программного обеспечения.</span><span class="sxs-lookup"><span data-stu-id="42e92-104">The first line of defense is software-enabled application resiliency.</span></span>

<span data-ttu-id="42e92-105">Хотя вы можете вкладывать значительное время в собственную платформу устойчивости, такие продукты уже существуют.</span><span class="sxs-lookup"><span data-stu-id="42e92-105">While you could invest considerable time writing your own resiliency framework, such products already exist.</span></span> <span data-ttu-id="42e92-106">Например, [Polly](http://www.thepollyproject.org/) — это комплексная библиотека устойчивости и обработки временных ошибок .NET, которая позволяет разработчикам выразить политики устойчивости в свободном и потокобезопасным способах.</span><span class="sxs-lookup"><span data-stu-id="42e92-106">For example, [Polly](http://www.thepollyproject.org/) is a comprehensive .NET resilience and transient-fault-handling library that allows developers to express resiliency policies in a fluent and thread-safe manner.</span></span> <span data-ttu-id="42e92-107">Polly предназначен для приложений, созданных с помощью полной .NET Framework или .NET Core.</span><span class="sxs-lookup"><span data-stu-id="42e92-107">Polly targets applications built with either the full .NET Framework or .NET Core.</span></span> <span data-ttu-id="42e92-108">На рис. 6-2 показаны политики устойчивости (т. е. функциональность), доступные из библиотеки Polly.</span><span class="sxs-lookup"><span data-stu-id="42e92-108">Figure 6-2 shows the resiliency policies (that is, functionality) available from the Polly Library.</span></span> <span data-ttu-id="42e92-109">Эти политики можно применять по отдельности или совместно.</span><span class="sxs-lookup"><span data-stu-id="42e92-109">These policies can be applied individually or combined together.</span></span>

![Polly Framework](./media/polly-resiliency-framework.png)

<span data-ttu-id="42e92-111">**Рис. 6-2**.</span><span class="sxs-lookup"><span data-stu-id="42e92-111">**Figure 6-2**.</span></span> <span data-ttu-id="42e92-112">Функции платформы устойчивости Polly</span><span class="sxs-lookup"><span data-stu-id="42e92-112">Polly resiliency framework features</span></span>

<span data-ttu-id="42e92-113">Обратите внимание, как на предыдущем рисунке политики устойчивости применяются к сообщениям запроса независимо от того, поступает ли он от внешнего клиента или другой серверной службы.</span><span class="sxs-lookup"><span data-stu-id="42e92-113">Note how in the previous figure the resiliency policies apply to request messages, whether coming from an external client or another back-end service.</span></span> <span data-ttu-id="42e92-114">Цель — компенсировать запрос службы, которая может быть недоступна мгновенно.</span><span class="sxs-lookup"><span data-stu-id="42e92-114">The goal is to compensate the request for a service that might be momentarily unavailable.</span></span> <span data-ttu-id="42e92-115">Эти короткие перерывы, как правило, переводят себя с кодом состояния HTTP, показанным на рис. 6-3.</span><span class="sxs-lookup"><span data-stu-id="42e92-115">These short interruptions typically manifest themselves with the HTTP status codes shown in Figure 6-3.</span></span>

![Коды состояния HTTP для повторной попытки](./media/http-status-codes.png)

<span data-ttu-id="42e92-117">**Рис. 6-3.**</span><span class="sxs-lookup"><span data-stu-id="42e92-117">**Figure 6-3**.</span></span> <span data-ttu-id="42e92-118">Коды состояния HTTP для повторной попытки</span><span class="sxs-lookup"><span data-stu-id="42e92-118">HTTP status codes to retry</span></span>

<span data-ttu-id="42e92-119">Вопрос. можно ли повторить код состояния HTTP 403-запрещено?</span><span class="sxs-lookup"><span data-stu-id="42e92-119">Question: Would you retry an HTTP Status Code of 403 - Forbidden?</span></span> <span data-ttu-id="42e92-120">Нет.</span><span class="sxs-lookup"><span data-stu-id="42e92-120">No.</span></span> <span data-ttu-id="42e92-121">В этом случае система работает правильно, но сообщает вызывающему объекту, что он не имеет прав для выполнения запрошенной операции.</span><span class="sxs-lookup"><span data-stu-id="42e92-121">Here, the system is functioning properly, but informing the caller that they aren't authorized to perform the requested operation.</span></span> <span data-ttu-id="42e92-122">Необходимо соблюдать осторожность, чтобы повторить только операции, вызванные сбоями.</span><span class="sxs-lookup"><span data-stu-id="42e92-122">Care must be taken to retry only those operations caused by failures.</span></span>

<span data-ttu-id="42e92-123">Как мы рекомендуем в главе 1, разработчики Майкрософт, создающие облачные приложения, должны ориентироваться на .NET Core.</span><span class="sxs-lookup"><span data-stu-id="42e92-123">As recommended in Chapter 1, Microsoft developers constructing cloud-native applications should target .NET Core.</span></span> <span data-ttu-id="42e92-124">В версии 2,1 появилась библиотека [хттпклиентфактори](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) для создания экземпляров клиентов HTTP для взаимодействия с ресурсами на основе URL-адресов.</span><span class="sxs-lookup"><span data-stu-id="42e92-124">Version 2.1 introduced the [HTTPClientFactory](https://www.stevejgordon.co.uk/introduction-to-httpclientfactory-aspnetcore) library for creating HTTP Client instances for interacting with URL-based resources.</span></span> <span data-ttu-id="42e92-125">Заменяя исходный класс HTTPClient, класс фабрики поддерживает множество улучшенных функций, одна из которых [тесно интегрируется](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) с библиотекой устойчивости Polly.</span><span class="sxs-lookup"><span data-stu-id="42e92-125">Superseding the original HTTPClient class, the factory class supports many enhanced features, one of which is [tight integration](../microservices/implement-resilient-applications/implement-http-call-retries-exponential-backoff-polly.md) with the Polly resiliency library.</span></span> <span data-ttu-id="42e92-126">С его помощью можно легко определить политики устойчивости в классе запуска приложения для решения частичных сбоев и проблем с подключением.</span><span class="sxs-lookup"><span data-stu-id="42e92-126">With it, you can easily define resiliency policies in the application Startup class to handle partial failures and connectivity issues.</span></span>

<span data-ttu-id="42e92-127">Теперь давайте разберем шаблоны повтора и повторного запуска.</span><span class="sxs-lookup"><span data-stu-id="42e92-127">Next, let's expand on retry and circuit breaker patterns.</span></span>

### <a name="retry-pattern"></a><span data-ttu-id="42e92-128">Шаблон повторных попыток</span><span class="sxs-lookup"><span data-stu-id="42e92-128">Retry pattern</span></span>

<span data-ttu-id="42e92-129">В распределенной облачной среде вызовы служб и облачных ресурсов могут завершаться сбоем из-за временных сбоев (кратковременных), которые обычно исправляются по истечении короткого периода времени.</span><span class="sxs-lookup"><span data-stu-id="42e92-129">In a distributed cloud-native environment, calls to services and cloud resources can fail because of transient (short-lived) failures, which typically correct themselves after a brief period of time.</span></span> <span data-ttu-id="42e92-130">Реализация стратегии повторных попыток позволяет облачной службе справиться с этими сценариями.</span><span class="sxs-lookup"><span data-stu-id="42e92-130">Implementing a retry strategy helps a cloud-native service handle these scenarios.</span></span>

<span data-ttu-id="42e92-131">[Шаблон повторных попыток](https://docs.microsoft.com/azure/architecture/patterns/retry) позволяет службе повторить операцию невыполненного запроса (настраивается) количество раз с экспоненциально увеличивающимся временем ожидания.</span><span class="sxs-lookup"><span data-stu-id="42e92-131">The [Retry pattern](https://docs.microsoft.com/azure/architecture/patterns/retry) enables a service to retry a failed request operation a (configurable) number of times with an exponentially increasing wait time.</span></span> <span data-ttu-id="42e92-132">На рис. 6-4 показана повторная попытка в действии.</span><span class="sxs-lookup"><span data-stu-id="42e92-132">Figure 6-4 shows a retry in action.</span></span>

![Шаблон повторных попыток в действии](./media/retry-pattern.png)

<span data-ttu-id="42e92-134">**Рис. 6-4**.</span><span class="sxs-lookup"><span data-stu-id="42e92-134">**Figure 6-4**.</span></span> <span data-ttu-id="42e92-135">Шаблон повторных попыток в действии</span><span class="sxs-lookup"><span data-stu-id="42e92-135">Retry pattern in action</span></span>

<span data-ttu-id="42e92-136">На предыдущем рисунке для операции запроса был реализован шаблон повтора.</span><span class="sxs-lookup"><span data-stu-id="42e92-136">In the previous figure, a retry pattern has been implemented for a request operation.</span></span> <span data-ttu-id="42e92-137">Он разрешает до четырех повторных попыток, прежде чем завершать работу с интервалом перехода (время ожидания), начиная с двух секунд, экспоненциально удваивается при каждой последующей попытке.</span><span class="sxs-lookup"><span data-stu-id="42e92-137">It's configured to allow up to four retries before failing with a backoff interval (wait time) starting at two seconds, which exponentially doubles for each subsequent attempt.</span></span>

- <span data-ttu-id="42e92-138">При первом вызове происходит сбой и возвращается код состояния HTTP 500.</span><span class="sxs-lookup"><span data-stu-id="42e92-138">The first invocation fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="42e92-139">Приложение ожидает две секунды и повторяет вызов.</span><span class="sxs-lookup"><span data-stu-id="42e92-139">The application waits for two seconds and retries the call.</span></span>
- <span data-ttu-id="42e92-140">Второй вызов также завершается ошибкой и возвращает код состояния HTTP 500.</span><span class="sxs-lookup"><span data-stu-id="42e92-140">The second invocation also fails and returns an HTTP status code of 500.</span></span> <span data-ttu-id="42e92-141">Теперь приложение удваивает интервал отхода до четырех секунд и повторяет вызов.</span><span class="sxs-lookup"><span data-stu-id="42e92-141">The application now doubles the backoff interval to four seconds and retries the call.</span></span>
- <span data-ttu-id="42e92-142">Наконец, третий вызов будет выполнен.</span><span class="sxs-lookup"><span data-stu-id="42e92-142">Finally, the third call succeeds.</span></span>
- <span data-ttu-id="42e92-143">В этом сценарии операция повтора попыталась выполнить до четырех повторных попыток, не выполняя при этом вызов.</span><span class="sxs-lookup"><span data-stu-id="42e92-143">In this scenario, the retry operation would have attempted up to four retries while doubling the backoff duration before failing the call.</span></span>

<span data-ttu-id="42e92-144">Важно увеличить период отсрочки перед повторным выполнением вызова, чтобы разрешить время службы самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="42e92-144">It's important to increase the backoff period before retrying the call to allow the service time to self-correct.</span></span> <span data-ttu-id="42e92-145">Рекомендуется реализовать экспоненциальное увеличение задержки (удвоение периода при каждой повторной попытке), чтобы обеспечить адекватное время исправления.</span><span class="sxs-lookup"><span data-stu-id="42e92-145">It's a best practice to implement an exponentially increasing backoff (doubling the period on each retry) to allow adequate correction time.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="42e92-146">Шаблон автоматического выключения</span><span class="sxs-lookup"><span data-stu-id="42e92-146">Circuit breaker pattern</span></span>

<span data-ttu-id="42e92-147">Хотя шаблон повторных попыток может помочь в восстановлении запроса, запутанными в частичный сбой, бывают ситуации, когда сбои могут быть вызваны непредвиденными событиями, требующими более длительных периодов времени для разрешения.</span><span class="sxs-lookup"><span data-stu-id="42e92-147">While the retry pattern can help salvage a request entangled in a partial failure, there are situations where failures can be caused by unanticipated events that will require longer periods of time to resolve.</span></span> <span data-ttu-id="42e92-148">Такие сбои могут быть различной степени серьезности: от частичной потери соединения до полного отказа службы.</span><span class="sxs-lookup"><span data-stu-id="42e92-148">These faults can range in severity from a partial loss of connectivity to the complete failure of a service.</span></span> <span data-ttu-id="42e92-149">В таких ситуациях приложение не позволяет постоянно повторять операцию, которая вряд ли будет выполнена.</span><span class="sxs-lookup"><span data-stu-id="42e92-149">In these situations, it's pointless for an application to continually retry an operation that is unlikely to succeed.</span></span>

<span data-ttu-id="42e92-150">Чтобы сделать что-то хуже, выполнение непрерывных операций повтора в службе, не поддерживающей реагирование, может привести к самостоятельному сценарию отказа в обслуживании, когда вы перейдете в службу с непрерывными вызовами, такими как память, потоки и база данных. подключения, которые вызывают сбой в несвязанных частях системы, использующих те же ресурсы.</span><span class="sxs-lookup"><span data-stu-id="42e92-150">To make things worse, executing continual retry operations on a non-responsive service can move you into a self-imposed denial of service scenario where you flood your service with continual calls exhausting resources such as memory, threads and database connections, causing failure in unrelated parts of the system that use the same resources.</span></span>

<span data-ttu-id="42e92-151">В таких ситуациях было бы предпочтительнее выполнить операцию неудачно и попытаться вызвать службу только в случае ее удачного завершения.</span><span class="sxs-lookup"><span data-stu-id="42e92-151">In these situations, it would be preferable for the operation to fail immediately and only attempt to invoke the service if it's likely to succeed.</span></span>

<span data-ttu-id="42e92-152">[Шаблон](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) автоматического выключения может помешать приложению многократно пытаться выполнить операцию, которая, скорее всего, завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="42e92-152">The [Circuit Breaker pattern](https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker) can prevent an application from repeatedly trying to execute an operation that's likely to fail.</span></span> <span data-ttu-id="42e92-153">Он также наблюдает за приложением периодическим вызовом пробной версии, чтобы определить, устранена ли ошибка.</span><span class="sxs-lookup"><span data-stu-id="42e92-153">It also monitors the application with a periodic trial call to determine whether the fault has resolved.</span></span> <span data-ttu-id="42e92-154">На рис. 6-5 показан шаблон автоматического выключения цепи в действии.</span><span class="sxs-lookup"><span data-stu-id="42e92-154">Figure 6-5 shows the Circuit Breaker pattern in action.</span></span>

![Шаблон автоматического прерывания в действии](./media/circuit-breaker-pattern.png)

<span data-ttu-id="42e92-156">**Рис. 6-5**.</span><span class="sxs-lookup"><span data-stu-id="42e92-156">**Figure 6-5**.</span></span> <span data-ttu-id="42e92-157">Шаблон автоматического прерывания в действии</span><span class="sxs-lookup"><span data-stu-id="42e92-157">Circuit breaker pattern in action</span></span>

<span data-ttu-id="42e92-158">На предыдущем рисунке к исходному шаблону повтора добавлен шаблон автоматического выключения.</span><span class="sxs-lookup"><span data-stu-id="42e92-158">In the previous figure, a Circuit Breaker pattern has been added to the original retry pattern.</span></span> <span data-ttu-id="42e92-159">Обратите внимание, что после 10 неудачных запросов автоматическое открытие отключено и больше не разрешает вызовы службы.</span><span class="sxs-lookup"><span data-stu-id="42e92-159">Note how after 10 failed requests, the circuit breakers opens and no longer allows calls to the service.</span></span> <span data-ttu-id="42e92-160">Значение ЧеккЦиркуит, заданное в течение 30 секунд, указывает, как часто библиотека разрешает выполнение одного запроса к службе.</span><span class="sxs-lookup"><span data-stu-id="42e92-160">The CheckCircuit value, set at 30 seconds, specifies how often the library allows one request to proceed to the service.</span></span> <span data-ttu-id="42e92-161">Если этот вызов завершается, канал закрывается, а служба снова становится доступной для трафика.</span><span class="sxs-lookup"><span data-stu-id="42e92-161">If that call succeeds, the circuit closes and the service is once again available to traffic.</span></span>

<span data-ttu-id="42e92-162">Помните, что цель шаблона автоматического выключения *отличается* от цели шаблона повторного выполнения.</span><span class="sxs-lookup"><span data-stu-id="42e92-162">Keep in mind that the intent of the Circuit Breaker pattern is *different* than that of the Retry pattern.</span></span> <span data-ttu-id="42e92-163">Шаблон повторных попыток позволяет приложению повторить операцию в ожидании, что оно будет выполняться.</span><span class="sxs-lookup"><span data-stu-id="42e92-163">The Retry pattern enables an application to retry an operation in the expectation that it will succeed.</span></span> <span data-ttu-id="42e92-164">Шаблон автоматического выключения не позволяет приложению выполнить операцию, которая, скорее всего, завершится ошибкой.</span><span class="sxs-lookup"><span data-stu-id="42e92-164">The Circuit Breaker pattern prevents an application from doing an operation that is likely to fail.</span></span> <span data-ttu-id="42e92-165">Часто приложение *объединяет* эти два шаблона, используя шаблон повтора для вызова операции через автоматическое выключение.</span><span class="sxs-lookup"><span data-stu-id="42e92-165">Often, an application will *combine* these two patterns by using the Retry pattern to invoke an operation through a circuit breaker.</span></span> <span data-ttu-id="42e92-166">Однако логика повторных попыток должна быть чувствительна к любым исключениям, возвращаемым средством автоматического выключения, и повторять попытки, если автоматическое выключение указывает на то, что сбой не является временным.</span><span class="sxs-lookup"><span data-stu-id="42e92-166">However, the retry logic should be sensitive to any exceptions returned by the circuit breaker and abandon retry attempts if the circuit breaker indicates that a fault isn't transient.</span></span>

<span data-ttu-id="42e92-167">Устойчивость приложений является обязательной для обработки проблемно запрашиваемых операций.</span><span class="sxs-lookup"><span data-stu-id="42e92-167">Application resiliency is a must for handling problematic requested operations.</span></span> <span data-ttu-id="42e92-168">Но это лишь половина истории.</span><span class="sxs-lookup"><span data-stu-id="42e92-168">But, it's only half of the story.</span></span> <span data-ttu-id="42e92-169">Далее мы рассмотрим функции устойчивости, доступные в облаке Azure.</span><span class="sxs-lookup"><span data-stu-id="42e92-169">Next, we cover resiliency features available in the Azure cloud.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="42e92-170">[Назад](resiliency.md)
>[Вперед](infrastructure-resiliency-azure.md)</span><span class="sxs-lookup"><span data-stu-id="42e92-170">[Previous](resiliency.md)
[Next](infrastructure-resiliency-azure.md)</span></span>
