---
title: Устойчивое взаимодействие
description: Создание архитектуры облачных приложений .NET для Azure | Устойчивое взаимодействие
ms.date: 06/30/2019
ms.openlocfilehash: 324f5426af1c892db73aa6fc2336a19b7a8e499e
ms.sourcegitcommit: 628e8147ca10187488e6407dab4c4e6ebe0cac47
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/15/2019
ms.locfileid: "73841225"
---
# <a name="resilient-communications"></a><span data-ttu-id="c062a-103">Устойчивое взаимодействие</span><span class="sxs-lookup"><span data-stu-id="c062a-103">Resilient communications</span></span>

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

<span data-ttu-id="c062a-104">В этой книге мы еванжелизеди о том, что далеко не работали с традиционным монолитным проектированием приложений и используем архитектуру на основе микрослужб, где набор распределенных автономных служб выполняется независимо друг от друга и взаимодействует с каждым другие используют стандартные протоколы связи, такие как HTTP и HTTPS.</span><span class="sxs-lookup"><span data-stu-id="c062a-104">Throughout this book, we've evangelized the merits of moving beyond traditional monolithic application design and embracing a microservice-based architecture where a set of distributed, self-contained services run independently and communicate with each other using standard communication protocols such as HTTP and HTTPS.</span></span> <span data-ttu-id="c062a-105">Хотя такая архитектура покупает многие важные преимущества, она также предоставляет множество проблем.</span><span class="sxs-lookup"><span data-stu-id="c062a-105">While such an architecture buys you many important benefits, it also presents many challenges.</span></span> <span data-ttu-id="c062a-106">Рассмотрим, к примеру, следующие проблемы:</span><span class="sxs-lookup"><span data-stu-id="c062a-106">Consider, for example, the following concerns:</span></span>

- <span data-ttu-id="c062a-107">*Необработанное сетевое взаимодействие.*</span><span class="sxs-lookup"><span data-stu-id="c062a-107">*Out-of-process network communication.*</span></span> <span data-ttu-id="c062a-108">Каждая служба взаимодействует по сетевому протоколу, который представляет перегрузку сети, задержку и временные сбои.</span><span class="sxs-lookup"><span data-stu-id="c062a-108">Each service communicates over a network protocol that introduces network congestion, latency, and transient faults.</span></span>
- <span data-ttu-id="c062a-109">*Обнаружение службы.*</span><span class="sxs-lookup"><span data-stu-id="c062a-109">*Service discovery.*</span></span> <span data-ttu-id="c062a-110">Как службы обнаруживают друг друга и взаимодействуют друг с другом с каждой службой, работающей в кластере компьютеров с собственным IP-адресом и портом?</span><span class="sxs-lookup"><span data-stu-id="c062a-110">With each service running across a cluster of machines with its own IP address and port, how do services discover and communicate with each other?</span></span>
- <span data-ttu-id="c062a-111">*Устойчивость.*</span><span class="sxs-lookup"><span data-stu-id="c062a-111">*Resiliency.*</span></span> <span data-ttu-id="c062a-112">Как управлять кратковременными сбоями и поддерживать стабильность системы?</span><span class="sxs-lookup"><span data-stu-id="c062a-112">How do you manage short-lived failures and keep the system stable?</span></span>
- <span data-ttu-id="c062a-113">*Балансировка нагрузки.*</span><span class="sxs-lookup"><span data-stu-id="c062a-113">*Load balancing.*</span></span> <span data-ttu-id="c062a-114">Как входящий трафик распределяется по нескольким экземплярам службы?</span><span class="sxs-lookup"><span data-stu-id="c062a-114">How does inbound traffic get distributed across multiple instances of a service?</span></span>
- <span data-ttu-id="c062a-115">*Безопасность.*</span><span class="sxs-lookup"><span data-stu-id="c062a-115">*Security.*</span></span> <span data-ttu-id="c062a-116">Как применяются такие проблемы безопасности, как шифрование на транспортном уровне и управление сертификатами?</span><span class="sxs-lookup"><span data-stu-id="c062a-116">How are security concerns such as transport-level encryption and certificate management enforced?</span></span>
- <span data-ttu-id="c062a-117">*Распределенный мониторинг.*</span><span class="sxs-lookup"><span data-stu-id="c062a-117">*Distributed Monitoring.*</span></span> <span data-ttu-id="c062a-118">— Как вы устанавливаете и отслеживаете трассировку и мониторинг для одного запроса в нескольких потребленных службах?</span><span class="sxs-lookup"><span data-stu-id="c062a-118">- How do you correlate and capture traceability and monitoring for a single request across multiple consuming services?</span></span>

<span data-ttu-id="c062a-119">Хотя эти проблемы могут быть решены с помощью различных библиотек и платформ, их реализация в базе кода может быть дорогостоящей, сложной и трудоемкой.</span><span class="sxs-lookup"><span data-stu-id="c062a-119">While these concerns can be addressed with various libraries and frameworks, implementing them inside your codebase can be expensive, complex, and time-consuming.</span></span> <span data-ttu-id="c062a-120">Более того, у вас есть решение о том, что проблемы с инфраструктурой связаны с бизнес-логикой.</span><span class="sxs-lookup"><span data-stu-id="c062a-120">Moreover, you end up with a solution where infrastructure concerns are coupled to business logic.</span></span>

## <a name="service-mesh"></a><span data-ttu-id="c062a-121">Сеть службы</span><span class="sxs-lookup"><span data-stu-id="c062a-121">Service mesh</span></span>

<span data-ttu-id="c062a-122">Лучшим подходом является рассмотрение новой и быстро развивающейся *сети*с технологией.</span><span class="sxs-lookup"><span data-stu-id="c062a-122">A better approach is to consider a new and rapidly evolving technology entitled *Service Mesh*.</span></span> <span data-ttu-id="c062a-123">[Сетка служб](https://www.nginx.com/blog/what-is-a-service-mesh/) — это настраиваемый уровень инфраструктуры со встроенными возможностями для управления взаимодействием служб и многими из описанных выше проблем.</span><span class="sxs-lookup"><span data-stu-id="c062a-123">A [service mesh](https://www.nginx.com/blog/what-is-a-service-mesh/) is a configurable infrastructure layer with built-in capabilities to handle service communication and many of the challenges mentioned above.</span></span> <span data-ttu-id="c062a-124">Он отделяет эти проблемы от вашего бизнес-кода и перемещает их в прокси-сервер службы, экземпляр, сопровождающий каждую из служб.</span><span class="sxs-lookup"><span data-stu-id="c062a-124">It decouples these concerns from your business code and moves them into a service proxy, an instance of which accompanies each of your services.</span></span> <span data-ttu-id="c062a-125">Прокси-сервер сетки служб, часто называемый [шаблоном расширения](https://docs.microsoft.com/azure/architecture/patterns/sidecar), развертывается в отдельный процесс, чтобы обеспечить изоляцию и инкапсуляцию из вашего бизнес-кода.</span><span class="sxs-lookup"><span data-stu-id="c062a-125">Often referred to as the [Sidecar pattern](https://docs.microsoft.com/azure/architecture/patterns/sidecar), the service mesh proxy is deployed into a separate process to provide isolation and encapsulation from your business code.</span></span> <span data-ttu-id="c062a-126">Однако прокси тесно связан с созданной службой вместе с ней и предоставляет общий доступ к ее жизненному циклу.</span><span class="sxs-lookup"><span data-stu-id="c062a-126">However, the proxy is closely linked to the service being created along with it and sharing its lifecycle.</span></span> <span data-ttu-id="c062a-127">Этот сценарий показан на рис. 6-9.</span><span class="sxs-lookup"><span data-stu-id="c062a-127">Figure 6-9 shows this scenario.</span></span>

![Сеть службы с побочным автомобилем](./media/service-mesh-with-side-car.png)

<span data-ttu-id="c062a-129">**Рис. 6-9**.</span><span class="sxs-lookup"><span data-stu-id="c062a-129">**Figure 6-9**.</span></span> <span data-ttu-id="c062a-130">Сеть службы с побочным автомобилем</span><span class="sxs-lookup"><span data-stu-id="c062a-130">Service mesh with a side car</span></span>

<span data-ttu-id="c062a-131">На предыдущем рисунке обратите внимание, как прокси-сервер перехватывает и управляет связью между микрослужбами и кластером.</span><span class="sxs-lookup"><span data-stu-id="c062a-131">In the previous figure, note how the proxy intercepts and manages communication among the microservices and the cluster.</span></span>

<span data-ttu-id="c062a-132">Сетка служб логически разделяется на два разнородных компонента: [плоскость данных](https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc) и [плоскость управления](https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc).</span><span class="sxs-lookup"><span data-stu-id="c062a-132">A service mesh is logically split into two disparate components: A [data plane](https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc) and [control plane](https://blog.envoyproxy.io/service-mesh-data-plane-vs-control-plane-2774e720f7fc).</span></span> <span data-ttu-id="c062a-133">На рис. 6-10 показаны эти компоненты и их обязанности.</span><span class="sxs-lookup"><span data-stu-id="c062a-133">Figure 6-10 shows these components and their responsibilities.</span></span>

![Управление сеткой услуг и плоскость данных](./media/istio-control-and-data-plane.png)

<span data-ttu-id="c062a-135">**Рис. 6-10.**</span><span class="sxs-lookup"><span data-stu-id="c062a-135">**Figure 6-10.**</span></span> <span data-ttu-id="c062a-136">Управление сеткой услуг и плоскость данных</span><span class="sxs-lookup"><span data-stu-id="c062a-136">Service mesh control and data plane</span></span>

<span data-ttu-id="c062a-137">После настройки сеть службы сильно функционирует.</span><span class="sxs-lookup"><span data-stu-id="c062a-137">Once configured, a service mesh is highly functional.</span></span> <span data-ttu-id="c062a-138">Он может получить соответствующий пул экземпляров из конечной точки обнаружения службы.</span><span class="sxs-lookup"><span data-stu-id="c062a-138">It can retrieve a corresponding pool of instances from a service discovery endpoint.</span></span> <span data-ttu-id="c062a-139">Затем он может отправить запрос к определенному экземпляру, записывая тип задержки и ответа результата.</span><span class="sxs-lookup"><span data-stu-id="c062a-139">It can then send a request to a specific instance, recording the latency and response type of the result.</span></span> <span data-ttu-id="c062a-140">Сетка может выбрать экземпляр, который, скорее всего, будет возвращать быстрый ответ на основе многих факторов, включая наблюдаемую задержку для последних запросов.</span><span class="sxs-lookup"><span data-stu-id="c062a-140">A mesh can choose the instance most likely to return a fast response based on many factors, including its observed latency for recent requests.</span></span>

<span data-ttu-id="c062a-141">Если экземпляр не отвечает или завершается ошибкой, сеть может повторить запрос на другом экземпляре.</span><span class="sxs-lookup"><span data-stu-id="c062a-141">If an instance is unresponsive or fails, the mesh can retry the request on another instance.</span></span> <span data-ttu-id="c062a-142">Если пул постоянно возвращает ошибки, сеть может исключить ее из пула балансировки нагрузки, чтобы периодически выполнять повторную попытку после сброса.</span><span class="sxs-lookup"><span data-stu-id="c062a-142">If a pool consistently returns errors, a mesh can evict it from the load-balancing pool to be retried periodically later after it heals.</span></span> <span data-ttu-id="c062a-143">Если время ожидания запроса истекло, произойдет сбой сетки, а затем повторите запрос.</span><span class="sxs-lookup"><span data-stu-id="c062a-143">If a request times out, a mesh can fail and then retry the request.</span></span> <span data-ttu-id="c062a-144">Сетка захватывает поведение в виде метрик и распределенной трассировки, которую затем можно передать в централизованную систему метрик.</span><span class="sxs-lookup"><span data-stu-id="c062a-144">A mesh captures behavior in the form of metrics and distributed tracing, which then can be emitted to a centralized metrics system.</span></span>

## <a name="istio-and-envoy"></a><span data-ttu-id="c062a-145">Istio и делегат</span><span class="sxs-lookup"><span data-stu-id="c062a-145">Istio and Envoy</span></span>

<span data-ttu-id="c062a-146">Хотя в настоящее время существует несколько параметров сетки служб, [Istio](https://istio.io/docs/concepts/what-is-istio/) является самым популярным на момент написания этой статьи.</span><span class="sxs-lookup"><span data-stu-id="c062a-146">While a few service mesh options currently exist, [Istio](https://istio.io/docs/concepts/what-is-istio/) is the most popular as of the time of this writing.</span></span> <span data-ttu-id="c062a-147">Совместное предприятие от IBM, Google и Лифт — это предложение с открытым кодом, которое можно интегрировать в новое или существующее распределенное приложение.</span><span class="sxs-lookup"><span data-stu-id="c062a-147">A joint venture from IBM, Google, and Lyft, it's an open-source offering that can be integrated into a new or existing distributed application.</span></span> <span data-ttu-id="c062a-148">Она предоставляет единообразное и полное решение для защиты и подключения микрослужб, а также для их мониторинга.</span><span class="sxs-lookup"><span data-stu-id="c062a-148">It provides a consistent and complete solution to secure, connect, and monitor microservices.</span></span> <span data-ttu-id="c062a-149">Его функции включают:</span><span class="sxs-lookup"><span data-stu-id="c062a-149">Its features include:</span></span>

- <span data-ttu-id="c062a-150">Защита обмена данными между службами в кластере с помощью надежной проверки подлинности и авторизации на основе удостоверений.</span><span class="sxs-lookup"><span data-stu-id="c062a-150">Secure service-to-service communication in a cluster with strong identity-based authentication and authorization.</span></span>
- <span data-ttu-id="c062a-151">Автоматическая балансировка нагрузки для трафика HTTP, [gRPC](https://grpc.io/), WEBSOCKET и TCP.</span><span class="sxs-lookup"><span data-stu-id="c062a-151">Automatic load balancing for HTTP, [gRPC](https://grpc.io/), WebSocket, and TCP traffic.</span></span>
- <span data-ttu-id="c062a-152">Детальное управление поведением трафика с богатыми правилами маршрутизации, повторными попытками, отработкой отказа и внедрением ошибок.</span><span class="sxs-lookup"><span data-stu-id="c062a-152">Fine-grained control of traffic behavior with rich routing rules, retries, failovers, and fault injection.</span></span>
- <span data-ttu-id="c062a-153">Подключаемый уровень политики и API конфигурации, поддерживающий элементы управления доступом, ограничения скорости и квоты.</span><span class="sxs-lookup"><span data-stu-id="c062a-153">A pluggable policy layer and configuration API supporting access controls, rate limits, and quotas.</span></span>
- <span data-ttu-id="c062a-154">Автоматические метрики, журналы и трассировки для всего трафика в кластере, включая входящие и исходящие данные кластера.</span><span class="sxs-lookup"><span data-stu-id="c062a-154">Automatic metrics, logs, and traces for all traffic within a cluster, including cluster ingress and egress.</span></span>

<span data-ttu-id="c062a-155">Ключевым компонентом для реализации Istio является служба прокси-сервера с [представителем прокси](https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy).</span><span class="sxs-lookup"><span data-stu-id="c062a-155">A key component for an Istio implementation is a proxy service entitled the [Envoy proxy](https://www.envoyproxy.io/docs/envoy/latest/intro/what_is_envoy).</span></span> <span data-ttu-id="c062a-156">Исходя из Лифт и, в дальнейшем, внесены в [облачный машинный фундамент](https://www.cncf.io/) (рассматривается в главе 1), прокси-сервер работает вместе с каждой службой и предоставляет независимую от платформы основу для следующих функций:</span><span class="sxs-lookup"><span data-stu-id="c062a-156">Originating from Lyft and subsequently contributed to the [Cloud Native Computing Foundation](https://www.cncf.io/) (discussed in chapter 1), the Envoy proxy runs alongside each service and provides a platform-agnostic foundation for the following features:</span></span>

- <span data-ttu-id="c062a-157">Динамическое обнаружение служб.</span><span class="sxs-lookup"><span data-stu-id="c062a-157">Dynamic service discovery.</span></span>
- <span data-ttu-id="c062a-158">Балансировка нагрузки.</span><span class="sxs-lookup"><span data-stu-id="c062a-158">Load balancing.</span></span>
- <span data-ttu-id="c062a-159">Завершение TLS.</span><span class="sxs-lookup"><span data-stu-id="c062a-159">TLS termination.</span></span>
- <span data-ttu-id="c062a-160">Прокси-серверы HTTP и gRPC.</span><span class="sxs-lookup"><span data-stu-id="c062a-160">HTTP and gRPC proxies.</span></span>
- <span data-ttu-id="c062a-161">Устойчивость выключателя.</span><span class="sxs-lookup"><span data-stu-id="c062a-161">Circuit breaker resiliency.</span></span>
- <span data-ttu-id="c062a-162">Проверки работоспособности.</span><span class="sxs-lookup"><span data-stu-id="c062a-162">Health checks.</span></span>
- <span data-ttu-id="c062a-163">Последовательные обновления с развертываниями [ранний](https://martinfowler.com/bliki/CanaryRelease.html) .</span><span class="sxs-lookup"><span data-stu-id="c062a-163">Rolling updates with [canary](https://martinfowler.com/bliki/CanaryRelease.html) deployments.</span></span>

<span data-ttu-id="c062a-164">Как уже говорилось, представитель развертывается как расширения для каждой микрослужбы в кластере.</span><span class="sxs-lookup"><span data-stu-id="c062a-164">As previously discussed, Envoy is deployed as a sidecar to each microservice in the cluster.</span></span>

## <a name="integration-with-azure-kubernetes-services"></a><span data-ttu-id="c062a-165">Интеграция с Azure Kubernetes Services</span><span class="sxs-lookup"><span data-stu-id="c062a-165">Integration with Azure Kubernetes Services</span></span>

<span data-ttu-id="c062a-166">Облако Azure использует Istio и обеспечивает прямую поддержку в Azure Kubernetes Services.</span><span class="sxs-lookup"><span data-stu-id="c062a-166">The Azure cloud embraces Istio and provides direct support for it within Azure Kubernetes Services.</span></span> <span data-ttu-id="c062a-167">Следующие ссылки помогут вам приступить к работе:</span><span class="sxs-lookup"><span data-stu-id="c062a-167">The following links can help you get started:</span></span>

- [<span data-ttu-id="c062a-168">Установка Istio в AKS</span><span class="sxs-lookup"><span data-stu-id="c062a-168">Installing Istio in AKS</span></span>](https://docs.microsoft.com/azure/aks/istio-install)
- [<span data-ttu-id="c062a-169">Использование AKS и Istio</span><span class="sxs-lookup"><span data-stu-id="c062a-169">Using AKS and Istio</span></span>](https://docs.microsoft.com/azure/aks/istio-scenario-routing)

>[!div class="step-by-step"]
><span data-ttu-id="c062a-170">[Назад](infrastructure-resiliency-azure.md)
>[Вперед](monitoring-health.md)</span><span class="sxs-lookup"><span data-stu-id="c062a-170">[Previous](infrastructure-resiliency-azure.md)
[Next](monitoring-health.md)</span></span>
