---
title: Шаблоны наблюдаемости
description: Шаблоны наблюдаемых приложений для облачных машин
ms.date: 09/23/2019
ms.openlocfilehash: 23320144c03278d631b8a1fcc1d1c0954e907296
ms.sourcegitcommit: 55f438d4d00a34b9aca9eedaac3f85590bb11565
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/23/2019
ms.locfileid: "73841069"
---
# <a name="observability-patterns"></a>Шаблоны наблюдаемости

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

Так же, как шаблоны были разработаны для облегчения размещения кода в приложениях, существуют шаблоны для операционных приложений в надежном виде. Появилось три полезных шаблона обслуживания приложений: ведение журнала, мониторинг и оповещения.

## <a name="when-to-use-logging"></a>Когда следует использовать ведение журнала

Независимо от того, насколько внимательны мы, приложения практически всегда ведут себя неожиданным образом в рабочей среде. Когда пользователи сообщают о проблемах с приложением, очень полезно иметь возможность увидеть, что произошло с приложением в момент возникновения проблемы. Одним из наиболее удачных и верных способов записи информации о том, что делает приложение во время его работы, является то, что приложение записывает то, что выполняется. Этот процесс называется ведением журнала. При возникновении неисправностей или проблем в рабочей среде цель должна состоять в том, чтобы воспроизводить условия, при которых произошел сбой, в нерабочем окружении. Наличие хорошего ведения журнала — это стратегия, с помощью которой разработчики могут дублировать проблемы в среде, которую можно протестировать и поэкспериментировать с.

### <a name="logging-in-cloud-native-applications"></a>Ведение журнала в собственных облачных приложениях

У каждого языка программирования есть средства, позволяющие записывать журналы, и обычно накладные расходы на запись этих журналов имеют низкий уровень. Многие библиотеки ведения журналов предоставляют различные типы критических событий, которые можно настроить во время выполнения. Например, Библиотека Serilog — это популярная структурированная библиотека ведения журнала для .NET, которая предоставляет следующие уровни ведения журнала.

* Подробный
* Отладка
* Сведения
* Предупреждение
* Error
* Аварий

Эти различные уровни ведения журнала обеспечивают гранулярность ведения журнала. Если приложение работает правильно в рабочей среде, оно может быть настроено на запись только важных сообщений. Если приложение работает неправильно, уровень журнала можно увеличить, чтобы собрать более подробные журналы. Это обеспечивает баланс производительности от простоты отладки.

Высокая производительность средств ведения журнала и тунабилити уровня детализации должны рекомендовать разработчикам часто заноситься в журнал. Многие применяют шаблон для регистрации входа и выхода каждого метода. Такой подход может показаться избыточным, но нередко, что разработчики хотят уменьшить объем ведения журнала. На самом деле, не очень часто выполняются развертывания с целью добавления ведения журнала для проблемного метода. Ошибка на стороне слишком большого объема ведения журнала, а не слишком мало. Обратите внимание, что некоторые средства можно использовать для автоматического предоставления такого рода журналов.

В традиционных приложениях файлы журнала обычно хранились на локальном компьютере. Фактически, в операционных системах, аналогичных UNIX, определена структура папок для хранения журналов, обычно в `/var/log`. Полезность ведения журнала в неструктурированный файл на одном компьютере значительно снизилась в облачной среде. Приложения, производящие журналы, могут не иметь доступа к локальному диску, или локальный диск может быть очень временным, так как контейнеры находятся на физических компьютерах.

Облачные приложения, разработанные с помощью архитектуры микрослужб, также сталкиваются с некоторыми трудностями при работе с средствами ведения журнала на основе файлов. Теперь запросы пользователей могут охватывать несколько служб, которые выполняются на разных компьютерах, и могут включать бессерверные функции без доступа к локальной файловой системе. Соотнесение журналов от пользователя или сеанса между несколькими службами и компьютерами будет очень трудной задачей.

Наконец, число пользователей в некоторых облачных приложениях имеет большое значение. Представьте себе, что каждый пользователь создает сотни строк сообщений журнала при входе в приложение. В изоляции, это может быть управляемым, но более чем 100 000 пользователей и объем журналов становится большим.

К счастью, существует несколько отличный альтернатива использованию ведения журнала на основе файловой системы. Централизованный сервер журналов, на который отправляются все журналы, исправляет все эти проблемы. Журналы собираются приложениями и передаются в центральное приложение ведения журнала, которое индексирует и хранит журналы. Этот класс системы может каждый день получать десятки гигабайт журналов.

Кроме того, при создании журнала, охватывающего множество служб, полезно соблюдать некоторые стандартные рекомендации. Например, создание [идентификатора корреляции](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/) в начале длительного взаимодействия и последующее его ведение в каждом сообщении, связанном с этим взаимодействием, упрощает поиск всех связанных сообщений. Одна из них должна находить только одно сообщение и извлекать идентификатор корреляции, чтобы найти все связанные сообщения. Другой пример — обеспечение того, что формат журнала одинаков для каждой службы, независимо от используемого языка или библиотеки ведения журнала. Эта стандартизация значительно упрощает чтение журналов. На рис. 7-1 показано, как архитектура микрослужб может использовать централизованное ведение журналов в рамках рабочего процесса.

![журналы из различных источников принимаются в централизованное хранилище журналов.](./media/centralized-logging.png)
**рис. 7-1**. Журналы из различных источников принимаются в централизованное хранилище журналов.

## <a name="when-to-use-monitoring"></a>Когда следует использовать мониторинг

Некоторые приложения не являются критически важными. Возможно, они используются только внутри системы, и при возникновении проблемы пользователь может связаться с группой, которой он отвечает, и приложение можно перезапустить. Однако клиенты часто имеют более высокие ожидания для используемых ими приложений. Если необходимо знать, когда возникают проблемы с приложением *до того, как* пользователи выводят или передают уведомление, необходимо отслеживать его текущее состояние. Наблюдение правильно реализовано. Мониторинг может помочь вам узнать об условиях, которые приведут к проблемам, позволяя устранить базовые условия до того, как они повлияют на любое воздействие на пользователя.

## <a name="monitoring-considerations"></a>Рекомендации по мониторингу

Некоторые централизованные системы ведения журналов принимают дополнительную роль в сборе данных телеметрии за пределами чистых журналов. Они могут получать метрики, такие как время выполнения запроса к базе данных, среднее время отклика с веб-сервера и даже средние нагрузки ЦП и нехватка памяти, сообщаемые операционной системой. В сочетании с журналами эти системы могут обеспечить целостное представление работоспособности узлов в системе и приложения в целом.

Возможность сбора метрик средств мониторинга также может быть поставляться вручную в рамках приложения. Бизнес-последовательности, представляющие интерес, такие как регистрация новых пользователей или размещение заказов, могут быть инструментированы таким образом, что увеличивают счетчик в системе центрального мониторинга. Это разблокирует средства мониторинга, чтобы не только отслеживать работоспособность приложения, но и его работоспособность.

Запросы можно создавать в средствах объединения журналов для поиска определенной статистики или закономерностей, которые затем могут отображаться в графической форме на пользовательских панелях мониторинга. Часто группы будут вкладывать в большие, подключенные к стене экраны, которые поворачивают статистику, связанную с приложением. Таким образом, можно легко увидеть проблемы по мере их возникновения.

## <a name="when-to-use-alerts"></a>Когда следует использовать предупреждения

Если вам нужно реагировать на проблемы с приложением, вам нужен какой – то способ оповещения о нужном сотруднике. Это третий шаблон наблюдаемого приложения в собственном облаке, который зависит от ведения журнала и мониторинга. Вашему приложению необходимо войти в систему, чтобы разрешить диагностику проблем, а в некоторых случаях передавать их в средства мониторинга. Он должен выполнять мониторинг для агрегирования метрик приложения и данных о работоспособности в одном месте. После этого можно создать правила, которые активируют предупреждения, если определенные метрики выходят за пределы допустимых уровней.

## <a name="alerts"></a>Предупреждения

Для поиска известных условий сбоя можно создавать запросы к средствам мониторинга. Например, запросы могут искать в входящих журналах события с кодом состояния HTTP 500, что указывает на проблему на веб-сервере. Как только один из них будет обнаружен, можно отправить владельцу исходной службы сообщение электронной почты или сервер SMS, который может начать анализ.

Как правило, одна ошибка 500 недостаточно, чтобы определить, что возникла проблема. Это может означать, что пользователь неправильно вводит пароль или указал неправильные данные. Запросы предупреждений можно создавать, только если обнаружено больше среднего числа ошибок 500.

Одним из наиболее вредных шаблонов в предупреждении является инициация слишком большого количества предупреждений для исследования. Владельцы служб быстро предесенситизедся к ошибкам, которые ранее были исследованы и были неблагоприятными. При возникновении истинных ошибок они будут потеряны при сотнях ложных срабатываний. Притче о кошке от перегрузки [, которая убедимся Wolf](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf) , часто сообщает детям о том, что это очень опасно. Важно убедиться, что срабатывание оповещений говорит о реальной проблеме.

>[!div class="step-by-step"]
>[Назад](monitoring-health.md)
>[Вперед](logging-with-elastic-stack.md)
