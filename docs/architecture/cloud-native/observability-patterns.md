---
title: Шаблоны наблюдаемости
description: Шаблоны наблюдаемых приложений для облачных машин
ms.date: 02/05/2020
ms.openlocfilehash: a821235835b4553760b19887d500a29ca75e133e
ms.sourcegitcommit: 700ea803fb06c5ce98de017c7f76463ba33ff4a9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2020
ms.locfileid: "77448537"
---
# <a name="observability-patterns"></a>Шаблоны наблюдаемости

[!INCLUDE [book-preview](../../../includes/book-preview.md)]

Так же, как шаблоны были разработаны для облегчения размещения кода в приложениях, существуют шаблоны для операционных приложений в надежном виде. Появилось три полезных шаблона обслуживания приложений: **ведение журнала**, **мониторинг**и **оповещения**.

## <a name="when-to-use-logging"></a>Когда следует использовать ведение журнала

Независимо от того, насколько внимательны мы, приложения практически всегда ведут себя неожиданным образом в рабочей среде. Когда пользователи сообщают о проблемах с приложением, очень полезно иметь возможность увидеть, что произошло с приложением в момент возникновения проблемы. Одним из наиболее удачных и верных способов записи информации о том, что делает приложение во время его работы, является то, что приложение записывает то, что выполняется. Этот процесс называется ведением журнала. При возникновении любых сбоев или проблем в рабочей среде цель должна состоять в том, чтобы воспроизвести условия, при которых произошел сбой, в нерабочей. Наличие хорошего ведения журнала — это стратегия, с помощью которой разработчики могут дублировать проблемы в среде, которую можно протестировать и поэкспериментировать с.

### <a name="challenges-when-logging-with-cloud-native-applications"></a>Проблемы при ведении журналов с помощью собственных приложений в облаке

В традиционных приложениях файлы журнала обычно хранятся на локальном компьютере. Фактически, в операционных системах, аналогичных UNIX, определена структура папок для хранения журналов, обычно в `/var/log`.

![запись в файл в монолитном приложении.](./media/single-monolith-logging.png)
рис. **7-1**. Ведение журнала в файл в монолитном приложении.

Полезность ведения журнала в неструктурированный файл на одном компьютере значительно снизилась в облачной среде. Приложения, производящие журналы, могут не иметь доступа к локальному диску, или локальный диск может быть очень временным, так как контейнеры находятся на физических компьютерах. Даже простое масштабирование монолитных приложений на нескольких узлах может усложнить Поиск соответствующего файла журнала на основе файлов.

![ведение журнала в файлы в масштабируемом монолитном приложении.](./media/multiple-node-monolith-logging.png)
**рис. 7-2**. Ведение журнала для файлов в масштабируемом монолитном приложении.

Облачные приложения, разработанные с помощью архитектуры микрослужб, также сталкиваются с некоторыми трудностями при работе с средствами ведения журнала на основе файлов. Теперь запросы пользователей могут охватывать несколько служб, которые выполняются на разных компьютерах, и могут включать бессерверные функции без доступа к локальной файловой системе. Соотнесение журналов от пользователя или сеанса между несколькими службами и компьютерами будет очень трудной задачей.

![ведение журнала для локальных файлов в приложении микрослужб.](./media/local-log-file-per-service.png)
**рис. 7-3**. Ведение журнала для локальных файлов в приложении микрослужб.

Наконец, число пользователей в некоторых облачных приложениях имеет большое значение. Представьте себе, что каждый пользователь создает сотни строк сообщений журнала при входе в приложение. В изоляции, это может быть управляемым, но более 100 000 пользователей и объем журналов достаточно велики, что для поддержки эффективного использования журналов требуются специализированные средства.

### <a name="logging-in-cloud-native-applications"></a>Ведение журнала в собственных облачных приложениях

У каждого языка программирования есть средства, позволяющие записывать журналы, и обычно накладные расходы на запись этих журналов имеют низкий уровень. Многие библиотеки ведения журналов предоставляют различные типы критических событий, которые можно настроить во время выполнения. Например, [Библиотека Serilog](https://serilog.net/) — это популярная структурированная библиотека ведения журнала для .NET, которая предоставляет следующие уровни ведения журнала:

* Подробный
* Отладка
* Сведения
* Предупреждение
* Ошибка
* Аварий

Эти различные уровни ведения журнала обеспечивают гранулярность ведения журнала. Если приложение работает правильно в рабочей среде, оно может быть настроено на запись только важных сообщений. Если приложение работает неправильно, уровень журнала можно увеличить, чтобы собрать более подробные журналы. Это обеспечивает баланс производительности от простоты отладки.

Высокая производительность средств ведения журнала и тунабилити уровня детализации должны рекомендовать разработчикам часто заноситься в журнал. Многие применяют шаблон для регистрации входа и выхода каждого метода. Такой подход может показаться избыточным, но нередко, что разработчики хотят уменьшить объем ведения журнала. На самом деле, не очень часто выполняются развертывания с целью добавления ведения журнала для проблемного метода. Ошибка на стороне слишком большого объема ведения журнала, а не слишком мало. Для автоматического предоставления такого рода журналов можно использовать некоторые средства.

Из-за проблем, связанных с использованием файловых журналов в облачных приложениях, рекомендуется использовать централизованные журналы. Журналы собираются приложениями и передаются в центральное приложение ведения журнала, которое индексирует и хранит журналы. Этот класс системы может каждый день получать десятки гигабайт журналов.

Кроме того, при создании журнала, охватывающего множество служб, полезно соблюдать некоторые стандартные рекомендации. Например, создание [идентификатора корреляции](https://blog.rapid7.com/2016/12/23/the-value-of-correlation-ids/) в начале длительного взаимодействия и последующее его ведение в каждом сообщении, связанном с этим взаимодействием, упрощает поиск всех связанных сообщений. Одна из них должна находить только одно сообщение и извлекать идентификатор корреляции, чтобы найти все связанные сообщения. Другой пример — обеспечение того, что формат журнала одинаков для каждой службы, независимо от используемого языка или библиотеки ведения журнала. Эта стандартизация значительно упрощает чтение журналов. На рис. 7-4 показано, как архитектура микрослужб может использовать централизованное ведение журналов в рамках рабочего процесса.

![журналы из различных источников принимаются в централизованное хранилище журналов.](./media/centralized-logging.png)
**рис. 7-4**. Журналы из различных источников принимаются в централизованное хранилище журналов.

## <a name="challenges-with-detecting-and-responding-to-potential-app-health-issues"></a>Проблемы с обнаружением и реагированием на потенциальные проблемы работоспособности приложений

Некоторые приложения не являются критически важными. Возможно, они используются только внутри системы, и при возникновении проблемы пользователь может связаться с группой, которой он отвечает, и приложение можно перезапустить. Однако клиенты часто имеют более высокие ожидания для используемых ими приложений. Вам следует узнать, когда возникают проблемы с вашим приложением *перед тем* , как пользователи будут уведомлены. В противном случае, первое, что вы узнаете о проблеме, может быть замечено при обнаружении злость грудеа публикации социальных сетей, в которой размещается приложение или даже ваша организация.

В некоторых сценариях может потребоваться рассмотреть следующее:

- Одна служба в приложении сохраняет сбои и перезапуски, что приводит к периодическим медленным ответам.
- В некоторые моменты дня время ответа приложения будет задолго.
- После последнего развертывания нагрузка на базу данных перегружается.

Наблюдение правильно реализовано. Мониторинг может помочь вам узнать об условиях, которые приведут к проблемам, позволяя устранить основные условия, прежде чем они приведут к значительным последствиям для пользователя.

### <a name="monitoring-cloud-native-apps"></a>Мониторинг облачных приложений

Некоторые централизованные системы ведения журналов принимают дополнительную роль в сборе данных телеметрии за пределами чистых журналов. Они могут получать метрики, такие как время выполнения запроса к базе данных, среднее время отклика с веб-сервера и даже средние нагрузки ЦП и нехватка памяти, сообщаемые операционной системой. В сочетании с журналами эти системы могут обеспечить целостное представление работоспособности узлов в системе и приложения в целом.

Возможности сбора метрик для средств мониторинга можно также поставлять вручную в приложении. Бизнес-последовательности, представляющие интерес, такие как регистрация новых пользователей или размещение заказов, могут быть инструментированы таким образом, что увеличивают счетчик в системе центрального мониторинга. Это разблокирует средства мониторинга, чтобы не только отслеживать работоспособность приложения, но и его работоспособность.

Запросы можно создавать в средствах объединения журналов для поиска определенной статистики или закономерностей, которые затем могут отображаться в графической форме на пользовательских панелях мониторинга. Часто группы будут вкладывать в большие, подключенные к стене экраны, которые поворачивают статистику, связанную с приложением. Таким образом, можно легко увидеть проблемы по мере их возникновения.

Облачные средства мониторинга обеспечивают телеметрию и анализ в реальном времени для приложений независимо от того, являются ли они однопроцессными монолитными приложениями или распределенными архитектурами микрослужб. Они включают в себя средства, позволяющие собирать данные из приложения, а также средства для запроса и отображения сведений о работоспособности приложения.

## <a name="challenges-with-reacting-to-critical-problems-in-cloud-native-apps"></a>Проблемы, связанные с реагированием на критические проблемы в облачных приложениях

Если вам нужно реагировать на проблемы с приложением, вам нужен какой – то способ оповещения о нужном сотруднике. Это третий шаблон наблюдаемого приложения в собственном облаке, который зависит от ведения журнала и мониторинга. Вашему приложению необходимо войти в систему, чтобы разрешить диагностику проблем, а в некоторых случаях передавать их в средства мониторинга. Он должен выполнять мониторинг для агрегирования метрик приложения и данных о работоспособности в одном месте. После этого можно создать правила, которые активируют предупреждения, если определенные метрики выходят за пределы допустимых уровней.

Как правило, оповещения размещаются поверх наблюдения таким образом, что определенные условия инициируют соответствующие предупреждения, чтобы уведомлять членов группы о срочных проблемах. Ниже перечислены некоторые сценарии, которые могут потребовать оповещения.

- Одна из служб вашего приложения не отвечает через 1 минуту простоя.
- Приложение возвращает неудачные ответы HTTP более чем на 1% запросов.
- Среднее время ответа для основных конечных точек приложения превышает 2000 мс.

### <a name="alerts-in-cloud-native-apps"></a>Оповещения в собственных облачных приложениях

Для поиска известных условий сбоя можно создавать запросы к средствам мониторинга. Например, запросы могут искать в входящих журналах события с кодом состояния HTTP 500, что указывает на проблему на веб-сервере. Как только один из них будет обнаружен, можно отправить владельцу исходной службы сообщение электронной почты или сервер SMS, который может начать анализ.

Однако, как правило, одна ошибка 500 недостаточно, чтобы определить, что возникла проблема. Это может означать, что пользователь неправильно вводит пароль или указал неправильные данные. Запросы предупреждений можно создавать, только если обнаружено больше среднего числа ошибок 500.

Одним из наиболее вредных шаблонов в предупреждении является инициация слишком большого количества предупреждений для исследования. Владельцы служб быстро предесенситизедся к ошибкам, которые ранее были исследованы и были неблагоприятными. Затем при возникновении истинных ошибок они будут потеряны в случае сотен ложных срабатываний. Притче о кошке от перегрузки [, которая убедимся Wolf](https://en.wikipedia.org/wiki/The_Boy_Who_Cried_Wolf) , часто сообщает детям о том, что это очень опасно. Важно убедиться, что срабатывание оповещений говорит о реальной проблеме.

>[!div class="step-by-step"]
>[Назад](monitoring-health.md)
>[Вперед](logging-with-elastic-stack.md)
