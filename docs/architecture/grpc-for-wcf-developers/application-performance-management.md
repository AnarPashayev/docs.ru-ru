---
title: Управление производительностью приложений — gRPC для разработчиков WCF
description: Ведение журнала, метрики и трассировка для ASP.NET Core gRPC приложений.
ms.date: 09/02/2019
ms.openlocfilehash: 2b6a30ab68cb6e2fdc81c59e7faef81064b948c1
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/12/2019
ms.locfileid: "73968182"
---
# <a name="application-performance-management"></a><span data-ttu-id="e5e52-103">Управление производительностью приложений</span><span class="sxs-lookup"><span data-stu-id="e5e52-103">Application Performance Management</span></span>

<span data-ttu-id="e5e52-104">В современных производственных средах, таких как Kubernetes, очень важно иметь возможность отслеживать приложения, чтобы обеспечить их оптимальное выполнение.</span><span class="sxs-lookup"><span data-stu-id="e5e52-104">In modern production environments like Kubernetes, it's very important to be able to monitor applications to ensure they're running optimally.</span></span> <span data-ttu-id="e5e52-105">Такие проблемы, как ведение журнала и метрики, никогда не были более важными.</span><span class="sxs-lookup"><span data-stu-id="e5e52-105">Concerns like logging and metrics have never been more important.</span></span> <span data-ttu-id="e5e52-106">ASP.NET Core, включая gRPC, обладает поддержкой первого класса для создания сообщений журнала и данных метрик и управления ими, а также *трассировки* данных.</span><span class="sxs-lookup"><span data-stu-id="e5e52-106">ASP.NET Core, including gRPC, has first-class support for producing and managing log messages and metrics data, as well as *tracing* data.</span></span> <span data-ttu-id="e5e52-107">В этом разделе подробно рассматриваются эти области.</span><span class="sxs-lookup"><span data-stu-id="e5e52-107">This section will explore these areas in more details.</span></span>

## <a name="logging-vs-metrics"></a><span data-ttu-id="e5e52-108">Ведение журналов и метрик</span><span class="sxs-lookup"><span data-stu-id="e5e52-108">Logging vs Metrics</span></span>

<span data-ttu-id="e5e52-109">Перед изучением сведений о реализации необходимо понять разницу между ведением журнала и метриками.</span><span class="sxs-lookup"><span data-stu-id="e5e52-109">Before looking at the implementation details, it's necessary to understand the difference between logging and metrics.</span></span>

<span data-ttu-id="e5e52-110">Ведение журнала касается текстовых сообщений, которые записывают подробные сведения о том, что произошло в системе.</span><span class="sxs-lookup"><span data-stu-id="e5e52-110">Logging is concerned with text messages that record detailed information about things that have happened in the system.</span></span> <span data-ttu-id="e5e52-111">Сообщения журнала могут содержать данные об исключениях, например трассировки стека, или структурированные данные, которые предоставляют контекст сообщения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-111">Log messages may include exception data like stack traces, or structured data that provides context about the message.</span></span> <span data-ttu-id="e5e52-112">Вывод журнала обычно записывается в хранилище текста с возможностью поиска.</span><span class="sxs-lookup"><span data-stu-id="e5e52-112">Logging output is commonly written to a searchable text store.</span></span>

<span data-ttu-id="e5e52-113">Метрики — это числовые данные, предназначенные для агрегирования и представления с помощью диаграмм и графиков на панели мониторинга, которые предоставляют общее представление о работоспособности и производительности приложения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-113">Metrics refers to numeric data that is designed to be aggregated and presented using charts and graphs in a dashboard that provides a view of the overall health and performance of an application.</span></span> <span data-ttu-id="e5e52-114">Данные метрик можно также использовать для активации автоматических оповещений при превышении порогового значения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-114">Metrics data can also be used to trigger automated alerts when a threshold is exceeded.</span></span> <span data-ttu-id="e5e52-115">В следующем списке приведены некоторые примеры данных метрик.</span><span class="sxs-lookup"><span data-stu-id="e5e52-115">The following list shows some examples of metrics data:</span></span>

- <span data-ttu-id="e5e52-116">Время, затраченное на обработку запросов.</span><span class="sxs-lookup"><span data-stu-id="e5e52-116">Time taken to process requests.</span></span>
- <span data-ttu-id="e5e52-117">Количество запросов в секунду, обрабатываемых экземпляром службы.</span><span class="sxs-lookup"><span data-stu-id="e5e52-117">The number of requests per second being handled by an instance of a service.</span></span>
- <span data-ttu-id="e5e52-118">Количество неудачных запросов в экземпляре.</span><span class="sxs-lookup"><span data-stu-id="e5e52-118">The number of failed requests on an instance.</span></span>

## <a name="logging-in-aspnet-core-grpc"></a><span data-ttu-id="e5e52-119">Вход в систему ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="e5e52-119">Logging in ASP.NET Core gRPC</span></span>

<span data-ttu-id="e5e52-120">ASP.NET Core предоставляет встроенную поддержку ведения журнала в виде пакета NuGet [Microsoft. Extensions. Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-120">ASP.NET Core provides built-in support for logging, in the form of the [Microsoft.Extensions.Logging](https://www.nuget.org/packages/Microsoft.Extensions.Logging) NuGet package.</span></span> <span data-ttu-id="e5e52-121">Основные части этой библиотеки включены в веб-пакет SDK, поэтому нет необходимости устанавливать его вручную.</span><span class="sxs-lookup"><span data-stu-id="e5e52-121">The core parts of this library are included with the Web SDK, so there's no need to install it manually.</span></span> <span data-ttu-id="e5e52-122">По умолчанию сообщения журнала записываются в стандартный вывод ("консоль") и в любой подключенный отладчик.</span><span class="sxs-lookup"><span data-stu-id="e5e52-122">By default, log messages are written to the standard output (the "console") and to any attached debugger.</span></span> <span data-ttu-id="e5e52-123">Для записи журналов в постоянные внешние хранилища данных может потребоваться импортировать [Дополнительные пакеты приемника журнала](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span><span class="sxs-lookup"><span data-stu-id="e5e52-123">To write logs to persistent external data stores, you may need to import [optional logging sink packages](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0#third-party-logging-providers).</span></span>

<span data-ttu-id="e5e52-124">ASP.NET Core gRPC Framework записывает подробные сообщения журнала диагностики в эту платформу ведения журналов, чтобы их можно было обрабатывать и хранить вместе с собственными сообщениями приложения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-124">The ASP.NET Core gRPC framework writes detailed diagnostic logging messages to this logging framework so they can be processed/stored along with your application's own messages.</span></span>

### <a name="produce-log-messages"></a><span data-ttu-id="e5e52-125">Создание сообщений журнала</span><span class="sxs-lookup"><span data-stu-id="e5e52-125">Produce log messages</span></span>

<span data-ttu-id="e5e52-126">Расширение ведения журнала регистрируется автоматически в системе внедрения зависимостей ASP.NET Core, поэтому можно указать средства ведения журнала в качестве параметра конструктора для типов служб gRPC.</span><span class="sxs-lookup"><span data-stu-id="e5e52-126">The logging extension is automatically registered with ASP.NET Core's dependency injection system, so you can specify loggers as a constructor parameter on gRPC service types.</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private readonly ILogger<StockData> _logger;

    public StockData(ILogger<StockData> logger)
    {
        _logger = logger;
    }
}
```

<span data-ttu-id="e5e52-127">Многие сообщения журнала, посвященные запросам, исключениям и т. д., предоставляются компонентами платформы ASP.NET Core и gRPC.</span><span class="sxs-lookup"><span data-stu-id="e5e52-127">Many log messages around requests, exceptions, and so on, are provided by the ASP.NET Core and gRPC framework components.</span></span> <span data-ttu-id="e5e52-128">Добавьте собственные сообщения журнала, чтобы предоставить подробные сведения и контекст о логике приложения, а не о проблемах низкого уровня.</span><span class="sxs-lookup"><span data-stu-id="e5e52-128">Add your own log messages to provide detail and context about application logic rather than lower-level concerns.</span></span>

<span data-ttu-id="e5e52-129">Дополнительные сведения о написании сообщений журнала и доступных приемников ведения журнала и целевых объектах см. в статье [ведение журнала в .NET Core и ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-129">For more information about writing log messages and available logging sinks and targets, see the [Logging in .NET Core and ASP.NET Core](https://docs.microsoft.com/aspnet/core/fundamentals/logging/?view=aspnetcore-3.0) article.</span></span>

## <a name="metrics-in-aspnet-core-grpc"></a><span data-ttu-id="e5e52-130">Метрики в ASP.NET Core gRPC</span><span class="sxs-lookup"><span data-stu-id="e5e52-130">Metrics in ASP.NET Core gRPC</span></span>

<span data-ttu-id="e5e52-131">Среда выполнения .NET Core предоставляет набор компонентов для создания и наблюдения за метриками, включающими такие интерфейсы API, как <xref:System.Diagnostics.Tracing.EventSource> и <xref:System.Diagnostics.Tracing.EventCounter> классы.</span><span class="sxs-lookup"><span data-stu-id="e5e52-131">The .NET Core runtime provides a set of components for emitting and observing metrics that includes APIs such as the <xref:System.Diagnostics.Tracing.EventSource> and <xref:System.Diagnostics.Tracing.EventCounter> classes.</span></span> <span data-ttu-id="e5e52-132">Эти API-интерфейсы можно использовать для выдачи базовых числовых данных, которые могут использоваться внешними процессами, например, [глобальным инструментом DotNet-Counters](https://github.com/dotnet/diagnostics/blob/master/documentation/dotnet-counters-instructions.md)или трассировкой событий для Windows.</span><span class="sxs-lookup"><span data-stu-id="e5e52-132">These APIs can be used to emit basic numeric data that can be consumed by external processes like the [dotnet-counters global tool](https://github.com/dotnet/diagnostics/blob/master/documentation/dotnet-counters-instructions.md), or Event Tracing for Windows.</span></span> <span data-ttu-id="e5e52-133">Дополнительные сведения об использовании `EventCounter` в коде см. в руководстве по [введению евенткаунтер](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-133">For more information about using `EventCounter` in your own code, see the [EventCounter Introduction](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.Tracing/documentation/EventCounterTutorial.md) tutorial.</span></span>

<span data-ttu-id="e5e52-134">Для более сложных метрик и для записи данных метрик в более широкий спектр хранилищ данных существует отличный проект с открытым исходным кодом, называемый [метриками приложений](https://www.app-metrics.io).</span><span class="sxs-lookup"><span data-stu-id="e5e52-134">For more advanced metrics and for writing metric data to a wider range of data stores, there's an excellent open-source project called [App Metrics](https://www.app-metrics.io).</span></span> <span data-ttu-id="e5e52-135">Этот набор библиотек предоставляет обширный набор типов для инструментирования кода.</span><span class="sxs-lookup"><span data-stu-id="e5e52-135">This suite of libraries provides an extensive set of types to instrument your code.</span></span> <span data-ttu-id="e5e52-136">Он также предоставляет пакеты для записи метрик в различные типы целевых объектов, которые включают базы данных временных рядов, такие как Prometheus и InfluxDB, [Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview)и многое другое.</span><span class="sxs-lookup"><span data-stu-id="e5e52-136">It also offers packages to write metrics to different kinds of targets that include time-series databases, such as Prometheus and InfluxDB, [Azure Application Insights](https://docs.microsoft.com/azure/azure-monitor/app/app-insights-overview), and more.</span></span> <span data-ttu-id="e5e52-137">Пакет NuGet [app. Metrics. AspNetCore. MVC](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) даже добавляет всеобъемлющий набор основных метрик, которые автоматически создаются с помощью интеграции с ASP.NET Core Framework, а веб-сайт предоставляет [шаблоны](https://www.app-metrics.io/samples/grafana/) для отображения этих метрик с помощью платформы визуализации [Grafana](https://grafana.com/) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-137">The [App.Metrics.AspNetCore.Mvc](https://www.nuget.org/packages/App.Metrics.AspNetCore.Mvc/) NuGet package even adds a comprehensive set of basic metrics that are automatically generated via integration with the ASP.NET Core framework, and the web site provides [templates](https://www.app-metrics.io/samples/grafana/) for displaying those metrics with the [Grafana](https://grafana.com/) visualization platform.</span></span>

<span data-ttu-id="e5e52-138">Дополнительные сведения и документацию по метрикам приложений см. на веб-сайте [app-Metrics.IO](https://app-metrics.io) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-138">For more information and documentation about App Metrics, see the [app-metrics.io](https://app-metrics.io) website.</span></span>

### <a name="produce-metrics"></a><span data-ttu-id="e5e52-139">Создание метрик</span><span class="sxs-lookup"><span data-stu-id="e5e52-139">Produce metrics</span></span>

<span data-ttu-id="e5e52-140">Большинство платформ метрик поддерживают пять основных типов метрик, описанных в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="e5e52-140">Most metrics platforms support five basic types of metric, outlined in the following table:</span></span>

| <span data-ttu-id="e5e52-141">Тип метрики</span><span class="sxs-lookup"><span data-stu-id="e5e52-141">Metric type</span></span> | <span data-ttu-id="e5e52-142">Описание</span><span class="sxs-lookup"><span data-stu-id="e5e52-142">Description</span></span> |
| ----------- | ----------- |
| <span data-ttu-id="e5e52-143">Счетчик</span><span class="sxs-lookup"><span data-stu-id="e5e52-143">Counter</span></span>     | <span data-ttu-id="e5e52-144">Отслеживает, как часто происходит нечто, например запросы, ошибки и т. д.</span><span class="sxs-lookup"><span data-stu-id="e5e52-144">Tracks how often something happens, such as requests, errors, and so on.</span></span> |
| <span data-ttu-id="e5e52-145">Калибр</span><span class="sxs-lookup"><span data-stu-id="e5e52-145">Gauge</span></span>       | <span data-ttu-id="e5e52-146">Записывает одно значение, которое изменяется со временем, например активные соединения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-146">Records a single value that changes over time, such as active connections.</span></span> |
| <span data-ttu-id="e5e52-147">Гистограмма</span><span class="sxs-lookup"><span data-stu-id="e5e52-147">Histogram</span></span>   | <span data-ttu-id="e5e52-148">Измеряет распределение значений по произвольным ограничениям.</span><span class="sxs-lookup"><span data-stu-id="e5e52-148">Measures a distribution of values across arbitrary limits.</span></span> <span data-ttu-id="e5e52-149">Например, гистограмма может отформатировать размер набора данных, подсчитать, сколько содержалось < 10 записей, сколько 11-100 и 101-1000 и > 1000 записей.</span><span class="sxs-lookup"><span data-stu-id="e5e52-149">For example, a histogram could track data set size, counting how many contained <10 records, how many 11-100 and 101-1000, and >1000 records.</span></span> |
| <span data-ttu-id="e5e52-150">Хода</span><span class="sxs-lookup"><span data-stu-id="e5e52-150">Meter</span></span>       | <span data-ttu-id="e5e52-151">Измеряет скорость, с которой событие происходит в различные промежутки времени.</span><span class="sxs-lookup"><span data-stu-id="e5e52-151">Measures the rate at which an event occurs in various time spans.</span></span> |
| <span data-ttu-id="e5e52-152">Таймер</span><span class="sxs-lookup"><span data-stu-id="e5e52-152">Timer</span></span>       | <span data-ttu-id="e5e52-153">Отслеживает длительность событий и скорость их возникновения, хранящуюся в виде гистограммы.</span><span class="sxs-lookup"><span data-stu-id="e5e52-153">Tracks the duration of events and the rate at which it occurs, stored as a histogram.</span></span> |

<span data-ttu-id="e5e52-154">Используя *метрики приложения*, интерфейс `IMetrics` можно получить с помощью внедрения зависимостей и использовать для записи любой из этих метрик для службы gRPC.</span><span class="sxs-lookup"><span data-stu-id="e5e52-154">Using *App Metrics*, an `IMetrics` interface can be obtained via dependency injection and used to record any of these metrics for a gRPC service.</span></span> <span data-ttu-id="e5e52-155">В следующем примере показано, как подсчитать число запросов `Get`, выполненных с течением времени:</span><span class="sxs-lookup"><span data-stu-id="e5e52-155">The following example shows how to count the number of `Get` requests made over time:</span></span>

```csharp
public class StockData : Stocks.StocksBase
{
    private static readonly CounterOptions GetRequestCounter = new CounterOptions
    {
        Name = "StockData_Get_Requests",
        MeasurementUnit = Unit.Calls
    };

    private readonly IStockRepository _repository;
    private readonly IMetrics _metrics;

    public StockData(IStockRepository repository, IMetrics metrics)
    {
        _repository = repository;
        _metrics = metrics;
    }

    public override async Task<GetResponse> Get(GetRequest request, ServerCallContext context)
    {
        _metrics.Measure.Counter.Increment(GetRequestCounter);

        // Serve request...
    }
}
```

### <a name="store-and-visualize-metrics-data"></a><span data-ttu-id="e5e52-156">Хранение и визуализация данных метрик</span><span class="sxs-lookup"><span data-stu-id="e5e52-156">Store and visualize metrics data</span></span>

<span data-ttu-id="e5e52-157">Лучшим способом хранения данных метрик является *база данных временных рядов*, специализированное хранилище данных, предназначенное для записи числовых рядов данных, помеченных метками времени.</span><span class="sxs-lookup"><span data-stu-id="e5e52-157">The best way to store metrics data is in a *time-series database*, a specialized data store designed to record numerical data series marked with timestamps.</span></span> <span data-ttu-id="e5e52-158">Самыми популярными из этих баз данных являются [Prometheus](https://prometheus.io/) и [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span><span class="sxs-lookup"><span data-stu-id="e5e52-158">The most popular of these databases are [Prometheus](https://prometheus.io/) and [InfluxDB](https://www.influxdata.com/products/influxdb-overview/).</span></span> <span data-ttu-id="e5e52-159">Microsoft Azure также предоставляет хранилище выделенных метрик через службу [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-159">Microsoft Azure also provides dedicated metrics storage through the [Azure Monitor](https://docs.microsoft.com/azure/azure-monitor/overview) service.</span></span>

<span data-ttu-id="e5e52-160">Текущее решение для визуализации данных метрик — [Grafana](https://grafana.com), которое работает с широким спектром поставщиков хранилища, включая Azure Monitor, InfluxDB и Prometheus.</span><span class="sxs-lookup"><span data-stu-id="e5e52-160">The current go-to solution for visualizing metrics data is [Grafana](https://grafana.com), which works with a wide range of storage providers including Azure Monitor, InfluxDB and Prometheus.</span></span> <span data-ttu-id="e5e52-161">На следующем рисунке показан пример панели мониторинга Grafana, отображающей метрики из сетки службы Linkerd с примером Стоккдата:</span><span class="sxs-lookup"><span data-stu-id="e5e52-161">The following image shows an example Grafana dashboard that displays metrics from the Linkerd service mesh running the StockData sample:</span></span>

![Панель мониторинга Grafana](media/application-performance-management/grafana-screenshot.png)

### <a name="metrics-based-alerting"></a><span data-ttu-id="e5e52-163">Оповещения на основе метрик</span><span class="sxs-lookup"><span data-stu-id="e5e52-163">Metrics-based alerting</span></span>

<span data-ttu-id="e5e52-164">Числовой характер данных метрик означает, что он идеально подходит для создания систем предупреждений, уведомления разработчиков или инженеров технической поддержки, когда значение выходит за пределы определенного периода.</span><span class="sxs-lookup"><span data-stu-id="e5e52-164">The numerical nature of metrics data means that it's ideally suited to drive alerting systems, notifying developers or support engineers when a value falls outside of some defined tolerance.</span></span> <span data-ttu-id="e5e52-165">Уже упомянутые платформы обеспечивают поддержку предупреждений с помощью различных параметров, включая сообщения электронной почты, текстовые сообщения или визуализации панелей мониторинга.</span><span class="sxs-lookup"><span data-stu-id="e5e52-165">The platforms already mentioned all provide support for alerting via a range of options, including emails, text messages, or in-dashboard visualizations.</span></span>

## <a name="distributed-tracing"></a><span data-ttu-id="e5e52-166">Распределенная трассировка</span><span class="sxs-lookup"><span data-stu-id="e5e52-166">Distributed tracing</span></span>

<span data-ttu-id="e5e52-167">*Распределенная трассировка* — это относительно недавняя разработка в мониторинге, которая возникли сомнения от увеличения использования микрослужб и распределенных архитектур.</span><span class="sxs-lookup"><span data-stu-id="e5e52-167">*Distributed tracing* is a relatively recent development in monitoring, which has arisen from the increasing use of microservices and distributed architectures.</span></span> <span data-ttu-id="e5e52-168">Один запрос от клиентского браузера, приложения или устройства может быть разбит на несколько шагов и подзапросов, что требует использования множества служб в сети.</span><span class="sxs-lookup"><span data-stu-id="e5e52-168">A single request from a client browser, application, or device may be broken down into many steps and sub-requests, and involve the use of many services across a network.</span></span> <span data-ttu-id="e5e52-169">Это затрудняет сопоставление сообщений журнала и метрик с конкретным запросом, который их инициировал.</span><span class="sxs-lookup"><span data-stu-id="e5e52-169">This makes it difficult to correlate log messages and metrics with the specific request that triggered them.</span></span> <span data-ttu-id="e5e52-170">Распределенная трассировка применяет идентификаторы к запросам, которые позволяют сопоставлять журналы и метрики с определенной операцией.</span><span class="sxs-lookup"><span data-stu-id="e5e52-170">Distributed tracing applies identifiers to requests that allow logs and metrics to be correlated with a particular operation.</span></span> <span data-ttu-id="e5e52-171">Это похоже на [сквозную трассировку WCF](https://docs.microsoft.com/dotnet/framework/wcf/diagnostics/tracing/end-to-end-tracing), но применяется на нескольких платформах.</span><span class="sxs-lookup"><span data-stu-id="e5e52-171">This is similar to [WCF's end-to-end tracing](https://docs.microsoft.com/dotnet/framework/wcf/diagnostics/tracing/end-to-end-tracing), but applied across multiple platforms.</span></span>

<span data-ttu-id="e5e52-172">Несмотря на то, что это все еще зарождающейся технология, Распределенная трассировка быстро увеличилась в популярности и теперь проходит стандартизацию.</span><span class="sxs-lookup"><span data-stu-id="e5e52-172">Although it's still a nascent technology area, distributed tracing has grown quickly in popularity and is now going through a standardization process.</span></span> <span data-ttu-id="e5e52-173">Облачная инфраструктура машинного кода создала [открытый стандарт трассировки](https://opentracing.io), который пытается предоставить независимые от поставщика библиотеки для работы с серверными интерфейсами, такими как [жаежер](https://www.jaegertracing.io/) и [эластичная APM](https://www.elastic.co/products/apm).</span><span class="sxs-lookup"><span data-stu-id="e5e52-173">The Cloud Native Computing Foundation created the [the Open Tracing standard](https://opentracing.io), attempting to provide vendor-neutral libraries for working with backends like [Jaeger](https://www.jaegertracing.io/) and [Elastic APM](https://www.elastic.co/products/apm).</span></span> <span data-ttu-id="e5e52-174">В то же время Google создал [проект опенценсус](https://opencensus.io/) для решения того же набора проблем.</span><span class="sxs-lookup"><span data-stu-id="e5e52-174">At the same time, Google created the [OpenCensus project](https://opencensus.io/) to address the same set of problems.</span></span> <span data-ttu-id="e5e52-175">Теперь эти два проекта объединяются в новый проект, [опентелеметри](https://opentelemetry.io), который является будущим отраслевым стандартом.</span><span class="sxs-lookup"><span data-stu-id="e5e52-175">These two projects are now being merged into a new project, [OpenTelemetry](https://opentelemetry.io), which aims to be the future industry standard.</span></span>

### <a name="how-distributed-tracing-works"></a><span data-ttu-id="e5e52-176">Как работает Распределенная трассировка</span><span class="sxs-lookup"><span data-stu-id="e5e52-176">How distributed tracing works</span></span>

<span data-ttu-id="e5e52-177">Распределенная трассировка основана на концепции *диапазонов*: именованных, временных операций, которые являются частью одной *трассировки*, которая может включать обработку на нескольких узлах системы.</span><span class="sxs-lookup"><span data-stu-id="e5e52-177">Distributed tracing is based on the concept of *Spans*: named, timed operations that are part of a single *Trace*, which may involve processing on multiple nodes of a system.</span></span> <span data-ttu-id="e5e52-178">При запуске новой операции создается трассировка с уникальным идентификатором.</span><span class="sxs-lookup"><span data-stu-id="e5e52-178">When a new operation is initiated, a trace is created with a unique identifier.</span></span> <span data-ttu-id="e5e52-179">Для каждой вложенной операции создается диапазон с собственным идентификатором и идентификатором трассировки.</span><span class="sxs-lookup"><span data-stu-id="e5e52-179">For each sub-operation, a span is created with its own identifier and trace identifier.</span></span> <span data-ttu-id="e5e52-180">По мере прохождения запроса вокруг системы различные компоненты могут создавать *дочерние* диапазоны, включающие идентификатор своего *родителя*.</span><span class="sxs-lookup"><span data-stu-id="e5e52-180">As the request passes around the system, various components can create *child* spans that include the identifier of their *parent*.</span></span> <span data-ttu-id="e5e52-181">Диапазон имеет *контекст*, который содержит идентификаторы трассировки и диапазонов, а также полезные данные в виде пар «ключ-значение» (называемого *багажа*).</span><span class="sxs-lookup"><span data-stu-id="e5e52-181">A span has a *context*, which contains the trace and span identifiers, as well as useful data in the form of key/value pairs (called *baggage*).</span></span>

### <a name="distributed-tracing-with-diagnosticsource"></a><span data-ttu-id="e5e52-182">Распределенная трассировка с помощью DiagnosticSource</span><span class="sxs-lookup"><span data-stu-id="e5e52-182">Distributed tracing with DiagnosticSource</span></span>

<span data-ttu-id="e5e52-183">В .NET Core есть внутренний модуль, который хорошо сопоставляется с распределенными трассировками и охватывает диапазоны: [DiagnosticSource](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span><span class="sxs-lookup"><span data-stu-id="e5e52-183">.NET Core has an internal module that maps well to distributed traces and spans: [DiagnosticSource](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#diagnosticsource-users-guide).</span></span> <span data-ttu-id="e5e52-184">Кроме простого способа создания и использования диагностики в процессе, модуль `DiagnosticSource` имеет концепцию *действия*, которая фактически является реализацией распределенной трассировки или диапазоном в трассировке.</span><span class="sxs-lookup"><span data-stu-id="e5e52-184">As well as providing a simple way to produce and consume diagnostics within a process, the `DiagnosticSource` module has the concept of an *Activity*, which is effectively an implementation of a distributed trace, or a span within a trace.</span></span> <span data-ttu-id="e5e52-185">Внутренние компоненты модуля принимают на себя действия родительских и дочерних элементов, включая выделение идентификаторов.</span><span class="sxs-lookup"><span data-stu-id="e5e52-185">The internals of the module take care of parent/child activities, including allocating identifiers.</span></span> <span data-ttu-id="e5e52-186">Дополнительные сведения об использовании типа `Activity` см. в разделе " [действие пользователя" на GitHub](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-186">For more information about using the `Activity` type, see the [Activity User Guide on GitHub](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-user-guide)</span></span>

<span data-ttu-id="e5e52-187">Поскольку DiagnosticSource является частью основной платформы, она поддерживается несколькими основными компонентами, включая <xref:System.Net.Http.HttpClient>, Entity Framework Core и ASP.NET Core, включая явную поддержку в gRPC Framework.</span><span class="sxs-lookup"><span data-stu-id="e5e52-187">Because DiagnosticSource is a part of the core framework, it's supported by several core components, including <xref:System.Net.Http.HttpClient>, Entity Framework Core and ASP.NET Core, including explicit support in the gRPC framework.</span></span> <span data-ttu-id="e5e52-188">Когда ASP.NET Core получает запрос, он проверяет наличие пары HTTP-заголовков, соответствующих стандарту [контекста трассировки W3C](https://www.w3.org/TR/trace-context) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-188">When ASP.NET Core receives a request, it  checks for a pair of HTTP headers matching the [W3C Trace Context](https://www.w3.org/TR/trace-context) standard.</span></span> <span data-ttu-id="e5e52-189">Если заголовки найдены, действие запускается с использованием значений идентификаторов и контекста из заголовков.</span><span class="sxs-lookup"><span data-stu-id="e5e52-189">If the headers are found, an Activity is started using the identity values and context from the headers.</span></span> <span data-ttu-id="e5e52-190">Если заголовки не найдены, действие запускается с созданными значениями идентификаторов, которые соответствуют стандартному формату.</span><span class="sxs-lookup"><span data-stu-id="e5e52-190">If no headers are found, an Activity is started with generated identity values that match the standard format.</span></span> <span data-ttu-id="e5e52-191">Любая диагностика, создаваемая платформой или кодом приложения в течение времени существования этого действия, может быть помечена идентификаторами трассировки и диапазона.</span><span class="sxs-lookup"><span data-stu-id="e5e52-191">Any diagnostics generated by the framework or by application code during the lifetime of this Activity can be tagged with the trace and span identifiers.</span></span> <span data-ttu-id="e5e52-192">Поддержка `HttpClient` расширяет эти возможности за счет проверки текущего действия при каждом запросе и автоматического добавления заголовков трассировки к исходящему запросу.</span><span class="sxs-lookup"><span data-stu-id="e5e52-192">The `HttpClient` support extends this further by checking for a current Activity on every request and automatically adding the trace headers to the outgoing request.</span></span>

<span data-ttu-id="e5e52-193">ASP.NET Core библиотеки клиента и сервера gRPC включают явную поддержку DiagnosticSource и Activity, а также создает действия и автоматически применяет и использует сведения о заголовке.</span><span class="sxs-lookup"><span data-stu-id="e5e52-193">The ASP.NET Core gRPC client and server libraries include explicit support for DiagnosticSource and Activity, and will create activities and apply and use header information automatically.</span></span>

> [!NOTE]
> <span data-ttu-id="e5e52-194">Все это происходит только в том случае, если *прослушиватель* использует диагностические данные.</span><span class="sxs-lookup"><span data-stu-id="e5e52-194">All of this only happens if a *listener* is consuming the diagnostic information.</span></span> <span data-ttu-id="e5e52-195">Если прослушиватель отсутствует, диагностика не записывается и действия не создаются.</span><span class="sxs-lookup"><span data-stu-id="e5e52-195">If there's no listener, no diagnostics are written and no activities are created.</span></span>

### <a name="add-your-own-diagnosticsources-and-activities"></a><span data-ttu-id="e5e52-196">Добавление собственных Диагностиксаурцес и действий</span><span class="sxs-lookup"><span data-stu-id="e5e52-196">Add your own DiagnosticSources and Activities</span></span>

<span data-ttu-id="e5e52-197">Хотя подASP.NET Core, в том числе gRPC, а также Entity Framework Core и `HttpClient`, может потребоваться добавить собственную диагностику или создать явные диапазоны в коде приложения.</span><span class="sxs-lookup"><span data-stu-id="e5e52-197">Although a good quantity of data is automatically generated by ASP.NET Core, including gRPC, as well as Entity Framework Core and `HttpClient`, you may wish to add your own diagnostics or create explicit spans within your application code.</span></span> <span data-ttu-id="e5e52-198">Дополнительные сведения о том, как реализовать собственную диагностику, см. в разделе [Руководство пользователя DiagnosticSource](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) и [Руководство пользователя по действию](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage) .</span><span class="sxs-lookup"><span data-stu-id="e5e52-198">Refer to the [DiagnosticSource User Guide](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/DiagnosticSourceUsersGuide.md#instrumenting-with-diagnosticsourcediagnosticlistener) and [Activity User Guide](https://github.com/dotnet/corefx/blob/master/src/System.Diagnostics.DiagnosticSource/src/ActivityUserGuide.md#activity-usage) for details on how to implement your own diagnostics.</span></span>

### <a name="store-distributed-trace-data"></a><span data-ttu-id="e5e52-199">Хранение распределенных данных трассировки</span><span class="sxs-lookup"><span data-stu-id="e5e52-199">Store distributed trace data</span></span>

<span data-ttu-id="e5e52-200">На момент написания проекта Опентелеметри все еще на ранних этапах, и для приложений .NET доступны только пакеты с альфа-качеством.</span><span class="sxs-lookup"><span data-stu-id="e5e52-200">At the time of writing the OpenTelemetry project is still in the early stages, and only alpha-quality packages are available for .NET applications.</span></span> <span data-ttu-id="e5e52-201">Проект ОпентраЦинг предлагает более зрелые библиотеки, но они будут заменены библиотеками Опентелеметри в будущем.</span><span class="sxs-lookup"><span data-stu-id="e5e52-201">The OpenTracing project offers more mature libraries, but these will be superseded by the OpenTelemetry libraries in the future.</span></span>

<span data-ttu-id="e5e52-202">ОпентраЦинг API описан ниже.</span><span class="sxs-lookup"><span data-stu-id="e5e52-202">The OpenTracing API is described below.</span></span> <span data-ttu-id="e5e52-203">Если вы предпочитаете использовать более новый API Опентелеметри в приложении, см. [репозиторий опентелеметри .NET SDK на сайте GitHub](https://github.com/open-telemetry/opentelemetry-dotnet).</span><span class="sxs-lookup"><span data-stu-id="e5e52-203">If you would prefer to use the newer OpenTelemetry API in your application, refer to the [OpenTelemetry .NET SDK repository on GitHub](https://github.com/open-telemetry/opentelemetry-dotnet).</span></span>

#### <a name="use-the-opentracing-package-to-store-distributed-trace-data"></a><span data-ttu-id="e5e52-204">Использование пакета ОпентраЦинг для хранения распределенных данных трассировки</span><span class="sxs-lookup"><span data-stu-id="e5e52-204">Use the OpenTracing package to store distributed trace data</span></span>

<span data-ttu-id="e5e52-205">[Пакет NuGet опентраЦинг](https://www.nuget.org/packages/OpenTracing/) , поддерживающий все опентраЦинг-совместимые серверные части (которые могут использоваться независимо от `DiagnosticSource`).</span><span class="sxs-lookup"><span data-stu-id="e5e52-205">The [an OpenTracing NuGet package](https://www.nuget.org/packages/OpenTracing/) that supports all OpenTracing-compliant back-ends (which can be used independently of `DiagnosticSource`).</span></span> <span data-ttu-id="e5e52-206">Существует дополнительный пакет из проекта публикаций ОпентраЦинг API, [опентраЦинг. от участников сообщества. NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/), который добавляет прослушиватель `DiagnosticSource` и записывает события и действия в серверную части автоматически.</span><span class="sxs-lookup"><span data-stu-id="e5e52-206">There's an additional package from the OpenTracing API Contributions project, [OpenTracing.Contrib.NetCore](https://www.nuget.org/packages/OpenTracing.Contrib.NetCore/), which adds a `DiagnosticSource` listener and writes events and activities to a back-end automatically.</span></span> <span data-ttu-id="e5e52-207">Включить этот пакет так же просто, как установить его из NuGet и добавить в качестве службы в класс `Startup`.</span><span class="sxs-lookup"><span data-stu-id="e5e52-207">Enabling this package is as simple as installing it from NuGet and adding it as a service in your `Startup` class.</span></span>

```csharp
public class Startup
{
    public void ConfigureServices(IServiceCollection services)
    {
        services.AddOpenTracing();
    }
}
```

<span data-ttu-id="e5e52-208">Пакет ОпентраЦинг является уровнем абстракции и, таким образом, требует реализации серверной части.</span><span class="sxs-lookup"><span data-stu-id="e5e52-208">The OpenTracing package is an abstraction layer and as such it requires a back-end-specific implementation.</span></span> <span data-ttu-id="e5e52-209">Реализации API ОпентраЦинг доступны для следующих серверных интерфейсов с открытым исходным кодом.</span><span class="sxs-lookup"><span data-stu-id="e5e52-209">OpenTracing API implementations are available for the following open source back-ends.</span></span>

| <span data-ttu-id="e5e52-210">Имя</span><span class="sxs-lookup"><span data-stu-id="e5e52-210">Name</span></span> | <span data-ttu-id="e5e52-211">Пакет</span><span class="sxs-lookup"><span data-stu-id="e5e52-211">Package</span></span> | <span data-ttu-id="e5e52-212">Веб-сайт</span><span class="sxs-lookup"><span data-stu-id="e5e52-212">Web site</span></span> |
| ---- | ------- | -------- |
| <span data-ttu-id="e5e52-213">жаежер</span><span class="sxs-lookup"><span data-stu-id="e5e52-213">Jaeger</span></span> | [<span data-ttu-id="e5e52-214">жаежер</span><span class="sxs-lookup"><span data-stu-id="e5e52-214">Jaeger</span></span>](https://www.nuget.org/packages/Jaeger/) | [<span data-ttu-id="e5e52-215">jaegertracing.io</span><span class="sxs-lookup"><span data-stu-id="e5e52-215">jaegertracing.io</span></span>](https://jaegertracing.io) |
| <span data-ttu-id="e5e52-216">Эластичная APM</span><span class="sxs-lookup"><span data-stu-id="e5e52-216">Elastic APM</span></span> | [<span data-ttu-id="e5e52-217">Эластичный. APM. Неткореалл</span><span class="sxs-lookup"><span data-stu-id="e5e52-217">Elastic.Apm.NetCoreAll</span></span>](https://www.nuget.org/packages/Elastic.Apm.NetCoreAll/) | [<span data-ttu-id="e5e52-218">elastic.co/products/apm</span><span class="sxs-lookup"><span data-stu-id="e5e52-218">elastic.co/products/apm</span></span>](https://www.elastic.co/products/apm) |

<span data-ttu-id="e5e52-219">Дополнительные сведения об API опентраЦинг для .NET см. в разделе [опентраЦинг for C# ](https://github.com/opentracing/opentracing-csharp) и [опентраЦинг C#от участников сообщества/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) репозитории на сайте GitHub.</span><span class="sxs-lookup"><span data-stu-id="e5e52-219">For more information on the OpenTracing API for .NET, see the [OpenTracing for C#](https://github.com/opentracing/opentracing-csharp) and the [OpenTracing Contrib C#/.NET Core](https://github.com/opentracing-contrib/csharp-netcore) repositories on GitHub.</span></span>

>[!div class="step-by-step"]
><span data-ttu-id="e5e52-220">[Назад](load-balancing.md)
>[Вперед](appendix.md)</span><span class="sxs-lookup"><span data-stu-id="e5e52-220">[Previous](load-balancing.md)
[Next](appendix.md)</span></span>
