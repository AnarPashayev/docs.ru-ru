---
title: Docker - gRPC для разработчиков WCF
description: Создание изображений Docker для ASP.NET основных приложений gRPC
ms.date: 09/02/2019
ms.openlocfilehash: e67c43f9486fbfe9a5d3e84e3b74770eb621f604
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79148118"
---
# <a name="create-docker-images"></a>Создание изображений Докера

Этот раздел охватывает создание изображений Docker для ASP.NET приложений Core gRPC, готовых к работе в Docker, Kubernetes или других контейнерных средах. Использованное примерное приложение с веб-приложением ASP.NET Core MVC и сервисом gRPC доступно на репозитории [Dotnet-architecture/grpc-for-wcf-разработчикам](https://github.com/dotnet-architecture/grpc-for-wcf-developers/tree/master/KubernetesSample) на GitHub.

## <a name="microsoft-base-images-for-aspnet-core-applications"></a>Базовые изображения Майкрософт для ASP.NET основных приложений

Корпорация Майкрософт предоставляет широкий спектр базовых изображений для создания и запуска приложений .NET Core. Для создания изображения ASP.NET Core 3.0 используется два базовых изображения:

- Изображение SDK для создания и публикации приложения.
- Изображение времени выполнения для развертывания.

| Образ — | Описание |
| ----- | ----------- |
| [mcr.microsoft.com/dotnet/core/sdk](https://hub.docker.com/_/microsoft-dotnet-core-sdk/) | Для строительных `docker build`приложений с . Не использовать в производстве. |
| [mcr.microsoft.com/dotnet/core/aspnet](https://hub.docker.com/_/microsoft-dotnet-core-aspnet/) | Содержит время выполнения и ASP.NET зависимостей Core. Для производства. |

Для каждого изображения существует четыре варианта, основанных на различных дистрибутивах Linux, отличаемых тегами.

| Тег изображения (ы) | Linux | Примечания |
| --------- | ----- | ----- |
| 3.0-Buster, 3.0 | Debian 10 | Изображение по умолчанию, если вариант ОС не указан. |
| 3.0-альпийский | Альпийский 3,9 | Альпийские базовые изображения намного меньше, чем Debian или Ubuntu. |
| 3.0-дискотека | Ubuntu 19.04 | |
| 3.0-бионический | Ubuntu 18.04 | |

Альпийская база изображения составляет около 100 МБ, по сравнению с 200 МБ для Debian и Ubuntu изображений. Некоторые пакеты программного обеспечения или библиотеки могут быть недоступны в управлении пакетами Alpine. Если вы не уверены, какое изображение использовать, вы, вероятно, следует выбрать Debian по умолчанию.

> [!IMPORTANT]
> Убедитесь, что вы используете тот же вариант Linux для сборки и времени выполнения. Приложения, построенные и опубликованные на одном варианте, могут не работать на другом.

## <a name="create-a-docker-image"></a>Создайте образ Docker.

Изображение Docker определяется *Dockerfile*. Это текстовый файл, содержащий все команды, необходимые для создания приложения и установки любых зависимостей, необходимых для создания или запуска приложения. Следующий пример показывает простейшую Dockerfile для приложения Core 3.0 ASP.NET:

```dockerfile
# Application build steps
FROM mcr.microsoft.com/dotnet/core/sdk:3.0 as builder

WORKDIR /src

COPY . .

RUN dotnet restore

RUN dotnet publish -c Release -o /published src/StockData/StockData.csproj

# Runtime image creation
FROM mcr.microsoft.com/dotnet/core/aspnet:3.0

# Uncomment the line below if running with HTTPS
# ENV ASPNETCORE_URLS=https://+:443

WORKDIR /app

COPY --from=builder /published .

ENTRYPOINT [ "dotnet", "StockData.dll" ]
```

Dockerfile имеет две части: первая использует базовое `sdk` изображение для создания и публикации приложения; второй создает изображение времени выполнения `aspnet` из базы. Это потому, что `sdk` изображение составляет около 900 МБ, по сравнению с примерно 200 МБ для изображения времени выполнения, и большая часть его содержимого являются ненужными во время выполнения.

### <a name="the-build-steps"></a>Шаги сборки

| Шаг | Описание |
| ---- | ----------- |
| `FROM ...` | Объявляет базовое изображение и `builder` присваивает псевдоним. |
| `WORKDIR /src` | Создает `/src` каталог и устанавливает его в качестве текущего рабочего каталога. |
| `COPY . .` | Копирует все, что ниже текущего каталога на хосте, в текущий каталог на изображении. |
| `RUN dotnet restore` | Восстанавливает любые внешние пакеты (ASP.NET core 3.0, предварительно установленный с помощью SDK). |
| `RUN dotnet publish ...` | Строит и публикует сборку выпуска. Обратите внимание, `--runtime` что флаг не требуется. |

### <a name="the-runtime-image-steps"></a>Шаги изображения времени выполнения

| Шаг | Описание |
| ---- | ----------- |
| `FROM ...` | Объявляет новое базовое изображение. |
| `WORKDIR /app` | Создает `/app` каталог и устанавливает его в качестве текущего рабочего каталога. |
| `COPY --from=builder ...` | Копирует опубликованное приложение из предыдущего `builder` изображения, используя `FROM` псевдоним из первой строки. |
| `ENTRYPOINT [ ... ]` | Устанавливает команду для выполнения при запуске контейнера. Команда `dotnet` в изображении времени выполнения может запускать только dLL-файлы. |

### <a name="https-in-docker"></a>HTTPS в Докере

Базовые изображения Microsoft для `ASPNETCORE_URLS` Docker `http://+:80`устанавливают переменную среды, а это означает, что Kestrel работает без HTTPS в этом порту. Если вы используете HTTPS с пользовательским сертификатом (как описано в [самохознательных приложениях gRPC),](self-hosted.md)вы должны переопределить это. Установите переменную среды в части создания изображения времен выполнения вашего Dockerfile.

```dockerfile
# Runtime image creation
FROM mcr.microsoft.com/dotnet/core/aspnet:3.0

ENV ASPNETCORE_URLS=https://+:443
```

### <a name="the-dockerignore-file"></a>Файл .dockerignore

Как `.gitignore` и файлы, исключающие определенные `.dockerignore` файлы и каталоги из элемента управления исходным элементом, файл может использоваться для исключения файлов и каталогов из скопирований на изображение во время сборки. Это не только экономит время копирования, но также позволяет `obj` избежать некоторых ошибок, возникающих в результате копирования каталога с вашего компьютера в изображение. Как минимум, вы должны добавить записи для `bin` и `obj` в файл. `.dockerignore`

```console
bin/
obj/
```

## <a name="build-the-image"></a>Создание образа

Для решения с одним приложением и, таким образом, одним Dockerfile, проще всего поместить Dockerfile в базовый каталог. Другими словами, поместите его в `.sln` тот же каталог, что и файл. В этом случае для создания изображения `docker build` используйте следующую команду из каталога, содержащего Dockerfile.

```console
docker build --tag stockdata .
```

Запутанно `--tag` названный флаг (который `-t`может быть сокращен до) определяет все имя изображения, включая фактический тег, если указано. В `.` конце оговаривается контекст, в котором будет запущена сборка; текущий рабочий `COPY` каталог для команд в Dockerfile.

Если у вас есть несколько приложений в рамках одного решения, вы можете сохранить `.csproj` Dockerfile для каждого приложения в своей папке, рядом с файлом. Вы все равно `docker build` должны запустить команду из базового каталога, чтобы убедиться, что решение и все проекты скопированы в изображение. Вы можете указать Dockerfile ниже текущего `--file` каталога, используя (или) `-f`флаг.

```console
docker build --tag stockdata --file src/StockData/Dockerfile .
```

## <a name="run-the-image-in-a-container-on-your-machine"></a>Выполнить изображение в контейнере на машине

Для запуска изображения в локальном экземпляре `docker run` Docker используйте команду.

```console
docker run -ti -p 5000:80 stockdata
```

Флаг `-ti` соединяет текущий терминал с терминалом контейнера и работает в интерактивном режиме. Публикует `-p 5000:80` (ссылки) порт 80 на контейнере к порту 5000 на интерфейсе сети localhost.

## <a name="push-the-image-to-a-registry"></a>Отправка образа в реестр

После того как вы проверите, что изображение работает, нажмите его на реестр Docker, чтобы сделать его доступным на других системах. Внутренние сети должны будут предоставить реестр Docker. Это может быть так же просто, как запуск [собственного `registry` изображения Docker](https://docs.docker.com/registry/deploying/) (реестр Docker работает в контейнере Docker), но существуют различные более всеобъемлющие решения. Для внешнего совместного использования и использования облачных технологий доступны различные управляемые реестры, такие как [реестр контейнеров Azure](https://docs.microsoft.com/azure/container-registry/) или [Docker Hub.](https://docs.docker.com/docker-hub/repos/)

Чтобы нажать на Docker Hub, префикс именем изображения с вашим пользователем или именем организации.

```console
docker tag stockdata myorg/stockdata
docker push myorg/stockdata
```

Чтобы нажать на частный реестр, префикс имя изображения с именем хоста реестра и название организации.

```console
docker tag stockdata internal-registry:5000/myorg/stockdata
docker push internal-registry:5000/myorg/stockdata
```

После того, как изображение находится в реестре, его можно развернуть в отдельных хостах Docker или в двигатель оркестровки контейнеров, как Kubernetes.

>[!div class="step-by-step"]
>[Предыдущий](self-hosted.md)
>[Следующий](kubernetes.md)
