---
title: Создание устойчивых служб, готовых к использованию в облаке адаптация к временным сбоям в облаке
description: Модернизация существующих приложений .NET с помощью облака Azure и контейнеров Windows | Создание устойчивых служб, готовых к использованию в облаке адаптация к временным сбоям в облаке
ms.date: 12/21/2020
ms.openlocfilehash: 4d592a5761cdf696f3e57516d747cbd770512053
ms.sourcegitcommit: 5d9cee27d9ffe8f5670e5f663434511e81b8ac38
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2021
ms.locfileid: "98025333"
---
# <a name="build-resilient-services-ready-for-the-cloud-embrace-transient-failures-in-the-cloud"></a>Создание устойчивых служб, готовых к использованию в облаке: адаптация к временным сбоям в облаке

Устойчивость — это возможность восстановления после сбоев и продолжение работы. Исходить следует из того, что избежать сбоев невозможно и на них нужно реагировать так, чтобы избежать простоев или потери данных. Цель устойчивости — вернуть приложение в полностью функционирующее состояние после сбоя.

Приложение готово к работе в облаке тогда, когда оно по крайней мере реализует программную модель устойчивости, а не аппаратную. Для облачного приложения необходимо предусмотреть частичные сбои, которые, безусловно, будут происходить. Создайте приложение или выполните его частичный рефакторинг, чтобы добиться устойчивости при ожидаемых частичных сбоях. Это значит, что оно должно справляться с такими сбоями, как временные отключения сети либо аварийные сбои узлов или виртуальных машин в облаке. Даже перенос контейнеров в другой узел кластера оркестратора может приводить к кратковременным сбоям в приложении.

## <a name="handling-partial-failure"></a>Обработка частичного сбоя

В облачном приложении всегда есть риск частичного сбоя. Например, один экземпляр веб-сайта или контейнер может быть недоступен, не отвечать в течение короткого времени или может произойти его сбой. Может также произойти аварийный сбой одной виртуальной машины или сервера.

Так как клиенты и службы работают отдельными процессами, служба может не ответить вовремя на запрос клиента. Служба может быть перегружена, медленно отвечать на запросы или быть недоступна некоторое время из-за проблем с сетью.

Например, рассмотрим монолитное приложение .NET, которое обращается к базе в Базе данных SQL Azure. Если База данных SQL Azure или любая сторонняя служба не отвечает в течение небольшого периода времени (если база перемещена на другой узел или сервер, она не будет отвечать несколько секунд), то при попытке пользователя выполнить какое-либо действие может одновременно произойти аварийное завершение работы приложения и выдача исключения.

Подобный сценарий может возникать в приложении, использующем HTTP-службы. Сеть или сама служба могут быть недоступны в облаке во время короткого сбоя.

Чтобы приложение, например показанное на рисунке 4-9, было устойчивым, в нем следует реализовать такие методы, как "повторные попытки с экспоненциальной задержкой", чтобы дать возможность справляться со временными сбоями ресурсов. В приложениях также следует использовать автоматическое выключение. Это значит, что приложение будет прекращать попытки получить доступ к ресурсу, когда на самом деле происходит долгосрочный сбой. Автоматическое выключение приложения позволяет не провоцировать отказ в обслуживании.

![Схема частичных сбоев, обрабатываемых с помощью повторных попыток с экспоненциальной задержкой](./media/retry-partial-failures.png)

**Рис. 4-9** Частичные сбои, обрабатываемые за счет повторных попыток с экспоненциальной задержкой

Эти методы можно использовать как с HTTP-ресурсами, так и с ресурсами базы данных. На рис. 4-9 показано приложение с трехуровневой архитектурой, поэтому методы необходимо применять на уровне служб (HTTP) и на уровне данных (TCP). В монолитном приложении, которое использует только один уровень в дополнение к базе данных (без дополнительных служб или микрослужб), может быть достаточно обработки временных сбоев на уровне подключения к базе данных. В этом сценарии требуется только определенная настройка подключения к базе данных.

Это может не вызывать затруднений при реализации отказоустойчивых подключений с доступом к базе данных, в зависимости от используемой версии .NET (например, для [Entity Framework 6 или более поздней версии](/ef/ef6/fundamentals/connection-resiliency/retry-logic)). Необходимо всего лишь настроить подключение к базе данных. Но может также потребоваться использовать дополнительные библиотеки, такие как [Блок приложения для обработки временной ошибки](/previous-versions/msp-n-p/hh680934(v=pandp.50)) (для .NET предыдущих версий), или даже внедрить собственную библиотеку.

При реализации повторных HTTP-запросов и размыкателей цепи для .NET рекомендуется использовать библиотеку [Polly](https://github.com/App-vNext/Polly), которая предназначена для .NET Standard 1.1 (включая .NET Core 1.0, Mono, Xamarin, UWP, WP 8.1 и более поздних версий) и .NET Standard 2.0 и более поздних версий (включая .NET Core 2.0 и более поздних версий, .NET Core 3.0, а также более поздние целевые версии Mono, Xamarin и UWP). Пакет NuGet также включает в себя прямые целевые объекты для .NET Framework 4.6.1 и 4.7.2.

Чтобы узнать, как реализовать стратегии по обработке частичных сбоев в облаке, ознакомьтесь со следующими ресурсами.

### <a name="additional-resources"></a>Дополнительные ресурсы

- **Реализация отказоустойчивого подключения для обработки частичного сбоя**

    [https://docs.microsoft.com/dotnet/architecture/microservices/implement-resilient-applications/partial-failure-strategies](../../microservices/implement-resilient-applications/partial-failure-strategies.md)

- **Отказоустойчивость подключения Entity Framework и логика повторных попыток (для версии 6 и более поздних)**

    [https://docs.microsoft.com/ef/ef6/fundamentals/connection-resiliency/retry-logic](/ef/ef6/fundamentals/connection-resiliency/retry-logic)

- **Блок приложения для обработки временной ошибки**

- <https://docs.microsoft.com/previous-versions/msp-n-p/hh680934(v=pandp.50)>

- **Библиотека Polly для устойчивого подключения по протоколу HTTP**

    <https://github.com/App-vNext/Polly>

>[!div class="step-by-step"]
>[Назад](when-to-deploy-windows-containers-to-azure-container-service-kubernetes.md)
>[Вперед](modernize-your-apps-with-monitoring-and-telemetry.md)
