---
title: Анализатор .NET API
description: Узнайте, как анализатор .NET API помогает выявлять устаревшие интерфейсы API и проблемы с совместимостью платформ.
author: oliag
ms.author: mairaw
ms.date: 04/26/2019
ms.technology: dotnet-standard
ms.openlocfilehash: 892fb5cc9fba3434b0884c88b97f784d58093303
ms.sourcegitcommit: ca2ca60e6f5ea327f164be7ce26d9599e0f85fe4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/06/2019
ms.locfileid: "65063345"
---
# <a name="net-api-analyzer"></a>Анализатор .NET API

Анализатор API .NET, созданный на платформе Roslyn, выявляет риски совместимости для API на языке C# на разных платформах, а также отслеживает вызовы устаревших интерфейсов API. Разработчики C# могут применять его на любом этапе разработки.

Анализатор API поставляется в виде пакета NuGet [Microsoft.DotNet.Analyzers.Compatibility](https://www.nuget.org/packages/Microsoft.DotNet.Analyzers.Compatibility/). Как только вы добавите в проект ссылку на анализатор, он автоматически начнет отслеживать код и извещать о проблемах с использованием API. Щелкнув значок лампочки, вы получите предложения по возможным мерам для исправления ситуации. Также в раскрывающееся меню есть пункт для скрытия предупреждений.

> [!NOTE]
> Анализатор .NET API пока доступен в режиме предварительной версии.

## <a name="prerequisites"></a>Предварительные требования

* Visual Studio 2017 и более поздние версии или Visual Studio для Mac (любые версии).

## <a name="discovering-deprecated-apis"></a>Обнаружение устаревших API-интерфейсов

### <a name="what-are-deprecated-apis"></a>Что такое устаревшие API-интерфейсы?

Семейство .NET включает несколько крупных программных продуктов, которые постоянно обновляются, чтобы лучше соответствовать потребностям клиентов. Вполне логично, что некоторые API устаревают и заменяются новыми. API считается устаревшим, если существует более современный вариант. Атрибут <xref:System.ObsoleteAttribute> в API оповещает о том, что этот интерфейс устарел и его не следует использовать. У этого подхода есть недостаток — для всех устаревших API применяется только один диагностический идентификатор ([CS0612](../../csharp/misc/cs0612.md) в C#). Это означает следующее.
- Нет возможности создать отдельные документы для каждого случая.
- Нет возможности отключить предупреждения определенной категории. Вы сможете только отключить все предупреждения или разрешить все сразу.
- Чтобы известить пользователей об устаревании интерфейсов, необходимо обновить используемую сборку или целевой пакет.

Анализатор API применяет коды ошибок с индексом DE (Deprecation Error, ошибка устаревания), характерные для конкретных API-интерфейсов, чтобы управлять отображением индивидуальных предупреждений. Устаревшие API, обнаруживаемые анализатором, определяются в репозитории [dotnet/platform-compat](https://github.com/dotnet/platform-compat).

### <a name="using-the-api-analyzer"></a>Использование анализатора API

Если в коде используется устаревший API-интерфейс, например <xref:System.Net.WebClient>, анализатор API выделяет его зеленой волнистой линией. Когда вы наведете указатель мыши на вызов этого API, отобразится значок лампочки со сведениями об устаревании API, как показано в следующем примере:

![Снимок экрана API-интерфейса WebClient с зеленой волнистой линией и лампочкой слева](media/api-analyzer/green-squiggle.jpg)

Окно **Список ошибок** содержит предупреждения с уникальным идентификатором для каждого устаревшего API-интерфейса, как показано в следующем примере (`DE004`): 

!["Снимок экрана с окном списка ошибок, где отображаются идентификатор и описание предупреждения"](media/api-analyzer/warnings-id-and-descriptions.jpg "Окно списка ошибок с предупреждениями.")

Щелкнув этот идентификатор, вы перейдите на веб-страницу с подробными сведениями о том, почему этот API-интерфейс устарел и какие альтернативы рекомендуется использовать.

Вы можете скрыть любое предупреждение, щелкнув подсвеченный элемент правой кнопкой мыши и выбрав пункт **Скрыть \<идентификатор диагностики>**. Есть два способа скрыть предупреждения: 

* [локально (в исходном коде)](#suppressing-warnings-locally);
* [глобально (в соответствующем файле)](#suppressing-warnings-globally) — мы рекомендуем использовать этот вариант.

### <a name="suppressing-warnings-locally"></a>Локальное скрытие предупреждений

Чтобы скрыть предупреждения локально, щелкните нужный элемент правой кнопкой мыши и выберите **Быстрые действия и рефакторинг** > **Скрыть *идентификатор диагностики*\<идентификатор диагностики>** > **в исходном коде**. Это действие добавляет в ваш исходный код директиву препроцессора [#pragma](../../csharp/language-reference/preprocessor-directives/preprocessor-pragma-warning.md) для определенной области: ![снимок экрана с фрагментом кода, для которого #pragma отключает предупреждение](media/api-analyzer/suppress-in-source.jpg)

### <a name="suppressing-warnings-globally"></a>Глобальное скрытие предупреждений

Чтобы скрыть предупреждения глобально, щелкните нужный элемент правой кнопкой мыши и выберите **Быстрые действия и рефакторинг** > **Скрыть *идентификатор диагностики* \<идентификатор диагностики >** > **в файле с предупреждениями**.

![Снимок экрана API-интерфейса WebClient с зеленой волнистой линией и лампочкой слева](media/api-analyzer/suppress-in-sup-file.jpg)

Когда вы настроите скрытие в первый раз, в проект будет добавлен файл *GlobalSuppressions.cs*. В этом файле сохраняются все новые операции глобального скрытия.

![Снимок экрана API-интерфейса WebClient с зеленой волнистой линией и лампочкой слева](media/api-analyzer/suppression-file.jpg)

Мы рекомендуем использовать глобальное скрытие, чтобы гарантировать единообразие в применении API-интерфейсов в проектах.

## <a name="discovering-cross-platform-issues"></a>Обнаружение проблем с межплатформенным взаимодействием

Помимо устаревших API-интерфейсов анализатор определяет все API-интерфейсы, не поддерживающие кроссплатформенность. Например, <xref:System.Console.WindowWidth?displayProperty=nameWithType> работает только в Windows, но не в Linux или macOS. Идентификатор диагностики отображается в окне **Список ошибок**. Чтобы скрыть это предупреждение, щелкните его правой кнопкой мыши и выберите пункт **Быстрые действия и рефакторинг**. В отличие от ситуации с устареванием, когда у вас есть два варианта (продолжать использование конкретного устаревшего элемента, скрыв предупреждение, или отказаться от его использования), здесь вы можете сразу отключить все предупреждения о тех платформах, для которых не предназначено ваше приложение. Для этого откройте файл проекта, добавьте в него свойство `PlatformCompatIgnore` и перечислите в нем все платформы, которые следует игнорировать. Допустимые значения: `Linux`, `macOS` и (или) `Windows`.

```xml
<PropertyGroup>
    <PlatformCompatIgnore>Linux;macOS</PlatformCompatIgnore>
</PropertyGroup>
```

Если код предназначен для нескольких платформ, но вы хотите воспользоваться преимуществами некоторого API, который поддерживается не всеми этими платформами, вы можете отделить часть кода с помощью инструкции `if` следующим образом:

```csharp
if (RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
{
     var w = Console.WindowWidth;
     // More code
}
```

Также вы можете выполнять условную компиляцию кода для целевой платформы и (или) операционной системы, но пока только [вручную](../frameworks.md#how-to-specify-target-frameworks).

## <a name="supported-diagnostics"></a>Поддерживаемые проверки

Сейчас анализатор обрабатывает следующие сценарии:

* Использование API .NET Standard, которые создают исключение <xref:System.PlatformNotSupportedException> (PC001).
* Использование API .NET Standard, которые не поддерживаются платформой .NET Framework 4.6.1 (PC002).
* Использование собственных API, которые не существуют в универсальной платформе Windows (PC003).
* Использование API-интерфейсов Delegate.BeginInvoke и EndInvoke (PC004).
* Использование API, которые помечены как устаревшие (DEXXXX).

## <a name="ci-machine"></a>Компьютер CI

Все эти диагностические действия доступны не только в среде IDE, но и в командной строке при сборке проекта, в том числе для сервера CI.

## <a name="configuration"></a>Параметр Configuration

Пользователь может выбрать режим поведения для каждой проверки: предупреждения, ошибки, предложения или отключено. Например, архитектор проекта может решить, что проблемы с совместимостью следует рассматривать как ошибки, для вызовов некоторых устаревших API формировать предупреждения, а остальные проверки выполнять только в режиме рекомендаций. Вы можете настроить это поведение отдельно для каждого идентификатора диагностики и каждого проекта. Для этого найдите в **обозревателе решений** узел **Зависимости** для нужного проекта. Разверните узлы **Зависимости** > **Анализаторы** > **Microsoft.DotNet.Analyzers.Compatibility**. Щелкните правой кнопкой мыши идентификатор диагностики, щелкните действие **Установить серьезность набора правил** и выберите нужный вариант.

![Снимок экрана с обозревателем решений и всплывающим диалоговым окном для выбора серьезности набор правил](media/api-analyzer/disable-notifications.jpg)

## <a name="see-also"></a>См. также

- Запись блога [Знакомство с API анализатора](https://devblogs.microsoft.com/dotnet/introducing-api-analyzer/).
- Демонстрационное видео [об анализаторе API](https://youtu.be/eeBEahYXGd0) на YouTube.
