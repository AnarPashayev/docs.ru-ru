---
title: Кроссплатформенное нацеливание для библиотек .NET
description: Рекомендации по созданию кроссплатформенных библиотек .NET.
ms.date: 08/12/2019
ms.openlocfilehash: 61adff3759984554bb83531b4f9d8a49e29c929c
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2020
ms.locfileid: "76731459"
---
# <a name="cross-platform-targeting"></a>Кроссплатформенное нацеливание

Современная версия .NET поддерживает различные операционные системы и устройства. Важно, чтобы библиотеки .NET с открытым кодом обеспечивали поддержку максимального спектра разработок, будь то веб-сайт, созданный на ASP.NET и размещенный в Azure, или .NET- игра на Unity.

## <a name="net-standard"></a>.NET Standard

Добавить в библиотеку .NET. кроссплатформенную поддержку лучше всего с помощью .NET Standard. [.NET Standard](../net-standard.md) — это спецификация API-интерфейсов .NET, которые доступны во всех реализациях .NET. Нацеливание на .NET Standard позволяет создавать библиотеки, которые могут использовать API-интерфейсы определенной версии .NET Standard, т. е. такие библиотеки могут использоваться на всех платформах, на которых реализуется определенная версия .NET Standard.

![.NET Standard](./media/cross-platform-targeting/platforms-netstandard.png ".NET Standard")

Нацеливание на .NET Standard и успешная компиляция проекта не гарантируют, что библиотека будет успешно работать на всех платформах.

1. API-интерфейсы для конкретных платформ не будут работать на других платформах. К примеру, <xref:Microsoft.Win32.Registry?displayProperty=nameWithType> будет нормально работать в ОС Windows и вызывать исключение <xref:System.PlatformNotSupportedException> в любой другой операционной системе.
2. API-интерфейсы могут работать по-разному. Например, поддерживающие рефлексию API-интерфейсы демонстрируют другие показатели производительности, если приложение использует компиляцию AOT на платформе iOS или UWP.

> [!TIP]
> Команда разработчиков .NET рекомендует использовать [анализатор Roslyn](../analyzers/api-analyzer.md), чтобы обнаружить потенциальные проблемы.

✔️ ️СЛЕДУЕТ в первую очередь указать целевую платформу `netstandard2.0`.

> Большинству универсальных библиотек не нужны API за пределами .NET Standard 2.0. Платформу .NET Standard 2.0 поддерживают все современные платформы. Ее рекомендуется использовать всегда, когда нужно реализовать кроссплатформенность с помощью одной целевой платформы.

❌ НЕЖЕЛАТЕЛЬНО указывать целевую платформу `netstandard1.x`.

> .NET Standard 1.x распространяется в виде набора небольших пакетов NuGet, что создает большую схему зависимостей пакетов и приводит к тому, что разработчики во время компиляции скачивают много пакетов. Все современные платформы .NET, включая .NET Framework 4.6.1, UWP и Xamarin, поддерживают .NET Standard 2.0. .NET Standard 1.x следует указывать, только если вам специально нужна более старая платформа.

✔️ СЛЕДУЕТ указать `netstandard2.0`, если вам требуется целевая платформа `netstandard1.x`.

> Все платформы, которые поддерживают .NET Standard 2.0, будут использовать целевую платформу `netstandard2.0`, а граф пакетов будет меньшим. При этом старые платформы также будут работать, но использовать они будут целевую платформу `netstandard1.x`.

❌ НЕ СЛЕДУЕТ указывать целевую платформу .NET Standard, если библиотека зависит от модели приложений для определенной платформы.

> Например, библиотека средств управления UWP зависит от модели приложений, которая доступна только для UWP. API-интерфейсы для определенных моделей приложений недоступны в .NET Standard.

## <a name="multi-targeting"></a>Настройка для различных версий

Иногда из библиотек необходимо получить доступ к API-интерфейсам конкретной платформы. Многоплатформенное нацеливание — лучший способ вызова API определенной платформы. Это означает, что проект создается с поддержкой не одной, а нескольких [требуемых версий .NET](../frameworks.md).

Чтобы пользователям не приходилось компилировать проект под разные платформы, старайтесь писать код под NET Standard плюс под еще одну или несколько определенных платформ. В случае с многоплатформенным нацеливанием все сборки упаковываются в один пакет NuGet. Таким образом пользователи будут ссылаться на один пакет, а NuGet будет выбирать подходящую реализацию. Библиотека .NET Standard выступает в качестве резервной. Она используется всегда, за исключением случаев, когда пакет NuGet предлагает реализацию под определенную платформу. Многоплатформенное нацеливание позволяет использовать условную компиляцию кода и вызывать API-интерфейсы определенных платформ.

![Пакет NuGet с несколькими сборками](./media/cross-platform-targeting/nuget-package-multiple-assemblies.png "Пакет NuGet с несколькими сборками")

✔ РЕКОМЕНДУЕТСЯ (помимо нацеливания на .NET Standard) также указать реализации .NET.

> Нацеливание на реализации .NET позволяет вызывать API-интерфейсы определенных платформ, которые не включены в .NET Standard.
>
> При этом не стоит исключать .NET Standard. Вместо этого выдайте исключение из реализации и предложите использовать API, поддерживающие нужные возможности. Таким образом библиотека окажется универсальной и будет поддерживать активацию функций в среде выполнения.

```csharp
public static class GpsLocation
{
    // This project uses multi-targeting to expose device-specific APIs to .NET Standard.
    public static async Task<(double latitude, double longitude)> GetCoordinatesAsync()
    {
#if NET461
        return CallDotNetFramworkApi();
#elif WINDOWS_UWP
        return CallUwpApi();
#else
        throw new PlatformNotSupportedException();
#endif
    }

    // Allows callers to check without having to catch PlatformNotSupportedException
    // or replicating the OS check.
    public static bool IsSupported
    {
        get
        {
#if NET461 || WINDOWS_UWP
            return true;
#else
            return false;
#endif
        }
    }
}
```

❌ НЕЖЕЛАТЕЛЬНО использовать многоплатформенное нацеливание, а также нацеливание с помощью .NET Standard, если исходный код будет одинаковым для всех целевых платформ.

> NuGet будет автоматически использовать сборку .NET Standard. Нацеливание на отдельные реализации .NET увеличивает размер файла `*.nupkg`, не давая взамен никаких преимуществ.

✔️ РЕКОМЕНДУЕТСЯ добавить целевую платформу для `net461`, если вы предлагаете целевую платформу `netstandard2.0`.

> Некоторые проблемы с использованием .NET Standard 2.0 в .NET Framework были устраненные в .NET Framework версии 4.7.2. Можно улучшить работу разработчиков, которые по-прежнему используют .NET Framework версий 4.6.1 — 4.7.1, предложив им двоичный файл, скомпилированный для .NET Framework 4.6.1.

✔️ DO Распространение библиотеки с помощью пакета NuGet.

> NuGet определит для разработчиков наиболее подходящую целевую платформу и избавит их от необходимости выбирать подходящую реализацию.

✔️ СЛЕДУЕТ использовать свойство `TargetFrameworks` файла проекта при многоплатформенном нацеливании.

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <!-- This project will output netstandard2.0 and net461 assemblies -->
    <TargetFrameworks>netstandard2.0;net461</TargetFrameworks>
  </PropertyGroup>
</Project>
```

✔ РЕКОМЕНДУЕТСЯ использовать [MSBuild.Sdk.Extras](https://github.com/onovotny/MSBuildSdkExtras) при многоплатформенном нацеливании на UWP и Xamarin, так как это значительно упрощает файл проекта.

## <a name="older-targets"></a>Старые целевые платформы

.NET поддерживает работу с уже неподдерживаемыми версиями .NET Framework, а также с редко используемыми платформами. Поддержка библиотекой максимального числа платформ в некотором смысле оправдана, но реализация решений для отсутствующих API может привести к значительному увеличению размера библиотеки. Мы считаем нецелесообразным обеспечивать поддержку некоторых платформ, учитывая их малую распространенность и ограничения.

❌ НЕ️ СЛЕДУЕТ добавлять целевую платформу переносимой библиотеки классов (PCL). Например, `portable-net45+win8+wpa81+wp8`.

> .NET Standard предлагает современный способ поддержки кроссплатформенных библиотек .NET и полностью заменяет PCL.

❌ НЕ СЛЕДУЕТ добавлять поддержку платформ .NET, которые больше не поддерживаются. Например, `SL4`, `WP`.

>[!div class="step-by-step"]
>[Назад](get-started.md)
>[Вперед](strong-naming.md)
