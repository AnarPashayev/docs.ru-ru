---
title: Зависимости и библиотеки .NET
description: Рекомендации по управлению зависимостями NuGet в библиотеках .NET.
ms.date: 10/02/2018
ms.openlocfilehash: b5742bf4724c4aff4beb4ca40a543bd096528a00
ms.sourcegitcommit: 5f236cd78cf09593c8945a7d753e0850e96a0b80
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/07/2020
ms.locfileid: "75706508"
---
# <a name="dependencies"></a>Зависимости

Основным средством для добавления зависимостей в библиотеку .NET являются ссылки на пакеты NuGet. Ссылки на пакеты NuGet позволяют быстро подключить уже готовые функции, но для многих разработчиков .NET они часто становятся источником трудностей. Правильное управление зависимостями нужно для того, чтобы изменения в чужих библиотеках .NET не нарушали работу вашей библиотеки .NET, и наоборот.

## <a name="diamond-dependencies"></a>Ромбовидные зависимости

Широко распространены ситуации, когда в дереве зависимостей для проекта .NET существует несколько версий одного пакета. Например, если приложение зависит от двух пакетов NuGet, которые в свою очередь зависят от разных версий одного пакета. В схеме зависимостей это отображено в виде ромбовидной зависимости.

![Ромбовидная зависимость](./media/dependencies/diamond-dependency.png "Ромбовидная зависимость")

Во время сборки NuGet анализирует все пакеты, от которых зависит проект, в том числе зависимости зависимостей. Если в этом списке есть нескольких версий одного пакета, из них выбирается одна. Унификация пакетов очень важна, так как в .NET очень сложно реализовать параллельную работу нескольких версий одной сборки в одном приложении.

Большинство ромбовидных зависимостей решаются очень легко, но в определенных обстоятельствах они могут создавать проблемы:

1. **Конфликт ссылок на пакет NuGet** не позволяет разрешить конфликт версий при восстановлении пакетов.
2. **Критические изменения между версиями** приводят к ошибкам и исключениям во время выполнения.
3. **Строгое именование пакета сборки**, если изменилась версия сборки для приложения, выполняющегося на .NET Framework. В такой ситуации требуется переадресация привязок.

Невозможно предсказать, какие пакеты будут работать параллельно с вашим. Чтобы снизить вероятность проблем с библиотекой при возникновении ромбовидной зависимости, сократите до минимума число пакетов, от которых она зависит.

**✔️ РЕКОМЕНДУЕТСЯ.** Проверьте наличие ненужных зависимостей в библиотеке .NET.

## <a name="nuget-dependency-version-ranges"></a>Диапазон версий для зависимостей NuGet

Ссылка на пакет определяет диапазон допустимых пакетов. Как правило, ссылка в файле проекта определяет минимально необходимую версию пакета, а верхний предел отсутствует.

```xml
<!-- Accepts any version 1.0 and above. -->
<PackageReference Include="ExamplePackage" Version="1.0" />
```

NuGet использует достаточно [сложные](/nuget/consume-packages/dependency-resolution) правила при разрешении зависимостей, всегда пытаясь найти минимально приемлемую версию. NuGet предпочитает минимально приемлемую версию, а не максимально доступную, чтобы снизить риск проблем с совместимостью.

Это правило минимально приемлемых версий позволяет не указывать верхний предел для диапазона версий пакета, даже если вы хотите избежать получения последней версии. NuGet и без этого будет искать наименьшую, то есть максимально совместимую, версию пакета.

```xml
<!-- Accepts 1.0 up to 1.x, but not 2.0 and higher. -->
<PackageReference Include="ExamplePackage" Version="[1.0,2.0)" />

<!-- Accepts exactly 1.0. -->
<PackageReference Include="ExamplePackage" Version="[1.0]" />
```

Наличие верхнего предела для версий пакета приведет к сбою NuGet в случае конфликта зависимостей. Предположим, одна из библиотек требует строго версию 1.0, а другая — версию не ниже 2.0. Использование версии 2.0 может привести к ошибкам, если в ней внесены критические изменения. Но строгое верхнее ограничение гарантирует ошибку.

![Конфликт ромбовидной зависимости](./media/dependencies/diamond-dependency-conflict.png "Конфликт ромбовидной зависимости")

**❌ НЕЛЬЗЯ.** Не используйте ссылки на пакет NuGet без минимально допустимой версии.

**❌ AVOID** Ссылки на пакеты NuGet, требующие указания точной версии.

**❌ НЕЖЕЛАТЕЛЬНО.** Не используйте ссылки на пакет NuGet с указанием верхнего предела.

## <a name="nuget-shared-source-packages"></a>Совместно используемые пакеты кода NuGet

Чтобы снизить внешние зависимости пакета NuGet, можно использовать ссылки на совместно используемые пакеты кода. Совместно используемые пакеты кода содержат [файлы исходного кода](/nuget/reference/nuspec#including-content-files), которые включаются в проект по ссылке. Так как эти файлы исходного кода напрямую включаются в проект и компилируются вместе с остальной частью проекта, не возникает никаких внешних зависимостей и возможностей для конфликта.

Совместно используемые пакеты кода — это отличный способ включать небольшие фрагменты и функции. Например, совместно используемый пакет кода может содержать вспомогательные методы для выполнения вызовов HTTP.

![Совместно используемый исходный пакет](./media/dependencies/shared-source-package.png "Совместно используемый исходный пакет")

```xml
<PackageReference Include="Microsoft.Extensions.Buffers.Testing.Sources" PrivateAssets="All" Version="1.0" />
```

![Совместно используемый исходный проект](./media/dependencies/shared-source-project.png "Совместно используемый исходный проект")

Совместно используемые пакеты кода имеют ряд ограничений. Для них можно использовать только ссылки `PackageReference`, поэтому более старые проекты `packages.config` исключаются. Также совместно используемые пакеты кода можно применять только в проектах с тем же типом языка. Из-за этих ограничений совместно используемые пакеты кода лучше всего подходят для совместного использования функций в рамках проекта с открытым исходным кодом.

**✔️ ДОПУСТИМО.** Вы можете использовать ссылки на совместно используемых пакетов кода для небольших встроенных функций.

**✔️ ДОПУСТИМО.** Вы можете создать совместно используемый пакет кода, если он предоставляет небольшие встроенные функции.

**✔️ РЕКОМЕНДУЕТСЯ.** Указывайте ссылку `PrivateAssets="All"` для совместно используемых пакетов кода.

> Этот вариант сообщает NuGet, что пакет будет использоваться только во время разработки и не должен предоставляться как открытая зависимость.

**❌ НЕЛЬЗЯ.** Не используйте совместно используемые пакеты кода в общедоступном API.

> Совместно используемые типы компилируются прямо в сборку, которая содержит ссылку на них, и их невозможно передать в другую сборку. Например, совместно используемый тип `IRepository` в одном проекте не будет совпадать с тем же совместно используемым типом `IRepository` в другом проекте. Типы в совместно используемых пакетах кода должны иметь предел видимости `internal`.

**❌ НЕЛЬЗЯ.** Не публикуйте совместно используемые пакеты кода на сайте NuGet.org.

> Совместно используемые пакеты кода содержат исходный код и могут использоваться только в проектах с тем же типом языка. Например, совместно используемые пакеты кода на C# невозможно использовать в приложении F#.
>
> Опубликуйте совместно используемые пакеты кода в [локальном веб-канале или MyGet](./publish-nuget-package.md) для их использования в проекте внутренним образом.

>[!div class="step-by-step"]
>[Назад](nuget.md)
>[Вперед](sourcelink.md)
