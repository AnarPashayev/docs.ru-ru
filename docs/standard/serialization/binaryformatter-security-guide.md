---
title: Руководство по безопасности BinaryFormatter
description: В этой статье описываются риски безопасности, присущие типу BinaryFormatter, а также приводятся рекомендации по использованию различных сериализаторов.
ms.date: 07/11/2020
ms.author: levib
author: GrabYourPitchforks
ms.openlocfilehash: f6a54b34bbf1e19212fe37aadb448a1722fe9ff0
ms.sourcegitcommit: 2543a78be6e246aa010a01decf58889de53d1636
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/17/2020
ms.locfileid: "86444754"
---
# <a name="binaryformatter-security-guide"></a>Руководство по безопасности BinaryFormatter

Эта статья применяется к следующим реализациям .NET:

* Все версии .NET Framework
* .NET Core 2.1 – 3.1
* .NET 5.0 и более поздней версии

## <a name="background"></a>Фон

> [!WARNING]
> Тип <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter> не является безопасным и ***не рекомендуется*** к применению для обработки данных. Даже если есть основания доверять обрабатываемым в приложении данным, следует как можно скорее прекратить использование типа `BinaryFormatter`. Обратите внимание, что обеспечить безопасное применение типа `BinaryFormatter` невозможно.

Эта статья также применима к следующим типам:

* <xref:System.Runtime.Serialization.Formatters.Soap.SoapFormatter>
* <xref:System.Runtime.Serialization.NetDataContractSerializer>
* <xref:System.Web.UI.LosFormatter>
* <xref:System.Web.UI.ObjectStateFormatter>

Уязвимости десериализации относятся к категории угроз, связанных с небезопасной обработкой полезных данных запроса. Использующие такие уязвимости злоумышленники могут провести на целевое приложение атаки, приводящие к отказу в обслуживании, раскрытию информации или удаленному выполнению кода в нем. Риски этой категории отнесены к [10 основным угрозам в рамках открытого проекта безопасности веб-приложений (OWASP)](https://owasp.org/www-project-top-ten/). В качестве целевых могут выступать приложения, написанные на [самых разных языках](https://owasp.org/www-community/vulnerabilities/Deserialization_of_untrusted_data), включая C/C++, Java и C#.

В .NET основная угроза связана с приложениями, в которых для десериализации данных используется тип <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter>. Тип `BinaryFormatter` широко применяется в экосистеме .NET благодаря своей эффективности и простоте использования. Тем не менее, именно благодаря столь широким возможностям злоумышленники могут использовать его для внедрения в поток управления целевого приложения. В случае успешной атаки злоумышленник получает возможность выполнять код в контексте целевого процесса.

Для простоты можно привести следующую аналогию: вызов `BinaryFormatter.Deserialize` в отношении полезной нагрузки эквивалентен интерпретации такой нагрузки как автономного исполняемого файла и его запуску.

## <a name="binaryformatter-security-vulnerabilities"></a>Уязвимости безопасности BinaryFormatter

> [!WARNING]
> Метод `BinaryFormatter.Deserialize` __ни при каких обстоятельствах__ не может считаться безопасным при работе с входными данными, не относящимися к доверенным. Вместо него мы настоятельно рекомендуем использовать любой из описываемых далее в этой статье альтернативных подходов.

Тип `BinaryFormatter` был реализован еще до того, как были четко определены угрозы, связанные с уязвимостями десериализации. Соответственно, его код не соответствует современным рекомендациям. Таким образом, злоумышленники могут использовать метод `Deserialize` для проведения атак типа "отказ в обслуживании" на использующее его приложение. В случае успешного проведения подобных атак приложение может перестать отвечать, а также может произойти непредвиденное завершение процесса. Обратите внимание, что предотвратить атаки этой категории с помощью `SerializationBinder` или любого другого параметра конфигурации `BinaryFormatter` невозможно. В .NET такое поведение считается ***преднамеренным*** и не приводит к изменению поведения в результате обновления кода.

Метод `BinaryFormatter.Deserialize` также может быть уязвим для атак других категорий, например, ведущих к раскрытию информации или удаленному выполнению кода. При этом в достаточной степени снизить соответствующие риски с помощью таких функций, как пользовательский класс <xref:System.Runtime.Serialization.SerializationBinder>, не всегда возможно. Кроме того, существует вероятность выявления новых уязвимостей, для которых будет невозможна своевременная публикация обновлений системы безопасности .NET. Мы рекомендуем всем потребителям проанализировать особенности конкретных сценариев применения и оценить их уязвимость в отношении этих рисков.

Кроме того, если в ваших приложениях используется тип `BinaryFormatter`, мы рекомендуем провести отдельную оценку рисков для них. Ответственность за использование типа `BinaryFormatter` полностью возлагается на потребителя. Потребители должны самостоятельно оценивать угрозы в области нарушения безопасности, возникновения технических проблем, потери репутации, а также несоответствия юридическим и нормативным требованиям, которые влечет за собой применение типа `BinaryFormatter`.

## <a name="preferred-alternatives"></a>Рекомендуемые альтернативы

В .NET предлагается несколько встроенных сериализаторов, которые обеспечивают безопасную работу с ненадежными данными:

* <xref:System.Xml.Serialization.XmlSerializer> и <xref:System.Runtime.Serialization.DataContractSerializer> обеспечивают сериализацию графов объектов в XML и в обратную сторону. Не путайте `DataContractSerializer` с <xref:System.Runtime.Serialization.NetDataContractSerializer>.
* <xref:System.IO.BinaryReader> и <xref:System.IO.BinaryWriter> предназначены для XML и JSON.
* API <xref:System.Text.Json> обеспечивают сериализацию графов объектов в JSON.

## <a name="dangerous-alternatives"></a>Опасные альтернативные варианты

Не рекомендуется использовать следующие сериализаторы:

* <xref:System.Runtime.Serialization.Formatters.Soap.SoapFormatter>
* <xref:System.Web.UI.LosFormatter>
* <xref:System.Runtime.Serialization.NetDataContractSerializer>
* <xref:System.Web.UI.ObjectStateFormatter>

Все описываемые выше сериализаторы выполняют неограниченную полиморфную десериализацию и, как и `BinaryFormatter`, являются небезопасными.

## <a name="the-risks-of-assuming-data-to-be-trustworthy"></a>Риски, связанные с необоснованным доверием данным

Зачастую разработчик приложения полагается на то, что в нем обрабатываются только надежные данные. Однако на самом деле входные данные действительно являются безопасными лишь в редких случаях. Куда чаще полезная нагрузка выходит за границы доверенной области, о чем разработчик может даже не догадываться.

__Рассмотрим локальный сервер__, где располагается служба, с которой сотрудники взаимодействуют при помощи установленных на рабочих станциях классических версий клиента. Такой сценарий может ошибочно считаться безопасным, в котором допустимо применение типа `BinaryFormatter`. Тем не менее, в нем существует способ проникновения вредоносных программ, которые могут получать доступ к компьютеру отдельного сотрудника и затем распространятся по всей организации. Если организация использует тип `BinaryFormatter`, благодаря ему такие вредоносные программы могут проникнуть с рабочей станции сотрудника на внутренний сервер. После этого они смогут перехватывать конфиденциальные данные компании. К ним, помимо прочего, могут относиться данные клиентов или сведения, представляющие коммерческую тайну.

__Также рассмотрим приложение, в котором тип `BinaryFormatter` применяется для хранения состояния сохранения.__ Как и в предыдущем случае, этот сценарий может изначально показаться безопасным, поскольку операции чтения данных с собственного жесткого диска и записи на него вряд ли могут представлять особую угрозу. Тем не менее, многие современные пользователи активно обмениваются документами через электронную почту и Интернет, но при этом спокойно открывают скачанные файлы, не рассматривая их как угрозу.

Такой сценарий также может быть использован злоумышленниками. Например, пользователи игрового приложения, которые обмениваются сохраненными файлами, непреднамеренно подвергают себя риску. Кроме того, целью злоумышленников могут быть и сами разработчики. Злоумышленник может отправить в службу поддержки разработчика электронное письмо, приложив к нему вредоносный файл данных и попросив сотрудника открыть его. Таким образом, злоумышленник может проникнуть в инфраструктуру организации.

Кроме того, файл данных может размещаться в облачном хранилище и автоматически синхронизироваться с компьютерами пользователей. В таком сценарии злоумышленник может получить доступ к учетной записи облачного хранилища и внедрить в этот файл вредоносный код или заменить его. После этого вредоносный файл автоматически синхронизируется с компьютерами пользователей. В следующий раз, когда пользователь откроет этот файл данных, будет запущена вредоносная полезная нагрузка. Таким образом, злоумышленник может использовать учетную запись облачного хранилища для получения полных разрешений на выполнение кода.

__Рассмотрим приложение, для которого классическая модель установки заменяется облачной.__ Например, этот сценарий может включать в себя классические приложения, для которых осуществляется переход к модели полнофункционального клиента или веб-приложения. Модели угроз, характерные для классических приложений, не обязательно будут относиться к облачным службам. К примеру, определенная угроза может исключаться, поскольку клиент не заинтересован в атаке на собственную систему. Тем не менее, та же самая угроза становится вполне реальной в контексте намерения удаленного пользователя (клиента) атаковать саму облачную службу.

> [!NOTE]
> В общем смысле сериализация предназначена для передачи объекта в приложение или из него. В рамках моделирования угроз подобные операции передачи данных почти всегда рассматриваются как пересекающие границу доверия.

## <a name="further-resources"></a>Дополнительные ресурсы

* [YSoSerial.Net](https://github.com/pwntester/ysoserial.net) — дополнительные сведения о способах, которыми злоумышленники могут атаковать приложения, использующие тип `BinaryFormatter`.
* [Моделирование угроз](/securityengineering/sdl/threatmodeling) — информация о приложениях и службах, предназначенных для моделирования угроз.
* Общие сведения об уязвимостях десериализации:
  * [Открытый проект безопасности веб-приложений (OWASP). Основные 10 угроз. A8:2017. Небезопасная десериализация](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A8-Insecure_Deserialization)
  * [CWE-502. Десериализация ненадежных данных](https://cwe.mitre.org/data/definitions/502.html)
