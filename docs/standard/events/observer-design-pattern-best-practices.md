---
title: Рекомендации по шаблону разработки Observer
ms.date: 03/30/2017
ms.technology: dotnet-standard
helpviewer_keywords:
- observer design pattern [.NET], best practices
- best practices [.NET], observer design pattern
ms.assetid: c834760f-ddd4-417f-abb7-a059679d5b8c
ms.openlocfilehash: 8e75343e1ca1c7f69306ee45148f2dc0eec3585f
ms.sourcegitcommit: b1442669f1982d3a1cb18ea35b5acfb0fc7d93e4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2020
ms.locfileid: "93064084"
---
# <a name="observer-design-pattern-best-practices"></a><span data-ttu-id="35f8d-102">Рекомендации по шаблону разработки Observer</span><span class="sxs-lookup"><span data-stu-id="35f8d-102">Observer Design Pattern Best Practices</span></span>

<span data-ttu-id="35f8d-103">В .NET конструктивный шаблон наблюдателя реализован в виде набора интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="35f8d-103">In .NET, the observer design pattern is implemented as a set of interfaces.</span></span> <span data-ttu-id="35f8d-104">Интерфейс <xref:System.IObservable%601?displayProperty=nameWithType> представляет поставщик данных, который также отвечает за предоставление реализации <xref:System.IDisposable>, позволяющей наблюдателям отменять подписку на уведомления.</span><span class="sxs-lookup"><span data-stu-id="35f8d-104">The <xref:System.IObservable%601?displayProperty=nameWithType> interface represents the data provider, which is also responsible for providing an <xref:System.IDisposable> implementation that lets observers unsubscribe from notifications.</span></span> <span data-ttu-id="35f8d-105">Интерфейс <xref:System.IObserver%601?displayProperty=nameWithType> представляет наблюдателя.</span><span class="sxs-lookup"><span data-stu-id="35f8d-105">The <xref:System.IObserver%601?displayProperty=nameWithType> interface represents the observer.</span></span> <span data-ttu-id="35f8d-106">В этом разделе содержатся рекомендации, которым должны следовать разработчики при реализации шаблона разработки наблюдателя с помощью этих интерфейсов.</span><span class="sxs-lookup"><span data-stu-id="35f8d-106">This topic describes the best practices that developers should follow when implementing the observer design pattern using these interfaces.</span></span>  
  
## <a name="threading"></a><span data-ttu-id="35f8d-107">Потоки</span><span class="sxs-lookup"><span data-stu-id="35f8d-107">Threading</span></span>  
 <span data-ttu-id="35f8d-108">Как правило, поставщик реализует метод <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> путем добавления определенного наблюдателя в список подписчиков, представленный неким объектом коллекции, и он реализует метод <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> путем удаления определенного наблюдателя из списка подписчиков.</span><span class="sxs-lookup"><span data-stu-id="35f8d-108">Typically, a provider implements the <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> method by adding a particular observer to a subscriber list that is represented by some collection object, and it implements the <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> method by removing a particular observer from the subscriber list.</span></span> <span data-ttu-id="35f8d-109">Наблюдатель может вызвать эти методы в любое время.</span><span class="sxs-lookup"><span data-stu-id="35f8d-109">An observer can call these methods at any time.</span></span> <span data-ttu-id="35f8d-110">Кроме того, поскольку в контракте поставщика и наблюдателя не указано, кто несет ответственность за отмену подписки после реализации метода обратного вызова <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType>, попытаться удалить тот же самый элемент из списка может как поставщик, так и наблюдатель.</span><span class="sxs-lookup"><span data-stu-id="35f8d-110">In addition, because the provider/observer contract does not specify who is responsible for unsubscribing after the <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> callback method, the provider and observer may both try to remove the same member from the list.</span></span> <span data-ttu-id="35f8d-111">В связи с этим методы <xref:System.IObservable%601.Subscribe%2A> и <xref:System.IDisposable.Dispose%2A> должны быть потокобезопасными.</span><span class="sxs-lookup"><span data-stu-id="35f8d-111">Because of this possibility, both the <xref:System.IObservable%601.Subscribe%2A> and <xref:System.IDisposable.Dispose%2A> methods should be thread-safe.</span></span> <span data-ttu-id="35f8d-112">Как правило, в этом случае предполагается использование [параллельной коллекции](../parallel-programming/data-structures-for-parallel-programming.md) или блокировки.</span><span class="sxs-lookup"><span data-stu-id="35f8d-112">Typically, this involves using a [concurrent collection](../parallel-programming/data-structures-for-parallel-programming.md) or a lock.</span></span> <span data-ttu-id="35f8d-113">Реализации, которые не являются потокобезопасными, должны явным образом сообщать об этом.</span><span class="sxs-lookup"><span data-stu-id="35f8d-113">Implementations that are not thread-safe should explicitly document that they are not.</span></span>  
  
 <span data-ttu-id="35f8d-114">Любые дополнительные гарантии должны быть указаны на уровне выше контракта поставщика и наблюдателя.</span><span class="sxs-lookup"><span data-stu-id="35f8d-114">Any additional guarantees have to be specified in a layer on top of the provider/observer contract.</span></span> <span data-ttu-id="35f8d-115">Чтобы избежать недоразумений, связанных с контрактом наблюдателя, разработчики должны четко сообщать о введении дополнительных требований.</span><span class="sxs-lookup"><span data-stu-id="35f8d-115">Implementers should clearly call out when they impose additional requirements to avoid user confusion about the observer contract.</span></span>  
  
## <a name="handling-exceptions"></a><span data-ttu-id="35f8d-116">Обработка исключений</span><span class="sxs-lookup"><span data-stu-id="35f8d-116">Handling Exceptions</span></span>  
 <span data-ttu-id="35f8d-117">Из-за слабой связи между поставщиком данных и наблюдателем исключения в шаблоне разработки наблюдателя носят информативный характер.</span><span class="sxs-lookup"><span data-stu-id="35f8d-117">Because of the loose coupling between a data provider and an observer, exceptions in the observer design pattern are intended to be informational.</span></span> <span data-ttu-id="35f8d-118">Это оказывает влияние на процесс обработки исключений поставщиками и наблюдателями в шаблоне разработки наблюдателя.</span><span class="sxs-lookup"><span data-stu-id="35f8d-118">This affects how providers and observers handle exceptions in the observer design pattern.</span></span>  
  
### <a name="the-provider----calling-the-onerror-method"></a><span data-ttu-id="35f8d-119">Поставщик — вызов метода OnError</span><span class="sxs-lookup"><span data-stu-id="35f8d-119">The Provider -- Calling the OnError Method</span></span>  
 <span data-ttu-id="35f8d-120">Метод <xref:System.IObserver%601.OnError%2A> предназначен для использования в качестве информационного сообщения для наблюдателей и очень похож на метод <xref:System.IObserver%601.OnNext%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-120">The <xref:System.IObserver%601.OnError%2A> method is intended as an informational message to observers, much like the <xref:System.IObserver%601.OnNext%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="35f8d-121">Однако метод <xref:System.IObserver%601.OnNext%2A> позволяет предоставлять наблюдателю текущие или обновленные данных, тогда как метод <xref:System.IObserver%601.OnError%2A> указывает на то, что поставщик не может предоставлять допустимые денные.</span><span class="sxs-lookup"><span data-stu-id="35f8d-121">However, the <xref:System.IObserver%601.OnNext%2A> method is designed to provide an observer with current or updated data, whereas the <xref:System.IObserver%601.OnError%2A> method is designed to indicate that the provider is unable to provide valid data.</span></span>  
  
 <span data-ttu-id="35f8d-122">При обработке исключений и вызове метода <xref:System.IObserver%601.OnError%2A> поставщику следует придерживаться приведенных ниже рекомендаций.</span><span class="sxs-lookup"><span data-stu-id="35f8d-122">The provider should follow these best practices when handling exceptions and calling the <xref:System.IObserver%601.OnError%2A> method:</span></span>  
  
- <span data-ttu-id="35f8d-123">Поставщик должен обрабатывать свои собственные исключения при наличии конкретных требований.</span><span class="sxs-lookup"><span data-stu-id="35f8d-123">The provider must handle its own exceptions if it has any specific requirements.</span></span>  
  
- <span data-ttu-id="35f8d-124">Поставщик не должен ожидать или требовать, чтобы наблюдатели обрабатывали исключения каким-либо определенным образом.</span><span class="sxs-lookup"><span data-stu-id="35f8d-124">The provider should not expect or require that observers handle exceptions in any particular way.</span></span>  
  
- <span data-ttu-id="35f8d-125">При обработке исключения, подвергающего риску его возможности по предоставлению обновлений, поставщику следует вызывать метод <xref:System.IObserver%601.OnError%2A>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-125">The provider should call the <xref:System.IObserver%601.OnError%2A> method when it handles an exception that compromises its ability to provide updates.</span></span> <span data-ttu-id="35f8d-126">Информацию по таким исключениям можно передать наблюдателю.</span><span class="sxs-lookup"><span data-stu-id="35f8d-126">Information on such exceptions can be passed to the observer.</span></span> <span data-ttu-id="35f8d-127">В других случаях уведомлять наблюдателей об исключении не нужно.</span><span class="sxs-lookup"><span data-stu-id="35f8d-127">In other cases, there is no need to notify observers of an exception.</span></span>  
  
 <span data-ttu-id="35f8d-128">После того, как поставщик вызовет метод <xref:System.IObserver%601.OnError%2A> или <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType>, дальнейшие уведомления поступать не должны, и поставщик может отменить подписку для своих наблюдателей.</span><span class="sxs-lookup"><span data-stu-id="35f8d-128">Once the provider calls the <xref:System.IObserver%601.OnError%2A> or <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> method, there should be no further notifications, and the provider can unsubscribe its observers.</span></span> <span data-ttu-id="35f8d-129">Однако наблюдатели также могут отменить свою подписку в любой момент — до или после получения уведомления <xref:System.IObserver%601.OnError%2A> или <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-129">However, the observers can also unsubscribe themselves at any time, including both before and after they receive an <xref:System.IObserver%601.OnError%2A> or <xref:System.IObserver%601.OnCompleted%2A?displayProperty=nameWithType> notification.</span></span> <span data-ttu-id="35f8d-130">В шаблоне разработки наблюдателя не указывается, кто несет ответственность за отмену подписки. Таким образом, есть вероятность, что отменить подписку попытается и поставщик, и наблюдатель.</span><span class="sxs-lookup"><span data-stu-id="35f8d-130">The observer design pattern does not dictate whether the provider or the observer is responsible for unsubscribing; therefore, there is a possibility that both may attempt to unsubscribe.</span></span> <span data-ttu-id="35f8d-131">Обычно наблюдатель, отменяющий подписку, удаляется из коллекции подписчиков.</span><span class="sxs-lookup"><span data-stu-id="35f8d-131">Typically, when observers unsubscribe, they are removed from a subscribers collection.</span></span> <span data-ttu-id="35f8d-132">В однопоточном приложении перед удалением объекта реализация <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> должна гарантировать, что ссылка на объект является действительной и объект входит в коллекцию подписчиков.</span><span class="sxs-lookup"><span data-stu-id="35f8d-132">In a single-threaded application, the <xref:System.IDisposable.Dispose%2A?displayProperty=nameWithType> implementation should ensure that an object reference is valid and that the object is a member of the subscribers collection before attempting to remove it.</span></span> <span data-ttu-id="35f8d-133">В многопоточном приложении следует использовать объект потокобезопасной коллекций, такой как <xref:System.Collections.Concurrent.BlockingCollection%601?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-133">In a multithreaded application, a thread-safe collection object, such as a <xref:System.Collections.Concurrent.BlockingCollection%601?displayProperty=nameWithType> object, should be used.</span></span>  
  
### <a name="the-observer----implementing-the-onerror-method"></a><span data-ttu-id="35f8d-134">Наблюдатель — реализация метода OnError</span><span class="sxs-lookup"><span data-stu-id="35f8d-134">The Observer -- Implementing the OnError Method</span></span>  
 <span data-ttu-id="35f8d-135">Когда наблюдатель получает от поставщика уведомление об ошибке, он должен рассматривать исключение как информационное и не обязан выполнять никаких конкретных действий.</span><span class="sxs-lookup"><span data-stu-id="35f8d-135">When an observer receives an error notification from a provider, the observer should treat the exception as informational and should not be required to take any particular action.</span></span>  
  
 <span data-ttu-id="35f8d-136">При ответе на вызов метода <xref:System.IObserver%601.OnError%2A> от поставщика наблюдателю следует придерживаться приведенных ниже рекомендаций.</span><span class="sxs-lookup"><span data-stu-id="35f8d-136">The observer should follow these best practices when responding to an <xref:System.IObserver%601.OnError%2A> method call from a provider:</span></span>  
  
- <span data-ttu-id="35f8d-137">Наблюдатель не должен вызывать исключения из своих реализаций интерфейса, таких как <xref:System.IObserver%601.OnNext%2A> или <xref:System.IObserver%601.OnError%2A>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-137">The observer should not throw exceptions from its interface implementations, such as <xref:System.IObserver%601.OnNext%2A> or <xref:System.IObserver%601.OnError%2A>.</span></span> <span data-ttu-id="35f8d-138">Однако если наблюдатель не создает исключения, следует ожидать, что исключения останутся необработанными.</span><span class="sxs-lookup"><span data-stu-id="35f8d-138">However, if the observer does throw exceptions, it should expect these exceptions to go unhandled.</span></span>  
  
- <span data-ttu-id="35f8d-139">Чтобы сохранить стек вызовов, наблюдатель, желающий создать объект <xref:System.Exception>, который был передан в его метод <xref:System.IObserver%601.OnError%2A>, должен упаковать исключение до его создания.</span><span class="sxs-lookup"><span data-stu-id="35f8d-139">To preserve the call stack, an observer that wishes to throw an <xref:System.Exception> object that was passed to its <xref:System.IObserver%601.OnError%2A> method should wrap the exception before throwing it.</span></span> <span data-ttu-id="35f8d-140">Для этой цели можно использовать стандартный объект исключения.</span><span class="sxs-lookup"><span data-stu-id="35f8d-140">A standard exception object should be used for this purpose.</span></span>  
  
## <a name="additional-best-practices"></a><span data-ttu-id="35f8d-141">Дополнительные рекомендации</span><span class="sxs-lookup"><span data-stu-id="35f8d-141">Additional Best Practices</span></span>  
 <span data-ttu-id="35f8d-142">Результатом попытки отмены регистрации в методе <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> может быть пустая ссылка.</span><span class="sxs-lookup"><span data-stu-id="35f8d-142">Attempting to unregister in the <xref:System.IObservable%601.Subscribe%2A?displayProperty=nameWithType> method may result in a null reference.</span></span> <span data-ttu-id="35f8d-143">Поэтому рекомендуется воздержаться от таких действий.</span><span class="sxs-lookup"><span data-stu-id="35f8d-143">Therefore, we recommend that you avoid this practice.</span></span>  
  
 <span data-ttu-id="35f8d-144">Несмотря на наличие возможности прикрепить наблюдателя к нескольким поставщикам, рекомендуется присоединить экземпляр <xref:System.IObserver%601> только к одному экземпляру <xref:System.IObservable%601>.</span><span class="sxs-lookup"><span data-stu-id="35f8d-144">Although it is possible to attach an observer to multiple providers, the recommended pattern is to attach an <xref:System.IObserver%601> instance to only one <xref:System.IObservable%601> instance.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="35f8d-145">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="35f8d-145">See also</span></span>

- [<span data-ttu-id="35f8d-146">Шаблон разработки наблюдателя</span><span class="sxs-lookup"><span data-stu-id="35f8d-146">Observer Design Pattern</span></span>](observer-design-pattern.md)
- [<span data-ttu-id="35f8d-147">Практическое руководство. Реализация объекта Observer</span><span class="sxs-lookup"><span data-stu-id="35f8d-147">How to: Implement an Observer</span></span>](how-to-implement-an-observer.md)
- [<span data-ttu-id="35f8d-148">Практическое руководство. Реализация поставщика</span><span class="sxs-lookup"><span data-stu-id="35f8d-148">How to: Implement a Provider</span></span>](how-to-implement-a-provider.md)
