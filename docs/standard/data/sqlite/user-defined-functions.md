---
title: Определяемые пользователем функции
ms.date: 12/13/2019
description: Узнайте, как создавать определяемые пользователем скалярные и агрегатные функции.
ms.openlocfilehash: 9ee3fbac73215353c8dc82199203b0d25e580cdb
ms.sourcegitcommit: 30a558d23e3ac5a52071121a52c305c85fe15726
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/25/2019
ms.locfileid: "75450414"
---
# <a name="user-defined-functions"></a>Определяемые пользователем функции

Большинство баз данных имеют процедурный диалект SQL, который можно использовать для определения собственных функций. SQLite, однако, работает в процессе с приложением. Вместо того чтобы изучать новый диалект SQL, можно просто использовать язык программирования приложения.

## <a name="scalar-functions"></a>Скалярные функции

Скалярные функции возвращают одно скалярное значение для каждой строки в запросе. Определяйте новые скалярные функции и переопределяйте встроенные, используя <xref:Microsoft.Data.Sqlite.SqliteConnection.CreateFunction%2A>.

Раздел [Типы данных](types.md) содержит список поддерживаемых параметров и возвращаемых типов для аргумента `func`.

При указании аргумента `state` это значение будет передаваться в каждый вызов функции. Используйте этот способ, чтобы избежать завершений.

Укажите `isDeterministic`, если функция является детерминированной, чтобы разрешить SQLite использовать дополнительные оптимизации при компиляции запросов.

В следующем примере показано, как добавить скалярную функцию для вычисления радиуса цилиндра.

[!code-csharp[](../../../../samples/snippets/standard/data/sqlite/ScalarFunctionSample/Program.cs?name=snippet_CreateFunction)]

## <a name="operators"></a>Операторы

Следующие операторы SQLite реализуются соответствующими скалярными функциями. Определение этих скалярных функций в приложении будет переопределять поведение этих операторов.

| Оператор          | Функция      |
| ----------------- | ------------- |
| X GLOB Y          | glob(Y, X)    |
| X LIKE Y          | like(Y, X)    |
| X LIKE Y ESCAPE Z | like(Y, X, Z) |
| X MATCH Y         | match(Y, X)   |
| X REGEXP Y        | regexp(Y, X)  |

В следующем примере показано, как определить функцию regexp для включения соответствующего оператора. SQLite не включает реализацию по умолчанию функции regexp.

[!code-csharp[](../../../../samples/snippets/standard/data/sqlite/RegularExpressionSample/Program.cs?name=snippet_Regex)]

## <a name="aggregate-functions"></a>Агрегатные функции

Агрегатные функции возвращают одно агрегированное значение для всех строк в запросе. Определяйте и переопределяйте агрегатные функции с помощью <xref:Microsoft.Data.Sqlite.SqliteConnection.CreateAggregate%2A>.

Аргумент `seed` указывает начальное состояние контекста. Он также используется, чтобы избежать завершений.

Аргумент `func` вызывается один раз для каждой строки. Используйте контекст для накопления конечного результата. Возвратите контекст. Этот шаблон позволяет контексту быть типом значения или неизменяемым.

Если `resultSelector` не указано, в качестве результата используется конечное состояние контекста. Это может упростить определение функций, таких как sum и count, для которых требуется только увеличение числа строк и их возврат.

Укажите `resultSelector`, чтобы вычислить окончательный результат из контекста после прохода по всем строкам.

Раздел [Типы данных](types.md) содержит список поддерживаемых параметров для аргумента `func` и возвращаемых типов для `resultSelector`.

Укажите `isDeterministic`, если функция является детерминированной, чтобы разрешить SQLite использовать дополнительные оптимизации при компиляции запросов.

В следующем примере определяется агрегатная функция для вычисления стандартного отклонения столбца.

[!code-csharp[](../../../../samples/snippets/standard/data/sqlite/AggregateFunctionSample/Program.cs?name=snippet_CreateAggregate)]

## <a name="errors"></a>Ошибки

Если определяемая пользователем функция создает исключение, сообщение возвращается SQLite. Затем SQLite вызовет ошибку, а Microsoft.Data.SQLite вызовет SqliteException. Дополнительные сведения см. в статье [Ошибки базы данных](database-errors.md).

По умолчанию кодом ошибки SQLite будет SQLITE_ERROR (или 1). Но его можно изменить, выполнив <xref:Microsoft.Data.Sqlite.SqliteException> в функции с указанным нужным <xref:Microsoft.Data.Sqlite.SqliteException.SqliteErrorCode>.

## <a name="debugging"></a>Отладка

SQLite вызывает вашу реализацию напрямую. Это позволяет добавлять точки останова, которые инициируются, когда SQLite оценивает запросы. Для создания определяемых пользователем функций доступны все возможности отладки .NET.

## <a name="see-also"></a>См. также

* [Типы данных](types.md)
* [Функции ядра SQLite](https://www.sqlite.org/lang_corefunc.html)
* [Агрегатные функции SQLite](https://www.sqlite.org/lang_aggfunc.html)
