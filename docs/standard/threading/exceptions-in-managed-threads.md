---
title: Исключения в управляемых потоках
description: Узнайте, как обрабатываются необработанные исключения в .NET. В .NET версии 2.0 большинство необработанных исключений потоков приводит к завершению работы приложения.
ms.date: 03/30/2017
ms.technology: dotnet-standard
helpviewer_keywords:
- unhandled exceptions,in managed threads
- threading [.NET Framework],unhandled exceptions
- threading [.NET Framework],exceptions in managed threads
- managed threading
ms.assetid: 11294769-2e89-43cb-890e-ad4ad79cfbee
ms.openlocfilehash: 2facb68c77815de7a6fb97ab8f2ee683ffbad724
ms.sourcegitcommit: 5fd4696a3e5791b2a8c449ccffda87f2cc2d4894
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/15/2020
ms.locfileid: "84767888"
---
# <a name="exceptions-in-managed-threads"></a><span data-ttu-id="b88ed-104">Исключения в управляемых потоках</span><span class="sxs-lookup"><span data-stu-id="b88ed-104">Exceptions in Managed Threads</span></span>
<span data-ttu-id="b88ed-105">Начиная с .NET Framework версии 2.0, среда CLR позволяет большинству необработанных исключений выполняться в потоках.</span><span class="sxs-lookup"><span data-stu-id="b88ed-105">Starting with the .NET Framework version 2.0, the common language runtime allows most unhandled exceptions in threads to proceed naturally.</span></span> <span data-ttu-id="b88ed-106">Как правило, это означает, что необработанное исключение будет вызывать завершение работы приложения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-106">In most cases this means that the unhandled exception causes the application to terminate.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b88ed-107">Это значительное изменение по сравнению с .NET Framework 1.0 и 1.1, в которых поддерживались многие необработанные исключения, например необработанные исключения в потоках из пула потоков.</span><span class="sxs-lookup"><span data-stu-id="b88ed-107">This is a significant change from the .NET Framework versions 1.0 and 1.1, which provide a backstop for many unhandled exceptions — for example, unhandled exceptions in thread pool threads.</span></span> <span data-ttu-id="b88ed-108">См. [Отличия от предыдущих версий](#ChangeFromPreviousVersions) ниже в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="b88ed-108">See [Change from Previous Versions](#ChangeFromPreviousVersions) later in this topic.</span></span>  
  
 <span data-ttu-id="b88ed-109">Среда CLR предоставляет поддержку для определенных необработанных исключений, которые используются для управления потоком выполнения программы:</span><span class="sxs-lookup"><span data-stu-id="b88ed-109">The common language runtime provides a backstop for certain unhandled exceptions that are used for controlling program flow:</span></span>  
  
- <span data-ttu-id="b88ed-110">В потоке создается исключение <xref:System.Threading.ThreadAbortException> из-за вызова <xref:System.Threading.Thread.Abort%2A>.</span><span class="sxs-lookup"><span data-stu-id="b88ed-110">A <xref:System.Threading.ThreadAbortException> is thrown in a thread because <xref:System.Threading.Thread.Abort%2A> was called.</span></span>  
  
- <span data-ttu-id="b88ed-111">В потоке создается исключение <xref:System.AppDomainUnloadedException> из-за того, что в данный момент выгружается домен приложения, в котором выполняется поток.</span><span class="sxs-lookup"><span data-stu-id="b88ed-111">An <xref:System.AppDomainUnloadedException> is thrown in a thread because the application domain in which the thread is executing is being unloaded.</span></span>  
  
- <span data-ttu-id="b88ed-112">Среда CLR или ведущий процесс прерывает выполнение потока путем создания внутреннего исключения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-112">The common language runtime or a host process terminates the thread by throwing an internal exception.</span></span>  
  
 <span data-ttu-id="b88ed-113">Если любые из этих исключений не обрабатываются в потоках, созданных в среде CLR, исключение завершает поток, однако среда CLR не позволяет исключению выполнять какие-либо дополнительные действия.</span><span class="sxs-lookup"><span data-stu-id="b88ed-113">If any of these exceptions are unhandled in threads created by the common language runtime, the exception terminates the thread, but the common language runtime does not allow the exception to proceed further.</span></span>  
  
 <span data-ttu-id="b88ed-114">Если эти исключения не обрабатываются в главном потоке или в потоках, которые перешли в среду выполнения из неуправляемого кода, они продолжают выполнение, что приводит к завершению работы приложения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-114">If these exceptions are unhandled in the main thread, or in threads that entered the runtime from unmanaged code, they proceed normally, resulting in termination of the application.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b88ed-115">Среда выполнения может создать необработанное исключение до того, как любой управляемый код сможет установить обработчик исключения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-115">It is possible for the runtime to throw an unhandled exception before any managed code has had a chance to install an exception handler.</span></span> <span data-ttu-id="b88ed-116">Даже если управляемый код не в состоянии обработать такое исключение, исключение может продолжать выполняться.</span><span class="sxs-lookup"><span data-stu-id="b88ed-116">Even though managed code had no chance to handle such an exception, the exception is allowed to proceed naturally.</span></span>  
  
## <a name="exposing-threading-problems-during-development"></a><span data-ttu-id="b88ed-117">Создание проблем при работе с потоками во время разработки</span><span class="sxs-lookup"><span data-stu-id="b88ed-117">Exposing Threading Problems During Development</span></span>  
 <span data-ttu-id="b88ed-118">Если потоки могут завершаться сбоем без уведомления и без завершения работы приложения, при программировании могут оставаться незамеченными серьезные ошибки.</span><span class="sxs-lookup"><span data-stu-id="b88ed-118">When threads are allowed to fail silently, without terminating the application, serious programming problems can go undetected.</span></span> <span data-ttu-id="b88ed-119">Это создает серьезную проблему для служб и других приложений, которые выполняются продолжительное время.</span><span class="sxs-lookup"><span data-stu-id="b88ed-119">This is a particular problem for services and other applications which run for extended periods.</span></span> <span data-ttu-id="b88ed-120">В случае сбоя потоков состояние программы постепенно нарушается.</span><span class="sxs-lookup"><span data-stu-id="b88ed-120">As threads fail, program state gradually becomes corrupted.</span></span> <span data-ttu-id="b88ed-121">Производительность приложения может ухудшаться, или приложение может перестать отвечать на запросы.</span><span class="sxs-lookup"><span data-stu-id="b88ed-121">Application performance may degrade, or the application might become unresponsive.</span></span>  
  
 <span data-ttu-id="b88ed-122">Предоставление возможности необработанным исключениям продолжать выполняться в потоках, пока операционная система не завершит программу, создает проблемы во время разработки и тестирования.</span><span class="sxs-lookup"><span data-stu-id="b88ed-122">Allowing unhandled exceptions in threads to proceed naturally, until the operating system terminates the program, exposes such problems during development and testing.</span></span> <span data-ttu-id="b88ed-123">Отчеты об ошибках при завершении программы поддерживают процесс отладки.</span><span class="sxs-lookup"><span data-stu-id="b88ed-123">Error reports on program terminations support debugging.</span></span>  
  
<a name="ChangeFromPreviousVersions"></a>
## <a name="change-from-previous-versions"></a><span data-ttu-id="b88ed-124">Отличия от предыдущих версий</span><span class="sxs-lookup"><span data-stu-id="b88ed-124">Change from Previous Versions</span></span>  
 <span data-ttu-id="b88ed-125">Наиболее существенное изменение связано с управляемыми потоками.</span><span class="sxs-lookup"><span data-stu-id="b88ed-125">The most significant change pertains to managed threads.</span></span> <span data-ttu-id="b88ed-126">В .NET Framework версий 1.0 и 1.1 среда CLR обеспечивает поддержку для необработанных исключений в следующих ситуациях.</span><span class="sxs-lookup"><span data-stu-id="b88ed-126">In the .NET Framework versions 1.0 and 1.1, the common language runtime provides a backstop for unhandled exceptions in the following situations:</span></span>  
  
- <span data-ttu-id="b88ed-127">В потоке пула потоков необработанные исключения больше не могут существовать.</span><span class="sxs-lookup"><span data-stu-id="b88ed-127">There is no such thing as an unhandled exception on a thread pool thread.</span></span> <span data-ttu-id="b88ed-128">Если задача создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли, а затем возвращает поток в пул потоков.</span><span class="sxs-lookup"><span data-stu-id="b88ed-128">When a task throws an exception that it does not handle, the runtime prints the exception stack trace to the console and then returns the thread to the thread pool.</span></span>  
  
- <span data-ttu-id="b88ed-129">В потоке, созданном методом <xref:System.Threading.Thread.Start%2A> класса <xref:System.Threading.Thread>, необработанные исключения не могут существовать.</span><span class="sxs-lookup"><span data-stu-id="b88ed-129">There is no such thing as an unhandled exception on a thread created with the <xref:System.Threading.Thread.Start%2A> method of the <xref:System.Threading.Thread> class.</span></span> <span data-ttu-id="b88ed-130">Если код, выполняемый в таком потоке, создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли и корректно завершает поток.</span><span class="sxs-lookup"><span data-stu-id="b88ed-130">When code running on such a thread throws an exception that it does not handle, the runtime prints the exception stack trace to the console and then gracefully terminates the thread.</span></span>  
  
- <span data-ttu-id="b88ed-131">В потоке метода завершения необработанные исключения больше не могут существовать.</span><span class="sxs-lookup"><span data-stu-id="b88ed-131">There is no such thing as an unhandled exception on the finalizer thread.</span></span> <span data-ttu-id="b88ed-132">Если метод завершения создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли и позволяет потоку метода завершения продолжить выполнение работающих методов завершения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-132">When a finalizer throws an exception that it does not handle, the runtime prints the exception stack trace to the console and then allows the finalizer thread to resume running finalizers.</span></span>  
  
 <span data-ttu-id="b88ed-133">Основное или фоновое состояние управляемого потока не влияет на такое поведение.</span><span class="sxs-lookup"><span data-stu-id="b88ed-133">The foreground or background status of a managed thread does not affect this behavior.</span></span>  
  
 <span data-ttu-id="b88ed-134">Для необработанных исключений в потоках, происходящих в неуправляемом коде, существует не такая заметная разница.</span><span class="sxs-lookup"><span data-stu-id="b88ed-134">For unhandled exceptions on threads originating in unmanaged code, the difference is more subtle.</span></span> <span data-ttu-id="b88ed-135">Диалог с JIT-присоединением среды выполнения выгружает диалог операционной системы для управляемых или собственных исключений в потоках, которые прошли через машинный код.</span><span class="sxs-lookup"><span data-stu-id="b88ed-135">The runtime JIT-attach dialog preempts the operating system dialog for managed exceptions or native exceptions on threads that have passed through native code.</span></span> <span data-ttu-id="b88ed-136">Процесс завершается во всех случаях.</span><span class="sxs-lookup"><span data-stu-id="b88ed-136">The process terminates in all cases.</span></span>  
  
### <a name="migrating-code"></a><span data-ttu-id="b88ed-137">Перенос кода</span><span class="sxs-lookup"><span data-stu-id="b88ed-137">Migrating Code</span></span>  
 <span data-ttu-id="b88ed-138">В общем случае изменение позволит выявлять проблемы при программировании, которые ранее обнаруживать не удавалось, для их последующего устранения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-138">In general, the change will expose previously unrecognized programming problems so that they can be fixed.</span></span> <span data-ttu-id="b88ed-139">Однако в некоторых случаях программисты могут использовать возможность поддержки среды выполнения, например для завершения потоков.</span><span class="sxs-lookup"><span data-stu-id="b88ed-139">In some cases, however, programmers might have taken advantage of the runtime backstop, for example to terminate threads.</span></span> <span data-ttu-id="b88ed-140">В зависимости от ситуации они должны использовать одну из следующих стратегий миграции.</span><span class="sxs-lookup"><span data-stu-id="b88ed-140">Depending on the situation, they should consider one of the following migration strategies:</span></span>  
  
- <span data-ttu-id="b88ed-141">Реструктурируйте код, чтобы при получении сигнала поток корректно выполнял выход.</span><span class="sxs-lookup"><span data-stu-id="b88ed-141">Restructure the code so the thread exits gracefully when a signal is received.</span></span>  
  
- <span data-ttu-id="b88ed-142">Использование метода <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> для отмены потока.</span><span class="sxs-lookup"><span data-stu-id="b88ed-142">Use the <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> method to abort the thread.</span></span>  
  
- <span data-ttu-id="b88ed-143">Если поток необходимо остановить, чтобы было можно продолжить завершение процесса, сделайте поток фоновым, чтобы он автоматически завершался при выходе процесса.</span><span class="sxs-lookup"><span data-stu-id="b88ed-143">If a thread must be stopped so that process termination can proceed, make the thread a background thread so that it is automatically terminated on process exit.</span></span>  
  
 <span data-ttu-id="b88ed-144">Во всех случаях стратегия должна соответствовать правилам разработки исключений.</span><span class="sxs-lookup"><span data-stu-id="b88ed-144">In all cases, the strategy should follow the design guidelines for exceptions.</span></span> <span data-ttu-id="b88ed-145">См. раздел [Правила разработки исключений](../design-guidelines/exceptions.md).</span><span class="sxs-lookup"><span data-stu-id="b88ed-145">See [Design Guidelines for Exceptions](../design-guidelines/exceptions.md).</span></span>  
  
### <a name="application-compatibility-flag"></a><span data-ttu-id="b88ed-146">Флаг совместимости приложений</span><span class="sxs-lookup"><span data-stu-id="b88ed-146">Application Compatibility Flag</span></span>  
 <span data-ttu-id="b88ed-147">В качестве временной меры обеспечения совместимости администраторы могут поместить флаг совместимости в раздел `<runtime>` файла конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="b88ed-147">As a temporary compatibility measure, administrators can place a compatibility flag in the `<runtime>` section of the application configuration file.</span></span> <span data-ttu-id="b88ed-148">Это приведет к возврату среды CLR к поведению версий 1.0 и 1.1.</span><span class="sxs-lookup"><span data-stu-id="b88ed-148">This causes the common language runtime to revert to the behavior of versions 1.0 and 1.1.</span></span>  
  
```xml  
<legacyUnhandledExceptionPolicy enabled="1"/>  
```  
  
## <a name="host-override"></a><span data-ttu-id="b88ed-149">Переопределение узла</span><span class="sxs-lookup"><span data-stu-id="b88ed-149">Host Override</span></span>  
 <span data-ttu-id="b88ed-150">В платформе .NET Framework версии 2.0 неуправляемый узел может использовать интерфейс [ICLRPolicyManager](../../framework/unmanaged-api/hosting/iclrpolicymanager-interface.md) в API размещения для переопределения политики необработанных исключений по умолчанию среды CLR.</span><span class="sxs-lookup"><span data-stu-id="b88ed-150">In the .NET Framework version 2.0, an unmanaged host can use the [ICLRPolicyManager](../../framework/unmanaged-api/hosting/iclrpolicymanager-interface.md) interface in the Hosting API to override the default unhandled exception policy of the common language runtime.</span></span> <span data-ttu-id="b88ed-151">Чтобы задать политику для необработанных исключений, используется функция [ICLRPolicyManager::SetUnhandledExceptionPolicy](../../framework/unmanaged-api/hosting/iclrpolicymanager-setunhandledexceptionpolicy-method.md).</span><span class="sxs-lookup"><span data-stu-id="b88ed-151">The [ICLRPolicyManager::SetUnhandledExceptionPolicy](../../framework/unmanaged-api/hosting/iclrpolicymanager-setunhandledexceptionpolicy-method.md) function is used to set the policy for unhandled exceptions.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b88ed-152">См. также</span><span class="sxs-lookup"><span data-stu-id="b88ed-152">See also</span></span>

- [<span data-ttu-id="b88ed-153">Основы управляемых потоков</span><span class="sxs-lookup"><span data-stu-id="b88ed-153">Managed Threading Basics</span></span>](managed-threading-basics.md)
