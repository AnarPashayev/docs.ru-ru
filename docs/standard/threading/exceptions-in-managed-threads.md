---
title: Исключения в управляемых потоках
ms.date: 03/30/2017
ms.technology: dotnet-standard
helpviewer_keywords:
- unhandled exceptions,in managed threads
- threading [.NET Framework],unhandled exceptions
- threading [.NET Framework],exceptions in managed threads
- managed threading
ms.assetid: 11294769-2e89-43cb-890e-ad4ad79cfbee
author: rpetrusha
ms.author: ronpet
ms.openlocfilehash: 43037f897dfb591572a62a9bb3cccf9170d1f5fe
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64645011"
---
# <a name="exceptions-in-managed-threads"></a>Исключения в управляемых потоках
Начиная с .NET Framework версии 2.0, среда CLR позволяет большинству необработанных исключений выполняться в потоках. Как правило, это означает, что необработанное исключение будет вызывать завершение работы приложения.  
  
> [!NOTE]
>  Это значительное изменение по сравнению с .NET Framework 1.0 и 1.1, в которых поддерживались многие необработанные исключения, например необработанные исключения в потоках из пула потоков. См. [Отличия от предыдущих версий](#ChangeFromPreviousVersions) ниже в этом разделе.  
  
 Среда CLR предоставляет поддержку для определенных необработанных исключений, которые используются для управления потоком выполнения программы:  
  
- В потоке создается исключение <xref:System.Threading.ThreadAbortException> из-за вызова <xref:System.Threading.Thread.Abort%2A>.  
  
- В потоке создается исключение <xref:System.AppDomainUnloadedException> из-за того, что в данный момент выгружается домен приложения, в котором выполняется поток.  
  
- Среда CLR или ведущий процесс прерывает выполнение потока путем создания внутреннего исключения.  
  
 Если любые из этих исключений не обрабатываются в потоках, созданных в среде CLR, исключение завершает поток, однако среда CLR не позволяет исключению выполнять какие-либо дополнительные действия.  
  
 Если эти исключения не обрабатываются в главном потоке или в потоках, которые перешли в среду выполнения из неуправляемого кода, они продолжают выполнение, что приводит к завершению работы приложения.  
  
> [!NOTE]
>  Среда выполнения может создать необработанное исключение до того, как любой управляемый код сможет установить обработчик исключения. Даже если управляемый код не в состоянии обработать такое исключение, исключение может продолжать выполняться.  
  
## <a name="exposing-threading-problems-during-development"></a>Создание проблем при работе с потоками во время разработки  
 Если потоки могут завершаться сбоем без уведомления и без завершения работы приложения, при программировании могут оставаться незамеченными серьезные ошибки. Это создает серьезную проблему для служб и других приложений, которые выполняются продолжительное время. В случае сбоя потоков состояние программы постепенно нарушается. Производительность приложения может ухудшаться, или приложение может перестать отвечать на запросы.  
  
 Предоставление возможности необработанным исключениям продолжать выполняться в потоках, пока операционная система не завершит программу, создает проблемы во время разработки и тестирования. Отчеты об ошибках при завершении программы поддерживают процесс отладки.  
  
<a name="ChangeFromPreviousVersions"></a>   
## <a name="change-from-previous-versions"></a>Отличия от предыдущих версий  
 Наиболее существенное изменение связано с управляемыми потоками. В .NET Framework версий 1.0 и 1.1 среда CLR обеспечивает поддержку для необработанных исключений в следующих ситуациях.  
  
- В потоке пула потоков необработанные исключения больше не могут существовать. Если задача создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли, а затем возвращает поток в пул потоков.  
  
- В потоке, созданном методом <xref:System.Threading.Thread.Start%2A> класса <xref:System.Threading.Thread>, необработанные исключения не могут существовать. Если код, выполняемый в таком потоке, создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли и корректно завершает поток.  
  
- В потоке метода завершения необработанные исключения больше не могут существовать. Если метод завершения создает исключение, которое остается необработанным, среда выполнения отображает трассировку стека исключений на консоли и позволяет потоку метода завершения продолжить выполнение работающих методов завершения.  
  
 Основное или фоновое состояние управляемого потока не влияет на такое поведение.  
  
 Для необработанных исключений в потоках, происходящих в неуправляемом коде, существует не такая заметная разница. Диалог с JIT-присоединением среды выполнения выгружает диалог операционной системы для управляемых или собственных исключений в потоках, которые прошли через машинный код. Процесс завершается во всех случаях.  
  
### <a name="migrating-code"></a>Перенос кода  
 В общем случае изменение позволит выявлять проблемы при программировании, которые ранее обнаруживать не удавалось, для их последующего устранения. Однако в некоторых случаях программисты могут использовать возможность поддержки среды выполнения, например для завершения потоков. В зависимости от ситуации они должны использовать одну из следующих стратегий миграции.  
  
- Реструктурируйте код, чтобы при получении сигнала поток корректно выполнял выход.  
  
- Использование метода <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> для отмены потока.  
  
- Если поток необходимо остановить, чтобы было можно продолжить завершение процесса, сделайте поток фоновым, чтобы он автоматически завершался при выходе процесса.  
  
 Во всех случаях стратегия должна соответствовать правилам разработки исключений. См. раздел [Правила разработки исключений](../../../docs/standard/design-guidelines/exceptions.md).  
  
### <a name="application-compatibility-flag"></a>Флаг совместимости приложений  
 В качестве временной меры обеспечения совместимости администраторы могут поместить флаг совместимости в раздел `<runtime>` файла конфигурации приложения. Это приведет к возврату среды CLR к поведению версий 1.0 и 1.1.  
  
```xml  
<legacyUnhandledExceptionPolicy enabled="1"/>  
```  
  
## <a name="host-override"></a>Переопределение узла  
 В платформе .NET Framework версии 2.0 неуправляемый узел может использовать интерфейс [ICLRPolicyManager](../../../docs/framework/unmanaged-api/hosting/iclrpolicymanager-interface.md) в API размещения для переопределения политики необработанных исключений по умолчанию среды CLR. Чтобы задать политику для необработанных исключений, используется функция [ICLRPolicyManager::SetUnhandledExceptionPolicy](../../../docs/framework/unmanaged-api/hosting/iclrpolicymanager-setunhandledexceptionpolicy-method.md).  
  
## <a name="see-also"></a>См. также

- [Основы управляемых потоков](../../../docs/standard/threading/managed-threading-basics.md)
