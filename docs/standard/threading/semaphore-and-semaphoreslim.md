---
title: Классы Semaphore и SemaphoreSlim
ms.date: 03/30/2017
ms.technology: dotnet-standard
helpviewer_keywords:
- counting semaphores
- semaphores
- threading [.NET Framework], cross-process synchronization
- Semaphore class, about Semaphore class
- SemaphoreSlim class, about SemaphoreSlim class
- threading [.NET Framework], Semaphore class
ms.assetid: 7722a333-b974-47a2-a7c0-f09097fb644e
ms.openlocfilehash: 9a18a6517548bb402e1e3b9ac02e95aae32a8f4a
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/02/2020
ms.locfileid: "84291140"
---
# <a name="semaphore-and-semaphoreslim"></a><span data-ttu-id="41ff3-102">Классы Semaphore и SemaphoreSlim</span><span class="sxs-lookup"><span data-stu-id="41ff3-102">Semaphore and SemaphoreSlim</span></span>
<span data-ttu-id="41ff3-103"><xref:System.Threading.Semaphore?displayProperty=nameWithType> Класс представляет собой именованный (общесистемный) или локальный семафор.</span><span class="sxs-lookup"><span data-stu-id="41ff3-103">The <xref:System.Threading.Semaphore?displayProperty=nameWithType> class represents a named (systemwide) or local semaphore.</span></span> <span data-ttu-id="41ff3-104">Он является тонкой оболочкой вокруг объекта семафора Win32.</span><span class="sxs-lookup"><span data-stu-id="41ff3-104">It is a thin wrapper around the Win32 semaphore object.</span></span> <span data-ttu-id="41ff3-105">Семафоры Win32 являются семафорами счета, которые могут быть использованы для управления доступом к пулу ресурсов.</span><span class="sxs-lookup"><span data-stu-id="41ff3-105">Win32 semaphores are counting semaphores, which can be used to control access to a pool of resources.</span></span>  
  
 <span data-ttu-id="41ff3-106"><xref:System.Threading.SemaphoreSlim> Класс представляет упрощенный, быстрый семафор, который можно использовать для ожидания внутри одного процесса, когда предполагается, что времена ожидания будут очень короткими.</span><span class="sxs-lookup"><span data-stu-id="41ff3-106">The <xref:System.Threading.SemaphoreSlim> class represents a lightweight, fast semaphore that can be used for waiting within a single process when wait times are expected to be very short.</span></span> <span data-ttu-id="41ff3-107"><xref:System.Threading.SemaphoreSlim>использует максимально примитивы синхронизации, предоставляемые общеязыковой среды выполнения (CLR).</span><span class="sxs-lookup"><span data-stu-id="41ff3-107"><xref:System.Threading.SemaphoreSlim> relies as much as possible on synchronization primitives provided by the common language runtime (CLR).</span></span> <span data-ttu-id="41ff3-108">Тем не менее, он также предоставляет неактивно инициализированные дескрипторы ожидания на основе ядра при необходимости поддержки ожидания для нескольких семафоров.</span><span class="sxs-lookup"><span data-stu-id="41ff3-108">However, it also provides lazily initialized, kernel-based wait handles as necessary to support waiting on multiple semaphores.</span></span> <span data-ttu-id="41ff3-109"><xref:System.Threading.SemaphoreSlim>также поддерживает использование токенов отмены, но не поддерживает именованные семафоры или использование дескриптора ожидания для синхронизации.</span><span class="sxs-lookup"><span data-stu-id="41ff3-109"><xref:System.Threading.SemaphoreSlim> also supports the use of cancellation tokens, but it does not support named semaphores or the use of a wait handle for synchronization.</span></span>  
  
## <a name="managing-a-limited-resource"></a><span data-ttu-id="41ff3-110">Управление ограниченным ресурсом</span><span class="sxs-lookup"><span data-stu-id="41ff3-110">Managing a Limited Resource</span></span>  
 <span data-ttu-id="41ff3-111">Потоки входят в семафор посредством вызова метода <xref:System.Threading.WaitHandle.WaitOne%2A>, который наследуется от класса <xref:System.Threading.WaitHandle>, в случае объекта <xref:System.Threading.Semaphore?displayProperty=nameWithType> либо метода <xref:System.Threading.SemaphoreSlim.Wait%2A?displayProperty=nameWithType> или <xref:System.Threading.SemaphoreSlim.WaitAsync%2A?displayProperty=nameWithType> в случае объекта <xref:System.Threading.SemaphoreSlim>.</span><span class="sxs-lookup"><span data-stu-id="41ff3-111">Threads enter the semaphore by calling the <xref:System.Threading.WaitHandle.WaitOne%2A> method, which is inherited from the <xref:System.Threading.WaitHandle> class, in the case of a <xref:System.Threading.Semaphore?displayProperty=nameWithType> object, or the <xref:System.Threading.SemaphoreSlim.Wait%2A?displayProperty=nameWithType> or <xref:System.Threading.SemaphoreSlim.WaitAsync%2A?displayProperty=nameWithType> method, in the case of a <xref:System.Threading.SemaphoreSlim> object.</span></span> <span data-ttu-id="41ff3-112">По возвращении вызова счетчик на семафоре уменьшается на единицу.</span><span class="sxs-lookup"><span data-stu-id="41ff3-112">When the call returns, the count on the semaphore is decremented.</span></span> <span data-ttu-id="41ff3-113">При запросе потоком записи счетчик равен нулю, поток блокируется.</span><span class="sxs-lookup"><span data-stu-id="41ff3-113">When a thread requests entry and the count is zero, the thread blocks.</span></span> <span data-ttu-id="41ff3-114">Потоки освобождают семафор посредством вызова метода <xref:System.Threading.Semaphore.Release%2A?displayProperty=nameWithType> или <xref:System.Threading.SemaphoreSlim.Release%2A?displayProperty=nameWithType>, заблокированные потоки разрешено вводить.</span><span class="sxs-lookup"><span data-stu-id="41ff3-114">As threads release the semaphore by calling the <xref:System.Threading.Semaphore.Release%2A?displayProperty=nameWithType> or <xref:System.Threading.SemaphoreSlim.Release%2A?displayProperty=nameWithType> method, blocked threads are allowed to enter.</span></span> <span data-ttu-id="41ff3-115">Для входа блокированных потоков в семафор нет гарантированного порядка, например first-in, first-out (FIFO) или последним поступил — первым обслужен (LIFO).</span><span class="sxs-lookup"><span data-stu-id="41ff3-115">There is no guaranteed order, such as first-in, first-out (FIFO) or last-in, first-out (LIFO), for blocked threads to enter the semaphore.</span></span>  
  
 <span data-ttu-id="41ff3-116">Поток может войти в семафор несколько раз, многократно вызывая метод <xref:System.Threading.Semaphore?displayProperty=nameWithType> объекта <xref:System.Threading.WaitHandle.WaitOne%2A> или метод  <xref:System.Threading.SemaphoreSlim> объекта<xref:System.Threading.SemaphoreSlim.Wait%2A>.</span><span class="sxs-lookup"><span data-stu-id="41ff3-116">A thread can enter the semaphore multiple times by calling the <xref:System.Threading.Semaphore?displayProperty=nameWithType> object's <xref:System.Threading.WaitHandle.WaitOne%2A> method or the  <xref:System.Threading.SemaphoreSlim> object's <xref:System.Threading.SemaphoreSlim.Wait%2A> method repeatedly.</span></span> <span data-ttu-id="41ff3-117">Чтобы освободить семафор, поток может либо вызвать метод перегрузки <xref:System.Threading.Semaphore.Release?displayProperty=nameWithType> или <xref:System.Threading.SemaphoreSlim.Release?displayProperty=nameWithType> одинаковое количество раз, либо вызвать метод перегрузки <xref:System.Threading.Semaphore.Release%28System.Int32%29?displayProperty=nameWithType> или <xref:System.Threading.SemaphoreSlim.Release%28System.Int32%29?displayProperty=nameWithType> и указать количество освобождаемых записей.</span><span class="sxs-lookup"><span data-stu-id="41ff3-117">To release the semaphore, the thread can either call the <xref:System.Threading.Semaphore.Release?displayProperty=nameWithType> or <xref:System.Threading.SemaphoreSlim.Release?displayProperty=nameWithType> method overload the same number of times, or call the <xref:System.Threading.Semaphore.Release%28System.Int32%29?displayProperty=nameWithType> or <xref:System.Threading.SemaphoreSlim.Release%28System.Int32%29?displayProperty=nameWithType> method overload and specify the number of entries to be released.</span></span>  
  
### <a name="semaphores-and-thread-identity"></a><span data-ttu-id="41ff3-118">Семафоры и идентификация потоков</span><span class="sxs-lookup"><span data-stu-id="41ff3-118">Semaphores and Thread Identity</span></span>  
 <span data-ttu-id="41ff3-119">Типы два семафора не обеспечивают идентификацию потоков по вызовам методов <xref:System.Threading.WaitHandle.WaitOne%2A>, <xref:System.Threading.SemaphoreSlim.Wait%2A>, <xref:System.Threading.Semaphore.Release%2A> и <xref:System.Threading.SemaphoreSlim.Release%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="41ff3-119">The two semaphore types do not enforce thread identity on calls to the <xref:System.Threading.WaitHandle.WaitOne%2A>, <xref:System.Threading.SemaphoreSlim.Wait%2A>, <xref:System.Threading.Semaphore.Release%2A>, and <xref:System.Threading.SemaphoreSlim.Release%2A?displayProperty=nameWithType> methods.</span></span> <span data-ttu-id="41ff3-120">Например, обычным сценарием использования семафора является наличие потока производителя и потока получателя. При этом один поток всегда увеличивает счетчик семафора, а другой всегда уменьшает его.</span><span class="sxs-lookup"><span data-stu-id="41ff3-120">For example, a common usage scenario for semaphores involves a producer thread and a consumer thread, with one thread always incrementing the semaphore count and the other always decrementing it.</span></span>  
  
 <span data-ttu-id="41ff3-121">Программист должен обеспечить, чтобы поток не освобождал семафор слишком много раз.</span><span class="sxs-lookup"><span data-stu-id="41ff3-121">It is the programmer's responsibility to ensure that a thread does not release the semaphore too many times.</span></span> <span data-ttu-id="41ff3-122">Например предположим, что семафор имеет максимальное значение счетчика равное двум, а два потока A и B входят в семафор.</span><span class="sxs-lookup"><span data-stu-id="41ff3-122">For example, suppose a semaphore has a maximum count of two, and that thread A and thread B both enter the semaphore.</span></span> <span data-ttu-id="41ff3-123">Если ошибка программирования в потоке B заставляет его вызывать метод `Release` дважды, оба вызова оканчиваются успешно.</span><span class="sxs-lookup"><span data-stu-id="41ff3-123">If a programming error in thread B causes it to call  `Release` twice, both calls succeed.</span></span> <span data-ttu-id="41ff3-124">Счетчик на семафоре переполнен, и если поток A вызывает `Release`, <xref:System.Threading.SemaphoreFullException> создается исключение.</span><span class="sxs-lookup"><span data-stu-id="41ff3-124">The count on the semaphore is full, and when thread A eventually calls `Release`, a <xref:System.Threading.SemaphoreFullException> is thrown.</span></span>  
  
## <a name="named-semaphores"></a><span data-ttu-id="41ff3-125">Именованные семафоры</span><span class="sxs-lookup"><span data-stu-id="41ff3-125">Named Semaphores</span></span>  
 <span data-ttu-id="41ff3-126">Операционная система Windows позволяет присваивать семафорам имена.</span><span class="sxs-lookup"><span data-stu-id="41ff3-126">The Windows operating system allows semaphores to have names.</span></span> <span data-ttu-id="41ff3-127">Именованный семафор относится ко всей системе.</span><span class="sxs-lookup"><span data-stu-id="41ff3-127">A named semaphore is system wide.</span></span> <span data-ttu-id="41ff3-128">То есть после создания именованный семафор становится видимым для всех потоков во всех процессах.</span><span class="sxs-lookup"><span data-stu-id="41ff3-128">That is, once the named semaphore is created, it is visible to all threads in all processes.</span></span> <span data-ttu-id="41ff3-129">Таким образом именованный семафор может использоваться для синхронизации действий процессов, а также потоков.</span><span class="sxs-lookup"><span data-stu-id="41ff3-129">Thus, named semaphore can be used to synchronize the activities of processes as well as threads.</span></span>  
  
 <span data-ttu-id="41ff3-130">Можно создать <xref:System.Threading.Semaphore> объект, который представляет именованный системный семафор с помощью одного из конструкторов, указывающих имя.</span><span class="sxs-lookup"><span data-stu-id="41ff3-130">You can create a <xref:System.Threading.Semaphore> object that represents a named system semaphore by using one of the constructors that specifies a name.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="41ff3-131">Так как именованные семафоры относятся ко всей системе, можно иметь несколько объектов <xref:System.Threading.Semaphore>, представляющих один и тот же именованный семафор.</span><span class="sxs-lookup"><span data-stu-id="41ff3-131">Because named semaphores are system wide, it is possible to have multiple <xref:System.Threading.Semaphore> objects that represent the same named semaphore.</span></span> <span data-ttu-id="41ff3-132">При каждом вызове конструктора или метода <xref:System.Threading.Semaphore.OpenExisting%2A?displayProperty=nameWithType> создается новый объект <xref:System.Threading.Semaphore>.</span><span class="sxs-lookup"><span data-stu-id="41ff3-132">Each time you call a constructor or the <xref:System.Threading.Semaphore.OpenExisting%2A?displayProperty=nameWithType> method, a new <xref:System.Threading.Semaphore> object is created.</span></span> <span data-ttu-id="41ff3-133">Если указать одно и то же имя несколько раз, создается несколько объектов, представляющих один и тот же именованный семафор.</span><span class="sxs-lookup"><span data-stu-id="41ff3-133">Specifying the same name repeatedly creates multiple objects that represent the same named semaphore.</span></span>  
  
 <span data-ttu-id="41ff3-134">Будьте осторожны при использовании именованных семафоров.</span><span class="sxs-lookup"><span data-stu-id="41ff3-134">Be careful when you use named semaphores.</span></span> <span data-ttu-id="41ff3-135">Так как они относятся ко всей системе, другой процесс, использующий то же имя, может неожиданно войти в семафор.</span><span class="sxs-lookup"><span data-stu-id="41ff3-135">Because they are system wide, another process that uses the same name can enter your semaphore unexpectedly.</span></span> <span data-ttu-id="41ff3-136">Вредоносный код, выполняемый на одном компьютере может использовать это как основу для атак типа "отказ в обслуживании".</span><span class="sxs-lookup"><span data-stu-id="41ff3-136">Malicious code executing on the same computer could use this as the basis of a denial-of-service attack.</span></span>  
  
 <span data-ttu-id="41ff3-137">Используйте безопасность управления доступом для защиты объекта <xref:System.Threading.Semaphore>, представляющего именованный семафор, предпочтительнее с помощью конструктора, который определяет объект <xref:System.Security.AccessControl.SemaphoreSecurity?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="41ff3-137">Use access control security to protect a <xref:System.Threading.Semaphore> object that represents a named semaphore, preferably by using a constructor that specifies a <xref:System.Security.AccessControl.SemaphoreSecurity?displayProperty=nameWithType> object.</span></span> <span data-ttu-id="41ff3-138">Также можно применить безопасность управления доступом с помощью метода <xref:System.Threading.Semaphore.SetAccessControl%2A?displayProperty=nameWithType>, однако это оставит брешь в защите между временем создания семафора и временем, когда он будет защищен.</span><span class="sxs-lookup"><span data-stu-id="41ff3-138">You can also apply access control security using the <xref:System.Threading.Semaphore.SetAccessControl%2A?displayProperty=nameWithType> method, but this leaves a window of vulnerability between the time the semaphore is created and the time it is protected.</span></span> <span data-ttu-id="41ff3-139">Защита семафоров с помощью безопасности управления доступом способствует предотвращению атак злоумышленников, но не решает проблемы непреднамеренного конфликта имен.</span><span class="sxs-lookup"><span data-stu-id="41ff3-139">Protecting semaphores with access control security helps prevent malicious attacks, but does not solve the problem of unintentional name collisions.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="41ff3-140">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="41ff3-140">See also</span></span>

- <xref:System.Threading.Semaphore>
- <xref:System.Threading.SemaphoreSlim>
- [<span data-ttu-id="41ff3-141">Объекты и функциональные возможности работы с потоками</span><span class="sxs-lookup"><span data-stu-id="41ff3-141">Threading Objects and Features</span></span>](threading-objects-and-features.md)
