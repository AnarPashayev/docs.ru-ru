---
title: Пул управляемых потоков
description: Сведения о пуле потоков .NET, обеспечивающем фоновые потоки рабочих процессов
ms.date: 08/02/2018
ms.technology: dotnet-standard
helpviewer_keywords:
- thread pooling [.NET]
- thread pools [.NET]
- threading [.NET], thread pool
- threading [.NET], pooling
ms.assetid: 2be05b06-a42e-4c9d-a739-96c21d673927
ms.openlocfilehash: 2671ce7c9721b15de8a3805da27040e973a62804
ms.sourcegitcommit: 67ebdb695fd017d79d9f1f7f35d145042d5a37f7
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/20/2020
ms.locfileid: "92223793"
---
# <a name="the-managed-thread-pool"></a><span data-ttu-id="160bd-103">Пул управляемых потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-103">The managed thread pool</span></span>

<span data-ttu-id="160bd-104">Класс <xref:System.Threading.ThreadPool?displayProperty=nameWithType> обеспечивает приложение пулом рабочих потоков, управляемых системой, позволяя пользователю сосредоточиться на выполнении задач приложения, а не на управлении потоками.</span><span class="sxs-lookup"><span data-stu-id="160bd-104">The <xref:System.Threading.ThreadPool?displayProperty=nameWithType> class provides your application with a pool of worker threads that are managed by the system, allowing you to concentrate on application tasks rather than thread management.</span></span> <span data-ttu-id="160bd-105">Если имеются небольшие задачи, которые требуют фоновой обработки, пул управляемых потоков — это самый простой способ воспользоваться преимуществами нескольких потоков.</span><span class="sxs-lookup"><span data-stu-id="160bd-105">If you have short tasks that require background processing, the managed thread pool is an easy way to take advantage of multiple threads.</span></span> <span data-ttu-id="160bd-106">В Framework 4 и более поздних версиях использовать пул потоков стало значительно проще, так как вы можете создавать объекты <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601>, которые выполняют в потоках пула асинхронные задачи.</span><span class="sxs-lookup"><span data-stu-id="160bd-106">Use of the thread pool is significantly easier in Framework 4 and later, since you can create <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> objects that perform asynchronous tasks on thread pool threads.</span></span>  
  
<span data-ttu-id="160bd-107">Платформа .NET использует потоки из пула в различных целях, в том числе для операций [библиотеки параллельных задач (TPL)](../parallel-programming/task-parallel-library-tpl.md), асинхронного ввода-вывода, обратных вызовов [таймера](timers.md), регистрируемых операций ожидания, асинхронного вызова методов с использованием делегатов и для подключения к сокетам <xref:System.Net?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-107">.NET uses thread pool threads for many purposes, including [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md) operations, asynchronous I/O completion, [timer](timers.md) callbacks, registered wait operations, asynchronous method calls using delegates, and <xref:System.Net?displayProperty=nameWithType> socket connections.</span></span>  

## <a name="thread-pool-characteristics"></a><span data-ttu-id="160bd-108">Характеристики пула потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-108">Thread pool characteristics</span></span>

<span data-ttu-id="160bd-109">Потоки из пула являются [фоновыми](foreground-and-background-threads.md).</span><span class="sxs-lookup"><span data-stu-id="160bd-109">Thread pool threads are [background](foreground-and-background-threads.md) threads.</span></span> <span data-ttu-id="160bd-110">Для каждого потока используется размер стека по умолчанию, поток запускается с приоритетом по умолчанию и находится в многопотоковом подразделении.</span><span class="sxs-lookup"><span data-stu-id="160bd-110">Each thread uses the default stack size, runs at the default priority, and is in the multithreaded apartment.</span></span> <span data-ttu-id="160bd-111">Когда поток в пуле завершает свою задачу, он возвращается в очередь потоков в состоянии ожидания.</span><span class="sxs-lookup"><span data-stu-id="160bd-111">Once a thread in the thread pool completes its task, it's returned to a queue of waiting threads.</span></span> <span data-ttu-id="160bd-112">С этого момента его можно использовать вновь.</span><span class="sxs-lookup"><span data-stu-id="160bd-112">From this moment it can be reused.</span></span> <span data-ttu-id="160bd-113">Повторное использование позволяет приложениям избежать дополнительных затрат на создание новых потоков для каждой задачи.</span><span class="sxs-lookup"><span data-stu-id="160bd-113">This reuse enables applications to avoid the cost of creating a new thread for each task.</span></span>
  
<span data-ttu-id="160bd-114">Для каждого процесса существует только один пул потоков.</span><span class="sxs-lookup"><span data-stu-id="160bd-114">There is only one thread pool per process.</span></span>  
  
### <a name="exceptions-in-thread-pool-threads"></a><span data-ttu-id="160bd-115">Исключения в потоках из пула потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-115">Exceptions in thread pool threads</span></span>

<span data-ttu-id="160bd-116">Необработанные исключения в потоках из пула приводят к завершению процесса.</span><span class="sxs-lookup"><span data-stu-id="160bd-116">Unhandled exceptions in thread pool threads terminate the process.</span></span> <span data-ttu-id="160bd-117">Есть три исключения из этого правила:</span><span class="sxs-lookup"><span data-stu-id="160bd-117">There are three exceptions to this rule:</span></span>  
  
- <span data-ttu-id="160bd-118">Исключение <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> возникает в потоке пула вследствие вызова <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-118">A <xref:System.Threading.ThreadAbortException?displayProperty=nameWithType> is thrown in a thread pool thread because <xref:System.Threading.Thread.Abort%2A?displayProperty=nameWithType> was called.</span></span>  
- <span data-ttu-id="160bd-119">Исключение <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> возникает в потоке пула вследствие выгрузки домена приложения.</span><span class="sxs-lookup"><span data-stu-id="160bd-119">A <xref:System.AppDomainUnloadedException?displayProperty=nameWithType> is thrown in a thread pool thread because the application domain is being unloaded.</span></span>  
- <span data-ttu-id="160bd-120">Среда CLR или процесс ведущего приложения прерывает выполнение потока.</span><span class="sxs-lookup"><span data-stu-id="160bd-120">The common language runtime or a host process terminates the thread.</span></span>  
  
<span data-ttu-id="160bd-121">См. дополнительные сведения об [исключениях в управляемых потоках](exceptions-in-managed-threads.md).</span><span class="sxs-lookup"><span data-stu-id="160bd-121">For more information, see [Exceptions in Managed Threads](exceptions-in-managed-threads.md).</span></span>  
  
### <a name="maximum-number-of-thread-pool-threads"></a><span data-ttu-id="160bd-122">Максимальное число потоков в пуле потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-122">Maximum number of thread pool threads</span></span>

<span data-ttu-id="160bd-123">Число операций, которое можно поставить в очередь в пуле потоков, ограничено только доступной памятью.</span><span class="sxs-lookup"><span data-stu-id="160bd-123">The number of operations that can be queued to the thread pool is limited only by available memory.</span></span> <span data-ttu-id="160bd-124">Однако пул потоков имеет ограничение на число потоков, которое можно активировать в процессе одновременно.</span><span class="sxs-lookup"><span data-stu-id="160bd-124">However, the thread pool limits the number of threads that can be active in the process simultaneously.</span></span> <span data-ttu-id="160bd-125">Если все потоки в пуле заняты, дополнительные рабочие элементы помещаются в очередь и ожидают их освобождения.</span><span class="sxs-lookup"><span data-stu-id="160bd-125">If all thread pool threads are busy, additional work items are queued until threads to execute them become available.</span></span> <span data-ttu-id="160bd-126">Начиная с .NET Framework 4, размер пула потоков по умолчанию для какого-либо процесса зависит от нескольких факторов, таких как размер виртуального адресного пространства.</span><span class="sxs-lookup"><span data-stu-id="160bd-126">Beginning with the .NET Framework 4, the default size of the thread pool for a process depends on several factors, such as the size of the virtual address space.</span></span> <span data-ttu-id="160bd-127">Процесс может вызвать метод <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> для определения количества потоков.</span><span class="sxs-lookup"><span data-stu-id="160bd-127">A process can call the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> method to determine the number of threads.</span></span>  
  
<span data-ttu-id="160bd-128">Вы можете управлять максимальным количеством потоков с помощью методов <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> и <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-128">You can control the maximum number of threads by using the <xref:System.Threading.ThreadPool.GetMaxThreads%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.SetMaxThreads%2A?displayProperty=nameWithType> methods.</span></span>  

> [!NOTE]
> <span data-ttu-id="160bd-129">В коде, содержащем среду CLR, этот размер можно задать с помощью метода [`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md).</span><span class="sxs-lookup"><span data-stu-id="160bd-129">Code that hosts the common language runtime can set the size using the [`ICorThreadpool::CorSetMaxThreads`](../../framework/unmanaged-api/hosting/icorthreadpool-corsetmaxthreads-method.md) method.</span></span>  
  
### <a name="thread-pool-minimums"></a><span data-ttu-id="160bd-130">Минимальные значения пула потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-130">Thread pool minimums</span></span>

<span data-ttu-id="160bd-131">Пул потоков предоставляет новые рабочие потоки или потоки завершения ввода-вывода по запросу, пока не будет достигнут заданный минимум для каждой категории.</span><span class="sxs-lookup"><span data-stu-id="160bd-131">The thread pool provides new worker threads or I/O completion threads on demand until it reaches a specified minimum for each category.</span></span> <span data-ttu-id="160bd-132">Для получения этих минимальных значений можно использовать метод <xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-132">You can use the <xref:System.Threading.ThreadPool.GetMinThreads%2A?displayProperty=nameWithType> method to obtain these minimum values.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="160bd-133">Если потребность низкая, фактическое количество потоков из пула потоков может быть ниже минимальных значений.</span><span class="sxs-lookup"><span data-stu-id="160bd-133">When demand is low, the actual number of thread pool threads can fall below the minimum values.</span></span>  
  
<span data-ttu-id="160bd-134">При достижении минимума пул потоков может создавать дополнительные потоки или ожидать завершения некоторых задач.</span><span class="sxs-lookup"><span data-stu-id="160bd-134">When a minimum is reached, the thread pool can create additional threads or wait until some tasks complete.</span></span> <span data-ttu-id="160bd-135">Начиная с .NET Framework 4, пул потоков создает и уничтожает рабочие потоки в целях оптимизации пропускной способности, которая определяется как количество задач, выполняемых в единицу времени.</span><span class="sxs-lookup"><span data-stu-id="160bd-135">Beginning with the .NET Framework 4, the thread pool creates and destroys worker threads in order to optimize throughput, which is defined as the number of tasks that complete per unit of time.</span></span> <span data-ttu-id="160bd-136">Слишком малое количество потоков может препятствовать оптимальному использованию доступных ресурсов, тогда как слишком большое их количество может усиливать конкуренцию за ресурсы.</span><span class="sxs-lookup"><span data-stu-id="160bd-136">Too few threads might not make optimal use of available resources, whereas too many threads could increase resource contention.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="160bd-137">Для увеличения минимального количества бездействующих потоков можно использовать метод <xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-137">You can use the <xref:System.Threading.ThreadPool.SetMinThreads%2A?displayProperty=nameWithType> method to increase the minimum number of idle threads.</span></span> <span data-ttu-id="160bd-138">Однако необоснованное увеличение этих значений может привести к снижению производительности.</span><span class="sxs-lookup"><span data-stu-id="160bd-138">However, unnecessarily increasing these values can cause performance problems.</span></span> <span data-ttu-id="160bd-139">Если одновременно запускается слишком много задач, все они могут выполняться слишком медленно.</span><span class="sxs-lookup"><span data-stu-id="160bd-139">If too many tasks start at the same time, all of them might appear to be slow.</span></span> <span data-ttu-id="160bd-140">В большинстве случаев пул потоков работает наилучшим образом, если он использует собственный алгоритм выделения потоков.</span><span class="sxs-lookup"><span data-stu-id="160bd-140">In most cases the thread pool will perform better with its own algorithm for allocating threads.</span></span>  

## <a name="using-the-thread-pool"></a><span data-ttu-id="160bd-141">Использование пула потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-141">Using the thread pool</span></span>

<span data-ttu-id="160bd-142">Начиная с .NET Framework 4, самым простым способом использования пула потоков является применение [библиотеки параллельных задач (TPL)](../parallel-programming/task-parallel-library-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="160bd-142">Beginning with the .NET Framework 4, the easiest way to use the thread pool is to use the [Task Parallel Library (TPL)](../parallel-programming/task-parallel-library-tpl.md).</span></span> <span data-ttu-id="160bd-143">По умолчанию такие типы TPL, как <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601>, используют потоки из пула для выполнения задач.</span><span class="sxs-lookup"><span data-stu-id="160bd-143">By default, TPL types like <xref:System.Threading.Tasks.Task> and <xref:System.Threading.Tasks.Task%601> use thread pool threads to run tasks.</span></span>

<span data-ttu-id="160bd-144">Пул потоков также можно использовать путем вызова <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> из управляемого кода (или [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md) из неуправляемого кода) и передачи делегата <xref:System.Threading.WaitCallback?displayProperty=nameWithType>, представляющего метод, который выполняет задачу.</span><span class="sxs-lookup"><span data-stu-id="160bd-144">You can also use the thread pool by calling <xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> from managed code (or [`ICorThreadpool::CorQueueUserWorkItem`](../../framework/unmanaged-api/hosting/icorthreadpool-corqueueuserworkitem-method.md) from unmanaged code) and passing a <xref:System.Threading.WaitCallback?displayProperty=nameWithType> delegate representing the method that performs the task.</span></span>

<span data-ttu-id="160bd-145">Другим способом использования пула потоков является помещение в очередь рабочих элементов, которые имеют отношение к операции ожидания, с помощью метода <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> и передача дескриптора <xref:System.Threading.WaitHandle?displayProperty=nameWithType>, который вызывает метод, представленный делегатом <xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType>, при получении сигнала или истечении времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="160bd-145">Another way to use the thread pool is to queue work items that are related to a wait operation by using the <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> method and passing a <xref:System.Threading.WaitHandle?displayProperty=nameWithType> that, when signaled or when timed out, calls the method represented by the <xref:System.Threading.WaitOrTimerCallback?displayProperty=nameWithType> delegate.</span></span> <span data-ttu-id="160bd-146">Потоки из пула потоков используются для вызова методов обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="160bd-146">Thread pool threads are used to invoke callback methods.</span></span>  

<span data-ttu-id="160bd-147">Примеры см. по ссылкам на страницы API.</span><span class="sxs-lookup"><span data-stu-id="160bd-147">For the examples, check the referenced API pages.</span></span>
  
## <a name="skipping-security-checks"></a><span data-ttu-id="160bd-148">Пропуск проверок безопасности</span><span class="sxs-lookup"><span data-stu-id="160bd-148">Skipping security checks</span></span>

<span data-ttu-id="160bd-149">Пул потоков также предоставляет методы <xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> и <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="160bd-149">The thread pool also provides the <xref:System.Threading.ThreadPool.UnsafeQueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.UnsafeRegisterWaitForSingleObject%2A?displayProperty=nameWithType> methods.</span></span> <span data-ttu-id="160bd-150">Используйте эти методы только в том случае, если вы уверены, что стек вызывающего объекта не важен для проверок безопасности, осуществляемых во время выполнения задачи в очереди.</span><span class="sxs-lookup"><span data-stu-id="160bd-150">Use these methods only when you are certain that the caller's stack is irrelevant to any security checks performed during the execution of the queued task.</span></span> <span data-ttu-id="160bd-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> и <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> перехватывают стек вызывающего объекта, который объединяется со стеком потока из пула потоков, когда поток начинает выполнять задачу.</span><span class="sxs-lookup"><span data-stu-id="160bd-151"><xref:System.Threading.ThreadPool.QueueUserWorkItem%2A?displayProperty=nameWithType> and <xref:System.Threading.ThreadPool.RegisterWaitForSingleObject%2A?displayProperty=nameWithType> both capture the caller's stack, which is merged into the stack of the thread pool thread when the thread begins to execute a task.</span></span> <span data-ttu-id="160bd-152">Если требуется проверка безопасности, проверяется весь стек.</span><span class="sxs-lookup"><span data-stu-id="160bd-152">If a security check is required, the entire stack must be checked.</span></span> <span data-ttu-id="160bd-153">Несмотря на обеспечение безопасности, такая проверка также влияет на производительность.</span><span class="sxs-lookup"><span data-stu-id="160bd-153">Although the check provides safety, it also has a performance cost.</span></span>  

## <a name="when-not-to-use-thread-pool-threads"></a><span data-ttu-id="160bd-154">Когда не следует использовать потоки из пула потоков</span><span class="sxs-lookup"><span data-stu-id="160bd-154">When not to use thread pool threads</span></span>

<span data-ttu-id="160bd-155">Существует ряд сценариев, в которых следует создавать собственные потоки и работать с ними, а не использовать потоки из пула:</span><span class="sxs-lookup"><span data-stu-id="160bd-155">There are several scenarios in which it's appropriate to create and manage your own threads instead of using thread pool threads:</span></span>  
  
- <span data-ttu-id="160bd-156">Необходим основной поток.</span><span class="sxs-lookup"><span data-stu-id="160bd-156">You require a foreground thread.</span></span>  
- <span data-ttu-id="160bd-157">Поток должен иметь определенный приоритет.</span><span class="sxs-lookup"><span data-stu-id="160bd-157">You require a thread to have a particular priority.</span></span>  
- <span data-ttu-id="160bd-158">Имеются задачи, которые приводят к блокировке потока на длительное время.</span><span class="sxs-lookup"><span data-stu-id="160bd-158">You have tasks that cause the thread to block for long periods of time.</span></span> <span data-ttu-id="160bd-159">Для пула потоков определено максимальное количество потоков, поэтому большое число заблокированных потоков в пуле может препятствовать запуску задач.</span><span class="sxs-lookup"><span data-stu-id="160bd-159">The thread pool has a maximum number of threads, so a large number of blocked thread pool threads might prevent tasks from starting.</span></span>  
- <span data-ttu-id="160bd-160">Необходимо поместить потоки в однопотоковое подразделение.</span><span class="sxs-lookup"><span data-stu-id="160bd-160">You need to place threads into a single-threaded apartment.</span></span> <span data-ttu-id="160bd-161">Все потоки <xref:System.Threading.ThreadPool> находятся в многопотоковом подразделении.</span><span class="sxs-lookup"><span data-stu-id="160bd-161">All <xref:System.Threading.ThreadPool> threads are in the multithreaded apartment.</span></span>  
- <span data-ttu-id="160bd-162">Необходимо иметь постоянное удостоверение, сопоставленное с потоком, или назначить поток задаче.</span><span class="sxs-lookup"><span data-stu-id="160bd-162">You need to have a stable identity associated with the thread, or to dedicate a thread to a task.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="160bd-163">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="160bd-163">See also</span></span>

- <xref:System.Threading.ThreadPool?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task?displayProperty=nameWithType>
- <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType>
- [<span data-ttu-id="160bd-164">Библиотека параллельных задач (TPL)</span><span class="sxs-lookup"><span data-stu-id="160bd-164">Task Parallel Library (TPL)</span></span>](../parallel-programming/task-parallel-library-tpl.md)
- [<span data-ttu-id="160bd-165">Практическое руководство. Возвращение значения из задачи</span><span class="sxs-lookup"><span data-stu-id="160bd-165">How to: Return a Value from a Task</span></span>](../parallel-programming/how-to-return-a-value-from-a-task.md)
- [<span data-ttu-id="160bd-166">Объекты и функциональные возможности работы с потоками</span><span class="sxs-lookup"><span data-stu-id="160bd-166">Threading Objects and Features</span></span>](threading-objects-and-features.md)
- [<span data-ttu-id="160bd-167">Потоки и работа с потоками</span><span class="sxs-lookup"><span data-stu-id="160bd-167">Threads and Threading</span></span>](threads-and-threading.md)
- [<span data-ttu-id="160bd-168">Asynchronous File I/O</span><span class="sxs-lookup"><span data-stu-id="160bd-168">Asynchronous File I/O</span></span>](../io/asynchronous-file-i-o.md)
- [<span data-ttu-id="160bd-169">Таймеры</span><span class="sxs-lookup"><span data-stu-id="160bd-169">Timers</span></span>](timers.md)
