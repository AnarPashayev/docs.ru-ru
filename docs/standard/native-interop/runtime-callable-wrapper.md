---
title: Вызываемая оболочка времени выполнения
ms.date: 03/30/2017
helpviewer_keywords:
- COM interop, COM wrappers
- RCW
- COM wrappers
- runtime callable wrappers
- interoperation with unmanaged code, COM wrappers
ms.assetid: 7e542583-1e31-4e10-b523-8cf2f29cb4a4
ms.openlocfilehash: 0b448379fba965060fdf3bf067e65374f40d1fc2
ms.sourcegitcommit: 00aa62e2f469c2272a457b04e66b4cc3c97a800b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/28/2020
ms.locfileid: "78156014"
---
# <a name="runtime-callable-wrapper"></a><span data-ttu-id="3f32c-102">Вызываемая оболочка времени выполнения</span><span class="sxs-lookup"><span data-stu-id="3f32c-102">Runtime Callable Wrapper</span></span>
<span data-ttu-id="3f32c-103">Среда CLR предоставляет доступ к COM-объектам через посредник, называемый вызываемой оболочкой времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="3f32c-103">The common language runtime exposes COM objects through a proxy called the runtime callable wrapper (RCW).</span></span> <span data-ttu-id="3f32c-104">Хотя вызываемая оболочка времени выполнения выглядит для клиентов .NET обычным объектом, ее основная функция состоит в маршалинге вызовов между клиентом .NET и COM-объектом.</span><span class="sxs-lookup"><span data-stu-id="3f32c-104">Although the RCW appears to be an ordinary object to .NET clients, its primary function is to marshal calls between a .NET client and a COM object.</span></span>  
  
 <span data-ttu-id="3f32c-105">Среда выполнения создает по одной вызываемой оболочке времени выполнения для каждого COM-объекта независимо от числа существующих ссылок на этот объект.</span><span class="sxs-lookup"><span data-stu-id="3f32c-105">The runtime creates exactly one RCW for each COM object, regardless of the number of references that exist on that object.</span></span> <span data-ttu-id="3f32c-106">Среда выполнения поддерживает одну вызываемую оболочку времени выполнения на процесс для каждого объекта.</span><span class="sxs-lookup"><span data-stu-id="3f32c-106">The runtime maintains a single RCW per process for each object.</span></span>  <span data-ttu-id="3f32c-107">Если вы создаете вызываемую оболочку времени выполнения в одном домене приложения или подразделении, а затем передаете ссылку в другой домен приложения или подразделение, будет использоваться посредник для первого объекта.</span><span class="sxs-lookup"><span data-stu-id="3f32c-107">If you create an RCW in one application domain or apartment, and then pass a reference to another application domain or apartment, a proxy to the first object will be used.</span></span>  <span data-ttu-id="3f32c-108">Как показано на схеме ниже, любое количество управляемых клиентов может содержать ссылку на COM-объекты, предоставляющие интерфейсы INew и INewer.</span><span class="sxs-lookup"><span data-stu-id="3f32c-108">As the following illustration shows, any number of managed clients can hold a reference to the COM objects that expose INew and INewer interfaces.</span></span>  

<span data-ttu-id="3f32c-109">На следующем рисунке показана процедура доступа к COM-объектам с помощью вызываемой оболочки времени выполнения:</span><span class="sxs-lookup"><span data-stu-id="3f32c-109">The following image shows the process for accessing COM objects through the runtime callable wrapper:</span></span>

 ![Процедура доступа к COM-объектам с помощью вызываемой оболочки времени выполнения.](./media/runtime-callable-wrapper/runtime-callable-wrapper.gif)  

 <span data-ttu-id="3f32c-111">Используя метаданные, полученные из библиотеки типов, среда выполнения создает и вызываемый COM-объект, и оболочку для него.</span><span class="sxs-lookup"><span data-stu-id="3f32c-111">Using metadata derived from a type library, the runtime creates both the COM object being called and a wrapper for that object.</span></span> <span data-ttu-id="3f32c-112">Каждая вызываемая оболочка времени выполнения содержит кэш указателей интерфейса для COM-объекта, для которого она используется, и освобождает ссылку на COM-объект, когда она больше не нужна.</span><span class="sxs-lookup"><span data-stu-id="3f32c-112">Each RCW maintains a cache of interface pointers on the COM object it wraps and releases its reference on the COM object when the RCW is no longer needed.</span></span> <span data-ttu-id="3f32c-113">Среда выполнения выполняет сборку мусора для вызываемой оболочки времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="3f32c-113">The runtime performs garbage collection on the RCW.</span></span>  
  
 <span data-ttu-id="3f32c-114">Среди прочих операций вызываемая оболочка времени выполнения осуществляет маршалинг данных между управляемым и неуправляемым кодом от имени упакованного в оболочку объекта.</span><span class="sxs-lookup"><span data-stu-id="3f32c-114">Among other activities, the RCW marshals data between managed and unmanaged code, on behalf of the wrapped object.</span></span> <span data-ttu-id="3f32c-115">В частности, вызываемая оболочка времени выполнения выполняет маршалинг аргументов и возвращаемых значений метода, если данные, которыми обмениваются клиент и сервер, представлены в них по-разному.</span><span class="sxs-lookup"><span data-stu-id="3f32c-115">Specifically, the RCW provides marshaling for method arguments and method return values whenever the client and server have different representations of the data passed between them.</span></span>  
  
 <span data-ttu-id="3f32c-116">Стандартная оболочка обеспечивает выполнение встроенных правил маршалинга.</span><span class="sxs-lookup"><span data-stu-id="3f32c-116">The standard wrapper enforces built-in marshaling rules.</span></span> <span data-ttu-id="3f32c-117">Например, когда клиент .NET передает в неуправляемый объект тип String как часть аргумента, оболочка преобразует эту строку в тип BSTR.</span><span class="sxs-lookup"><span data-stu-id="3f32c-117">For example, when a .NET client passes a String type as part of an argument to an unmanaged object, the wrapper converts the string to a BSTR type.</span></span> <span data-ttu-id="3f32c-118">Если COM-объект возвращает управляемому вызывающему объекту данные типа BSTR, вызывающий объект получит данные типа String.</span><span class="sxs-lookup"><span data-stu-id="3f32c-118">Should the COM object return a BSTR to its managed caller, the caller receives a String.</span></span> <span data-ttu-id="3f32c-119">И клиент, и сервер отправляют и получают данные в понятном им представлении.</span><span class="sxs-lookup"><span data-stu-id="3f32c-119">Both the client and the server send and receive data that is familiar to them.</span></span> <span data-ttu-id="3f32c-120">Преобразование других типов не требуется.</span><span class="sxs-lookup"><span data-stu-id="3f32c-120">Other types require no conversion.</span></span> <span data-ttu-id="3f32c-121">Например, стандартная оболочка всегда передает 4-байтовое целое число между управляемым и неуправляемым кодом, не преобразуя тип.</span><span class="sxs-lookup"><span data-stu-id="3f32c-121">For instance, a standard wrapper will always pass a 4-byte integer between managed and unmanaged code without converting the type.</span></span>  
  
## <a name="marshaling-selected-interfaces"></a><span data-ttu-id="3f32c-122">Маршалинг выбранных интерфейсов</span><span class="sxs-lookup"><span data-stu-id="3f32c-122">Marshaling selected interfaces</span></span>  
 <span data-ttu-id="3f32c-123">Основная цель [вызываемой оболочки времени выполнения](runtime-callable-wrapper.md) — скрыть различия между управляемыми и неуправляемыми моделями программирования.</span><span class="sxs-lookup"><span data-stu-id="3f32c-123">The primary goal of the [runtime callable wrapper](runtime-callable-wrapper.md) (RCW) is to hide the differences between the managed and unmanaged programming models.</span></span> <span data-ttu-id="3f32c-124">Чтобы обеспечить беспроблемный переход, вызываемая оболочка времени выполнения использует выбранные COM-интерфейсы, не предоставляя доступа к ним клиенту .NET, как показано на схеме ниже.</span><span class="sxs-lookup"><span data-stu-id="3f32c-124">To create a seamless transition, the RCW consumes selected COM interfaces without exposing them to the .NET client, as shown in the following illustration.</span></span>

 <span data-ttu-id="3f32c-125">На следующем рисунке показаны COM-интерфейсы и вызываемая оболочка времени выполнения:</span><span class="sxs-lookup"><span data-stu-id="3f32c-125">The following image shows COM interfaces and the runtime callable wrapper:</span></span>
  
 ![Снимок экрана, показывающий вызываемую оболочку времени выполнения с интерфейсами.](./media/runtime-callable-wrapper/runtime-callable-wrapper-interfaces.gif)  
  
 <span data-ttu-id="3f32c-127">Вызываемая оболочка времени выполнения, если она создается как объект с ранним связыванием, является особым типом.</span><span class="sxs-lookup"><span data-stu-id="3f32c-127">When created as an early-bound object, the RCW is a specific type.</span></span> <span data-ttu-id="3f32c-128">Она реализует интерфейсы, реализуемые COM-объектом, и предоставляет доступ к методам, свойствам и событиям из интерфейсов объекта.</span><span class="sxs-lookup"><span data-stu-id="3f32c-128">It implements the interfaces that the COM object implements and exposes the methods, properties, and events from the object's interfaces.</span></span> <span data-ttu-id="3f32c-129">На рисунке вызываемая оболочка времени выполнения предоставляет доступ к интерфейсу INew, для чего использует интерфейсы **IUnknown** и **IDispatch**.</span><span class="sxs-lookup"><span data-stu-id="3f32c-129">In the illustration, the RCW exposes the INew interface but consumes the **IUnknown** and **IDispatch** interfaces.</span></span> <span data-ttu-id="3f32c-130">Кроме того, вызываемая оболочка времени выполнения предоставляет клиенту .NET доступ ко всем членам интерфейса INew.</span><span class="sxs-lookup"><span data-stu-id="3f32c-130">Further, the RCW exposes all members of the INew interface to the .NET client.</span></span>  
  
 <span data-ttu-id="3f32c-131">Вызываемая оболочка времени выполнения использует перечисленные в следующей таблице интерфейсы, предоставляемые инкапсулированным в эту оболочку объектом.</span><span class="sxs-lookup"><span data-stu-id="3f32c-131">The RCW consumes the interfaces listed in the following table, which are exposed by the object it wraps.</span></span>  
  
|<span data-ttu-id="3f32c-132">Интерфейс</span><span class="sxs-lookup"><span data-stu-id="3f32c-132">Interface</span></span>|<span data-ttu-id="3f32c-133">Description</span><span class="sxs-lookup"><span data-stu-id="3f32c-133">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="3f32c-134">**IDispatch**</span><span class="sxs-lookup"><span data-stu-id="3f32c-134">**IDispatch**</span></span>|<span data-ttu-id="3f32c-135">Для позднего связывания с COM-объектами с помощью отражения.</span><span class="sxs-lookup"><span data-stu-id="3f32c-135">For late binding to COM objects through reflection.</span></span>|  
|<span data-ttu-id="3f32c-136">**IErrorInfo**</span><span class="sxs-lookup"><span data-stu-id="3f32c-136">**IErrorInfo**</span></span>|<span data-ttu-id="3f32c-137">Предоставляет текстовое описание ошибки, ее источник, файл справки, контекст справки и идентификатор GUID интерфейса, определившего ошибку (для классов .NET всегда **GUID_NULL**).</span><span class="sxs-lookup"><span data-stu-id="3f32c-137">Provides a textual description of the error, its source, a Help file, Help context, and the GUID of the interface that defined the error (always **GUID_NULL** for .NET classes).</span></span>|  
|<span data-ttu-id="3f32c-138">**IProvideClassInfo**</span><span class="sxs-lookup"><span data-stu-id="3f32c-138">**IProvideClassInfo**</span></span>|<span data-ttu-id="3f32c-139">Если инкапсулируемый COM-объект реализует интерфейс **IProvideClassInfo**, вызываемая оболочка времени выполнения извлекает из этого интерфейса сведения о типе для лучшей его идентификации.</span><span class="sxs-lookup"><span data-stu-id="3f32c-139">If the COM object being wrapped implements **IProvideClassInfo**, the RCW extracts the type information from this interface to provide better type identity.</span></span>|  
|<span data-ttu-id="3f32c-140">**IUnknown**</span><span class="sxs-lookup"><span data-stu-id="3f32c-140">**IUnknown**</span></span>|<span data-ttu-id="3f32c-141">Для идентификации объектов, приведения типов и управления жизненным циклом объекта:</span><span class="sxs-lookup"><span data-stu-id="3f32c-141">For object identity, type coercion, and lifetime management:</span></span><br /><br /> <span data-ttu-id="3f32c-142">— Идентификация объектов</span><span class="sxs-lookup"><span data-stu-id="3f32c-142">-   Object identity</span></span><br />     <span data-ttu-id="3f32c-143">Среда выполнения различает COM-объекты, сравнивая значение интерфейса **IUnknown** для каждого из них.</span><span class="sxs-lookup"><span data-stu-id="3f32c-143">The runtime distinguishes between COM objects by comparing the value of the **IUnknown** interface for each object.</span></span><br /><span data-ttu-id="3f32c-144">— Приведение типов</span><span class="sxs-lookup"><span data-stu-id="3f32c-144">-   Type coercion</span></span><br />     <span data-ttu-id="3f32c-145">Вызываемая оболочка времени выполнения распознает динамическое обнаружение типов, выполняемое методом **QueryInterface**.</span><span class="sxs-lookup"><span data-stu-id="3f32c-145">The RCW recognizes the dynamic type discovery performed by the **QueryInterface** method.</span></span><br /><span data-ttu-id="3f32c-146">— Управление жизненным циклом объекта</span><span class="sxs-lookup"><span data-stu-id="3f32c-146">-   Lifetime management</span></span><br />     <span data-ttu-id="3f32c-147">С помощью метода **QueryInterface** вызываемая оболочка времени выполнения получает и сохраняет ссылку на неуправляемый объект, пока среда выполнения не выполнит для оболочки сбор мусора, освободив неуправляемый объект.</span><span class="sxs-lookup"><span data-stu-id="3f32c-147">Using the **QueryInterface** method, the RCW gets and holds a reference to an unmanaged object until the runtime performs garbage collection on the wrapper, which releases the unmanaged object.</span></span>|  
  
 <span data-ttu-id="3f32c-148">Вызываемая оболочка времени выполнения может использовать перечисленные в следующей таблице интерфейсы, предоставляемые инкапсулированным в эту оболочку объектом.</span><span class="sxs-lookup"><span data-stu-id="3f32c-148">The RCW optionally consumes the interfaces listed in the following table, which are exposed by the object it wraps.</span></span>  
  
|<span data-ttu-id="3f32c-149">Интерфейс</span><span class="sxs-lookup"><span data-stu-id="3f32c-149">Interface</span></span>|<span data-ttu-id="3f32c-150">Description</span><span class="sxs-lookup"><span data-stu-id="3f32c-150">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="3f32c-151">**IConnectionPoint** и **IConnectionPointContainer**</span><span class="sxs-lookup"><span data-stu-id="3f32c-151">**IConnectionPoint** and **IConnectionPointContainer**</span></span>|<span data-ttu-id="3f32c-152">Вызываемая оболочка времени выполнения преобразует объекты, предоставляющие событиям на основе делегата доступ к стилю события точки подключения.</span><span class="sxs-lookup"><span data-stu-id="3f32c-152">The RCW converts objects that expose the connection-point event style to delegate-based events.</span></span>|  
|<span data-ttu-id="3f32c-153">**IDispatchEx** (только в .NET Framework)</span><span class="sxs-lookup"><span data-stu-id="3f32c-153">**IDispatchEx** (.NET Framework Only)</span></span> |<span data-ttu-id="3f32c-154">Если класс реализует интерфейс **IDispatchEx**, вызываемая оболочка времени выполнения реализует интерфейс **IExpando**.</span><span class="sxs-lookup"><span data-stu-id="3f32c-154">If the class implements **IDispatchEx**, the RCW implements **IExpando**.</span></span> <span data-ttu-id="3f32c-155">Интерфейс **IDispatchEx** является расширением интерфейса **IDispatch**, который, в отличие от интерфейса **IDispatch**, позволяет перечислять, добавлять, удалять и вызывать члены с учетом регистра.</span><span class="sxs-lookup"><span data-stu-id="3f32c-155">The **IDispatchEx** interface is an extension of the **IDispatch** interface that, unlike **IDispatch**, enables enumeration, addition, deletion, and case-sensitive calling of members.</span></span>|  
|<span data-ttu-id="3f32c-156">**IEnumVARIANT**</span><span class="sxs-lookup"><span data-stu-id="3f32c-156">**IEnumVARIANT**</span></span>|<span data-ttu-id="3f32c-157">Активирует COM-типы, позволяющие работать с перечислениями как с коллекциями.</span><span class="sxs-lookup"><span data-stu-id="3f32c-157">Enables COM types that support enumerations to be treated as collections.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="3f32c-158">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="3f32c-158">See also</span></span>

- [<span data-ttu-id="3f32c-159">Oболочки COM</span><span class="sxs-lookup"><span data-stu-id="3f32c-159">COM Wrappers</span></span>](com-wrappers.md)
- [<span data-ttu-id="3f32c-160">Вызываемая оболочка COM</span><span class="sxs-lookup"><span data-stu-id="3f32c-160">COM Callable Wrapper</span></span>](com-callable-wrapper.md)
- <span data-ttu-id="3f32c-161">[Общие сведения о преобразовании библиотеки типов в сборку](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/k83zzh38(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="3f32c-161">[Type Library to Assembly Conversion Summary](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/k83zzh38(v=vs.100))</span></span>
- [<span data-ttu-id="3f32c-162">Импорт библиотеки типов в виде сборки</span><span class="sxs-lookup"><span data-stu-id="3f32c-162">Importing a Type Library as an Assembly</span></span>](../../framework/interop/importing-a-type-library-as-an-assembly.md)
