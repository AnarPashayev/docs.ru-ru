---
title: Устойчивые функции Azure — Бессерверных приложений
description: Устойчивые функции Azure расширения среды выполнения функций Azure для включения с отслеживанием состояния потоков работ в коде.
author: cecilphillip
ms.author: cephilli
ms.date: 06/26/2018
ms.openlocfilehash: f7ee74926d6658042120113b49dc763383881423
ms.sourcegitcommit: 8699383914c24a0df033393f55db3369db728a7b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2019
ms.locfileid: "65643402"
---
# <a name="durable-azure-functions"></a>Устойчивые функции Azure

При создании бессерверных приложений с помощью функций Azure, ваши операции, обычно быть настроены для работы в режиме без отслеживания состояния. Причина этого выбора обусловлено тем, как их масштабы платформы, становится сложно предсказать, какие серверы, на которой выполняется код. Он также становится сложно предсказать, сколько экземпляров активны в любой момент. Однако существуют классы приложений, требующих текущее состояние процесса, чтобы быть известны. Рассмотрим процесс отправки заказа для Интернет-магазина. Возможно, операция извлечения рабочий процесс, состоящий из нескольких операций, которые нужно знать состояние процесса. Такие сведения могут включать складских запасов, если пользователь имеет все кредиты на своей учетной записью, а также результаты обработки кредитной карты. Эти операции легко может быть собственных внутренних рабочих процессов или даже службы от сторонних систем.

Различные шаблоны, существует, привлечению координации состояния приложения между внутренними и внешними системами. Очень часто сталкивались с решениями, которые зависят от централизованные системы организации очереди, распределенное хранилище значений ключа или общих баз данных для управления этим состоянием. Тем не менее это все дополнительные ресурсы, которые теперь должны быть подготовлены и управляемые. В бессерверной среде ваш код может стать громоздкой, одновременное координирование действий с этими ресурсами вручную. Функции Azure предлагает альтернативный подход для создания функции с отслеживанием состояния, вызывается устойчивых функций.

Устойчивые функции — это расширение, чтобы среда выполнения функций Azure, которая позволяет определять с отслеживанием состояния потоков работ в коде. Путем разбиения рабочих процессов в действия, расширение устойчивых функций можно управлять состоянием, создавать контрольные точки ход выполнения и обработки распространения вызовов функций между серверами. В фоновом режиме он позволяет использовать учетную запись хранилища Azure для сохранения журнала выполнения, планируют функции действий и получения ответов. Бессерверном коде никогда не должна взаимодействовать с сохраненной информации в этой учетной записи, которое обычно не что-то с помощью которого разработчики должны взаимодействовать.

## <a name="triggering-a-stateful-workflow"></a>Активация с отслеживанием состояния рабочего процесса

С отслеживанием состояния рабочих процессов в устойчивых функциях можно разделить на два встроенных компонентов; триггеры оркестрации и действия. Триггеры и привязки, основные компоненты, используемые функциями Azure, позволяя вашим функциям бессерверной уведомлять для запуска, получать входные и возврата результатов.

### <a name="working-with-the-orchestration-client"></a>Работа с клиента Оркестрации

Согласование уникальны, по сравнению с другим стилем активированные операций в функциях Azure. Устойчивые функции обеспечивают выполнение функций, которые может длиться несколько часов или даже дней. Такой тип поведения поставляется с необходимостью возможность проверить состояние выполнения оркестрации, заблаговременно завершать, или отправлять уведомления о внешних событий.

В таких случаях предоставляет расширение устойчивых функций `DurableOrchestrationClient` класс, который позволяет взаимодействовать с оркестрацией в функции. Вы получаете доступ к клиенту оркестрации с помощью `OrchestrationClientAttribute` привязки. Как правило, следует включить этот атрибут с другим типом триггера, такие как `HttpTrigger` или `ServiceBusTrigger`. После активации функции источника клиента оркестрации можно использовать для запуска функции оркестратора.

```csharp
[FunctionName("KickOff")]
public static async Task<HttpResponseMessage> Run(
    [HttpTrigger(AuthorizationLevel.Function, "POST")]HttpRequestMessage req,
    [OrchestrationClient ] DurableOrchestrationClient<orchestrationClient>)
{
    OrderRequestData data = await req.Content.ReadAsAsync<OrderRequestData>();

    string instanceId = await orchestrationClient.StartNewAsync("PlaceOrder", data);

    return orchestrationClient.CreateCheckStatusResponse(req, instanceId);
}
```

### <a name="the-orchestrator-function"></a>Функции оркестратора

Создание примечаний к функции с помощью OrchestrationTriggerAttribute знаки "функции Azure" этой функции как функции оркестратора. Он отвечает за управление различными действиями, составляющих с отслеживанием состояния рабочего процесса.

Функции оркестратора не можете использовать привязок, отличных от OrchestrationTriggerAttribute. Этот атрибут может использоваться только с типом параметра DurableOrchestrationContext. Нет входных данных может использоваться, так как входные данные в сигнатуре функции десериализации не поддерживается. Чтобы получить входные данные с помощью клиента оркестрации, GetInput\<T\> метод должен использоваться.

Кроме того, типы возвращаемого значения функций оркестратора должен быть либо void, задачи или сериализуемые значения JSON.

> *Код обработки ошибок были опущены для краткости*

```csharp
[FunctionName("PlaceOrder")]
public static async Task<string> PlaceOrder([OrchestrationTrigger] DurableOrchestrationContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    await context.CallActivityAsync<bool>("CheckAndReserveInventory", orderData);
    await context.CallActivityAsync<string>("ProcessPayment", orderData);

    string trackingNumber = await context.CallActivityAsync<string>("ScheduleShipping", orderData);
    await context.CallActivityAsync<string>("EmailCustomer", trackingNumber);

    return trackingNumber;
}
```

Несколько экземпляров оркестрации может быть запущена и работает, в то же время. Вызов `StartNewAsync` метод `DurableOrchestrationClient` запускает новый экземпляр оркестрации. Этот метод возвращает `Task<string>` которая завершается при запуске оркестрации. Исключение типа `TimeoutException` получает создается, если оркестрации не запущен в течение 30 секунд.

Завершенные `Task<string>` из `StartNewAsync` должен содержать уникальный идентификатор экземпляра оркестрации. Этот идентификатор экземпляра можно использовать для вызова операций в этой определенной оркестрации. Оркестрация можно запросить состояние или отправить уведомления о событиях.

### <a name="the-activity-functions"></a>Функции действий

Функции действий являются отдельные операции, которые составляются друг с другом в пределах функции оркестрации для создания рабочего процесса. Вот, где будет выполняться большая часть фактическую работу. Они представляют бизнес-логику, долго выполняющихся процессов и части головоломки, чтобы более крупного решения.

`ActivityTriggerAttribute` Создаются заметки для типа параметра функции `DurableActivityContext`. С помощью заметки информирует среду CLR, что функция предназначен для использования в качестве функции действия. Входные значения для функции действий можно получить с помощью `GetInput<T>` метод `DurableActivityContext` параметра.

Подобно функции оркестрации, типы возвращаемого значения функции действий необходимо быть либо void, задачи или сериализуемые значения JSON.

Все необработанные исключения, возникающие в функциях действий get отправляется вызывающей функции orchestrator и представлены в виде `TaskFailedException`. На этом этапе можно выявить ошибки и вход оркестратора и действия можно повторить.

```csharp
[FunctionName("CheckAndReserveInventory")]
public static bool CheckAndReserveInventory([ActivityTrigger] DurableActivityContext context)
{
    OrderRequestData orderData = context.GetInput<OrderRequestData>();

    // Connect to inventory system and try to reserve items
    return true;
}
```

## <a name="recommended-resources"></a>Рекомендуемые ресурсы

* [Устойчивые функции](https://docs.microsoft.com/azure/azure-functions/durable-functions-overview)
* [Привязки для устойчивых функций](https://docs.microsoft.com/azure/azure-functions/durable-functions-bindings)
* [Управление экземплярами в устойчивых функциях](https://docs.microsoft.com/azure/azure-functions/durable-functions-instance-management)

>[!div class="step-by-step"]
>[Назад](event-grid.md)
>[Вперед](orchestration-patterns.md)
