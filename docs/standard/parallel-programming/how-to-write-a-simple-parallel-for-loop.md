---
title: Практическое руководство. Написание простого цикла Parallel.For
description: Узнайте, как реализовывать в .NET циклы Parallel.For, которые не требуют отмены, прерывания итераций цикла или сохранения локального состояния по отношению к потоку.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
ms.openlocfilehash: 506d6dd725f5d42c6c445a14c5f450c815bfdde1
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94826638"
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="c87eb-103">Практическое руководство. Написание простого цикла Parallel.For</span><span class="sxs-lookup"><span data-stu-id="c87eb-103">How to: Write a Simple Parallel.For Loop</span></span>

<span data-ttu-id="c87eb-104">Этот раздел содержит два примера, иллюстрирующих использование метода <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="c87eb-104">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="c87eb-105">Первый использует перегрузку метода <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType>, а второй — перегрузку <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType>, которые являются двумя простейшими перегрузками метода <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="c87eb-105">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="c87eb-106">Эти две перегрузки метода <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> можно использовать, когда не требуется отменять цикл, прерывать итерации цикла или сохранять локальное состояние по отношению к потоку.</span><span class="sxs-lookup"><span data-stu-id="c87eb-106">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>

> [!NOTE]
> <span data-ttu-id="c87eb-107">В этой документации для определения делегатов в библиотеке параллельных задач используются лямбда-выражения.</span><span class="sxs-lookup"><span data-stu-id="c87eb-107">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="c87eb-108">Если вы не знакомы с лямбда-выражениями в C# или Visual Basic, см. раздел [Лямбда-выражения в PLINQ и TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="c87eb-108">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="c87eb-109">Первый пример вычисляет размер файлов в одном каталоге.</span><span class="sxs-lookup"><span data-stu-id="c87eb-109">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="c87eb-110">Второй — вычисляет произведение двух матриц.</span><span class="sxs-lookup"><span data-stu-id="c87eb-110">The second computes the product of two matrices.</span></span>

## <a name="directory-size-example"></a><span data-ttu-id="c87eb-111">Пример вычисления размера каталога</span><span class="sxs-lookup"><span data-stu-id="c87eb-111">Directory size example</span></span>

<span data-ttu-id="c87eb-112">Данный пример представлен простой служебной программой командной строки, которая вычисляет общий размер файлов в каталоге.</span><span class="sxs-lookup"><span data-stu-id="c87eb-112">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="c87eb-113">Он ожидает получить путь к одному каталогу в качестве аргумента и сообщает количество и общий размер файлов в этом каталоге.</span><span class="sxs-lookup"><span data-stu-id="c87eb-113">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="c87eb-114">После подтверждения существования каталога он использует метод <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> для перечисления файлов в этом каталоге и определения их размеров.</span><span class="sxs-lookup"><span data-stu-id="c87eb-114">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="c87eb-115">После этого размер каждого файла добавляется в переменную `totalSize`.</span><span class="sxs-lookup"><span data-stu-id="c87eb-115">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="c87eb-116">Обратите внимание, что добавление выполняется путем вызова <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>, чтобы оно имело форму атомарной операции.</span><span class="sxs-lookup"><span data-stu-id="c87eb-116">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="c87eb-117">В противном случае несколько задач могут одновременно попытаться обновить переменную `totalSize`.</span><span class="sxs-lookup"><span data-stu-id="c87eb-117">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>

[!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
[!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]

## <a name="matrix-and-stopwatch-example"></a><span data-ttu-id="c87eb-118">Пример с матрицами и таймером</span><span class="sxs-lookup"><span data-stu-id="c87eb-118">Matrix and stopwatch example</span></span>

<span data-ttu-id="c87eb-119">Этот пример использует метод <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> для вычисления произведения двух матриц.</span><span class="sxs-lookup"><span data-stu-id="c87eb-119">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="c87eb-120">Он также демонстрирует использование класса <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> для сравнения производительности параллельного цикла и непараллельного цикла.</span><span class="sxs-lookup"><span data-stu-id="c87eb-120">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="c87eb-121">Обратите внимание на то, что поскольку данный пример может создавать большое количество выходных данных, он позволяет перенаправлять выходные данные в файл.</span><span class="sxs-lookup"><span data-stu-id="c87eb-121">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>

[!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
[!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]

<span data-ttu-id="c87eb-122">При параллелизации любого кода, включая циклы, одна из важнейших целей — достижение максимального уровня использования процессоров без чрезмерной параллелизации до точки, где издержки параллельной обработки нивелируют выигрыш в производительности.</span><span class="sxs-lookup"><span data-stu-id="c87eb-122">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="c87eb-123">В данном конкретном примере параллелизации подвергается только внешний цикл, так как во внутреннем цикле выполняется не очень большой объем работы.</span><span class="sxs-lookup"><span data-stu-id="c87eb-123">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="c87eb-124">Сочетание небольшого объема работы и нежелательного влияния кэша может привести к снижению производительности во вложенных параллельных циклах.</span><span class="sxs-lookup"><span data-stu-id="c87eb-124">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="c87eb-125">Таким образом, параллелизация только внешнего цикла является лучшим способом обеспечить максимальную выгоду от параллелизма в большинстве систем.</span><span class="sxs-lookup"><span data-stu-id="c87eb-125">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>

## <a name="the-delegate"></a><span data-ttu-id="c87eb-126">Делегат</span><span class="sxs-lookup"><span data-stu-id="c87eb-126">The Delegate</span></span>

<span data-ttu-id="c87eb-127">Третий параметр этой перегрузки <xref:System.Threading.Tasks.Parallel.For%2A> — делегат типа `Action<int>` в C# или `Action(Of Integer)` в Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="c87eb-127">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="c87eb-128">Делегат `Action` всегда возвращает значение void независимо от того, сколько параметров типа он имеет.</span><span class="sxs-lookup"><span data-stu-id="c87eb-128">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="c87eb-129">В Visual Basic поведение `Action` определяется `Sub`.</span><span class="sxs-lookup"><span data-stu-id="c87eb-129">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="c87eb-130">Пример использует для создания делегата лямбда-выражение, но этот делегат можно создать и другими способами.</span><span class="sxs-lookup"><span data-stu-id="c87eb-130">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="c87eb-131">См. дополнительные сведения см. в руководстве по [лямбда-выражениям в PLINQ и TPL](lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="c87eb-131">For more information, see [Lambda Expressions in PLINQ and TPL](lambda-expressions-in-plinq-and-tpl.md).</span></span>

## <a name="the-iteration-value"></a><span data-ttu-id="c87eb-132">Значение итерации</span><span class="sxs-lookup"><span data-stu-id="c87eb-132">The Iteration Value</span></span>

<span data-ttu-id="c87eb-133">Этот делегат принимает один входной параметр, значение которого является текущей итерацией.</span><span class="sxs-lookup"><span data-stu-id="c87eb-133">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="c87eb-134">Это значение итерации предоставляется средой выполнения, а его начальным значением является индекс первого элемента в сегменте (части) источника, который обрабатывается в текущем потоке.</span><span class="sxs-lookup"><span data-stu-id="c87eb-134">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>

<span data-ttu-id="c87eb-135">Если требуется расширенное управление уровнем параллелизма, используйте одну из перегрузок, принимающих входной параметр <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType>, например: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="c87eb-135">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>

## <a name="return-value-and-exception-handling"></a><span data-ttu-id="c87eb-136">Обработка возвращаемых значений и исключений</span><span class="sxs-lookup"><span data-stu-id="c87eb-136">Return Value and Exception Handling</span></span>

<span data-ttu-id="c87eb-137"><xref:System.Threading.Tasks.Parallel.For%2A> возвращает объект <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> после завершения всех потоков.</span><span class="sxs-lookup"><span data-stu-id="c87eb-137"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="c87eb-138">Это возвращаемое значение полезно при остановке или прерывании итерации цикла вручную, поскольку <xref:System.Threading.Tasks.ParallelLoopResult> хранит такие сведения, как последняя завершенная итерация.</span><span class="sxs-lookup"><span data-stu-id="c87eb-138">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="c87eb-139">Если в одном из потоков возникает одно или несколько исключений, выдается <xref:System.AggregateException?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="c87eb-139">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>

<span data-ttu-id="c87eb-140">В коде этого примера возвращаемое значение <xref:System.Threading.Tasks.Parallel.For%2A> не используется.</span><span class="sxs-lookup"><span data-stu-id="c87eb-140">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>

## <a name="analysis-and-performance"></a><span data-ttu-id="c87eb-141">Анализ и производительность</span><span class="sxs-lookup"><span data-stu-id="c87eb-141">Analysis and Performance</span></span>

<span data-ttu-id="c87eb-142">Для просмотра загрузки ЦП на компьютере можно использовать мастер производительности.</span><span class="sxs-lookup"><span data-stu-id="c87eb-142">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="c87eb-143">В качестве эксперимента увеличьте количество столбцов и строк в матрицах.</span><span class="sxs-lookup"><span data-stu-id="c87eb-143">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="c87eb-144">Чем больше матрицы, тем больше разница в производительности между последовательной и параллельной версиями вычисления.</span><span class="sxs-lookup"><span data-stu-id="c87eb-144">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="c87eb-145">При небольшом размере матрицы последовательная версия выполняется быстрее из-за издержек на формирование параллельного цикла.</span><span class="sxs-lookup"><span data-stu-id="c87eb-145">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>

<span data-ttu-id="c87eb-146">Синхронные вызовы общих ресурсов, таких как консоль или файловая система, значительно снижают производительность параллельного цикла.</span><span class="sxs-lookup"><span data-stu-id="c87eb-146">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="c87eb-147">При измерении производительности старайтесь избегать в цикле таких вызовов, как <xref:System.Console.WriteLine%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="c87eb-147">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>

## <a name="compile-the-code"></a><span data-ttu-id="c87eb-148">Компиляция кода</span><span class="sxs-lookup"><span data-stu-id="c87eb-148">Compile the Code</span></span>

<span data-ttu-id="c87eb-149">Скопируйте и вставьте этот код в проект Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="c87eb-149">Copy and paste this code into a Visual Studio project.</span></span>

## <a name="see-also"></a><span data-ttu-id="c87eb-150">См. также</span><span class="sxs-lookup"><span data-stu-id="c87eb-150">See also</span></span>

- <xref:System.Threading.Tasks.Parallel.For%2A>
- <xref:System.Threading.Tasks.Parallel.ForEach%2A>
- [<span data-ttu-id="c87eb-151">Параллелизм данных</span><span class="sxs-lookup"><span data-stu-id="c87eb-151">Data Parallelism</span></span>](data-parallelism-task-parallel-library.md)
- [<span data-ttu-id="c87eb-152">Параллельное программирование</span><span class="sxs-lookup"><span data-stu-id="c87eb-152">Parallel Programming</span></span>](index.md)
