---
title: Создание цепочки задач с помощью задач продолжения
description: Сведения о создании цепочки задач с помощью задач продолжения в .NET. Задача продолжения — это асинхронная задача, вызываемая другой задачей.
ms.date: 07/20/2020
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- tasks, continuations
ms.assetid: 0b45e9a2-de28-46ce-8212-1817280ed42d
ms.openlocfilehash: d42d244e644bf3ee1f45b25a71d60bbb2ef8e590
ms.sourcegitcommit: 7476c20d2f911a834a00b8a7f5e8926bae6804d9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2020
ms.locfileid: "88063839"
---
# <a name="chaining-tasks-using-continuation-tasks"></a><span data-ttu-id="3c1fc-104">Создание цепочки задач с помощью задач продолжения</span><span class="sxs-lookup"><span data-stu-id="3c1fc-104">Chaining tasks using continuation tasks</span></span>

<span data-ttu-id="3c1fc-105">В асинхронном программировании при завершении одной асинхронной операции обычно вызывается вторая операция.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-105">In asynchronous programming, it's common for one asynchronous operation, on completion, to invoke a second operation.</span></span> <span data-ttu-id="3c1fc-106">Такое поведение позволяет последующим операциям использовать результаты первой операции.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-106">Continuations allow decedent operations to consume the results of the first operation.</span></span> <span data-ttu-id="3c1fc-107">В большинстве случаев непрерывность достигается с помощью методов обратного вызова.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-107">Traditionally, continuations have been done by using callback methods.</span></span> <span data-ttu-id="3c1fc-108">В библиотеке параллельных задач эта функциональность обеспечивается _задачами продолжения_.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-108">In the Task Parallel Library, the same functionality is provided by _continuation tasks_.</span></span> <span data-ttu-id="3c1fc-109">Задача продолжения (также называемая просто продолжением) — это асинхронная задача, вызываемая другой задачей, которая называется _предшествующей_, при завершении этой предшествующей задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-109">A continuation task (also known just as a continuation) is an asynchronous task that's invoked by another task, known as the _antecedent_, when the antecedent finishes.</span></span>

<span data-ttu-id="3c1fc-110">Хотя продолжения относительно легко использовать, они представляют собой мощный и гибкий инструмент.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-110">Continuations are relatively easy to use, but are nevertheless powerful and flexible.</span></span> <span data-ttu-id="3c1fc-111">Например, с их помощью можно выполнять следующее.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-111">For example, you can:</span></span>

- <span data-ttu-id="3c1fc-112">Передавать данные из предшествующей задачи в продолжение.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-112">Pass data from the antecedent to the continuation.</span></span>
- <span data-ttu-id="3c1fc-113">Указывать точные условия, при которых продолжение будет вызываться или не будет вызываться.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-113">Specify the precise conditions under which the continuation will be invoked or not invoked.</span></span>
- <span data-ttu-id="3c1fc-114">Отменять продолжение перед его запуском либо совместно с его выполнением.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-114">Cancel a continuation either before it starts or cooperatively as it is running.</span></span>
- <span data-ttu-id="3c1fc-115">Определять подсказки, как должно планироваться продолжение.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-115">Provide hints about how the continuation should be scheduled.</span></span>
- <span data-ttu-id="3c1fc-116">Вызывать несколько продолжений из одной и той же предшествующей задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-116">Invoke multiple continuations from the same antecedent.</span></span>
- <span data-ttu-id="3c1fc-117">Вызывать одно продолжение по завершении всех или одной из нескольких предшествующих задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-117">Invoke one continuation when all or any one of multiple antecedents complete.</span></span>
- <span data-ttu-id="3c1fc-118">Прикреплять продолжения одно после другого до любой произвольной длины.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-118">Chain continuations one after another to any arbitrary length.</span></span>
- <span data-ttu-id="3c1fc-119">Использовать продолжение для обработки исключений, вызванных предшествующей задачей.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-119">Use a continuation to handle exceptions thrown by the antecedent.</span></span>

## <a name="about-continuations"></a><span data-ttu-id="3c1fc-120">О продолжениях</span><span class="sxs-lookup"><span data-stu-id="3c1fc-120">About continuations</span></span>

<span data-ttu-id="3c1fc-121">Продолжение — это задача, созданная в состоянии <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-121">A continuation is a task that is created in the <xref:System.Threading.Tasks.TaskStatus.WaitingForActivation> state.</span></span> <span data-ttu-id="3c1fc-122">Она активируется автоматически при завершении предшествующей задачи или задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-122">It is activated automatically when its antecedent task or tasks complete.</span></span> <span data-ttu-id="3c1fc-123">Вызов <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> в продолжении в пользовательском коде вызывает исключение <xref:System.InvalidOperationException?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-123">Calling <xref:System.Threading.Tasks.Task.Start%2A?displayProperty=nameWithType> on a continuation in user code throws an <xref:System.InvalidOperationException?displayProperty=nameWithType> exception.</span></span>

<span data-ttu-id="3c1fc-124">Продолжение по сути является <xref:System.Threading.Tasks.Task> и не блокирует поток, в котором она запущена.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-124">A continuation is itself a <xref:System.Threading.Tasks.Task> and does not block the thread on which it is started.</span></span> <span data-ttu-id="3c1fc-125">Вызовите метод <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> для блокирования до завершения задачи продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-125">Call the <xref:System.Threading.Tasks.Task.Wait%2A?displayProperty=nameWithType> method to block until the continuation task finishes.</span></span>

## <a name="create-a-continuation-for-a-single-antecedent"></a><span data-ttu-id="3c1fc-126">Создание продолжения для одной предшествующей задачи</span><span class="sxs-lookup"><span data-stu-id="3c1fc-126">Create a continuation for a single antecedent</span></span>

<span data-ttu-id="3c1fc-127">Продолжение, которое выполняется, когда завершается предшествующая задача, создается путем вызова метода <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-127">You create a continuation that executes when its antecedent has completed by calling the <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="3c1fc-128">В следующем примере показан базовый шаблон (для ясности в нем опущена обработка исключений).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-128">The following example shows the basic pattern (for clarity, exception handling is omitted).</span></span> <span data-ttu-id="3c1fc-129">Он выполняет предшествующую задачу `taskA`, которая возвращает объект <xref:System.DayOfWeek> , указывающий название текущего дня недели.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-129">It executes an antecedent task, `taskA`, that returns a <xref:System.DayOfWeek> object that indicates the name of the current day of the week.</span></span> <span data-ttu-id="3c1fc-130">После завершения предшествующей задачи задача продолжения `continuation` передается предшествующей задаче и отображает строку, содержащую результат ее выполнения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-130">When the antecedent completes, the continuation task, `continuation`, is passed the antecedent and displays a string that includes its result.</span></span>

> [!NOTE]
> <span data-ttu-id="3c1fc-131">В примере C# в этой статье используется модификатор `async` в методе `Main`.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-131">The C# samples in this article make use of the `async` modifier on the `Main` method.</span></span> <span data-ttu-id="3c1fc-132">Эта возможность доступна в C# 7.1 и более поздних версиях.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-132">That feature is available in C# 7.1 and later.</span></span> <span data-ttu-id="3c1fc-133">В предыдущих версиях при компиляции примера кода создается [`CS5001`](../../csharp/misc/cs5001.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-133">Previous versions generate [`CS5001`](../../csharp/misc/cs5001.md) when compiling this sample code.</span></span> <span data-ttu-id="3c1fc-134">Вам потребуется задать версию языка C# 7.1 или более поздней версии.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-134">You'll need to set the language version to C# 7.1 or newer.</span></span> <span data-ttu-id="3c1fc-135">Инструкции по настройке версии языка приводятся в [этой статье](../../csharp/language-reference/configure-language-version.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-135">You can learn how to configure the language version in the article on [configure language version](../../csharp/language-reference/configure-language-version.md).</span></span>

:::code language="csharp" source="snippets/cs/simple1.cs":::

[!code-vb[TPL_Continuations#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/simple1.vb#1)]

## <a name="create-a-continuation-for-multiple-antecedents"></a><span data-ttu-id="3c1fc-136">Создание продолжения для нескольких предшествующих задач</span><span class="sxs-lookup"><span data-stu-id="3c1fc-136">Create a continuation for multiple antecedents</span></span>

<span data-ttu-id="3c1fc-137">Можно также создать продолжение, которое будет выполняться после завершения всей группы задач или какой-либо из них.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-137">You can also create a continuation that will run when any or all of a group of tasks has completed.</span></span> <span data-ttu-id="3c1fc-138">Чтобы выполнить продолжение после завершения всех предшествующих задач, вызовите статический (`Shared` в Visual Basic) метод <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> или экземпляр метода <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-138">To execute a continuation when all antecedent tasks have completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="3c1fc-139">Чтобы выполнить продолжение после завершения какой-либо из предшествующих задач, вызовите статический (`Shared` в Visual Basic) метод <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> или экземпляр метода <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-139">To execute a continuation when any of the antecedent tasks has completed, you call the static (`Shared` in Visual Basic) <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> method or the instance <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAny%2A?displayProperty=nameWithType> method.</span></span>

<span data-ttu-id="3c1fc-140">Вызовы перегрузок <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> и <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> не блокируют вызывающий поток.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-140">Calls to the <xref:System.Threading.Tasks.Task.WhenAll%2A?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAny%2A?displayProperty=nameWithType> overloads do not block the calling thread.</span></span> <span data-ttu-id="3c1fc-141">Тем не менее обычно вызываются все методы, кроме <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> и <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> для извлечения возвращаемого свойства <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType>, которое не блокирует вызывающий поток.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-141">However, you typically call all but the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> and <xref:System.Threading.Tasks.Task.WhenAll%28System.Threading.Tasks.Task%5B%5D%29?displayProperty=nameWithType> methods to retrieve the returned <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property, which does block the calling thread.</span></span>

<span data-ttu-id="3c1fc-142">В следующем примере вызывается метод <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> для создания задачи продолжения, которая отражает результаты десяти своих предшествующих задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-142">The following example calls the <xref:System.Threading.Tasks.Task.WhenAll%28System.Collections.Generic.IEnumerable%7BSystem.Threading.Tasks.Task%7D%29?displayProperty=nameWithType> method to create a continuation task that reflects the results of its 10 antecedent tasks.</span></span> <span data-ttu-id="3c1fc-143">Каждой предшествующей задаче соответствует значение индекса в диапазоне от 1 до 10.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-143">Each antecedent task squares an index value that ranges from one to 10.</span></span> <span data-ttu-id="3c1fc-144">Если предшествующие задачи завершаются успешно (их свойство <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> имеет значение <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), то свойство <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> продолжения представляет собой массив значений <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> , возвращенных каждой предшествующей задачей.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-144">If the antecedents complete successfully (their <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>), the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the continuation is an array of the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> values returned by each antecedent.</span></span> <span data-ttu-id="3c1fc-145">В этом примере они добавляются для вычисления суммы квадратов всех чисел от 1 до 10.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-145">The example adds them to compute the sum of squares for all numbers between one and 10.</span></span>

:::code language="csharp" source="snippets/cs/whenall1.cs":::

[!code-vb[TPL_Continuations#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/whenall1.vb#5)]

## <a name="continuation-options"></a><span data-ttu-id="3c1fc-146">Параметры продолжения</span><span class="sxs-lookup"><span data-stu-id="3c1fc-146">Continuation options</span></span>

<span data-ttu-id="3c1fc-147">При создании продолжения одной задачи можно использовать перегрузку <xref:System.Threading.Tasks.Task.ContinueWith%2A> , принимающую значение перечисления <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> для указания условий, при которых запускается продолжение.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-147">When you create a single-task continuation, you can use a <xref:System.Threading.Tasks.Task.ContinueWith%2A> overload that takes a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration value to specify the conditions under which the continuation starts.</span></span> <span data-ttu-id="3c1fc-148">Например, вы можете указать, что продолжение должно выполняться только в случае успешного завершения предшествующей задачи или только в случае, если предшествующая задача завершилась в состоянии ошибки.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-148">For example, you can specify that the continuation is to run only if the antecedent completes successfully, or only if it completes in a faulted state.</span></span> <span data-ttu-id="3c1fc-149">Если в момент, когда предшествующая задача готова вызвать продолжение, условие не выполняется, продолжение переходит непосредственно в состояние <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> и после этого не может быть запущено.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-149">If the condition is not true when the antecedent is ready to invoke the continuation, the continuation transitions directly to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state and subsequently cannot be started.</span></span>

<span data-ttu-id="3c1fc-150">Ряд методов продолжения нескольких задач, таких как перегрузки метода <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> , также включает параметр <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-150">A number of multi-task continuation methods, such as overloads of the <xref:System.Threading.Tasks.TaskFactory.ContinueWhenAll%2A?displayProperty=nameWithType> method, also include a <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> parameter.</span></span> <span data-ttu-id="3c1fc-151">Однако допустимым является только подмножество всех членов перечисления <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-151">Only a subset of all <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> enumeration members are valid, however.</span></span> <span data-ttu-id="3c1fc-152">Вы можете указать значения <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> , которые имеют аналоги в перечислении <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> , такие как <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>и <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-152">You can specify <xref:System.Threading.Tasks.TaskContinuationOptions?displayProperty=nameWithType> values that have counterparts in the <xref:System.Threading.Tasks.TaskCreationOptions?displayProperty=nameWithType> enumeration, such as <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType>, <xref:System.Threading.Tasks.TaskContinuationOptions.LongRunning?displayProperty=nameWithType>, and <xref:System.Threading.Tasks.TaskContinuationOptions.PreferFairness?displayProperty=nameWithType>.</span></span> <span data-ttu-id="3c1fc-153">Если указать один из параметров `NotOn` или `OnlyOn` с продолжением нескольких задач, во время выполнения будет вызвано исключение <xref:System.ArgumentOutOfRangeException> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-153">If you specify any of the `NotOn` or `OnlyOn` options with a multi-task continuation, an <xref:System.ArgumentOutOfRangeException> exception will be thrown at run time.</span></span>

<span data-ttu-id="3c1fc-154">Дополнительные сведения о параметрах продолжения задач см. в разделе <xref:System.Threading.Tasks.TaskContinuationOptions> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-154">For more information on task continuation options, see the <xref:System.Threading.Tasks.TaskContinuationOptions> topic.</span></span>

## <a name="pass-data-to-a-continuation"></a><span data-ttu-id="3c1fc-155">Передача данных в продолжение</span><span class="sxs-lookup"><span data-stu-id="3c1fc-155">Pass data to a continuation</span></span>

<span data-ttu-id="3c1fc-156">Метод <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> передает ссылку на предшествующую задачу в пользовательский делегат продолжения в виде аргумента.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-156">The <xref:System.Threading.Tasks.Task.ContinueWith%2A?displayProperty=nameWithType> method passes a reference to the antecedent to the user delegate of the continuation as an argument.</span></span> <span data-ttu-id="3c1fc-157">Если предшествующая задача является объектом <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> и эта задача выполнялась до своего завершения, то продолжение может получить доступ к свойству <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> этой задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-157">If the antecedent is a <xref:System.Threading.Tasks.Task%601?displayProperty=nameWithType> object, and the task ran until it was completed, then the continuation can access the <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property of the task.</span></span>

<span data-ttu-id="3c1fc-158">Свойство <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> блокируется до завершения задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-158">The <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property blocks until the task has completed.</span></span> <span data-ttu-id="3c1fc-159">Однако если задача была отменена или произошел сбой, то попытка доступа к свойству <xref:System.Threading.Tasks.Task%601.Result%2A> вызовет исключение <xref:System.AggregateException> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-159">However, if the task was canceled or faulted, attempting to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property throws an <xref:System.AggregateException> exception.</span></span> <span data-ttu-id="3c1fc-160">Этой проблемы можно избежать, используя параметр <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> , как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-160">You can avoid this problem by using the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnRanToCompletion> option, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/result1.cs":::

[!code-vb[TPL_Continuations#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result1.vb#2)]

<span data-ttu-id="3c1fc-161">Если вы хотите, чтобы продолжение выполнялось, даже если предшествующая задача не выполнилась до успешного завершения, необходимо защититься от этого исключения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-161">If you want the continuation to run even if the antecedent did not run to successful completion, you must guard against the exception.</span></span> <span data-ttu-id="3c1fc-162">Один из подходов заключается в проверке свойства <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> предшествующей задачи и выполнении попытки доступа к свойству <xref:System.Threading.Tasks.Task%601.Result%2A> только в том случае, если предшествующая задача не находится в состоянии <xref:System.Threading.Tasks.TaskStatus.Faulted> или <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-162">One approach is to test the <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of the antecedent, and only attempt to access the <xref:System.Threading.Tasks.Task%601.Result%2A> property if the status is not <xref:System.Threading.Tasks.TaskStatus.Faulted> or <xref:System.Threading.Tasks.TaskStatus.Canceled>.</span></span> <span data-ttu-id="3c1fc-163">Можно также проверять свойство <xref:System.Threading.Tasks.Task.Exception%2A> предшествующей задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-163">You can also examine the <xref:System.Threading.Tasks.Task.Exception%2A> property of the antecedent.</span></span> <span data-ttu-id="3c1fc-164">Дополнительные сведения см. в разделе [Обработка исключений](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-164">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span> <span data-ttu-id="3c1fc-165">В следующем примере изменяется предыдущий пример, чтобы доступ к свойству <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> предшествующей задачи осуществлялся только в том случае, если она находится в состоянии <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-165">The following example modifies the previous example to access antecedent's <xref:System.Threading.Tasks.Task%601.Result%2A?displayProperty=nameWithType> property only if its status is <xref:System.Threading.Tasks.TaskStatus.RanToCompletion?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/result2.cs":::

[!code-vb[TPL_Continuations#7](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/result2.vb#7)]

## <a name="cancel-a-continuation"></a><span data-ttu-id="3c1fc-166">Отмена продолжения</span><span class="sxs-lookup"><span data-stu-id="3c1fc-166">Cancel a continuation</span></span>

<span data-ttu-id="3c1fc-167">Свойство <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> продолжения устанавливается в значение <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> в следующих ситуациях.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-167">The <xref:System.Threading.Tasks.Task.Status%2A?displayProperty=nameWithType> property of a continuation is set to <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> in the following situations:</span></span>

- <span data-ttu-id="3c1fc-168">В ответ на запрос отмены вызывается исключение <xref:System.OperationCanceledException> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-168">It throws an <xref:System.OperationCanceledException> exception in response to a cancellation request.</span></span> <span data-ttu-id="3c1fc-169">Как и в любой другой задаче, если исключение содержит тот же токен, что и переданный в продолжение, то он рассматривается как подтверждение совместной отмены.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-169">As with any task, if the exception contains the same token that was passed to the continuation, it is treated as an acknowledgment of cooperative cancellation.</span></span>
- <span data-ttu-id="3c1fc-170">Продолжение передает объект <xref:System.Threading.CancellationToken?displayProperty=nameWithType> , свойство <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> которого имеет значение `true`.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-170">The continuation is passed a <xref:System.Threading.CancellationToken?displayProperty=nameWithType> whose <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property is `true`.</span></span> <span data-ttu-id="3c1fc-171">В этом случае продолжение не запускается и переходит в состояние <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-171">In this case, the continuation does not start, and it transitions to the <xref:System.Threading.Tasks.TaskStatus.Canceled?displayProperty=nameWithType> state.</span></span>
- <span data-ttu-id="3c1fc-172">Продолжение никогда не запускается, поскольку условие, заданное его аргументом <xref:System.Threading.Tasks.TaskContinuationOptions> , не выполнено.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-172">The continuation never runs because the condition set by its <xref:System.Threading.Tasks.TaskContinuationOptions> argument was not met.</span></span> <span data-ttu-id="3c1fc-173">Например, если предшествующая задача переходит в состояние <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> , ее продолжение, которое передало параметр <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> , не будет выполняться, но перейдет в состояние <xref:System.Threading.Tasks.TaskStatus.Canceled> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-173">For example, if an antecedent goes into a <xref:System.Threading.Tasks.TaskStatus.Faulted?displayProperty=nameWithType> state, its continuation that was passed the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnFaulted?displayProperty=nameWithType> option will not run but will transition to the <xref:System.Threading.Tasks.TaskStatus.Canceled> state.</span></span>

<span data-ttu-id="3c1fc-174">Если задача и ее продолжение представляют две части одной логической операции, вы можете передать один и тот же токен отмены в обе задачи, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-174">If a task and its continuation represent two parts of the same logical operation, you can pass the same cancellation token to both tasks, as shown in the following example.</span></span> <span data-ttu-id="3c1fc-175">В нем имеется предшествующая задача, создающая список целых чисел, кратных 33, который передается в продолжение.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-175">It consists of an antecedent that generates a list of integers that are divisible by 33, which it passes to the continuation.</span></span> <span data-ttu-id="3c1fc-176">Продолжение, в свою очередь, отображает этот список.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-176">The continuation in turn displays the list.</span></span> <span data-ttu-id="3c1fc-177">И предшествующая задача, и продолжение регулярно приостанавливаются на произвольные периоды времени.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-177">Both the antecedent and the continuation pause regularly for random intervals.</span></span> <span data-ttu-id="3c1fc-178">Кроме того, используется объект <xref:System.Threading.Timer?displayProperty=nameWithType> для выполнения метода `Elapsed` после пятисекундного времени ожидания.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-178">In addition, a <xref:System.Threading.Timer?displayProperty=nameWithType> object is used to execute the `Elapsed` method after a five-second timeout interval.</span></span> <span data-ttu-id="3c1fc-179">В этом примере вызывается метод <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType>, который приводит к тому, что текущая выполняющаяся задача вызывает метод <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-179">This example calls the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method, which causes the currently executing task to call the <xref:System.Threading.CancellationToken.ThrowIfCancellationRequested%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="3c1fc-180">В зависимости от длительности произвольно создаваемых пауз метод <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> вызывается при выполнении либо предшествующей задачи, либо ее продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-180">Whether the <xref:System.Threading.CancellationTokenSource.Cancel%2A?displayProperty=nameWithType> method is called when the antecedent or its continuation is executing depends on the duration of the randomly generated pauses.</span></span> <span data-ttu-id="3c1fc-181">Если предшествующая задача отменена, продолжение не запустится.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-181">If the antecedent is canceled, the continuation will not start.</span></span> <span data-ttu-id="3c1fc-182">Если предшествующая задача не отменена, токен еще можно использовать для отмены продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-182">If the antecedent is not canceled, the token can still be used to cancel the continuation.</span></span>

:::code language="csharp" source="snippets/cs/cancellation1.cs":::

[!code-vb[TPL_Continuations#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation1.vb#3)]

<span data-ttu-id="3c1fc-183">Вы также можете запретить выполнение продолжения в случае отмены его предшествующей задачи без передачи в продолжение токена отмены, указав параметр <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> при создании продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-183">You can also prevent a continuation from executing if its antecedent is canceled without supplying the continuation a cancellation token by specifying the <xref:System.Threading.Tasks.TaskContinuationOptions.NotOnCanceled?displayProperty=nameWithType> option when you create the continuation.</span></span> <span data-ttu-id="3c1fc-184">Ниже приведен простой пример.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-184">The following is a simple example.</span></span>

:::code language="csharp" source="snippets/cs/cancellation2.cs":::

[!code-vb[TPL_Continuations#8](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/cancellation2.vb#8)]

<span data-ttu-id="3c1fc-185">После перехода продолжения в состояние <xref:System.Threading.Tasks.TaskStatus.Canceled> это может повлиять на последующие продолжения, в зависимости от <xref:System.Threading.Tasks.TaskContinuationOptions> , указанных для этих продолжений.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-185">After a continuation goes into the <xref:System.Threading.Tasks.TaskStatus.Canceled> state, it may affect continuations that follow, depending on the <xref:System.Threading.Tasks.TaskContinuationOptions> that were specified for those continuations.</span></span>

<span data-ttu-id="3c1fc-186">Освобожденные продолжения не будут запускаться.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-186">Continuations that are disposed will not start.</span></span>

## <a name="continuations-and-child-tasks"></a><span data-ttu-id="3c1fc-187">Продолжения и дочерние задачи</span><span class="sxs-lookup"><span data-stu-id="3c1fc-187">Continuations and child tasks</span></span>

<span data-ttu-id="3c1fc-188">Продолжение не выполняется до завершения предшествующей задачи и всех ее присоединенных дочерних задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-188">A continuation does not run until the antecedent and all of its attached child tasks have completed.</span></span> <span data-ttu-id="3c1fc-189">Продолжение не ожидает завершения отсоединенных дочерних задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-189">The continuation does not wait for detached child tasks to finish.</span></span> <span data-ttu-id="3c1fc-190">В следующих двух примерах показаны дочерние задачи, присоединенные к предшествующей задаче, создающей продолжение, и отсоединенные от нее.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-190">The following two examples illustrate child tasks that are attached to and detached from an antecedent that creates a continuation.</span></span> <span data-ttu-id="3c1fc-191">В следующем примере продолжение выполняется только после завершения всех дочерних задач, и многократное выполнение примера каждый раз приводит к одному и тому же результату.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-191">In the following example, the continuation runs only after all child tasks have completed, and running the example multiple times produces identical output each time.</span></span> <span data-ttu-id="3c1fc-192">В этом примере предшествующая задача запускается путем вызова метода <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType>, поскольку по умолчанию метод <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> создает родительскую задачу, которая имеет параметр создания задачи по умолчанию <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-192">The example launches the antecedent by calling the <xref:System.Threading.Tasks.TaskFactory.StartNew%2A?displayProperty=nameWithType> method, since by default the <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> method creates a parent task whose default task creation option is <xref:System.Threading.Tasks.TaskCreationOptions.DenyChildAttach?displayProperty=nameWithType>.</span></span>

:::code language="csharp" source="snippets/cs/attached1.cs":::

[!code-vb[TPL_Continuations#9](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/attached1.vb#9)]

<span data-ttu-id="3c1fc-193">Если дочерние задачи отсоединены от предшествующей задачи, продолжение выполняется сразу после завершения предшествующей задачи независимо от состояния дочерних задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-193">If child tasks are detached from the antecedent, however, the continuation runs as soon as the antecedent has terminated, regardless of the state of the child tasks.</span></span> <span data-ttu-id="3c1fc-194">В результате после нескольких запусков следующего примера могут создаваться разные выходные данные, в зависимости от того, как планировщик задач обработал каждую дочернюю задачу.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-194">As a result, multiple runs of the following example can produce variable output that depends on how the task scheduler handled each child task.</span></span>

:::code language="csharp" source="snippets/cs/detached1.cs":::

[!code-vb[TPL_Continuations#10](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/detached1.vb#10)]

<span data-ttu-id="3c1fc-195">Конечное состояние предшествующей задачи зависит от конечного состояния всех присоединенных дочерних задач.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-195">The final status of the antecedent task depends on the final status of any attached child tasks.</span></span> <span data-ttu-id="3c1fc-196">Состояние отсоединенных дочерних задач не влияет на родительскую задачу.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-196">The status of detached child tasks does not affect the parent.</span></span> <span data-ttu-id="3c1fc-197">Дополнительные сведения см. в разделе [Присоединенные и отсоединенные дочерние задачи](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-197">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="associate-state-with-continuations"></a><span data-ttu-id="3c1fc-198">Связывание состояния с продолжениями</span><span class="sxs-lookup"><span data-stu-id="3c1fc-198">Associate state with continuations</span></span>

<span data-ttu-id="3c1fc-199">Вы можете связывать произвольное состояние с продолжением задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-199">You can associate arbitrary state with a task continuation.</span></span> <span data-ttu-id="3c1fc-200">Метод <xref:System.Threading.Tasks.Task.ContinueWith%2A> предоставляет перегруженные версии, каждая из которых принимает значение <xref:System.Object> , представляющее состояние продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-200">The <xref:System.Threading.Tasks.Task.ContinueWith%2A> method provides overloaded versions that each take an <xref:System.Object> value that represents the state of the continuation.</span></span> <span data-ttu-id="3c1fc-201">Позднее можно получить доступ к этому объекту состояния с помощью свойства <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-201">You can later access this state object by using the <xref:System.Threading.Tasks.Task.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="3c1fc-202">Если значение не предоставлено, то этот объект состояния имеет значение `null` .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-202">This state object is `null` if you do not provide a value.</span></span>

<span data-ttu-id="3c1fc-203">Состояние продолжения полезно при преобразовании существующего кода, который  использует библиотеку параллельных задач с помощью [асинхронной модели программирования (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-203">Continuation state is useful when you convert existing code that uses the [Asynchronous Programming Model (APM)](../asynchronous-programming-patterns/asynchronous-programming-model-apm.md) to use the TPL.</span></span> <span data-ttu-id="3c1fc-204">В APM объект состояния обычно предоставляется в метод **Begin**_Method_, а впоследствии доступ к этому состоянию получается с помощью свойства <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-204">In the APM, you typically provide object state in the **Begin**_Method_ method and later access that state by using the <xref:System.IAsyncResult.AsyncState%2A?displayProperty=nameWithType> property.</span></span> <span data-ttu-id="3c1fc-205">С помощью метода <xref:System.Threading.Tasks.Task.ContinueWith%2A> можно сохранить это состояние при преобразовании кода,  использующего библиотеку параллельных задач с помощью  APM.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-205">By using the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method, you can preserve this state when you convert code that uses the APM to use the TPL.</span></span>

<span data-ttu-id="3c1fc-206">Состояние продолжения также можно использовать при работе с объектами <xref:System.Threading.Tasks.Task> в отладчике Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-206">Continuation state can also be useful when you work with <xref:System.Threading.Tasks.Task> objects in the Visual Studio debugger.</span></span> <span data-ttu-id="3c1fc-207">Например, в окне **Параллельные задачи** столбец **Задачи** отображает строковое представление объекта состояния для каждой задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-207">For example, in the **Parallel Tasks** window, the **Task** column displays the string representation of the state object for each task.</span></span> <span data-ttu-id="3c1fc-208">Дополнительные сведения об окне **Параллельные задачи** см. в разделе [Использование окна задач](/visualstudio/debugger/using-the-tasks-window).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-208">For more information about the **Parallel Tasks** window, see [Using the Tasks Window](/visualstudio/debugger/using-the-tasks-window).</span></span>

<span data-ttu-id="3c1fc-209">В следующем примере демонстрируется использование состояния продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-209">The following example shows how to use continuation state.</span></span> <span data-ttu-id="3c1fc-210">В нем создается цепочка задач продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-210">It creates a chain of continuation tasks.</span></span> <span data-ttu-id="3c1fc-211">Каждая задача предоставляет текущее время в объекте <xref:System.DateTime> для параметра `state` метода <xref:System.Threading.Tasks.Task.ContinueWith%2A> .</span><span class="sxs-lookup"><span data-stu-id="3c1fc-211">Each task provides the current time, a <xref:System.DateTime> object, for the `state` parameter of the <xref:System.Threading.Tasks.Task.ContinueWith%2A> method.</span></span> <span data-ttu-id="3c1fc-212">Каждый объект <xref:System.DateTime> представляет время, в которое создана задача продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-212">Each <xref:System.DateTime> object represents the time at which the continuation task is created.</span></span> <span data-ttu-id="3c1fc-213">Каждая задача в результате создает второй объект <xref:System.DateTime> , представляющий время, в которое эта задача завершена.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-213">Each task produces as its result a second <xref:System.DateTime> object that represents the time at which the task finishes.</span></span> <span data-ttu-id="3c1fc-214">После завершения всех задач в этом примере отображается время создания и время завершения каждой задачи продолжения.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-214">After all tasks finish, this example displays the creation time and the time at which each continuation task finishes.</span></span>

:::code language="csharp" source="snippets/cs/continuationstate.cs":::

[!code-vb[TPL_ContinuationState#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuationstate/vb/continuationstate.vb#1)]

## <a name="continuations-that-return-task-types"></a><span data-ttu-id="3c1fc-215">Продолжения, возвращающие типы Task</span><span class="sxs-lookup"><span data-stu-id="3c1fc-215">Continuations that return Task types</span></span>

<span data-ttu-id="3c1fc-216">Иногда может потребоваться создать цепочку продолжения, возвращающую тип <xref:System.Threading.Tasks.Task>.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-216">Sometimes you may need to chain a continuation that returns a <xref:System.Threading.Tasks.Task> type.</span></span> <span data-ttu-id="3c1fc-217">Это называется вложенными задачами, которые являются общими.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-217">These are referred to as nested tasks, and they are common.</span></span> <span data-ttu-id="3c1fc-218">Когда родительская задача вызывает <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType> и предоставляет `continuationFunction`, это значит, что задача возвращает вызов <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A>, чтобы создать дополнительную задачу по выполнению асинхронной операции `<Task<Task<T>>>` или `Task(Of Task(Of T))` (в Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-218">When a parent task calls <xref:System.Threading.Tasks.Task%601.ContinueWith%2A?displayProperty=nameWithType>, and provides a `continuationFunction` that is task returning you call <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> to create a proxy task that represents the asynchronous operation of the `<Task<Task<T>>>` or `Task(Of Task(Of T))` (Visual Basic).</span></span>

<span data-ttu-id="3c1fc-219">В следующем примере показано, как использовать продолжения, которые оборачивают функции, возвращающие дополнительные задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-219">The following example shows how to use continuations that wrap additional task returning functions.</span></span> <span data-ttu-id="3c1fc-220">Продолжение можно развернуть, чтобы посмотреть содержащиеся в нем задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-220">Each continuation can be unwrapped, exposing the inner task that was wrapped.</span></span>

:::code language="csharp" source="snippets/cs/unwrap.cs":::
:::code language="vb" source="snippets/vb/unwrap.vb":::

<span data-ttu-id="3c1fc-221">Дополнительные сведения об использовании метода <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A> см. в статье [Практическое руководство. Извлечение вложенной задачи из оболочки](how-to-unwrap-a-nested-task.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-221">For more information on using <xref:System.Threading.Tasks.TaskExtensions.Unwrap%2A>, see [How to: Unwrap a nested Task](how-to-unwrap-a-nested-task.md).</span></span>

## <a name="handle-exceptions-thrown-from-continuations"></a><span data-ttu-id="3c1fc-222">Обработка исключений, вызванных из продолжений</span><span class="sxs-lookup"><span data-stu-id="3c1fc-222">Handle exceptions thrown from continuations</span></span>

<span data-ttu-id="3c1fc-223">Отношение предшествующей задачи и продолжения не является связью типа «родитель — потомок».</span><span class="sxs-lookup"><span data-stu-id="3c1fc-223">An antecedent-continuation relationship is not a parent-child relationship.</span></span> <span data-ttu-id="3c1fc-224">Исключения, вызванные продолжениями, не распространяются в предшествующую задачу.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-224">Exceptions thrown by continuations are not propagated to the antecedent.</span></span> <span data-ttu-id="3c1fc-225">Таким образом, следует обрабатывать вызванные продолжениями исключения так, как они обрабатываются в любой другой задаче, следующим образом.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-225">Therefore, handle exceptions thrown by continuations as you would handle them in any other task, as follows:</span></span>

- <span data-ttu-id="3c1fc-226">Для ожидания продолжения можно использовать метод <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, или <xref:System.Threading.Tasks.Task.WaitAny%2A> , либо его универсальный эквивалент.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-226">You can use the <xref:System.Threading.Tasks.Task.Wait%2A>, <xref:System.Threading.Tasks.Task.WaitAll%2A>, or <xref:System.Threading.Tasks.Task.WaitAny%2A> method, or its generic counterpart, to wait on the continuation.</span></span> <span data-ttu-id="3c1fc-227">Вы можете ожидать предшествующую задачу и ее продолжение в одном операторе `try` , как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-227">You can wait for an antecedent and its continuations in the same `try` statement, as shown in the following example.</span></span>

:::code language="csharp" source="snippets/cs/exception1.cs":::

[!code-vb[TPL_Continuations#6](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception1.vb#6)]

- <span data-ttu-id="3c1fc-228">Для наблюдения за свойством <xref:System.Threading.Tasks.Task.Exception%2A> первого продолжения можно использовать второе продолжение.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-228">You can use a second continuation to observe the <xref:System.Threading.Tasks.Task.Exception%2A> property of the first continuation.</span></span> <span data-ttu-id="3c1fc-229">В следующем примере задача пытается выполнить чтение в несуществующем файле.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-229">In the following example, a task attempts to read from a non-existent file.</span></span> <span data-ttu-id="3c1fc-230">Затем продолжение отображает сведения об исключении в предшествующей задаче.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-230">The continuation then displays information about the exception in the antecedent task.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="example":::

[!code-vb[TPL_Continuations#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#4)]

<span data-ttu-id="3c1fc-231">Так как она была запущена с параметром <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> , продолжение выполняется только в том случае, если в предшествующей задаче возникает исключение, и поэтому можно предполагать, что свойство <xref:System.Threading.Tasks.Task.Exception%2A> предшествующей задачи не имеет значение `null`.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-231">Because it was run with the <xref:System.Threading.Tasks.TaskContinuationOptions.OnlyOnFaulted?displayProperty=nameWithType> option, the continuation executes only if an exception occurs in the antecedent, and therefore it can assume that the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null`.</span></span> <span data-ttu-id="3c1fc-232">Если продолжение выполняется независимо от того, вызывалось ли исключение в предшествующей задаче, то перед попыткой обработки исключения оно должно проверить, что свойство <xref:System.Threading.Tasks.Task.Exception%2A> не имеет значение `null` , как показано в следующем фрагменте кода.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-232">If the continuation executes whether or not an exception is thrown in the antecedent, it would have to check whether the antecedent's <xref:System.Threading.Tasks.Task.Exception%2A> property is not `null` before attempting to handle the exception, as the following code fragment shows.</span></span>

:::code language="csharp" source="snippets/cs/exception2.cs" id="exception":::

[!code-vb[TPL_Continuations#11](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_continuations/vb/exception2.vb#11)]

<span data-ttu-id="3c1fc-233">Дополнительные сведения см. в разделе [Обработка исключений](exception-handling-task-parallel-library.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-233">For more information, see [Exception Handling](exception-handling-task-parallel-library.md).</span></span>

- <span data-ttu-id="3c1fc-234">Если продолжение является присоединенной дочерней задачей, созданной с использованием параметра <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> , его исключения будут распространяться родительской задачей обратно в вызывающий поток, как и в случае любой другой присоединенной дочерней задачи.</span><span class="sxs-lookup"><span data-stu-id="3c1fc-234">If the continuation is an attached child task that was created by using the <xref:System.Threading.Tasks.TaskContinuationOptions.AttachedToParent?displayProperty=nameWithType> option, its exceptions will be propagated by the parent back to the calling thread, as is the case in any other attached child.</span></span> <span data-ttu-id="3c1fc-235">Дополнительные сведения см. в разделе [Присоединенные и отсоединенные дочерние задачи](attached-and-detached-child-tasks.md).</span><span class="sxs-lookup"><span data-stu-id="3c1fc-235">For more information, see [Attached and Detached Child Tasks](attached-and-detached-child-tasks.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="3c1fc-236">См. также</span><span class="sxs-lookup"><span data-stu-id="3c1fc-236">See also</span></span>

- [<span data-ttu-id="3c1fc-237">Библиотека параллельных задач (TPL)</span><span class="sxs-lookup"><span data-stu-id="3c1fc-237">Task Parallel Library (TPL)</span></span>](task-parallel-library-tpl.md)
