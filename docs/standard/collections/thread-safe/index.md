---
title: Потокобезопасные коллекции
ms.date: 03/30/2017
ms.technology: dotnet-standard
helpviewer_keywords:
- thread-safe collections, overview
ms.assetid: 2e7ca21f-786c-4367-96be-0cf3f3dcc6bd
author: mairaw
ms.author: mairaw
ms.openlocfilehash: 7fad67c1a3c53cd83dec6bfa161333b5e20ab4c4
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61644715"
---
# <a name="thread-safe-collections"></a><span data-ttu-id="7b2c0-102">Потокобезопасные коллекции</span><span class="sxs-lookup"><span data-stu-id="7b2c0-102">Thread-Safe Collections</span></span>
<span data-ttu-id="7b2c0-103">В [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] введено пространство имен <xref:System.Collections.Concurrent?displayProperty=nameWithType>, включающее несколько потокобезопасных и масштабируемых классов коллекций.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-103">The [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] introduces the <xref:System.Collections.Concurrent?displayProperty=nameWithType> namespace, which includes several collection classes that are both thread-safe and scalable.</span></span> <span data-ttu-id="7b2c0-104">Несколько потоков могут безопасно и эффективно добавлять и удалять элементы из таких коллекций, не требуя при этом дополнительной синхронизации в пользовательском коде.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-104">Multiple threads can safely and efficiently add or remove items from these collections, without requiring additional synchronization in user code.</span></span> <span data-ttu-id="7b2c0-105">При написании нового кода пользуйтесь классами параллельных коллекций, когда множество потоков будет вести в коллекцию запись параллельно.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-105">When you write new code, use the concurrent collection classes whenever multiple threads will write to the collection concurrently.</span></span> <span data-ttu-id="7b2c0-106">Если выполняется только чтение из общей коллекции, вы можете использовать классы в пространстве имен <xref:System.Collections.Generic?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-106">If you are only reading from a shared collection, then you can use the classes in the <xref:System.Collections.Generic?displayProperty=nameWithType> namespace.</span></span> <span data-ttu-id="7b2c0-107">Мы рекомендуем использовать классы коллекций версии 1.0 только в том случае, если вам нужна среда выполнения .NET Framework до версии 1.1 включительно.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-107">We recommend that you do not use 1.0 collection classes unless you are required to target the .NET Framework 1.1 or earlier runtime.</span></span>  
  
## <a name="thread-synchronization-in-the-net-framework-10-and-20-collections"></a><span data-ttu-id="7b2c0-108">Синхронизация потоков в коллекциях .NET Framework версий 1.0 и 2.0</span><span class="sxs-lookup"><span data-stu-id="7b2c0-108">Thread Synchronization in the .NET Framework 1.0 and 2.0 Collections</span></span>  
 <span data-ttu-id="7b2c0-109">Коллекции, представленные в .NET Framework 1.0, находятся в пространстве имен <xref:System.Collections?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-109">The collections introduced in the .NET Framework 1.0 are found in the <xref:System.Collections?displayProperty=nameWithType> namespace.</span></span> <span data-ttu-id="7b2c0-110">Эти коллекции, которые содержат часто используемые классы <xref:System.Collections.ArrayList> и <xref:System.Collections.Hashtable>, обеспечивают определенную степень потокобезопасности посредством свойства `Synchronized`, которое создает для коллекции потокобезопасную программу-оболочку.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-110">These collections, which include the commonly used <xref:System.Collections.ArrayList> and <xref:System.Collections.Hashtable>, provide some thread-safety through the `Synchronized` property, which returns a thread-safe wrapper around the collection.</span></span> <span data-ttu-id="7b2c0-111">Работа программы оболочки заключается в блокировке всей коллекции при каждой операции добавления или удаления.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-111">The wrapper works by locking the entire collection on every add or remove operation.</span></span> <span data-ttu-id="7b2c0-112">Поэтому каждый поток, который пытается получить доступ к коллекции, должен ждать своей очереди для получения блокировки.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-112">Therefore, each thread that is attempting to access the collection must wait for its turn to take the one lock.</span></span> <span data-ttu-id="7b2c0-113">Такой подход не является масштабируемым и может привести к значительному снижению производительности для больших коллекций.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-113">This is not scalable and can cause significant performance degradation for large collections.</span></span> <span data-ttu-id="7b2c0-114">Также такой подход не защищен полностью от состояния гонки.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-114">Also, the design is not completely protected from race conditions.</span></span> <span data-ttu-id="7b2c0-115">Дополнительные сведения см. в статье [Синхронизация в универсальных коллекциях](https://blogs.msdn.microsoft.com/bclteam/2005/03/15/synchronization-in-generic-collections-brian-grunkemeyer/).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-115">For more information, see [Synchronization in Generic Collections](https://blogs.msdn.microsoft.com/bclteam/2005/03/15/synchronization-in-generic-collections-brian-grunkemeyer/).</span></span>  
  
 <span data-ttu-id="7b2c0-116">Классы коллекций, представленные в .NET Framework 2.0, находятся в пространстве имен <xref:System.Collections.Generic?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-116">The collection classes introduced in the .NET Framework 2.0 are found in the <xref:System.Collections.Generic?displayProperty=nameWithType> namespace.</span></span> <span data-ttu-id="7b2c0-117">К ним относятся <xref:System.Collections.Generic.List%601>, <xref:System.Collections.Generic.Dictionary%602> и др.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-117">These include <xref:System.Collections.Generic.List%601>, <xref:System.Collections.Generic.Dictionary%602>, and so on.</span></span> <span data-ttu-id="7b2c0-118">Эти классы отличаются улучшенной безопасностью типа и производительностью по сравнению с классами .NET Framework 1.0.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-118">These classes provide improved type safety and performance compared to the .NET Framework 1.0 classes.</span></span> <span data-ttu-id="7b2c0-119">Однако классы коллекций .NET Framework 2.0 не обеспечивают синхронизацию потоков. Пользовательский код должен обеспечивать всю синхронизацию при параллельном добавлении элементов в несколько потоков или удалении элементов из них.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-119">However, the .NET Framework 2.0 collection classes do not provide any thread synchronization; user code must provide all synchronization when items are added or removed on multiple threads concurrently.</span></span>  
  
 <span data-ttu-id="7b2c0-120">Мы рекомендуем использовать классы параллельных коллекций [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)], так как они предоставляют не только безопасность типа классов NET Framework 2.0, но и большую эффективность, более полную потокобезопасность по сравнению с коллекциями [!INCLUDE[net_v10_short](../../../../includes/net-v10-short-md.md)].</span><span class="sxs-lookup"><span data-stu-id="7b2c0-120">We recommend the concurrent collections classes in the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)] because they provide not only the type safety of the .NET Framework 2.0 collection classes, but also more efficient and more complete thread safety than the [!INCLUDE[net_v10_short](../../../../includes/net-v10-short-md.md)] collections provide.</span></span>  
  
## <a name="fine-grained-locking-and-lock-free-mechanisms"></a><span data-ttu-id="7b2c0-121">Механизм блокировки мелких фрагментов данных и механизм, свободный от блокировки</span><span class="sxs-lookup"><span data-stu-id="7b2c0-121">Fine-Grained Locking and Lock-Free Mechanisms</span></span>  
 <span data-ttu-id="7b2c0-122">Некоторые типы многопоточных коллекций используют упрощенные механизмы синхронизации, например <xref:System.Threading.SpinLock>, <xref:System.Threading.SpinWait>, <xref:System.Threading.SemaphoreSlim> и <xref:System.Threading.CountdownEvent>, которые впервые введены в [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].</span><span class="sxs-lookup"><span data-stu-id="7b2c0-122">Some of the concurrent collection types use lightweight synchronization mechanisms such as <xref:System.Threading.SpinLock>, <xref:System.Threading.SpinWait>, <xref:System.Threading.SemaphoreSlim>, and <xref:System.Threading.CountdownEvent>, which are new in the [!INCLUDE[net_v40_short](../../../../includes/net-v40-short-md.md)].</span></span> <span data-ttu-id="7b2c0-123">Эти типы синхронизации обычно используют *цикличную работу* для коротких промежутков перед помещением потока в фактическое состояние ожидания.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-123">These synchronization types typically use *busy spinning* for brief periods before they put the thread into a true Wait state.</span></span> <span data-ttu-id="7b2c0-124">При условии, что время ожидания предполагается очень коротким, цикличность требует значительно меньших затрат компьютерных ресурсов, чем ожидание, которое включает в себя переход в режим ядра, требующий больших затрат компьютерных ресурсов.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-124">When wait times are expected to be very short, spinning is far less computationally expensive than waiting, which involves an expensive kernel transition.</span></span> <span data-ttu-id="7b2c0-125">Для классов коллекций, которые используют цикличность, эта эффективность означает, что множество потоков могут добавлять и удалять большое количество элементов.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-125">For collection classes that use spinning, this efficiency means that multiple threads can add and remove items at a very high rate.</span></span> <span data-ttu-id="7b2c0-126">Дополнительные сведения о цикличности и блокировках см. в статья [SpinLock](../../../../docs/standard/threading/spinlock.md) и [SpinWait](../../../../docs/standard/threading/spinwait.md).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-126">For more information about spinning vs. blocking, see [SpinLock](../../../../docs/standard/threading/spinlock.md) and [SpinWait](../../../../docs/standard/threading/spinwait.md).</span></span>  
  
 <span data-ttu-id="7b2c0-127">Классы <xref:System.Collections.Concurrent.ConcurrentQueue%601> и <xref:System.Collections.Concurrent.ConcurrentStack%601> не используют блокировку.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-127">The <xref:System.Collections.Concurrent.ConcurrentQueue%601> and <xref:System.Collections.Concurrent.ConcurrentStack%601> classes do not use locks at all.</span></span> <span data-ttu-id="7b2c0-128">Вместо этого они используют операции класса <xref:System.Threading.Interlocked> для обеспечения потокобезопасности.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-128">Instead, they rely on <xref:System.Threading.Interlocked> operations to achieve thread-safety.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="7b2c0-129">Так как классы многопоточных коллекций поддерживают интерфейс <xref:System.Collections.ICollection>, они включают реализации для свойств <xref:System.Collections.ICollection.IsSynchronized%2A> и <xref:System.Collections.ICollection.SyncRoot%2A>, даже хотя эти свойства никак не используются.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-129">Because the concurrent collections classes support <xref:System.Collections.ICollection>, they provide implementations for the <xref:System.Collections.ICollection.IsSynchronized%2A> and <xref:System.Collections.ICollection.SyncRoot%2A> properties, even though these properties are irrelevant.</span></span> <span data-ttu-id="7b2c0-130">`IsSynchronized` всегда возвращает `false`, а `SyncRoot` всегда имеет значение `null` (`Nothing` в Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-130">`IsSynchronized` always returns `false` and `SyncRoot` is always `null` (`Nothing` in Visual Basic).</span></span>  
  
 <span data-ttu-id="7b2c0-131">В следующей таблице перечислены типы коллекций в пространстве имен <xref:System.Collections.Concurrent?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-131">The following table lists the collection types in the <xref:System.Collections.Concurrent?displayProperty=nameWithType> namespace.</span></span>  
  
|<span data-ttu-id="7b2c0-132">Тип</span><span class="sxs-lookup"><span data-stu-id="7b2c0-132">Type</span></span>|<span data-ttu-id="7b2c0-133">Описание</span><span class="sxs-lookup"><span data-stu-id="7b2c0-133">Description</span></span>|  
|----------|-----------------|  
|<xref:System.Collections.Concurrent.BlockingCollection%601>|<span data-ttu-id="7b2c0-134">Предоставляет возможности блокировки и ограничения для всех типов, реализующих интерфейс <xref:System.Collections.Concurrent.IProducerConsumerCollection%601>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-134">Provides bounding and blocking functionality for any type that implements <xref:System.Collections.Concurrent.IProducerConsumerCollection%601>.</span></span> <span data-ttu-id="7b2c0-135">Дополнительные сведения см. в разделе [Общие сведения о коллекции BlockingCollection](../../../../docs/standard/collections/thread-safe/blockingcollection-overview.md).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-135">For more information, see [BlockingCollection Overview](../../../../docs/standard/collections/thread-safe/blockingcollection-overview.md).</span></span>|  
|<xref:System.Collections.Concurrent.ConcurrentDictionary%602>|<span data-ttu-id="7b2c0-136">Потокобезопасная реализация словаря пар "ключ-значение".</span><span class="sxs-lookup"><span data-stu-id="7b2c0-136">Thread-safe implementation of a dictionary of key-value pairs.</span></span>|  
|<xref:System.Collections.Concurrent.ConcurrentQueue%601>|<span data-ttu-id="7b2c0-137">Потокобезопасная реализация очереди с типом "первым поступил — первым обслужен" (FIFO).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-137">Thread-safe implementation of a FIFO (first-in, first-out) queue.</span></span>|  
|<xref:System.Collections.Concurrent.ConcurrentStack%601>|<span data-ttu-id="7b2c0-138">Потокобезопасная реализация стека с типом "последним поступил — первым обслужен" (LIFO).</span><span class="sxs-lookup"><span data-stu-id="7b2c0-138">Thread-safe implementation of a LIFO (last-in, first-out) stack.</span></span>|  
|<xref:System.Collections.Concurrent.ConcurrentBag%601>|<span data-ttu-id="7b2c0-139">Потокобезопасная реализация неупорядоченной коллекции элементов.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-139">Thread-safe implementation of an unordered collection of elements.</span></span>|  
|<xref:System.Collections.Concurrent.IProducerConsumerCollection%601>|<span data-ttu-id="7b2c0-140">Это интерфейс, тип которого должен быть реализован для использования в классе `BlockingCollection`.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-140">The interface that a type must implement to be used in a `BlockingCollection`.</span></span>|  
  
## <a name="related-topics"></a><span data-ttu-id="7b2c0-141">См. также</span><span class="sxs-lookup"><span data-stu-id="7b2c0-141">Related Topics</span></span>  
  
|<span data-ttu-id="7b2c0-142">Заголовок</span><span class="sxs-lookup"><span data-stu-id="7b2c0-142">Title</span></span>|<span data-ttu-id="7b2c0-143">Описание</span><span class="sxs-lookup"><span data-stu-id="7b2c0-143">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="7b2c0-144">Общие сведения о коллекции BlockingCollection</span><span class="sxs-lookup"><span data-stu-id="7b2c0-144">BlockingCollection Overview</span></span>](../../../../docs/standard/collections/thread-safe/blockingcollection-overview.md)|<span data-ttu-id="7b2c0-145">Приводится описание функциональных возможностей, которые предоставляются типом <xref:System.Collections.Concurrent.BlockingCollection%601>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-145">Describes the functionality provided by the <xref:System.Collections.Concurrent.BlockingCollection%601> type.</span></span>|  
|[<span data-ttu-id="7b2c0-146">Практическое руководство. Добавление элементов в коллекцию ConcurrentDictionary и их удаление из этой коллекции</span><span class="sxs-lookup"><span data-stu-id="7b2c0-146">How to: Add and Remove Items from a ConcurrentDictionary</span></span>](../../../../docs/standard/collections/thread-safe/how-to-add-and-remove-items.md)|<span data-ttu-id="7b2c0-147">Приводится описание добавления и удаления элементов в классе <xref:System.Collections.Concurrent.ConcurrentDictionary%602></span><span class="sxs-lookup"><span data-stu-id="7b2c0-147">Describes how to add and remove elements from a <xref:System.Collections.Concurrent.ConcurrentDictionary%602></span></span>|  
|[<span data-ttu-id="7b2c0-148">Практическое руководство. Добавление и удаление отдельных элементов коллекции BlockingCollection</span><span class="sxs-lookup"><span data-stu-id="7b2c0-148">How to: Add and Take Items Individually from a BlockingCollection</span></span>](../../../../docs/standard/collections/thread-safe/how-to-add-and-take-items.md)|<span data-ttu-id="7b2c0-149">Приводится описание порядка добавления и получения элементов из заблокированной коллекции без использования перечислителя, доступного только для чтения.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-149">Describes how to add and retrieve items from a blocking collection without using the read-only enumerator.</span></span>|  
|[<span data-ttu-id="7b2c0-150">Практическое руководство. Добавление функций границы и блокировки в коллекцию</span><span class="sxs-lookup"><span data-stu-id="7b2c0-150">How to: Add Bounding and Blocking Functionality to a Collection</span></span>](../../../../docs/standard/collections/thread-safe/how-to-add-bounding-and-blocking.md)|<span data-ttu-id="7b2c0-151">Приводится описание порядка использования всех классов коллекций в качестве базового механизма хранения для коллекции <xref:System.Collections.Concurrent.IProducerConsumerCollection%601>.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-151">Describes how to use any collection class as the underlying storage mechanism for an <xref:System.Collections.Concurrent.IProducerConsumerCollection%601> collection.</span></span>|  
|[<span data-ttu-id="7b2c0-152">Практическое руководство. Использование оператора ForEach для удаления элементов в коллекции BlockingCollection</span><span class="sxs-lookup"><span data-stu-id="7b2c0-152">How to: Use ForEach to Remove Items in a BlockingCollection</span></span>](../../../../docs/standard/collections/thread-safe/how-to-use-foreach-to-remove.md)|<span data-ttu-id="7b2c0-153">Описание порядка использования `foreach` (`For Each` в Visual Basic) для удаления всех элементов в заблокированной коллекции.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-153">Describes how to use `foreach`, (`For Each` in Visual Basic) to remove all items in a blocking collection.</span></span>|  
|[<span data-ttu-id="7b2c0-154">Практическое руководство. Использование массивов для блокировки коллекций в конвейере</span><span class="sxs-lookup"><span data-stu-id="7b2c0-154">How to: Use Arrays of Blocking Collections in a Pipeline</span></span>](../../../../docs/standard/collections/thread-safe/how-to-use-arrays-of-blockingcollections.md)|<span data-ttu-id="7b2c0-155">Приводится описание порядка одновременного использования нескольких заблокированных коллекций для реализации конвейера.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-155">Describes how to use multiple blocking collections at the same time to implement a pipeline.</span></span>|  
|[<span data-ttu-id="7b2c0-156">Практическое руководство. Создание пула объектов с помощью класса ConcurrentBag</span><span class="sxs-lookup"><span data-stu-id="7b2c0-156">How to: Create an Object Pool by Using a ConcurrentBag</span></span>](../../../../docs/standard/collections/thread-safe/how-to-create-an-object-pool.md)|<span data-ttu-id="7b2c0-157">Показано, как применить параллельный контейнер для повышения производительности в сценариях, где можно повторно использовать объекты вместо постоянного создания новых.</span><span class="sxs-lookup"><span data-stu-id="7b2c0-157">Shows how to use a concurrent bag to improve performance in scenarios where you can reuse objects instead of continually creating new ones.</span></span>|  
  
## <a name="reference"></a><span data-ttu-id="7b2c0-158">Ссылка</span><span class="sxs-lookup"><span data-stu-id="7b2c0-158">Reference</span></span>  
 <xref:System.Collections.Concurrent?displayProperty=nameWithType>
