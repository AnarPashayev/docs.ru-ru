---
title: Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers
description: Архитектура микрослужб .NET для контейнерных приложений .NET | Реализация CQRS в микрослужбе заказов в eShopOnContainers.
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 10/08/2018
ms.openlocfilehash: b33f49bdeb20176b711d6dc50a247e131f9de9d7
ms.sourcegitcommit: 558d78d2a68acd4c95ef23231c8b4e4c7bac3902
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59309840"
---
# <a name="apply-cqrs-and-cqs-approaches-in-a-ddd-microservice-in-eshoponcontainers"></a><span data-ttu-id="444cc-103">Применение подходов CQRS и CQS в микрослужбе DDD в eShopOnContainers</span><span class="sxs-lookup"><span data-stu-id="444cc-103">Apply CQRS and CQS approaches in a DDD microservice in eShopOnContainers</span></span>

<span data-ttu-id="444cc-104">Проект микрослужбы заказов эталонного приложения eShopOnContainers построен на принципах CQRS.</span><span class="sxs-lookup"><span data-stu-id="444cc-104">The design of the ordering microservice at the eShopOnContainers reference application is based on CQRS principles.</span></span> <span data-ttu-id="444cc-105">Однако в нем применяется простейший подход, который просто разделяет запросы и команды и использует одну и ту же базу данных для обоих действий.</span><span class="sxs-lookup"><span data-stu-id="444cc-105">However, it uses the simplest approach, which is just separating the queries from the commands and using the same database for both actions.</span></span>

<span data-ttu-id="444cc-106">Важная отличительная особенность этих шаблонов — идемпотентность запросов. Это означает, что состояние системы не изменяется, независимо от количества запросов к ней.</span><span class="sxs-lookup"><span data-stu-id="444cc-106">The essence of those patterns, and the important point here, is that queries are idempotent: no matter how many times you query a system, the state of that system won't change.</span></span> <span data-ttu-id="444cc-107">Другими словами, выполнение запросов не влечет за собой возможные проблемы.</span><span class="sxs-lookup"><span data-stu-id="444cc-107">In other words, queries are side-effect free.</span></span>

<span data-ttu-id="444cc-108">Следовательно, вы можете использовать для чтения другую модель данных, отличающуюся от модели предметной области записи транзакционной логики, хотя микрослужбы размещения заказов используют ту же базу данных.</span><span class="sxs-lookup"><span data-stu-id="444cc-108">Therefore, you could use a different “reads” data model than the transactional logic “writes” domain model, even though the ordering microservices are using the same database.</span></span> <span data-ttu-id="444cc-109">Следовательно, такой подход CQRS является упрощенным.</span><span class="sxs-lookup"><span data-stu-id="444cc-109">Hence, this is a simplified CQRS approach.</span></span>

<span data-ttu-id="444cc-110">С другой стороны, команды, которые инициируют транзакции и обновления данных, изменяют состояние в системе.</span><span class="sxs-lookup"><span data-stu-id="444cc-110">On the other hand, commands, which trigger transactions and data updates, change state in the system.</span></span> <span data-ttu-id="444cc-111">При использовании команд необходимо соблюдать осторожность, имея дело со сложными и постоянно меняющимися бизнес-правилами.</span><span class="sxs-lookup"><span data-stu-id="444cc-111">With commands, you need to be careful when dealing with complexity and ever-changing business rules.</span></span> <span data-ttu-id="444cc-112">Это наиболее подходящее место для применения методов DDD, чтобы получить наилучшим образом смоделированную систему.</span><span class="sxs-lookup"><span data-stu-id="444cc-112">This is the where you want to apply DDD techniques to have a better modeled system.</span></span>

<span data-ttu-id="444cc-113">Шаблоны DDD, представленные в настоящем руководстве, не должны применяться универсально.</span><span class="sxs-lookup"><span data-stu-id="444cc-113">The DDD patterns presented in this guide should not be applied universally.</span></span> <span data-ttu-id="444cc-114">Они вводят в ваш проект ограничения.</span><span class="sxs-lookup"><span data-stu-id="444cc-114">They introduce constraints on your design.</span></span> <span data-ttu-id="444cc-115">Эти ограничения обеспечивают такие преимущества, как повышение качества с течением времени, особенно в командах и другом коде, который изменяет состояние системы.</span><span class="sxs-lookup"><span data-stu-id="444cc-115">Those constraints provide benefits such as higher quality over time, especially in commands and other code that modifies system state.</span></span> <span data-ttu-id="444cc-116">Однако эти ограничения увеличивают сложность с минимумом преимуществ для чтения и запросов данных.</span><span class="sxs-lookup"><span data-stu-id="444cc-116">However, those constraints add complexity with fewer benefits for reading and querying data.</span></span>

<span data-ttu-id="444cc-117">Одним из таких шаблонов является шаблон агрегата, который мы подробно рассмотрим в последующих разделах.</span><span class="sxs-lookup"><span data-stu-id="444cc-117">One such pattern is the Aggregate pattern, which we examine more in later sections.</span></span> <span data-ttu-id="444cc-118">Вкратце, в шаблоне агрегата (Aggregate) многие объекты предметной области обрабатываются как единое целое в результате их связей в предметной области.</span><span class="sxs-lookup"><span data-stu-id="444cc-118">Briefly, in the Aggregate pattern, you treat many domain objects as a single unit as a result of their relationship in the domain.</span></span> <span data-ttu-id="444cc-119">В запросах не всегда удается извлечь преимущества из этого шаблона; он может увеличить сложность логики запроса.</span><span class="sxs-lookup"><span data-stu-id="444cc-119">You might not always gain advantages from this pattern in queries; it can increase the complexity of query logic.</span></span> <span data-ttu-id="444cc-120">В запросах только на чтение вы не получите никаких преимуществ от обработки нескольких объектов как единого агрегата.</span><span class="sxs-lookup"><span data-stu-id="444cc-120">For read-only queries, you do not get the advantages of treating multiple objects as a single Aggregate.</span></span> <span data-ttu-id="444cc-121">Вы получите только сложность.</span><span class="sxs-lookup"><span data-stu-id="444cc-121">You only get the complexity.</span></span>

<span data-ttu-id="444cc-122">Как показано на рис. 7-2, в данном руководстве предлагается использовать шаблоны DDD только в области транзакций или обновлений вашей микрослужбы (то есть в том, что инициируется командами).</span><span class="sxs-lookup"><span data-stu-id="444cc-122">As shown in Figure 7-2, this guide suggests using DDD patterns only in the transactional/updates area of your microservice (that is, as triggered by commands).</span></span> <span data-ttu-id="444cc-123">Для запросов можно использовать более простой подход, и согласно концепции CQRS их следует отделить от команд.</span><span class="sxs-lookup"><span data-stu-id="444cc-123">Queries can follow a simpler approach and should be separated from commands, following a CQRS approach.</span></span>

<span data-ttu-id="444cc-124">Для реализации "стороны запросов" вы можете выбирать между подходами, включая полнофункциональные ORM, например EF Core, проекции AutoMapper, хранимые процедуры, представления, материализованные представления и micro ORM.</span><span class="sxs-lookup"><span data-stu-id="444cc-124">For implementing the “queries side”, you can choose between many approaches, from your full-blown ORM like EF Core, AutoMapper projections, stored procedures, views, materialized views or a micro ORM.</span></span>

<span data-ttu-id="444cc-125">В данном руководстве и в приложении eShopOnContainers (в частности, в микрослужбе заказов) мы решили реализовать прямые запросы с помощью micro ORM, например [Dapper](https://github.com/StackExchange/dapper-dot-net).</span><span class="sxs-lookup"><span data-stu-id="444cc-125">In this guide and in eShopOnContainers (specifically the ordering microservice) we chose to implement straight queries using a micro ORM like [Dapper](https://github.com/StackExchange/dapper-dot-net).</span></span> <span data-ttu-id="444cc-126">Это позволяет реализовать любой запрос на основе инструкций SQL для получения наилучшей производительности благодаря облегченной инфраструктуре с минимальными накладными расходами.</span><span class="sxs-lookup"><span data-stu-id="444cc-126">This lets you implement any query based on SQL statements to get the best performance, thanks to a light framework with very little overhead.</span></span>

<span data-ttu-id="444cc-127">Обратите внимание, что при использовании этого подхода для любых обновлений модели, влияющих на то, как сущности сохраняются в базе данных SQL, также требуются отдельные обновления запросов SQL, используемых Dapper или любым другим отдельным (не EF) подходом к запросам.</span><span class="sxs-lookup"><span data-stu-id="444cc-127">Note that when you use this approach, any updates to your model that impact how entities are persisted to a SQL database also need separate updates to SQL queries used by Dapper or any other separate (non-EF) approaches to querying.</span></span>

## <a name="cqrs-and-ddd-patterns-are-not-top-level-architectures"></a><span data-ttu-id="444cc-128">Шаблоны DDD и CQRS не относятся к архитектурам верхнего уровня</span><span class="sxs-lookup"><span data-stu-id="444cc-128">CQRS and DDD patterns are not top-level architectures</span></span>

<span data-ttu-id="444cc-129">Важно понимать, что CQRS и большинство шаблонов DDD (например, слои DDD или модель предметной области с агрегатами) являются не архитектурными стилями, а лишь архитектурными шаблонами.</span><span class="sxs-lookup"><span data-stu-id="444cc-129">It's important to understand that CQRS and most DDD patterns (like DDD layers or a domain model with aggregates) are not architectural styles, but only architecture patterns.</span></span> <span data-ttu-id="444cc-130">Примерами архитектурных стилей являются микрослужбы, SOA и событийно-управляемая архитектура (EDA).</span><span class="sxs-lookup"><span data-stu-id="444cc-130">Microservices, SOA, and event-driven architecture (EDA) are examples of architectural styles.</span></span> <span data-ttu-id="444cc-131">Они описывают систему, состоящую из множества компонентов, например из множества микрослужб.</span><span class="sxs-lookup"><span data-stu-id="444cc-131">They describe a system of many components, such as many microservices.</span></span> <span data-ttu-id="444cc-132">Шаблоны DDD и CQRS описывают нечто внутри одной системы или компонента; в данном случае — нечто внутри микрослужбы.</span><span class="sxs-lookup"><span data-stu-id="444cc-132">CQRS and DDD patterns describe something inside a single system or component; in this case, something inside a microservice.</span></span>

<span data-ttu-id="444cc-133">Разные ограниченные контексты (BC) будут использовать разные шаблоны.</span><span class="sxs-lookup"><span data-stu-id="444cc-133">Different Bounded Contexts (BCs) will employ different patterns.</span></span> <span data-ttu-id="444cc-134">Они имеют разные сферы ответственности, что ведет к разным решениям.</span><span class="sxs-lookup"><span data-stu-id="444cc-134">They have different responsibilities, and that leads to different solutions.</span></span> <span data-ttu-id="444cc-135">Стоит подчеркнуть, что повсеместное применение одного и того же шаблона приводит к неудаче.</span><span class="sxs-lookup"><span data-stu-id="444cc-135">It is worth emphasizing that forcing the same pattern everywhere leads to failure.</span></span> <span data-ttu-id="444cc-136">Не используйте шаблоны DDD и CQRS повсюду.</span><span class="sxs-lookup"><span data-stu-id="444cc-136">Do not use CQRS and DDD patterns everywhere.</span></span> <span data-ttu-id="444cc-137">Многие подсистемы, ограниченные контексты или микрослужбы довольно простые, и их можно реализовать более просто с помощью служб CRUD или другого метода.</span><span class="sxs-lookup"><span data-stu-id="444cc-137">Many subsystems, BCs, or microservices are simpler and can be implemented more easily using simple CRUD services or using another approach.</span></span>

<span data-ttu-id="444cc-138">Имеется только одна архитектура приложения: архитектура разрабатываемой системы или комплексного приложения (например, архитектура микрослужб).</span><span class="sxs-lookup"><span data-stu-id="444cc-138">There is only one application architecture: the architecture of the system or end-to-end application you are designing (for example, the microservices architecture).</span></span> <span data-ttu-id="444cc-139">Однако структура каждого ограниченного контекста или микрослужбы в этом приложении отражает их собственные компромиссы и внутренние проектные решения на уровне архитектурных шаблонов.</span><span class="sxs-lookup"><span data-stu-id="444cc-139">However, the design of each Bounded Context or microservice within that application reflects its own tradeoffs and internal design decisions at an architecture patterns level.</span></span> <span data-ttu-id="444cc-140">Не пытайтесь везде применять одни и те же архитектурные шаблоны, такие как CQRS или DDD.</span><span class="sxs-lookup"><span data-stu-id="444cc-140">Do not try to apply the same architectural patterns like CQRS or DDD everywhere.</span></span>

### <a name="additional-resources"></a><span data-ttu-id="444cc-141">Дополнительные ресурсы</span><span class="sxs-lookup"><span data-stu-id="444cc-141">Additional resources</span></span>

- <span data-ttu-id="444cc-142">**Мартин Фоулер (Martin Fowler). CQRS** \\</span><span class="sxs-lookup"><span data-stu-id="444cc-142">**Martin Fowler. CQRS** \\</span></span>
  [https://martinfowler.com/bliki/CQRS.html](https://martinfowler.com/bliki/CQRS.html)

- <span data-ttu-id="444cc-143">**Грег Янг (Greg Young). CQS и CQRS** \\</span><span class="sxs-lookup"><span data-stu-id="444cc-143">**Greg Young. CQS vs. CQRS** \\</span></span>
  [http://codebetter.com/gregyoung/2009/08/13/command-query-separation/](http://codebetter.com/gregyoung/2009/08/13/command-query-separation/)

- <span data-ttu-id="444cc-144">**Грег Янг (Greg Young). Документы по CQRS**  \\</span><span class="sxs-lookup"><span data-stu-id="444cc-144">**Greg Young. CQRS Documents** \\</span></span>
  [https://cqrs.files.wordpress.com/2010/11/cqrs\_documents.pdf](https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf)

- <span data-ttu-id="444cc-145">**Грег Янг (Greg Young). CQRS, пользовательские интерфейсы на основе задач и источники событий** \\</span><span class="sxs-lookup"><span data-stu-id="444cc-145">**Greg Young. CQRS, Task Based UIs and Event Sourcing** \\</span></span>
  [http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/](http://codebetter.com/gregyoung/2010/02/16/cqrs-task-based-uis-event-sourcing-agh/)

- <span data-ttu-id="444cc-146">**Уди Дахан (Udi Dahan). Пояснения к CQRS** \\</span><span class="sxs-lookup"><span data-stu-id="444cc-146">**Udi Dahan. Clarified CQRS** \\</span></span>
  [http://udidahan.com/2009/12/09/clarified-cqrs/](http://udidahan.com/2009/12/09/clarified-cqrs/)

- <span data-ttu-id="444cc-147">**Источники событий (ES)** \\</span><span class="sxs-lookup"><span data-stu-id="444cc-147">**Event-Sourcing (ES)** \\</span></span>
  [http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/](http://codebetter.com/gregyoung/2010/02/20/why-use-event-sourcing/)

>[!div class="step-by-step"]
><span data-ttu-id="444cc-148">[Назад](apply-simplified-microservice-cqrs-ddd-patterns.md)
>[Вперед](cqrs-microservice-reads.md)</span><span class="sxs-lookup"><span data-stu-id="444cc-148">[Previous](apply-simplified-microservice-cqrs-ddd-patterns.md)
[Next](cqrs-microservice-reads.md)</span></span>
