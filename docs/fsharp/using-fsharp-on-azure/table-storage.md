---
title: Начало работы с хранилищем таблиц Azure с помощью языка F#
description: Хранение структурированных данных в облаке с помощью хранилища таблиц Azure или Azure Cosmos DB.
author: sylvanc
ms.date: 03/26/2018
ms.openlocfilehash: 23f5e40e1d9b3d5a0ee27d675362930ef86e90c5
ms.sourcegitcommit: 7e2128d4a4c45b4274bea3b8e5760d4694569ca1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75935589"
---
# <a name="get-started-with-azure-table-storage-and-the-azure-cosmos-db-table-api-using-f"></a>Приступая к работе с хранилищем таблиц Azure и Azure Cosmos DB API таблиц с помощью F\#

Хранилище таблиц Azure — это служба в облаке, в которой хранятся структурированные данные NoSQL. Хранилище таблиц — это хранилище ключей и атрибутов, реализованное в виде бессхемной конструкции. Такая конструкция хранилища таблиц позволяет легко адаптировать данные по мере расширения приложения. Быстрый и экономичный доступ к данным предоставляется приложениям всех видов. Табличное хранилище обычно значительно дешевле, чем традиционная база данных SQL для тех же объемов данных.

Табличное хранилище можно использовать для хранения гибких наборов данных, например пользовательских данных для веб-приложений, адресных книг, сведений об устройстве, а также метаданных любого другого типа, которые требуются вашей службе. В таблице можно хранить любое количество сущностей, а учетная запись хранения может содержать любое количество таблиц в пределах емкости учетной записи.

Azure Cosmos DB предоставляет API таблиц для приложений, написанных для хранилища таблиц Azure и требующих таких возможностей:

- Комплексные возможности глобального распределения.
- Выделенная пропускная способность по всему миру.
- задержка меньше 10 миллисекунд на уровне 99-го процентиля;
- гарантированно высокий уровень доступности;
- автоматическое вторичное индексирование.

С помощью API таблицы вы можете перенести приложения, написанные для хранилища таблиц Azure, в Azure Cosmos DB, не изменяя код, и воспользоваться возможностями уровня "Премиум". API таблицы включает клиентские пакеты SDK для .NET., Java, Python и Node.js.

Дополнительные сведения см. [в статье Введение в Azure Cosmos DB API таблиц](https://docs.microsoft.com/azure/cosmos-db/table-introduction).

## <a name="about-this-tutorial"></a>Сведения об этом руководстве

В этом учебнике показано, F# как написать код для выполнения некоторых распространенных задач с помощью хранилища таблиц Azure или Azure Cosmos DB API таблиц, включая создание и удаление таблицы, а также вставку, обновление, удаление и выполнение запросов к данным таблицы.

## <a name="prerequisites"></a>Prerequisites

Для работы с этим руководством необходимо сначала [создать учетную запись хранения Azure](/azure/storage/storage-create-storage-account) или [Azure Cosmos DB](https://azure.microsoft.com/try/cosmosdb/).

## <a name="create-an-f-script-and-start-f-interactive"></a>Создание F# скрипта и запуск F# интерактивного

Примеры в этой статье можно использовать как в F# приложении, так и в F# сценарии. Чтобы создать F# скрипт, создайте файл с расширением `.fsx`, например `tables.fsx`, в среде F# разработки.

Затем используйте [Диспетчер пакетов](package-management.md) , например [пакет](https://fsprojects.github.io/Paket/) или [NuGet](https://www.nuget.org/) , для установки пакета `WindowsAzure.Storage` и ссылки на `WindowsAzure.Storage.dll` в скрипте с помощью директивы `#r`. Повторите эту операцию для `Microsoft.WindowsAzure.ConfigurationManager`, чтобы получить пространство имен Microsoft. Azure.

### <a name="add-namespace-declarations"></a>Добавление объявлений пространств имен

Добавьте в начало файла `tables.fsx` следующие инструкции `open`:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L1-L5)]

### <a name="get-your-azure-storage-connection-string"></a>Получение строки подключения к службе хранилища Azure

Если вы подключаетесь к службе таблиц службы хранилища Azure, вам потребуется строка подключения для этого руководства. Строку подключения можно скопировать из портал Azure. Дополнительные сведения о строках подключения см. в разделе [Настройка строк подключения к хранилищу](/azure/storage/storage-configure-connection-string).

### <a name="get-your-azure-cosmos-db-connection-string"></a>Получение строки подключения Azure Cosmos DB

Если вы подключаетесь к Azure Cosmos DB, вам потребуется строка подключения для этого руководства. Строку подключения можно скопировать из портал Azure. В портал Azure в учетной записи Cosmos DB перейдите в раздел **параметры** > **строка подключения**и нажмите кнопку **Копировать** , чтобы скопировать основную строку подключения.

Для этого руководства введите в скрипт строку подключения, как показано в следующем примере:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L11-L11)]

Однако это **не рекомендуется** для реальных проектов. Ключ учетной записи хранения похож на корневой пароль для вашей учетной записи хранения. Не забудьте защитить ключ учетной записи хранения. Не сообщайте его другим пользователям, не определяйте его в коде и не храните его в текстовом файле, доступном другим пользователям. Вы можете повторно создать ключ с помощью портала Azure, если считаете, что он был скомпрометирован.

Для реальных приложений лучшим способом поддержания строки подключения к хранилищу является файл конфигурации. Чтобы получить строку подключения из файла конфигурации, можно сделать следующее:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L13-L15)]

Использование диспетчера конфигураций Azure не является обязательным. Можно также использовать API, например тип `ConfigurationManager` .NET Framework.

### <a name="parse-the-connection-string"></a>Проанализируйте строку подключения

Чтобы проанализировать строку подключения, используйте:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L21-L22)]

Это возвращает `CloudStorageAccount`.

### <a name="create-the-table-service-client"></a>Создание клиента службы таблиц

Класс `CloudTableClient` позволяет извлекать таблицы и сущности в хранилище таблиц. Вот один из способов создать клиента службы.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L28-L29)]

Теперь вы можете написать код, который считывает и записывает данные в хранилище таблиц.

### <a name="create-a-table"></a>Создание таблицы

В этом примере показано, как создать таблицу, если она не существует:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L35-L39)]

### <a name="add-an-entity-to-a-table"></a>Добавление сущности в таблицу

Сущность должна иметь тип, который наследуется от `TableEntity`. Можно расширять `TableEntity` любым способом, но у типа *должен* быть конструктор без параметров. В таблице Azure хранятся только свойства, которые содержат как `get`, так и `set`.

Ключ секции и строки сущности уникально идентифицируют сущность в таблице. Сущности с одинаковым ключом раздела можно запрашивать быстрее, чем с разными ключами раздела, но использование различных ключей разделов обеспечивает более высокую масштабируемость параллельных операций.

Ниже приведен пример `Customer`, в котором в качестве ключа секции используется `lastName`, а в качестве ключа строки — `firstName`.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L45-L52)]

Теперь добавьте `Customer` в таблицу. Для этого создайте `TableOperation`, который выполняется для таблицы. В этом случае создается операция `Insert`.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L54-L55)]

### <a name="insert-a-batch-of-entities"></a>Вставка пакета сущностей

Пакет сущностей можно вставить в таблицу с помощью одной операции записи. Пакетные операции позволяют объединять операции в одно выполнение, но имеют некоторые ограничения.

- Обновления, удаления и вставки можно выполнять в одной и той же пакетной операции.
- Пакетная операция может включать до 100 сущностей.
- Все сущности в пакетной операции должны иметь один и тот же ключ секции.
- Хотя можно выполнить запрос в пакетной операции, он должен быть единственной операцией в пакете.

Ниже приведен код, объединяющий две операции вставки в пакетную операцию:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L62-L71)]

### <a name="retrieve-all-entities-in-a-partition"></a>Получение всех сущностей в разделе

Чтобы запросить все сущности из таблицы, используйте объект `TableQuery`. Здесь выполняется фильтрация для сущностей, где "Иванов" — ключ секции.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L77-L82)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L84-L85)]

### <a name="retrieve-a-range-of-entities-in-a-partition"></a>Получение диапазона сущностей в разделе

Если вы не хотите запрашивать все сущности в разделе, можно указать диапазон, объединив фильтр ключа раздела с фильтром ключа строк. Здесь используются два фильтра для получения всех сущностей в разделе "Smith", где ключ строки (имя) начинается с буквы, предшествующей "M", в алфавите.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L91-L100)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L102-L103)]

### <a name="retrieve-a-single-entity"></a>Извлечение одной сущности

Можно написать запрос для получения отдельной сущности. Здесь вы используете `TableOperation`, чтобы указать клиента «Бен Смит». Вместо коллекции вы получаете `Customer`. Указание как ключа секции, так и ключа строки в запросе — самый быстрый способ извлечь одну сущность из службы таблиц.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L109-L111)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L113-L115)]

### <a name="replace-an-entity"></a>Замена сущности

Чтобы обновить сущность, извлеките ее из службы таблиц, измените объект сущности, а затем сохраните изменения обратно в службу таблиц с помощью операции `Replace`. Это приводит к тому, что сущность будет полностью заменена на сервере, если только сущность на сервере не изменялась с момента получения. в этом случае операция завершается ошибкой. Этот сбой заключается в предотвращении непреднамеренной перезаписи изменений из других источников в приложении.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L121-L128)]

### <a name="insert-or-replace-an-entity"></a>Вставка или замена сущности

Иногда неизвестно, существует ли сущность в таблице. Если это так, текущие значения, хранящиеся в нем, больше не нужны. С помощью `InsertOrReplace` можно создать сущность или заменить ее, если она существует, независимо от ее состояния.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L134-L141)]

### <a name="query-a-subset-of-entity-properties"></a>Запрос подмножества свойств сущности

Запрос таблицы может получить лишь несколько свойств сущности, а не все. Этот метод, называемый проекцией, может повысить производительность запросов, особенно для больших сущностей. Здесь вы возвращаете только адреса электронной почты с помощью `DynamicTableEntity` и `EntityResolver`. Обратите внимание, что проекция не поддерживается в локальном эмуляторе хранения, поэтому этот код выполняется только при использовании учетной записи хранения в службе таблиц.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L147-L158)]

### <a name="retrieve-entities-in-pages-asynchronously"></a>Асинхронное получение объектов со страниц

Если вы читаете большое количество сущностей и хотите обрабатывать их по мере их извлечения, а не ждать их возврата, можно использовать сегментированный запрос. Здесь вы возвращаете результаты на страницах с помощью асинхронного рабочего процесса, чтобы выполнение не блокировалось, пока не будет возвращен большой набор результатов.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L163-L178)]

Теперь это вычисление выполняется синхронно:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L180-L180)]

### <a name="delete-an-entity"></a>Удаление сущности

Сущность можно удалить после ее получения. Как и при обновлении сущности, эта ошибка возникает, если сущность изменилась со времени ее получения.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L186-L187)]

### <a name="delete-a-table"></a>Удаление таблицы

Вы можете удалить таблицу из учетной записи хранения. Удаленную таблицу нельзя воссоздать в течение определенного времени после удаления.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L193-L193)]

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали основные сведения о хранилище таблиц, перейдите по следующим ссылкам, чтобы узнать о более сложных задачах хранилища и Azure Cosmos DB API таблиц.

- [Общие сведения об API таблиц Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/table-introduction)
- [Справочник по клиентской библиотеке хранилища для .NET](https://docs.microsoft.com/dotnet/api/overview/azure/storage)
- [Поставщик типов службы хранилища Azure](https://fsprojects.github.io/AzureStorageTypeProvider/)
- [Блог рабочей группы службы хранилища Azure](https://docs.microsoft.com/archive/blogs/windowsazurestorage/)
- [Настройка строк подключения](https://docs.microsoft.com/azure/storage/common/storage-configure-connection-string)
