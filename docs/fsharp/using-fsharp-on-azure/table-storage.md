---
title: Начало работы с хранилищем таблиц Azure с помощью языка F#
description: Храните структурированные данные в облаке с помощью хранилища таблиц Azure или Azure Cosmos DB.
author: sylvanc
ms.date: 03/26/2018
ms.openlocfilehash: 6833e2264f7543f50b94892b6980140e4bf1cdd1
ms.sourcegitcommit: 14ad34f7c4564ee0f009acb8bfc0ea7af3bc9541
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/01/2019
ms.locfileid: "73424598"
---
# <a name="get-started-with-azure-table-storage-and-the-azure-cosmos-db-table-api-using-f"></a>Приступая к работе с хранилищем таблиц Azure и Azure Cosmos DB API таблиц с помощью F\#

Хранилище таблиц Azure — это служба, которая хранит структурированные данные NoSQL в облаке. Хранилище таблиц — это хранилище ключей или атрибутов с несхемной конструкцией. Поскольку табличное хранилище не имеет схемы, можно легко адаптировать данные по мере развития потребностей приложения. Доступ к данным является быстрым и экономичным для всех типов приложений. Хранилище таблиц обычно значительно меньше затрат по сравнению с традиционными SQL для аналогичных объемов данных.

Хранилище таблиц можно использовать для хранения гибких наборов данных, таких как пользовательские данные для веб-приложений, адресных книг, сведений об устройствах и любых других типов метаданных, необходимых службе. В таблице можно хранить любое количество сущностей, а учетная запись хранения может содержать любое количество таблиц, вплоть до ограничения емкости учетной записи хранения.

Azure Cosmos DB предоставляет API таблиц для приложений, написанных для хранилища таблиц Azure и требующих таких возможностей:

- Готовое глобальное распределение.
- Выделенная пропускная способность по всему миру.
- Задержка в одну цифру в миллисекундах на 99-м процентиль.
- Гарантированная высокая доступность.
- Автоматическое вторичное индексирование.

Приложения, написанные для хранилища таблиц Azure, можно перенести в Azure Cosmos DB с помощью API таблиц без изменений кода и воспользоваться преимуществами расширенных возможностей. У API таблиц есть клиентские пакеты SDK, доступные для .NET, Java, Python и Node. js.

Дополнительные сведения см. [в статье Введение в Azure Cosmos DB API таблиц](https://docs.microsoft.com/azure/cosmos-db/table-introduction).

## <a name="about-this-tutorial"></a>Сведения об этом руководстве

В этом учебнике показано, F# как написать код для выполнения некоторых распространенных задач с помощью хранилища таблиц Azure или Azure Cosmos DB API таблиц, включая создание и удаление таблицы, а также вставку, обновление, удаление и выполнение запросов к данным таблицы.

## <a name="prerequisites"></a>Необходимые компоненты

Для работы с этим руководством необходимо сначала [создать учетную запись хранения Azure](/azure/storage/storage-create-storage-account) или [Azure Cosmos DB](https://azure.microsoft.com/try/cosmosdb/).

## <a name="create-an-f-script-and-start-f-interactive"></a>Создание F# скрипта и запуск F# интерактивного

Примеры в этой статье можно использовать как в F# приложении, так и в F# сценарии. Чтобы создать F# скрипт, создайте файл с расширением `.fsx`, например `tables.fsx` в среде F# разработки.

Затем используйте [Диспетчер пакетов](package-management.md) , например [пакет](https://fsprojects.github.io/Paket/) или [NuGet](https://www.nuget.org/) , для установки пакета `WindowsAzure.Storage` и ссылку `WindowsAzure.Storage.dll` в скрипте с помощью директивы `#r`. Повторите эту операцию для `Microsoft.WindowsAzure.ConfigurationManager`, чтобы получить пространство имен Microsoft. Azure.

### <a name="add-namespace-declarations"></a>Добавить объявления пространств имен

Добавьте следующие операторы `open` в начало файла `tables.fsx`:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L1-L5)]

### <a name="get-your-azure-storage-connection-string"></a>Получение строки подключения к службе хранилища Azure

Если вы подключаетесь к службе таблиц службы хранилища Azure, вам потребуется строка подключения для этого руководства. Строку подключения можно скопировать из портал Azure. Дополнительные сведения о строках подключения см. в разделе [Настройка строк подключения к хранилищу](/azure/storage/storage-configure-connection-string).

### <a name="get-your-azure-cosmos-db-connection-string"></a>Получение строки подключения Azure Cosmos DB

Если вы подключаетесь к Azure Cosmos DB, вам потребуется строка подключения для этого руководства. Строку подключения можно скопировать из портал Azure. В портал Azure в учетной записи Cosmos DB перейдите в раздел **параметры** > **строка подключения**и нажмите кнопку **Копировать** , чтобы скопировать основную строку подключения.

Для этого руководства введите в скрипт строку подключения, как показано в следующем примере:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L11-L11)]

Однако это **не рекомендуется** для реальных проектов. Ключ учетной записи хранения аналогичен корневому паролю для вашей учетной записи хранения. Всегда будьте внимательны, чтобы защитить ключ учетной записи хранения. Не рекомендуется распространять его другим пользователям, жестко программировать или сохранять в виде обычного текстового файла, доступного для других пользователей. Вы можете повторно создать ключ с помощью портала Azure, если считаете, что он был скомпрометирован.

Для реальных приложений лучшим способом поддержания строки подключения к хранилищу является файл конфигурации. Чтобы получить строку подключения из файла конфигурации, можно сделать следующее:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L13-L15)]

Использование Configuration Manager Azure является необязательным. Вы также можете использовать API, например тип .NET Framework `ConfigurationManager`.

### <a name="parse-the-connection-string"></a>Анализ строки подключения

Чтобы проанализировать строку подключения, используйте:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L21-L22)]

Возвращается значение `CloudStorageAccount`.

### <a name="create-the-table-service-client"></a>Создание клиента службы таблиц

Класс `CloudTableClient` позволяет извлекать таблицы и сущности в хранилище таблиц. Вот один из способов создания клиента службы:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L28-L29)]

Теперь все готово для написания кода, считывающего данные из таблицы и записывающего их в хранилище таблиц.

### <a name="create-a-table"></a>Создание таблицы

В этом примере показано, как создать таблицу, если она еще не существует:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L35-L39)]

### <a name="add-an-entity-to-a-table"></a>Добавление сущности в таблицу

Сущность должна иметь тип, который наследует от `TableEntity`. Можно расширить `TableEntity` любым способом, но у типа *должен* быть конструктор без параметров. В таблице Azure хранятся только те свойства, которые имеют `get` и `set`.

Ключ секции и строки сущности уникально идентифицируют сущность в таблице. Сущности с одним и тем же ключом секции можно запрашивать быстрее, чем с разными ключами секции, но использование различных ключей секции позволяет повысить масштабируемость параллельных операций.

Ниже приведен пример `Customer`, который использует `lastName` в качестве ключа секции, а `firstName` — ключ строки.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L45-L52)]

Теперь добавьте `Customer` в таблицу. Для этого создайте `TableOperation`, который выполняется для таблицы. В этом случае создается операция `Insert`.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L54-L55)]

### <a name="insert-a-batch-of-entities"></a>Вставка пакета сущностей

Пакет сущностей можно вставить в таблицу с помощью одной операции записи. Пакетные операции позволяют объединять операции в одно выполнение, но имеют некоторые ограничения.

- Обновления, удаления и вставки можно выполнять в одной и той же пакетной операции.
- Пакетная операция может включать до 100 сущностей.
- Все сущности в пакетной операции должны иметь один и тот же ключ секции.
- Хотя можно выполнить запрос в пакетной операции, он должен быть единственной операцией в пакете.

Ниже приведен код, объединяющий две операции вставки в пакетную операцию:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L62-L71)]

### <a name="retrieve-all-entities-in-a-partition"></a>Получение всех сущностей в секции

Чтобы запросить таблицу для всех сущностей в секции, используйте объект `TableQuery`. Здесь выполняется фильтрация для сущностей, где "Иванов" — ключ секции.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L77-L82)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L84-L85)]

### <a name="retrieve-a-range-of-entities-in-a-partition"></a>Получение диапазона сущностей в секции

Если вы не хотите запрашивать все сущности в секции, можно указать диапазон, объединив фильтр ключей секций с фильтром ключей строк. Здесь используются два фильтра для получения всех сущностей в разделе "Smith", где ключ строки (имя) начинается с буквы, предшествующей "M", в алфавите.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L91-L100)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L102-L103)]

### <a name="retrieve-a-single-entity"></a>Получение одной сущности

Можно написать запрос для получения одной конкретной сущности. Здесь вы используете `TableOperation` для указания клиента «Бен Смит». Вместо коллекции возвращается `Customer`. Указание как ключа секции, так и ключа строки в запросе — самый быстрый способ извлечь одну сущность из службы таблиц.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L109-L111)]

Теперь результаты будут напечатаны следующим образом:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L113-L115)]

### <a name="replace-an-entity"></a>Замена сущности

Чтобы обновить сущность, извлеките ее из службы таблиц, измените объект сущности, а затем сохраните изменения обратно в службу таблиц с помощью операции `Replace`. Это приводит к тому, что сущность будет полностью заменена на сервере, если только сущность на сервере не изменялась с момента получения. в этом случае операция завершается ошибкой. Этот сбой заключается в предотвращении непреднамеренной перезаписи изменений из других источников в приложении.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L121-L128)]

### <a name="insert-or-replace-an-entity"></a>Вставка или замена сущности

Иногда неизвестно, существует ли сущность в таблице. Если это так, текущие значения, хранящиеся в нем, больше не нужны. Можно использовать `InsertOrReplace`, чтобы создать сущность, или заменить ее, если она существует, независимо от ее состояния.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L134-L141)]

### <a name="query-a-subset-of-entity-properties"></a>Запрос подмножества свойств сущности

Запрос таблицы может получить лишь несколько свойств сущности, а не все. Этот метод, называемый проекцией, может повысить производительность запросов, особенно для больших сущностей. Здесь вы возвращаете только адреса электронной почты с помощью `DynamicTableEntity` и `EntityResolver`. Обратите внимание, что проекция не поддерживается в эмуляторе локального хранилища, поэтому этот код выполняется, только если вы используете учетную запись службы таблиц.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L147-L158)]

### <a name="retrieve-entities-in-pages-asynchronously"></a>Асинхронное извлечение сущностей в страницах

Если вы читаете большое количество сущностей и хотите обрабатывать их по мере их извлечения, а не ждать их возврата, можно использовать сегментированный запрос. Здесь вы возвращаете результаты на страницах с помощью асинхронного рабочего процесса, чтобы выполнение не блокировалось, пока не будет возвращен большой набор результатов.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L163-L178)]

Теперь это вычисление выполняется синхронно:

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L180-L180)]

### <a name="delete-an-entity"></a>Удаление сущности

Сущность можно удалить после ее получения. Как и при обновлении сущности, эта ошибка возникает, если сущность изменилась со времени ее получения.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L186-L187)]

### <a name="delete-a-table"></a>Удаление таблицы

Вы можете удалить таблицу из учетной записи хранения. Удаленная таблица будет недоступна для повторного создания в течение периода времени после удаления.

[!code-fsharp[TableStorage](~/samples/snippets/fsharp/azure/table-storage.fsx#L193-L193)]

## <a name="next-steps"></a>Следующие шаги

Теперь, когда вы узнали основные сведения о хранилище таблиц, перейдите по следующим ссылкам, чтобы узнать о более сложных задачах хранилища и Azure Cosmos DB API таблиц.

- [Общие сведения о Azure Cosmos DB API таблиц](https://docs.microsoft.com/azure/cosmos-db/table-introduction)
- [Справочник по клиентской библиотеке хранилища для .NET](https://docs.microsoft.com/dotnet/api/overview/azure/storage)
- [Поставщик типов службы хранилища Azure](https://fsprojects.github.io/AzureStorageTypeProvider/)
- [Блог команды разработчиков службы хранилища Azure](https://blogs.msdn.microsoft.com/windowsazurestorage/)
- [Настройка строк подключения](https://docs.microsoft.com/azure/storage/common/storage-configure-connection-string)
