---
title: Начало работы с хранилищем очередей Azure с помощью языка F#
description: Очереди хранилища обеспечивают надежный асинхронный обмен сообщениями между компонентами приложения. Обмен сообщениями в облаке позволяет масштабировать компоненты приложения независимо друг от друга.
author: sylvanc
ms.date: 09/20/2016
ms.openlocfilehash: 841068ac91aecc53811359e27d984907569a2c6d
ms.sourcegitcommit: 7e2128d4a4c45b4274bea3b8e5760d4694569ca1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75935496"
---
# <a name="get-started-with-azure-queue-storage-using-f"></a>Приступая к работе с хранилищем очередей Azure с помощью F\#

Хранилище очередей Azure — это служба, обеспечивающая обмен сообщениями в облаке между компонентами приложения. При разработке приложений для масштабирования компоненты приложения часто не связаны между собой, так что они могут масштабироваться независимо друг от друга. Хранилище очередей обеспечивает асинхронный обмен сообщениями для взаимодействия между компонентами приложения независимо от того, где они выполняются: в облаке, на рабочем столе, локальном сервере или мобильном устройстве. Хранилище очередей также поддерживает управление асинхронными задачами и создание рабочих процессов.

### <a name="about-this-tutorial"></a>Сведения об этом руководстве

В этом руководстве показано, как F# написать код для некоторых распространенных задач с помощью хранилища очередей Azure. В число описываемых задач входят создание и удаление очередей, а затем Добавление, чтение и удаление сообщений очереди.

Общие сведения о хранилище очередей см. в разделе ["рекомендации по .NET" для хранилища очередей](/azure/storage/storage-dotnet-how-to-use-queues).

## <a name="prerequisites"></a>Prerequisites

Для работы с этим руководством необходимо сначала [создать учетную запись хранения Azure](/azure/storage/storage-create-storage-account).
Вам также потребуется ключ доступа к хранилищу для этой учетной записи.

## <a name="create-an-f-script-and-start-f-interactive"></a>Создание F# скрипта и запуск F# интерактивного

Примеры в этой статье можно использовать как в F# приложении, так и в F# сценарии. Чтобы создать F# скрипт, создайте файл с расширением `.fsx`, например `queues.fsx`, в среде F# разработки.

Затем используйте [Диспетчер пакетов](package-management.md) , например [пакет](https://fsprojects.github.io/Paket/) или [NuGet](https://www.nuget.org/) , для установки пакета `WindowsAzure.Storage` и ссылки на `WindowsAzure.Storage.dll` в скрипте с помощью директивы `#r`.

### <a name="add-namespace-declarations"></a>Добавление объявлений пространств имен

Добавьте в начало файла `queues.fsx` следующие инструкции `open`:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L1-L3)]

### <a name="get-your-connection-string"></a>Получение строки подключения

Для работы с этим руководством вам потребуется строка подключения к службе хранилища Azure. Дополнительные сведения о строках подключения см. в разделе [Настройка строк подключения к хранилищу](/azure/storage/storage-configure-connection-string).

В этом руководстве вы введете строку подключения в сценарий следующим образом:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L9-L9)]

Однако это **не рекомендуется** для реальных проектов. Ключ учетной записи хранения похож на корневой пароль для вашей учетной записи хранения. Не забудьте защитить ключ учетной записи хранения. Не сообщайте его другим пользователям, не определяйте его в коде и не храните его в текстовом файле, доступном другим пользователям. Вы можете повторно создать ключ с помощью портала Azure, если считаете, что он был скомпрометирован.

Для реальных приложений лучшим способом поддержания строки подключения к хранилищу является файл конфигурации. Чтобы получить строку подключения из файла конфигурации, можно сделать следующее:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L11-L13)]

Использование диспетчера конфигураций Azure не является обязательным. Можно также использовать API, например тип `ConfigurationManager` .NET Framework.

### <a name="parse-the-connection-string"></a>Проанализируйте строку подключения

Чтобы проанализировать строку подключения, используйте:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L19-L20)]

Это приведет к возврату `CloudStorageAccount`.

### <a name="create-the-queue-service-client"></a>Создание клиента службы очередей

Класс `CloudQueueClient` позволяет получать очереди, хранящиеся в хранилище очередей. Вот один из способов создать клиента службы.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L26-L26)]

Теперь вы можете написать код, который считывает и записывает данные в хранилище очередей.

## <a name="create-a-queue"></a>Создать очередь

В этом примере показано, как создать очередь, если она еще не существует:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L32-L36)]

## <a name="insert-a-message-into-a-queue"></a>Вставка сообщения в очередь

Чтобы вставить сообщение в существующую очередь, сначала создайте новый `CloudQueueMessage`. Затем вызовите метод `AddMessage`. `CloudQueueMessage` можно создать из строки (в формате UTF-8) или массива `byte` следующим образом:

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L42-L44)]

## <a name="peek-at-the-next-message"></a>Просмотр следующего сообщения

Можно взглянуть на сообщение в начале очереди, не удаляя его из очереди, вызвав метод `PeekMessage`.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L50-L52)]

## <a name="get-the-next-message-for-processing"></a>Получить следующее сообщение для обработки

Вы можете получить сообщение в начале очереди для обработки, вызвав метод `GetMessage`.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L58-L59)]

Позднее можно указать успешную обработку сообщения с помощью `DeleteMessage`.

## <a name="change-the-contents-of-a-queued-message"></a>Изменение содержимого сообщения в очереди

Вы можете изменить содержимое извлеченного сообщения на месте в очереди. Если сообщение представляет собой рабочую задачу, можно использовать эту функцию для обновления состояния рабочей задачи. Следующий код добавляет новое содержимое в очередь сообщений и продлевает время ожидания видимости еще на 60 секунд. Это сохраняет состояние работы, связанной с данным сообщением, и позволяет клиенту продолжить работу с сообщением на протяжении еще одной минуты. Этот метод можно использовать для отслеживания многошаговых рабочих процессов по сообщениям в очереди без необходимости начинать с самого начала в случае сбоя шага обработки в связи с ошибкой аппаратного или программного обеспечения. Как правило, вы также сохраняете число повторных попыток, и если сообщение повторяется несколько раз, его можно удалить. Это обеспечивает защиту от сообщений, которые инициируют ошибку приложения при каждой попытке обработки.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L65-L69)]

## <a name="de-queue-the-next-message"></a>Удаление следующего сообщения из очереди

Код удаляет сообщение из очереди в два этапа. При вызове `GetMessage`вы получаете следующее сообщение в очереди. Сообщение, возвращаемое методом `GetMessage`, становится невидимым для другого кода, считывающего сообщения из этой очереди. По умолчанию это сообщение остается невидимым в течение 30 секунд. Чтобы завершить удаление сообщения из очереди, необходимо также вызвать `DeleteMessage`. Этот двухэтапный процесс удаления сообщения позволяет удостовериться, что если коду не удастся обработать сообщение из-за сбоя оборудования или программного обеспечения, другой экземпляр кода сможет получить то же сообщение и повторить попытку. Код вызывает `DeleteMessage` сразу после обработки сообщения.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L75-L76)]

## <a name="use-async-workflows-with-common-queue-storage-apis"></a>Использование асинхронных рабочих процессов с общими интерфейсами API хранилища очередей

В этом примере показано, как использовать асинхронный рабочий процесс с общими интерфейсами API хранилища очередей.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L82-L91)]

## <a name="additional-options-for-de-queuing-messages"></a>Дополнительные параметры для удаления сообщений из очереди

Способ извлечения сообщения из очереди можно настроить двумя способами.
Во-первых, можно получить пакет сообщений (до 32 сообщений). Во-вторых, можно задать более длительное или короткое время ожидания видимости, чтобы предоставить коду больше или меньше времени на полную обработку каждого сообщения. В следующем примере кода используется `GetMessages` для получения 20 сообщений в одном вызове и последующей обработки каждого сообщения. Он также задает время ожидания невидимости 5 минут для каждого сообщения. Обратите внимание, что 5 минут начинается для всех сообщений одновременно, поэтому спустя 5 минут после вызова `GetMessages`все сообщения, которые не были удалены, снова станут видимыми.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L97-L99)]

## <a name="get-the-queue-length"></a>Получение длины очереди

Вы можете узнать приблизительное количество сообщений в очереди. Метод `FetchAttributes` запрашивает у служба очередей получение атрибутов очереди, включая число сообщений. Свойство `ApproximateMessageCount` возвращает последнее значение, полученное методом `FetchAttributes`, без вызова служба очередей.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L105-L106)]

## <a name="delete-a-queue"></a>Удаление очереди

Чтобы удалить очередь и все сообщения, содержащиеся в ней, вызовите метод `Delete` для объекта Queue.

[!code-fsharp[QueueStorage](~/samples/snippets/fsharp/azure/queue-storage.fsx#L112-L113)]

## <a name="next-steps"></a>Следующие шаги

Вы изучили основные сведения о хранилище очередей. Дополнительные сведения о более сложных задачах по использованию хранилища можно найти по следующим ссылкам.

- [API-интерфейсы хранилища Azure для .NET](/dotnet/api/overview/azure/storage)
- [Поставщик типов службы хранилища Azure](https://github.com/fsprojects/AzureStorageTypeProvider)
- [Блог рабочей группы службы хранилища Azure](https://docs.microsoft.com/archive/blogs/windowsazurestorage/)
- [Настройка строк подключения службы хранилища Azure](/azure/storage/common/storage-configure-connection-string)
- [Azure Storage Services REST API Reference](/rest/api/storageservices/Azure-Storage-Services-REST-API-Reference) (Справочник по REST API службы хранилища Azure)
