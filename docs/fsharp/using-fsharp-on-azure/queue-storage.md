---
title: Начало работы с хранилищем очередей Azure с использованиемF#
description: Очереди Azure обеспечивают надежный асинхронный обмен сообщениями между компонентами приложения. Облачные системы обмена сообщениями позволяет независимо масштабировать компоненты приложения.
author: sylvanc
ms.date: 09/20/2016
ms.openlocfilehash: 58a46dfe905a32be77a13d11df8f0544546ea0ed
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61756381"
---
# <a name="get-started-with-azure-queue-storage-using-f"></a>Начало работы с хранилищем очередей Azure с помощью F\#

Хранилище очередей Azure обеспечивает обмен сообщениями между компонентами приложения в облаке. При разработке приложений для масштабирования, компоненты приложения часто не связаны, так что они могут масштабироваться независимо друг от друга. Хранилище очередей обеспечивает асинхронный обмен сообщениями для взаимодействия между компонентами приложения, ли они выполняются в облаке, на рабочем столе, на локальном сервере или на мобильном устройстве. Хранилище очередей также поддерживает управление асинхронными задачами и создание рабочих процессов.

### <a name="about-this-tutorial"></a>Сведения об этом руководстве

Этот учебник демонстрирует запись F# код для некоторых типичных задач, с помощью хранилища очередей Azure. Рассмотренные задачи включают создание и удаление очередей и добавление, чтение и удаление сообщений очереди.

Общие сведения о хранилище очередей, см. в разделе [руководство по .NET для хранилища очередей](/azure/storage/storage-dotnet-how-to-use-queues).

## <a name="prerequisites"></a>Предварительные требования

Чтобы использовать это руководство, необходимо сначала [создать учетную запись хранения](/azure/storage/storage-create-storage-account).
Вам также потребуется ключ доступа к хранилищу для этой учетной записи.

## <a name="create-an-f-script-and-start-f-interactive"></a>Создание F# сценариев и запустить F# интерактивный

Примеры в этой статье можно использовать в любом F# приложения или F# скрипта. Чтобы создать F# скрипт, создайте файл с `.fsx` расширение, например `queues.fsx`в вашей F# среды разработки.

Затем используйте [диспетчера пакетов](package-management.md) например [Paket](https://fsprojects.github.io/Paket/) или [NuGet](https://www.nuget.org/) для установки `WindowsAzure.Storage` пакета и ссылка `WindowsAzure.Storage.dll` в скрипте, с помощью `#r`директива.

### <a name="add-namespace-declarations"></a>Добавьте объявления пространств имен

Добавьте следующий `open` операторы в верхнюю часть `queues.fsx` файла:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L1-L3)]

### <a name="get-your-connection-string"></a>Получить строку подключения

В этом руководстве вам потребуется строки подключения к службе хранилища Azure. Дополнительные сведения о строках подключения см. в разделе [Настройка строк подключения службы хранилища](/azure/storage/storage-configure-connection-string).

Для этого руководства вы введете строку подключения в скрипте, следующим образом:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L9-L9)]

Однако это **не рекомендуется** реальных проектов. Ключ учетной записи хранения похож на корневой пароль для учетной записи хранения. Не забудьте защитить ключ учетной записи хранения. Избегайте распределения его другим пользователям, в коде, или сохранить его в текстовом файле, доступном другим пользователям. Можно повторно создать ключ с помощью портала Azure, если вы считаете, что он мог быть скомпрометирован.

Для реальных приложений, чтобы сохранить строку подключения хранилища рекомендуется в файле конфигурации. Чтобы получить строку подключения из файла конфигурации, это можно сделать:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L11-L13)]

Использование диспетчера конфигураций Azure не является обязательным. Можно также использовать API, например .NET Framework `ConfigurationManager` типа.

### <a name="parse-the-connection-string"></a>Проанализировать строку подключения

Чтобы проанализировать строку подключения, используйте следующую команду:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L19-L20)]

Эта команда возвращает `CloudStorageAccount`.

### <a name="create-the-queue-service-client"></a>Создание клиента службы очередей

`CloudQueueClient` Класс позволяет получать очереди, хранящиеся в хранилище очередей. Вот один из способов создания клиента службы:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L26-L26)]

Теперь вы готовы написать код, который считывает и записывает данные в хранилище очередей.

## <a name="create-a-queue"></a>Создание очереди

В этом примере показано, как создать очередь, если он еще не существует:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L32-L36)]

## <a name="insert-a-message-into-a-queue"></a>Вставка сообщения в очереди

Чтобы вставить сообщение в существующую очередь, сначала создайте `CloudQueueMessage`. Затем вызовите `AddMessage` метод. Объект `CloudQueueMessage` может быть создан из строки (в формате UTF-8) или `byte` массиве, вот так:

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L42-L44)]

## <a name="peek-at-the-next-message"></a>Просмотр следующего сообщения

Вы можете просмотреть сообщение в начале очереди, не удаляя его из очереди, вызвав `PeekMessage` метод.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L50-L52)]

## <a name="get-the-next-message-for-processing"></a>Получить следующее сообщение для обработки

Сообщение в начале очереди для обработки можно получить, вызвав `GetMessage` метод.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L58-L59)]

Позже вы указать успешную обработку сообщения с помощью `DeleteMessage`.

## <a name="change-the-contents-of-a-queued-message"></a>Изменение содержимого сообщения в очереди

Можно изменить содержимое полученного сообщения непосредственно в очереди. Если сообщение представляет собой рабочую задачу, можно использовать эту функцию для обновления состояния рабочей задачи. Следующий код добавляет новое содержимое сообщения очереди и задает время ожидания видимости, чтобы расширить еще на 60 секунд. Это сохраняет состояние работы, связанной с сообщением и дает еще одной минуты, чтобы продолжить работу с сообщения клиенту. Этот метод можно использовать для отслеживания многошаговых рабочих процессов по сообщениям в очереди, без необходимости начинать с самого начала, если происходит сбой на этапе обработки из-за сбоя оборудования или программного обеспечения. Обычно также сохраняется также числом повторов, и если сообщения превысит больше, чем определенное число раз, нужно удалить. Это обеспечивает защиту от сообщений, которые инициируют ошибку приложения каждый раз при его обработке.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L65-L69)]

## <a name="de-queue-the-next-message"></a>Удаление следующего сообщения из очереди

Код исключении из очереди сообщения из очереди в два этапа. При вызове `GetMessage`, вы получаете следующее сообщение в очереди. Сообщение, возвращаемое методом `GetMessage` становится невидимым для другого кода, считывающего сообщения из этой очереди. По умолчанию это сообщение остается невидимым в течение 30 секунд. Чтобы завершить удаление сообщения из очереди, необходимо также вызвать `DeleteMessage`. Этот двухэтапный процесс удаления сообщения позволяет удостовериться, что если коду не удастся обработать сообщение из-за сбоя оборудования или программного обеспечения, другой экземпляр кода можно получить то же сообщение и повторить попытку. Код вызывает метод `DeleteMessage` сразу после обработки сообщения.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L75-L76)]

## <a name="use-async-workflows-with-common-queue-storage-apis"></a>Использование асинхронных рабочих процессов со стандартными интерфейсами API хранилища очередей

В этом примере показано, как использовать поток async со стандартными интерфейсами API хранилища очередей.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L82-L91)]

## <a name="additional-options-for-de-queuing-messages"></a>Дополнительные параметры для удаления сообщений из очереди

Существует два способа настройки извлечения сообщения из очереди.
Во-первых можно получить пакет сообщений (до 32). Во-вторых можно задать время ожидания невидимости длинный или короткий, предоставить коду больше или меньше времени на полную обработку каждого сообщения. В следующем примере кода используется `GetMessages` для получения 20 сообщений в один вызов и затем обрабатывает каждое сообщение. Он также задает время ожидания невидимости пять минут для каждого сообщения. Обратите внимание, что начинается для всех сообщений, в то же время, поэтому 5 минут по прошествии с момента вызова `GetMessages`, все сообщения, которые не были удалены становятся видимыми.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L97-L99)]

## <a name="get-the-queue-length"></a>Получение длины очереди

Можно получить приблизительное количество сообщений в очереди. `FetchAttributes` Метод запрашивает у службы очередей на извлечение атрибутов очереди, включая количество сообщений. `ApproximateMessageCount` Свойство возвращает последнее значение, полученное путем `FetchAttributes` метод без обращения к службе очередей.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L105-L106)]

## <a name="delete-a-queue"></a>Удаление очереди

Чтобы удалить очередь и все сообщения, содержащиеся в ней, вызовите `Delete` метода для объекта очереди.

[!code-fsharp[QueueStorage](../../../samples/snippets/fsharp/azure/queue-storage.fsx#L112-L113)]

## <a name="next-steps"></a>Следующие шаги

Теперь, когда ознакомились с основными понятиями хранилища очередей, по следующим ссылкам, чтобы узнать о более сложных задачах хранилища.

- [API службы хранилища Azure для .NET](/dotnet/api/overview/azure/storage)
- [Тип поставщика хранилища Azure](https://github.com/fsprojects/AzureStorageTypeProvider)
- [Блог группы разработчиков хранилища Azure](https://blogs.msdn.microsoft.com/windowsazurestorage/)
- [Настройка строк подключения службы хранилища Azure](/azure/storage/common/storage-configure-connection-string)
- [Справочник по API REST служб хранилища Azure](/rest/api/storageservices/Azure-Storage-Services-REST-API-Reference)
