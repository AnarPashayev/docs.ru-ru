---
title: Алгоритм загрузки управляемых сборок (.NET Core)
description: Подробный алгоритм загрузки управляемых сборок в .NET Core
ms.date: 08/09/2019
author: sdmaclea
ms.author: stmaclea
ms.openlocfilehash: 312a320676be6eb453697e0704ab771a6707618b
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "73973498"
---
# <a name="managed-assembly-loading-algorithm"></a><span data-ttu-id="962fd-103">Алгоритм загрузки управляемых сборок</span><span class="sxs-lookup"><span data-stu-id="962fd-103">Managed assembly loading algorithm</span></span>

<span data-ttu-id="962fd-104">Управляемые сборки обнаруживаются и загружаются по специальному алгоритму, который состоит из нескольких этапов.</span><span class="sxs-lookup"><span data-stu-id="962fd-104">Managed assemblies are located and loaded with an algorithm involving various stages.</span></span>

<span data-ttu-id="962fd-105">Для всех управляемых сборок, за исключением вспомогательных сборок и сборок `WinRT`, используется один и тот же алгоритм.</span><span class="sxs-lookup"><span data-stu-id="962fd-105">All managed assemblies except satellite assemblies and `WinRT` assemblies use the same algorithm.</span></span>

## <a name="when-are-managed-assemblies-loaded"></a><span data-ttu-id="962fd-106">Когда загружаются управляемые сборки?</span><span class="sxs-lookup"><span data-stu-id="962fd-106">When are managed assemblies loaded?</span></span>

<span data-ttu-id="962fd-107">Чаще всего загрузку управляемой сборки активирует статическая ссылка на сборку.</span><span class="sxs-lookup"><span data-stu-id="962fd-107">The most common mechanism to trigger a managed assembly load is a static assembly reference.</span></span> <span data-ttu-id="962fd-108">Эти ссылки добавляются в компилятор каждый раз, когда код обращается к типу, который определен в другой сборке.</span><span class="sxs-lookup"><span data-stu-id="962fd-108">These references are inserted by the compiler whenever code uses a type defined in another assembly.</span></span> <span data-ttu-id="962fd-109">Такие сборки среда выполнения загружает (`load-by-name`) по мере необходимости.</span><span class="sxs-lookup"><span data-stu-id="962fd-109">These assemblies are loaded (`load-by-name`) as needed by the runtime.</span></span>

<span data-ttu-id="962fd-110">Прямое использование конкретных интерфейсов API также приведет к загрузке сборки:</span><span class="sxs-lookup"><span data-stu-id="962fd-110">The direct use of specific APIs will also trigger loads:</span></span>

|<span data-ttu-id="962fd-111">API</span><span class="sxs-lookup"><span data-stu-id="962fd-111">API</span></span>  |<span data-ttu-id="962fd-112">Описание</span><span class="sxs-lookup"><span data-stu-id="962fd-112">Description</span></span>  |<span data-ttu-id="962fd-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span><span class="sxs-lookup"><span data-stu-id="962fd-113">`Active` <xref:System.Runtime.Loader.AssemblyLoadContext></span></span> |
|---------|---------|---------|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyName%2A?displayProperty=nameWithType>|`Load-by-name`|<span data-ttu-id="962fd-114">Экземпляр [this](../../csharp/language-reference/keywords/this.md).</span><span class="sxs-lookup"><span data-stu-id="962fd-114">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromAssemblyPath%2A?displayProperty=nameWithType><p><xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromNativeImagePath%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-115">Загрузка на основе пути.</span><span class="sxs-lookup"><span data-stu-id="962fd-115">Load from path.</span></span>|<span data-ttu-id="962fd-116">Экземпляр [this](../../csharp/language-reference/keywords/this.md).</span><span class="sxs-lookup"><span data-stu-id="962fd-116">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
<xref:System.Runtime.Loader.AssemblyLoadContext.LoadFromStream%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-117">Загрузка из объекта.</span><span class="sxs-lookup"><span data-stu-id="962fd-117">Load from object.</span></span>|<span data-ttu-id="962fd-118">Экземпляр [this](../../csharp/language-reference/keywords/this.md).</span><span class="sxs-lookup"><span data-stu-id="962fd-118">The [this](../../csharp/language-reference/keywords/this.md) instance.</span></span>|
|<xref:System.Reflection.Assembly.LoadFile%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-119">Загрузка на основе пути в новый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-119">Load from path in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance</span></span>|<span data-ttu-id="962fd-120">Новый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-120">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Reflection.Assembly.LoadFrom%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-121">Загрузка на основе пути в новый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-121">Load from path in the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span><p><span data-ttu-id="962fd-122">Добавляет обработчик <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving> в <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-122">Adds a <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving> handler to <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="962fd-123">Обработчик загрузит зависимости сборки из своего каталога.</span><span class="sxs-lookup"><span data-stu-id="962fd-123">The handler will load the assembly's dependencies from its directory.</span></span>|<span data-ttu-id="962fd-124">Экземпляр класса <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-124">The <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instance.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Reflection.AssemblyName)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.String)?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.LoadWithPartialName%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-125">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-125">`Load-by-name`.</span></span>|<span data-ttu-id="962fd-126">Выводится из вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="962fd-126">Inferred from caller.</span></span><p><span data-ttu-id="962fd-127">Лучше использовать методы <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-127">Prefer <xref:System.Runtime.Loader.AssemblyLoadContext> methods.</span></span>|
|<xref:System.Reflection.Assembly.Load(System.Byte[])?displayProperty=nameWithType><p><xref:System.Reflection.Assembly.Load(System.Byte[],System.Byte[])?displayProperty=nameWithType>|<span data-ttu-id="962fd-128">Загрузка из объекта в новый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-128">Load from object in a new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|<span data-ttu-id="962fd-129">Новый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-129">The new <xref:System.Runtime.Loader.AssemblyLoadContext> instance.</span></span>|
<xref:System.Type.GetType(System.String)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean)?displayProperty=nameWithType><p><xref:System.Type.GetType(System.String,System.Boolean,System.Boolean)?displayProperty=nameWithType>|<span data-ttu-id="962fd-130">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-130">`Load-by-name`.</span></span>|<span data-ttu-id="962fd-131">Выводится из вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="962fd-131">Inferred from caller.</span></span><p><span data-ttu-id="962fd-132">Лучше использовать методы <xref:System.Type.GetType%2A?displayProperty=nameWithType> с аргументом `assemblyResolver`.</span><span class="sxs-lookup"><span data-stu-id="962fd-132">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> methods with an `assemblyResolver` argument.</span></span>|
<xref:System.Reflection.Assembly.GetType%2A?displayProperty=nameWithType>|<span data-ttu-id="962fd-133">Если в типе `name` описан полный универсальный тип сборки, активируется `Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-133">If type `name` describes an assembly qualified generic type, trigger a `Load-by-name`.</span></span>|<span data-ttu-id="962fd-134">Выводится из вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="962fd-134">Inferred from caller.</span></span><p><span data-ttu-id="962fd-135">Лучше использовать <xref:System.Type.GetType%2A?displayProperty=nameWithType> для полных имен типов сборки.</span><span class="sxs-lookup"><span data-stu-id="962fd-135">Prefer <xref:System.Type.GetType%2A?displayProperty=nameWithType> when using assembly qualified type names.</span></span>|
<xref:System.Activator.CreateInstance(System.String,System.String)?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Object[])?displayProperty=nameWithType><p><xref:System.Activator.CreateInstance(System.String,System.String,System.Boolean,System.Reflection.BindingFlags,System.Reflection.Binder,System.Object[],System.Globalization.CultureInfo,System.Object[])?displayProperty=nameWithType>|<span data-ttu-id="962fd-136">`Load-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-136">`Load-by-name`.</span></span>|<span data-ttu-id="962fd-137">Выводится из вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="962fd-137">Inferred from caller.</span></span><p><span data-ttu-id="962fd-138">Лучше использовать методы <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType>, принимающие аргумент <xref:System.Type>.</span><span class="sxs-lookup"><span data-stu-id="962fd-138">Prefer <xref:System.Activator.CreateInstance%2A?displayProperty=nameWithType> methods taking a <xref:System.Type> argument.</span></span>|

## <a name="algorithm"></a><span data-ttu-id="962fd-139">Алгоритм</span><span class="sxs-lookup"><span data-stu-id="962fd-139">Algorithm</span></span>

<span data-ttu-id="962fd-140">Ниже приведен алгоритм загрузки управляемой сборки средой выполнения.</span><span class="sxs-lookup"><span data-stu-id="962fd-140">The following algorithm describes how the runtime loads a managed assembly.</span></span>

1. <span data-ttu-id="962fd-141">Определяется `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-141">Determine the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span>

    - <span data-ttu-id="962fd-142">Для ссылки на статическую сборку `active` <xref:System.Runtime.Loader.AssemblyLoadContext> обозначает экземпляр, который загрузил ссылающуюся сборку.</span><span class="sxs-lookup"><span data-stu-id="962fd-142">For a static assembly reference, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> is the instance that loaded the referring assembly.</span></span>
    - <span data-ttu-id="962fd-143">Предпочитаемые API-интерфейсы делают экземпляр `active` <xref:System.Runtime.Loader.AssemblyLoadContext> явным.</span><span class="sxs-lookup"><span data-stu-id="962fd-143">Preferred APIs make the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> explicit.</span></span>
    - <span data-ttu-id="962fd-144">Другие API-интерфейсы выводят `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-144">Other APIs infer the `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span></span> <span data-ttu-id="962fd-145">Для этих API-интерфейсов используется свойство <xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-145">For these APIs, the <xref:System.Runtime.Loader.AssemblyLoadContext.CurrentContextualReflectionContext?displayProperty=nameWithType> property is used.</span></span> <span data-ttu-id="962fd-146">Если его значение равно `null`, то используется выводимый экземпляр <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-146">If its value is `null`, then the inferred <xref:System.Runtime.Loader.AssemblyLoadContext> instance is used.</span></span>
    - <span data-ttu-id="962fd-147">См. приведенную выше таблицу.</span><span class="sxs-lookup"><span data-stu-id="962fd-147">See table above.</span></span>

2. <span data-ttu-id="962fd-148">Для методов `Load-by-name` активный класс <xref:System.Runtime.Loader.AssemblyLoadContext> загружает сборку.</span><span class="sxs-lookup"><span data-stu-id="962fd-148">For the `Load-by-name` methods, the active <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="962fd-149">Порядок приоритета:</span><span class="sxs-lookup"><span data-stu-id="962fd-149">In priority order by:</span></span>
    - <span data-ttu-id="962fd-150">Проверяется свойство `cache-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-150">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="962fd-151">Вызывается функция <xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-151">Calling the <xref:System.Runtime.Loader.AssemblyLoadContext.Load%2A?displayProperty=nameWithType> function.</span></span>

    - <span data-ttu-id="962fd-152">Проверяется кэш экземпляров <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> и выполняется логика [стандартного зондирования для поиска управляемой сборки](default-probing.md#managed-assembly-default-probing).</span><span class="sxs-lookup"><span data-stu-id="962fd-152">Checking the <xref:System.Runtime.Loader.AssemblyLoadContext.Default%2A?displayProperty=nameWithType> instances' cache and running [managed assembly default probing](default-probing.md#managed-assembly-default-probing) logic.</span></span>

    - <span data-ttu-id="962fd-153">Вызывается событие <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType> для активного класса AssemblyLoadContext.</span><span class="sxs-lookup"><span data-stu-id="962fd-153">Raising the <xref:System.Runtime.Loader.AssemblyLoadContext.Resolving?displayProperty=nameWithType> event for the active AssemblyLoadContext.</span></span>

    - <span data-ttu-id="962fd-154">Создается событие <xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-154">Raising the <xref:System.AppDomain.AssemblyResolve?displayProperty=nameWithType> event.</span></span>

3. <span data-ttu-id="962fd-155">Для других типов загрузок `active` <xref:System.Runtime.Loader.AssemblyLoadContext> загружает сборку.</span><span class="sxs-lookup"><span data-stu-id="962fd-155">For the other types of loads, the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> loads the assembly.</span></span> <span data-ttu-id="962fd-156">Порядок приоритета:</span><span class="sxs-lookup"><span data-stu-id="962fd-156">In priority order by:</span></span>
    - <span data-ttu-id="962fd-157">Проверяется свойство `cache-by-name`.</span><span class="sxs-lookup"><span data-stu-id="962fd-157">Checking its `cache-by-name`.</span></span>

    - <span data-ttu-id="962fd-158">Выполняется загрузка на основе указанного пути или из необработанного объекта сборки.</span><span class="sxs-lookup"><span data-stu-id="962fd-158">Loading from the specified path or raw assembly object.</span></span>

4. <span data-ttu-id="962fd-159">В любом случае, если загружена новая сборка, выполняется следующее:</span><span class="sxs-lookup"><span data-stu-id="962fd-159">In either case, if an assembly is newly loaded, then:</span></span>
   - <span data-ttu-id="962fd-160">Возникает событие <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="962fd-160">The <xref:System.AppDomain.AssemblyLoad?displayProperty=nameWithType> event is raised.</span></span>
   - <span data-ttu-id="962fd-161">Добавляется ссылка в `cache-by-name` экземпляра <xref:System.Runtime.Loader.AssemblyLoadContext> сборки.</span><span class="sxs-lookup"><span data-stu-id="962fd-161">A reference is added to the assembly's <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>

5. <span data-ttu-id="962fd-162">Если сборка найдена, добавляется соответствующая ссылка в `cache-by-name` экземпляра `active` <xref:System.Runtime.Loader.AssemblyLoadContext>.</span><span class="sxs-lookup"><span data-stu-id="962fd-162">If the assembly is found, a reference is added as needed to the `active` <xref:System.Runtime.Loader.AssemblyLoadContext> instance's `cache-by-name`.</span></span>
