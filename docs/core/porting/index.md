---
title: Перенос кода из .NET Framework в .NET Core
description: Общие сведения о процессе переноса и инструментах, которые могут оказаться полезными при переносе проектов .NET Framework в .NET Core.
author: cartermp
ms.date: 10/22/2019
ms.openlocfilehash: 247e709ac6898a6a89318626e3aa9a2a8e239a9a
ms.sourcegitcommit: a4cecb7389f02c27e412b743f9189bd2a6dea4d6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2021
ms.locfileid: "98189939"
---
# <a name="overview-of-porting-from-net-framework-to-net-core"></a>Общие сведения о переносе кода в .NET Core из .NET Framework

Возможно, у вас есть код, который сейчас выполняется в .NET Framework, и вы хотите перенести его в .NET Core. В этой статье приводится следующее:

* Общие сведения о переносе.
* Список средств, которые могут оказаться полезными при переносе кода в .NET Core.

## <a name="overview-of-the-porting-process"></a>Общие сведения о переносе

Перенос в .NET Core (или .NET Standard) из .NET Framework для многих проектов выполняется относительно просто. Существует ряд необходимых изменений, но многие из них соответствуют шаблонам, приведенным ниже. Для проектов, в которых модель приложений доступна в .NET Core (например, библиотеки, консольные приложения и классические приложения), обычно требуются небольшие изменения. Проекты, для которых нужна новая модель приложения, например переход на ASP.NET Core из ASP.NET, требуют немного больше работы, но многие шаблоны имеют аналоги, которые можно использовать во время преобразования. Этот документ должен помочь определить основные стратегии, которые были использованы пользователями для успешного преобразования базы кода для .NET Standard или .NET Core. Мы рассмотрим преобразование на двух уровнях: в масштабе всего решения и на уровне конкретного проекта. В нижней части приведены ссылки на инструкции по преобразованию в зависимости от модели приложений.

Мы рекомендуем следовать следующему процессу при переносе проекта в .NET Core. В каждом из этих шагов рассматриваются потенциальные изменения в поведении, поэтому убедитесь, что вы надлежащим образом тестируете библиотеку или приложение, прежде чем продолжать работу. Сначала необходимо подготовить проект для перехода на .NET Standard или .NET Core. При наличии модульных тестов рекомендуется сначала преобразовать их, чтобы можно было продолжить тестирование изменений в продукте, над которым вы работаете. Так как перенос в .NET Core является важным изменением базы кода, мы настоятельно рекомендуем перенести тестовые проекты, чтобы можно было выполнять тесты при переносе кода. .NET Core поддерживает все основные платформы: MSTest, xUnit и NUnit.

## <a name="getting-started"></a>Начало работы

В процессе будут использоваться следующие средства:

- Visual Studio 2019
- Загрузка [анализатора переносимости .NET](../../standard/analyzers/portability-analyzer.md)
- _Необязательно_ Установка [dotnet try-convert](https://github.com/dotnet/try-convert)

## <a name="porting-a-solution"></a>Перенос решения

При наличии в решении нескольких проектов перенос может показаться более сложным, поскольку необходимо работать с проектами в определенном порядке. Процесс преобразования должен осуществляться снизу вверх, при этом проекты без зависимостей от других проектов в решении преобразуются первыми и так далее вверх по решению.

Чтобы определить порядок проектов, которые нужно перенести, можно использовать следующие средства:

- [Схемы зависимостей в Visual Studio](/visualstudio/modeling/create-layer-diagrams-from-your-code) могут создавать направленный граф кода в решении.
- Запустите `msbuild _SolutionPath_ /t:GenerateRestoreGraphFile /p:RestoreGraphOutputPath=graph.dg.json`, чтобы создать документ JSON, включающий список ссылок проекта.
- Запустите [анализатор переносимости .NET](../../standard/analyzers/portability-analyzer.md) с параметром `-r DGML`, чтобы получить схему зависимостей сборок. Дополнительные сведения см. [здесь](../../standard/analyzers/portability-analyzer.md#solution-wide-view).

После получения сведений о зависимостях можно использовать эти сведения для продвижения по дереву зависимостей, начиная с листовых узлов, путем выполнения действий, описанных в следующем разделе.

## <a name="per-project-steps"></a>Действия для каждого проекта

Мы рекомендуем следовать следующему процессу при переносе проекта в .NET Core:

1. Преобразуйте все зависимости `packages.config` в формат [PackageReference](/nuget/consume-packages/package-references-in-project-files) с помощью [средства преобразования в Visual Studio](/nuget/consume-packages/migrate-packages-config-to-package-reference).

   На этом шаге выполняется преобразование зависимостей из устаревшего формата `packages.config`. Формат `packages.config` не поддерживается в .NET Core, поэтому такое преобразование является обязательным при наличии зависимостей пакетов. Кроме того, требуются только зависимости, напрямую используемые в проекте. Необходимость работать с меньшим числом зависимостей упрощает дальнейшие этапы.

1. Преобразуйте файл проекта в новую структуру файлов в стиле пакета SDK. Создайте проекты для .NET Core, скопируйте исходные файлы или попытайтесь преобразовать существующий файл проекта с помощью средства.

   В .NET Core используется более простой (и другой) [формат файла проекта](../project-sdk/overview.md), чем в .NET Framework. Чтобы продолжить, потребуется преобразовать файлы проекта в этот формат. Этот стиль проекта позволяет также ориентироваться на .NET Framework, что и так необходимо.

   Можно попытаться перенести за одну операцию более мелкие решения или отдельные проекты в формат файла проекта .NET Core с помощью средства [dotnet try-convert](https://github.com/dotnet/try-convert). Нет гарантии, что `dotnet try-convert` будет поддерживать все проекты. Кроме того, оно может вызвать незначительные изменения в ожидаемом поведении. Используйте это средство в качестве _начальной точки_, которая автоматизирует соответствующие основные процессы. Это не гарантированное решение для миграции проекта, поскольку существует множество различий в целевых объектах, используемых проектами в стиле пакета SDK, по сравнению с файлами проектов в старом стиле.

1. Перенацельте все переносимые проекты на .NET Framework 4.7.2 и более поздней версии.

   Так вы сможете использовать альтернативные API для целевых платформ .NET Framework в случае, если платформа .NET Core не поддерживает определенный API.

1. Обновите все зависимости до последней версии. Проекты могут использовать более старые версии библиотек, которые могут не поддерживать .NET Standard. Однако более поздние версии могут поддерживать его с помощью простого переключателя. Для этого может потребоваться изменить код, если в библиотеках есть критические изменения.

1. Чтобы выполнить анализ сборок и узнать, можно ли их перенести в .NET Core, используйте [анализатор переносимости .NET](../../standard/analyzers/portability-analyzer.md).

   Средство анализатора переносимости .NET позволяет проанализировать скомпилированные сборки и создать отчет. В этом отчете представлена сводная информация о переносимости и разбивка по каждому используемому API, недоступному в .NET Core. При использовании этого средства отправляйте только отдельный проект, который вы преобразуете, чтобы сосредоточиться на потенциально необходимых изменениях API. Многие API одинаково доступны в .NET Core, на который вы планируете перейти.

   При чтении отчетов, созданных анализатором, обратите внимание на фактические используемые API, а не на процент поддержки для целевой платформы. Многие API имеют эквиваленты в .NET Standard/Core, и поэтому понимание сценариев, в которых ваша библиотека или приложение используют API, поможет определить влияние на переносимость.

   В некоторых случаях API-интерфейсы не эквивалентны и необходимо выполнить некоторые директивы препроцессора компилятора (т. е. `#if NET45`) для подстройки под платформу. На этом этапе проект по-прежнему будет нацелен на .NET Framework. Для каждого из этих целевых вариантов рекомендуется использовать хорошо известные условия, которые можно рассматривать как сценарий.  Например, поддержка домена приложений в .NET Core ограничена, но для сценария загрузки и выгрузки сборок существует новый API, который в .NET Core недоступен. Распространенный способ решения этой задачи в коде будет выглядеть примерно так:

   ```csharp
   #if FEATURE_APPDOMAIN_LOADING
   // Code that uses appdomains
   #elif FEATURE_ASSEMBLY_LOAD_CONTEXT
   // Code that uses assembly load context
   #else
   #error Unsupported platform
   #endif
   ```

1. Установите [анализатор API .NET](../../standard/analyzers/api-analyzer.md) в проектах, чтобы узнать, какие интерфейсы API вызывают исключение <xref:System.PlatformNotSupportedException> на отдельных платформах и другие потенциальные проблемы совместимости.

   Это средство подобно анализатору переносимости. Но вместо анализа возможности создания кода на платформе .NET Core оно анализирует вероятность использования API на предмет действий, которые могут вызвать <xref:System.PlatformNotSupportedException> во время выполнения. Хотя такая проверка обычно не выполняется при переходе с .NET Framework 4.7.2 и более поздних версий, ее стоит выполнить. Дополнительные сведения об API, вызывающих исключения в .NET Core, см. в статье [APIs that always throw exceptions on .NET Core](../compatibility/unsupported-apis.md) (API, которые всегда создают исключения в .NET Core).

1. На этом этапе можно переключиться на платформу .NET Core (обычно для приложений) или .NET Standard (для библиотек).

   Выбор между .NET Core и .NET Standard во многом зависит от того, где будет выполняться проект. Если это библиотека, которая будет использоваться другими приложениями или распространяться с помощью NuGet, лучше выбрать .NET Standard. Однако могут существовать API-интерфейсы, которые доступны только в .NET Core из-за производительности или иных причин. В этом случае следует использовать .NET Core в качестве целевой платформы и, возможно, иметь дополнительную сборку для .NET Standard с уменьшенной производительностью или функционалом. При нацеливании на .NET Standard проект будет готов к выполнению на новых платформах (например, WebAssembly). Если проект имеет зависимости от конкретных платформ приложений (например, ASP.NET Core), целевой объект будет ограничен тем, что поддерживают зависимости.

   Если нет директив препроцессора для условной компиляции кода для .NET Framework или .NET Standard, достаточно будет найти в файле проекта следующий элемент:

   ```xml
   <TargetFramework>net472</TargetFramework>
   ```

   и переключить его на нужную платформу. Для .NET Core 3.1 это будет:

   ```xml
   <TargetFramework>netcoreapp3.1</TargetFramework>
   ```

   Но если речь идет о библиотеке, для которой нужно сохранить поддержку сборок конкретно под .NET Framework, вы можете использовать [настройку для различных версий](../../standard/library-guidance/cross-platform-targeting.md), заменив элемент следующим образом:

   ```xml
   <TargetFrameworks>net472;netstandard2.0</TargetFrameworks>
   ```

   Если вы используете API-интерфейсы для Windows (например, для доступа к реестру), установите [пакет обеспечения совместимости Windows](./windows-compat-pack.md).

## <a name="next-steps"></a>Следующие шаги

> [!div class="nextstepaction"]
> [Анализ зависимостей](third-party-deps.md)
> [Создание пакета NuGet](../deploying/creating-nuget-packages.md)

## <a name="see-also"></a>См. также раздел

- [Миграция с ASP.NET на ASP.NET Core](/aspnet/core/migration/proper-to-2x)
- [Перенос приложений WPF на платформу .NET Core](/dotnet/desktop/wpf/migration/convert-project-from-net-framework)
- [Перенос приложений Windows Forms из .NET Framework на .NET Core](/dotnet/desktop/winforms/migration/?view=netdesktop-5.0&preserve-view=true)
