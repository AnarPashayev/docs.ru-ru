---
title: Учебник. Прогнозирование цен с помощью регрессии с использованием построителя моделей
description: В этом учебнике показано, как создать модель регрессии с помощью построителя моделей ML.NET, чтобы прогнозировать цены, в частности плату за проезд в такси по Нью-Йорку.
author: luisquintanilla
ms.author: luquinta
ms.date: 09/18/2019
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: bb344a7f01e8ffe0e40578c6fb2f28bebd2eb807
ms.sourcegitcommit: a4b10e1f2a8bb4e8ff902630855474a0c4f1b37a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/19/2019
ms.locfileid: "71117962"
---
# <a name="tutorial-predict-prices-using-regression-with-model-builder"></a>Учебник. Прогнозирование цен с помощью регрессии с использованием построителя моделей

Узнайте, как с помощью построителя моделей ML.NET создать модель регрессии для прогнозирования цен.  Консольное приложение .NET, разрабатываемое в этом учебнике, прогнозирует плату за проезд в такси по Нью-Йорку на основе исторических данных.

Шаблон прогнозирования цен, имеющийся в построителе моделей, можно использовать для любых сценариев, предполагающих прогнозирование числовых значений. Примерами могут служить прогнозирование цен на недвижимость, спроса и продаж.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
>
> - Подготовка и анализ данных
> - Выбор сценария
> - Загрузка данных
> - Обучение модели
> - Оценка модели
> - Использование модели для прогнозирования

> [!NOTE]
> Построитель моделей в настоящее время находится на этапе предварительной версии.

## <a name="pre-requisites"></a>Предварительные требования

Список необходимых условий и инструкции по установке см. в [руководстве по установке построителя моделей](../how-to-guides/install-model-builder.md).

## <a name="create-a-console-application"></a>Создание консольного приложения

1. Создайте **консольное приложение .NET Core** с именем TaxiFarePrediction.

## <a name="prepare-and-understand-the-data"></a>Подготовка и анализ данных

1. Создайте каталог с именем *Data* в папке проекта, чтобы сохранить в нем файлы набора данных.

1. Набор данных, используемый для обучения и оценки модели машинного обучения, создан на основе данных Комиссии по лицензированию перевозок автотранспортом города Нью-Йорк (TLC).

    Скачать набор данных можно по [этой ссылке](https://raw.githubusercontent.com/dotnet/machinelearning/master/test/data/taxi-fare-train.csv).

    При загрузке страницы щелкните правой кнопкой мыши в любом месте и выберите в меню команду **Сохранить как**.

    В диалоговом окне **Сохранить как** сохраните файл в созданную ранее папку *Data*.

1. В **обозревателе решений** щелкните правой кнопкой мыши файл *taxi-fare-train.csv* и выберите пункт **Свойства**. В разделе **Дополнительно** для параметра **Копировать в выходной каталог** установите значение **Копировать более позднюю версию**.

Каждая строка в наборе данных `taxi-fare-train.csv` содержит сведения о поездках в такси.

1. Откройте набор данных **taxi-fare-train.csv**.

    Предоставленный набор данных содержит следующие столбцы:

    - **vendor_id:** идентификатор поставщика услуг такси — это признак.
    - **rate_code:** тип тарифа для поездки на такси — это признак.
    - **passenger_count:** число пассажиров в поездке — это признак.
    - **trip_time_in_secs:** время, затраченное на поездку.
    - **trip_distance:** расстояние поездки — это признак.
    - **payment_type:** метод оплаты (наличные или кредитная карта) — это признак.
    - **fare_amount:** общая сумма, уплаченная за поездку на такси, — это метка.

`label` — это столбец для прогнозирования. Цель задачи регрессии — прогнозирование числового значения. В этом сценарии прогнозируется стоимость поездки в такси. Поэтому меткой является **fare_amount**. Выбранные признаки (`features`) — это входные данные, которые вы предоставляете модели для прогнозирования метки (`label`). В данном случае признаками или входными данными для прогнозирования стоимости поездки служат все остальные столбцы.

## <a name="choose-a-scenario"></a>Выбор сценария

Чтобы обучить модель, нужно выбрать один из доступных сценариев машинного обучения в построителе моделей. В этом случае используется сценарий `Price Prediction`.

1. В **обозревателе решений** щелкните правой кнопкой мыши проект *TaxiFarePrediction* и выберите **Добавить** > **Машинное обучение**.
1. На этапе выбора сценария выберите *Прогнозирование цен*.

## <a name="load-the-data"></a>Загрузка данных

Построитель моделей принимает данные из двух источников: базы данных SQL Server или локального файла в формате CSV или TSV.

1. На этапе добавления данных выберите в раскрывающемся списке источников данных пункт *Прогнозирование цен*.
1. Нажмите кнопку рядом с текстовым полем *Выберите файл* и выберите в проводнике файл *taxi-fare-test.csv* в каталоге *Data*.
1. В раскрывающемся списке *Метка или прогнозируемый столбец* выберите *fare_amount* и перейдите к шагу обучения в построителе моделей.

## <a name="train-the-model"></a>Обучение модели

Задачей машинного обучения, используемой в этом учебнике для обучения модели прогнозирования цен, является регрессия. В процессе обучения построитель моделей обучает отдельные модели с помощью различных алгоритмов и параметров регрессии, определяя оптимальную модель для вашего набора данных.

Время, требуемое для обучения модели, пропорционально объему данных. Построитель моделей автоматически выбирает значение по умолчанию для параметра **Time to train (seconds)** (Время обучения в секундах) в зависимости от размера источника данных.

1. Оставьте значение по умолчанию для параметра *Time to train (seconds)* (Время обучения в секундах), если только вы не хотите проводить обучение более длительное время.
2. Выберите *Начать обучение*.

В процессе обучения сведения о ходе выполнения отображаются в разделе `Progress` шага обучения.

- "Состояние" — это состояние завершения процесса обучения.
- "Наибольшая точность" — это точность модели, которая на данный момент определена построителем моделей как лучшая. Точность зависит от того, насколько правильный прогноз был сделан моделью на основе тестовых данных.
- "Лучший алгоритм" — это название алгоритма, который на данный момент определен построителем моделей как лучший.
- "Последний алгоритм" — это название алгоритма, который использовался построителем моделей для обучения модели последним.

По завершении обучения перейдите к шагу оценки.

## <a name="evaluate-the-model"></a>Оценка модели

Результат обучения — одна модель с наивысшей точностью. В шаге оценки в разделе результатов будет указан алгоритм, используемый оптимальной моделью, в поле *Лучшая модель*, а также метрики в поле *Качество лучшей модели (достоверность аппроксимации)* . Кроме того, приводится сводная таблица с пятью лучшими моделями и их метриками.

Если вас не удовлетворяют метрики точности, самые простые способы повысить точность модели — увеличить длительность обучения или использовать больше данных. Если все в порядке, переходите к следующему шагу.

## <a name="add-the-code-to-make-predictions"></a>Добавление кода для прогнозирования

В результате процесса обучения создаются два проекта.

- TaxiFarePredictionML.ConsoleApp: консольное приложение .NET Core с кодом обучения и использования модели.
- TaxiFarePredictionML.Model: библиотека классов .NET Standard с моделями данных, которые определяют схему входных и выходных данных модели, а также хранимую версию оптимальной модели.

1. На шаге добавления кода в построителе моделей выберите **Добавить проекты**, чтобы добавить автоматически созданные проекты в решение.
1. Щелкните правой кнопкой мыши проект *TaxiFarePrediction*. Выберите **Добавить > Ссылка**. Выберите узел **Проекты > Решение**, установите в списке флажок рядом с проектом *TaxiFarePredictionML.Model* и нажмите кнопку "ОК".
1. Откройте файл *Program.cs* в проекте *TaxiFarePrediction*.
1. Добавьте следующие операторы using, ссылающиеся на пакет NuGet *Microsoft.ML* и проект *TaxiFarePredictionML.Model*:

    ```csharp
    using System;
    using Microsoft.ML;
    using TaxiFarePredictionML.Model.DataModels;
    ```

1. Добавьте метод `ConsumeModel` в класс `Program`.

    ```csharp
    static ModelOutput ConsumeModel(ModelInput input)
    {
        // 1. Load the model
        MLContext mlContext = new MLContext();
        ITransformer mlModel = mlContext.Model.Load("MLModel.zip", out var modelInputSchema);

        // 2. Create PredictionEngine
        var predictionEngine = mlContext.Model.CreatePredictionEngine<ModelInput, ModelOutput>(mlModel);

        // 3. Use PredictionEngine to use model on input data
        ModelOutput result = predictionEngine.Predict(input);

        // 4. Return prediction result
        return result;
    }
    ```

    `ConsumeModel` загружает обученную модель, создает [`PredictionEngine`](xref:Microsoft.ML.PredictionEngine%602) для модели и с помощью этой подсистемы прогнозирования делает прогнозы по новым данным.

1. Чтобы сделать прогноз по новым данным с помощью модели, создайте экземпляр класса `ModelInput` и используйте метод `ConsumeModel`. Обратите внимание, что данные о суммах, уплаченных за поездку на такси, отсутствуют во входных данных. Это сделано для того, чтобы модель сама спрогнозировала их. Добавьте в метод `Main` приведенный ниже код и запустите приложение.

    ```csharp
    // Create sample data
    ModelInput input = new ModelInput()
    {
        Vendor_id = "CMT",
        Rate_code = 1,
        Passenger_count = 1,
        Trip_time_in_secs = 1271,
        Trip_distance = 3.8f,
        Payment_type = "CRD"
    };

    // Make prediction
    ModelOutput prediction = ConsumeModel(input);

    // Print Prediction
    Console.WriteLine($"Predicted Fare: {prediction.Score}");
    Console.ReadKey();
    ```

    Выходные данные программы должны выглядеть примерно так:

    ```bash
    Predicted Fare: 16.82245
    ```

Если на созданные проекты нужно будет сослаться позднее в другом решении, их можно найти в каталоге `C:\Users\%USERNAME%\AppData\Local\Temp\MLVSTools`.

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:
> [!div class="checklist"]
>
> - Подготовка и анализ данных
> - Выбор сценария
> - Загрузка данных
> - Обучение модели
> - Оценка модели
> - Использование модели для прогнозирования

### <a name="additional-resources"></a>Дополнительные ресурсы

Дополнительные сведения см. в следующих статьях:

- [Сценарии для построителя моделей](../automate-training-with-model-builder.md#scenarios)
- [Регрессия](../resources/glossary.md#regression)
- [Метрики модели регрессии](../resources/metrics.md#metrics-for-regression)
- [Набор данных о поездках на такси, предоставленный Комиссией по лицензированию перевозок автотранспортом города Нью-Йорк (TLC)](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml)
