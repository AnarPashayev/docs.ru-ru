---
title: Прогнозирование цен с помощью регрессии с использованием построителя моделей
description: В этом учебнике показано, как создать модель регрессии с помощью построителя моделей ML.NET, чтобы прогнозировать цены, в частности плату за проезд в такси по Нью-Йорку.
author: luisquintanilla
ms.author: luquinta
ms.date: 06/26/2019
ms.topic: tutorial
ms.custom: mvc
ms.openlocfilehash: db9788e3065a0f2f21d712b2d4826efea2d8a829
ms.sourcegitcommit: 52e588dc2ee74d484cd07ac60076be25cbf777ab
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/27/2019
ms.locfileid: "67410582"
---
# <a name="predict-prices-using-regression-with-model-builder"></a>Прогнозирование цен с помощью регрессии с использованием построителя моделей

Узнайте, как с помощью построителя моделей ML.NET создать [модель регрессии](../resources/glossary.md#regression) для прогнозирования цен.  Консольное приложение .NET, разрабатываемое в этом учебнике, прогнозирует плату за проезд в такси по Нью-Йорку на основе исторических данных.

Шаблон прогнозирования цен, имеющийся в построителе моделей, можно использовать для любых сценариев, предполагающих прогнозирование числовых значений. Примерами могут служить прогнозирование цен на недвижимость, спроса и продаж.

В этом руководстве вы узнаете, как:
> [!div class="checklist"]
> * Подготовка и анализ данных
> * Выбор сценария
> * Загрузка данных
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

> [!NOTE]
> Построитель моделей в настоящее время находится на этапе предварительной версии.

## <a name="pre-requisites"></a>Предварительные требования

Список необходимых условий и инструкции по установке см. в [руководстве по установке построителя моделей](../how-to-guides/install-model-builder.md).

## <a name="create-a-console-application"></a>Создание консольного приложения

1. Создайте **консольное приложение .NET Core** с именем TaxiFarePrediction.

1. Установите пакет NuGet для **Microsoft.ML**:

    В **обозревателе решений** щелкните правой кнопкой мыши проект *TaxiFarePrediction* и выберите пункт **Управление пакетами NuGet**. Выберите в качестве источника пакета "nuget.org", откройте вкладку **Обзор**, найдите **Microsoft.ML**, выберите пакет в списке и нажмите кнопку **Установить**. Нажмите кнопку **ОК** в диалоговом окне **Предварительный просмотр изменений**, а затем нажмите кнопку **Принимаю** в диалоговом окне **Принятие условий лицензионного соглашения**, если вы согласны с указанными условиями лицензионного соглашения для выбранных пакетов.

## <a name="prepare-and-understand-the-data"></a>Подготовка и анализ данных

1. Создайте каталог с именем *Data* в папке проекта, чтобы сохранить в нем файлы набора данных.

1. Скачайте набор данных [taxi-fare-train.csv](https://github.com/dotnet/machinelearning/blob/master/test/data/taxi-fare-train.csv) и сохраните его в папке *Data*, созданной в предыдущем шаге. Этот набор данных используется для обучения и оценки модели машинного обучения. Он взят из [набора данных NYC TLC Taxi Trip](http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml).

1. В **обозревателе решений** щелкните правой кнопкой мыши файл *taxi-fare-train.csv* и выберите пункт **Свойства**. В разделе **Дополнительно** для параметра **Копировать в выходной каталог** установите значение **Копировать более позднюю версию**.

Каждая строка в наборе данных `taxi-fare-train.csv` содержит сведения о поездках в такси. 

1. Откройте набор данных **taxi-fare-train.csv**.

    Предоставленный набор данных содержит следующие столбцы:

    * **vendor_id:** идентификатор поставщика услуг такси — это признак.
    * **rate_code:** тип тарифа для поездки на такси — это признак.
    * **passenger_count:** число пассажиров в поездке — это признак.
    * **trip_time_in_secs:** время, затраченное на поездку. Вам требуется спрогнозировать плату за одну поездку до того, как поездка будет завершена. На этот момент вам неизвестна продолжительность поездки. Таким образом, продолжительность поездки не является признаком и соответствующий столбец следует исключить из модели.
    * **trip_distance:** расстояние поездки — это признак.
    * **payment_type:** метод оплаты (наличные или кредитная карта) — это признак.
    * **fare_amount:** общая сумма, уплаченная за поездку на такси, — это метка.

`label` — это столбец для прогнозирования. Цель задачи регрессии — прогнозирование числового значения. В этом сценарии прогнозируется стоимость поездки в такси. Поэтому меткой является **fare_amount**. Выбранные признаки (`features`) — это входные данные, которые вы предоставляете модели для прогнозирования метки (`label`). В данном случае признаками или входными данными для прогнозирования стоимости поездки служат все остальные столбцы.

## <a name="choose-a-scenario"></a>Выбор сценария

Чтобы обучить модель, нужно выбрать один из доступных сценариев машинного обучения в построителе моделей. В этом случае используется сценарий `Price Prediction`. Более полный список см. в [обзорной статье по построителю моделей](../automate-training-with-model-builder.md#scenarios).

1. В **обозревателе решений** щелкните правой кнопкой мыши проект *TaxiFarePrediction* и выберите **Добавить** > **Машинное обучение**.
1. На этапе выбора сценария выберите *Прогнозирование цен*.

## <a name="load-the-data"></a>Загрузка данных

Построитель моделей принимает данные из двух источников: базы данных SQL Server либо локального файла CSV или TSV. Дополнительные сведения о требованиях к формату данных см. [здесь](../how-to-guides/install-model-builder.md#limitations).

1. На этапе добавления данных выберите в раскрывающемся списке источников данных пункт *Прогнозирование цен*.
1. Нажмите кнопку рядом с текстовым полем *Выберите файл* и выберите в проводнике файл *taxi-fare-test.csv* в каталоге *Data*.
1. В раскрывающемся списке *Метка или прогнозируемый столбец* выберите *fare_amount* и перейдите к шагу обучения в построителе моделей.

## <a name="train-the-model"></a>Обучение модели

Задачей машинного обучения, используемой в этом учебнике для обучения модели прогнозирования цен, является регрессия. В процессе обучения построитель моделей обучает отдельные модели с помощью различных алгоритмов и параметров регрессии, определяя оптимальную модель для вашего набора данных.

Время, требуемое для обучения модели, пропорционально объему данных. Чтобы выбрать подходящее значение для поля `Time to train (seconds)`, можно опираться на следующую таблицу:

Размер набора данных  | Тип набора данных       | Среднее Время обучения
------------- | ------------------ | --------------
0–10 МБ     | Числа и текст   | 10 с
10–100 МБ   | Числа и текст   | 10 мин
100–500 МБ  | Числа и текст   | 30 мин
500 МБ — 1 ГБ    | Числа и текст   | 60 мин
Более 1 ГБ         | Числа и текст   | Более 3 часов

1. Так как размер файла с данными для обучения превышает 10 МБ, используйте для поля *Время обучения (в секундах)* значение 600 секунд (10 минут).
2. Выберите *Начать обучение*.

В процессе обучения сведения о ходе выполнения отображаются в разделе `Progress` шага обучения.

- "Состояние" — это состояние завершения процесса обучения.
- "Наибольшая точность" — это точность модели, которая на данный момент определена построителем моделей как лучшая. Точность зависит от того, насколько правильный прогноз был сделан моделью на основе тестовых данных. 
- "Лучший алгоритм" — это название алгоритма, который на данный момент определен построителем моделей как лучший.
- "Последний алгоритм" — это название алгоритма, который использовался построителем моделей для обучения модели последним.

По завершении обучения перейдите к шагу оценки.

## <a name="evaluate-the-model"></a>Оценка модели

Результат обучения — одна модель с наивысшей точностью. В шаге оценки в разделе результатов будет указан алгоритм, используемый оптимальной моделью, в поле *Лучшая модель*, а также метрики в поле *Качество лучшей модели (достоверность аппроксимации)* . Кроме того, приводится сводная таблица с пятью лучшими моделями и их метриками. Дополнительные сведения об оценке метрик модели см. [здесь](https://docs.microsoft.com/dotnet/machine-learning/resources/metrics).

Если вас не удовлетворяют метрики точности, самые простые способы повысить точность модели — увеличить длительность обучения или использовать больше данных.

## <a name="use-the-model-for-predictions"></a>Использование модели для прогнозирования

В результате процесса обучения создаются два проекта.

- TaxiFarePredictionML.ConsoleApp: консольное приложение .NET с кодом обучения и использования модели.
- TaxiFarePredictionML.Model: библиотека классов .NET Standard с моделями данных, которые определяют схему входных и выходных данных модели, а также хранимую версию оптимальной модели.

1. В разделе кода в построителе моделей выберите элемент **Добавленные проекты**, чтобы добавить проекты в решение.
1. В обозревателе решений щелкните правой кнопкой мыши проект *TaxiFarePrediction*. Затем выберите **Добавить > Существующий элемент**. В раскрывающемся списке типов файлов выберите пункт `All Files` (Все файлы), перейдите в каталог проекта *TaxiFarePredictionML.Model* и выберите файл `MLModel.zip`. Затем щелкните добавленный файл `MLModel.zip` правой кнопкой мыши и выберите пункт *Свойства*. Для параметра "Копировать в выходной каталог" выберите в раскрывающемся списке пункт *Копировать, если новее*.
1. Щелкните правой кнопкой мыши проект *TaxiFarePrediction*. Выберите **Добавить > Ссылка**. Выберите узел **Проекты > Решение**, установите в списке флажок рядом с проектом *TaxiFarePredictionML.Model* и нажмите кнопку "ОК".

4. Откройте файл *Program.cs* в проекте *TaxiFarePrediction*.
5. Добавьте операторы using:

    ```csharp
    using System;
    using Microsoft.ML;
    using TaxiFarePredictionML.Model.DataModels;
    ```

6. Добавьте метод `ConsumeModel` в класс `Program`. Метод `ConsumeModel` создаст `PredictionEngine` на основе модели, созданной построителем моделей, с целью составления прогнозов на основе новых данных и вывода их в консоль.

    ```csharp
    static ModelOutput ConsumeModel(ModelInput input)
    {
        // 1. Load the model
        MLContext mlContext = new MLContext();
        ITransformer mlModel = mlContext.Model.Load("MLModel.zip", out var modelInputSchema);

        // 2. Create PredictionEngine
        var predictionEngine = mlContext.Model.CreatePredictionEngine<ModelInput, ModelOutput>(mlModel);

        // 3. Use PredictionEngine to use model on input data
        ModelOutput result = predictionEngine.Predict(input);

        // 4. Return prediction result
        return result;
    }
    ```

7. Добавьте в метод `Main` приведенный ниже код и запустите приложение.

    ```csharp
    // Create sample data
    ModelInput input = new ModelInput()
    {
        Vendor_id = "CMT",
        Rate_code = 1,
        Passenger_count = 1,
        Trip_time_in_secs = 1271,
        Trip_distance = 3.8f,
        Payment_type = "CRD"
    };

    // Make prediction
    ModelOutput prediction = ConsumeModel(input);

    // Print Prediction
    Console.WriteLine($"Predicted Fare: {prediction.Score}");
    Console.ReadKey();
    ```

    Выходные данные программы должны выглядеть примерно так:

    ```bash
    Predicted Fare: 16.82245
    ```

Если на созданные проекты нужно будет сослаться позднее в другом решении, их можно найти в каталоге `C:\Users\%USERNAME%\AppData\Local\Temp\MLVSTools`.

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как:
> [!div class="checklist"]
> * Подготовка и анализ данных
> * Выбор сценария
> * Загрузка данных
> * Обучение модели
> * Оценка модели
> * Использование модели для прогнозирования

Перейдите к одному из следующих руководств, чтобы узнать, как развернуть модель:

> [!div class="nextstepaction"]
> [Развертывание модели в Функциях Azure](../how-to-guides/serve-model-serverless-azure-functions-ml-net.md)
> [!div class="nextstepaction"]
> [Развертывание модели в веб-API](../how-to-guides/serve-model-web-api-ml-net.md)
