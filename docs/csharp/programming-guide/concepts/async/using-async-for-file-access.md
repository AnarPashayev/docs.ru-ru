---
title: Асинхронный доступ к файлам (C#)
description: Узнайте, как использовать функцию Async для доступа к файлам в C#. Можно вызывать асинхронные методы, не прибегая к использованию обратных вызовов или разделению кода между методами.
ms.date: 08/19/2020
ms.assetid: bb018fea-5313-4c80-ab3f-7c24b2145bd9
ms.openlocfilehash: 9a8db6004e8fff2cb39f0c350b403b56ea619e54
ms.sourcegitcommit: 9c45035b781caebc63ec8ecf912dc83fb6723b1f
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/25/2020
ms.locfileid: "88812046"
---
# <a name="asynchronous-file-access-c"></a><span data-ttu-id="f6c82-104">Асинхронный доступ к файлам (C#)</span><span class="sxs-lookup"><span data-stu-id="f6c82-104">Asynchronous file access (C#)</span></span>

<span data-ttu-id="f6c82-105">Для доступа к файлам можно использовать функцию Async.</span><span class="sxs-lookup"><span data-stu-id="f6c82-105">You can use the async feature to access files.</span></span> <span data-ttu-id="f6c82-106">При использовании функции Async вы можете вызывать асинхронные методы без использования обратных вызовов или разделения вашего кода на множество методов или лямбда-выражений.</span><span class="sxs-lookup"><span data-stu-id="f6c82-106">By using the async feature, you can call into asynchronous methods without using callbacks or splitting your code across multiple methods or lambda expressions.</span></span> <span data-ttu-id="f6c82-107">Для выполнения последовательного кода асинхронно просто вызовите асинхронный метод вместо синхронного метода и добавьте несколько ключевых слов в код.</span><span class="sxs-lookup"><span data-stu-id="f6c82-107">To make synchronous code asynchronous, you just call an asynchronous method instead of a synchronous method and add a few keywords to the code.</span></span>

<span data-ttu-id="f6c82-108">Можно рассмотреть следующие причины для добавления асинхронности для вызовов для доступа к файлам.</span><span class="sxs-lookup"><span data-stu-id="f6c82-108">You might consider the following reasons for adding asynchrony to file access calls:</span></span>

> [!div class="checklist"]
>
> - <span data-ttu-id="f6c82-109">Асинхронность делает приложения пользовательского интерфейса более отзывчивыми, потому что поток пользовательского интерфейса, который запускает операцию, может продолжать выполнять и другую работу.</span><span class="sxs-lookup"><span data-stu-id="f6c82-109">Asynchrony makes UI applications more responsive because the UI thread that launches the operation can perform other work.</span></span> <span data-ttu-id="f6c82-110">Если поток пользовательского интерфейса должен выполнять код, который занимает много времени (например, более 50 миллисекунд), пользовательский интерфейс можно приостановить до тех пор, пока не будет завершен ввод-вывод, и затем пользовательский интерфейс сможет снова обрабатывать ввод с клавиатуры, мыши и другие события.</span><span class="sxs-lookup"><span data-stu-id="f6c82-110">If the UI thread must execute code that takes a long time (for example, more than 50 milliseconds), the UI may freeze until the I/O is complete and the UI thread can again process keyboard and mouse input and other events.</span></span>
> - <span data-ttu-id="f6c82-111">Асинхронность улучшает масштабируемость ASP.NET и других серверных приложений за счет уменьшения необходимости использования потоков.</span><span class="sxs-lookup"><span data-stu-id="f6c82-111">Asynchrony improves the scalability of ASP.NET and other server-based applications by reducing the need for threads.</span></span> <span data-ttu-id="f6c82-112">Если приложение использует выделенный поток на ответ и тысяча запросов приходит одновременно, тысяча потоков не потребуется.</span><span class="sxs-lookup"><span data-stu-id="f6c82-112">If the application uses a dedicated thread per response and a thousand requests are being handled simultaneously, a thousand threads are needed.</span></span> <span data-ttu-id="f6c82-113">Асинхронные операции часто не нуждаются в пользовании потоком во время ожидания.</span><span class="sxs-lookup"><span data-stu-id="f6c82-113">Asynchronous operations often don't need to use a thread during the wait.</span></span> <span data-ttu-id="f6c82-114">Они пользуются существующим потоком завершения ввода-вывода короткое время в конце.</span><span class="sxs-lookup"><span data-stu-id="f6c82-114">They use the existing I/O completion thread briefly at the end.</span></span>
> - <span data-ttu-id="f6c82-115">Задержка операции доступа к файлу может быть очень низкой при текущих условиях, но может значительно увеличиться в будущем.</span><span class="sxs-lookup"><span data-stu-id="f6c82-115">The latency of a file access operation might be very low under current conditions, but the latency may greatly increase in the future.</span></span> <span data-ttu-id="f6c82-116">Например, файл может быть перемещен на сервер через Интернет.</span><span class="sxs-lookup"><span data-stu-id="f6c82-116">For example, a file may be moved to a server that's across the world.</span></span>
> - <span data-ttu-id="f6c82-117">Добавленные издержки при использовании функции Async являются малыми.</span><span class="sxs-lookup"><span data-stu-id="f6c82-117">The added overhead of using the Async feature is small.</span></span>
> - <span data-ttu-id="f6c82-118">Асинхронные задачи могут легко выполняться параллельно.</span><span class="sxs-lookup"><span data-stu-id="f6c82-118">Asynchronous tasks can easily be run in parallel.</span></span>

## <a name="use-appropriate-classes"></a><span data-ttu-id="f6c82-119">Использование соответствующих классов</span><span class="sxs-lookup"><span data-stu-id="f6c82-119">Use appropriate classes</span></span>

<span data-ttu-id="f6c82-120">В простых примерах в этом разделе демонстрируются <xref:System.IO.File.WriteAllTextAsync%2A?displayProperty=nameWithType> и <xref:System.IO.File.ReadAllTextAsync%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="f6c82-120">The simple examples in this topic demonstrate <xref:System.IO.File.WriteAllTextAsync%2A?displayProperty=nameWithType> and <xref:System.IO.File.ReadAllTextAsync%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="f6c82-121">Для конечного контроля над операциями файлового ввода-вывода используйте класс <xref:System.IO.FileStream>, содержащий параметр, который вызывает асинхронный ввод-вывод на уровне операционной системы.</span><span class="sxs-lookup"><span data-stu-id="f6c82-121">For finite control over the file I/O operations, use the <xref:System.IO.FileStream> class, which has an option that causes asynchronous I/O to occur at the operating system level.</span></span> <span data-ttu-id="f6c82-122">С помощью этого параметра можно избежать блокирования пула потоков во многих случаях.</span><span class="sxs-lookup"><span data-stu-id="f6c82-122">By using this option, you can avoid blocking a thread pool thread in many cases.</span></span> <span data-ttu-id="f6c82-123">Чтобы включить этот параметр, необходимо добавить в вызов конструктора аргумент `useAsync=true` или `options=FileOptions.Asynchronous`.</span><span class="sxs-lookup"><span data-stu-id="f6c82-123">To enable this option, you specify the `useAsync=true` or `options=FileOptions.Asynchronous` argument in the constructor call.</span></span>

<span data-ttu-id="f6c82-124">Этот параметр нельзя использовать с классами <xref:System.IO.StreamReader> и <xref:System.IO.StreamWriter>, если вы открываете их напрямую (указав путь к файлу).</span><span class="sxs-lookup"><span data-stu-id="f6c82-124">You can't use this option with <xref:System.IO.StreamReader> and <xref:System.IO.StreamWriter> if you open them directly by specifying a file path.</span></span> <span data-ttu-id="f6c82-125">При этом параметр можно использовать, если им предоставлен <xref:System.IO.Stream>, открытый классом <xref:System.IO.FileStream>.</span><span class="sxs-lookup"><span data-stu-id="f6c82-125">However, you can use this option if you provide them a <xref:System.IO.Stream> that the <xref:System.IO.FileStream> class opened.</span></span> <span data-ttu-id="f6c82-126">Асинхронные вызовы выполняются быстрее в приложениях пользовательского интерфейса, даже если поток в пуле потоков блокирован, поскольку поток пользовательского интерфейса не блокирован во время ожидания.</span><span class="sxs-lookup"><span data-stu-id="f6c82-126">Asynchronous calls are faster in UI apps even if a thread pool thread is blocked, because the UI thread isn't blocked during the wait.</span></span>

## <a name="write-text"></a><span data-ttu-id="f6c82-127">Запись текста</span><span class="sxs-lookup"><span data-stu-id="f6c82-127">Write text</span></span>

<span data-ttu-id="f6c82-128">Следующие примеры записывают текст в файл.</span><span class="sxs-lookup"><span data-stu-id="f6c82-128">The following examples write text to a file.</span></span> <span data-ttu-id="f6c82-129">На каждой точке await происходит немедленный выход из метода.</span><span class="sxs-lookup"><span data-stu-id="f6c82-129">At each await statement, the method immediately exits.</span></span> <span data-ttu-id="f6c82-130">После завершения файлового ввода-вывода метод возобновляет работу с пункта, следующего за await.</span><span class="sxs-lookup"><span data-stu-id="f6c82-130">When the file I/O is complete, the method resumes at the statement that follows the await statement.</span></span> <span data-ttu-id="f6c82-131">Модификатор async в определении методов требует наличия await в теле метода.</span><span class="sxs-lookup"><span data-stu-id="f6c82-131">The async modifier is in the definition of methods that use the await statement.</span></span>

### <a name="simple-example"></a><span data-ttu-id="f6c82-132">Простой пример</span><span class="sxs-lookup"><span data-stu-id="f6c82-132">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleWrite":::

### <a name="finite-control-example"></a><span data-ttu-id="f6c82-133">Пример конечного элемента управления</span><span class="sxs-lookup"><span data-stu-id="f6c82-133">Finite control example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="WriteText":::

<span data-ttu-id="f6c82-134">Первоначальная строка с оператором `await sourceStream.WriteAsync(encodedText, 0, encodedText.Length);` является сокращенной формой записи двух следующих операторов:</span><span class="sxs-lookup"><span data-stu-id="f6c82-134">The original example has the statement `await sourceStream.WriteAsync(encodedText, 0, encodedText.Length);`, which is a contraction of the following two statements:</span></span>

```csharp
Task theTask = sourceStream.WriteAsync(encodedText, 0, encodedText.Length);
await theTask;
```

<span data-ttu-id="f6c82-135">Первый оператор возвращает задачу и вызывает запуск обработки файла.</span><span class="sxs-lookup"><span data-stu-id="f6c82-135">The first statement returns a task and causes file processing to start.</span></span> <span data-ttu-id="f6c82-136">Вторая строка с await немедленно оставляет метод и возвращается в другую задачу.</span><span class="sxs-lookup"><span data-stu-id="f6c82-136">The second statement with the await causes the method to immediately exit and return a different task.</span></span> <span data-ttu-id="f6c82-137">При окончании обработки файла выполнение возвращается в точку выполнения, которая следует за await.</span><span class="sxs-lookup"><span data-stu-id="f6c82-137">When the file processing later completes, execution returns to the statement that follows the await.</span></span>

## <a name="read-text"></a><span data-ttu-id="f6c82-138">Чтение текста</span><span class="sxs-lookup"><span data-stu-id="f6c82-138">Read text</span></span>

<span data-ttu-id="f6c82-139">Следующий пример считывает текст из файла.</span><span class="sxs-lookup"><span data-stu-id="f6c82-139">The following examples read text from a file.</span></span>

### <a name="simple-example"></a><span data-ttu-id="f6c82-140">Простой пример</span><span class="sxs-lookup"><span data-stu-id="f6c82-140">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleRead":::

### <a name="finite-control-example"></a><span data-ttu-id="f6c82-141">Пример конечного элемента управления</span><span class="sxs-lookup"><span data-stu-id="f6c82-141">Finite control example</span></span>

<span data-ttu-id="f6c82-142">Текст добавляется в буфер обмена, а затем, в данном случае, помещается в <xref:System.Text.StringBuilder>.</span><span class="sxs-lookup"><span data-stu-id="f6c82-142">The text is buffered and, in this case, placed into a <xref:System.Text.StringBuilder>.</span></span> <span data-ttu-id="f6c82-143">В отличие от предыдущего примера await выдаёт в результате значение.</span><span class="sxs-lookup"><span data-stu-id="f6c82-143">Unlike in the previous example, the evaluation of the await produces a value.</span></span> <span data-ttu-id="f6c82-144">Метод <xref:System.IO.Stream.ReadAsync%2A> возвращает <xref:System.Threading.Tasks.Task>\<<xref:System.Int32>>, поэтому по завершении операции оценка await выдает значение `Int32` `numRead`.</span><span class="sxs-lookup"><span data-stu-id="f6c82-144">The <xref:System.IO.Stream.ReadAsync%2A> method returns a <xref:System.Threading.Tasks.Task>\<<xref:System.Int32>>, so the evaluation of the await produces an `Int32` value `numRead` after the operation completes.</span></span> <span data-ttu-id="f6c82-145">Дополнительные сведения см. в разделе [Асинхронные типы возвращаемых значений (C#)](async-return-types.md).</span><span class="sxs-lookup"><span data-stu-id="f6c82-145">For more information, see [Async Return Types (C#)](async-return-types.md).</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="ReadText":::

## <a name="parallel-asynchronous-io"></a><span data-ttu-id="f6c82-146">Параллельный асинхронный ввод-вывод</span><span class="sxs-lookup"><span data-stu-id="f6c82-146">Parallel asynchronous I/O</span></span>

<span data-ttu-id="f6c82-147">В следующем примере показана параллельная обработка при записи 10 текстовых файлов.</span><span class="sxs-lookup"><span data-stu-id="f6c82-147">The following examples demonstrate parallel processing by writing 10 text files.</span></span>

### <a name="simple-example"></a><span data-ttu-id="f6c82-148">Простой пример</span><span class="sxs-lookup"><span data-stu-id="f6c82-148">Simple example</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="SimpleParallelWrite":::

### <a name="finite-control-example"></a><span data-ttu-id="f6c82-149">Пример конечного элемента управления</span><span class="sxs-lookup"><span data-stu-id="f6c82-149">Finite control example</span></span>

<span data-ttu-id="f6c82-150">Для каждого файла метод <xref:System.IO.Stream.WriteAsync%2A> возвращает задачу, которая затем добавляется в список задач.</span><span class="sxs-lookup"><span data-stu-id="f6c82-150">For each file, the <xref:System.IO.Stream.WriteAsync%2A> method returns a task that is then added to a list of tasks.</span></span> <span data-ttu-id="f6c82-151">Оператор `await Task.WhenAll(tasks);` существует и возобновляется в методе, как только завершается обработка файла для всех задач.</span><span class="sxs-lookup"><span data-stu-id="f6c82-151">The `await Task.WhenAll(tasks);` statement exits the method and resumes within the method when file processing is complete for all of the tasks.</span></span>

<span data-ttu-id="f6c82-152">Пример закрывает все экземпляры <xref:System.IO.FileStream> в блоке `finally` после завершения всех задач.</span><span class="sxs-lookup"><span data-stu-id="f6c82-152">The example closes all <xref:System.IO.FileStream> instances in a `finally` block after the tasks are complete.</span></span> <span data-ttu-id="f6c82-153">Если бы вместо этого каждый `FileStream` был бы создан в операторе `using`, то `FileStream` можно было бы удалить до завершения задачи.</span><span class="sxs-lookup"><span data-stu-id="f6c82-153">If each `FileStream` was instead created in a `using` statement, the `FileStream` might be disposed of before the task was complete.</span></span>

<span data-ttu-id="f6c82-154">Любое увеличение производительности зависит почти полностью от параллельной, а не асинхронной обработки.</span><span class="sxs-lookup"><span data-stu-id="f6c82-154">Any performance boost is almost entirely from the parallel processing and not the asynchronous processing.</span></span> <span data-ttu-id="f6c82-155">Преимущества асинхронности в том, что она не привязана к количеству потоков и не связана с потоком пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="f6c82-155">The advantages of asynchrony are that it doesn't tie up multiple threads, and that it doesn't tie up the user interface thread.</span></span>

:::code language="csharp" source="snippets/file-access/Program.cs" id="ParallelWriteText":::

<span data-ttu-id="f6c82-156">При использовании методов <xref:System.IO.Stream.WriteAsync%2A> и <xref:System.IO.Stream.ReadAsync%2A> можно указать <xref:System.Threading.CancellationToken>, который позволяет отменить операцию в середине потока.</span><span class="sxs-lookup"><span data-stu-id="f6c82-156">When using the <xref:System.IO.Stream.WriteAsync%2A> and <xref:System.IO.Stream.ReadAsync%2A> methods, you can specify a <xref:System.Threading.CancellationToken>, which you can use to cancel the operation mid-stream.</span></span> <span data-ttu-id="f6c82-157">Подробные сведения см. в статье [Отмена в управляемых потоках](../../../../standard/threading/cancellation-in-managed-threads.md).</span><span class="sxs-lookup"><span data-stu-id="f6c82-157">For more information, see [Cancellation in managed threads](../../../../standard/threading/cancellation-in-managed-threads.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="f6c82-158">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="f6c82-158">See also</span></span>

- [<span data-ttu-id="f6c82-159">Асинхронное программирование с использованием ключевых слов Async и Await (C#)</span><span class="sxs-lookup"><span data-stu-id="f6c82-159">Asynchronous programming with async and await (C#)</span></span>](index.md)
- [<span data-ttu-id="f6c82-160">Типы возвращаемых значений асинхронных операций (C#)</span><span class="sxs-lookup"><span data-stu-id="f6c82-160">Async return types (C#)</span></span>](async-return-types.md)
