---
title: Модель асинхронного программирования задач (TAP) с использованием ключевых слов async и await (C#)
description: Узнайте, когда и как использовать асинхронное программирование на основе задач, которое представляет собой упрощенный подход к асинхронному программированию в C#.
ms.date: 08/19/2020
ms.assetid: 9bcf896a-5826-4189-8c1a-3e35fa08243a
ms.openlocfilehash: 1014e38dcb3e2c4f56c8b3f3dade9bdbff3abd27
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/15/2020
ms.locfileid: "90556041"
---
# <a name="task-asynchronous-programming-model"></a>Асинхронная модель программирования

Асинхронное программирование позволяет избежать появления узких мест производительности и увеличить общую скорость реагирования приложения. Однако традиционные методы создания асинхронных приложений могут оказаться сложными, как в плане написания кода, так и в плане отладки и обслуживания.

[C# 5](../../../whats-new/csharp-version-history.md#c-version-50) вводит упрощенный подход асинхронного программирования, который использует асинхронные возможности .NET Framework 4.5 и более поздних версий, .NET Core и среды выполнения Windows. Компилятор выполняет сложную работу, которую раньше делал разработчик, при этом логическая структура кода приложения похожа на синхронный код. То есть можно пользоваться всеми преимуществами асинхронного программирования с гораздо меньшими, чем обычно, трудозатратами.

В этом разделе рассматриваются области и методы использования асинхронного программирования, а также приводятся ссылки на вспомогательные разделы с дополнительными сведениями и примерами.

## <a name="async-improves-responsiveness"></a><a name="BKMK_WhentoUseAsynchrony"></a> Async повышает скорость реагирования

Асинхронность необходимо использовать при наличии потенциально блокирующих работу действий, например при осуществлении доступа к Интернету. Доступ к веб-ресурсу иногда осуществляется медленно или с задержкой. Если такое действие блокируется в синхронном процессе, все приложение вынуждено ожидать. В асинхронном процессе приложение может перейти к следующей операции, не зависящей от веб-ресурса, до завершения блокирующей задачи.

В следующей таблице показаны стандартные области, в которых асинхронное программирование повышает скорость реагирования. Перечисленные API-интерфейсы платформы .NET и среды выполнения Windows содержат методы, поддерживающие асинхронное программирование.

| Область приложения | Типы .NET с методами Async | Типы среды выполнения Windows с методами Async |
|--|--|--|
| Веб-доступ | <xref:System.Net.Http.HttpClient> | <xref:Windows.Web.Http.HttpClient?displayProperty=nameWithType> <br> <xref:Windows.Web.Syndication.SyndicationClient> |
| Работа с файлами | <xref:System.Text.Json.JsonSerializer> <br> <xref:System.IO.StreamReader> <br> <xref:System.IO.StreamWriter> <br> <xref:System.Xml.XmlReader> <br> <xref:System.Xml.XmlWriter> | <xref:Windows.Storage.StorageFile> |
| Работа с образами |  | <xref:Windows.Media.Capture.MediaCapture> <br> <xref:Windows.Graphics.Imaging.BitmapEncoder> <br> <xref:Windows.Graphics.Imaging.BitmapDecoder> |
| Программирование с использованием WCF | [Синхронные и асинхронные операции](../../../../framework/wcf/synchronous-and-asynchronous-operations.md) |  |

Асинхронность особенно полезна в приложениях, которые обращаются к потоку пользовательского интерфейса, поскольку все связанные с пользовательским интерфейсом действия обычно используют один поток. В синхронном приложении блокировка одного процесса приводит к блокировке всех процессов. Приложение перестает отвечать, и это выглядит как сбой, а не как ожидание.

При использовании асинхронных методов приложение продолжает реагировать на действия в пользовательском интерфейсе. Например, можно изменить размер окна или свернуть его, либо закрыть приложение, если не требуется ждать завершения работы.

Асинхронный подход добавляет эквивалент автоматической передачи в список параметров, выбранных при создании асинхронных операций. То есть разработчик может пользоваться всеми преимуществами традиционного асинхронного программирования, прикладывая гораздо меньше усилий.

## <a name="async-methods-are-easy-to-write"></a><a name="BKMK_HowtoWriteanAsyncMethod"></a> Методы async проще создавать

В C# основой асинхронного программирования. являются ключевые слова [async](../../../language-reference/keywords/async.md) и [await](../../../language-reference/operators/await.md). Они позволяют использовать ресурсы платформы .NET Framework, .NET Core или среды выполнения Windows для создания асинхронных методов, и это почти так же просто, как создавать синхронные методы. Асинхронные методы, которые определяются с помощью ключевого слова `async`, называются *методами async*.

Ниже приводится пример асинхронного метода. Почти все элементы кода должны быть вам знакомы.

Полный пример Windows Presentation Foundation (WPF), доступный для загрузки, см. в статье [Асинхронное программирование с использованием ключевых слов async и await в C#](/samples/dotnet/samples/async-and-await-cs).

:::code language="csharp" source="snippets/access-web/Program.cs" id="ControlFlow":::

Из предыдущего примера вы можете узнать несколько полезных методик. Начните с сигнатуры метода. Она включает модификатор `async`. Типом возвращаемого значения является `Task<int>` (дополнительные параметры см. в разделе "Типы возвращаемых значений"). Имя метода заканчивается на `Async`. В теле метода `GetStringAsync` возвращает `Task<string>`. Это означает, что когда вы ожидаете (`await`) задачу, то получаете `string` (`contents`). Прежде чем ожидать задачу, можно сделать работу, которая не зависит от `string` из `GetStringAsync`.

Обратите внимание на оператор `await`. Он приостанавливает `GetUrlContentLengthAsync`.

- `GetUrlContentLengthAsync` не может продолжить выполнение до завершения `getStringTask`.
- На это время управление возвращается вызывающему объекту метода `GetUrlContentLengthAsync`.
- Управление возобновляется после завершения `getStringTask`.
- Оператор `await` извлекает результат `string` из `getStringTask`.

Оператор return указывает целочисленный результат. Все методы, ожидающие `GetUrlContentLengthAsync`, получают значение длины.

Если метод `GetUrlContentLengthAsync` не выполняет никакие операции между вызовом метода `GetStringAsync` и его завершением, можно упростить код, описав вызов и ожидание с помощью следующего простого оператора.

```csharp
string contents = await client.GetStringAsync("https://docs.microsoft.com/dotnet");
```

Далее поясняется, почему код предыдущего примера является асинхронным методом:

- Сигнатура метода включает модификатор `async`.
- Имя асинхронного метода, как правило, оканчивается суффиксом Async.
- Возвращаемое значение имеет один из следующих типов:

  - <xref:System.Threading.Tasks.Task%601>, если метод включает оператор return с операндом типа `TResult`.
  - <xref:System.Threading.Tasks.Task>, если метод не имеет оператора Return или имеет оператор Return без операнда.
  - `void`, если вы создаете асинхронный обработчик событий.
  - Любой другой тип, имеющий метод `GetAwaiter` (начиная с C# 7.0).

  Дополнительные сведения см. в [описании типов возвращаемого значения и параметров](#BKMK_ReturnTypesandParameters).

- Метод обычно содержит по меньшей мере одно выражение `await`, отмечающее точку, в которой метод не может продолжить выполнение до завершения асинхронной операции. На это время метод приостанавливается и управление возвращается к вызывающему объекту метода. В следующем подразделе показано, что происходит в точке приостановки.

В асинхронных методах с помощью соответствующих ключевых слов и типов указывается, что требуется сделать, а компилятор выполняет остальные задачи, в том числе отслеживает обязательные действия, когда управление возвращается в точку await в приостановленном методе. Некоторые программные процессы, такие как циклы и обработка исключений, сложно добавлять в традиционный асинхронный код. В асинхронном методе эти элементы пишутся почти так же, как в синхронном решении, что очень удобно.

Дополнительные сведения об асинхронности в предыдущих версиях платформы .NET Framework см. в статье [Библиотека параллельных задач и традиционное асинхронное программирование .NET Framework](../../../../standard/parallel-programming/tpl-and-traditional-async-programming.md).

## <a name="what-happens-in-an-async-method"></a><a name="BKMK_WhatHappensUnderstandinganAsyncMethod"></a> Что происходит в методе Async

В асинхронном программировании важнее всего понимать, как поток управления перемещается из метода в метод. Следующая схема описывает этот процесс.

:::image type="content" source="media/task-asynchronous-programming-model/navigation-trace-async-program.png" alt-text="Навигация по трассировке асинхронного потока управления" lightbox="media/task-asynchronous-programming-model/navigation-trace-async-program.png":::

Числа на схеме соответствуют следующим шагам, которые запускаются, когда вызывающий метод вызывает асинхронный метод.

1. Вызывающий метод вызывает и ожидает асинхронный метод `GetUrlContentLengthAsync`.

1. `GetUrlContentLengthAsync` создает экземпляр <xref:System.Net.Http.HttpClient> и вызывает асинхронный метод <xref:System.Net.Http.HttpClient.GetStringAsync%2A>, чтобы загрузить содержимое веб-сайта в виде строки.

1. В `GetStringAsync` происходит событие, которое приостанавливает ход выполнения. Например, методу необходимо подождать завершения загрузки или произошло другое блокирующее действие. Чтобы избежать блокировки ресурсов, `GetStringAsync` передает управление вызывающему объекту `GetUrlContentLengthAsync`.

     `GetStringAsync` возвращает <xref:System.Threading.Tasks.Task%601>, где `TResult` — строка, а `GetUrlContentLengthAsync` присваивает задачу переменной `getStringTask`. Задача представляет собой непрерывный процесс для вызова `GetStringAsync` с обязательством создать фактическое значение строки, когда работа будет завершена.

1. Поскольку значение из процесса `getStringTask` еще не получено, метод `GetUrlContentLengthAsync` может перейти к другим операциям, не зависящим от конечного результата`GetStringAsync`. Эти операции представлены вызовом синхронного метода `DoIndependentWork`.

1. `DoIndependentWork` — это синхронный метод, который выполняет свой код и возвращает управление вызывающему объекту.

1. Метод `GetUrlContentLengthAsync` выполнил все операции, для которых не требуется результат процесса `getStringTask`. Далее метод `GetUrlContentLengthAsync` должен вычислить длину загруженной строки и возвратить ее, но не может этого сделать, пока нет строки.

    Поэтому `GetUrlContentLengthAsync` использует оператор await, чтобы приостановить свою работу и передать управление методу, вызвавшему `GetUrlContentLengthAsync`. `GetUrlContentLengthAsync` возвращает вызывающему объекту `Task<int>`. Задача представляет собой обещание создать целочисленный результат, являющийся длиной загруженной строки.

    > [!NOTE]
    > Если метод `GetStringAsync` (и, следовательно, процесс `getStringTask`) завершается прежде, чем этого дождется `GetUrlContentLengthAsync`, управление остается у метода `GetUrlContentLengthAsync`. На приостановку метода `GetUrlContentLengthAsync` и последующий возврат к нему были бы потрачены лишние ресурсы, если вызываемый асинхронный процесс `getStringTask` уже завершен и `GetUrlContentLengthAsync` не нужно ждать окончательного результата.

    В вызывающем методе сохраняется шаблон обработки. Вызывающий объект может выполнять другие операции, не зависящие от результата `GetUrlContentLengthAsync`, во время ожидания этого результата, или сразу ожидать результата. Вызывающий метод ожидает `GetUrlContentLengthAsync`, а `GetUrlContentLengthAsync` ожидает `GetStringAsync`.

1. `GetStringAsync` завершается и создает строковый результат. Вызов возвращает строковый результат в метод `GetStringAsync`, но не так, как, возможно, ожидалось. (Помните, что метод уже возвратил задачу в шаге 3.) Вместо этого строковый результат хранится в задаче `getStringTask`, которая представляет собой завершение метода. Оператор await извлекает результат из `getStringTask`. Оператор присваивания назначает извлеченный результат `contents`.

1. Если `GetUrlContentLengthAsync` содержит строковый результат, метод может вычислить длину строки. Затем работа `GetUrlContentLengthAsync` также завершена, и ожидающий обработчик событий может возобновить работу. В полном примере в конце этого раздела видно, что обработчик событий извлекает значение длины и выводит результат.
Если вы недавно занимаетесь асинхронным программированием, рекомендуем обратить внимание на различия между синхронным и асинхронным поведением. Синхронный метод возвращает управление, когда его работа завершается (шаг 5), тогда как асинхронный метод возвращает значение задачи, когда его работа приостанавливается (шаги 3 и 6). Когда асинхронный метод в конечном счете завершает работу, задача помечается как завершенная и результат, при его наличии, сохраняется в задаче.

## <a name="api-async-methods"></a><a name="BKMK_APIAsyncMethods"></a> Async-методы API-интерфейсов

Где же найти методы для асинхронного программирования (такие как `GetStringAsync`)? Платформа .NET Framework 4.5 и более поздние версии, а также .NET Core содержат большое количество элементов, совместимых с `async` и `await`. Они содержат суффикс Async в имени элемента и возвращают тип <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>. Например, класс `System.IO.Stream` имеет такие методы, как <xref:System.IO.Stream.CopyToAsync%2A>, <xref:System.IO.Stream.ReadAsync%2A> и <xref:System.IO.Stream.WriteAsync%2A>, наряду с синхронными методами <xref:System.IO.Stream.CopyTo%2A>, <xref:System.IO.Stream.Read%2A> и <xref:System.IO.Stream.Write%2A>.

Среда выполнения Windows также содержит множество методов, которые можно использовать в сочетании с `async` и `await` в приложениях Windows. См. дополнительные сведения о [потоковом и асинхронном программировании](/windows/uwp/threading-async/) для разработки UWP, [асинхронном программировании (приложения Магазина Windows)](/previous-versions/windows/apps/hh464924(v=win.10)), а также [вызове асинхронных API в C# или Visual Basic](/previous-versions/windows/apps/hh452713(v=win.10)), если вы используете предыдущие версии среды выполнения Windows.

## <a name="threads"></a><a name="BKMK_Threads"></a> Потоки

Асинхронные методы используются для неблокирующих операций. Выражение `await` в асинхронном методе не блокирует текущий поток на время выполнения ожидаемой задачи. Вместо этого выражение регистрирует остальную часть метода как продолжение и возвращает управление вызывающему объекту асинхронного метода.

Ключевые слова `async` и `await` не вызывают создания дополнительных потоков. Асинхронные методы не требуют многопоточности, поскольку асинхронный метод не выполняется в собственном потоке. Метод выполняется в текущем контексте синхронизации и использует время в потоке, только когда метод активен. Метод <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> можно применять для перемещения операций, использующих ресурсы ЦП, в фоновый поток, однако фоновый поток не имеет смысла применять для процесса, который просто ждет результата.

Асинхронный подход к асинхронному программированию практически по всем параметрам имеет преимущество перед другими подходами. В частности, такой подход эффективнее, чем использование класса <xref:System.ComponentModel.BackgroundWorker> для привязанных к вводу-выводу операций, так как используется более простой код и вам не нужно специально предотвращать состояние гонки. В сочетании с методом <xref:System.Threading.Tasks.Task.Run%2A?displayProperty=nameWithType> асинхронное программирование лучше <xref:System.ComponentModel.BackgroundWorker> для операций, использующих ресурсы процессора, так как оно отделяет координацию выполнения кода от действий, которые `Task.Run` перемещает в пул потоков.

## <a name="async-and-await"></a><a name="BKMK_AsyncandAwait"></a> Async и Await

Если с помощью модификатора [async](../../../language-reference/keywords/async.md) указать, что метод является асинхронным, у вас появятся следующие две возможности.

- Асинхронный метод сможет использовать [await](../../../language-reference/operators/await.md) для обозначения точек приостановки. Оператор `await` сообщает компилятору, что асинхронный метод не может выполняться после этой точки до завершения ожидаемого асинхронного процесса. На это время управление возвращается вызывающему объекту асинхронного метода.

     Приостановка асинхронного метода на выражении `await` не считается выходом из метода, и блоки `finally` не выполняются.

- Сам обозначенный асинхронный метод может ожидаться вызывающими его методами.

Асинхронный метод обычно содержит одно или несколько вхождений оператора `await`, но отсутствие выражений `await` не вызывает ошибок компилятора. Если асинхронный метод не использует оператор `await` для обозначения точки приостановки, метод выполняется как синхронный независимо от наличия модификатора `async`. При компиляции таких методов выдается предупреждение.

`async` и `await` являются контекстными ключевыми словами. Дополнительные сведения и примеры см. в следующих разделах:

- [async](../../../language-reference/keywords/async.md)
- [await](../../../language-reference/operators/await.md)

## <a name="return-types-and-parameters"></a><a name="BKMK_ReturnTypesandParameters"></a> Типы и параметры возвращаемого значения

В результате работы асинхронного метода обычно возвращается <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>. Внутри асинхронного метода оператор `await` применяется к задаче, возвращаемой из вызова другого асинхронного метода.

В качестве возвращаемого типа указывается <xref:System.Threading.Tasks.Task%601>, если метод содержит оператор [`return`](../../../language-reference/keywords/return.md), который задает операнд типа `TResult`.

Используйте <xref:System.Threading.Tasks.Task> в качестве возвращаемого типа, если метод не содержит операторов return или содержит оператор return, который не возвращает операнд.

В C# начиная с версии 7.0 также можно указывать любые другие типы операторов return, при условии, что тип содержит метод `GetAwaiter`. Пример такого типа — <xref:System.Threading.Tasks.ValueTask%601>. Он доступен в NuGet-пакете [System.Threading.Tasks.Extension](https://www.nuget.org/packages/System.Threading.Tasks.Extensions/).

В следующем примере показано объявление и вызов метода, который возвращает <xref:System.Threading.Tasks.Task%601> или <xref:System.Threading.Tasks.Task>:

```csharp
async Task<int> GetTaskOfTResultAsync()
{
    int hours = 0;
    await Task.Delay(0);

    return hours;
}


Task<int> returnedTaskTResult = GetTaskOfTResultAsync();
int intResult = await returnedTaskTResult;
// Single line
// int intResult = await GetTaskOfTResultAsync();

async Task GetTaskAsync()
{
    await Task.Delay(0);
    // No return statement needed
}

Task returnedTask = GetTaskAsync();
await returnedTask;
// Single line
await GetTaskAsync();
```

Каждая возвращенная задача представляет выполняющуюся работу. Задача инкапсулирует информацию о состоянии асинхронного процесса и, в итоге, либо конечный результат процесса, либо исключение, созданное процессом в случае его сбоя.

Асинхронный метод может иметь тип возвращаемого значения `void`. Возвращаемый тип в основном используется для определения обработчиков событий, где требуется возвращать тип `void`. Асинхронные обработчики событий часто служат в качестве отправной точки для асинхронных программ.

Асинхронный метод, который имеет тип возвращаемого значения `void`, невозможно ожидать методом await. Вызывающий объект не может перехватывать исключения, которые выдает такой метод.

Асинхронный метод не может объявлять параметры [in](../../../language-reference/keywords/in-parameter-modifier.md), [ref](../../../language-reference/keywords/ref.md) или [out](../../../language-reference/keywords/out-parameter-modifier.md), но может вызывать методы с этими параметрами. Аналогичным образом, асинхронный метод не может возвращать значение по ссылке, несмотря на то, что он может вызывать методы с возвращаемыми значениями ref.

Дополнительные сведения и примеры см. в статье [Типы возвращаемых значений асинхронных операций (C#)](async-return-types.md). Дополнительные сведения о перехвате исключений в асинхронных методах см. в описании механизма [try-catch](../../../language-reference/keywords/try-catch.md).

При программировании в среде выполнения Windows асинхронные API-интерфейсы имеют один из следующих возвращаемых типов, которые похожи на задачи.

- <xref:Windows.Foundation.IAsyncOperation%601>, что соответствует <xref:System.Threading.Tasks.Task%601>
- <xref:Windows.Foundation.IAsyncAction>, что соответствует <xref:System.Threading.Tasks.Task>
- <xref:Windows.Foundation.IAsyncActionWithProgress%601>
- <xref:Windows.Foundation.IAsyncOperationWithProgress%602>

## <a name="naming-convention"></a><a name="BKMK_NamingConvention"></a> Соглашение об именовании

По соглашению имена методов, возвращающих обычно поддерживающие ожидание типы (например, `Task`, `Task<T>`, `ValueTask` и `ValueTask<T>`), должны заканчиваться на Async. Имена методов, которые запускают асинхронную операцию, но не возвращают поддерживающий ожидание тип, не должны заканчиваться на Async, но могут начинаться с Begin, Start или другой команды, предполагающей, что метод не возвращает и не выдает результат операции.

Соглашение можно игнорировать в тех случаях, когда событие, базовый класс или контракт интерфейса предлагает другое имя. Например, не следует переименовывать общие обработчики событий, такие как `OnButtonClick`.

## <a name="related-topics-and-samples-visual-studio"></a><a name="BKMK_RelatedTopics"></a> Связанные разделы и примеры (Visual Studio)

| Заголовок | Описание | Пример |
|--|--|--|
| [Практическое руководство. Параллельное выполнение нескольких веб-запросов с использованием Async и Await (C#)](./index.md) | Иллюстрирует, как запустить несколько задач одновременно. | [Пример использования Async. Параллельное выполнение нескольких веб-запросов](https://code.msdn.microsoft.com/Async-Make-Multiple-Web-49adb82e) |
| [Типы возвращаемых значений асинхронных операций (C#)](async-return-types.md) | Иллюстрирует типы, которые могут возвращать асинхронные методы, и поясняет, когда следует использовать каждый из этих типов. |  |
| Отмените задачи с маркером отмены в качестве механизма сигнализации. | Иллюстрирует добавление следующих функциональных возможностей в асинхронное решение:<br><br> - [Отмена списка задач (C#)](cancel-an-async-task-or-a-list-of-tasks.md)<br>- [Отмена задач после определенного периода времени (C#)](cancel-async-tasks-after-a-period-of-time.md)<br>- [Обработка асинхронных задач по мере завершения (C#)](start-multiple-async-tasks-and-process-them-as-they-complete.md) |  |
| [Использование метода async для доступа к файлам (C#)](using-async-for-file-access.md) | Иллюстрирует преимущества использования асинхронности и ожидания для доступа к файлам. |  |
| [Асинхронный шаблон, основанный на задачах (TAP)](../../../../standard/asynchronous-programming-patterns/task-based-asynchronous-pattern-tap.md) | Описывает асинхронную модель, шаблон основан на типах <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601>. |  |
| [Видеоролики об async на канале Channel 9](https://channel9.msdn.com/search?term=async%20&type=All#pubDate=year&ch9Search&lang-en=en) | Предоставляет ссылки на различные видеоролики об асинхронном программировании. |  |

## <a name="see-also"></a>См. также

- [async](../../../language-reference/keywords/async.md)
- [await](../../../language-reference/operators/await.md)
- [Асинхронное программирование](../../../async.md)
- [Общие сведения об асинхронной модели](../../../../standard/async.md)
