---
title: Асинхронные типы возвращаемых значений (C#)
ms.date: 04/14/2020
ms.assetid: ddb2539c-c898-48c1-ad92-245e4a996df8
ms.openlocfilehash: 73a6e1924652c8635377547e2faddc864ac5540a
ms.sourcegitcommit: c91110ef6ee3fedb591f3d628dc17739c4a7071e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/15/2020
ms.locfileid: "81389137"
---
# <a name="async-return-types-c"></a>Асинхронные типы возвращаемых значений (C#)

Асинхронные методы могут иметь следующие типы возвращаемых значений:

- <xref:System.Threading.Tasks.Task%601> для асинхронного метода, возвращающего значение.
- <xref:System.Threading.Tasks.Task> для асинхронного метода, который выполняет операцию, но не возвращает значение.
- `void` для обработчика событий.
- Начиная с версии 7.0 в языке C# поддерживаются любые типы с доступным методом `GetAwaiter`. Объект, возвращаемый методом `GetAwaiter`, должен реализовывать интерфейс <xref:System.Runtime.CompilerServices.ICriticalNotifyCompletion?displayProperty=nameWithType>.
- Начиная с версии 8.0, в языке C# поддерживается интерфейс <xref:System.Collections.Generic.IAsyncEnumerable%601> для асинхронного метода, который возвращает *асинхронный поток*.

Дополнительные сведения об асинхронных методах см. в разделе [Асинхронное программирование с использованием ключевых слов Async и Await (C#)](./index.md).  
  
## <a name="tasktresult-return-type"></a>Тип возвращаемого значения Task\<TResult\>  
Тип возвращаемого значения <xref:System.Threading.Tasks.Task%601> используется для асинхронного метода, содержащего инструкцию [return](../../../language-reference/keywords/return.md) (C#) с операндом типа `TResult`.  
  
В следующем примере асинхронный метод `GetLeisureHours` содержит инструкцию `return`, которая возвращает целое число. Поэтому в объявлении метода должен указываться тип возвращаемого значения `Task<int>`.  Асинхронный метод <xref:System.Threading.Tasks.Task.FromResult%2A> представляет собой заполнитель для операции, которая возвращает строку.
  
:::code language="csharp" source="./snippets/async-returns1.cs" id="SnippetFirstExample":::

При вызове `GetLeisureHours` из выражения await в методе `ShowTodaysInfo` это выражение await извлекает целочисленное значение (значение `leisureHours`), хранящееся в задаче, которая возвращается методом `GetLeisureHours`. Дополнительные сведения о выражениях await см. в разделе [await](../../../language-reference/operators/await.md).  
  
Чтобы лучше понять, как `await` получает результат из `Task<T>`, отделите вызов метода `GetLeisureHours` от применения `await`, как показано в следующем коде. Вызов метода `GetLeisureHours`, который не ожидается немедленно, возвращает `Task<int>`, как и следовало ожидать из объявления метода. В данном примере эта задача назначается переменной `integerTask`. Поскольку `integerTask` является <xref:System.Threading.Tasks.Task%601>, она содержит свойство <xref:System.Threading.Tasks.Task%601.Result> типа `TResult`. В этом примере `TResult` представляет собой целочисленный тип. Если выражение `await` применяется к `integerTask`, выражение await вычисляется как содержимое свойства <xref:System.Threading.Tasks.Task%601.Result%2A> объекта `integerTask`. Это значение присваивается переменной `ret`.  
  
> [!IMPORTANT]
> Свойство <xref:System.Threading.Tasks.Task%601.Result%2A> является блокирующим свойством. При попытке доступа к нему до завершения его задачи поток, который в текущий момент активен, блокируется до того момента, пока задача не будет завершена, а ее значение не станет доступным. В большинстве случаев следует получать доступ к этому значению с помощью `await` вместо прямого обращения к свойству. <br/> В предыдущем примере извлекалось значение свойства <xref:System.Threading.Tasks.Task%601.Result%2A> для блокировки основного потока. Это позволяет закончить выполнение метода `ShowTodaysInfo` до того, как завершится работа приложения.  

:::code language="csharp" source="./snippets/async-returns1a.cs" id="SnippetSecondVersion":::

## <a name="task-return-type"></a>Тип возвращаемого значения Task  
Асинхронные методы, не содержащие инструкцию `return` или содержащие инструкцию `return`, которая не возвращает операнд, обычно имеют тип возвращаемого значения <xref:System.Threading.Tasks.Task>. При синхронном выполнении такие методы возвращают `void`. Если для асинхронного метода вы используете тип возвращаемого значения <xref:System.Threading.Tasks.Task>, вызывающий метод может использовать оператор `await` для приостановки выполнения вызывающего объекта до завершения вызванного асинхронного метода.  
  
В следующем примере асинхронный метод `WaitAndApologize` не содержит инструкцию `return`, в связи с чем он возвращает объект <xref:System.Threading.Tasks.Task>. Возврат `Task` позволяет реализовать ожидание `WaitAndApologize`. Тип <xref:System.Threading.Tasks.Task> не имеет возвращаемого значения и, соответственно, не содержит свойство `Result`.  

:::code language="csharp" source="./snippets/async-returns2.cs" id="SnippetTaskReturn":::

`WaitAndApologize` вызывается и ожидается с помощью инструкции await (вместо выражения await), похожей на инструкцию вызова для синхронного метода, возвращающего значение void. Применение оператора await в этом случае не возвращает значение.  
  
Как и в предыдущем примере <xref:System.Threading.Tasks.Task%601>, вы можете отделить вызов `WaitAndApologize` от применения инструкции await, как показывает следующий код. Однако следует помнить, что `Task` не содержит свойство `Result`, и при применении оператора await к `Task` никакое значение не создается.  
  
В следующем коде вызов метода `WaitAndApologize` отделяется от ожидания задачи, которую возвращает этот метод.  

:::code language="csharp" source="./snippets/async-returns2a.cs" id="SnippetAwaitTask":::

## <a name="void-return-type"></a>Тип возвращаемого значения Void

Тип возвращаемого значения `void` используется в асинхронных обработчиках событий, для которых требуется тип возвращаемого значения `void`. Поскольку методы, не являющиеся обработчиками событий, не возвращают значения, вместо этого необходимо вернуть <xref:System.Threading.Tasks.Task>. Это вызвано тем, что для асинхронных методов, возвращающих значение `void`, ожидание невозможно. Любой вызывающий объект такого метода должен иметь возможность завершить свою работу, не дожидаясь завершения вызванного асинхронного метода. Вызывающий объект не должен зависеть ни от каких значений и исключений, создаваемых асинхронным методом.  
  
Вызывающий объект асинхронного метода, возвращающего void, не может перехватывать исключения, создаваемые методом, и такие необработанные исключения могут привести к сбою приложения. Если метод, возвращающий <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601>, создает исключение, оно хранится в возвращенной задаче. Исключение повторно вызывается при ожидании задачи. Поэтому убедитесь, что любой асинхронный метод, который может вызвать исключение, имеет тип возвращаемого значения <xref:System.Threading.Tasks.Task> или <xref:System.Threading.Tasks.Task%601> и что вызовы метода являются ожидаемыми.  
  
Дополнительные сведения о перехвате исключений в асинхронных методах см. в разделе [Исключения в асинхронных методах](../../../language-reference/keywords/try-catch.md#exceptions-in-async-methods) в статье о [try-catch](../../../language-reference/keywords/try-catch.md).  
  
В следующем примере показано поведение асинхронного обработчика событий. В примере кода асинхронный обработчик событий должен сообщить основному потоку о завершении своей работы. Основной поток может ожидать завершения работы асинхронного обработчика событий перед выходом из программы.

:::code language="csharp" source="./snippets/async-returns3.cs":::

## <a name="generalized-async-return-types-and-valuetasktresult"></a>Обобщенные асинхронные типы возвращаемых значений и ValueTask\<TResult\>

Начиная с C# 7.0 асинхронные методы могут возвращать любой тип, имеющий доступный метод `GetAwaiter`.

Поскольку <xref:System.Threading.Tasks.Task> и <xref:System.Threading.Tasks.Task%601> являются ссылочными типами, выделение памяти во влияющих на производительность сегментах (особенно при выделении памяти в ограниченных циклах) может серьезно снизить производительность. Поддержка обобщенных типов возвращаемых значений позволяет возвращать небольшой тип значения вместо ссылочного типа, благодаря чему удается предотвратить избыточное выделение памяти.

На платформе .NET представлена структура <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, которая является упрощенной реализацией обобщенного значения, возвращающего задачу. Чтобы использовать тип <xref:System.Threading.Tasks.ValueTask%601?displayProperty=nameWithType>, необходимо добавить в проект пакет NuGet `System.Threading.Tasks.Extensions`. В следующем примере структура <xref:System.Threading.Tasks.ValueTask%601> используется для извлечения значений двух игральных костей.
  
:::code language="csharp" source="./snippets/async-valuetask.cs":::

## <a name="async-streams-with-iasyncenumerablet"></a>Асинхронные потоки с IAsyncEnumerable\<T\>

Начиная с C# 8.0, асинхронный метод может возвращать *асинхронный поток*, представленный интерфейсом <xref:System.Collections.Generic.IAsyncEnumerable%601>. Асинхронный поток позволяет перечислять элементы, считываемые из потока, при создании блоков элементов с помощью повторяющихся асинхронных вызовов. В следующем примере показан асинхронный метод, создающий асинхронный поток.

:::code language="csharp" source="./snippets/AsyncStreams.cs" id="SnippetGenerateAsyncStream":::

В предыдущем примере показано асинхронное считывание строк. После считывания каждой строки код перечисляет каждое слово в строке. Вызывающие объекты будут перечислять каждое слово с помощью оператора `await foreach`. Метод ожидает, когда необходимо асинхронно считать следующую строку из исходной строки.

## <a name="see-also"></a>См. также

- <xref:System.Threading.Tasks.Task.FromResult%2A>
- [Пошаговое руководство: Доступ к Интернету с помощью модификатора Async и оператора Await в C#](./walkthrough-accessing-the-web-by-using-async-and-await.md)
- [Control Flow in Async Programs (C#)](./control-flow-in-async-programs.md) (Поток управления в асинхронных программах C#)
- [async](../../../language-reference/keywords/async.md)
- [await](../../../language-reference/operators/await.md)
