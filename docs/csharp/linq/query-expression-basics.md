---
title: Основы выражения запроса (LINQ в C#)
description: Общие сведения о понятиях, относящихся к выражениям запроса
ms.date: 11/30/2016
ms.assetid: 027db1f8-346f-44d2-a16e-043fcea3a4e0
ms.openlocfilehash: 83beaa82d4b4b42ff9da5230edddd391b33a0717
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "79173358"
---
# <a name="query-expression-basics"></a>Основы выражения запроса

В этой статье представлены основные понятия, связанные с выражениями запроса на языке C#.

## <a name="what-is-a-query-and-what-does-it-do"></a>Что такое запрос и для чего он нужен

*Запрос* — это набор инструкций, которые описывают, какие данные необходимо извлечь из указанного источника (или источников) данных, а также описывают форму и организацию извлекаемых данных. Запрос отличается от полученного с его помощью результата.

Обычно исходные данные логически организованы как последовательность элементов одного вида. Например, таблица базы данных SQL содержит последовательность строк. В файле XML содержится "последовательность" элементов XML (они организованы иерархически в древовидную структуру). Коллекция в памяти содержит последовательность объектов.

С точки зрения приложения определенные тип и структура оригинальных исходных данных не важны. Приложение всегда видит исходные данные в виде коллекции <xref:System.Collections.Generic.IEnumerable%601> или <xref:System.Linq.IQueryable%601>. Например, в LINQ to XML исходные данные становятся видимыми как `IEnumerable`\<<xref:System.Xml.Linq.XElement>>.

При такой исходной последовательности, запрос может выполнять одно из трех возможных действий.

- Извлечение подмножества элементов для получения новой последовательности без изменения отдельных элементов. Затем запрос может отсортировать или сгруппировать возвращаемую последовательность различными способами, как показано в следующем примере (предположим, что `scores` является `int[]`):

    [!code-csharp[csrefQueryExpBasics#45](~/samples/snippets/csharp/concepts/linq/query-expression-basics_1.cs)]

- Извлечение последовательности элементов, как и в предыдущем примере, но с преобразованием элементов в новый тип объекта. Например, запрос может извлекать только фамилии из определенных записей клиентов в источнике данных. Запрос также может извлекать полную запись и использовать ее для создания другого типа объекта в памяти или даже данных XML перед созданием заключительной последовательности результатов. В следующем примере показана трансформация `int` в `string`. Обратите внимание на новый тип `highScoresQuery`.

    [!code-csharp[csrefQueryExpBasics#46](~/samples/snippets/csharp/concepts/linq/query-expression-basics_2.cs)]

- Извлечение одноэлементного значения исходных данных, таких как:

  - Количество элементов, соответствующих определенному условию.

  - Элемент с наибольшим или наименьшим значением.

  - Первый элемент, соответствующий условию, или сумма определенных значений в указанном наборе элементов. Например, следующий запрос возвращает количество оценок выше 80 из целочисленного массива `scores`:

    [!code-csharp[csrefQueryExpBasics#47](~/samples/snippets/csharp/concepts/linq/query-expression-basics_3.cs)]

    В предыдущем примере обратите внимание на использование скобок вокруг выражения запроса перед вызовом метода `Count`. Его также можно выразить, используя новую переменную для сохранения конкретного результата. Этот метод является более удобочитаемым, так как переменная, в которой хранится запрос, хранится отдельно от запроса, в котором хранится результат.

    [!code-csharp[csrefQueryExpBasics#48](~/samples/snippets/csharp/concepts/linq/query-expression-basics_4.cs)]

В предыдущем примере запрос выполняется в вызове `Count`, так как `Count` должен выполнить итерацию результатов, чтобы определить количество элементов, возвращенных методом `highScoresQuery`.

## <a name="what-is-a-query-expression"></a>Что такое выражение запроса

*Выражение запроса* — запрос, выраженный с помощью синтаксиса запроса. Выражение запроса является конструкцией языка первого класса. Оно похоже на любое другое выражение и может использоваться в любом контексте, в котором выражение C# является допустимым. Выражение запроса состоит из набора предложений, написанных в декларативном синтаксисе, аналогичном SQL или XQuery. Каждое предложение, в свою очередь, содержит одно или несколько выражений C#, которые могут являться выражениями запроса или содержать выражение запроса.

Выражение запроса должно начинаться предложением [from](../language-reference/keywords/from-clause.md) и заканчиваться предложением [select](../language-reference/keywords/select-clause.md) или [group](../language-reference/keywords/group-clause.md). Между первым предложением `from` и последним предложением `select` или `group` может содержаться одно или несколько необязательных предложений: [where](../language-reference/keywords/where-clause.md), [orderby](../language-reference/keywords/orderby-clause.md), [join](../language-reference/keywords/join-clause.md), [let](../language-reference/keywords/let-clause.md) и даже дополнительных предложений [from](../language-reference/keywords/from-clause.md). Можно также использовать ключевое слово [into](../language-reference/keywords/into.md), чтобы результат предложения `join` или `group` мог служить источником дополнительных предложений запроса в том же выражении запроса.

### <a name="query-variable"></a>Переменная запроса

В LINQ переменная запроса — это любая переменная, сохраняющая *запрос* вместо *результатов* запроса. Говоря точнее, переменная запроса всегда является перечислимым типом и производит последовательность элементов, когда она используется в итерации оператора `foreach` или прямом вызове ее метода `IEnumerator.MoveNext`.

В следующем примере кода показано простое выражение запроса с одним источником данных, одним предложением фильтрации, одним предложением упорядочения и без трансформации исходных элементов. Предложение `select` завершает запрос.

[!code-csharp[csrefQueryExpBasics#49](~/samples/snippets/csharp/concepts/linq/query-expression-basics_5.cs)]

В предыдущем примере `scoreQuery` — *переменная запроса*, которую иногда называют просто *запросом*. В переменной запроса не хранятся фактические данные результата, которые получаются с помощью цикла `foreach`. Когда выполняется оператор `foreach`, результаты запроса не возвращаются с помощью переменной запроса `scoreQuery`. В этом случае они возвращаются с помощью переменной итерации `testScore`. Итерация переменной `scoreQuery` может выполняться во втором цикле `foreach`. Результаты будет теми же, если ни они, ни источник данных не изменяются.

В переменной запроса может храниться запрос, выраженный с помощью синтаксиса запроса или метода запроса, или их комбинации. В следующих примерах `queryMajorCities` и `queryMajorCities2` являются переменными запроса.

[!code-csharp[csrefQueryExpBasics#50](~/samples/snippets/csharp/concepts/linq/query-expression-basics_6.cs)]

С другой стороны, в следующих примерах показаны переменные, которые не являются переменными запроса даже несмотря на то, что все они инициализируются запросом. Они не являются переменными запроса, так как в них хранятся результаты.

[!code-csharp[csrefQueryExpBasics#51](~/samples/snippets/csharp/concepts/linq/query-expression-basics_7.cs)]

Дополнительные сведения о различных способах выражения запросов см. в разделе [Синтаксис запросов и синтаксис методов в LINQ](../programming-guide/concepts/linq/query-syntax-and-method-syntax-in-linq.md).

#### <a name="explicit-and-implicit-typing-of-query-variables"></a>Явная и неявная типизация переменных запроса

В этой документации обычно явно указывается тип переменной запроса для того, чтобы продемонстрировать типичное отношение между переменной запроса и [предложением select](../language-reference/keywords/select-clause.md). Однако можно также использовать ключевое слов [var](../language-reference/keywords/var.md), чтобы указать компилятору вывести тип переменной запроса (или любой другой локальной переменной) во время компиляции. Например, ранее приведенный в данном разделе пример запроса также может быть выражен путем неявной типизации:

[!code-csharp[csrefQueryExpBasics#52](~/samples/snippets/csharp/concepts/linq/query-expression-basics_8.cs)]

Дополнительные сведения см. в разделах [Неявно типизированные локальные переменные](../programming-guide/classes-and-structs/implicitly-typed-local-variables.md) и [Связи типов в операциях запроса LINQ](../programming-guide/concepts/linq/type-relationships-in-linq-query-operations.md).

### <a name="starting-a-query-expression"></a>Начало выражения запроса

Выражение запроса должно начинаться с предложения `from`. Оно задает источник данных вместе с переменной диапазона. Переменная диапазона предоставляет каждый последующий элемент в исходной последовательности во время ее обзора. Переменная диапазона строго типизируется на основе типа элементов в источнике данных. В следующем примере переменная диапазона типизируется как `countries`, так как `Country` является массивом объектов `Country`. Так как переменная диапазона строго типизируется, для доступа к любым доступным элементам типа можно использовать оператор-точку.

[!code-csharp[csrefQueryExpBasics#53](~/samples/snippets/csharp/concepts/linq/query-expression-basics_9.cs)]

Переменная диапазона находится в области до тех пор, пока запрос не завершится с помощью точки с запятой или предложения *continuation*.

Выражение запроса может содержать несколько предложений `from`. Используйте дополнительные предложения `from`, если каждый элемент в исходной последовательности является коллекцией или содержит коллекцию. Например, предположим, что имеется коллекция объектов `Country`, каждый из которых содержит коллекцию объектов `City` с именем `Cities`. Для выполнения запросов к объектам `City` в каждой коллекции `Country` используйте два предложения `from`, как показано ниже.

[!code-csharp[csrefQueryExpBasics#54](~/samples/snippets/csharp/concepts/linq/query-expression-basics_10.cs)]

Дополнительные сведения см. в разделе [Предложение from](../language-reference/keywords/from-clause.md).

### <a name="ending-a-query-expression"></a>Окончание выражения запроса

Выражение запроса должно завершаться предложением `group` или `select`.

#### <a name="group-clause"></a>Предложение group

Используйте предложение `group` для получения последовательности групп, упорядоченных по указанному ключу. Ключом могут быть данные любого типа. Например, следующий запрос создает последовательность групп, содержащую один или несколько объектов `Country`, ключ для которых имеет значение `char`.

[!code-csharp[csrefQueryExpBasics#55](~/samples/snippets/csharp/concepts/linq/query-expression-basics_11.cs)]

Дополнительные сведения о группировании см. в разделе [Предложение group](../language-reference/keywords/group-clause.md).

#### <a name="select-clause"></a>Предложение select

Используйте предложение `select` для получения всех других типов последовательностей. Простое предложение `select` просто создает последовательность с тем же типом объектов, что и у объектов, которые содержатся в источнике данных. В этом примере источник данных содержит объекты типа `Country`. Предложение `orderby` просто сортирует элементы в новом порядке, а предложение `select` создает последовательность переупорядоченных объектов `Country`.

[!code-csharp[csrefQueryExpBasics#56](~/samples/snippets/csharp/concepts/linq/query-expression-basics_12.cs)]

Предложение `select` может использоваться для преобразования исходных данных в последовательности новых типов. Такое преобразование также называется *проекцией*. В следующем примере предложение `select` создает *проекцию* последовательности анонимных типов, которая содержит только подмножество полей оригинального элемента. Обратите внимание, что новые объекты инициализируются с помощью инициализатора объекта.

[!code-csharp[csrefQueryExpBasics#57](~/samples/snippets/csharp/concepts/linq/query-expression-basics_13.cs)]

Дополнительные сведения обо всех методах использования предложения `select` для преобразования исходных данных см. в разделе [Предложение select](../language-reference/keywords/select-clause.md).

#### <a name="continuations-with-into"></a>Продолжения с использованием ключевого слова "into"

Ключевое слово `into` можно использовать в предложении `select` или `group` для создания временного идентификатора, в котором хранится запрос. Это действие рекомендуется выполнять, если требуется выполнить в запросе дополнительные операции запроса после операции группирования или выбора. В следующем примере объекты `countries` группируются в соответствии с численностью населения в диапазоны по 10 миллионов. После создания этих групп дополнительные предложения отфильтровывают некоторые группы, а затем сортируют группы в порядке возрастания. Чтобы выполнить эти дополнительные операции, требуется продолжение, предоставляемое с помощью `countryGroup`.

[!code-csharp[csrefQueryExpBasics#58](~/samples/snippets/csharp/concepts/linq/query-expression-basics_14.cs)]

Дополнительные сведения см. в разделе [into](../language-reference/keywords/into.md).

### <a name="filtering-ordering-and-joining"></a>Фильтрация, упорядочение и присоединение

Между открывающим предложением `from` и завершающим предложением `select` или `group` могут размещаться все остальные необязательные предложения (`where`, `join`, `orderby`, `from`, `let`). Любое необязательное предложение может использоваться в теле запроса несколько раз или отсутствовать вообще.

#### <a name="where-clause"></a>Предложение where

Используйте предложение `where` для фильтрации элементов из источника данных по одному или нескольким выражениям предиката. Предложение `where` в следующем примере имеет один предикат с двумя условиями.

[!code-csharp[csrefQueryExpBasics#59](~/samples/snippets/csharp/concepts/linq/query-expression-basics_15.cs)]

Дополнительные сведения см. в разделе [Предложение where](../language-reference/keywords/where-clause.md).

#### <a name="orderby-clause"></a>Предложение orderby

Используйте `orderby` предложение для сортировки результатов по возрастанию или убыванию. Также можно задать порядок дополнительной сортировки. В следующем примере выполняется основная сортировка объектов `country` по свойству `Area`. Затем выполняется дополнительная сортировка по свойству `Population`.

[!code-csharp[csrefQueryExpBasics#60](~/samples/snippets/csharp/concepts/linq/query-expression-basics_16.cs)]

Ключевое слово `ascending` является необязательным, так как сортировка по умолчанию происходит по возрастанию, если не задан порядок сортировки. Дополнительные сведения см. в разделе [Предложение orderby](../language-reference/keywords/orderby-clause.md).

#### <a name="join-clause"></a>Предложение join

Используйте предложение `join` для связи или объединения элементов из одного источника данных с элементами из другого источника данных на основе сравнения на равенство определенных ключей в каждом элементе. В LINQ операции объединения выполняются в последовательностях объектов, элементы которых относятся к разным типам. После объединения двух последовательностей необходимо использовать оператор `select` или `group`, чтобы указать элемент для сохранения в выходной последовательности. Также можно использовать анонимный тип, чтобы объединить свойства каждого набора связанных элементов в новый тип для выходной последовательности. В следующем примере связываются объекты `prod`, свойство `Category` которых соответствует одной из категорий в массиве строк `categories`. Продукты, свойство `Category` которых не соответствует ни одной строке в `categories`, отфильтровываются. Оператор `select` формирует новый тип, свойства которого берутся как из `cat`, так и из `prod`.

[!code-csharp[csrefQueryExpBasics#61](~/samples/snippets/csharp/concepts/linq/query-expression-basics_17.cs)]

Также можно выполнить групповое соединение путем сохранения результатов операции `join` во временную переменную, используя ключевое слово [into](../language-reference/keywords/into.md). Дополнительные сведения см. в разделе [Предложение join](../language-reference/keywords/join-clause.md).

#### <a name="let-clause"></a>Предложение let

Используйте предложение `let` для сохранения результата выражения, например вызов метода, в новую переменную диапазона. В следующем примере в переменную диапазона `firstName` сохраняется первый элемент массива строк, возвращенного с помощью `Split`.

[!code-csharp[csrefQueryExpBasics#62](~/samples/snippets/csharp/concepts/linq/query-expression-basics_18.cs)]

Дополнительные сведения см. в разделе [Предложение let](../language-reference/keywords/let-clause.md).

### <a name="subqueries-in-a-query-expression"></a>Вложенные запросы в выражении запроса

Предложение запроса может само содержать выражение запроса, которое иногда называют *вложенным запросом*. Каждый вложенный запрос начинается с собственным предложением `from`, которое может указывать на источник данных, отличный от источника данных первого предложения `from`. Например, в следующем запросе показано выражение запроса, которое используется в операторе "select" для извлечения результатов операции группирования.

[!code-csharp[csrefQueryExpBasics#63](~/samples/snippets/csharp/concepts/linq/query-expression-basics_19.cs)]

Дополнительные сведения см. в руководстве по [выполнению вложенного запроса в операции группирования](perform-a-subquery-on-a-grouping-operation.md).

## <a name="see-also"></a>См. также

- [Руководство по программированию на C#](../programming-guide/index.md)
- [LINQ](index.md)
- [Ключевые слова запросов (LINQ)](../language-reference/keywords/query-keywords.md)
- [Общие сведения о стандартных операторах запросов](../programming-guide/concepts/linq/standard-query-operators-overview.md)
