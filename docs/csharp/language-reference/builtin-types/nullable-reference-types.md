---
title: Ссылочные типы, допускающие значение NULL, — справочник по C#
description: Сведения о ссылочных типах C#, допускающих значение NULL, и их использовании
ms.date: 04/06/2020
ms.openlocfilehash: d961af9ba3b4776e6b4ec3eeea5392fb0d0394ce
ms.sourcegitcommit: 965a5af7918acb0a3fd3baf342e15d511ef75188
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/18/2020
ms.locfileid: "94822429"
---
# <a name="nullable-reference-types-c-reference"></a>Ссылочные типы, допускающие значение NULL (справочник по C#)

> [!NOTE]
> В этой статье рассматриваются ссылочные типы, допускающие значение NULL. Вы также можете объявить [типы значений, допускающие значение NULL](nullable-value-types.md).

Ссылочные типы, допускающие значение NULL, доступны начиная с C# 8.0, в коде, который дал явное согласие на *контекст, поддерживающий значение NULL*. Ссылочные типы, допускающие значение NULL, предупреждения о значении NULL при статическом анализе и [оператор, опускающий NULL](../operators/null-forgiving.md), являются необязательными функциями языка. По умолчанию все они отключены. *Контекст, допускающий значение NULL*, контролируется на уровне проекта с помощью параметров сборки или в коде с помощью директив pragma.

 В контексте, поддерживающем значение NULL:

- переменная ссылочного типа `T` должна быть инициализирована со значением, отличным от NULL, и ей невозможно присвоить значение, которое может быть равно `null`;
- переменная ссылочного типа `T?` может быть инициализирована с помощью `null`, или ей может быть присвоено значение `null`, но она должна быть проверена на `null` перед разыменованием;
- переменная `m` типа `T?` считается не равной NULL при применении оператора, опускающего NULL, как в `m!`.

Различия между ссылочным типом, не допускающим значение NULL, `T` и ссылочным типом, допускающим значение NULL, `T?` проявляются при интерпретации предыдущих правил компилятором. Переменная типа `T` и переменная типа `T?` представлены одним и тем же типом .NET. В следующем примере объявляется строка, не допускающая значение NULL, и строка, допускающая значение NULL, а затем используется оператор, опускающий NULL, для присваивания значения строке, не допускающей значение NULL:

:::code language="csharp" source="snippets/shared/NullableReferenceTypes.cs" id="SnippetCoreSyntax":::

Переменные `notNull` и `nullable` представлены типом <xref:System.String>. Так как типы, допускающие и не допускающие значение NULL, хранятся в виде одного типа, существует несколько мест, где использование ссылочного типа, допускающего значение NULL, не допускается. Как правило, ссылочный тип, допускающий значение NULL, запрещено использовать в качестве базового класса или реализованного интерфейса. Ссылочный тип, допускающий значение NULL, не может использоваться в выражении проверки типа или создания объекта. Ссылочный тип, допускающий значение NULL, не может быть типом выражения доступа к члену. Эти конструкции показаны в следующих примерах:

```csharp
public MyClass : System.Object? // not allowed
{
}

var nullEmpty = System.String?.Empty; // Not allowed
var maybeObject = new object?(); // Not allowed
try
{
    if (thing is string? nullableString) // not allowed
        Console.WriteLine(nullableString);
} catch (Exception? e) // Not Allowed
{
    Console.WriteLine("error");
}
```

## <a name="nullable-references-and-static-analysis"></a>Ссылки, допускающие значение NULL, и статический анализ

Примеры в предыдущем разделе иллюстрируют природу ссылочных типов, допускающих значение NULL. Ссылочные типы, допускающие значение NULL, не являются новыми типами классов, а обозначены заметками для существующих ссылочных типов. Компилятор использует эти заметки, чтобы помочь найти потенциальные ошибки для пустых ссылок в коде. Во время выполнения нет никакой разницы между ссылочным типом, не допускающим значение NULL, и ссылочным типом, допускающим значение NULL. Компилятор не добавляет никакую проверку для ссылочных типов, не допускающих значение NULL, во время выполнения. Преимущества заключаются в анализе времени компиляции. Компилятор создает предупреждения, помогающие находить и исправлять потенциальные ошибки со значениями NULL в коде. Вы объявляете свое намерение, и компилятор предупреждает вас, если код нарушает его.

В контексте, допускающем значение NULL, компилятор выполняет статический анализ для переменных любого ссылочного типа, как допускающего, так и не допускающего значение NULL. Компилятор отслеживает состояние NULL каждой ссылочной переменной в виде *не NULL* или *может быть NULL*. Состоянием по умолчанию для ссылки, не допускающей значение NULL, является *не NULL*. Состоянием по умолчанию для ссылки, допускающей значение NULL, является *может быть NULL*.

Ссылочные типы, не допускающие значение NULL, всегда должны быть безопасными для разыменования, так как их состоянием NULL является *не NULL*. Чтобы применить это правило, компилятор выдает предупреждения, если ссылочный тип, не допускающий значение NULL, не инициализируется со значением, отличным от NULL. Локальные переменные должны присваиваться там же, где они объявляются. Каждый конструктор должен назначить каждое поле либо в своем теле, вызываемом конструкторе, либо с помощью инициализатора поля. Компилятор выдает предупреждения, если ссылка, не допускающая значение NULL, присваивается ссылке с состоянием *может быть NULL*. Однако так как ссылка, не допускающая значение NULL, имеет состояние *не NULL*, при разыменовании этих переменных предупреждения не выдаются.

Ссылочные типы, допускающие значение NULL, могут быть инициализированы или присвоены `null`. Таким образом, статический анализ должен определить, что переменная имеет состояние *не NULL*, до ее разыменования. Если ссылка, допускающая значение NULL, определяется как *может быть NULL*, ее невозможно присвоить ссылочной переменной, не допускающей значение NULL. В следующем классе показаны примеры этих предупреждений:

:::code language="csharp" source="snippets/shared/NullableReferenceTypes.cs" id="SnippetClassWithNullable":::

В следующем фрагменте кода показано, где компилятор выдает предупреждения при использовании этого класса:

:::code language="csharp" source="snippets/shared/NullableReferenceTypes.cs" id="SnippetLocalWarnings":::

В предыдущих примерах показан статический анализ компилятора для определения состояния NULL ссылочных переменных. Компилятор применяет правила языка для проверок и присваиваний, чтобы получить сведения для анализа.  Компилятор не может делать предположения о семантике методов или свойств. При вызове методов, выполняющих проверки значений NULL, компилятор не может понять, что эти методы влияют на состояние NULL переменной. Существует ряд атрибутов, которые можно добавить в API, чтобы сообщить компилятору о семантике аргументов и возвращаемых значений. Эти атрибуты применялись для многих общих API в библиотеках .NET Core. Например, <xref:System.String.IsNullOrEmpty%2A> был обновлен, и компилятор правильно интерпретирует этот метод как проверку значения NULL. Дополнительные сведения об атрибутах, применяемых для статического анализа состояния NULL, см. в статье [Атрибуты, допускающие значение NULL](../attributes/nullable-analysis.md).

## <a name="setting-the-nullable-context"></a>Задание контекста, допускающего значение NULL

Существует два способа управления контекстом, допускающим значение NULL. На уровне проекта можно добавить параметр `<Nullable>enable</Nullable>`. В одном файле исходного кода C# можно добавить директиву pragma `#nullable enable`, чтобы включить контекст, допускающий значение NULL. См. статью о [настройке стратегии, допускающей значение NULL](../../nullable-migration-strategies.md).

## <a name="c-language-specification"></a>Спецификация языка C#

Дополнительные сведения см. в следующих предложениях для [спецификации языка C#](~/_csharplang/spec/introduction.md):

- [Ссылочные типы, допускающие значение NULL](~/_csharplang/proposals/csharp-8.0/nullable-reference-types.md)
- [Ссылочные типы, допускающие значение NULL. Черновик спецификации](~/_csharplang/proposals/csharp-9.0/nullable-reference-types-specification.md)

## <a name="see-also"></a>См. также

- [справочник по C#](../index.md)
- [Типы значений, допускающие значение NULL](nullable-value-types.md)
