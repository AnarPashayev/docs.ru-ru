---
title: Справочник по C#. Ключевое слово ref
ms.date: 03/26/2019
f1_keywords:
- ref_CSharpKeyword
- ref
helpviewer_keywords:
- parameters [C#], ref
- ref keyword [C#]
ms.openlocfilehash: 05f0bd8566851678203a3f064b96bfff7dee18b6
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/14/2020
ms.locfileid: "79398133"
---
# <a name="ref-c-reference"></a>ref (Справочник по C#)

Ключевое слово `ref` указывает на значение, переданное по ссылке. Оно используется в четырех разных контекстах:

- В сигнатуре и вызове метода для передачи аргумента в метод по ссылке. Дополнительные сведения см. в статье о [передаче аргументов по ссылке](#passing-an-argument-by-reference).
- В сигнатуре метода для возврата значения вызывающему объекту по ссылке. Дополнительные сведения см. в разделе [Значения, возвращаемые по ссылке](#reference-return-values).
- В теле элемента для указания на то, что возвращаемые ссылочные значения хранятся локально в виде ссылки, которая может быть изменена вызывающим объектом, или, в общем случае, что локальная переменная обращается к другому значению по ссылке. Дополнительные сведения см. в статье о [ссылочных локальных переменных](#ref-locals).
- В объявлении `struct`, чтобы объявить `ref struct` или `readonly ref struct`. Дополнительные сведения см. в статье о [типах ссылочных структур](#ref-struct-types).

## <a name="passing-an-argument-by-reference"></a>Передача аргументов по ссылке

При использовании в списке параметров метода ключевое слово `ref` указывает на то, что аргумент передается по ссылке, а не по значению. Ключевое слово `ref` позволяет превратить этот формальный параметр в псевдоним для аргумента, который должен представлять собой переменную. Другими словами, любая операция в параметре осуществляется с аргументом. Например, если вызывающий объект передает выражение локальной переменной или выражение доступа к элементу массива и вызванный метод заменяет объект, на который ссылается параметр ref, то локальная переменная или элемент массива взывающего объекта будет ссылаться на новый объект после возврата из метода.

> [!NOTE]
> Не следует путать понятие передачи по ссылке с понятием ссылочных типов. Эти два понятия не совпадают. Параметр метода может быть изменен с помощью `ref` независимо от того, принадлежит ли он к типу значения или ссылочному типу. При передаче по ссылке упаковка-преобразование типа значения не производится.  

Для использования параметра `ref` и при определении метода, и при вызове метода следует явно использовать ключевое слово `ref`, как показано в следующем примере.  

[!code-csharp-interactive[csrefKeywordsMethodParams#6](~/samples/snippets/csharp/language-reference/keywords/in-ref-out-modifier/RefParameterModifier.cs#1)]

Аргумент, передаваемый в параметр `ref` или `in`, нужно инициализировать перед передачей. В этом заключается отличие от параметров [out](out-parameter-modifier.md), аргументы которых не требуют явной инициализации перед передачей.

Члены класса не могут иметь сигнатуры, отличающихся только `ref`, `in` или `out`. Если единственное различие между двумя членами типа состоит в том, что один из них имеет параметр `ref`, а второй — параметр `out` или `in`, возникает ошибка компилятора. Например, следующий код не будет компилироваться.  

```csharp
class CS0663_Example
{
    // Compiler error CS0663: "Cannot define overloaded
    // methods that differ only on ref and out".
    public void SampleMethod(out int i) { }
    public void SampleMethod(ref int i) { }
}
```

Но методы можно перегружать, если один метод имеет параметр `ref`, `in` или `out`, а другой — параметр по значению, как показано в приведенном ниже примере.
  
[!code-csharp[csrefKeywordsMethodParams#6](~/samples/snippets/csharp/language-reference/keywords/in-ref-out-modifier/RefParameterModifier.cs#2)]
  
 В других ситуациях, требующих соответствия сигнатур, таких как скрытие или переопределение, `in`, `ref` и `out` являются частью сигнатуры и не соответствуют друг другу.  
  
 Свойства не являются переменными. Они являются методами и не могут быть переданы в параметр `ref`.  
  
 Ключевые слова `ref`, `in` и `out` запрещено использовать для следующих типов методов.  
  
- Асинхронные методы, которые определяются с помощью модификатора [async](async.md).  
- Методы итератора, которые включают оператор [yield return](yield.md) или `yield break`.  

## <a name="passing-an-argument-by-reference-an-example"></a>Передача аргументов по ссылке. Пример

В предыдущих примерах типы значений передаются по ссылке. Также можно использовать ключевое слово `ref` для передачи ссылочных типов по ссылке. Передача ссылочного типа по ссылке позволяет вызываемому методу заменять объект, на который указывает ссылочный параметр в вызывающем объекте. Место хранения объекта передается методу в качестве значения ссылочного параметра. Если изменить место хранения параметра (с указанием на новый объект), необходимо изменить место хранения, на который ссылается вызывающий объект. В следующем примере экземпляр ссылочного типа передается как параметр `ref`.
  
[!code-csharp[csrefKeywordsMethodParams#6](~/samples/snippets/csharp/language-reference/keywords/in-ref-out-modifier/RefParameterModifier.cs#3)]

Дополнительные сведения о передаче ссылочных типов по значению и по ссылке см. в разделе [Передача параметров ссылочного типа](../../programming-guide/classes-and-structs/passing-reference-type-parameters.md).
  
## <a name="reference-return-values"></a>Возвращаемые ссылочные значения

Возвращаемые ссылочные значения — это значения, которые метод возвращает вызывающему объекту по ссылке. Это значит, что вызывающий объект может изменять значение, возвращаемое методом, и это изменение будет отражаться в состоянии объекта, содержащего этот метод.

Возвращаемое ссылочное значение определяется с помощью ключевого слова `ref`:

- В сигнатуре метода. Например, следующая сигнатура указывает, что метод `GetCurrentPrice` возвращает значение <xref:System.Decimal> по ссылке.

```csharp
public ref decimal GetCurrentPrice()
```

- Между токеном `return` и переменной, возвращенной в инструкции `return` в методе. Пример:

```csharp
return ref DecimalArray[0];
```

Чтобы вызывающий объект имел возможность изменять состояние объекта, возвращаемое ссылочное значение должно храниться в переменной, которая явно определена как [ссылочная локальная переменная](#ref-locals).

Вызываемый метод может также объявить возвращаемое значение `ref readonly`, чтобы возвращать значения по ссылке, и запретить вызывающему коду изменять возвращенное значение. Вызывающий метод может обойтись без копирования возвращаемого значения, сохраняя его в локальной переменной [ref readonly](#ref-readonly-locals).

Пример см. в разделе [Пример использования возвращаемых ссылочных значений и ссылочных локальных переменных](#a-ref-returns-and-ref-locals-example).

## <a name="ref-locals"></a>Ссылочные локальные переменные

Ссылочная локальная переменная задает ссылку на значения, возвращаемые с помощью `return ref`. Ссылочная локальная переменная не может инициализироваться как не ссылочное возвращаемое значение. Другими словами, правая часть инициализации должна быть ссылкой. Любые изменения в значении ссылочной локальной переменной отражаются в состоянии объекта, метод которого возвращает значение по ссылке.

Ссылочная локальная переменная определяется с помощью ключевого слова `ref` перед объявлением переменной, а также непосредственно перед вызовом метода, который возвращает значение по ссылке.

Например, следующая инструкция определяет значение ссылочной локальной переменной, которое возвращается методом `GetEstimatedValue`:

```csharp
ref decimal estValue = ref Building.GetEstimatedValue();
```

Вы можете таким же образом обратиться к значению по ссылке. В некоторых случаях обращение к значению по ссылке повышает производительность, поскольку позволяет избежать потенциально затратной операции копирования. Например, в следующей инструкции показано, как можно определить локальное ссылочное значение, используемое для ссылки на значение.

```csharp
ref VeryLargeStruct reflocal = ref veryLargeStruct;
```

Обратите внимание, что в обоих примерах ключевое слово `ref` необходимо использовать в обоих местах. В противном случае возникает ошибка компилятора CS8172, "Невозможно инициализировать значением переменную по ссылке".

Начиная с версии C# 7.3, переменная итерации инструкции `foreach` может иметь вид локальной ссылочной переменной или локальной ссылочной переменной только для чтения. Дополнительные сведения см. в статье, посвященной [инструкции foreach](foreach-in.md).

Также, начиная с версии C# 7.3, вы можете переназначать ссылочную локальную переменную или ссылочную локальную переменную только для чтения с помощью [ссылочного оператора присваивания](../operators/assignment-operator.md#ref-assignment-operator).

## <a name="ref-readonly-locals"></a>Ссылочные локальные переменные только для чтения

Ссылочная локальная переменная только для чтения (ref readonly) позволяет сохранить ссылку на значения, возвращаемые методом или свойством, которые имеют в сигнатуре модификатор `ref readonly` и используют `return ref`. Переменная `ref readonly` сочетает свойства локальной переменной `ref` и переменной `readonly`. Она является псевдонимом для хранилища, которому она присвоена, и не может изменять свое значение.

## <a name="a-ref-returns-and-ref-locals-example"></a>Пример использования возвращаемых ссылочных значений и ссылочных локальных переменных

В следующем примере определяется класс `Book`, содержащий два поля <xref:System.String>: `Title` и `Author`. Также определяется класс `BookCollection`, который включает частный массив объектов `Book`. Отдельные объекты книг возвращаются по ссылке путем вызова метода `GetBookByTitle`.

[!code-csharp[csrefKeywordsMethodParams#6](~/samples/snippets/csharp/language-reference/keywords/in-ref-out-modifier/RefParameterModifier.cs#4)]

Если вызывающий объект сохраняет значение, возвращаемое методом `GetBookByTitle`, в качестве ссылочной локальной переменной, изменения, которые этот объект вносит в возвращаемое значение, отражаются в объекте `BookCollection`, как показано в следующем примере.

[!code-csharp[csrefKeywordsMethodParams#6](~/samples/snippets/csharp/language-reference/keywords/in-ref-out-modifier/RefParameterModifier.cs#5)]

## <a name="ref-struct-types"></a>Типы ссылочных структур

Добавление модификатора `ref` в объявление `struct` определяет, что экземпляры этого типа должны размещаться в стеке. Другими словами, экземпляры этих типов никогда не создаются из кучи в роли члена другого класса. Главным стимулом для создания этой функции была структура <xref:System.Span%601> и связанные структуры.

Необходимость поддержки типа `ref struct` как выделенной в стеке переменной вводит ряд правил, применяемых компилятором ко всем типам `ref struct`.

- `ref struct` не поддерживает упаковку. Тип `ref struct` невозможно присвоить переменной типа `object`, `dynamic` или любому типу интерфейса.
- Типы `ref struct` не могут реализовывать интерфейсы.
- `ref struct` невозможно объявить как член поля класса или обычной структуры. Сюда входит объявление автоматически реализуемого свойства, которое создает резервное поле, созданное компилятором.
- Невозможно объявить локальные переменные, которые являются типами `ref struct` в асинхронных методах. Вы можете объявлять их в синхронных методах, которые возвращают типы <xref:System.Threading.Tasks.Task>, <xref:System.Threading.Tasks.Task%601> или `Task`.
- Локальные переменные `ref struct` невозможно объявить в итераторах.
- Невозможно захватить переменные `ref struct` в лямбда-выражениях или локальных функциях.

Эти ограничения позволяют избежать случайного использования `ref struct`, которое может повысить его уровень до управляемой кучи.

Вы можете сочетать модификаторы и объявить структуру как `readonly ref`. Объявление `readonly ref struct` объединяет все преимущества и ограничения объявлений `ref struct` и `readonly struct`.

## <a name="c-language-specification"></a>Спецификация языка C#

[!INCLUDE[CSharplangspec](~/includes/csharplangspec-md.md)]  
  
## <a name="see-also"></a>См. также

- [Написание безопасного и эффективного кода](../../write-safe-efficient-code.md)
- [Возвращаемые значения ref и локальные переменные ref](../../programming-guide/classes-and-structs/ref-returns.md)
- [Условное выражение REF](../operators/conditional-operator.md#conditional-ref-expression)
- [Передача параметров](../../programming-guide/classes-and-structs/passing-parameters.md)
- [Параметры методов](method-parameters.md)
- [Справочник по C#](../index.md)
- [Руководство по программированию на C#](../../programming-guide/index.md)
- [Ключевые слова в C#](index.md)
