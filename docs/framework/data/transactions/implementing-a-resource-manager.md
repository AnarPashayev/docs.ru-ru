---
title: Реализация диспетчера ресурсов
description: Реализуйте диспетчер ресурсов в .NET. Диспетчер ресурсов управляет ресурсами, используемыми в транзакциях. Диспетчер транзакций координирует действия диспетчера ресурсов.
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: e6370f6b544255ebdc402f06b7977d4a3a587c32
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91182900"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="a8e13-105">Реализация диспетчера ресурсов</span><span class="sxs-lookup"><span data-stu-id="a8e13-105">Implementing a Resource Manager</span></span>

<span data-ttu-id="a8e13-106">Каждым используемым в транзакции ресурсом управляет диспетчер ресурсов, действия которого координируются диспетчером транзакций.</span><span class="sxs-lookup"><span data-stu-id="a8e13-106">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="a8e13-107">Диспетчеры ресурсов работают совместно с диспетчером транзакций для предоставления приложения, гарантирующего атомарность и изоляцию.</span><span class="sxs-lookup"><span data-stu-id="a8e13-107">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="a8e13-108">Примерами диспетчеров ресурсов являются Microsoft SQL Server, устойчивые очереди сообщений и расположенные в оперативной памяти хэш-таблицы.</span><span class="sxs-lookup"><span data-stu-id="a8e13-108">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="a8e13-109">Диспетчер ресурсов управляет либо устойчивыми, либо неустойчивыми данными.</span><span class="sxs-lookup"><span data-stu-id="a8e13-109">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="a8e13-110">Устойчивость (или наоборот, неустойчивость) диспетчера ресурсов определяет, поддерживает ли он восстановление после сбоя.</span><span class="sxs-lookup"><span data-stu-id="a8e13-110">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="a8e13-111">Если диспетчер ресурсов поддерживает восстановление после сбоя, он сохраняет данные в устойчивом хранилище во время фазы 1 (подготовка); таким образом, если диспетчер ресурсов выходит из строя, он может повторно зачислиться в транзакцию после восстановления и выполнить соответствующие действия на основе уведомлений, полученных от диспетчера транзакций.</span><span class="sxs-lookup"><span data-stu-id="a8e13-111">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="a8e13-112">В основном, диспетчеры неустойчивых ресурсов управляют неустойчивыми ресурсами, такими как структура данных, расположенная в оперативной памяти (например транзакционная хэш-таблица), а диспетчеры устойчивых ресурсов управляют устойчивыми ресурсами, которые имеют более устойчивое резервное хранилище (например, базой данных, резервным хранилищем которой является диск).</span><span class="sxs-lookup"><span data-stu-id="a8e13-112">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="a8e13-113">Для участия в транзакции ресурс должен зачислиться в нее.</span><span class="sxs-lookup"><span data-stu-id="a8e13-113">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="a8e13-114"><xref:System.Transactions.Transaction>Класс определяет набор методов, имена которых начинаются с **прикрепления** , обеспечивающих эту функциональность.</span><span class="sxs-lookup"><span data-stu-id="a8e13-114">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="a8e13-115">Различные методы **прикрепления** соответствуют различным типам прикрепления, которые могут иметь диспетчер ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8e13-115">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="a8e13-116">В частности, методы <xref:System.Transactions.Transaction.EnlistVolatile%2A> используются для неустойчивых ресурсов, а метод <xref:System.Transactions.Transaction.EnlistDurable%2A> - для устойчивых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8e13-116">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="a8e13-117">После выбора используемого метода (<xref:System.Transactions.Transaction.EnlistDurable%2A> или <xref:System.Transactions.Transaction.EnlistVolatile%2A>) в зависимости от поддержки ресурсом восстановления после сбоя необходимо зачислить ресурс для участия в двухфазной фиксации путем реализации интерфейса <xref:System.Transactions.IEnlistmentNotification> для диспетчера ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8e13-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="a8e13-118">Дополнительные сведения о 2PC см. [в статье фиксация транзакции в однофазном и многофазном](committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="a8e13-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="a8e13-119">Зачисление гарантирует получение диспетчером ресурсов обратных вызовов от диспетчера транзакций при фиксации или прерывании транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-119">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="a8e13-120">Для каждого зачисления существует один экземпляр класса <xref:System.Transactions.IEnlistmentNotification>.</span><span class="sxs-lookup"><span data-stu-id="a8e13-120">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="a8e13-121">Как правило, для каждой транзакции существует одно зачисление, однако диспетчер ресурсов может зачислиться в одну транзакцию несколько раз.</span><span class="sxs-lookup"><span data-stu-id="a8e13-121">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="a8e13-122">После зачисления диспетчер ресурсов отвечает на запросы транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-122">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="a8e13-123">Диспетчер устойчивых ресурсов сохраняет достаточное количество данных, чтобы отменить или повторить операции транзакции над ресурсами, которыми он управляет.</span><span class="sxs-lookup"><span data-stu-id="a8e13-123">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="a8e13-124">Существует множество способов сохранения этих данных; двумя наиболее распространенными из них являются сохранение версий данных и ведение журнала изменений.</span><span class="sxs-lookup"><span data-stu-id="a8e13-124">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="a8e13-125">Когда приложение запрашивает фиксацию транзакции, диспетчер транзакций инициирует протокол двухфазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="a8e13-125">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="a8e13-126">Сначала диспетчер транзакций опрашивает все зачисленные диспетчеры ресурсов, чтобы выяснить, готовы ли они к фиксации транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-126">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="a8e13-127">Диспетчер ресурсов должен подготовиться к фиксации или прерыванию транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-127">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="a8e13-128">В фазе подготовки диспетчер устойчивых ресурсов записывает старые и новые данные в устойчивое хранилище, чтобы иметь возможность их восстановления в случае сбоя системы.</span><span class="sxs-lookup"><span data-stu-id="a8e13-128">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="a8e13-129">Если диспетчер ресурсов способен выполнить подготовку, он передает диспетчеру транзакции свой голос за фиксацию или прерывание транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-129">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="a8e13-130">Если хотя бы от одного диспетчера ресурсов получено сообщение о том, что подготовку выполнить не удалось, диспетчер транзакций передает команду отката каждому диспетчеру ресурсов и сообщает приложению о сбое фиксации.</span><span class="sxs-lookup"><span data-stu-id="a8e13-130">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="a8e13-131">После подготовки диспетчер ресурсов должен ожидать получения обратного вызова фиксации или прекращения от диспетчера транзакций на второй фазе.</span><span class="sxs-lookup"><span data-stu-id="a8e13-131">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="a8e13-132">Обычно весь протокол подготовки и фиксации выполняется за долю секунды.</span><span class="sxs-lookup"><span data-stu-id="a8e13-132">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="a8e13-133">В случае системного сбоя или отказа канала связи уведомление о фиксации или прерывании может прийти по прошествии нескольких минут или часов.</span><span class="sxs-lookup"><span data-stu-id="a8e13-133">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="a8e13-134">В течение этого времени диспетчеру ресурсов не известен результат транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-134">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="a8e13-135">Он не знает, была ли транзакция зафиксирована или прервана.</span><span class="sxs-lookup"><span data-stu-id="a8e13-135">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="a8e13-136">Пока результат транзакции неизвестен, диспетчер ресурсов сохраняет измененные данные посредством сохранения блокировки транзакции, изолируя эти изменения от всех остальных транзакций.</span><span class="sxs-lookup"><span data-stu-id="a8e13-136">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="a8e13-137">При сбое диспетчера ресурсов прерываются все его транзакции, за исключением транзакций, которые были подготовлены или зафиксированы до сбоя.</span><span class="sxs-lookup"><span data-stu-id="a8e13-137">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="a8e13-138">После перезапуска диспетчер устойчивых ресурсов воссоздает фиксированное состояние управляемых им ресурсов путем извлечения данных подготовки, записанных в фазе подготовки, и соответственно фиксирует или прерывает эти транзакции.</span><span class="sxs-lookup"><span data-stu-id="a8e13-138">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="a8e13-139">Протокол двухфазной фиксации и диспетчеры ресурсов вместе обеспечивают атомарность и устойчивость транзакций.</span><span class="sxs-lookup"><span data-stu-id="a8e13-139">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="a8e13-140">Класс <xref:System.Transactions.Transaction> также предоставляет метод <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> для PSPE-зачисления.</span><span class="sxs-lookup"><span data-stu-id="a8e13-140">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="a8e13-141">Это позволяет диспетчеру устойчивых ресурсов "владеть" и управлять транзакцией, которая затем при необходимости может быть повышена до транзакции MSDTC.</span><span class="sxs-lookup"><span data-stu-id="a8e13-141">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="a8e13-142">Дополнительные сведения об этом см. в статье [Оптимизация с помощью однофазного уведомления о фиксации и продвижения с одним этапом](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="a8e13-142">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="a8e13-143">в этом разделе</span><span class="sxs-lookup"><span data-stu-id="a8e13-143">In This Section</span></span>  

 <span data-ttu-id="a8e13-144">Действия, обычно выполняемые диспетчером ресурсов, описываются в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="a8e13-144">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="a8e13-145">Зачисление ресурсов в транзакцию в качестве участников</span><span class="sxs-lookup"><span data-stu-id="a8e13-145">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="a8e13-146">Описывает порядок зачисления устойчивого или неустойчивого ресурса в транзакцию.</span><span class="sxs-lookup"><span data-stu-id="a8e13-146">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="a8e13-147">Однофазная и многофазная фиксация транзакции</span><span class="sxs-lookup"><span data-stu-id="a8e13-147">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="a8e13-148">Описывает, как диспетчер ресурсов отвечает на уведомление о фиксации и подготавливает фиксацию.</span><span class="sxs-lookup"><span data-stu-id="a8e13-148">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="a8e13-149">Выполнение восстановления</span><span class="sxs-lookup"><span data-stu-id="a8e13-149">Performing Recovery</span></span>](performing-recovery.md)  
  
 <span data-ttu-id="a8e13-150">Описывает порядок восстановления диспетчера устойчивых ресурсов после сбоя.</span><span class="sxs-lookup"><span data-stu-id="a8e13-150">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="a8e13-151">Уровни доверия, используемые при доступе к ресурсам</span><span class="sxs-lookup"><span data-stu-id="a8e13-151">Security Trust Levels in Accessing Resources</span></span>](security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="a8e13-152">Описывает, как три уровня доверия для System.Transactions ограничивают доступ к ресурсам различных типов, используемым инфраструктурой <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="a8e13-152">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="a8e13-153">Оптимизация производительности с помощью механизмов уведомления об однофазной фиксации и повышаемого однофазного присоединения</span><span class="sxs-lookup"><span data-stu-id="a8e13-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="a8e13-154">Описывает способы оптимизации, доступные реализациям диспетчеров ресурсов.</span><span class="sxs-lookup"><span data-stu-id="a8e13-154">Describes optimization practices available to implementations of resource managers.</span></span>
