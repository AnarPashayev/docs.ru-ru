---
title: Зачисление ресурсов в транзакцию в качестве участников
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: 83d83df0f747198e93dd64308b904cad5c7439ec
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205978"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a>Зачисление ресурсов в транзакцию в качестве участников

Каждым участвующим в транзакции ресурсом управляет диспетчер ресурсов, действия которого координируются диспетчером транзакций. Координация осуществляется посредством уведомлений, которые передаются подписчикам, зачисленным в транзакцию с помощью диспетчера транзакций.

В этом разделе описывается, как зачислить в транзакцию один или несколько ресурсов, и рассматриваются различные типы зачисления. В разделе [фиксация транзакции в однофазной и](committing-a-transaction-in-single-phase-and-multi-phase.md) многофазной главе описывается, как обязательства транзакций можно координировать между прикрепленными ресурсами.

## <a name="enlisting-resources-in-a-transaction"></a>Зачисление ресурсов в транзакцию

Для участия в транзакции ресурс должен зачислиться в нее. Класс определяет набор методов, имена которых начинаются с прикрепления, обеспечивающих эту функциональность. <xref:System.Transactions.Transaction> Различные методы **прикрепления** соответствуют различным типам прикрепления, которые могут иметь диспетчер ресурсов. В частности, методы <xref:System.Transactions.Transaction.EnlistVolatile%2A> используются для неустойчивых ресурсов, а метод <xref:System.Transactions.Transaction.EnlistDurable%2A> - для устойчивых ресурсов. Устойчивость (или наоборот, неустойчивость) диспетчера ресурсов определяет, поддерживает ли он восстановление после сбоя. Если диспетчер ресурсов поддерживает восстановление после сбоя, он сохраняет данные в устойчивом хранилище во время фазы 1 (подготовка); таким образом, если диспетчер ресурсов выходит из строя, он может повторно зачислиться в транзакцию после восстановления и выполнить соответствующие действия на основе уведомлений, полученных от диспетчера транзакций. В основном, диспетчеры неустойчивых ресурсов управляют неустойчивыми ресурсами, такими как структура данных, расположенная в оперативной памяти (например транзакционная хэш-таблица), а диспетчеры устойчивых ресурсов управляют устойчивыми ресурсами, которые имеют более устойчивое резервное хранилище (например, базой данных, резервным хранилищем которой является диск).

После выбора используемого метода (<xref:System.Transactions.Transaction.EnlistDurable%2A> или <xref:System.Transactions.Transaction.EnlistVolatile%2A>) в зависимости от поддержки ресурсом восстановления после сбоя необходимо зачислить ресурс для участия в двухфазной фиксации путем реализации интерфейса <xref:System.Transactions.IEnlistmentNotification> для диспетчера ресурсов. Дополнительные сведения о 2PC см. [в статье фиксация транзакции в однофазном и](committing-a-transaction-in-single-phase-and-multi-phase.md)многофазном.

Один участник может зачислиться в транзакцию с использованием более одного протокола, вызвав методы <xref:System.Transactions.Transaction.EnlistDurable%2A> и <xref:System.Transactions.Transaction.EnlistVolatile%2A> несколько раз.

### <a name="durable-enlistment"></a>Зачисление устойчивых ресурсов

Методы <xref:System.Transactions.Transaction.EnlistDurable%2A> используются для зачисления диспетчера ресурсов в транзакцию в качестве устойчивого ресурса.  Предполагается, что в случае выхода из строя в ходе транзакции диспетчер устойчивых ресурсов может выполнить восстановление после повторного зачисления (с помощью метода <xref:System.Transactions.TransactionManager.Reenlist%2A>) во все транзакции, в которых он участвовал, но в которых он не выполнил операции фазы 2, и вызвать метод <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> после завершения восстановления. Дополнительные сведения о восстановлении см. в разделе [выполнение восстановления](performing-recovery.md).

Все методы <xref:System.Transactions.Transaction.EnlistDurable%2A> принимают в качестве первого параметра объект <xref:System.Guid>. Объект <xref:System.Guid> используется диспетчером транзакций для связывания зачисленного устойчивого ресурса с конкретным диспетчером ресурсов. Поэтому крайне важно, чтобы диспетчер ресурсов согласованно использовал один и тот же объект <xref:System.Guid> для идентификации себя среди различных диспетчеров ресурсов при перезапуске, иначе может не удастся выполнить восстановление.

Второй параметр метода <xref:System.Transactions.Transaction.EnlistDurable%2A> является ссылкой на объект, реализуемый диспетчером ресурсов для получения уведомлений транзакции. Используемый перегруженный метод сообщает диспетчеру транзакций, поддерживает ли диспетчер ресурсов оптимизацию однофазной фиксации. В большинстве случаев требуется реализовать интерфейс <xref:System.Transactions.IEnlistmentNotification> для принятия участия в двухфазной фиксации. Однако если требуется оптимизировать процесс фиксации, можно реализовать интерфейс <xref:System.Transactions.ISinglePhaseNotification> для однофазной фиксации. Дополнительные сведения о SPC см. в статьях [фиксация транзакции в однофазном и](committing-a-transaction-in-single-phase-and-multi-phase.md) многоэтапной и [Оптимизация с помощью](optimization-spc-and-promotable-spn.md)однофазного уведомления с одноэтапной фиксацией и с возможностью продвижения.

Третий параметр - это перечисление <xref:System.Transactions.EnlistmentOptions>, значением которого может являться <xref:System.Transactions.EnlistmentOptions.None> или <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>. Если задано значение <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, при получении уведомления о подготовке от диспетчера транзакций можно зачислить дополнительные диспетчеры ресурсов. Однако следует иметь в виду, что данный тип зачисления не подходит для оптимизации однофазной фиксации.

### <a name="volatile-enlistment"></a>Зачисление неустойчивых ресурсов

Участникам, управляющим неустойчивыми ресурсами, такими как кэш, необходимо зачисляться с помощью методов <xref:System.Transactions.Transaction.EnlistVolatile%2A>. Такие объекты могут быть неспособны получить результат транзакции или восстановить состояние какой-либо транзакции, к которой они присоединяются после сбоя.

Как уже было отмечено, диспетчер ресурсов выполняет зачисление неустойчивого ресурса, если он управляет неустойчивым ресурсом, расположенным в оперативной памяти. Одно из преимуществ использования метода <xref:System.Transactions.Transaction.EnlistVolatile%2A> заключается в том, что он не приводит к передаче транзакции на следующий уровень иерархии, если эта передача не является необходимой. Дополнительные сведения о укрупнении транзакций см. в разделе [эскалация управления транзакциями](transaction-management-escalation.md) . Прикрепление изменчивости подразумевает и то, и другое, как зачисление обрабатывается диспетчером транзакций, а также ожидаемый диспетчером транзакций диспетчер ресурсов. Это обусловлено тем, что диспетчер неустойчивых ресурсов не выполняет восстановление. Методы <xref:System.Transactions.Transaction.EnlistVolatile%2A> не принимают параметр <xref:System.Guid>, поскольку диспетчер неустойчивых ресурсов не выполняет восстановление и не вызывает метод <xref:System.Transactions.TransactionManager.Reenlist%2A>, которому требуется объект <xref:System.Guid>.

Как и в случае зачисления устойчивых ресурсов используемый для зачисления перегруженный метод указывает диспетчеру транзакций, поддерживает ли диспетчер ресурсов оптимизацию однофазной фиксации. Поскольку диспетчер неустойчивых ресурсов не может выполнять восстановление, никакие данные для восстановления не записываются для зачисленного неустойчивого ресурса во время фазы подготовки. Таким образом, при вызове метода <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> возникает исключение <xref:System.InvalidOperationException>.

В следующем примере показано, как с помощью метода <xref:System.Transactions.Transaction.EnlistVolatile%2A> зачислить объект в транзакцию в качестве участника.

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a>Оптимизация производительности

Класс <xref:System.Transactions.Transaction> также предоставляет метод <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> для PSPE-зачисления. Это позволяет диспетчеру устойчивых ресурсов "владеть" и управлять транзакцией, которая затем при необходимости может быть повышена до транзакции MSDTC. Дополнительные сведения об этом см. в статье [Оптимизация с помощью однофазного уведомления о фиксации и продвижения с одним этапом](optimization-spc-and-promotable-spn.md).

## <a name="see-also"></a>См. также

- [Оптимизация производительности с помощью механизмов уведомления об однофазной фиксации и повышаемого однофазного присоединения](optimization-spc-and-promotable-spn.md)
- [Однофазная и многофазная фиксация транзакции](committing-a-transaction-in-single-phase-and-multi-phase.md)
