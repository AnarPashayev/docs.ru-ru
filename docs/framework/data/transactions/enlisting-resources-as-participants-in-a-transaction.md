---
title: Зачисление ресурсов в транзакцию в качестве участников
description: Прикрепление ресурсов в качестве участников транзакции .NET. Каждый ресурс в транзакции управляется диспетчером ресурсов, скоординированным диспетчером транзакций.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 786a12c2-d530-49f4-9c59-5c973e15a11d
ms.openlocfilehash: c3c777593750b3a4f05ae97ed6e26e19f58e4d72
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141879"
---
# <a name="enlisting-resources-as-participants-in-a-transaction"></a><span data-ttu-id="bb1b1-104">Зачисление ресурсов в транзакцию в качестве участников</span><span class="sxs-lookup"><span data-stu-id="bb1b1-104">Enlisting Resources as Participants in a Transaction</span></span>

<span data-ttu-id="bb1b1-105">Каждым участвующим в транзакции ресурсом управляет диспетчер ресурсов, действия которого координируются диспетчером транзакций.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-105">Each resource participating in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="bb1b1-106">Координация осуществляется посредством уведомлений, которые передаются подписчикам, зачисленным в транзакцию с помощью диспетчера транзакций.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-106">The coordination is done through notifications given to subscribers who have enlisted in a transaction through the transaction manager.</span></span>

<span data-ttu-id="bb1b1-107">В этом разделе описывается, как зачислить в транзакцию один или несколько ресурсов, и рассматриваются различные типы зачисления.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-107">This topic covers how a resource (or multiple resources) can be enlisted in a transaction, as well as the different types of enlistment.</span></span> <span data-ttu-id="bb1b1-108">В разделе [фиксация транзакции в однофазной и многофазной](committing-a-transaction-in-single-phase-and-multi-phase.md) главе описывается, как обязательства транзакций можно координировать между прикрепленными ресурсами.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-108">The [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) topic covers how transaction commitment can be coordinated among enlisted resources.</span></span>

## <a name="enlisting-resources-in-a-transaction"></a><span data-ttu-id="bb1b1-109">Зачисление ресурсов в транзакцию</span><span class="sxs-lookup"><span data-stu-id="bb1b1-109">Enlisting Resources in a Transaction</span></span>

<span data-ttu-id="bb1b1-110">Для участия в транзакции ресурс должен зачислиться в нее.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="bb1b1-111"><xref:System.Transactions.Transaction>Класс определяет набор методов, имена которых начинаются с **прикрепления** , обеспечивающих эту функциональность.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="bb1b1-112">Различные методы **прикрепления** соответствуют различным типам прикрепления, которые могут иметь диспетчер ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="bb1b1-113">В частности, методы <xref:System.Transactions.Transaction.EnlistVolatile%2A> используются для неустойчивых ресурсов, а метод <xref:System.Transactions.Transaction.EnlistDurable%2A> - для устойчивых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="bb1b1-114">Устойчивость (или наоборот, неустойчивость) диспетчера ресурсов определяет, поддерживает ли он восстановление после сбоя.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-114">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="bb1b1-115">Если диспетчер ресурсов поддерживает восстановление после сбоя, он сохраняет данные в устойчивом хранилище во время фазы 1 (подготовка); таким образом, если диспетчер ресурсов выходит из строя, он может повторно зачислиться в транзакцию после восстановления и выполнить соответствующие действия на основе уведомлений, полученных от диспетчера транзакций.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-115">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the TM.</span></span> <span data-ttu-id="bb1b1-116">В основном, диспетчеры неустойчивых ресурсов управляют неустойчивыми ресурсами, такими как структура данных, расположенная в оперативной памяти (например транзакционная хэш-таблица), а диспетчеры устойчивых ресурсов управляют устойчивыми ресурсами, которые имеют более устойчивое резервное хранилище (например, базой данных, резервным хранилищем которой является диск).</span><span class="sxs-lookup"><span data-stu-id="bb1b1-116">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>

<span data-ttu-id="bb1b1-117">После выбора используемого метода (<xref:System.Transactions.Transaction.EnlistDurable%2A> или <xref:System.Transactions.Transaction.EnlistVolatile%2A>) в зависимости от поддержки ресурсом восстановления после сбоя необходимо зачислить ресурс для участия в двухфазной фиксации путем реализации интерфейса <xref:System.Transactions.IEnlistmentNotification> для диспетчера ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-117">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="bb1b1-118">Дополнительные сведения о 2PC см. [в статье фиксация транзакции в однофазном и многофазном](committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="bb1b1-118">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>

<span data-ttu-id="bb1b1-119">Один участник может зачислиться в транзакцию с использованием более одного протокола, вызвав методы <xref:System.Transactions.Transaction.EnlistDurable%2A> и <xref:System.Transactions.Transaction.EnlistVolatile%2A> несколько раз.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-119">A single participant can enlist for more than one of these protocols by calling <xref:System.Transactions.Transaction.EnlistDurable%2A> and <xref:System.Transactions.Transaction.EnlistVolatile%2A> multiple times.</span></span>

### <a name="durable-enlistment"></a><span data-ttu-id="bb1b1-120">Зачисление устойчивых ресурсов</span><span class="sxs-lookup"><span data-stu-id="bb1b1-120">Durable Enlistment</span></span>

<span data-ttu-id="bb1b1-121">Методы <xref:System.Transactions.Transaction.EnlistDurable%2A> используются для зачисления диспетчера ресурсов в транзакцию в качестве устойчивого ресурса.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-121">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods are used to enlist a resource manager for participation in the transaction as a durable resource.</span></span>  <span data-ttu-id="bb1b1-122">Предполагается, что в случае выхода из строя в ходе транзакции диспетчер устойчивых ресурсов может выполнить восстановление после повторного зачисления (с помощью метода <xref:System.Transactions.TransactionManager.Reenlist%2A>) во все транзакции, в которых он участвовал, но в которых он не выполнил операции фазы 2, и вызвать метод <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> после завершения восстановления.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-122">It is expected that if a durable resource manager is brought down in the middle of a transaction, it can perform recovery once it is brought back online by reenlisting (using the <xref:System.Transactions.TransactionManager.Reenlist%2A> method) in all transactions in which it was a participant and did not complete phase 2, and call <xref:System.Transactions.TransactionManager.RecoveryComplete%2A> once it finishes recovery processing.</span></span> <span data-ttu-id="bb1b1-123">Дополнительные сведения о восстановлении см. в разделе [выполнение восстановления](performing-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="bb1b1-123">For more information on recovery, see [Performing Recovery](performing-recovery.md).</span></span>

<span data-ttu-id="bb1b1-124">Все методы <xref:System.Transactions.Transaction.EnlistDurable%2A> принимают в качестве первого параметра объект <xref:System.Guid>.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-124">The <xref:System.Transactions.Transaction.EnlistDurable%2A> methods all take a <xref:System.Guid> object as their first parameter.</span></span> <span data-ttu-id="bb1b1-125">Объект <xref:System.Guid> используется диспетчером транзакций для связывания зачисленного устойчивого ресурса с конкретным диспетчером ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-125">The <xref:System.Guid> is used by the transaction manager to associate a durable enlistment with a particular resource manager.</span></span> <span data-ttu-id="bb1b1-126">Поэтому крайне важно, чтобы диспетчер ресурсов согласованно использовал один и тот же объект <xref:System.Guid> для идентификации себя среди различных диспетчеров ресурсов при перезапуске, иначе может не удастся выполнить восстановление.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-126">As such, it is imperative that a resource manager consistently uses the same <xref:System.Guid> to identify itself even across different resource managers upon restarting, otherwise the recovery can fail.</span></span>

<span data-ttu-id="bb1b1-127">Второй параметр метода <xref:System.Transactions.Transaction.EnlistDurable%2A> является ссылкой на объект, реализуемый диспетчером ресурсов для получения уведомлений транзакции.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-127">The second parameter of the <xref:System.Transactions.Transaction.EnlistDurable%2A> method is a reference to the object that the resource manager implements to receive transaction notifications.</span></span> <span data-ttu-id="bb1b1-128">Используемый перегруженный метод сообщает диспетчеру транзакций, поддерживает ли диспетчер ресурсов оптимизацию однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-128">The overload you use informs the transaction manager whether your resource manager supports the Single Phase Commit (SPC) optimization.</span></span> <span data-ttu-id="bb1b1-129">В большинстве случаев требуется реализовать интерфейс <xref:System.Transactions.IEnlistmentNotification> для принятия участия в двухфазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-129">Most of the time you would implement the <xref:System.Transactions.IEnlistmentNotification> interface to take part in Two-Phase Commit (2PC).</span></span> <span data-ttu-id="bb1b1-130">Однако если требуется оптимизировать процесс фиксации, можно реализовать интерфейс <xref:System.Transactions.ISinglePhaseNotification> для однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-130">However, if you want to optimize the commit process, you can consider implementing the <xref:System.Transactions.ISinglePhaseNotification> interface for SPC.</span></span> <span data-ttu-id="bb1b1-131">Дополнительные сведения о SPC см. в статьях [фиксация транзакции в однофазном и многоэтапной](committing-a-transaction-in-single-phase-and-multi-phase.md) и оптимизация с помощью однофазного уведомления с одноэтапной [фиксацией и с возможностью продвижения](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="bb1b1-131">For more information on SPC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md) and [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

<span data-ttu-id="bb1b1-132">Третий параметр - это перечисление <xref:System.Transactions.EnlistmentOptions>, значением которого может являться <xref:System.Transactions.EnlistmentOptions.None> или <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-132">The third parameter is an <xref:System.Transactions.EnlistmentOptions> enumeration, whose value can be either <xref:System.Transactions.EnlistmentOptions.None> or <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>.</span></span> <span data-ttu-id="bb1b1-133">Если задано значение <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, при получении уведомления о подготовке от диспетчера транзакций можно зачислить дополнительные диспетчеры ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-133">If the value is set to <xref:System.Transactions.EnlistmentOptions.EnlistDuringPrepareRequired>, the enlistment may enlist additional resource managers upon receiving the Prepare notification from the transaction manager.</span></span> <span data-ttu-id="bb1b1-134">Однако следует иметь в виду, что данный тип зачисления не подходит для оптимизации однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-134">However, you should be aware that this type of enlistment is not eligible for the Single Phase Commit optimization.</span></span>

### <a name="volatile-enlistment"></a><span data-ttu-id="bb1b1-135">Зачисление неустойчивых ресурсов</span><span class="sxs-lookup"><span data-stu-id="bb1b1-135">Volatile Enlistment</span></span>

<span data-ttu-id="bb1b1-136">Участникам, управляющим неустойчивыми ресурсами, такими как кэш, необходимо зачисляться с помощью методов <xref:System.Transactions.Transaction.EnlistVolatile%2A>.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-136">Participants managing volatile resources such as a cache should enlist using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods.</span></span> <span data-ttu-id="bb1b1-137">Такие объекты могут быть неспособны получить результат транзакции или восстановить состояние какой-либо транзакции, к которой они присоединяются после сбоя.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-137">Such objects might not be able to obtain the outcome of a transaction or recover the state of any transaction they participate in after a system failure.</span></span>

<span data-ttu-id="bb1b1-138">Как уже было отмечено, диспетчер ресурсов выполняет зачисление неустойчивого ресурса, если он управляет неустойчивым ресурсом, расположенным в оперативной памяти.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-138">As stated previously, a resource manager would make a volatile enlistment if it manages an in-memory, volatile resource.</span></span> <span data-ttu-id="bb1b1-139">Одно из преимуществ использования метода <xref:System.Transactions.Transaction.EnlistVolatile%2A> заключается в том, что он не приводит к передаче транзакции на следующий уровень иерархии, если эта передача не является необходимой.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-139">One of the benefits of using <xref:System.Transactions.Transaction.EnlistVolatile%2A> is that it does not force an unnecessary escalation of the transaction.</span></span> <span data-ttu-id="bb1b1-140">Дополнительные сведения о укрупнении транзакций см. в разделе [эскалация управления транзакциями](transaction-management-escalation.md) .</span><span class="sxs-lookup"><span data-stu-id="bb1b1-140">For more information on transaction escalation, see [Transaction Management Escalation](transaction-management-escalation.md) topic.</span></span> <span data-ttu-id="bb1b1-141">Прикрепление изменчивости подразумевает и то, и другое, как зачисление обрабатывается диспетчером транзакций, а также ожидаемый диспетчером транзакций диспетчер ресурсов.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-141">Enlisting volatility implies both a difference in how the enlistment is handled by the transaction manager, as well as what is expected of the resource manager by the transaction manager.</span></span> <span data-ttu-id="bb1b1-142">Это обусловлено тем, что диспетчер неустойчивых ресурсов не выполняет восстановление.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-142">This is because a volatile resource manager does not perform recovery.</span></span> <span data-ttu-id="bb1b1-143">Методы <xref:System.Transactions.Transaction.EnlistVolatile%2A> не принимают параметр <xref:System.Guid>, поскольку диспетчер неустойчивых ресурсов не выполняет восстановление и не вызывает метод <xref:System.Transactions.TransactionManager.Reenlist%2A>, которому требуется объект <xref:System.Guid>.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-143">The <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods do not take a <xref:System.Guid> parameter, because a volatile resource manager does not perform recovery and would not call the <xref:System.Transactions.TransactionManager.Reenlist%2A> method which needs a <xref:System.Guid>.</span></span>

<span data-ttu-id="bb1b1-144">Как и в случае зачисления устойчивых ресурсов используемый для зачисления перегруженный метод указывает диспетчеру транзакций, поддерживает ли диспетчер ресурсов оптимизацию однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-144">As with durable enlistments, whichever overload method you use to enlist denotes to the transaction manager whether your resource manager supports the Single Phase Commit optimization.</span></span> <span data-ttu-id="bb1b1-145">Поскольку диспетчер неустойчивых ресурсов не может выполнять восстановление, никакие данные для восстановления не записываются для зачисленного неустойчивого ресурса во время фазы подготовки.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-145">Since a volatile resource manager cannot perform recovery, no recovery information is written for a volatile enlistment during the Prepare phase.</span></span> <span data-ttu-id="bb1b1-146">Таким образом, при вызове метода <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> возникает исключение <xref:System.InvalidOperationException>.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-146">Therefore, calling the <xref:System.Transactions.PreparingEnlistment.RecoveryInformation%2A> method results in an <xref:System.InvalidOperationException>.</span></span>

<span data-ttu-id="bb1b1-147">В следующем примере показано, как с помощью метода <xref:System.Transactions.Transaction.EnlistVolatile%2A> зачислить объект в транзакцию в качестве участника.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-147">The following example shows how to enlist such an object as a participant in a transaction using the <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span>

[!code-csharp[Tx_Enlist#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/tx_enlist/cs/enlist.cs#1)]
[!code-vb[Tx_Enlist#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/tx_enlist/vb/enlist.vb#1)]

### <a name="optimizing-performance"></a><span data-ttu-id="bb1b1-148">Оптимизация производительности</span><span class="sxs-lookup"><span data-stu-id="bb1b1-148">Optimizing Performance</span></span>

<span data-ttu-id="bb1b1-149">Класс <xref:System.Transactions.Transaction> также предоставляет метод <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> для PSPE-зачисления.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-149">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="bb1b1-150">Это позволяет диспетчеру устойчивых ресурсов "владеть" и управлять транзакцией, которая затем при необходимости может быть повышена до транзакции MSDTC.</span><span class="sxs-lookup"><span data-stu-id="bb1b1-150">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="bb1b1-151">Дополнительные сведения об этом см. в статье [Оптимизация с помощью однофазного уведомления о фиксации и продвижения с одним этапом](optimization-spc-and-promotable-spn.md).</span><span class="sxs-lookup"><span data-stu-id="bb1b1-151">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="bb1b1-152">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="bb1b1-152">See also</span></span>

- [<span data-ttu-id="bb1b1-153">Оптимизация производительности с помощью механизмов уведомления об однофазной фиксации и повышаемого однофазного присоединения</span><span class="sxs-lookup"><span data-stu-id="bb1b1-153">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)
- [<span data-ttu-id="bb1b1-154">Однофазная и многофазная фиксация транзакции</span><span class="sxs-lookup"><span data-stu-id="bb1b1-154">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
