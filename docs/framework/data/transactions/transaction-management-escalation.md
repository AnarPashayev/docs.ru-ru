---
title: Передача управления транзакцией на следующий уровень иерархии
ms.date: 03/30/2017
ms.assetid: 1e96331e-31b6-4272-bbbd-29ed1e110460
ms.openlocfilehash: d2f027f8a94ee8f0cd23d0f0909ecc9137873bc2
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205842"
---
# <a name="transaction-management-escalation"></a>Передача управления транзакцией на следующий уровень иерархии
В ОС Windows реализован набор служб и модулей, которые составляют диспетчер транзакций. В данном разделе описывается процесс переноса транзакции из одного компонента диспетчера транзакций в другой.  
  
 <xref:System.Transactions>включает компонент диспетчера транзакций, который координирует транзакцию, включающую не более одного устойчивого ресурса или нескольких временных ресурсов. Поскольку диспетчер транзакций использует только вызовы внутри домена приложения, он обеспечивает оптимальную производительность. Разработчикам не требуется взаимодействовать с диспетчером транзакций напрямую. Эту задачу выполняет предоставляемая пространством имен <xref:System.Transactions> общая инфраструктура, которая определяет интерфейсы, распространенное поведение и вспомогательные классы.  
  
 Если требуется предоставить транзакцию объекту в другом домене приложения (включая границы процессов и компьютеров) на том же компьютере, <xref:System.Transactions> инфраструктура автоматически передает транзакцию, управляемую Майкрософт Координатор распределенных транзакций (MSDTC). Передача также происходит при зачислении другого диспетчера устойчивых ресурсов. После передачи транзакции на следующий уровень иерархии управление транзакцией осуществляется на этом уровне до ее завершения.  
  
 Помимо транзакций <xref:System.Transactions> и транзакций MSDTC существуют транзакции промежуточного типа, предоставляемые механизмом повышаемого однофазного зачисления (PSPE). PSPE является еще одним важным механизмом в инфраструктуре <xref:System.Transactions>, предназначенным для оптимизации производительности. Он позволяет удаленному устойчивому ресурсу, расположенному в другом домене приложения, процессе или компьютере, участвовать в транзакции <xref:System.Transactions>, не вызывая ее повышения до транзакции MSDTC. Дополнительные сведения о ПСПЕ см. [в разделе прикрепление ресурсов в качестве участников транзакции](enlisting-resources-as-participants-in-a-transaction.md).  
  
## <a name="how-escalation-is-initiated"></a>Порядок передачи транзакции на следующий уровень иерархии  
 Передача транзакции на следующий уровень иерархии приводит к снижению производительности, поскольку координатор MSDTC находится в отдельном процессе и при передаче транзакции координатору MSDTC необходима отправка сообщений за границы исходного процесса. Чтобы повысить производительность, следует отложить или избежать эскалации для MSDTC; Таким способом, необходимо знать, как и когда инициируется укрупнение.  
  
 Пока инфраструктура <xref:System.Transactions> работает с неустойчивыми ресурсами и по крайней мере с одним устойчивым ресурсом, поддерживающим уведомления об однофазной фиксации, транзакция принадлежит инфраструктуре <xref:System.Transactions>. Диспетчер транзакций предоставляется только ресурсам, которые находятся в одном с ним домене приложения и для которых не требуется ведение журнала (запись результата транзакции на диск). Передача транзакции на следующий уровень иерархии, в результате которой инфраструктура <xref:System.Transactions> передает право владения транзакцией координатору MSDTC, выполняется в следующих случаях.  
  
- В транзакцию зачислен по крайней мере один устойчивый ресурс, не поддерживающий уведомления об однофазной фиксации.  
  
- В транзакцию зачислено по крайней мере два устойчивых ресурса, поддерживающих уведомления об однофазной фиксации. Например, прикрепление одного соединения с SQL Server 2005 не приводит к повышению уровня транзакции. Однако при открытии второго подключения к базе данных SQL Server 2005, в результате которой база данных будет прикреплена, <xref:System.Transactions> Инфраструктура обнаруживает, что это второй устойчивый ресурс в транзакции, и передает его в транзакцию MSDTC.  
  
- Инициирован запрос на "маршалирование" транзакции в другой домен приложения или процесс. Например, требуется сериализация объекта транзакции за границей домена приложения. Объект транзакции маршалируется по значению; это означает, что любая попытка передать его за границу домена приложения (даже в том же самом процессе) приводит к сериализации объекта транзакции. Чтобы передать объект транзакции можно вызвать удаленный метод, который принимает в качестве параметра объект <xref:System.Transactions.Transaction>, или предпринять попытку доступа к удаленному компоненту обслуживания транзакций. При этом объект транзакции будет сериализован, что приведет к передаче транзакции на следующий уровень иерархии, как в случае сериализации транзакции за границей домена приложения. Транзакция становится распределенной, и локальный диспетчер транзакций перестает за нее отвечать.  
  
 В следующей таблице перечислены все возможные исключения, которые могут возникнуть при передаче транзакции на следующий уровень иерархии.  
  
|Тип исключения|Условие|  
|--------------------|---------------|  
|<xref:System.InvalidOperationException>|Попытка повысить транзакцию с уровнем изоляции <xref:System.Transactions.IsolationLevel.Snapshot>.|  
|<xref:System.Transactions.TransactionAbortedException>|Выход диспетчера транзакций из строя.|  
|<xref:System.Transactions.TransactionException>|Сбой при передаче транзакции на следующий уровень иерархии и прерывание работы приложения.|
