---
title: Передача управления транзакцией на следующий уровень иерархии
ms.date: 03/30/2017
ms.assetid: 1e96331e-31b6-4272-bbbd-29ed1e110460
ms.openlocfilehash: 1e40244e1f6b5ffd7b52584a5da121d1203f8376
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64630568"
---
# <a name="transaction-management-escalation"></a><span data-ttu-id="4d64f-102">Передача управления транзакцией на следующий уровень иерархии</span><span class="sxs-lookup"><span data-stu-id="4d64f-102">Transaction Management Escalation</span></span>
<span data-ttu-id="4d64f-103">В ОС Windows реализован набор служб и модулей, которые составляют диспетчер транзакций.</span><span class="sxs-lookup"><span data-stu-id="4d64f-103">Windows hosts a set of services and modules that together constitute a transaction manager.</span></span> <span data-ttu-id="4d64f-104">В данном разделе описывается процесс переноса транзакции из одного компонента диспетчера транзакций в другой.</span><span class="sxs-lookup"><span data-stu-id="4d64f-104">Transaction management escalation describes the process of migrating a transaction from one of the transaction manager's components to another.</span></span>  
  
 <span data-ttu-id="4d64f-105"><xref:System.Transactions> включает диспетчер транзакций, осуществляющий координацию транзакций, которые охватывают по крайней мере, один устойчивый ресурс или несколько неустойчивых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="4d64f-105"><xref:System.Transactions> includes a transaction manager component that coordinates a transaction involving at most, a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="4d64f-106">Поскольку диспетчер транзакций использует только вызовы внутри домена приложения, он обеспечивает оптимальную производительность.</span><span class="sxs-lookup"><span data-stu-id="4d64f-106">Because the transaction manager uses only intra-application domain calls, it yields the best performance.</span></span> <span data-ttu-id="4d64f-107">Разработчикам не требуется взаимодействовать с диспетчером транзакций напрямую.</span><span class="sxs-lookup"><span data-stu-id="4d64f-107">Developers need not interact with the transaction manager directly.</span></span> <span data-ttu-id="4d64f-108">Эту задачу выполняет предоставляемая пространством имен <xref:System.Transactions> общая инфраструктура, которая определяет интерфейсы, распространенное поведение и вспомогательные классы.</span><span class="sxs-lookup"><span data-stu-id="4d64f-108">Instead, a common infrastructure that defines interfaces, common behavior, and helper classes is provided by the <xref:System.Transactions> namespace.</span></span>  
  
 <span data-ttu-id="4d64f-109">Если вы хотите предоставить транзакцию на объект в другом домене приложения (также в другом процессе или компьютере) на одном компьютере, <xref:System.Transactions> инфраструктура автоматически передает управление транзакцией осуществляется посредством Microsoft Координатор распределенных транзакций (Майкрософт) (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="4d64f-109">When you want to provide the transaction to an object in another application domain (including across process and machine boundaries) on the same computer, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="4d64f-110">Передача также происходит при зачислении другого диспетчера устойчивых ресурсов.</span><span class="sxs-lookup"><span data-stu-id="4d64f-110">The escalation also occurs if you enlist another durable resource manager.</span></span> <span data-ttu-id="4d64f-111">После передачи транзакции на следующий уровень иерархии управление транзакцией осуществляется на этом уровне до ее завершения.</span><span class="sxs-lookup"><span data-stu-id="4d64f-111">When escalated, the transaction remains managed in its elevated state until its completion.</span></span>  
  
 <span data-ttu-id="4d64f-112">Помимо транзакций <xref:System.Transactions> и транзакций MSDTC существуют транзакции промежуточного типа, предоставляемые механизмом повышаемого однофазного зачисления (PSPE).</span><span class="sxs-lookup"><span data-stu-id="4d64f-112">Between the <xref:System.Transactions> transaction and MSDTC transaction, there is an intermediary type of transaction that is made available through the Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="4d64f-113">PSPE является еще одним важным механизмом в инфраструктуре <xref:System.Transactions>, предназначенным для оптимизации производительности.</span><span class="sxs-lookup"><span data-stu-id="4d64f-113">PSPE is another important mechanism in <xref:System.Transactions> for performance optimization.</span></span> <span data-ttu-id="4d64f-114">Он позволяет удаленному устойчивому ресурсу, расположенному в другом домене приложения, процессе или компьютере, участвовать в транзакции <xref:System.Transactions>, не вызывая ее повышения до транзакции MSDTC.</span><span class="sxs-lookup"><span data-stu-id="4d64f-114">It allows a remote durable resource, located in a different application domain, process or computer, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="4d64f-115">Дополнительные сведения о PSPE см. в разделе [ресурсы прикрепление в транзакции, в качестве участников](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="4d64f-115">For more information about PSPE, see [Enlisting Resources as Participants in a Transaction](../../../../docs/framework/data/transactions/enlisting-resources-as-participants-in-a-transaction.md).</span></span>  
  
## <a name="how-escalation-is-initiated"></a><span data-ttu-id="4d64f-116">Порядок передачи транзакции на следующий уровень иерархии</span><span class="sxs-lookup"><span data-stu-id="4d64f-116">How Escalation is Initiated</span></span>  
 <span data-ttu-id="4d64f-117">Передача транзакции на следующий уровень иерархии приводит к снижению производительности, поскольку координатор MSDTC находится в отдельном процессе и при передаче транзакции координатору MSDTC необходима отправка сообщений за границы исходного процесса.</span><span class="sxs-lookup"><span data-stu-id="4d64f-117">Transaction escalation reduces performance because the MSDTC resides in a separate process, and escalating a transaction to the MSDTC results in messages being sent across process.</span></span> <span data-ttu-id="4d64f-118">Для повышения производительности следует отложить или избежать укрупнения к координатору MS DTC; Таким образом необходимо знать, как и когда инициируется укрупнения.</span><span class="sxs-lookup"><span data-stu-id="4d64f-118">To improve performance, you should delay or avoid escalation to MSDTC; thus, you need to know how and when the escalation is initiated.</span></span>  
  
 <span data-ttu-id="4d64f-119">Пока инфраструктура <xref:System.Transactions> работает с неустойчивыми ресурсами и по крайней мере с одним устойчивым ресурсом, поддерживающим уведомления об однофазной фиксации, транзакция принадлежит инфраструктуре <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="4d64f-119">As long as the <xref:System.Transactions> infrastructure handles volatile resources and at most one durable resource that supports single-phase notifications, the transaction remains in the ownership of the <xref:System.Transactions> infrastructure.</span></span> <span data-ttu-id="4d64f-120">Диспетчер транзакций предоставляется только ресурсам, которые находятся в одном с ним домене приложения и для которых не требуется ведение журнала (запись результата транзакции на диск).</span><span class="sxs-lookup"><span data-stu-id="4d64f-120">The transaction manager avails itself only to those resources that live in the same application domain and for which logging (writing the transaction outcome to disk) is not required.</span></span> <span data-ttu-id="4d64f-121">Передача транзакции на следующий уровень иерархии, в результате которой инфраструктура <xref:System.Transactions> передает право владения транзакцией координатору MSDTC, выполняется в следующих случаях.</span><span class="sxs-lookup"><span data-stu-id="4d64f-121">An escalation that results in the <xref:System.Transactions> infrastructure transferring the ownership of the transaction to MSDTC happens when:</span></span>  
  
- <span data-ttu-id="4d64f-122">В транзакцию зачислен по крайней мере один устойчивый ресурс, не поддерживающий уведомления об однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="4d64f-122">At least one durable resource that does not support single-phase notifications is enlisted in the transaction.</span></span>  
  
- <span data-ttu-id="4d64f-123">В транзакцию зачислено по крайней мере два устойчивых ресурса, поддерживающих уведомления об однофазной фиксации.</span><span class="sxs-lookup"><span data-stu-id="4d64f-123">At least two durable resources that support single-phase notifications are enlisted in the transaction.</span></span> <span data-ttu-id="4d64f-124">Например, зачисление одного соединения с базой данных [!INCLUDE[sqprsqlong](../../../../includes/sqprsqlong-md.md)] не приводит к повышению транзакции.</span><span class="sxs-lookup"><span data-stu-id="4d64f-124">For example, enlisting a single connection with [!INCLUDE[sqprsqlong](../../../../includes/sqprsqlong-md.md)] does not cause a transaction to be promoted.</span></span> <span data-ttu-id="4d64f-125">Однако если открыть второе соединение с базой данных [!INCLUDE[sqprsqlong](../../../../includes/sqprsqlong-md.md)], в результате чего она будет зачислена в транзакцию, инфраструктура <xref:System.Transactions> определит эту базу данных как второй устойчивый ресурс и повысит транзакцию до транзакции MSDTC.</span><span class="sxs-lookup"><span data-stu-id="4d64f-125">However, whenever you open a second connection to a [!INCLUDE[sqprsqlong](../../../../includes/sqprsqlong-md.md)] database causing the database to enlist, the <xref:System.Transactions> infrastructure detects that it is the second durable resource in the transaction, and escalates it to an MSDTC transaction.</span></span>  
  
- <span data-ttu-id="4d64f-126">Инициирован запрос на "маршалирование" транзакции в другой домен приложения или процесс.</span><span class="sxs-lookup"><span data-stu-id="4d64f-126">A request to "marshal" the transaction to a different application domain or different process is invoked.</span></span> <span data-ttu-id="4d64f-127">Например, требуется сериализация объекта транзакции за границей домена приложения.</span><span class="sxs-lookup"><span data-stu-id="4d64f-127">For example, the serialization of the transaction object across an application domain boundary.</span></span> <span data-ttu-id="4d64f-128">Объект транзакции маршалируется по значению; это означает, что любая попытка передать его за границу домена приложения (даже в том же самом процессе) приводит к сериализации объекта транзакции.</span><span class="sxs-lookup"><span data-stu-id="4d64f-128">The transaction object is marshaled-by-value, meaning that any attempt to pass it across an application domain boundary (even in the same process) results in serialization of the transaction object.</span></span> <span data-ttu-id="4d64f-129">Чтобы передать объект транзакции можно вызвать удаленный метод, который принимает в качестве параметра объект <xref:System.Transactions.Transaction>, или предпринять попытку доступа к удаленному компоненту обслуживания транзакций.</span><span class="sxs-lookup"><span data-stu-id="4d64f-129">You can pass the transaction objects by making a call on a remote method that takes a <xref:System.Transactions.Transaction> as a parameter or you can try to access a remote transactional-serviced component.</span></span> <span data-ttu-id="4d64f-130">При этом объект транзакции будет сериализован, что приведет к передаче транзакции на следующий уровень иерархии, как в случае сериализации транзакции за границей домена приложения.</span><span class="sxs-lookup"><span data-stu-id="4d64f-130">This serializes the transaction object and results in an escalation, as when a transaction is serialized across an application domain.</span></span> <span data-ttu-id="4d64f-131">Транзакция становится распределенной, и локальный диспетчер транзакций перестает за нее отвечать.</span><span class="sxs-lookup"><span data-stu-id="4d64f-131">It is being distributed and the local transaction manager is no longer adequate.</span></span>  
  
 <span data-ttu-id="4d64f-132">В следующей таблице перечислены все возможные исключения, которые могут возникнуть при передаче транзакции на следующий уровень иерархии.</span><span class="sxs-lookup"><span data-stu-id="4d64f-132">The following table lists all the possible exceptions that can be thrown during escalation.</span></span>  
  
|<span data-ttu-id="4d64f-133">Тип исключения</span><span class="sxs-lookup"><span data-stu-id="4d64f-133">Exception type</span></span>|<span data-ttu-id="4d64f-134">Условие</span><span class="sxs-lookup"><span data-stu-id="4d64f-134">Condition</span></span>|  
|--------------------|---------------|  
|<xref:System.InvalidOperationException>|<span data-ttu-id="4d64f-135">Попытка повысить транзакцию с уровнем изоляции <xref:System.Transactions.IsolationLevel.Snapshot>.</span><span class="sxs-lookup"><span data-stu-id="4d64f-135">An attempt to escalate a transaction with isolation level equal to <xref:System.Transactions.IsolationLevel.Snapshot>.</span></span>|  
|<xref:System.Transactions.TransactionAbortedException>|<span data-ttu-id="4d64f-136">Выход диспетчера транзакций из строя.</span><span class="sxs-lookup"><span data-stu-id="4d64f-136">The transaction manager is down.</span></span>|  
|<xref:System.Transactions.TransactionException>|<span data-ttu-id="4d64f-137">Сбой при передаче транзакции на следующий уровень иерархии и прерывание работы приложения.</span><span class="sxs-lookup"><span data-stu-id="4d64f-137">The escalation fails and the application is aborted.</span></span>|
