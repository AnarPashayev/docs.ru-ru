---
title: Включение нескольких активных результирующих наборов
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 576079e4-debe-4ab5-9204-fcbe2ca7a5e2
ms.openlocfilehash: 72125be835298218e5445fe1915d6a17f5008bb2
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79148729"
---
# <a name="enabling-multiple-active-result-sets"></a><span data-ttu-id="c511f-102">Включение нескольких активных результирующих наборов</span><span class="sxs-lookup"><span data-stu-id="c511f-102">Enabling Multiple Active Result Sets</span></span>
<span data-ttu-id="c511f-103">Режим MARS — это новая функция, которая в SQL Server используется для выполнения нескольких пакетов по одному соединению.</span><span class="sxs-lookup"><span data-stu-id="c511f-103">Multiple Active Result Sets (MARS) is a feature that works with SQL Server to allow the execution of multiple batches on a single connection.</span></span> <span data-ttu-id="c511f-104">Когда для работы с SQL Server включен режим MARS, каждый используемый объект команды добавляет сеанс к соединению.</span><span class="sxs-lookup"><span data-stu-id="c511f-104">When MARS is enabled for use with SQL Server, each command object used adds a session to the connection.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c511f-105">Один сеанс режима MARS открывает одно логическое подключение для использования самим режимом MARS, а затем — по одному логическому подключению для каждой активной команды.</span><span class="sxs-lookup"><span data-stu-id="c511f-105">A single MARS session opens one logical connection for MARS to use and then one logical connection for each active command.</span></span>  
  
## <a name="enabling-and-disabling-mars-in-the-connection-string"></a><span data-ttu-id="c511f-106">Включение и отключение режима MARS в строке соединения</span><span class="sxs-lookup"><span data-stu-id="c511f-106">Enabling and Disabling MARS in the Connection String</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c511f-107">В следующей строке подключения используется образец базы данных **AdventureWorks**, входящий в состав SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c511f-107">The following connection strings use the sample **AdventureWorks** database included with SQL Server.</span></span> <span data-ttu-id="c511f-108">Приведенные здесь строки подключения предполагают, что база данных установлена на сервере MSSQL1.</span><span class="sxs-lookup"><span data-stu-id="c511f-108">The connection strings provided assume that the database is installed on a server named MSSQL1.</span></span> <span data-ttu-id="c511f-109">При необходимости измените строку подключения для вашей среды.</span><span class="sxs-lookup"><span data-stu-id="c511f-109">Modify the connection string as necessary for your environment.</span></span>  
  
 <span data-ttu-id="c511f-110">Эта функция по умолчанию отключена.</span><span class="sxs-lookup"><span data-stu-id="c511f-110">The MARS feature is disabled by default.</span></span> <span data-ttu-id="c511f-111">Ее можно включить, добавив пару ключевых слов MultipleActiveResultSets=True в строку подключения.</span><span class="sxs-lookup"><span data-stu-id="c511f-111">It can be enabled by adding the "MultipleActiveResultSets=True" keyword pair to your connection string.</span></span> <span data-ttu-id="c511f-112">"True" — единственное допустимое значение для включения режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-112">"True" is the only valid value for enabling MARS.</span></span> <span data-ttu-id="c511f-113">В следующем примере демонстрируется, как подключиться к экземпляру SQL Server, а также как указать, что режим MARS должен быть включен.</span><span class="sxs-lookup"><span data-stu-id="c511f-113">The following example demonstrates how to connect to an instance of SQL Server and how to specify that MARS should be enabled.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=True"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=True";  
```  
  
 <span data-ttu-id="c511f-114">Отключить режим MARS можно, добавив в строку подключения ключевое слово MultipleActiveResultSets=False.</span><span class="sxs-lookup"><span data-stu-id="c511f-114">You can disable MARS by adding the "MultipleActiveResultSets=False" keyword pair to your connection string.</span></span> <span data-ttu-id="c511f-115">"False" — единственное допустимое значение для отключения режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-115">"False" is the only valid value for disabling MARS.</span></span> <span data-ttu-id="c511f-116">В следующей строке подключения показано, как отключить режим MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-116">The following connection string demonstrates how to disable MARS.</span></span>  
  
```vb  
Dim connectionString As String = "Data Source=MSSQL1;" & _  
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" & _  
    "MultipleActiveResultSets=False"  
```  
  
```csharp  
string connectionString = "Data Source=MSSQL1;" +
    "Initial Catalog=AdventureWorks;Integrated Security=SSPI;" +  
    "MultipleActiveResultSets=False";  
```  
  
## <a name="special-considerations-when-using-mars"></a><span data-ttu-id="c511f-117">Особые рассуждения об использовании режима MARS</span><span class="sxs-lookup"><span data-stu-id="c511f-117">Special Considerations When Using MARS</span></span>  
 <span data-ttu-id="c511f-118">Как правило, для использования подключения с включенным режимом MARS не требуется изменять существующие приложения.</span><span class="sxs-lookup"><span data-stu-id="c511f-118">In general, existing applications should not need modification to use a MARS-enabled connection.</span></span> <span data-ttu-id="c511f-119">Тем не менее, если вы хотите использовать функции MARS в приложениях, следует учитывать следующие особенности.</span><span class="sxs-lookup"><span data-stu-id="c511f-119">However, if you wish to use MARS features in your applications, you should understand the following special considerations.</span></span>  
  
### <a name="statement-interleaving"></a><span data-ttu-id="c511f-120">Чередование инструкций</span><span class="sxs-lookup"><span data-stu-id="c511f-120">Statement Interleaving</span></span>  
 <span data-ttu-id="c511f-121">Операции режима MARS выполняются синхронно на сервере.</span><span class="sxs-lookup"><span data-stu-id="c511f-121">MARS operations execute synchronously on the server.</span></span> <span data-ttu-id="c511f-122">Допускается чередование инструкций SELECT и BULK INSERT.</span><span class="sxs-lookup"><span data-stu-id="c511f-122">Statement interleaving of SELECT and BULK INSERT statements is allowed.</span></span> <span data-ttu-id="c511f-123">Тем не менее, инструкции языка обработки данных DML и языка описания данных DDL выполняются атомарно.</span><span class="sxs-lookup"><span data-stu-id="c511f-123">However, data manipulation language (DML) and data definition language (DDL) statements execute atomically.</span></span> <span data-ttu-id="c511f-124">Попытка выполнения любых инструкций во время выполнения атомарного пакета блокируется.</span><span class="sxs-lookup"><span data-stu-id="c511f-124">Any statements attempting to execute while an atomic batch is executing are blocked.</span></span> <span data-ttu-id="c511f-125">Параллельное выполнение на сервере не является функцией режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-125">Parallel execution at the server is not a MARS feature.</span></span>  
  
 <span data-ttu-id="c511f-126">Если в рамках подключения режима MARS отправляются два пакета (один с инструкцией SELECT, другой с инструкцией DML), выполнение инструкции DML может начаться во время выполнения инструкции SELECT.</span><span class="sxs-lookup"><span data-stu-id="c511f-126">If two batches are submitted under a MARS connection, one of them containing a SELECT statement, the other containing a DML statement, the DML can begin execution within execution of the SELECT statement.</span></span> <span data-ttu-id="c511f-127">Тем не менее, выполнение инструкции SELECT можно продолжить только после полного выполнения инструкции DML.</span><span class="sxs-lookup"><span data-stu-id="c511f-127">However, the DML statement must run to completion before the SELECT statement can make progress.</span></span> <span data-ttu-id="c511f-128">Если обе инструкции выполняются в рамках одной транзакции, любые изменения, внесенные инструкцией DML после начала выполнения инструкции SELECT, являются невидимыми для операции чтения.</span><span class="sxs-lookup"><span data-stu-id="c511f-128">If both statements are running under the same transaction, any changes made by a DML statement after the SELECT statement has started execution are not visible to the read operation.</span></span>  
  
 <span data-ttu-id="c511f-129">Инструкция WAITFOR внутри инструкции SELECT не выдает транзакцию во время ожидания, то есть пока не будет сформирована первая строка.</span><span class="sxs-lookup"><span data-stu-id="c511f-129">A WAITFOR statement inside a SELECT statement does not yield the transaction while it is waiting, that is, until the first row is produced.</span></span> <span data-ttu-id="c511f-130">Это означает, что пока инструкция WAITFOR ждет, другие пакеты не могут выполняться в рамках одного подключения.</span><span class="sxs-lookup"><span data-stu-id="c511f-130">This implies that no other batches can execute within the same connection while a WAITFOR statement is waiting.</span></span>  
  
### <a name="mars-session-cache"></a><span data-ttu-id="c511f-131">Кэш сеанса режима MARS</span><span class="sxs-lookup"><span data-stu-id="c511f-131">MARS Session Cache</span></span>  
 <span data-ttu-id="c511f-132">При открытии подключения с включенным режимом MARS создается логический сеанс, что требует дополнительных затрат.</span><span class="sxs-lookup"><span data-stu-id="c511f-132">When a connection is opened with MARS enabled, a logical session is created, which adds additional overhead.</span></span> <span data-ttu-id="c511f-133">Чтобы свести к минимуму затраты и повысить производительность, **SqlClient** кэширует сеанс режима MARS в рамках соединения.</span><span class="sxs-lookup"><span data-stu-id="c511f-133">To minimize overhead and enhance performance, **SqlClient** caches the MARS session within a connection.</span></span> <span data-ttu-id="c511f-134">Кэш может содержать максимум 10 сеансов режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-134">The cache contains at most 10 MARS sessions.</span></span> <span data-ttu-id="c511f-135">Это значение не может быть изменено пользователем.</span><span class="sxs-lookup"><span data-stu-id="c511f-135">This value is not user adjustable.</span></span> <span data-ttu-id="c511f-136">При достижении лимита сеансов создается новый сеанс — ошибка не формируется.</span><span class="sxs-lookup"><span data-stu-id="c511f-136">If the session limit is reached, a new session is created—an error is not generated.</span></span> <span data-ttu-id="c511f-137">Сам кэш и содержащиеся в нем сеансы принадлежат одному подключению. Они не могут использоваться в нескольких подключениях.</span><span class="sxs-lookup"><span data-stu-id="c511f-137">The cache and sessions contained in it are per-connection; they are not shared across connections.</span></span> <span data-ttu-id="c511f-138">Когда сеанс освобождается, он возвращается в пул, если только не был достигнут верхний предел пула.</span><span class="sxs-lookup"><span data-stu-id="c511f-138">When a session is released, it is returned to the pool unless the pool's upper limit has been reached.</span></span> <span data-ttu-id="c511f-139">Если пул кэша заполнен, то сеанс закрывается.</span><span class="sxs-lookup"><span data-stu-id="c511f-139">If the cache pool is full, the session is closed.</span></span> <span data-ttu-id="c511f-140">Сеансы режима MARS не имеют истекающего срока действия.</span><span class="sxs-lookup"><span data-stu-id="c511f-140">MARS sessions do not expire.</span></span> <span data-ttu-id="c511f-141">Они очищаются только при удалении объекта подключения.</span><span class="sxs-lookup"><span data-stu-id="c511f-141">They are only cleaned up when the connection object is disposed.</span></span> <span data-ttu-id="c511f-142">Кэш сеансов режима MARS предварительно не загружается.</span><span class="sxs-lookup"><span data-stu-id="c511f-142">The MARS session cache is not preloaded.</span></span> <span data-ttu-id="c511f-143">Он загружается, когда приложению требуется больше сеансов.</span><span class="sxs-lookup"><span data-stu-id="c511f-143">It is loaded as the application requires more sessions.</span></span>  
  
### <a name="thread-safety"></a><span data-ttu-id="c511f-144">Многопоточное использование</span><span class="sxs-lookup"><span data-stu-id="c511f-144">Thread Safety</span></span>  
 <span data-ttu-id="c511f-145">Операции режима MARS не обеспечивают безопасность потока.</span><span class="sxs-lookup"><span data-stu-id="c511f-145">MARS operations are not thread-safe.</span></span>  
  
### <a name="connection-pooling"></a><span data-ttu-id="c511f-146">Организация пулов соединений</span><span class="sxs-lookup"><span data-stu-id="c511f-146">Connection Pooling</span></span>  
 <span data-ttu-id="c511f-147">Как и любые другие подключения, подключения, для которых включен режим MARS, упорядочиваются в пулы.</span><span class="sxs-lookup"><span data-stu-id="c511f-147">MARS-enabled connections are pooled like any other connection.</span></span> <span data-ttu-id="c511f-148">Если приложение открывает два подключения (одно с включенным режимом MARS и другое, для которого режим MARS отключен), эти два подключения помещаются в отдельные пулы.</span><span class="sxs-lookup"><span data-stu-id="c511f-148">If an application opens two connections, one with MARS enabled and one with MARS disabled, the two connections are in separate pools.</span></span> <span data-ttu-id="c511f-149">Дополнительные сведения см. в разделе [Объединение подключений в пул в SQL Server (ADO.NET)](../sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="c511f-149">For more information, see [SQL Server Connection Pooling (ADO.NET)](../sql-server-connection-pooling.md).</span></span>  
  
### <a name="sql-server-batch-execution-environment"></a><span data-ttu-id="c511f-150">Среда выполнения пакетов SQL Server</span><span class="sxs-lookup"><span data-stu-id="c511f-150">SQL Server Batch Execution Environment</span></span>  
 <span data-ttu-id="c511f-151">При открытии подключения определяется среда по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c511f-151">When a connection is opened, a default environment is defined.</span></span> <span data-ttu-id="c511f-152">Затем эта среда копируется в логический сеанс режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-152">This environment is then copied into a logical MARS session.</span></span>  
  
 <span data-ttu-id="c511f-153">Среда пакетного выполнения состоит из следующих компонентов:</span><span class="sxs-lookup"><span data-stu-id="c511f-153">The batch execution environment includes the following components:</span></span>  
  
- <span data-ttu-id="c511f-154">заданных параметров (например, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE);</span><span class="sxs-lookup"><span data-stu-id="c511f-154">Set options (for example, ANSI_NULLS, DATE_FORMAT, LANGUAGE, TEXTSIZE)</span></span>  
  
- <span data-ttu-id="c511f-155">контекста безопасности (роль пользователя/приложения);</span><span class="sxs-lookup"><span data-stu-id="c511f-155">Security context (user/application role)</span></span>  
  
- <span data-ttu-id="c511f-156">контекста базы данных (текущая база данных);</span><span class="sxs-lookup"><span data-stu-id="c511f-156">Database context (current database)</span></span>  
  
- <span data-ttu-id="c511f-157">переменных состояния выполнения (@@ERROR, @@ROWCOUNT, @@FETCH_STATUS и @@IDENTITY);</span><span class="sxs-lookup"><span data-stu-id="c511f-157">Execution state variables (for example, @@ERROR, @@ROWCOUNT, @@FETCH_STATUS @@IDENTITY)</span></span>  
  
- <span data-ttu-id="c511f-158">Временные таблицы верхнего уровня</span><span class="sxs-lookup"><span data-stu-id="c511f-158">Top-level temporary tables</span></span>  
  
 <span data-ttu-id="c511f-159">При работе в режиме MARS среда выполнения по умолчанию ассоциируется с подключением.</span><span class="sxs-lookup"><span data-stu-id="c511f-159">With MARS, a default execution environment is associated to a connection.</span></span> <span data-ttu-id="c511f-160">Каждый новый пакет, выполняемый для конкретного соединения, получает копию среды по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c511f-160">Every new batch that starts executing under a given connection receives a copy of the default environment.</span></span> <span data-ttu-id="c511f-161">Всякий раз при выполнении кода все изменения в среде выполнения применяются к данному конкретному пакету.</span><span class="sxs-lookup"><span data-stu-id="c511f-161">Whenever code is executed under a given batch, all changes made to the environment are scoped to the specific batch.</span></span> <span data-ttu-id="c511f-162">Как только выполнение завершается, настройки выполнения копируются в среду по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="c511f-162">Once execution finishes, the execution settings are copied into the default environment.</span></span> <span data-ttu-id="c511f-163">Если один пакет выдает несколько команд для последовательного выполнения в рамках одной транзакции, семантика такая же, как и при подключениях прошлых клиентов или серверов.</span><span class="sxs-lookup"><span data-stu-id="c511f-163">In the case of a single batch issuing several commands to be executed sequentially under the same transaction, semantics are the same as those exposed by connections involving earlier clients or servers.</span></span>  
  
### <a name="parallel-execution"></a><span data-ttu-id="c511f-164">Параллельное выполнение</span><span class="sxs-lookup"><span data-stu-id="c511f-164">Parallel Execution</span></span>  
 <span data-ttu-id="c511f-165">Режим MARS не предназначен для использования во всех ситуациях, когда приложению требуется несколько подключений.</span><span class="sxs-lookup"><span data-stu-id="c511f-165">MARS is not designed to remove all requirements for multiple connections in an application.</span></span> <span data-ttu-id="c511f-166">Если приложению требуется настоящее параллельное выполнение команд для сервера, следует использовать несколько подключений.</span><span class="sxs-lookup"><span data-stu-id="c511f-166">If an application needs true parallel execution of commands against a server, multiple connections should be used.</span></span>  
  
 <span data-ttu-id="c511f-167">Давайте рассмотрим следующий пример.</span><span class="sxs-lookup"><span data-stu-id="c511f-167">For example, consider the following scenario.</span></span> <span data-ttu-id="c511f-168">Создаются два объекта команд, один для обработки результирующего набора, а другой для обновления данных. Они используют одно подключение с режимом MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-168">Two command objects are created, one for processing a result set and another for updating data; they share a common connection via MARS.</span></span> <span data-ttu-id="c511f-169">В этом сценарии `Transaction`.`Commit`</span><span class="sxs-lookup"><span data-stu-id="c511f-169">In this scenario, the `Transaction`.`Commit`</span></span> <span data-ttu-id="c511f-170">не сможет выполнить обновление, пока не будут прочитаны все результаты для первого объекта команды, при этом выдается следующее исключение.</span><span class="sxs-lookup"><span data-stu-id="c511f-170">fails on the update until all the results have been read on the first command object, yielding the following exception:</span></span>  
  
 <span data-ttu-id="c511f-171">Сообщение: контекст транзакции используется другим сеансом.</span><span class="sxs-lookup"><span data-stu-id="c511f-171">Message: Transaction context in use by another session.</span></span>  
  
 <span data-ttu-id="c511f-172">Источник: .NET SqlClient Data Provider</span><span class="sxs-lookup"><span data-stu-id="c511f-172">Source: .NET SqlClient Data Provider</span></span>  
  
 <span data-ttu-id="c511f-173">Ожидается: (значение NULL).</span><span class="sxs-lookup"><span data-stu-id="c511f-173">Expected: (null)</span></span>  
  
 <span data-ttu-id="c511f-174">Получено: System.Data.SqlClient.SqlException</span><span class="sxs-lookup"><span data-stu-id="c511f-174">Received: System.Data.SqlClient.SqlException</span></span>  
  
 <span data-ttu-id="c511f-175">Есть три способа обработки этой ситуации.</span><span class="sxs-lookup"><span data-stu-id="c511f-175">There are three options for handling this scenario:</span></span>  
  
1. <span data-ttu-id="c511f-176">Запустить транзакцию после создания модуля чтения с тем, чтобы он не был частью транзакции.</span><span class="sxs-lookup"><span data-stu-id="c511f-176">Start the transaction after the reader is created, so that it is not part of the transaction.</span></span> <span data-ttu-id="c511f-177">После этого любое обновление будет становиться собственной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="c511f-177">Every update then becomes its own transaction.</span></span>  
  
2. <span data-ttu-id="c511f-178">Зафиксировать всю работу после закрытия модуля чтения.</span><span class="sxs-lookup"><span data-stu-id="c511f-178">Commit all work after the reader is closed.</span></span> <span data-ttu-id="c511f-179">Это создает потенциал для значительного пакета обновлений.</span><span class="sxs-lookup"><span data-stu-id="c511f-179">This has the potential for a substantial batch of updates.</span></span>  
  
3. <span data-ttu-id="c511f-180">Не использовать режим MARS. Вместо этого использовать отдельное подключение для каждого объекта команды, что было стандартным решением до появления режима MARS.</span><span class="sxs-lookup"><span data-stu-id="c511f-180">Don't use MARS; instead use a separate connection for each command object as you would have before MARS.</span></span>  
  
### <a name="detecting-mars-support"></a><span data-ttu-id="c511f-181">Обнаружение поддержки режима MARS</span><span class="sxs-lookup"><span data-stu-id="c511f-181">Detecting MARS Support</span></span>  
 <span data-ttu-id="c511f-182">Приложение может проверить, поддерживается ли режим MARS, считав значение `SqlConnection.ServerVersion`.</span><span class="sxs-lookup"><span data-stu-id="c511f-182">An application can check for MARS support by reading the `SqlConnection.ServerVersion` value.</span></span> <span data-ttu-id="c511f-183">Основным номером должен быть 9 для SQL Server 2005 и 10 для SQL Server 2008.</span><span class="sxs-lookup"><span data-stu-id="c511f-183">The major number should be 9 for SQL Server 2005 and 10 for SQL Server 2008.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c511f-184">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="c511f-184">See also</span></span>

- [<span data-ttu-id="c511f-185">Режим MARS</span><span class="sxs-lookup"><span data-stu-id="c511f-185">Multiple Active Result Sets (MARS)</span></span>](multiple-active-result-sets-mars.md)
- [<span data-ttu-id="c511f-186">Общие сведения об ADO.NET</span><span class="sxs-lookup"><span data-stu-id="c511f-186">ADO.NET Overview</span></span>](../ado-net-overview.md)
