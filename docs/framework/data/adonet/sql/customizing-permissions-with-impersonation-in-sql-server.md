---
title: Настройка разрешений с олицетворением в SQL Server
ms.date: 03/30/2017
ms.assetid: dc733d09-1d6d-4af0-9c4b-8d24504860f1
ms.openlocfilehash: 84c5585912ba259fdcefaae186138c4466b16206
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91180859"
---
# <a name="customizing-permissions-with-impersonation-in-sql-server"></a><span data-ttu-id="0f9ad-102">Настройка разрешений с олицетворением в SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-102">Customizing Permissions with Impersonation in SQL Server</span></span>

<span data-ttu-id="0f9ad-103">Во многих приложениях используются хранимые процедуры для получения доступа к данным, что позволяет ограничивать доступ к базовым таблицам на основе формирования цепочки владения.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-103">Many applications use stored procedures to access data, relying on ownership chaining to restrict access to base tables.</span></span> <span data-ttu-id="0f9ad-104">При этом можно предоставлять разрешения EXECUTE для хранимых процедур, отзывая или отменяя разрешения по отношению к базовым таблицам.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-104">You can grant EXECUTE permissions on stored procedures, revoking or denying permissions on the base tables.</span></span> <span data-ttu-id="0f9ad-105">В СУБД SQL Server если хранимая процедура и таблицы имеют одного владельца, то разрешения вызывающего объекта не проверяются.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-105">SQL Server does not check the permissions of the caller if the stored procedure and tables have the same owner.</span></span> <span data-ttu-id="0f9ad-106">Но формирование цепочки владения перестает действовать, если объекты имеют разных владельцев, а также в случае применения динамического кода SQL.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-106">However, ownership chaining doesn't work if objects have different owners or in the case of dynamic SQL.</span></span>  
  
 <span data-ttu-id="0f9ad-107">Начиная с версии SQL Server 2005, появилась возможность использовать предложение EXECUTE AS в хранимой процедуре, если вызывающий объект не имеет разрешений на указанные в ссылках объекты базы данных.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-107">You can use the EXECUTE AS clause in a stored procedure when the caller doesn't have permissions on the referenced database objects.</span></span> <span data-ttu-id="0f9ad-108">Результат действия предложения EXECUTE AS состоит в том, что контекст выполнения переключается на пользователя-посредника.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-108">The effect of the EXECUTE AS clause is that the execution context is switched to the proxy user.</span></span> <span data-ttu-id="0f9ad-109">Весь код, а также все вызовы вложенных хранимых процедур или триггеров выполняются в контексте безопасности пользователя-посредника.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-109">All code, as well as any calls to nested stored procedures or triggers, executes under the security context of the proxy user.</span></span> <span data-ttu-id="0f9ad-110">Контекст выполнения возвращается к исходному вызывающему только после выполнения процедуры или при выдаче инструкции REVERT.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-110">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
## <a name="context-switching-with-the-execute-as-statement"></a><span data-ttu-id="0f9ad-111">Переключение контекста с помощью инструкции EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="0f9ad-111">Context Switching with the EXECUTE AS Statement</span></span>  

 <span data-ttu-id="0f9ad-112">Инструкция EXECUTE AS языка Transact-SQL позволяет переключать контекст выполнения инструкции путем олицетворения другого имени входа или пользователя базы данных.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-112">The Transact-SQL EXECUTE AS statement allows you to switch the execution context of a statement by impersonating another login or database user.</span></span> <span data-ttu-id="0f9ad-113">Это удобный метод проверки запросов и процедур от имени другого пользователя.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-113">This is a useful technique for testing queries and procedures as another user.</span></span>  
  
```sql  
EXECUTE AS LOGIN = 'loginName';  
EXECUTE AS USER = 'userName';  
```  
  
 <span data-ttu-id="0f9ad-114">В данном случае необходимо иметь разрешения IMPERSONATE по отношению к олицетворяемому имени входа или пользователю.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-114">You must have IMPERSONATE permissions on the login or user you are impersonating.</span></span> <span data-ttu-id="0f9ad-115">Это разрешение подразумевается для `sysadmin` во всех базах данных, а также для членов роли `db_owner` в базах данных, которыми они владеют.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-115">This permission is implied for `sysadmin` for all databases, and `db_owner` role members in databases that they own.</span></span>  
  
## <a name="granting-permissions-with-the-execute-as-clause"></a><span data-ttu-id="0f9ad-116">Предоставление разрешений с помощью предложения EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="0f9ad-116">Granting Permissions with the EXECUTE AS Clause</span></span>  

 <span data-ttu-id="0f9ad-117">Предложение EXECUTE AS можно использовать в заголовке определения хранимой процедуры, триггера или определяемой пользователем функции (за исключением встроенных функций с табличным значением).</span><span class="sxs-lookup"><span data-stu-id="0f9ad-117">You can use the EXECUTE AS clause in the definition header of a stored procedure, trigger, or user-defined function (except for inline table-valued functions).</span></span> <span data-ttu-id="0f9ad-118">Применение этого предложения приводит к выполнению процедуры в контексте пользователя с указанным именем или ключевого слова, заданного в предложении EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-118">This causes the procedure to execute in the context of the user name or keyword specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="0f9ad-119">В базе данных можно создать пользователя-посредника, не сопоставленного с каким-либо именем входа, и предоставить ему только самые необходимые разрешения на объекты, доступ к которым осуществляется в процедуре.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-119">You can create a proxy user in the database that is not mapped to a login, granting it only the necessary permissions on the objects accessed by the procedure.</span></span> <span data-ttu-id="0f9ad-120">Только пользователь-посредник, указанный в предложении EXECUTE AS, должен иметь разрешения на все объекты, к которым осуществляется доступ в модуле.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-120">Only the proxy user specified in the EXECUTE AS clause must have permissions on all objects accessed by the module.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="0f9ad-121">Некоторые действия, такие как TRUNCATE TABLE, не имеют предоставляемых разрешений.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-121">Some actions, such as TRUNCATE TABLE, do not have grantable permissions.</span></span> <span data-ttu-id="0f9ad-122">Включение инструкции в процедуру и определение пользователя-посредника, имеющего разрешения ALTER TABLE, позволяет распространить разрешения на усечение таблицы на те вызывающие объекты, которые имеют только разрешения EXECUTE на процедуру.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-122">By incorporating the statement within a procedure and specifying a proxy user who has ALTER TABLE permissions, you can extend the permissions to truncate the table to callers who have only EXECUTE permissions on the procedure.</span></span>  
  
 <span data-ttu-id="0f9ad-123">Контекст, заданный в предложении EXECUTE AS, действует только на время выполнения процедуры, включая вложенные процедуры и триггеры.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-123">The context specified in the EXECUTE AS clause is valid for the duration of the procedure, including nested procedures and triggers.</span></span> <span data-ttu-id="0f9ad-124">Контекст снова становится контекстом вызывающего объекта после завершения выполнения или после выдачи инструкции REVERT.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-124">Context reverts to the caller when execution is complete or the REVERT statement is issued.</span></span>  
  
 <span data-ttu-id="0f9ad-125">Чтобы использовать предложение EXECUTE AS в процедуре, необходимо выполнить следующие три действия.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-125">There are three steps involved in using the EXECUTE AS clause in a procedure.</span></span>  
  
1. <span data-ttu-id="0f9ad-126">Создать в базе данных пользователя-посредника, который не сопоставляется с именем входа.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-126">Create a proxy user in the database that is not mapped to a login.</span></span> <span data-ttu-id="0f9ad-127">Этот шаг не является обязательным, но позволяет упростить управление разрешениями.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-127">This is not required, but it helps when managing permissions.</span></span>  
  
```sql
CREATE USER proxyUser WITHOUT LOGIN  
```  
  
1. <span data-ttu-id="0f9ad-128">Предоставить пользователю-посреднику необходимые разрешения.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-128">Grant the proxy user the necessary permissions.</span></span>  
  
2. <span data-ttu-id="0f9ad-129">Добавить предложение EXECUTE AS в хранимую процедуру или определяемую пользователем функцию.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-129">Add the EXECUTE AS clause to the stored procedure or user-defined function.</span></span>  
  
```sql
CREATE PROCEDURE [procName] WITH EXECUTE AS 'proxyUser' AS ...  
```  
  
> [!NOTE]
> <span data-ttu-id="0f9ad-130">Работа приложений, требующих аудита, может быть нарушена, поскольку первоначальный контекст безопасности вызывающего объекта не сохраняется.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-130">Applications that require auditing can break because the original security context of the caller is not retained.</span></span> <span data-ttu-id="0f9ad-131">Встроенные функции, которые возвращают идентификатор текущего пользователя, такие как SESSION_USER, USER или USER_NAME, возвращают данные о пользователе, связанном с предложением EXECUTE AS, а не данные первоначального вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-131">Built-in functions that return the identity of the current user, such as SESSION_USER, USER, or USER_NAME, return the user associated with the EXECUTE AS clause, not the original caller.</span></span>  
  
### <a name="using-execute-as-with-revert"></a><span data-ttu-id="0f9ad-132">Использование предложения EXECUTE AS с инструкцией REVERT</span><span class="sxs-lookup"><span data-stu-id="0f9ad-132">Using EXECUTE AS with REVERT</span></span>  

 <span data-ttu-id="0f9ad-133">Инструкцию REVERT языка Transact-SQL можно использовать для возврата к первоначальному контексту выполнения.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-133">You can use the Transact-SQL REVERT statement to revert to the original execution context.</span></span>  
  
 <span data-ttu-id="0f9ad-134">Необязательное предложение с параметром NO REVERT COOKIE = @variableName позволяет переключить контекст выполнения обратно вызывающему объекту, если @variableName переменная содержит правильное значение.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-134">The optional clause, WITH NO REVERT COOKIE = @variableName, allows you switch the execution context back to the caller if the @variableName variable contains the correct value.</span></span> <span data-ttu-id="0f9ad-135">Это позволяет переключать контекст выполнения обратно к контексту вызывающего объекта в тех средах, где используются пулы соединений.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-135">This allows you to switch the execution context back to the caller in environments where connection pooling is used.</span></span> <span data-ttu-id="0f9ad-136">Поскольку значение @variableName известно только вызывающему объекту инструкции EXECUTE AS, вызывающий объект может гарантировать, что контекст выполнения не может быть изменен конечным пользователем, который вызывает приложение.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-136">Because the value of @variableName is known only to the caller of the EXECUTE AS statement, the caller can guarantee that the execution context cannot be changed by the end user that invokes the application.</span></span> <span data-ttu-id="0f9ad-137">Соединение после закрытия возвращается в пул.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-137">When the connection is closed, it is returned to the pool.</span></span> <span data-ttu-id="0f9ad-138">Дополнительные сведения о пуле подключений в ADO.NET см. в разделе [SQL Server подключение пулов (ADO.NET)](../sql-server-connection-pooling.md).</span><span class="sxs-lookup"><span data-stu-id="0f9ad-138">For more information on connection pooling in ADO.NET, see [SQL Server Connection Pooling (ADO.NET)](../sql-server-connection-pooling.md).</span></span>  
  
### <a name="specifying-the-execution-context"></a><span data-ttu-id="0f9ad-139">Определение контекста выполнения</span><span class="sxs-lookup"><span data-stu-id="0f9ad-139">Specifying the Execution Context</span></span>  

 <span data-ttu-id="0f9ad-140">Предложение EXECUTE AS можно не только использовать для указания пользователя, но и указывать в нем любое из следующих ключевых слов.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-140">In addition to specifying a user, you can also use EXECUTE AS with any of the following keywords.</span></span>  
  
- <span data-ttu-id="0f9ad-141">CALLER.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-141">CALLER.</span></span> <span data-ttu-id="0f9ad-142">По умолчанию происходит выполнение с ключевым словом CALLER. Если не указан другой параметр, то процедура выполняется в контексте безопасности вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-142">Executing as CALLER is the default; if no other option is specified, then the procedure executes in the security context of the caller.</span></span>  
  
- <span data-ttu-id="0f9ad-143">OWNER.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-143">OWNER.</span></span> <span data-ttu-id="0f9ad-144">Выполнение с ключевым словом OWNER приводит к выполнению процедуры в контексте владельца процедуры.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-144">Executing as OWNER executes the procedure in the context of the procedure owner.</span></span> <span data-ttu-id="0f9ad-145">Если процедура создана в схеме, принадлежащей `dbo` или владельцу базы данных, то процедура выполняется с неограниченными разрешениями.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-145">If the procedure is created in a schema owned by `dbo` or the database owner, the procedure will execute with unrestricted permissions.</span></span>  
  
- <span data-ttu-id="0f9ad-146">SELF.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-146">SELF.</span></span> <span data-ttu-id="0f9ad-147">Выполнение с ключевым словом SELF приводит к выполнению в контексте безопасности создателя хранимой процедуры.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-147">Executing as SELF executes in the security context of the creator of the stored procedure.</span></span> <span data-ttu-id="0f9ad-148">Это эквивалентно вызову на выполнение от имени указанного пользователя, где указанным пользователем является лицо, создавшее или изменившее процедуру.</span><span class="sxs-lookup"><span data-stu-id="0f9ad-148">This is equivalent to executing as a specified user, where the specified user is the person creating or altering the procedure.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="0f9ad-149">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="0f9ad-149">See also</span></span>

- [<span data-ttu-id="0f9ad-150">Защита приложений ADO.NET</span><span class="sxs-lookup"><span data-stu-id="0f9ad-150">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="0f9ad-151">Общие сведения о безопасности SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-151">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="0f9ad-152">Сценарии безопасности приложений в SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-152">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="0f9ad-153">Управление разрешениями с использованием хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-153">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="0f9ad-154">Написание безопасного динамического кода SQL в SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-154">Writing Secure Dynamic SQL in SQL Server</span></span>](writing-secure-dynamic-sql-in-sql-server.md)
- [<span data-ttu-id="0f9ad-155">Подписывание хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="0f9ad-155">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="0f9ad-156">Изменение данных с помощью хранимых процедур</span><span class="sxs-lookup"><span data-stu-id="0f9ad-156">Modifying Data with Stored Procedures</span></span>](../modifying-data-with-stored-procedures.md)
- [<span data-ttu-id="0f9ad-157">Общие сведения об ADO.NET</span><span class="sxs-lookup"><span data-stu-id="0f9ad-157">ADO.NET Overview</span></span>](../ado-net-overview.md)
