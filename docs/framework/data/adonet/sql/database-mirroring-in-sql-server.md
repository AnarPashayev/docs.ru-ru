---
title: Зеркальное отображение баз данных в SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.openlocfilehash: 7e2c1c8ea1cbc1bb22452b9ef9d1f250c96118ea
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91173540"
---
# <a name="database-mirroring-in-sql-server"></a><span data-ttu-id="ea9c2-102">Зеркальное отображение баз данных в SQL Server</span><span class="sxs-lookup"><span data-stu-id="ea9c2-102">Database Mirroring in SQL Server</span></span>

<span data-ttu-id="ea9c2-103">Зеркальное отображение базы данных в SQL Server позволяет сохранять копию или зеркальную копию базы данных SQL Server на резервном сервере.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-103">Database mirroring in SQL Server allows you to keep a copy, or mirror, of a SQL Server database on a standby server.</span></span> <span data-ttu-id="ea9c2-104">Зеркальное отображение гарантирует, что две отдельные копии данных постоянно существуют, обеспечивая высокий уровень доступности и избыточности данных.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-104">Mirroring ensures that two separate copies of the data exist at all times, providing high availability and complete data redundancy.</span></span> <span data-ttu-id="ea9c2-105">Поставщик данных .NET для SQL Server предоставляет неявную поддержку зеркального отображения базы данных, поэтому разработчику не надо предпринимать никаких действий или писать код, если он настроен для работы с базой данных SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-105">The .NET Data Provider for SQL Server provides implicit support for database mirroring, so that the developer does not need to take any action or write any code once it has been configured for a SQL Server database.</span></span> <span data-ttu-id="ea9c2-106">Кроме того, объект <xref:System.Data.SqlClient.SqlConnection> поддерживает явный режим подключения, который позволяет указать имя сервера-партнера по обеспечению отработки отказа в <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-106">In addition, the <xref:System.Data.SqlClient.SqlConnection> object supports an explicit connection mode that allows supplying the name of a failover partner server in the <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
 <span data-ttu-id="ea9c2-107">Следующая упрощенная последовательность событий возникает для объекта <xref:System.Data.SqlClient.SqlConnection>, предназначенного для базы данных, которая настроена для зеркального отображения:</span><span class="sxs-lookup"><span data-stu-id="ea9c2-107">The following simplified sequence of events occurs for a <xref:System.Data.SqlClient.SqlConnection> object that targets a database configured for mirroring:</span></span>  
  
1. <span data-ttu-id="ea9c2-108">Клиентское приложение успешно подключается к основной базе данных, а сервер отправляет обратно имя сервера-партнера, который затем кэшируется на клиенте.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-108">The client application successfully connects to the principal database, and the server sends back the name of the partner server, which is then cached on the client.</span></span>  
  
2. <span data-ttu-id="ea9c2-109">Если на сервере с основной базой данных происходит сбой или подключение прерывается, состояние подключения и транзакции будет утеряно.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-109">If the server containing the principal database fails or connectivity is interrupted, connection and transaction state is lost.</span></span> <span data-ttu-id="ea9c2-110">Клиентское приложение пытается восстановить подключение к основной базе данных, и происходит сбой.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-110">The client application attempts to re-establish a connection to the principal database and fails.</span></span>  
  
3. <span data-ttu-id="ea9c2-111">Затем клиентское приложение прозрачно пытается установить подключение к зеркальной базе данных на сервере-партнере.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-111">The client application then transparently attempts to establish a connection to the mirror database on the partner server.</span></span> <span data-ttu-id="ea9c2-112">В случае успешной установки подключение перенаправляется в зеркальную базу данных, которая затем становится новой основной базой данных.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-112">If it succeeds, the connection is redirected to the mirror database, which then becomes the new principal database.</span></span>  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a><span data-ttu-id="ea9c2-113">Указание резервного участника в строке подключения</span><span class="sxs-lookup"><span data-stu-id="ea9c2-113">Specifying the Failover Partner in the Connection String</span></span>  

 <span data-ttu-id="ea9c2-114">Если в строке подключения указать имя сервера-партнера по обеспечению отработки отказа, клиент будет прозрачно пытаться подключиться к партнеру по обеспечению отработки отказа в случае, если основная база данных недоступна при первом подключении клиентского приложения.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-114">If you supply the name of a failover partner server in the connection string, the client will transparently attempt a connection with the failover partner if the principal database is unavailable when the client application first connects.</span></span>  
  
```csharp
";Failover Partner=PartnerServerName"  
```  
  
 <span data-ttu-id="ea9c2-115">Если не указано имя сервера-партнера по обеспечению отработки отказа, а основная база данных недоступна при первом подключении клиентского приложения, возникает <xref:System.Data.SqlClient.SqlException>.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-115">If you omit the name of the failover partner server and the principal database is unavailable when the client application first connects then a <xref:System.Data.SqlClient.SqlException> is raised.</span></span>  
  
 <span data-ttu-id="ea9c2-116">При успешном открытии <xref:System.Data.SqlClient.SqlConnection> имя партнера по обеспечению отработки отказа возвращается сервером и заменяет все значения, указанные в строке подключения.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-116">When a <xref:System.Data.SqlClient.SqlConnection> is successfully opened, the failover partner name is returned by the server and supersedes any values supplied in the connection string.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ea9c2-117">Необходимо явно указать имя исходного каталога или базы данных в строке подключения для сценариев зеркального отображения базы данных.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-117">You must explicitly specify the initial catalog or database name in the connection string for database mirroring scenarios.</span></span> <span data-ttu-id="ea9c2-118">Если клиент получает сведения о переходе на другой ресурс во время соединения, которое не содержит явно указанного исходного каталога или базы данных, эти сведения не кэшируются и приложение не делает попытку перехода на другой ресурс в случае выхода основного сервера из строя.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-118">If the client receives failover information on a connection that doesn't have an explicitly specified initial catalog or database, the failover information is not cached and the application does not attempt to fail over if the principal server fails.</span></span> <span data-ttu-id="ea9c2-119">Если строка подключения имеет значение для партнера по обеспечению отработки отказа, но не имеет значения для исходного каталога или базы данных, возникает `InvalidArgumentException`.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-119">If a connection string has a value for the failover partner, but no value for the initial catalog or database, an `InvalidArgumentException` is raised.</span></span>  
  
## <a name="retrieving-the-current-server-name"></a><span data-ttu-id="ea9c2-120">Получение текущего имени сервера</span><span class="sxs-lookup"><span data-stu-id="ea9c2-120">Retrieving the Current Server Name</span></span>  

 <span data-ttu-id="ea9c2-121">В случае отработки отказа можно получить имя сервера, к которому на самом деле подключено текущее подключение, с помощью свойства <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> объекта <xref:System.Data.SqlClient.SqlConnection>.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-121">In the event of a failover, you can retrieve the name of the server to which the current connection is actually connected by using the <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> property of a <xref:System.Data.SqlClient.SqlConnection> object.</span></span> <span data-ttu-id="ea9c2-122">Следующий фрагмент кода извлекает имя активного сервера, предполагая, что переменная подключения ссылается на открытый элемент <xref:System.Data.SqlClient.SqlConnection>.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-122">The following code fragment retrieves the name of the active server, assuming that the connection variable references an open <xref:System.Data.SqlClient.SqlConnection>.</span></span>  
  
 <span data-ttu-id="ea9c2-123">При возникновении события отработки отказа и переключении подключения на зеркальный сервер свойство **DataSource** обновляется для отображения имени этого сервера.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-123">When a failover event occurs and the connection is switched to the mirror server, the **DataSource** property is updated to reflect the mirror name.</span></span>  
  
```vb  
Dim activeServer As String = connection.DataSource  
```  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a><span data-ttu-id="ea9c2-124">Поведение SqlClient при зеркальном отображении</span><span class="sxs-lookup"><span data-stu-id="ea9c2-124">SqlClient Mirroring Behavior</span></span>  

 <span data-ttu-id="ea9c2-125">Клиент всегда пытается подключиться к текущему основному серверу.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-125">The client always tries to connect to the current principal server.</span></span> <span data-ttu-id="ea9c2-126">В случае сбоя он пытается обратиться к партнеру по обеспечению отработки отказа.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-126">If it fails, it tries the failover partner.</span></span> <span data-ttu-id="ea9c2-127">Если зеркальная база данных уже переключена на основную роль на сервере-партнере, подключение будет установлено успешно, а новое сопоставление зеркального отображения-субъекта отправляется клиенту и кэшируется на время существования вызова <xref:System.AppDomain>.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-127">If the mirror database has already been switched to the principal role on the partner server, the connection succeeds and the new principal-mirror mapping is sent to the client and cached for the lifetime of the calling <xref:System.AppDomain>.</span></span> <span data-ttu-id="ea9c2-128">Оно не сохраняется в постоянном хранилище и недоступно для последующих соединений в другом домене приложения **AppDomain** или процессе.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-128">It is not stored in persistent storage and is not available for subsequent connections in a different **AppDomain** or process.</span></span> <span data-ttu-id="ea9c2-129">Однако оно доступно для последующих соединений внутри того же домена приложения **AppDomain**.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-129">However, it is available for subsequent connections within the same **AppDomain**.</span></span> <span data-ttu-id="ea9c2-130">Обратите внимание, что другой домен приложения **AppDomain** или процесс, выполняемый на том же или другом компьютере, всегда имеет свой пул соединений и эти соединения не сбрасываются.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-130">Note that another **AppDomain** or process running on the same or a different computer always has its pool of connections, and those connections are not reset.</span></span> <span data-ttu-id="ea9c2-131">В этом случае, если база данных-источник выходит из строя, каждый процесс или домен приложения **AppDomain** заканчивается ошибкой и пул автоматически очищается.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-131">In that case, if the primary database goes down, each process or **AppDomain** fails once, and the pool is automatically cleared.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="ea9c2-132">Поддержка зеркального отображения на сервере настраивается отдельно для каждой базы данных.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-132">Mirroring support on the server is configured on a per-database basis.</span></span> <span data-ttu-id="ea9c2-133">Если операции обработки данных выполняются для других баз данных, не входящих в основной или зеркальный набор, с помощью составных имен либо путем изменения текущей базы данных, изменения в этих базах данных не распространяются в случае сбоя.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-133">If data manipulation operations are executed against other databases not included in the principal/mirror set, either by using multipart names or by changing the current database, the changes to these other databases do not propagate in the event of failure.</span></span> <span data-ttu-id="ea9c2-134">При изменении данных в незеркальной базе данных ошибка не возникает.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-134">No error is generated when data is modified in a database that is not mirrored.</span></span> <span data-ttu-id="ea9c2-135">Разработчик должен оценить возможное воздействие таких операций.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-135">The developer must evaluate the possible impact of such operations.</span></span>  
  
## <a name="database-mirroring-resources"></a><span data-ttu-id="ea9c2-136">Ресурсы, посвященные зеркальному отображению баз данных</span><span class="sxs-lookup"><span data-stu-id="ea9c2-136">Database Mirroring Resources</span></span>  

 <span data-ttu-id="ea9c2-137">Документацию и сведения о настройке, развертывании и администрировании зеркального подключения см. в приведенных ниже ресурсах документации на SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-137">For conceptual documentation and information on configuring, deploying and administering mirroring, see the following resources in SQL Server documentation.</span></span>  
  
|<span data-ttu-id="ea9c2-138">Ресурс</span><span class="sxs-lookup"><span data-stu-id="ea9c2-138">Resource</span></span>|<span data-ttu-id="ea9c2-139">Описание</span><span class="sxs-lookup"><span data-stu-id="ea9c2-139">Description</span></span>|  
|--------------|-----------------|  
|[<span data-ttu-id="ea9c2-140">Зеркальное отображение базы данных</span><span class="sxs-lookup"><span data-stu-id="ea9c2-140">Database Mirroring</span></span>](/sql/database-engine/database-mirroring/database-mirroring-sql-server)|<span data-ttu-id="ea9c2-141">Описывается установка и настройка зеркального отображения в SQL Server.</span><span class="sxs-lookup"><span data-stu-id="ea9c2-141">Describes how to set up and configure mirroring in SQL Server.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="ea9c2-142">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="ea9c2-142">See also</span></span>

- [<span data-ttu-id="ea9c2-143">Общие сведения об ADO.NET</span><span class="sxs-lookup"><span data-stu-id="ea9c2-143">ADO.NET Overview</span></span>](../ado-net-overview.md)
