---
title: Зеркальное отображение баз данных в SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 89befaff-bb46-4290-8382-e67cdb0e3de9
ms.openlocfilehash: bdcdce58d78a305493bd698cf4d849e640f14ce0
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59230997"
---
# <a name="database-mirroring-in-sql-server"></a>Зеркальное отображение баз данных в SQL Server
Зеркальное отображение базы данных в SQL Server позволяет сохранять копию или зеркальную копию базы данных SQL Server на резервном сервере. Зеркальное отображение гарантирует постоянное существование двух отдельных копий данных, обеспечивая тем самым высокий уровень доступности и полную избыточность данных. Поставщик данных .NET для SQL Server предоставляет неявную поддержку зеркального отображения базы данных, поэтому разработчику не надо предпринимать никаких действий или писать код, если он настроен для работы с базой данных SQL Server. Кроме того, объект <xref:System.Data.SqlClient.SqlConnection> поддерживает режим явного подключения, в котором в строке подключения <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A> можно указать имя резервного сервера-участника.  
  
 Приведенная ниже упрощенная последовательность событий возникает для объекта <xref:System.Data.SqlClient.SqlConnection>, связанного с базой данных, которая настроена на зеркальное отображение.  
  
1.  Клиентское приложение успешно соединяется с основной базой данных, и сервер возвращает имя сервера-участника, которое затем кэшируется на клиенте.  
  
2.  В случае выхода из строя или разрыва соединения с сервером, содержащим основную базу данных, состояние соединения и транзакции теряется. Клиентское приложение предпринимает безуспешную попытку повторно установить соединение с основной базой данных.  
  
3.  Затем клиентское приложение пытается явным образом установить соединение с зеркальной базой данных на сервере-участнике. В случае успеха соединение перенаправляется в зеркальную базу данных, которая становится новой основной базой данных.  
  
## <a name="specifying-the-failover-partner-in-the-connection-string"></a>Указание резервного участника в строке подключения  
 При указании в строке подключения имени резервного сервера-участника клиент прозрачным образом попытается установить соединение с резервным участником, если основная база данных будет недоступна при первом подключении клиентского приложения.  
  
```  
";Failover Partner=PartnerServerName"  
```  
  
 Если имя резервного сервера-участника не указано, а основная база данных недоступна при первом подключении клиентского приложения, вызывается исключение <xref:System.Data.SqlClient.SqlException>.  
  
 При успешном открытии подключения <xref:System.Data.SqlClient.SqlConnection>, имя резервного партнера-участника возвращается сервером и замещает все значения, указанные в строке подключения.  
  
> [!NOTE]
>  При зеркальном отображении базы данных в строке подключения необходимо явным образом указать исходный каталог или имя базы данных. Если клиент получает сведения о переходе на другой ресурс во время соединения, для которого явным образом не указан исходный каталог или база данных, эти сведения не кэшируются и приложение не пытается перейти на другой ресурс в случае выхода из строя основного сервера. Если в строке подключения указан резервный партнер, но не указан исходный каталог или база данных, вызывается исключение `InvalidArgumentException`.  
  
## <a name="retrieving-the-current-server-name"></a>Получение текущего имени сервера  
 При помощи свойства <xref:System.Data.SqlClient.SqlConnection.DataSource%2A> объекта <xref:System.Data.SqlClient.SqlConnection> в случае перехода на другой ресурс можно получить имя сервера, с которым установлено текущее соединение. Следующий фрагмент кода получает имя активного сервера, предполагая, что переменная connection ссылается на открытое соединение <xref:System.Data.SqlClient.SqlConnection>.  
  
 При возникновении события перехода на другой ресурс и переключении соединения на зеркальный сервер **DataSource** свойство обновляется для отражения имени зеркала.  
  
```vb  
Dim activeServer As String = connection.DataSource  
```  
  
```csharp  
string activeServer = connection.DataSource;  
```  
  
## <a name="sqlclient-mirroring-behavior"></a>Поведение SqlClient при зеркальном отображении  
 Клиент всегда пытается соединиться с текущим основным сервером. В случае сбоя он пытается соединиться с резервным участником. Если зеркальная база данных уже была переключена на основную роль на сервере-участнике, то соединение устанавливается успешно и новое сопоставление «основная-зеркальная» отправляется клиенту и кэшируется на время существования домена приложения <xref:System.AppDomain>. Он не хранится в постоянном хранилище и недоступен для последующих соединений в другом **AppDomain** или процесса. Тем не менее, он доступен для последующих соединений внутри того же **AppDomain**. Обратите внимание что другой **AppDomain** или процесс, выполняемый на том же или другом компьютере, всегда имеет свой пул соединений и эти соединения не сбрасываются. В этом случае, если база данных-источник выходит из строя, каждый процесс или **AppDomain** заканчивается ошибкой и пул автоматически очищается.  
  
> [!NOTE]
>  Поддержка зеркального отображения на сервере настраивается отдельно для каждой базы данных. Если операции по обработке данных, выполняемые в других базах данных, не включаются в основной или зеркальный набор вследствие использования многокомпонентных имен либо из-за изменения текущей базы данных, то в случае сбоя изменения в эти базы данных не распространяются. При изменении данных в базе данных, которая не была зеркально отображена, ошибка не выдается. Разработчик должен оценить возможное последствие таких операций.  
  
## <a name="database-mirroring-resources"></a>Ресурсы, посвященные зеркальному отображению баз данных  
 Документацию и сведения о настройке развертывании и администрировании зеркального отображения, см. в следующих ресурсах в документации по SQL Server.  
  
|Ресурс|Описание|  
|--------------|-----------------|  
|[Зеркальное отображение базы данных](/sql/database-engine/database-mirroring/database-mirroring-sql-server)|Описывается установка и настройка зеркального отображения в SQL Server.|  
  
## <a name="see-also"></a>См. также

- [Управляемые поставщики ADO.NET и центр разработчиков DataSet](https://go.microsoft.com/fwlink/?LinkId=217917)
