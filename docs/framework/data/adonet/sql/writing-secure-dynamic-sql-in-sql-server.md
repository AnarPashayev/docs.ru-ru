---
title: Написание безопасного динамического кода SQL в SQL Server
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: 9b0c903c04c82c9a0f61197642645c5ba93ba099
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64645922"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="b7348-102">Написание безопасного динамического кода SQL в SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="b7348-103">Внедрение кода SQL - это процесс, посредством которого пользователь-злоумышленник вводит инструкции языка Transact-SQL вместо допустимых входных данных.</span><span class="sxs-lookup"><span data-stu-id="b7348-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="b7348-104">Если входные данные передаются непосредственно на сервер без проверки, и если в приложении не приняты меры против выполнения внедренного кода, то появляется возможность осуществлять злонамеренные действия для повреждения или уничтожения данных.</span><span class="sxs-lookup"><span data-stu-id="b7348-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="b7348-105">Любая процедура, создающая инструкции SQL, должна рассматриваться на предмет уязвимости к внедрению небезопасного кода, поскольку SQL Server выполняет все получаемые синтаксически правильные запросы.</span><span class="sxs-lookup"><span data-stu-id="b7348-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="b7348-106">Даже параметризованные данные могут стать предметом манипуляций опытного и решительного злоумышленника.</span><span class="sxs-lookup"><span data-stu-id="b7348-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="b7348-107">В случае применения динамического кода SQL следует обязательно параметризовать применяемые команды и никогда не включать значения параметров непосредственно в строку запроса.</span><span class="sxs-lookup"><span data-stu-id="b7348-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="b7348-108">Принцип осуществления атаки путем внедрения кода SQL</span><span class="sxs-lookup"><span data-stu-id="b7348-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="b7348-109">Атака осуществляется посредством преждевременного завершения текстовой строки и присоединения к ней новой команды.</span><span class="sxs-lookup"><span data-stu-id="b7348-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="b7348-110">Поскольку к вставленной команде перед выполнением могут быть добавлены дополнительные строки, злоумышленник заканчивает внедряемую строку меткой комментария «--».</span><span class="sxs-lookup"><span data-stu-id="b7348-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="b7348-111">Весь последующий текст во время выполнения не учитывается.</span><span class="sxs-lookup"><span data-stu-id="b7348-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="b7348-112">Вставка нескольких команд осуществляется с помощью разделителя - точки с запятой (;).</span><span class="sxs-lookup"><span data-stu-id="b7348-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="b7348-113">Если вставленный код SQL синтаксически верен, искаженные данные нельзя выявить программно.</span><span class="sxs-lookup"><span data-stu-id="b7348-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="b7348-114">Поэтому необходимо проверять правильность всех вводимых пользователями данных, а также внимательно просматривать код, выполняющий созданные SQL-команды на сервере.</span><span class="sxs-lookup"><span data-stu-id="b7348-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="b7348-115">Никогда не объединяйте введенные пользователем данные без проверки.</span><span class="sxs-lookup"><span data-stu-id="b7348-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="b7348-116">Объединение строк является основной точкой входа для внедрения кода в скрипте.</span><span class="sxs-lookup"><span data-stu-id="b7348-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="b7348-117">Ниже приведены некоторые полезные рекомендации.</span><span class="sxs-lookup"><span data-stu-id="b7348-117">Here are some helpful guidelines:</span></span>  
  
- <span data-ttu-id="b7348-118">Ни в коем случае не следует формировать инструкции Transact-SQL непосредственно на основании данных, введенных пользователем. Используйте хранимые процедуры для проверки ввода данных пользователем.</span><span class="sxs-lookup"><span data-stu-id="b7348-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
- <span data-ttu-id="b7348-119">Всегда проверяйте все данные, вводимые пользователем, выполняя проверку типа, длины, формата и диапазона данных.</span><span class="sxs-lookup"><span data-stu-id="b7348-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="b7348-120">Применяйте функцию QUOTENAME() языка Transact-SQL для экранирования системных имен или функцию REPLACE() для экранирования любого символа в строке.</span><span class="sxs-lookup"><span data-stu-id="b7348-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
- <span data-ttu-id="b7348-121">Реализуйте несколько уровней проверки в каждом уровне приложения.</span><span class="sxs-lookup"><span data-stu-id="b7348-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
- <span data-ttu-id="b7348-122">Проверяйте размер и тип вводимых данных и устанавливайте соответствующие ограничения.</span><span class="sxs-lookup"><span data-stu-id="b7348-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="b7348-123">Это поможет предотвратить преднамеренное переполнение буфера.</span><span class="sxs-lookup"><span data-stu-id="b7348-123">This can help prevent deliberate buffer overruns.</span></span>  
  
- <span data-ttu-id="b7348-124">Проверяйте содержимое строковых переменных и принимайте только ожидаемые значения.</span><span class="sxs-lookup"><span data-stu-id="b7348-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="b7348-125">Отклоняйте записи, содержащие двоичные данные, управляющие последовательности и символы комментариев.</span><span class="sxs-lookup"><span data-stu-id="b7348-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
- <span data-ttu-id="b7348-126">При работе с XML-документами проверяйте все вводимые данные на соответствие схеме.</span><span class="sxs-lookup"><span data-stu-id="b7348-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
- <span data-ttu-id="b7348-127">В многоуровневых средах все данные должны проверяться перед передачей в доверенную зону.</span><span class="sxs-lookup"><span data-stu-id="b7348-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
- <span data-ttu-id="b7348-128">Не допускайте использование в полях следующих строк, из которых могут быть созданы имена файлов: AUX, CLOCK$, COM1–COM8, CON, CONFIG$, LPT1–LPT8, NUL и PRN.</span><span class="sxs-lookup"><span data-stu-id="b7348-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
- <span data-ttu-id="b7348-129">Используйте объекты <xref:System.Data.SqlClient.SqlParameter> с хранимыми процедурами и командами для обеспечения контроля типов и проверки длины.</span><span class="sxs-lookup"><span data-stu-id="b7348-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
- <span data-ttu-id="b7348-130">Используйте выражения <xref:System.Text.RegularExpressions.Regex> в клиентском коде для фильтрации недопустимых символов.</span><span class="sxs-lookup"><span data-stu-id="b7348-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="b7348-131">Стратегии применения динамического кода SQL</span><span class="sxs-lookup"><span data-stu-id="b7348-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="b7348-132">Выполнение динамически создаваемых инструкций SQL в процедурном коде нарушает цепочку владения, в результате чего SQL Server приходится проверять разрешения вызывающего объекта на объекты, доступ к которым осуществляется в динамическом коде SQL.</span><span class="sxs-lookup"><span data-stu-id="b7348-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="b7348-133">В SQL Server имеются методы предоставления пользователям доступа к данным с помощью хранимых процедур и определяемых пользователем функций, в которых выполняется динамический код SQL.</span><span class="sxs-lookup"><span data-stu-id="b7348-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
- <span data-ttu-id="b7348-134">Использование олицетворения с предложением Transact-SQL EXECUTE AS, как описано в разделе [Настройка разрешений с олицетворением в SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="b7348-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
- <span data-ttu-id="b7348-135">Подписывание хранимых процедур с помощью сертификатов, как описано в разделе [Подписывание хранимых процедур в SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="b7348-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="b7348-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="b7348-136">EXECUTE AS</span></span>  
 <span data-ttu-id="b7348-137">Предложение EXECUTE AS заменяет разрешения вызывающего объекта разрешениями пользователя, указанного в предложении EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="b7348-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="b7348-138">Вложенные хранимые процедуры или триггеры выполняются в контексте безопасности пользователя-посредника.</span><span class="sxs-lookup"><span data-stu-id="b7348-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="b7348-139">Это может привести к нарушению работы приложений, которые основаны на использовании средств безопасности уровня строки или требуют аудита.</span><span class="sxs-lookup"><span data-stu-id="b7348-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="b7348-140">Некоторые функции, возвращающие идентификатор пользователя, возвращают данные о пользователе, указанном в предложении EXECUTE AS, а не данные первоначального вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="b7348-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="b7348-141">Контекст выполнения переходит к вызывающему объекту только после выполнения процедуры или при выполнении инструкции REVERT.</span><span class="sxs-lookup"><span data-stu-id="b7348-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="b7348-142">Подпись сертификата</span><span class="sxs-lookup"><span data-stu-id="b7348-142">Certificate Signing</span></span>  
 <span data-ttu-id="b7348-143">При выполнении хранимой процедуры, подписанной с помощью сертификата, разрешения, предоставленные пользователю сертификата, объединяются с разрешениями вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="b7348-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="b7348-144">Контекст выполнения остается тем же; пользователь сертификата не олицетворяет вызывающий объект.</span><span class="sxs-lookup"><span data-stu-id="b7348-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="b7348-145">Для подписания хранимых процедур необходимо выполнить несколько действий.</span><span class="sxs-lookup"><span data-stu-id="b7348-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="b7348-146">После каждого изменения процедуры должно быть проведено ее повторное подписание.</span><span class="sxs-lookup"><span data-stu-id="b7348-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="b7348-147">Доступ к объектам в нескольких базах данных</span><span class="sxs-lookup"><span data-stu-id="b7348-147">Cross Database Access</span></span>  
 <span data-ttu-id="b7348-148">Межбазовые цепочки владения не работают при выполнении динамически создаваемых инструкций SQL.</span><span class="sxs-lookup"><span data-stu-id="b7348-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="b7348-149">Это можно обойти в SQL Server, создав хранимую процедуру для доступа к данным другой базы данных и подписав эту процедуру сертификатом, существующим в обеих базах данных.</span><span class="sxs-lookup"><span data-stu-id="b7348-149">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="b7348-150">Это предоставляет пользователям доступ к используемым процедурой ресурсам базы данных без предоставления им доступа к базе данных или разрешений на нее.</span><span class="sxs-lookup"><span data-stu-id="b7348-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="b7348-151">Внешние ресурсы</span><span class="sxs-lookup"><span data-stu-id="b7348-151">External Resources</span></span>  
 <span data-ttu-id="b7348-152">Дополнительные сведения см. в следующих ресурсах.</span><span class="sxs-lookup"><span data-stu-id="b7348-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="b7348-153">Ресурс</span><span class="sxs-lookup"><span data-stu-id="b7348-153">Resource</span></span>|<span data-ttu-id="b7348-154">Описание</span><span class="sxs-lookup"><span data-stu-id="b7348-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="b7348-155">[Хранимые процедуры](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) и [Внедрение кода SQL](/sql/relational-databases/security/sql-injection) в электронной документации на SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-155">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="b7348-156">Разделы описывают, как создавать хранимые процедуры и как работает внедрение кода SQL.</span><span class="sxs-lookup"><span data-stu-id="b7348-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="b7348-157">См. также</span><span class="sxs-lookup"><span data-stu-id="b7348-157">See also</span></span>

- [<span data-ttu-id="b7348-158">Защита приложений ADO.NET</span><span class="sxs-lookup"><span data-stu-id="b7348-158">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)
- [<span data-ttu-id="b7348-159">Общие сведения о безопасности SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-159">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)
- [<span data-ttu-id="b7348-160">Сценарии безопасности приложений в SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-160">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="b7348-161">Управление разрешениями с использованием хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-161">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="b7348-162">Подписывание хранимых процедур в SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-162">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="b7348-163">Настройка разрешений с олицетворением в SQL Server</span><span class="sxs-lookup"><span data-stu-id="b7348-163">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="b7348-164">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="b7348-164">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
