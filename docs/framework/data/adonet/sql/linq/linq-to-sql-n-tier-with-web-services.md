---
title: N-уровневое использование LINQ to SQL с веб-службами
ms.date: 03/30/2017
ms.assetid: 9cb10eb8-957f-4beb-a271-5f682016fed2
ms.openlocfilehash: dd1f756fae99fbae591b27aaefc7cc4ad7501bd6
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91175295"
---
# <a name="linq-to-sql-n-tier-with-web-services"></a><span data-ttu-id="ab33c-102">N-уровневое использование LINQ to SQL с веб-службами</span><span class="sxs-lookup"><span data-stu-id="ab33c-102">LINQ to SQL N-Tier with Web Services</span></span>

[!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] <span data-ttu-id="ab33c-103">разработан специально для использования на среднем уровне на слабо связанном уровне доступа к данным (DAL), таком как веб-служба.</span><span class="sxs-lookup"><span data-stu-id="ab33c-103">is designed especially for use on the middle tier in a loosely-coupled data access layer (DAL) such as a Web service.</span></span> <span data-ttu-id="ab33c-104">Если уровнем представления данных является веб-страница ASP.NET, то для управления передачей данных между пользовательским интерфейсом и <xref:System.Web.UI.WebControls.LinqDataSource> на среднем уровне используется серверный веб-элемент управления [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)].</span><span class="sxs-lookup"><span data-stu-id="ab33c-104">If the presentation tier is an ASP.NET Web page, then you use the <xref:System.Web.UI.WebControls.LinqDataSource> Web server control to manage the data transfer between the user interface and [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] on the middle-tier.</span></span> <span data-ttu-id="ab33c-105">Если уровень представления данных не является страницей ASP.NET, то и на среднем уровне, и на уровне представления данных необходимо выполнить дополнительные действия по управлению сериализацией и десериализацией данных.</span><span class="sxs-lookup"><span data-stu-id="ab33c-105">If the presentation tier is not an ASP.NET page, then both the middle-tier and the presentation tier must do some additional work to manage the serialization and deserialization of data.</span></span>  
  
## <a name="setting-up-linq-to-sql-on-the-middle-tier"></a><span data-ttu-id="ab33c-106">Настройка технологии LINQ to SQL на среднем уровне</span><span class="sxs-lookup"><span data-stu-id="ab33c-106">Setting up LINQ to SQL on the Middle Tier</span></span>  

 <span data-ttu-id="ab33c-107">Средний уровень веб-службы или многоуровневого приложения содержит контекст данных и классы сущностей.</span><span class="sxs-lookup"><span data-stu-id="ab33c-107">In a Web service or n-tier application, the middle tier contains the data context and the entity classes.</span></span> <span data-ttu-id="ab33c-108">Эти классы можно создать вручную либо с помощью SQLMetal.exe или реляционный конструктор объектов, как описано в других разделах документации.</span><span class="sxs-lookup"><span data-stu-id="ab33c-108">You can create these classes manually, or by using either SQLMetal.exe or the Object Relational Designer as described elsewhere in the documentation.</span></span> <span data-ttu-id="ab33c-109">Во время разработки можно сделать класс сущностей сериализуемым.</span><span class="sxs-lookup"><span data-stu-id="ab33c-109">At design time, you have the option to make the entity classes serializable.</span></span> <span data-ttu-id="ab33c-110">Дополнительные сведения см. [в разделе инструкции. обеспечение сериализации сущностей](how-to-make-entities-serializable.md).</span><span class="sxs-lookup"><span data-stu-id="ab33c-110">For more information, see [How to: Make Entities Serializable](how-to-make-entities-serializable.md).</span></span> <span data-ttu-id="ab33c-111">Другой вариант — создать отдельный набор классов, инкапсулирующих данные для сериализации, а затем выполнить проецирование этих сериализуемых типов при возврате данных в запросах LINQ.</span><span class="sxs-lookup"><span data-stu-id="ab33c-111">Another option is to create a separate set of classes that encapsulate the data to be serialized, and then project into those serializable types when you return data in your LINQ queries.</span></span>  
  
 <span data-ttu-id="ab33c-112">Затем следует определить интерфейс с методами, которые клиенты будут вызывать для извлечения, вставки и обновления данных.</span><span class="sxs-lookup"><span data-stu-id="ab33c-112">You then define the interface with the methods that the clients will call to retrieve, insert and update data.</span></span> <span data-ttu-id="ab33c-113">Методы интерфейса заключают запросы LINQ.</span><span class="sxs-lookup"><span data-stu-id="ab33c-113">The interface methods wrap your LINQ queries.</span></span> <span data-ttu-id="ab33c-114">Для обработки удаленных вызовов методов и сериализации данных можно использовать любой вид механизма сериализации.</span><span class="sxs-lookup"><span data-stu-id="ab33c-114">You can use any kind of serialization mechanism to handle the remote method calls and the serialization of data.</span></span> <span data-ttu-id="ab33c-115">Единственное требование заключается в том, что если в объектной модели существуют циклические или двунаправленные отношения, например между классами "Customers" и "Orders" в стандартной объектной модели "Northwind", то необходимо использовать сериализатор, который поддерживает такие отношения.</span><span class="sxs-lookup"><span data-stu-id="ab33c-115">The only requirement is that if you have cyclic or bi-directional relationships in your object model, such as that between Customers and Orders in the standard Northwind object model, then you must use a serializer that supports it.</span></span> <span data-ttu-id="ab33c-116">Сериализатор Windows Communication Foundation (WCF) <xref:System.Runtime.Serialization.DataContractSerializer> поддерживает двунаправленные отношения, а сериализатор XmlSerializer, который используется для веб-служб, не совместимых с WCF, не поддерживает.</span><span class="sxs-lookup"><span data-stu-id="ab33c-116">The Windows Communication Foundation (WCF) <xref:System.Runtime.Serialization.DataContractSerializer> supports bi-directional relationships but the XmlSerializer that is used with non-WCF Web services does not.</span></span> <span data-ttu-id="ab33c-117">Если используется сериализатор XmlSerializer, то необходимо убедиться, что в объектной модели отсутствуют циклические связи.</span><span class="sxs-lookup"><span data-stu-id="ab33c-117">If you select to use the XmlSerializer, then you must make sure that your object model has no cyclic relationships.</span></span>  
  
 <span data-ttu-id="ab33c-118">Дополнительные сведения о Windows Communication Foundation см. [в разделе Windows Communication Foundation Services and WCF Data Services в Visual Studio](/visualstudio/data-tools/windows-communication-foundation-services-and-wcf-data-services-in-visual-studio).</span><span class="sxs-lookup"><span data-stu-id="ab33c-118">For more information about Windows Communication Foundation, see [Windows Communication Foundation Services and WCF Data Services in Visual Studio](/visualstudio/data-tools/windows-communication-foundation-services-and-wcf-data-services-in-visual-studio).</span></span>  
  
 <span data-ttu-id="ab33c-119">Реализуйте бизнес-правила и другую логику, относящуюся к домену, используя разделяемые классы и методы в классе <xref:System.Data.Linq.DataContext> и классах сущностей для обработки событий [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] времени выполнения.</span><span class="sxs-lookup"><span data-stu-id="ab33c-119">Implement your business rules or other domain-specific logic by using the partial classes and methods on the <xref:System.Data.Linq.DataContext> and entity classes to hook into [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] runtime events.</span></span> <span data-ttu-id="ab33c-120">Дополнительные сведения см. в разделе [Реализация N-уровневой бизнес-логики](implementing-business-logic-linq-to-sql.md).</span><span class="sxs-lookup"><span data-stu-id="ab33c-120">For more information, see [Implementing N-Tier Business Logic](implementing-business-logic-linq-to-sql.md).</span></span>  
  
## <a name="defining-the-serializable-types"></a><span data-ttu-id="ab33c-121">Определение сериализуемых типов</span><span class="sxs-lookup"><span data-stu-id="ab33c-121">Defining the Serializable Types</span></span>  

 <span data-ttu-id="ab33c-122">Клиент или уровень представления данных должен иметь определения типов для классов, которые он будет получать от среднего уровня.</span><span class="sxs-lookup"><span data-stu-id="ab33c-122">The client or presentation tier must have type definitions for the classes that it will be receiving from the middle tier.</span></span> <span data-ttu-id="ab33c-123">Данные типы могут сами быть классами сущностей или представлять собой особые классы, которые включают только определенные поля из классов сущностей для удаленного взаимодействия.</span><span class="sxs-lookup"><span data-stu-id="ab33c-123">Those types may be the entity classes themselves, or special classes that wrap only certain fields from the entity classes for remoting.</span></span> <span data-ttu-id="ab33c-124">В любом случае [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] совершенно неважно, как уровень представления данных получает определения типов.</span><span class="sxs-lookup"><span data-stu-id="ab33c-124">In any case, [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] is completely unconcerned about how the presentation tier acquires those type definitions.</span></span> <span data-ttu-id="ab33c-125">Например, уровень представления данных может использовать технологию WCF для автоматического создания типов, содержать копию библиотеки DLL, в которой определены эти типы или определить собственные версии типов.</span><span class="sxs-lookup"><span data-stu-id="ab33c-125">For example, the presentation tier could use WCF to generate the types automatically, or it could have a copy of a DLL in which those types are defined, or it could just define its own versions of the types.</span></span>  
  
## <a name="retrieving-and-inserting-data"></a><span data-ttu-id="ab33c-126">Извлечение и вставка данных</span><span class="sxs-lookup"><span data-stu-id="ab33c-126">Retrieving and Inserting Data</span></span>  

 <span data-ttu-id="ab33c-127">Средний уровень определяет интерфейс, указывающий, как уровень представления данных получает доступ к данным.</span><span class="sxs-lookup"><span data-stu-id="ab33c-127">The middle tier defines an interface that specifies how the presentation tier accesses the data.</span></span> <span data-ttu-id="ab33c-128">например `GetProductByID(int productID)` или `GetCustomers()`.</span><span class="sxs-lookup"><span data-stu-id="ab33c-128">For example `GetProductByID(int productID)`, or `GetCustomers()`.</span></span> <span data-ttu-id="ab33c-129">На среднем уровне тело метода обычно создает новый экземпляр класса <xref:System.Data.Linq.DataContext> и выполняет запрос к одной или нескольким своим таблицам.</span><span class="sxs-lookup"><span data-stu-id="ab33c-129">On the middle tier, the method body typically creates a new instance of the <xref:System.Data.Linq.DataContext>, executes a query against one or more of its table.</span></span> <span data-ttu-id="ab33c-130">Затем средний уровень возвращает результат в виде интерфейса <xref:System.Collections.Generic.IEnumerable%601>, где `T` является классом сущностей или другим типом, используемым для сериализации.</span><span class="sxs-lookup"><span data-stu-id="ab33c-130">The middle tier then returns the result as an <xref:System.Collections.Generic.IEnumerable%601>, where `T` is either an entity class or another type that is used for serialization.</span></span> <span data-ttu-id="ab33c-131">Уровень представления данных никогда не отправляет переменные запроса непосредственно на средний уровень и не получает этих переменных из среднего уровня.</span><span class="sxs-lookup"><span data-stu-id="ab33c-131">The presentation tier never sends or receives query variables directly to or from the middle tier.</span></span> <span data-ttu-id="ab33c-132">Оба уровня обмениваются значениями, объектами и коллекциями конкретных данных.</span><span class="sxs-lookup"><span data-stu-id="ab33c-132">The two tiers exchange values, objects, and collections of concrete data.</span></span> <span data-ttu-id="ab33c-133">После получения коллекции уровень представления может использовать LINQ to Objects, чтобы при необходимости запросить его.</span><span class="sxs-lookup"><span data-stu-id="ab33c-133">After it has received a collection, the presentation tier can use LINQ to Objects to query it if necessary.</span></span>  
  
 <span data-ttu-id="ab33c-134">При вставке данных уровень представления может создать новый объект и отправить его на средний уровень или указать среднему уровню создать объект на основе предоставленных им значений.</span><span class="sxs-lookup"><span data-stu-id="ab33c-134">When inserting data, the presentation tier can construct a new object and send it to the middle tier, or it can have the middle tier construct the object based on values that it provides.</span></span> <span data-ttu-id="ab33c-135">В общем случае извлечение и вставка данных в многоуровневых приложениях не сильно отличается от аналогичного процесса в двухуровневых приложениях.</span><span class="sxs-lookup"><span data-stu-id="ab33c-135">In general, retrieving and inserting data in n-tier applications does not differ much from the process in 2-tier applications.</span></span> <span data-ttu-id="ab33c-136">Дополнительные сведения см. в статьях [запросы к базе данных](querying-the-database.md) и [внесение и отправка изменений данных](making-and-submitting-data-changes.md).</span><span class="sxs-lookup"><span data-stu-id="ab33c-136">For more information, see [Querying the Database](querying-the-database.md) and [Making and Submitting Data Changes](making-and-submitting-data-changes.md).</span></span>  
  
## <a name="tracking-changes-for-updates-and-deletes"></a><span data-ttu-id="ab33c-137">Отслеживание изменений для обновления и удаления</span><span class="sxs-lookup"><span data-stu-id="ab33c-137">Tracking Changes for Updates and Deletes</span></span>  

 <span data-ttu-id="ab33c-138">Технология [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] поддерживает оптимистический параллелизм, основанный на отметках времени (также называемых RowVersions) или на исходных значениях.</span><span class="sxs-lookup"><span data-stu-id="ab33c-138">[!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] supports optimistic concurrency based on timestamps (also named RowVersions) and on original values.</span></span> <span data-ttu-id="ab33c-139">Если таблицам базы данных присвоены метки времени, то для операций обновления и удаления требуются некоторые дополнительные действия либо на среднем уровне, либо на уровне представления данных.</span><span class="sxs-lookup"><span data-stu-id="ab33c-139">If the database tables have timestamps, then updates and deletions require little extra work on either the middle-tier or presentation tier.</span></span> <span data-ttu-id="ab33c-140">Однако если для проверок на оптимистический параллелизм необходимо использовать исходные значения, то ответственность за отслеживание этих значений и отправку их обратно при выполнении обновлений лежит на уровне представления данных.</span><span class="sxs-lookup"><span data-stu-id="ab33c-140">However, if you must use original values for optimistic concurrency checks, then the presentation tier is responsible for tracking those values and sending them back when it makes updates.</span></span> <span data-ttu-id="ab33c-141">Причиной этого является тот факт, что изменения сущностей, выполненные на уровне представления данных, не отслеживаются на среднем уровне.</span><span class="sxs-lookup"><span data-stu-id="ab33c-141">This is because changes that were made to entities on the presentation tier are not tracked on the middle tier.</span></span> <span data-ttu-id="ab33c-142">В действительности, исходное извлечение сущности и окончательное его обновление обычно выполняется двумя совершенно различными экземплярами класса <xref:System.Data.Linq.DataContext>.</span><span class="sxs-lookup"><span data-stu-id="ab33c-142">In fact, the original retrieval of an entity, and the eventual update made to it are typically performed by two completely separate instances of the <xref:System.Data.Linq.DataContext>.</span></span>  
  
 <span data-ttu-id="ab33c-143">Чем больше количество изменений, выполненных на уровне представления данных, тем сложнее становится отслеживать эти изменения и отправлять их в пакетах обратно на средний уровень.</span><span class="sxs-lookup"><span data-stu-id="ab33c-143">The greater the number of changes that the presentation tier makes, the more complex it becomes to track those changes and package them back to the middle tier.</span></span> <span data-ttu-id="ab33c-144">Реализация механизма передачи изменений полностью зависит от приложения.</span><span class="sxs-lookup"><span data-stu-id="ab33c-144">The implementation of a mechanism for communicating changes is completely up to the application.</span></span> <span data-ttu-id="ab33c-145">Единственное требование заключается в том, что технологии [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] должны быть предоставлены исходные значений, которые необходимы для выполнения проверок на оптимистический параллелизм.</span><span class="sxs-lookup"><span data-stu-id="ab33c-145">The only requirement is that [!INCLUDE[vbtecdlinq](../../../../../../includes/vbtecdlinq-md.md)] must be given those original values that are required for optimistic concurrency checks.</span></span>  
  
 <span data-ttu-id="ab33c-146">Дополнительные сведения см. в статьях [Получение данных и операции CUD в N-уровневых приложениях (LINQ to SQL)](data-retrieval-and-cud-operations-in-n-tier-applications.md).</span><span class="sxs-lookup"><span data-stu-id="ab33c-146">For more information, see [Data Retrieval and CUD Operations in N-Tier Applications (LINQ to SQL)](data-retrieval-and-cud-operations-in-n-tier-applications.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ab33c-147">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="ab33c-147">See also</span></span>

- [<span data-ttu-id="ab33c-148">N-уровневые и удаленные приложения с LINQ to SQL</span><span class="sxs-lookup"><span data-stu-id="ab33c-148">N-Tier and Remote Applications with LINQ to SQL</span></span>](n-tier-and-remote-applications-with-linq-to-sql.md)
- <span data-ttu-id="ab33c-149">[Обзор серверного веб-элемента управления LinqDataSource](/previous-versions/aspnet/bb547113(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="ab33c-149">[LinqDataSource Web Server Control Overview](/previous-versions/aspnet/bb547113(v=vs.100))</span></span>
