---
title: Предоставление разрешений уровня строки в SQL Server
ms.date: 03/30/2017
ms.assetid: a55aaa12-34ab-41cd-9dec-fd255b29258c
ms.openlocfilehash: df5fcb4a6c73e12bec2ab17501fdfb02cf672324
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/07/2019
ms.locfileid: "70782351"
---
# <a name="granting-row-level-permissions-in-sql-server"></a>Предоставление разрешений уровня строки в SQL Server

В некоторых случаях требуется более точное управление доступом к данным, чем простое предоставление, отзыв или отклонение предоставленных разрешений. Например, в приложении базы данных больницы может требоваться ограничение доступа отдельных врачей, чтобы они имели доступ к сведениям только о своих пациентах. Подобные требования существуют во многих областях, включая финансовые, юридические, правительственные и военные приложения. SQL Server 2016 помогает реализовать эти сценарии, предоставляя функциональность [безопасности на уровне строк](/sql/relational-databases/security/row-level-security) , которая упрощает и централизует логику доступа на уровне строк в политике безопасности. В более ранних версиях SQL Server аналогичная функциональность достигается путем использования представлений для внедрения фильтрации на уровне строк.

## <a name="implementing-row-level-filtering"></a>Реализация фильтрации на уровне строк

Фильтрация на уровне строк используется для приложений, которые хранят сведения в одной таблице, как в приведенном выше примере приложения больницы. Для реализации фильтрации на уровне строк в каждой строке предусмотрен столбец, в котором задается отличительный параметр, например имя пользователя, метка или другой идентификатор. Вы создаете политику безопасности или представление на основе этой таблицы для фильтрации строк, к которым пользователь имеет доступ. Затем вы создаете параметризованные хранимые процедуры, контролирующие типы запросов, которые может выполнять пользователь.

В следующем примере показывается, как настроить фильтрацию на уровне строк на основе имени пользователя или имени для входа.

- Создайте таблицу и добавьте в нее столбец для хранения имени.

- Включите фильтрацию на уровне строк следующим образом.

  - Если вы используете SQL Server версии не ниже 2016 или [базу данных SQL Azure](https://docs.microsoft.com/azure/sql-database/), создайте политику безопасности, которая добавляет в таблицу предикат, ограничивающий возвращаемые строки теми, которые соответствуют либо текущему пользователю базы данных (с помощью встроенной функции CURRENT_USER()), либо текущему имени для входа (с помощью встроенной функции SUSER_SNAME()).

      ```sql
      CREATE SCHEMA Security
      GO

      CREATE FUNCTION Security.userAccessPredicate(@UserName sysname)
          RETURNS TABLE
          WITH SCHEMABINDING
      AS
          RETURN SELECT 1 AS accessResult
          WHERE @UserName = SUSER_SNAME()
      GO

      CREATE SECURITY POLICY Security.userAccessPolicy
          ADD FILTER PREDICATE Security.userAccessPredicate(UserName) ON dbo.MyTable,
          ADD BLOCK PREDICATE Security.userAccessPredicate(UserName) ON dbo.MyTable
      GO
      ```

  - При использовании версии SQL Server до 2016 аналогичную функциональность можно реализовать с помощью представления:

      ```sql
      CREATE VIEW vw_MyTable
      AS
          RETURN SELECT * FROM MyTable
          WHERE UserName = SUSER_SNAME()
      GO
      ```

- Создайте хранимые процедуры для выбора, вставки, обновления и удаления данных. Если фильтрация осуществляется с помощью политики безопасности, хранимые процедуры должны выполнять эти операции непосредственно в базовой таблице; если же фильтрация осуществляется с помощью представления, хранимые процедуры должны работать с представлением. Политика безопасности или представление будет автоматически фильтровать строки, возвращаемые или изменяемые по запросам пользователя, а хранимая процедура будет обеспечивать более жесткую границу безопасности, чтобы предотвратить прямой доступ пользователей через успешно выполняемые запросы, которые могут определять наличие отфильтрованных данных.

- Для хранимых процедур, которые вставляют данные, получайте имя пользователя при помощи той же функции, которая указана в политике безопасности или в представлении, и вставляйте это значение в столбец UserName.

- Запретите роли `public` всякий доступ к таблицам (и представлениям, если они применяются). Пользователи не смогут наследовать права доступа от других ролей базы данных, поскольку предикат фильтра основан на имени пользователя или имени для входа, а не на ролях.

- Предоставьте ролям базы данных право доступа EXECUTE для хранимых процедур. Пользователи смогут иметь доступ к данным только через предоставленные хранимые процедуры.

## <a name="see-also"></a>См. также

- [Безопасность на уровне строк](/sql/relational-databases/security/row-level-security)
- [Защита приложений ADO.NET](../securing-ado-net-applications.md)
- [Общие сведения о безопасности SQL Server](overview-of-sql-server-security.md)
- [Сценарии безопасности приложений в SQL Server](application-security-scenarios-in-sql-server.md)
- [Управление разрешениями с использованием хранимых процедур в SQL Server](managing-permissions-with-stored-procedures-in-sql-server.md)
- [Написание безопасного динамического кода SQL в SQL Server](writing-secure-dynamic-sql-in-sql-server.md)
- [Общие сведения об ADO.NET](../ado-net-overview.md)
