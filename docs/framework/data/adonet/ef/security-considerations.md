---
title: Вопросы безопасности (Entity Framework)
ms.date: 03/30/2017
ms.assetid: 84758642-9b72-4447-86f9-f831fef46962
ms.openlocfilehash: 1e3c1f74c1bf30da47fb38b6799bff11090cf31a
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62033973"
---
# <a name="security-considerations-entity-framework"></a>Вопросы безопасности (Entity Framework)
В этом разделе приводятся сведения по безопасности, связанные с разработкой, развертыванием и запуском приложений [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)]. Необходимо также следовать инструкциям по созданию безопасных приложений [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)]. Дополнительные сведения см. в разделе [Общие сведения о безопасности](../../../../../docs/framework/data/adonet/security-overview.md).  
  
## <a name="general-security-considerations"></a>Общие соображения безопасности  
 Следующие вопросы безопасности актуальны для всех приложений [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
#### <a name="use-only-trusted-data-source-providers"></a>Использование только доверенных поставщиков источников данных.  
 Для обеспечения связи с источником данных поставщик должен выполнить следующие действия:  
  
- получить строку соединения от [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)];  
  
- перевести дерево команд на собственный язык запросов источника данных;  
  
- собрать и возвратить результирующие наборы.  
  
 Во время операции входа в систему сведения, полученные с помощью пароля пользователя, передаются на сервер через сетевые библиотеки базового источника данных. Злонамеренный поставщик может похитить учетные данные пользователя, сформировать вредоносные запросы или внести несанкционированные изменения в результирующий набор.  
  
#### <a name="encrypt-your-connection-to-protect-sensitive-data"></a>Шифрование соединения для защиты конфиденциальных данных  
 В [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] непосредственно не выполняется шифрование данных. Если пользователи получают доступ к данным через открытую сеть, то в приложении для повышения безопасности необходимо устанавливать зашифрованное соединение с источником данных. Дополнительные сведения см. в документации источника данных, связанной с безопасностью. Для источника данных SQL Server, см. в разделе [шифрование соединений с SQL Server](https://go.microsoft.com/fwlink/?LinkId=119544).  
  
#### <a name="secure-the-connection-string"></a>Защита строки соединения  
 Защита доступа к источникам данным - одна из важнейших целей защиты приложения. Строка соединения потенциально уязвима, если не защищена или не сформирована должным образом. Хранение сведений о соединении в виде простого текста или хранение их в памяти представляет угрозу безопасности для всей системы. Ниже представлены рекомендуемые методы защиты строки соединения.  
  
- При соединении с источником данных SQL Server используйте проверку подлинности Windows.  
  
     При использовании проверки подлинности Windows для соединения с источником данных SQL Server строка соединения не содержит сведений об имени входа и пароле.  
  
- Шифрование разделов файла конфигурации с использованием защищенной конфигурации.  
  
     В ASP.NET 2.0 предоставляется возможность, известная как защищенная конфигурация, которая позволяет шифровать конфиденциальные сведения в файле конфигурации. Безусловно, защищенная конфигурация разрабатывалась в первую очередь для ASP.NET, но ее можно также использовать для шифрования разделов файлов конфигурации в приложениях Windows. Подробное описание новых возможностей защищенной конфигурации, см. в разделе [шифрование конфигурации сведения с помощью защищенной конфигурации](https://docs.microsoft.com/previous-versions/aspnet/53tyfkaw(v=vs.100)).  
  
- Хранение строк соединения в защищенных файлах конфигурации.  
  
     Строку соединения ни в коем случае нельзя внедрять в исходный код. Строки соединения можно хранить в файлах конфигурации, что исключает необходимость внедрять их в код приложения. По умолчанию мастер моделей EDM хранит строки соединения в файле конфигурации приложения. Этот файл необходимо защитить от несанкционированного доступа.  
  
- Использование построителей строки соединения при динамическом создании соединений.  
  
     Если строки соединения необходимо конструировать во время выполнения, используется класс <xref:System.Data.EntityClient.EntityConnectionStringBuilder>. Этот класс построителя строк соединения помогает предотвратить атаки внедрения кода путем проверки входных данных и экранирования недопустимых данных. Дополнительные сведения см. в разделе [Как Построить строку соединения EntityConnection](../../../../../docs/framework/data/adonet/ef/how-to-build-an-entityconnection-connection-string.md). Соответствующий класс построителя используется также для создания строки подключения источника данных, который является частью [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] строку подключения. Сведения о построителях строк соединения для поставщиков ADO.NET см. в разделе [построители строк подключения](../../../../../docs/framework/data/adonet/connection-string-builders.md).  
  
 Дополнительные сведения см. в разделе [Защита сведений о подключении](../../../../../docs/framework/data/adonet/protecting-connection-information.md).  
  
#### <a name="do-not-expose-an-entityconnection-to-untrusted-users"></a>Не следует предоставлять доступ к объекту EntityConnection пользователям, не заслуживающим доверия  
 Объект <xref:System.Data.EntityClient.EntityConnection> отображает строку соединения базового соединения. Пользователь, получивший доступ к объекту <xref:System.Data.EntityClient.EntityConnection>, может также изменить <xref:System.Data.ConnectionState> базового соединения. Класс <xref:System.Data.EntityClient.EntityConnection> не является потокобезопасным.  
  
#### <a name="do-not-pass-connections-outside-the-security-context"></a>Не следует передавать соединения за пределы контекста безопасности  
 После установки соединения его нельзя передавать за пределы контекста безопасности. Например, один поток с разрешением открыть соединение не должен хранить это соединение в глобальном местоположении. Если соединение доступно в глобальном местонахождении, то другой вредоносный поток может использовать открытое соединение, не имея на это явно предоставленного разрешения.  
  
#### <a name="be-aware-that-logon-information-and-passwords-may-be-visible-in-a-memory-dump"></a>Следует учитывать, что сведения о входе в систему и пароли могут быть обнаружены в дампе памяти  
 Если данные о входе в систему и пароль передаются в строке соединения, эти сведения хранятся в памяти до тех пор, пока операция сборки мусора не освободит ресурсы. В результате этого становится невозможным определение того, с какого момента строка пароля перестает находиться в памяти. После сбоя приложения файл дампа памяти может содержать конфиденциальные данные, а возможность просматривать этот файл дампа памяти способен получить пользователь, эксплуатирующий это приложение, а также любой другой пользователь с административным доступом к компьютеру. Для соединения с Microsoft SQL Server используйте проверку подлинности Windows.  
  
#### <a name="grant-users-only-the-necessary-permissions-in-the-data-source"></a>Предоставление пользователям только необходимых разрешений на доступ к источнику данных  
 Администратор источника данных должен предоставлять пользователям только необходимые разрешения. Язык [!INCLUDE[esql](../../../../../includes/esql-md.md)] не поддерживает такие инструкции DML изменяющие данные, как INSERT, UPDATE или DELETE; тем не менее пользователи могут получить доступ к соединению с источником данных. Злонамеренный пользователь может с помощью этого соединения выполнять инструкции DML на собственном языке источника данных.  
  
#### <a name="run-applications-with-the-minimum-permissions"></a>Запуск приложения с минимально возможными разрешениями  
 Если разрешена эксплуатация управляемого приложения с полным набором разрешений, то [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)] не ограничивает доступ этого приложения к компьютеру. Это может стать предпосылкой появления в приложении потенциально уязвимого места, что представляет угрозу для всей системы. Чтобы использовать средства управления доступом к коду и другие механизмы безопасности в [!INCLUDE[dnprdnshort](../../../../../includes/dnprdnshort-md.md)], следует запускать приложения с использованием частичного уровня доверия и с минимальным набором разрешений, необходимым для выполнения всех задач приложения. Ниже приведены минимальные разрешения, необходимые для работы приложения [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
- <xref:System.Security.Permissions.FileIOPermission>. Разрешение <xref:System.Security.Permissions.FileIOPermissionAccess.Write> на открытие заданных файлов метаданных или разрешение <xref:System.Security.Permissions.FileIOPermissionAccess.PathDiscovery> на поиск в каталоге файлов метаданных.  
  
- <xref:System.Security.Permissions.ReflectionPermission>. Разрешение <xref:System.Security.Permissions.ReflectionPermissionFlag.RestrictedMemberAccess> на поддержку запросов LINQ to Entities.  
  
- <xref:System.Transactions.DistributedTransactionPermission>. Разрешение <xref:System.Security.Permissions.PermissionState.Unrestricted> на участие в транзакции <xref:System.Transactions><xref:System.Transactions.Transaction>.  
  
- <xref:System.Security.Permissions.SecurityPermission>. Разрешение <xref:System.Security.Permissions.SecurityPermissionFlag.SerializationFormatter> на сериализацию исключений с помощью интерфейса <xref:System.Runtime.Serialization.ISerializable>.  
  
- Разрешение на открытие подключения к базе данных и выполнения команд в базе данных, таких как <xref:System.Data.SqlClient.SqlClientPermission> для базы данных SQL Server.  
  
 Для получения дополнительной информации см. [Code Access Security and ADO.NET](../../../../../docs/framework/data/adonet/code-access-security.md).  
  
#### <a name="do-not-install-untrusted-applications"></a>Не устанавливайте приложения, не заслуживающие доверия  
 Платформа [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не требует применения каких-либо прав доступа и вызовет любой объектный код в процессе, переданный пользователем, независимо от того, надежен он или нет Убедитесь, что проверка подлинности и авторизация клиента выполняются хранилищем данных и приложением.  
  
#### <a name="restrict-access-to-all-configuration-files"></a>Ограничьте доступ ко всем файлам конфигурации  
 Администратор должен ограничить доступ на запись для всех файлов, в которых указывается Конфигурация приложения, в том числе enterprisesec.config, security.config, machine.conf, и файл конфигурации приложения \< *приложения* >. exe.config.  
  
 В файле app.config можно указать другое значение неизменяемого имени поставщика. Клиентское приложение должно обеспечивать доступ к базовому поставщику через фабричную модель стандартного поставщика с использованием строгого имени.  
  
#### <a name="restrict-permissions-to-the-model-and-mapping-files"></a>Ограничьте разрешения на файлы модели и сопоставления.  
 Администратор должен предоставлять доступ для записи к файлам модели и сопоставления (EDMX-файлы, CSDL-файлы, SSDL-файлы и MSL-файлы) только тем пользователям, которые изменяют модель или сопоставления. [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] Требуется только доступ на чтение к этим файлам во время выполнения. Администратор должен также ограничить доступ к уровню объектов и предварительно компилируемым файлам просмотра исходного кода, которые формируются средствами [!INCLUDE[adonet_edm](../../../../../includes/adonet-edm-md.md)].  
  
## <a name="security-considerations-for-queries"></a>Вопросы безопасности применительно к запросам  
 При запросах к концептуальной модели применимы следующие рекомендации по безопасности. Эти рекомендации по безопасности применимы к запросам [!INCLUDE[esql](../../../../../includes/esql-md.md)], использующим EntityClient, и к объектным запросам, использующим LINQ, [!INCLUDE[esql](../../../../../includes/esql-md.md)] и методы построителя запросов.  
  
#### <a name="prevent-sql-injection-attacks"></a>Предотвращение атак путем внедрения кода SQL  
 Приложения часто получают внешние входные данные (от пользователя или другого внешнего агента) и выполняют действия над этими входными данными. Любые входные данные, прямо или косвенно полученные от пользователя или внешнего агента, могут иметь содержимое, в котором используется синтаксис целевого языка для выполнения несанкционированных действий. Если целевым языком является один из диалектов языка SQL, например [!INCLUDE[tsql](../../../../../includes/tsql-md.md)], такие действия называются атакой путем внедрения кода SQL. Злонамеренный пользователь может внедрить данные непосредственно в запрос и удалить таблицу базы данных, вызвать отказ в обслуживании или другим образом изменить характер выполняемой операции.  
  
- Атаки путем внедрения кода [!INCLUDE[esql](../../../../../includes/esql-md.md)]:  
  
     Атаки путем внедрения кода SQL осуществляются на языке [!INCLUDE[esql](../../../../../includes/esql-md.md)] путем предоставления вредоносных входных значений в составе предикатов запросов и имен параметров. Для предотвращения атак путем внедрения кода SQL ни в коем случае нельзя объединять входные данные пользователя с текстом команд [!INCLUDE[esql](../../../../../includes/esql-md.md)].  
  
     Запросы [!INCLUDE[esql](../../../../../includes/esql-md.md)] принимают параметры во всех случаях, где допускаются литералы. Необходимо использовать параметризованные запросы, а не внедрять литералы, полученные от внешних агентов, непосредственно в запрос. Также можно использовать [методы построителя запросов](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bb896238(v=vs.100)) для безопасного создания Entity SQL.  
  
- Атаки путем внедрения кода [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)]:  
  
     Хотя в [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] допустима композиция запросов, она выполняется через API объектной модели. В отличие от запросов [!INCLUDE[esql](../../../../../includes/esql-md.md)] запросы [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] не строятся с помощью манипулирования строками или объединения строк, поэтому не подвержены обычным атакам путем внедрения кода SQL.  
  
#### <a name="prevent-very-large-result-sets"></a>Предотвращение создания очень больших результирующих наборов  
 Слишком большой результирующий набор может вызвать завершение работы клиентской системы, если клиент выполняет операции, для которых потребность в ресурсах пропорциональна размеру результирующего набора. Непредвиденное появление больших результирующих наборов может происходить при следующих условиях:  
  
- в запросах к большим базам данных, не включающих соответствующих условий фильтрации;  
  
- в запросах, создающих декартовы соединения на сервере;  
  
- во вложенных запросах [!INCLUDE[esql](../../../../../includes/esql-md.md)].  
  
 Принимая ввод от пользователя, необходимо убедиться в том, что входные данные не могут привести к созданию слишком больших результирующих наборов, которые не сможет обработать система. Можно также использовать <xref:System.Linq.Queryable.Take%2A> метод в [!INCLUDE[linq_entities](../../../../../includes/linq-entities-md.md)] или [ограничение](../../../../../docs/framework/data/adonet/ef/language-reference/limit-entity-sql.md) оператор в [!INCLUDE[esql](../../../../../includes/esql-md.md)] для ограничения размера результирующего набора.  
  
#### <a name="avoid-returning-iqueryable-results-when-exposing-methods-to-potentially-untrusted-callers"></a>Старайтесь не возвращать результаты IQueryable, если методы доступны потенциально ненадежным вызывающим объектам.  
 Старайтесь не возвращать типы <xref:System.Linq.IQueryable%601> из методов, которые доступны потенциально ненадежным вызывающим объектам, по следующим причинам.  
  
- Объект-получатель запроса, обеспечивающего доступ к типу <xref:System.Linq.IQueryable%601>, может вызвать метод, предоставляющий доступ к защищенным данным или увеличивающий размер результирующего набора. Например, рассмотрим следующую сигнатуру метода.  
  
    ```  
    public IQueryable<Customer> GetCustomer(int customerId)  
    ```  
  
     Объект-получатель этого запроса может вызвать метод `.Include("Orders")`, возвращающий `IQueryable<Customer>`, по которому можно извлечь данные, доступ к которым через этот запрос не планировался. Этого можно избежать, если изменить тип возвращаемого значения метода на <xref:System.Collections.Generic.IEnumerable%601> и вызвать метод (например, `.ToList()`) для материализации результатов.  
  
- Поскольку запросы <xref:System.Linq.IQueryable%601> выполняются при переборе результатов, объект-получатель запроса, обеспечивающего доступ к типу <xref:System.Linq.IQueryable%601>, может обработать возникшие исключения. Исключения могут содержать информацию, не предназначенную объекту-получателю.  
  
## <a name="security-considerations-for-entities"></a>Вопросы безопасности применительно к сущностям  
 Следующие рекомендации по безопасности применимы при формировании типов сущностей и работе с ними.  
  
#### <a name="do-not-share-an-objectcontext-across-application-domains"></a>Не следует совместно использовать контекст ObjectContext во всех доменах приложений  
 Совместное использование <xref:System.Data.Objects.ObjectContext> в нескольких доменах приложений может создать предпосылки получения доступа к данным в строке соединения. Вместо этого следует передать сериализованные объекты или графы объектов в домен другого приложения, а затем присоединить эти объекты к <xref:System.Data.Objects.ObjectContext> в этом домене приложения. Дополнительные сведения см. в разделе [сериализация объектов](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/bb738446(v=vs.100)).  
  
#### <a name="prevent-type-safety-violations"></a>Предотвращение нарушений безопасности типов  
 При нарушении безопасности типов [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не может гарантировать целостность данных в объектах. Нарушения безопасности типов могут происходить, если разрешается эксплуатация ненадежных приложений с полным уровнем доверия для управления доступом для кода.  
  
#### <a name="handle-exceptions"></a>Обработка исключений.  
 Доступ к методам и свойствам <xref:System.Data.Objects.ObjectContext> в блоке try-catch. Обработка исключений предотвращает их попадание в пользовательское приложение, и поэтому пользователи приложения не смогут получить доступ к записям в <xref:System.Data.Objects.ObjectStateManager> или к данным модели (например, именам таблиц).  
  
## <a name="security-considerations-for-aspnet-applications"></a>Вопросы безопасности применительно к приложениям ASP.NET  
 При работе с приложениями [!INCLUDE[vstecasp](../../../../../includes/vstecasp-md.md)] необходимо учитывать следующее.  
  
#### <a name="verify-whether-your-host-performs-path-checks"></a>Убедиться в том, что узел выполняет проверку путей  
 Если используется строка подстановки `|DataDirectory|` (заключенная в символы вертикальной черты), то [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] проверяет, поддерживается ли путь, полученный путем преобразования этой строки. Например, недопустима подстрока ".." после `DataDirectory`. Та же проверка преобразования оператора задания корневого каталога веб-приложения (`~`) выполняется процессом, предоставляющим услуги размещения [!INCLUDE[vstecasp](../../../../../includes/vstecasp-md.md)]. Эту проверку выполняют службы IIS, однако узлы, отличные от IIS, могут не проверять, поддерживается ли преобразованный путь. Необходимо знать, как действует узел, на котором развертывается приложение [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].  
  
#### <a name="do-not-make-assumptions-about-resolved-path-names"></a>Не следует делать предположений в отношении преобразованных имен путей  
 Безусловно, значения, в которые преобразуются оператор задания корневого каталога (`~`) и строка подстановки `DataDirectory`, должны оставаться неизменными во время выполнения приложения, но [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] не налагает ограничения на изменение узлом этих значений.  
  
#### <a name="verify-the-path-length-before-deployment"></a>Проверить длину пути перед развертыванием.  
 Перед развертыванием приложения [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] необходимо убедиться, что значения оператора задания корневого каталога (~) и строки подстановки `DataDirectory` не превышают ограничений, налагаемых операционной системой на длину пути. Поставщики данных [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] не гарантируют того, что длина пути останется в допустимых пределах.  
  
## <a name="security-considerations-for-adonet-metadata"></a>Вопросы безопасности применительно к метаданным ADO.NET  
 При формировании и работе с файлами модели и сопоставления применимы следующие рекомендации по безопасности.  
  
#### <a name="do-not-expose-sensitive-information-through-logging"></a>Не следует представлять доступ к конфиденциальным сведениям с помощью средств ведения журнала  
 Служебные компоненты метаданных [!INCLUDE[vstecado](../../../../../includes/vstecado-md.md)] не записывают в журнал конфиденциальные сведения. Если имеются результаты, которые не удается возвратить из-за ограничений доступа, то системы управления базами данных и файловые системы должны возвращать нулевой результат, а не активизировать исключение, которое может содержать конфиденциальные данные.  
  
#### <a name="do-not-accept-metadataworkspace-objects-from-untrusted-sources"></a>Не следует принимать объекты MetadataWorkspace из ненадежных источников  
 Приложения не должны принимать экземпляры объектов класса <xref:System.Data.Metadata.Edm.MetadataWorkspace> из ненадежных источников. Вместо этого необходимо явно создать и заполнить рабочую область из такого источника.  
  
## <a name="see-also"></a>См. также

- [Защита приложений ADO.NET](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)
- [Требования к развертыванию](../../../../../docs/framework/data/adonet/ef/deployment-considerations.md)
- [Вопросы миграции](../../../../../docs/framework/data/adonet/ef/migration-considerations.md)
