---
title: Компилированные запросы (LINQ to Entities)
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 8025ba1d-29c7-4407-841b-d5a3bed40b7a
ms.openlocfilehash: d4101eae755ac698d4cef5b2e1334d01e02c3e35
ms.sourcegitcommit: 957c49696eaf048c284ef8f9f8ffeb562357ad95
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/07/2020
ms.locfileid: "82895421"
---
# <a name="compiled-queries--linq-to-entities"></a><span data-ttu-id="a723f-102">Компилированные запросы (LINQ to Entities)</span><span class="sxs-lookup"><span data-stu-id="a723f-102">Compiled Queries  (LINQ to Entities)</span></span>
<span data-ttu-id="a723f-103">Если приложение многократно выполняет похожие по структуре запросы на платформе Entity Framework, во многих случаях можно повысить производительность, скомпилировав запрос один раз, а затем выполняя его несколько раз с разными параметрами.</span><span class="sxs-lookup"><span data-stu-id="a723f-103">When you have an application that executes structurally similar queries many times in the Entity Framework, you can frequently increase performance by compiling the query one time and executing it several times with different parameters.</span></span> <span data-ttu-id="a723f-104">Например, приложению может понадобиться получить всех клиентов из определенного города; имя города указывается пользователем во время выполнения с помощью формы.</span><span class="sxs-lookup"><span data-stu-id="a723f-104">For example, an application might have to retrieve all the customers in a particular city; the city is specified at runtime by the user in a form.</span></span> <span data-ttu-id="a723f-105">Для этих целей технология LINQ to Entities поддерживает использование скомпилированных запросов.</span><span class="sxs-lookup"><span data-stu-id="a723f-105">LINQ to Entities supports using compiled queries for this purpose.</span></span>  
  
 <span data-ttu-id="a723f-106">Начиная с версии 4.5 платформы .NET Framework, запросы LINQ кэшируются автоматически.</span><span class="sxs-lookup"><span data-stu-id="a723f-106">Starting with the .NET Framework 4.5, LINQ queries are cached automatically.</span></span> <span data-ttu-id="a723f-107">Тем не менее можно использовать скомпилированные запросы LINQ для снижения затрат при последующем выполнении, и скомпилированные запросы могут быть более эффективными, чем запросы LINQ, которые автоматически сохраняются в кэше.</span><span class="sxs-lookup"><span data-stu-id="a723f-107">However, you can still use compiled LINQ queries to reduce this cost in later executions and compiled queries can be more efficient than LINQ queries that are automatically cached.</span></span> <span data-ttu-id="a723f-108">Обратите внимание, что запросы LINQ to Entities, которые применяют оператор `Enumerable.Contains` к коллекции в памяти, автоматически не кэшируются.</span><span class="sxs-lookup"><span data-stu-id="a723f-108">Note that LINQ to Entities queries that apply the `Enumerable.Contains` operator to in-memory collections are not automatically cached.</span></span> <span data-ttu-id="a723f-109">Также в скомпилированных запросах LINQ не допускаются коллекции в памяти с параметрами.</span><span class="sxs-lookup"><span data-stu-id="a723f-109">Also parameterizing in-memory collections in compiled LINQ queries is not allowed.</span></span>  
  
 <span data-ttu-id="a723f-110">Класс <xref:System.Data.Objects.CompiledQuery> обеспечивает компиляцию и кэширование запросов для повторного использования.</span><span class="sxs-lookup"><span data-stu-id="a723f-110">The <xref:System.Data.Objects.CompiledQuery> class provides compilation and caching of queries for reuse.</span></span> <span data-ttu-id="a723f-111">Концептуально данный класс содержит метод <xref:System.Data.Objects.CompiledQuery>`Compile` с несколькими перегрузками.</span><span class="sxs-lookup"><span data-stu-id="a723f-111">Conceptually, this class contains a <xref:System.Data.Objects.CompiledQuery>'s `Compile` method with several overloads.</span></span> <span data-ttu-id="a723f-112">Вызовите метод `Compile`, чтобы создать новый делегат, для представления скомпилированного запроса.</span><span class="sxs-lookup"><span data-stu-id="a723f-112">Call the `Compile` method to create a new delegate to represent the compiled query.</span></span> <span data-ttu-id="a723f-113">Метод `Compile`, которому предоставляют контекст <xref:System.Data.Objects.ObjectContext> и значения параметров, возвращает делегата, который формирует определенный результат (например, экземпляр <xref:System.Linq.IQueryable%601>).</span><span class="sxs-lookup"><span data-stu-id="a723f-113">The `Compile` methods, provided with a <xref:System.Data.Objects.ObjectContext> and parameter values, return a delegate that produces some result (such as an <xref:System.Linq.IQueryable%601> instance).</span></span> <span data-ttu-id="a723f-114">Компиляция запроса выполняется только один раз во время первого выполнения.</span><span class="sxs-lookup"><span data-stu-id="a723f-114">The query compiles once during only the first execution.</span></span> <span data-ttu-id="a723f-115">Параметры слияния, которые заданы для запроса во время компиляции, далее не могут быть изменены.</span><span class="sxs-lookup"><span data-stu-id="a723f-115">The merge options set for the query at the time of the compilation cannot be changed later.</span></span> <span data-ttu-id="a723f-116">После компиляции запроса ему можно передавать только параметры примитивного типа, но нельзя заменять части запроса, которые изменят созданный код SQL.</span><span class="sxs-lookup"><span data-stu-id="a723f-116">Once the query is compiled you can only supply parameters of primitive type but you cannot replace parts of the query that would change the generated SQL.</span></span> <span data-ttu-id="a723f-117">Дополнительные сведения см. в разделе [Параметры слияния EF и скомпилированные запросы](https://docs.microsoft.com/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries).</span><span class="sxs-lookup"><span data-stu-id="a723f-117">For more information, see [EF Merge Options and Compiled Queries](https://docs.microsoft.com/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries).</span></span>
  
 <span data-ttu-id="a723f-118">LINQ to Entities выражение запроса, <xref:System.Data.Objects.CompiledQuery>которое компилируется `Compile` методом, представлено одним из универсальных `Func` методов-делегатов, таких <xref:System.Func%605>как.</span><span class="sxs-lookup"><span data-stu-id="a723f-118">The LINQ to Entities query expression that the <xref:System.Data.Objects.CompiledQuery>'s `Compile` method compiles is represented by one of the generic `Func` delegates, such as <xref:System.Func%605>.</span></span> <span data-ttu-id="a723f-119">Выражение запроса может инкапсулировать не более одного параметра `ObjectContext`, одного возвращаемого параметра и 16 параметров запроса.</span><span class="sxs-lookup"><span data-stu-id="a723f-119">At most, the query expression can encapsulate an `ObjectContext` parameter, a return parameter, and 16 query parameters.</span></span> <span data-ttu-id="a723f-120">Если нужно больше 16 параметров запроса, то можно создать структуру, свойства которой будут соответствовать параметрам запроса.</span><span class="sxs-lookup"><span data-stu-id="a723f-120">If more than 16 query parameters are required, you can create a structure whose properties represent query parameters.</span></span> <span data-ttu-id="a723f-121">После задания свойств ими можно будет воспользоваться в выражении запроса из структуры.</span><span class="sxs-lookup"><span data-stu-id="a723f-121">You can then use the properties on the structure in the query expression after you set the properties.</span></span>  
  
## <a name="example-1"></a><span data-ttu-id="a723f-122">Пример 1</span><span class="sxs-lookup"><span data-stu-id="a723f-122">Example 1</span></span>  
 <span data-ttu-id="a723f-123">В следующем примере компилируется и вызывается запрос, принимающий входной параметр типа <xref:System.Decimal> и возвращающий последовательность заказов, сумма заказа которых больше или равна 200 долларам США:</span><span class="sxs-lookup"><span data-stu-id="a723f-123">The following example compiles and then invokes a query that accepts a <xref:System.Decimal> input parameter and returns a sequence of orders where the total due is greater than or equal to $200.00:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery2](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery2)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery2](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery2)]  
  
## <a name="example-2"></a><span data-ttu-id="a723f-124">Пример 2</span><span class="sxs-lookup"><span data-stu-id="a723f-124">Example 2</span></span>  
 <span data-ttu-id="a723f-125">В следующем примере компилируется и вызывается запрос, возвращающий экземпляр элемента <xref:System.Data.Objects.ObjectQuery%601>:</span><span class="sxs-lookup"><span data-stu-id="a723f-125">The following example compiles and then invokes a query that returns an <xref:System.Data.Objects.ObjectQuery%601> instance:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery1_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery1_mq)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery1_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery1_mq)]  
  
## <a name="example-3"></a><span data-ttu-id="a723f-126">Пример 3</span><span class="sxs-lookup"><span data-stu-id="a723f-126">Example 3</span></span>  
 <span data-ttu-id="a723f-127">В следующем примере компилируется и затем вызывается запрос, возвращающий среднее значение цен списка продуктов в виде значения <xref:System.Decimal>:</span><span class="sxs-lookup"><span data-stu-id="a723f-127">The following example compiles and then invokes a query that returns the average of the product list prices as a <xref:System.Decimal> value:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery3_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery3_mq)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery3_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery3_mq)]  
  
## <a name="example-4"></a><span data-ttu-id="a723f-128">Пример 4</span><span class="sxs-lookup"><span data-stu-id="a723f-128">Example 4</span></span>  
 <span data-ttu-id="a723f-129">В следующем примере компилируется и затем вызывается запрос, который принимает <xref:System.String> входной параметр, а затем возвращает объект `Contact` , адрес электронной почты которого начинается с указанной строки:</span><span class="sxs-lookup"><span data-stu-id="a723f-129">The following example compiles and then invokes a query that accepts a <xref:System.String> input parameter and then returns a `Contact` whose email address starts with the specified string:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery4_MQ](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery4_mq)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery4_MQ](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery4_mq)]  
  
## <a name="example-5"></a><span data-ttu-id="a723f-130">Пример 5</span><span class="sxs-lookup"><span data-stu-id="a723f-130">Example 5</span></span>  
 <span data-ttu-id="a723f-131">В следующем примере компилируется и вызывается запрос, который принимает входные параметры <xref:System.DateTime> и <xref:System.Decimal> и возвращает последовательность заказов с датой позднее 8 марта 2003 г. и суммой заказа менее 300 долларов:</span><span class="sxs-lookup"><span data-stu-id="a723f-131">The following example compiles and then invokes a query that accepts <xref:System.DateTime> and <xref:System.Decimal> input parameters and returns a sequence of orders where the order date is later than March 8, 2003, and the total due is less than $300.00:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery5](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery5)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery5](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery5)]  
  
## <a name="example-6"></a><span data-ttu-id="a723f-132">Пример 6.</span><span class="sxs-lookup"><span data-stu-id="a723f-132">Example 6</span></span>  
 <span data-ttu-id="a723f-133">В следующем примере компилируется и вызывается запрос, принимающий входной параметр типа <xref:System.DateTime> и возвращающий последовательность заказов с датой после 8 марта 2004 г.</span><span class="sxs-lookup"><span data-stu-id="a723f-133">The following example compiles and then invokes a query that accepts a <xref:System.DateTime> input parameter and returns a sequence of orders where the order date is later than March 8, 2004.</span></span> <span data-ttu-id="a723f-134">Этот запрос возвращает сведения о заказе в виде последовательности анонимных типов.</span><span class="sxs-lookup"><span data-stu-id="a723f-134">This query returns the order information as a sequence of anonymous types.</span></span> <span data-ttu-id="a723f-135">Анонимные типы выводятся компилятором, поэтому параметры типа нельзя указать в методе <xref:System.Data.Objects.CompiledQuery>`Compile` и тип определяется в самом запросе.</span><span class="sxs-lookup"><span data-stu-id="a723f-135">Anonymous types are inferred by the compiler, so you cannot specify type parameters in the <xref:System.Data.Objects.CompiledQuery>'s `Compile` method and the type is defined in the query itself.</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery6](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery6)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery6](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery6)]  
  
## <a name="example-7"></a><span data-ttu-id="a723f-136">Пример 7</span><span class="sxs-lookup"><span data-stu-id="a723f-136">Example 7</span></span>  
 <span data-ttu-id="a723f-137">В следующем примере компилируется и вызывается запрос, принимающий входной параметр в виде пользовательской структуры и возвращающий последовательность заказов.</span><span class="sxs-lookup"><span data-stu-id="a723f-137">The following example compiles and then invokes a query that accepts a user-defined structure input parameter and returns a sequence of orders.</span></span> <span data-ttu-id="a723f-138">В структуре определяются такие параметры запроса, как время начала, окончания и общая сумма заказа, а запрос возвращает заказы, поставленные с 3 по 8 марта 2003 г. общей суммой более 700 долларов США.</span><span class="sxs-lookup"><span data-stu-id="a723f-138">The structure defines start date, end date, and total due query parameters, and the query returns orders shipped between March 3 and March 8, 2003 with a total due greater than $700.00.</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#CompiledQuery7](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#compiledquery7)]
 [!code-vb[DP L2E Conceptual Examples#CompiledQuery7](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#compiledquery7)]  
  
 <span data-ttu-id="a723f-139">Структура, определяющая параметры запроса:</span><span class="sxs-lookup"><span data-stu-id="a723f-139">The structure that defines the query parameters:</span></span>  
  
 [!code-csharp[DP L2E Conceptual Examples#MyParamsStruct](../../../../../../samples/snippets/csharp/VS_Snippets_Data/DP L2E Conceptual Examples/CS/Program.cs#myparamsstruct)]
 [!code-vb[DP L2E Conceptual Examples#MyParamsStruct](../../../../../../samples/snippets/visualbasic/VS_Snippets_Data/DP L2E Conceptual Examples/VB/Module1.vb#myparamsstruct)]  
  
## <a name="see-also"></a><span data-ttu-id="a723f-140">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="a723f-140">See also</span></span>

- [<span data-ttu-id="a723f-141">ADO.NET Entity Framework</span><span class="sxs-lookup"><span data-stu-id="a723f-141">ADO.NET Entity Framework</span></span>](../index.md)
- [<span data-ttu-id="a723f-142">LINQ to Entities</span><span class="sxs-lookup"><span data-stu-id="a723f-142">LINQ to Entities</span></span>](linq-to-entities.md)
- [<span data-ttu-id="a723f-143">Параметры слияния EF и скомпилированные запросы</span><span class="sxs-lookup"><span data-stu-id="a723f-143">EF Merge Options and Compiled Queries</span></span>](https://docs.microsoft.com/archive/blogs/dsimmons/ef-merge-options-and-compiled-queries)
