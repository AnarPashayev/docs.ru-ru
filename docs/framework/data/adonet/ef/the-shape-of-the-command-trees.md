---
title: Форма деревьев команд
ms.date: 03/30/2017
ms.assetid: 2215585e-ca47-45f8-98d4-8cb982f8c1d3
ms.openlocfilehash: 08a67c8d181188cbc14c6f60876a7e26cd6de25a
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/22/2019
ms.locfileid: "59980087"
---
# <a name="the-shape-of-the-command-trees"></a>Форма деревьев команд

Модуль создания кода SQL отвечает за создание кода SQL, зависящего от конкретного сервера запроса, на основе данного входного выражения дерева команд запроса. В этом разделе описываются характеристики, свойства и структура деревьев команд запроса.

## <a name="query-command-trees-overview"></a>Общие сведения о деревьях команд запроса

Дерево команд запроса является представлением объектной модели запроса. Деревья команд запроса используются для двух целей.

- Представление входного запроса, который задан по отношению к [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)].

- Представление выходного запроса, который передается поставщику и описывает запрос по отношению к серверу базы данных.

Деревья команд запроса поддерживают более развитую семантику по сравнению с запросами, совместимыми с SQL:1999, включая поддержку работы с вложенными коллекциями и операциями типа, такими как проверка того, имеет ли сущность конкретный тип, или фильтрации наборов с учетом типа.

Свойство DBQueryCommandTree.Query является корнем дерева выражения, которое описывает логику запроса. Свойство DBQueryCommandTree.Parameters содержит список параметров, которые используются в запросе. Дерево выражения состоит из объектов DbExpression.

Объект DbExpression представляет некоторое вычисление. Для составления выражений запросов [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)] предоставляет несколько видов выражений, включая константы, переменные, функции, конструкторы и стандартные реляционные операторы, такие как фильтрация и соединение. Каждый объект DbExpression имеет свойство ResultType, которое представляет тип результата, формируемого этим выражением. Этот тип выражается как TypeUsage.

## <a name="shapes-of-the-output-query-command-tree"></a>Формы деревьев команд выходного запроса

Деревья команд выходного запроса подробно представляют реляционные запросы (SQL) и соответствуют намного более строгим правилам по сравнению с теми, которые применяются к деревьям команд запроса. Они обычно содержат конструкции, которые легко преобразуются в код SQL.

Деревья входных команд выражаются применительно к концептуальной модели, которая поддерживает свойства навигации, ассоциации среди сущностей и наследование. Деревья выходных команд выражаются применительно к модели хранения. Деревья входных команд позволяют проецировать вложенные коллекции, а деревья выходных команд - нет.

Деревья выходных команд запроса формируются с использованием подмножества доступных объектов DbExpression, и даже некоторые выражения в этом подмножестве имеют ограниченное использование.

Операции типа, такие как проверка того, имеет ли данное выражение конкретный тип, или фильтрация наборов с учетом типа, отсутствуют в деревьях выходных команд.

В деревьях выходных команд для проекций используются только выражения, которые возвращают значения типа Boolean, и только для предикатов в выражениях, требующих предиката, таких как фильтр или инструкция CASE.

Корнем деревьев выходных команд запроса является объект DbProjectExpression.

### <a name="expression-types-not-present-in-output-query-command-trees"></a>Типы выражений, не присутствующих в деревьях выходных команд запроса

Следующие типы выражений не допускаются в дереве выходных команд запроса и не требуют обработки поставщиками.

- DbDerefExpression

- DbEntityRefExpression

- DbRefKeyExpression

- DbIsOfExpression

- DbOfTypeExpression

- DbRefExpression

- DbRelationshipNavigationExpression

- DbTreatExpression

### <a name="expression-restrictions-and-notes"></a>Ограничения выражений и примечания

В деревьях выходных команд запроса многие выражения могут использоваться только в ограниченном виде.

#### <a name="dbfunctionexpression"></a>DbFunctionExpression

Могут передаваться следующие типы функций:

- Канонические функции, распознаваемые в пространстве имен Edm.

- Встроенные функции (хранилища), которые распознаются BuiltInAttribute.

- Определяемые пользователем функции.

Канонические функции (см. в разделе [канонические функции](../../../../../docs/framework/data/adonet/ef/language-reference/canonical-functions.md) подробнее) указываются как часть [!INCLUDE[adonet_ef](../../../../../includes/adonet-ef-md.md)], а поставщики должны предоставлять реализации для канонических функций на основе этих спецификаций. Функции хранилища основаны на спецификациях из соответствующего манифеста поставщика. Определяемые пользователем функции основаны на спецификациях из языка SSDL.

Кроме того, функции с атрибутом NiladicFunction не имеют аргументов и должны преобразовываться без круглой скобки в конце.  То есть,  *\<functionName >* вместо  *\<functionName > ()*.

#### <a name="dbnewinstanceexpression"></a>DbNewInstanceExpression

Выражение DbNewInstanceExpression может встречаться только в следующих двух случаях.

- Как свойство Projection объекта DbProjectExpression.  При его использовании в этом качестве виде применяются следующие ограничения.

  - Тип результата должен быть типом строки.

  - Каждый из его аргументов представляет собой выражение, которое формирует результат с примитивным типом. Как правило, каждый аргумент является скалярным выражением, таким как PropertyExpression на основе DbVariableReferenceExpression, вызовом функции или арифметическим вычислением DbPropertyExpression на основе DbVariableReferenceExpression или вызова функции. Однако выражение, представляющее скалярный вложенный запрос, может также встретиться в списке аргументов для выражения DbNewInstanceExpression. Выражение, представляющее скалярный вложенный запрос — это дерево выражения, которое представляет вложенный запрос, который возвращает только одну строку и один столбец типа-примитива с корнем объекта DbElementExpression

- С типом возвращаемого значения коллекции, и в этом случае он определяет новую коллекцию выражений, предоставленных как аргументы.

#### <a name="dbvariablereferenceexpression"></a>DbVariableReferenceExpression

Выражение DbVariableReferenceExpression должно быть дочерним элементом узла DbPropertyExpression.

#### <a name="dbgroupbyexpression"></a>DbGroupByExpression

Свойство Aggregates выражения DbGroupByExpression может иметь только элементы типа DbFunctionAggregate. Никакие прочие типы агрегатов не предусмотрены.

#### <a name="dblimitexpression"></a>DbLimitExpression

Значением свойства Limit может быть только DbConstantExpression или DbParameterReferenceExpression. Кроме того, начиная с версии 3.5 платформы .NET Framework, свойство WithTies всегда имеет значение false.

#### <a name="dbscanexpression"></a>DbScanExpression

При использовании в деревьях выходных команд выражение DbScanExpression фактически представляет проверку через таблицу, представление или запрос хранилища, представленный EntitySetBase::Target.

Если свойство метаданных «Defining Query» цели не равно null, то он представляет запрос, текст запроса, для которого предоставляется в этом свойстве метаданных поставщика конкретного языка (или диалекте), как указано в определении схемы хранилища.

В противном случае цель представляет таблицу или представление. Его префиксом схемы находится либо в свойство метаданных «Schema», в противном случае значение null, в противном случае является именем контейнера сущностей.  Имя таблицы или представления является либо свойство метаданных «Table», если не null, в противном случае свойство Name сущности задать базовый.

Все эти свойства происходят из определения соответствующего набора EntitySet, которое приведено в файле SSDL.

### <a name="using-primitive-types"></a>Использование примитивных типов

Если в деревьях выходных команд имеются ссылки на примитивные типы, они, как правило, упоминаются в примитивных типах концептуальной модели. Однако, применительно к определенным выражениям, поставщикам требуется соответствующий примитивный тип хранилища. Примеры таких выражений включают DbCastExpression и, возможно, DbNullExpression, если поставщик должен привести значение NULL к соответствующему типу. В этих случаях поставщики должны выполнить сопоставление с типом поставщика с учетом разновидности примитивного типа и его аспектов.

## <a name="see-also"></a>См. также

- [Создание SQL](../../../../../docs/framework/data/adonet/ef/sql-generation.md)
