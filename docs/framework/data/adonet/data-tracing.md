---
title: Трассировка данных в ADO.NET
ms.date: 03/30/2017
ms.assetid: a6a752a5-d2a9-4335-a382-b58690ccb79f
ms.openlocfilehash: df49fc7a5f7c437132a4dc24ed7f18492d9e7647
ms.sourcegitcommit: c7a7e1468bf0fa7f7065de951d60dfc8d5ba89f5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/14/2019
ms.locfileid: "65583778"
---
# <a name="data-tracing-in-adonet"></a><span data-ttu-id="f5e9e-102">Трассировка данных в ADO.NET</span><span class="sxs-lookup"><span data-stu-id="f5e9e-102">Data Tracing in ADO.NET</span></span>

<span data-ttu-id="f5e9e-103">ADO.NET появились новые встроенные функции трассировки данных, поддерживаемые поставщиками данных .NET для SQL Server, Oracle, OLE DB и ODBC, а также ADO.NET <xref:System.Data.DataSet>, а также сетевые протоколы SQL Server.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-103">ADO.NET features built-in data tracing functionality that is supported by the .NET data providers for SQL Server, Oracle, OLE DB and ODBC, as well as the ADO.NET <xref:System.Data.DataSet>, and the SQL Server network protocols.</span></span>

<span data-ttu-id="f5e9e-104">Трассировка вызовов API-интерфейсов для доступа к данным может помочь в выявлении следующих проблем:</span><span class="sxs-lookup"><span data-stu-id="f5e9e-104">Tracing data access API calls can help diagnose the following problems:</span></span>

- <span data-ttu-id="f5e9e-105">несоответствие схемы между клиентской программой и базой данных;</span><span class="sxs-lookup"><span data-stu-id="f5e9e-105">Schema mismatch between client program and the database.</span></span>

- <span data-ttu-id="f5e9e-106">недоступность базы данных или проблемы с сетевой библиотекой;</span><span class="sxs-lookup"><span data-stu-id="f5e9e-106">Database unavailability or network library problems.</span></span>

- <span data-ttu-id="f5e9e-107">неверный SQL-код, фиксированный или сформированный приложением;</span><span class="sxs-lookup"><span data-stu-id="f5e9e-107">Incorrect SQL whether hard coded or generated by an application.</span></span>

- <span data-ttu-id="f5e9e-108">неверная программная логика;</span><span class="sxs-lookup"><span data-stu-id="f5e9e-108">Incorrect programming logic.</span></span>

- <span data-ttu-id="f5e9e-109">проблемы, возникающие вследствие взаимодействия нескольких компонентов ADO.NET или компонентов ADO.NET и собственных компонентов.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-109">Issues resulting from the interaction between multiple ADO.NET components or between ADO.NET and your own components.</span></span>

<span data-ttu-id="f5e9e-110">Трассировка является расширяемой для поддержки разных методов трассировки, поэтому разработчик может отслеживать проблемы на любом уровне стека приложений.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-110">To support different trace technologies, tracing is extensible, so a developer can trace a problem at any level of the application stack.</span></span> <span data-ttu-id="f5e9e-111">Хотя трассировка не является возможностью только ADO.NET, поставщики Майкрософт пользуются преимуществами обобщенных API трассировки и инструментария.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-111">Although tracing is not an ADO.NET-only feature, Microsoft providers take advantage of generalized tracing and instrumentation APIs.</span></span>

<span data-ttu-id="f5e9e-112">Дополнительные сведения об установке и настройке управляемой трассировки в ADO.NET см. в разделе [трассировка доступа к данным](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).</span><span class="sxs-lookup"><span data-stu-id="f5e9e-112">For more information about setting and configuring managed tracing in ADO.NET, see [Tracing Data Access](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).</span></span>

## <a name="accessing-diagnostic-information-in-the-extended-events-log"></a><span data-ttu-id="f5e9e-113">Доступ к диагностической информации в расширенном журнале событий</span><span class="sxs-lookup"><span data-stu-id="f5e9e-113">Accessing Diagnostic Information in the Extended Events Log</span></span>

<span data-ttu-id="f5e9e-114">В поставщике данных .NET Framework для SQL Server доступа к данным трассировки ([трассировка доступа к данным](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) был обновлен для упрощения проще коррелировать события клиента с диагностической информацией — ошибками соединения, из сервера кольцевой буфер и приложение производительности сведения о подключении в журнале расширенных событий.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-114">In the .NET Framework Data Provider for SQL Server, data access tracing ([Data Access Tracing](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) has been updated to make it easier to easier to correlate client events with diagnostic information, such as connection failures, from the server's connectivity ring buffer and application performance information in the extended events log.</span></span> <span data-ttu-id="f5e9e-115">Дополнительные сведения о чтении журнала расширенных событий см. в разделе [данные сеанса событий представления](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).</span><span class="sxs-lookup"><span data-stu-id="f5e9e-115">For information about reading the extended events log, see [View Event Session Data](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).</span></span>

<span data-ttu-id="f5e9e-116">Для операций соединения ADO.NET передает идентификатор соединения клиента.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-116">For connection operations, ADO.NET will send a client connection ID.</span></span> <span data-ttu-id="f5e9e-117">Если подключение отсутствует, можно воспользоваться кольцевого буфера ([Устранение неполадок подключения в SQL Server 2008 с помощью кольцевого буфера](https://go.microsoft.com/fwlink/?LinkId=207752)) и найти `ClientConnectionID` поле и получить диагностическую информацию Ошибка соединения.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-117">If the connection fails, you can access the connectivity ring buffer ([Connectivity troubleshooting in SQL Server 2008 with the Connectivity Ring Buffer](https://go.microsoft.com/fwlink/?LinkId=207752)) and find the `ClientConnectionID` field and get diagnostic information about the connection failure.</span></span> <span data-ttu-id="f5e9e-118">Идентификаторы соединения клиента регистрируются в кольцевом буфере только при возникновении ошибки.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-118">Client connection IDs are logged in the ring buffer only if an error occurs.</span></span> <span data-ttu-id="f5e9e-119">(Если установление соединения завершилось неудачно перед отправкой пакета предварительного согласования, то идентификатор соединения клиента не будет сформирован.) Идентификатор соединения клиента - это 16-байтное значение идентификатора GUID.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-119">(If a connection fails before sending the prelogin packet, a client connection ID will not be generated.) The client connection ID is a 16-byte GUID.</span></span> <span data-ttu-id="f5e9e-120">Можно также найти идентификатор соединения клиента в расширенном выводе целевых событий, если целевое действие `client_connection_id` добавляется в события в расширенном сеансе событий.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-120">You can also find the client connection ID in the extended events target output, if the `client_connection_id` action is added to events in an extended events session.</span></span> <span data-ttu-id="f5e9e-121">Если необходима дополнительная помощь по устранению неполадок драйвера клиента, можно включить трассировку для доступа к данным, повторно запустить команду соединения и проверить поле `ClientConnectionID` в трассировке доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-121">You can enable data access tracing and rerun the connection command and observe the `ClientConnectionID` field in the data access trace, if you need further client driver diagnostic assistance.</span></span>

<span data-ttu-id="f5e9e-122">Можно получить идентификатор соединения клиента программно через свойство `SqlConnection.ClientConnectionID`.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-122">You can get the client connection ID programmatically by using the `SqlConnection.ClientConnectionID` property.</span></span>

<span data-ttu-id="f5e9e-123">Идентификатор `ClientConnectionID` доступен для объекта <xref:System.Data.SqlClient.SqlConnection>, который успешно устанавливает соединение.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-123">The `ClientConnectionID` is available for a <xref:System.Data.SqlClient.SqlConnection> object that successfully establishes  a connection.</span></span> <span data-ttu-id="f5e9e-124">Если попытка соединения завершилась ошибкой, то `ClientConnectionID` можно попробовать получить через `SqlException.ToString`.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-124">If a connection attempt fails, `ClientConnectionID` may be available via `SqlException.ToString`.</span></span>

<span data-ttu-id="f5e9e-125">ADO.NET также отправляет идентификатор действия, определенный для потока.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-125">ADO.NET also sends a thread-specific activity ID.</span></span> <span data-ttu-id="f5e9e-126">Идентификатор активности регистрируется в сеансах расширенных событий, если сеанс запущен с включенным параметром TRACK_CAUSALITY.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-126">The activity ID is captured in the extended events sessions if the sessions are started with the TRACK_CAUSALITY option enabled.</span></span> <span data-ttu-id="f5e9e-127">Для устранения проблем производительности с активным соединением можно получить идентификатор действия из трассировки клиента для доступа к данным (поле `ActivityID`), а затем найти идентификатор действия в выходных данных расширенных событий.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-127">For performance issues with an active connection, you can get the activity ID from the client's data access trace (`ActivityID` field) and then locate the activity ID in the extended events output.</span></span> <span data-ttu-id="f5e9e-128">Идентификатор действия в расширенных событиях представляет собой 16-байтовый GUID (не совпадает с идентификатором GUID для идентификатора соединения клиента) с добавленным к нему четырехбайтовым порядковым номером.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-128">The activity ID in extended events is a 16-byte GUID (not the same as the GUID for the client connection ID) appended with a four-byte sequence number.</span></span> <span data-ttu-id="f5e9e-129">Порядковый номер представляет собой порядковый номер запроса в потоке и указывает относительное упорядочение инструкций пакета RPC для потока.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-129">The sequence number represents the order of a request within a thread and indicates the relative ordering of batch and RPC statements for the thread.</span></span> <span data-ttu-id="f5e9e-130">Идентификатор `ActivityID` в настоящее время (необязательно) отправляется для инструкций пакета SQL и запросов RPC, если включена трассировка доступа к данным и включен 18-й бит в слове настройки трассировки доступа к данным.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-130">The `ActivityID` is currently optionally sent for SQL batch statements and RPC requests when data access tracing is enabled on and the 18th bit in the data access tracing configuration word is turned ON.</span></span>

<span data-ttu-id="f5e9e-131">Далее приведен образец, в котором используется [!INCLUDE[tsql](../../../../includes/tsql-md.md)] для запуска расширенного сеанса событий, который будет сохранен в кольцевом буфере и будет регистрировать идентификатор действия, отправленный с клиента в операциях RPC и пакета.</span><span class="sxs-lookup"><span data-stu-id="f5e9e-131">The following is a sample that uses [!INCLUDE[tsql](../../../../includes/tsql-md.md)] to start an extended events session that will be stored in a ring buffer and will record the activity ID sent from a client on RPC and batch operations.</span></span>

```sql
create event session MySession on server
add event connectivity_ring_buffer_recorded,
add event sql_statement_starting (action (client_connection_id)),
add event sql_statement_completed (action (client_connection_id)),
add event rpc_starting (action (client_connection_id)),
add event rpc_completed (action (client_connection_id))
add target ring_buffer with (track_causality=on)
```

## <a name="see-also"></a><span data-ttu-id="f5e9e-132">См. также</span><span class="sxs-lookup"><span data-stu-id="f5e9e-132">See also</span></span>

- [<span data-ttu-id="f5e9e-133">Трассировка сети в .NET Framework</span><span class="sxs-lookup"><span data-stu-id="f5e9e-133">Network Tracing in the .NET Framework</span></span>](../../../../docs/framework/network-programming/network-tracing.md)
- [<span data-ttu-id="f5e9e-134">Трассировка и инструментирование приложений</span><span class="sxs-lookup"><span data-stu-id="f5e9e-134">Tracing and Instrumenting Applications</span></span>](../../../../docs/framework/debug-trace-profile/tracing-and-instrumenting-applications.md)
- [<span data-ttu-id="f5e9e-135">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="f5e9e-135">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
