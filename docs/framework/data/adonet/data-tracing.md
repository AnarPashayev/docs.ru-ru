---
title: Трассировка данных в ADO.NET
ms.date: 03/30/2017
ms.assetid: a6a752a5-d2a9-4335-a382-b58690ccb79f
ms.openlocfilehash: f92a17374cf3df1281e51d54bae1a1dcf9e5ea03
ms.sourcegitcommit: 7e2128d4a4c45b4274bea3b8e5760d4694569ca1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/14/2020
ms.locfileid: "75937628"
---
# <a name="data-tracing-in-adonet"></a>Трассировка данных в ADO.NET

ADO.NET содержит встроенные функции трассировки данных, поддерживаемые поставщиками данных .NET для SQL Server, Oracle, OLE DB и ODBC, а также <xref:System.Data.DataSet>ADO.NET и сетевых протоколов SQL Server.

Трассировка вызовов API-интерфейсов для доступа к данным может помочь в выявлении следующих проблем:

- несоответствие схемы между клиентской программой и базой данных;

- недоступность базы данных или проблемы с сетевой библиотекой;

- неверный SQL-код, фиксированный или сформированный приложением;

- неверная программная логика;

- проблемы, возникающие вследствие взаимодействия нескольких компонентов ADO.NET или компонентов ADO.NET и собственных компонентов.

Трассировка является расширяемой для поддержки разных методов трассировки, поэтому разработчик может отслеживать проблемы на любом уровне стека приложений. Хотя трассировка не является возможностью только ADO.NET, поставщики Майкрософт пользуются преимуществами обобщенных API трассировки и инструментария.

Дополнительные сведения о настройке и настройке управляемой трассировки в ADO.NET см. в разделе [Трассировка доступа к данным](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10)).

## <a name="accessing-diagnostic-information-in-the-extended-events-log"></a>Доступ к диагностической информации в расширенном журнале событий

В поставщике данных .NET Framework для SQL Server трассировка доступа к данным ([Трассировка доступа к данным](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh880086(v=msdn.10))) была обновлена, чтобы упростить сопоставление событий клиента с диагностической информацией, например сбоями подключения, от сведений о производительности сервера и приложения в журнале расширенных событий. Дополнительные сведения о чтении журнала расширенных событий см. в разделе [View Event Session Data](https://docs.microsoft.com/previous-versions/sql/sql-server-2012/hh710068(v=sql.110)).

Для операций соединения ADO.NET передает идентификатор соединения клиента. В случае сбоя подключения можно получить доступ к кольцевому буферу подключения ([Устранение неполадок подключения в SQL Server 2008 с помощью кольцевого буфера подключения](https://docs.microsoft.com/archive/blogs/sql_protocols/connectivity-troubleshooting-in-sql-server-2008-with-the-connectivity-ring-buffer)), найти поле `ClientConnectionID` и получить диагностические сведения об ошибке подключения. Идентификаторы соединения клиента регистрируются в кольцевом буфере только при возникновении ошибки. (Если соединение не будет отправлено до отправки пакета с предварительным именем, идентификатор подключения клиента не создается.) Идентификатор подключения клиента — это 16-байтовый идентификатор GUID. Можно также найти идентификатор соединения клиента в расширенном выводе целевых событий, если целевое действие `client_connection_id` добавляется в события в расширенном сеансе событий. Если необходима дополнительная помощь по устранению неполадок драйвера клиента, можно включить трассировку для доступа к данным, повторно запустить команду соединения и проверить поле `ClientConnectionID` в трассировке доступа к данным.

Можно получить идентификатор соединения клиента программно через свойство `SqlConnection.ClientConnectionID`.

Идентификатор `ClientConnectionID` доступен для объекта <xref:System.Data.SqlClient.SqlConnection>, который успешно устанавливает соединение. Если попытка соединения завершилась ошибкой, то `ClientConnectionID` можно попробовать получить через `SqlException.ToString`.

ADO.NET также отправляет идентификатор действия, определенный для потока. Идентификатор действия захватывается в сеансах расширенных событий, если сеансы запускаются с включенным параметром TRACK_CAUSALITY. Для устранения проблем производительности с активным соединением можно получить идентификатор действия из трассировки клиента для доступа к данным (поле `ActivityID`), а затем найти идентификатор действия в выходных данных расширенных событий. Идентификатором действия в расширенных событиях является 16-байтовый идентификатор GUID (который отличается от идентификатора GUID соединения клиента), к которому добавляется порядковый номер из четырех байт. Порядковый номер представляет собой порядковый номер запроса в потоке и указывает относительное упорядочение инструкций пакета RPC для потока. Идентификатор `ActivityID` в настоящее время (необязательно) отправляется для инструкций пакета SQL и запросов RPC, если включена трассировка доступа к данным и включен 18-й бит в слове настройки трассировки доступа к данным.

Ниже приведен пример, использующий Transact-SQL для запуска сеанса расширенных событий, который будет храниться в кольцевом буфере, и будет записывать идентификатор действия, отправленный клиентом по протоколу RPC и пакетным операциям.

```sql
create event session MySession on server
add event connectivity_ring_buffer_recorded,
add event sql_statement_starting (action (client_connection_id)),
add event sql_statement_completed (action (client_connection_id)),
add event rpc_starting (action (client_connection_id)),
add event rpc_completed (action (client_connection_id))
add target ring_buffer with (track_causality=on)
```

## <a name="see-also"></a>См. также:

- [Трассировка сети в .NET Framework](../../network-programming/network-tracing.md)
- [Трассировка и инструментирование приложений](../../debug-trace-profile/tracing-and-instrumenting-applications.md)
- [Общие сведения об ADO.NET](ado-net-overview.md)
