---
title: Распределенные транзакции
ms.date: 03/30/2017
ms.assetid: 718b257c-bcb2-408e-b004-a7b0adb1c176
ms.openlocfilehash: 60a455d51d7ae80f5434f9564ca7416c70bef9f5
ms.sourcegitcommit: 581ab03291e91983459e56e40ea8d97b5189227e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2019
ms.locfileid: "70041248"
---
# <a name="distributed-transactions"></a><span data-ttu-id="3d3da-102">Распределенные транзакции</span><span class="sxs-lookup"><span data-stu-id="3d3da-102">Distributed Transactions</span></span>
<span data-ttu-id="3d3da-103">Транзакция - это набор связанных задач, который, помимо всего прочего, завершается успешно (фиксация) или с ошибкой (отмена) как единое целое.</span><span class="sxs-lookup"><span data-stu-id="3d3da-103">A transaction is a set of related tasks that either succeeds (commit) or fails (abort) as a unit, among other things.</span></span> <span data-ttu-id="3d3da-104">*Распределенная транзакция* — это транзакция, влияющая на несколько ресурсов.</span><span class="sxs-lookup"><span data-stu-id="3d3da-104">A *distributed transaction* is a transaction that affects several resources.</span></span> <span data-ttu-id="3d3da-105">Для фиксации распределенной транзакции все участники должны гарантировать, что любое изменение данных будет постоянным.</span><span class="sxs-lookup"><span data-stu-id="3d3da-105">For a distributed transaction to commit, all participants must guarantee that any change to data will be permanent.</span></span> <span data-ttu-id="3d3da-106">Изменения должны сохраняться даже в случае фатального сбоя системы или других непредвиденных событий.</span><span class="sxs-lookup"><span data-stu-id="3d3da-106">Changes must persist despite system crashes or other unforeseen events.</span></span> <span data-ttu-id="3d3da-107">Если хоть один из участников не сможет предоставить такую гарантию, вся транзакция завершится с ошибкой и будет выполнен откат любых изменений данных внутри области транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-107">If even a single participant fails to make this guarantee, the entire transaction fails, and any changes to data within the scope of the transaction are rolled back.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3d3da-108">Если `DataReader` запускается во время активной транзакции, то при попытке зафиксировать или выполнить откат транзакции возникнет исключение.</span><span class="sxs-lookup"><span data-stu-id="3d3da-108">An exception will be thrown if you attempt to commit or roll back a transaction if a `DataReader` is started while the transaction is active.</span></span>  
  
## <a name="working-with-systemtransactions"></a><span data-ttu-id="3d3da-109">Работа с System.Transactions</span><span class="sxs-lookup"><span data-stu-id="3d3da-109">Working with System.Transactions</span></span>  
 <span data-ttu-id="3d3da-110">На платформе.NET Framework распределенные транзакции управляются с помощью API-интерфейса пространства имен <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-110">In the .NET Framework, distributed transactions are managed through the API in the <xref:System.Transactions> namespace.</span></span> <span data-ttu-id="3d3da-111">При участии нескольких постоянных диспетчеров ресурсов API-интерфейс <xref:System.Transactions> делегирует обработку распределенной транзакции средству наблюдения за транзакциями, такому как координатор распределенных транзакций (Майкрософт) (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="3d3da-111">The <xref:System.Transactions> API will delegate distributed transaction handling to a transaction monitor such as the Microsoft Distributed Transaction Coordinator (MS DTC) when multiple persistent resource managers are involved.</span></span> <span data-ttu-id="3d3da-112">Дополнительные сведения см. в статье [основы транзакций](../../../../docs/framework/data/transactions/transaction-fundamentals.md).</span><span class="sxs-lookup"><span data-stu-id="3d3da-112">For more information, see [Transaction Fundamentals](../../../../docs/framework/data/transactions/transaction-fundamentals.md).</span></span>  
  
 <span data-ttu-id="3d3da-113">В ADO.NET 2.0 появилась поддержка прикрепления распределенных транзакций с помощью метода `EnlistTransaction`, который прикрепляет подключение к экземпляру <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-113">ADO.NET 2.0 introduced support for enlisting in a distributed transaction using the `EnlistTransaction` method, which enlists a connection in a <xref:System.Transactions.Transaction> instance.</span></span> <span data-ttu-id="3d3da-114">В предыдущих версиях ADO.NET явное прикрепление к распределенной транзакции выполнялось с помощью метода соединения `EnlistDistributedTransaction` для прикрепления соединения к экземпляру <xref:System.EnterpriseServices.ITransaction>, который поддерживался в целях обратной совместимости.</span><span class="sxs-lookup"><span data-stu-id="3d3da-114">In previous versions of ADO.NET, explicit enlistment in distributed transactions was performed using the `EnlistDistributedTransaction` method of a connection to enlist a connection in a <xref:System.EnterpriseServices.ITransaction> instance, which is supported for backwards compatibility.</span></span> <span data-ttu-id="3d3da-115">Дополнительные сведения о транзакциях корпоративных служб см. в статье [взаимодействие с корпоративными службами и транзакциями COM+](../../../../docs/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span><span class="sxs-lookup"><span data-stu-id="3d3da-115">For more information on Enterprise Services transactions, see [Interoperability with Enterprise Services and COM+ Transactions](../../../../docs/framework/data/transactions/interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
 <span data-ttu-id="3d3da-116">При использовании транзакции <xref:System.Transactions> с поставщиком .NET Framework для SQL Server для базы данных SQL Server автоматически будет использована упрощенная <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-116">When using a <xref:System.Transactions> transaction with the .NET Framework Provider for SQL Server against a SQL Server database, a lightweight <xref:System.Transactions.Transaction> will automatically be used.</span></span> <span data-ttu-id="3d3da-117">Затем по мере необходимости транзакция может стать полной распределенной транзакцией.</span><span class="sxs-lookup"><span data-stu-id="3d3da-117">The transaction can then be promoted to a full distributed transaction on an as-needed basis.</span></span> <span data-ttu-id="3d3da-118">Дополнительные сведения см. [в разделе Интеграция System. Transactions с SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3d3da-118">For more information, see [System.Transactions Integration with SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3d3da-119">Максимальное количество распределенных транзакций, которое база данных Oracle может обрабатывать одновременно, по умолчанию равно 10.</span><span class="sxs-lookup"><span data-stu-id="3d3da-119">The maximum number of distributed transactions that an Oracle database can participate in at one time is set to 10 by default.</span></span> <span data-ttu-id="3d3da-120">При соединении с базой данных Oracle после десятой транзакции возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="3d3da-120">After the 10th transaction when connected to an Oracle database, an exception is thrown.</span></span> <span data-ttu-id="3d3da-121">Oracle не поддерживает инструкции языка `DDL` внутри распределенной транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-121">Oracle does not support `DDL` inside of a distributed transaction.</span></span>  
  
## <a name="automatically-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="3d3da-122">Автоматическое прикрепление к распределенной транзакции</span><span class="sxs-lookup"><span data-stu-id="3d3da-122">Automatically Enlisting in a Distributed Transaction</span></span>  
 <span data-ttu-id="3d3da-123">Автоматическое прикрепление является способом интеграции соединений ADO.NET по умолчанию (и предпочитаемым) с `System.Transactions`.</span><span class="sxs-lookup"><span data-stu-id="3d3da-123">Automatic enlistment is the default (and preferred) way of integrating ADO.NET connections with `System.Transactions`.</span></span> <span data-ttu-id="3d3da-124">В случае определения активной транзакции (что, с точки зрения `System.Transaction`, означает, что `Transaction.Current` отлична от значения типа NULL) объект соединения автоматически будет прикреплен к существующей распределенной транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-124">A connection object will automatically enlist in an existing distributed transaction if it determines that a transaction is active, which, in `System.Transaction` terms, means that `Transaction.Current` is not null.</span></span> <span data-ttu-id="3d3da-125">Автоматическое прикрепление транзакции происходит при открытии соединения.</span><span class="sxs-lookup"><span data-stu-id="3d3da-125">Automatic transaction enlistment occurs when the connection is opened.</span></span> <span data-ttu-id="3d3da-126">Оно не произойдет после открытия, даже если команда выполняется внутри области транзакций.</span><span class="sxs-lookup"><span data-stu-id="3d3da-126">It will not happen after that even if a command is executed inside of a transaction scope.</span></span> <span data-ttu-id="3d3da-127">Для отключения автоматического прикрепления в существующих транзакциях следует указать `Enlist=false` в качестве параметра строки соединения для <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType> или `OLE DB Services=-7` в качестве параметра строки соединения для <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-127">You can disable auto-enlistment in existing transactions by specifying `Enlist=false` as a connection string parameter for a <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A?displayProperty=nameWithType>, or `OLE DB Services=-7` as a connection string parameter for an <xref:System.Data.OleDb.OleDbConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="3d3da-128">Дополнительные сведения о параметрах строки соединения Oracle и ODBC см. в <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> и <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-128">For more information on Oracle and ODBC connection string parameters, see <xref:System.Data.OracleClient.OracleConnection.ConnectionString%2A?displayProperty=nameWithType> and <xref:System.Data.Odbc.OdbcConnection.ConnectionString%2A?displayProperty=nameWithType>.</span></span>  
  
## <a name="manually-enlisting-in-a-distributed-transaction"></a><span data-ttu-id="3d3da-129">Ручное прикрепление к распределенной транзакции</span><span class="sxs-lookup"><span data-stu-id="3d3da-129">Manually Enlisting in a Distributed Transaction</span></span>  
 <span data-ttu-id="3d3da-130">Если автоматическое прикрепление отключено или необходимо прикрепить транзакцию, запущенную после открытия соединения, то можно осуществить прикрепление к существующей распределенной транзакции с помощью метода `EnlistTransaction` объекта <xref:System.Data.Common.DbConnection> для рабочего поставщика.</span><span class="sxs-lookup"><span data-stu-id="3d3da-130">If auto-enlistment is disabled or you need to enlist a transaction that was started after the connection was opened, you can enlist in an existing distributed transaction using the `EnlistTransaction` method of the <xref:System.Data.Common.DbConnection> object for the provider you are working with.</span></span> <span data-ttu-id="3d3da-131">Прикрепление к существующей распределенной транзакции гарантирует, что в случае фиксации или отката транзакции изменения, выполненные кодом в источнике данных, будут также зафиксированы или откатаны назад.</span><span class="sxs-lookup"><span data-stu-id="3d3da-131">Enlisting in an existing distributed transaction ensures that, if the transaction is committed or rolled back, modifications made by the code at the data source will be committed or rolled back as well.</span></span>  
  
 <span data-ttu-id="3d3da-132">Прикрепление к распределенным транзакциям обычно применяется при объединении бизнес-объектов в пул.</span><span class="sxs-lookup"><span data-stu-id="3d3da-132">Enlisting in distributed transactions is particularly applicable when pooling business objects.</span></span> <span data-ttu-id="3d3da-133">Если бизнес-объект заносится в пул с открытым соединением, автоматическое прикрепление происходит только при открытии этого соединения.</span><span class="sxs-lookup"><span data-stu-id="3d3da-133">If a business object is pooled with an open connection, automatic transaction enlistment only occurs when that connection is opened.</span></span> <span data-ttu-id="3d3da-134">При выполнении нескольких транзакций с помощью занесенного в пул бизнес-объекта открытое для этого объекта соединение не будет автоматически прикрепляться к новым транзакциям.</span><span class="sxs-lookup"><span data-stu-id="3d3da-134">If multiple transactions are performed using the pooled business object, the open connection for that object will not automatically enlist in newly initiated transactions.</span></span> <span data-ttu-id="3d3da-135">В этом случае можно отключить для соединения автоматическое прикрепление транзакций и прикреплять его к транзакциям с помощью `EnlistTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3d3da-135">In this case, you can disable automatic transaction enlistment for the connection and enlist the connection in transactions using `EnlistTransaction`.</span></span>  
  
 <span data-ttu-id="3d3da-136">`EnlistTransaction`принимает один аргумент типа <xref:System.Transactions.Transaction> , который является ссылкой на существующую транзакцию.</span><span class="sxs-lookup"><span data-stu-id="3d3da-136">`EnlistTransaction` takes a single argument of type <xref:System.Transactions.Transaction> that is a reference to the existing transaction.</span></span> <span data-ttu-id="3d3da-137">После вызова метода соединения `EnlistTransaction` все изменения в источнике данных, выполненные с помощью соединения, включаются в транзакцию.</span><span class="sxs-lookup"><span data-stu-id="3d3da-137">After calling the connection's `EnlistTransaction` method, all modifications made at the data source using the connection are included in the transaction.</span></span> <span data-ttu-id="3d3da-138">Передача значения NULL исключает соединение из прикрепления к текущей распределенной транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-138">Passing a null value unenlists the connection from its current distributed transaction enlistment.</span></span> <span data-ttu-id="3d3da-139">Обратите внимание, что соединение должно быть открыто до вызова `EnlistTransaction`.</span><span class="sxs-lookup"><span data-stu-id="3d3da-139">Note that the connection must be opened before calling `EnlistTransaction`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="3d3da-140">После явного прикрепления соединения к транзакции нельзя отменить его прикрепление или прикрепить к другой транзакции до завершения первой транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-140">Once a connection is explicitly enlisted on a transaction, it cannot be un-enlisted or enlisted in another transaction until the first transaction finishes.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="3d3da-141">Если соединение уже запустило транзакцию с помощью метода соединений `EnlistTransaction`, то <xref:System.Data.Common.DbConnection.BeginTransaction%2A> вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="3d3da-141">`EnlistTransaction` throws an exception if the connection has already begun a transaction using the connection's <xref:System.Data.Common.DbConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="3d3da-142">Однако, если транзакция является локальной и запущенной из источника данных (например, явно выполнив инструкцию BEGIN TRANSACTION с помощью <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` выполнит откат локальной транзакции и прикрепит к существующей распределенной транзакции.</span><span class="sxs-lookup"><span data-stu-id="3d3da-142">However, if the transaction is a local transaction started at the data source (for example, executing the BEGIN TRANSACTION statement explicitly using a <xref:System.Data.SqlClient.SqlCommand>), `EnlistTransaction` will roll back the local transaction and enlist in the existing distributed transaction as requested.</span></span> <span data-ttu-id="3d3da-143">Уведомления об откате локальной транзакции не высылается, и управление любыми незапущенными локальными транзакциями осуществляется с помощью <xref:System.Data.Common.DbConnection.BeginTransaction%2A>.</span><span class="sxs-lookup"><span data-stu-id="3d3da-143">You will not receive notice that the local transaction was rolled back, and must manage any local transactions not started using <xref:System.Data.Common.DbConnection.BeginTransaction%2A>.</span></span> <span data-ttu-id="3d3da-144">При использовании поставщика данных .NET Framework для SQL Server (`SqlClient`) с SQL Server попытка прикрепления вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="3d3da-144">If you are using the .NET Framework Data Provider for SQL Server (`SqlClient`) with SQL Server, an attempt to enlist will throw an exception.</span></span> <span data-ttu-id="3d3da-145">Все остальные случаи исключений не вызовут.</span><span class="sxs-lookup"><span data-stu-id="3d3da-145">All other cases will go undetected.</span></span>  
  
## <a name="promotable-transactions-in-sql-server"></a><span data-ttu-id="3d3da-146">Повышаемые транзакции в SQL Server</span><span class="sxs-lookup"><span data-stu-id="3d3da-146">Promotable Transactions in SQL Server</span></span>  
 <span data-ttu-id="3d3da-147">SQL Server поддерживает повышаемые транзакции, в которых локальная упрощенная транзакция может быть автоматически повышена до распределенной, если потребуется.</span><span class="sxs-lookup"><span data-stu-id="3d3da-147">SQL Server supports promotable transactions in which a local lightweight transaction can be automatically promoted to a distributed transaction only if it is required.</span></span> <span data-ttu-id="3d3da-148">Повышаемая транзакция не вызывает дополнительную нагрузку распределенной транзакции, если таковая не требуется.</span><span class="sxs-lookup"><span data-stu-id="3d3da-148">A promotable transaction does not invoke the added overhead of a distributed transaction unless the added overhead is required.</span></span> <span data-ttu-id="3d3da-149">Дополнительные сведения и пример кода см. в разделе [Интеграция System. Transactions с SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="3d3da-149">For more information and a code sample, see [System.Transactions Integration with SQL Server](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md).</span></span>  
  
## <a name="configuring-distributed-transactions"></a><span data-ttu-id="3d3da-150">Настройка распределенных транзакций</span><span class="sxs-lookup"><span data-stu-id="3d3da-150">Configuring Distributed Transactions</span></span>  
 <span data-ttu-id="3d3da-151">Для использования распределенных транзакций возможна необходимость включения в сети MS DTC.</span><span class="sxs-lookup"><span data-stu-id="3d3da-151">You may need to enable the MS DTC over the network in order to use distributed transactions.</span></span> <span data-ttu-id="3d3da-152">Если включен межсетевой экран Windows, необходимо разрешить службе MS DTC использовать сеть или открыть порт MS DTC.</span><span class="sxs-lookup"><span data-stu-id="3d3da-152">If have the Windows Firewall enabled, you must allow the MS DTC service to use the network or open the MS DTC port.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="3d3da-153">См. также</span><span class="sxs-lookup"><span data-stu-id="3d3da-153">See also</span></span>

- [<span data-ttu-id="3d3da-154">Транзакции и параллельность</span><span class="sxs-lookup"><span data-stu-id="3d3da-154">Transactions and Concurrency</span></span>](../../../../docs/framework/data/adonet/transactions-and-concurrency.md)
- [<span data-ttu-id="3d3da-155">Интеграция System.Transactions с SQL Server</span><span class="sxs-lookup"><span data-stu-id="3d3da-155">System.Transactions Integration with SQL Server</span></span>](../../../../docs/framework/data/adonet/system-transactions-integration-with-sql-server.md)
- [<span data-ttu-id="3d3da-156">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="3d3da-156">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
