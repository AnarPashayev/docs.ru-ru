---
title: Объединение подключений в пул в SQL Server (ADO.NET)
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 7581031b022c9c53568a616de66584be9ef7229c
ms.sourcegitcommit: 581ab03291e91983459e56e40ea8d97b5189227e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/27/2019
ms.locfileid: "70041197"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="78075-102">Объединение подключений в пул в SQL Server (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="78075-102">SQL Server Connection Pooling (ADO.NET)</span></span>
<span data-ttu-id="78075-103">Соединение с сервером базы данных обычно состоит из нескольких длительных шагов.</span><span class="sxs-lookup"><span data-stu-id="78075-103">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="78075-104">Необходимо установить физический канал, например сокет или именованный канал, выполнить первоначальное подтверждение установления связи с сервером, выполнить синтаксический анализ данных строки соединения, сервер должен проверить подлинность соединения, а также запустить проверку прикреплений в текущей транзакции и т. д.</span><span class="sxs-lookup"><span data-stu-id="78075-104">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="78075-105">На практике большинство приложений использует только одно или несколько различных конфигураций соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-105">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="78075-106">Это означает, что во время выполнения приложения многие идентичные соединения будут повторно открываться и закрываться.</span><span class="sxs-lookup"><span data-stu-id="78075-106">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="78075-107">Чтобы максимально сэкономить расходы на открытие подключений, ADO.NET использует методику оптимизации, называемую созданием *пулов соединений*.</span><span class="sxs-lookup"><span data-stu-id="78075-107">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="78075-108">Пул соединений снижает количество открытий новых соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-108">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="78075-109">*Пул* хранит владение физическим подключением.</span><span class="sxs-lookup"><span data-stu-id="78075-109">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="78075-110">Он управляет соединениями с помощью поддержания набора активных соединений для каждой конфигурации данного соединения.</span><span class="sxs-lookup"><span data-stu-id="78075-110">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="78075-111">Каждый раз, когда пользователь вызывает метод `Open` в соединении, организатор пулов ищет в пуле доступное соединение.</span><span class="sxs-lookup"><span data-stu-id="78075-111">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="78075-112">Если соединение пула доступно, вместо открытия нового соединения он возвращает его участнику.</span><span class="sxs-lookup"><span data-stu-id="78075-112">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="78075-113">При вызове приложением метода `Close` в соединении вместо закрытия организатор пулов возвращает его в набор активных соединений пула.</span><span class="sxs-lookup"><span data-stu-id="78075-113">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="78075-114">После возвращения соединения в пул оно готово к повторному использованию при следующем вызове метода `Open`.</span><span class="sxs-lookup"><span data-stu-id="78075-114">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="78075-115">В пул могут помещаться только соединения с одинаковой конфигурацией.</span><span class="sxs-lookup"><span data-stu-id="78075-115">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="78075-116">ADO.NET хранит несколько пулов в одно и то же время, по одному для каждой конфигурации.</span><span class="sxs-lookup"><span data-stu-id="78075-116">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="78075-117">Соединения разделяются в пулы строкой соединения, а при использовании встроенной безопасности - удостоверением Windows.</span><span class="sxs-lookup"><span data-stu-id="78075-117">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="78075-118">Соединения также заносятся в пул в зависимости от того, прикреплены ли они к транзакции.</span><span class="sxs-lookup"><span data-stu-id="78075-118">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="78075-119">При использовании метода <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A> экземпляр <xref:System.Data.SqlClient.SqlCredential> влияет на пул соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-119">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="78075-120">Различные экземпляры <xref:System.Data.SqlClient.SqlCredential> используют различные пулы соединений, даже если идентификатор пользователя и пароль совпадают.</span><span class="sxs-lookup"><span data-stu-id="78075-120">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="78075-121">Организация пулов соединений может существенно улучшить производительность и масштабируемость приложения.</span><span class="sxs-lookup"><span data-stu-id="78075-121">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="78075-122">По умолчанию в ADO.NET включена поддержка пулов соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-122">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="78075-123">Пока организатор пулов не будет явно отключен, он оптимизирует соединения по мере их открытия и закрытия в приложении.</span><span class="sxs-lookup"><span data-stu-id="78075-123">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="78075-124">Также можно указать несколько модификаторов строки соединения для управления поведением пула соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-124">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="78075-125">Дополнительные сведения см. в подразделе «Управление пулами соединений с помощью ключевых слов строки соединения» далее в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="78075-125">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="78075-126">Если включено создание пулов соединения и происходит ошибка времени ожидания или другая ошибка входа, то выдается исключение и последующие попытки подключения завершаются ошибкой в течение следующего «интервала блокирования» - 5 секунд.</span><span class="sxs-lookup"><span data-stu-id="78075-126">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="78075-127">Если приложение пытается установить подключение в течение интервала блокирования, то снова выдается первое исключение.</span><span class="sxs-lookup"><span data-stu-id="78075-127">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="78075-128">Последующие ошибки после завершения интервала блокирования приводят к возникновению новых интервалов блокирования, вдвое превышающих предыдущий период времени блокирования, вплоть до максимального значения в 1 минуту.</span><span class="sxs-lookup"><span data-stu-id="78075-128">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="78075-129">Создание и назначение пулов</span><span class="sxs-lookup"><span data-stu-id="78075-129">Pool Creation and Assignment</span></span>  
 <span data-ttu-id="78075-130">При первом открытии соединения создается пул соединений, основанный на алгоритме точного совпадения, связанного с пулом строкой соединения.</span><span class="sxs-lookup"><span data-stu-id="78075-130">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="78075-131">Каждый пул соединений связывается с отдельной строкой соединения.</span><span class="sxs-lookup"><span data-stu-id="78075-131">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="78075-132">При открытии нового соединения, если строка соединения не соответствует в точности существующему пулу, создается новый пул.</span><span class="sxs-lookup"><span data-stu-id="78075-132">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="78075-133">Соединения заносятся в пул отдельно для процесса, домена приложения, строки соединения и, если используется встроенная безопасность, для удостоверения Windows.</span><span class="sxs-lookup"><span data-stu-id="78075-133">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="78075-134">Строки соединения должны точно совпадать. Ключевые слова, указанные в различном порядке для одного соединения, будут включены в пул по отдельности.</span><span class="sxs-lookup"><span data-stu-id="78075-134">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="78075-135">В следующем примере C# создаются три новых объекта <xref:System.Data.SqlClient.SqlConnection>, но для управления ими требуется только два пула соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-135">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="78075-136">Обратите внимание, что первая и вторая строки соединения отличаются значениями, присвоенными аргументу `Initial Catalog`.</span><span class="sxs-lookup"><span data-stu-id="78075-136">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();        
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();        
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();        
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="78075-137">Если аргумент `MinPoolSize` не указан в строке соединения или указано значение 0, соединения в пуле будут закрыты после периода отсутствия активности.</span><span class="sxs-lookup"><span data-stu-id="78075-137">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="78075-138">Однако, если значение аргумента `MinPoolSize` больше 0, пул соединений не уничтожается, пока не будет выгружен домен приложения `AppDomain` и не завершится процесс.</span><span class="sxs-lookup"><span data-stu-id="78075-138">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="78075-139">Обслуживание неактивных или пустых пулов требует минимальных системных издержек.</span><span class="sxs-lookup"><span data-stu-id="78075-139">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="78075-140">Пул автоматически очищается при возникновении неустранимой ошибки, например переходе на другой ресурс.</span><span class="sxs-lookup"><span data-stu-id="78075-140">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="78075-141">Добавление соединений</span><span class="sxs-lookup"><span data-stu-id="78075-141">Adding Connections</span></span>  
 <span data-ttu-id="78075-142">Пул соединений создается для каждой уникальной строки соединения.</span><span class="sxs-lookup"><span data-stu-id="78075-142">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="78075-143">При создании пула создается множество объектов соединения, которые добавляются в пул для удовлетворения требования к минимальному размеру пула.</span><span class="sxs-lookup"><span data-stu-id="78075-143">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="78075-144">Соединения добавляются в пул по необходимости, вплоть до указанного максимального размера пула (по умолчанию - 100).</span><span class="sxs-lookup"><span data-stu-id="78075-144">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="78075-145">Соединения освобождаются обратно в пул при закрытии или ликвидации.</span><span class="sxs-lookup"><span data-stu-id="78075-145">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="78075-146">При запросе объекта <xref:System.Data.SqlClient.SqlConnection> он получается из пула при наличии готового к использованию соединения.</span><span class="sxs-lookup"><span data-stu-id="78075-146">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="78075-147">Чтобы соединение можно было использовать, оно не должно использоваться, иметь совпадающий контекст транзакции либо не иметь связи с каким-либо контекстом транзакций и иметь допустимую ссылку на сервер.</span><span class="sxs-lookup"><span data-stu-id="78075-147">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="78075-148">Организатор пулов соединений обрабатывает запросы соединений путем их повторного размещения после возврата в пул.</span><span class="sxs-lookup"><span data-stu-id="78075-148">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="78075-149">Если достигнут максимальный размер пула, а пригодные соединения недоступны, запрос помещается в очередь.</span><span class="sxs-lookup"><span data-stu-id="78075-149">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="78075-150">Затем организатор пулов пытается вернуть любое соединение до истечения времени ожидания (по умолчанию - 15 секунд).</span><span class="sxs-lookup"><span data-stu-id="78075-150">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="78075-151">Если организатор пулов не может обработать запрос до истечения времени ожидания соединения, возникнет исключение.</span><span class="sxs-lookup"><span data-stu-id="78075-151">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="78075-152">Настоятельно рекомендуется всегда закрывать соединение после его использования, чтобы оно вернулось в пул.</span><span class="sxs-lookup"><span data-stu-id="78075-152">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="78075-153">Это `Close` можно сделать с помощью методов `Connection` или объекта `Dispose` или путем открытия всех C# `Using` соединений внутри `using` инструкции в или инструкции в Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="78075-153">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="78075-154">Соединения, которые явно не закрыты, нельзя добавить или вернуть в пул.</span><span class="sxs-lookup"><span data-stu-id="78075-154">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="78075-155">Дополнительные сведения см. в разделе [оператор using](../../../csharp/language-reference/keywords/using-statement.md) или [инструкции. Удаление системного ресурса](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) для Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="78075-155">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="78075-156">В методе `Close` вашего класса нельзя вызывать методы `Dispose` или `Connection` объектов `DataReader`, `Finalize` или любого другого управляемого объекта.</span><span class="sxs-lookup"><span data-stu-id="78075-156">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="78075-157">В методе завершения следует освобождать только неуправляемые ресурсы, которыми ваш класс непосредственно владеет.</span><span class="sxs-lookup"><span data-stu-id="78075-157">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="78075-158">Если класс не владеет какими-либо неуправляемыми ресурсами, не включайте в его определение метод `Finalize`.</span><span class="sxs-lookup"><span data-stu-id="78075-158">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="78075-159">Дополнительные сведения см. в разделе [Сборка мусора](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="78075-159">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="78075-160">Дополнительные сведения о событиях, связанных с открытием и закрытием соединений, см. в разделе [Аудит входа](/sql/relational-databases/event-classes/audit-login-event-class) в класс событий и [аудит Logout](/sql/relational-databases/event-classes/audit-logout-event-class) в SQL Server документации.</span><span class="sxs-lookup"><span data-stu-id="78075-160">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="78075-161">Удаление соединений</span><span class="sxs-lookup"><span data-stu-id="78075-161">Removing Connections</span></span>  
 <span data-ttu-id="78075-162">Организатор пулов соединений удаляет соединение из пула после его простоя в течение примерно 4-8 минут или при определении им разрыва соединения с сервером.</span><span class="sxs-lookup"><span data-stu-id="78075-162">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="78075-163">Обратите внимание, что разорванное соединение можно определить только после попытки связи с сервером.</span><span class="sxs-lookup"><span data-stu-id="78075-163">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="78075-164">При обнаружении соединения, которое больше не имеет связи с сервером, оно помечается как недействительное.</span><span class="sxs-lookup"><span data-stu-id="78075-164">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="78075-165">Недействительные соединения удаляются из пула соединений только после их закрытия или возврата.</span><span class="sxs-lookup"><span data-stu-id="78075-165">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="78075-166">Если существующее соединение с сервером исчезло, оно может быть удалено из пула, даже если организатор пулов соединений не определил разорванное соединение и не пометил его как недопустимое.</span><span class="sxs-lookup"><span data-stu-id="78075-166">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="78075-167">Это происходит вследствие того, что проверка соединения на допустимость уничтожит преимущества существования организатора пулов, став причиной вызова очередного цикла приема-передачи с сервером.</span><span class="sxs-lookup"><span data-stu-id="78075-167">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="78075-168">В этом случае первая попытка использовать соединение определит его разрыв и вызовет исключение.</span><span class="sxs-lookup"><span data-stu-id="78075-168">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="78075-169">Очистка пула</span><span class="sxs-lookup"><span data-stu-id="78075-169">Clearing the Pool</span></span>  
 <span data-ttu-id="78075-170">В ADO.NET 2,0 появились два новых метода очистки пула: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> и. <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A></span><span class="sxs-lookup"><span data-stu-id="78075-170">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="78075-171">Метод `ClearAllPools` очищает пулы соединений данного поставщика, а метод `ClearPool` - пул, связанный с конкретным соединением.</span><span class="sxs-lookup"><span data-stu-id="78075-171">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="78075-172">Если во время вызова методов соединения использовались, они соответствующим образом помечаются.</span><span class="sxs-lookup"><span data-stu-id="78075-172">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="78075-173">При их закрытии вместо возвращения в пул они удаляются.</span><span class="sxs-lookup"><span data-stu-id="78075-173">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="78075-174">Поддержка транзакций</span><span class="sxs-lookup"><span data-stu-id="78075-174">Transaction Support</span></span>  
 <span data-ttu-id="78075-175">Соединения выбираются из пула и назначаются в зависимости от контекста транзакции.</span><span class="sxs-lookup"><span data-stu-id="78075-175">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="78075-176">Если в строке соединения не указан аргумент `Enlist=false`, пул соединений гарантирует прикрепление соединения к контексту <xref:System.Transactions.Transaction.Current%2A>.</span><span class="sxs-lookup"><span data-stu-id="78075-176">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="78075-177">После закрытия и возврата соединения в пул с прикрепленной транзакцией `System.Transactions` оно резервируется таким образом, что следующий запрос к пулу соединений с той же транзакцией `System.Transactions` вернет это соединение, если оно доступно.</span><span class="sxs-lookup"><span data-stu-id="78075-177">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="78075-178">Если при выдаче такого запроса в пуле нет доступных соединений, соединение берется и прикрепляется из части пула, не использующей транзакции.</span><span class="sxs-lookup"><span data-stu-id="78075-178">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="78075-179">Если доступных соединений нет во всех частях пула, создается и прикрепляется новое соединение.</span><span class="sxs-lookup"><span data-stu-id="78075-179">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="78075-180">При закрытии соединения оно освобождается обратно в пул и в соответствующий подраздел в зависимости от его контекста транзакции.</span><span class="sxs-lookup"><span data-stu-id="78075-180">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="78075-181">Поэтому можно закрыть соединение без создания ошибки, даже если распределенная транзакция все еще находится в ожидании.</span><span class="sxs-lookup"><span data-stu-id="78075-181">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="78075-182">Это позволит зафиксировать или отменить распределенную транзакцию позже.</span><span class="sxs-lookup"><span data-stu-id="78075-182">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="78075-183">Управление пулами соединений с помощью ключевых слов строки соединения</span><span class="sxs-lookup"><span data-stu-id="78075-183">Controlling Connection Pooling with Connection String Keywords</span></span>  
 <span data-ttu-id="78075-184">Свойство `ConnectionString` объекта <xref:System.Data.SqlClient.SqlConnection> поддерживает пары «ключ-значение» из строки соединения, с помощью которых можно изменять логику организации пулов соединений.</span><span class="sxs-lookup"><span data-stu-id="78075-184">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="78075-185">Дополнительные сведения см. в разделе <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="78075-185">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="78075-186">Фрагментация пула</span><span class="sxs-lookup"><span data-stu-id="78075-186">Pool Fragmentation</span></span>  
 <span data-ttu-id="78075-187">Фрагментация пула является распространенной проблемой для многих веб-приложений, в которых может создаваться большое количество пулов, которые не освобождаются, пока существует процесс.</span><span class="sxs-lookup"><span data-stu-id="78075-187">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="78075-188">Это оставляет большое количество соединений открытыми и потребляющими память, что приводит к ухудшению производительности.</span><span class="sxs-lookup"><span data-stu-id="78075-188">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="78075-189">Фрагментация пула из-за встроенной безопасности</span><span class="sxs-lookup"><span data-stu-id="78075-189">Pool Fragmentation Due to Integrated Security</span></span>  
 <span data-ttu-id="78075-190">Соединения заносятся в пул в соответствии со строкой соединения, а также удостоверением пользователя.</span><span class="sxs-lookup"><span data-stu-id="78075-190">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="78075-191">Таким образом, при использовании на веб-узле обычной проверки подлинности или проверки подлинности Windows, а также встроенной безопасности имени входа получается один пул на пользователя.</span><span class="sxs-lookup"><span data-stu-id="78075-191">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="78075-192">Несмотря на то, что это улучшает производительность последующих запросов пользователя к базе данных, для него недоступны преимущества соединений, установленных другими пользователями.</span><span class="sxs-lookup"><span data-stu-id="78075-192">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="78075-193">Это также приводит по крайней мере к одному соединению с сервером базы данных для каждого пользователя.</span><span class="sxs-lookup"><span data-stu-id="78075-193">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="78075-194">Это является побочным эффектом данной архитектуры веб-приложений, который разработчики должны соизмерить с требованиями безопасности и аудита.</span><span class="sxs-lookup"><span data-stu-id="78075-194">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="78075-195">Фрагментация пула из-за многочисленных баз данных</span><span class="sxs-lookup"><span data-stu-id="78075-195">Pool Fragmentation Due to Many Databases</span></span>  
 <span data-ttu-id="78075-196">Многие поставщики услуг Интернет размещают несколько веб-узлов на одиночном сервере.</span><span class="sxs-lookup"><span data-stu-id="78075-196">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="78075-197">Они могут использовать одну базу данных для подтверждения проверки подлинности имени входа с помощью форм и затем открывать соединение с определенной базой данных для этого пользователя или группы пользователей.</span><span class="sxs-lookup"><span data-stu-id="78075-197">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="78075-198">Соединение с базой данных проверки подлинности заносится в пул и используется всеми.</span><span class="sxs-lookup"><span data-stu-id="78075-198">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="78075-199">Однако для каждой базы данных существует отдельный пул соединений, увеличивающий количество соединений с сервером.</span><span class="sxs-lookup"><span data-stu-id="78075-199">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="78075-200">Это также является побочным эффектом конструкции приложений.</span><span class="sxs-lookup"><span data-stu-id="78075-200">This is also a side-effect of the application design.</span></span> <span data-ttu-id="78075-201">При соединении с SQL Server существует относительно простой способ устранения этого побочного эффекта без нарушения безопасности.</span><span class="sxs-lookup"><span data-stu-id="78075-201">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="78075-202">Вместо соединения каждого пользователя или группы с отдельной базой данных устанавливается соединение с одной базой данных на сервере, а затем выполняется инструкция Transact-SQL USE, чтобы переключиться на требуемую базу данных.</span><span class="sxs-lookup"><span data-stu-id="78075-202">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="78075-203">Следующий фрагмент кода демонстрирует создание первоначального соединения с базой данных `master` и последующее переключение на требуемую базу данных, указанную в строковой переменной `databaseName`.</span><span class="sxs-lookup"><span data-stu-id="78075-203">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="78075-204">Роли приложений и пул соединений</span><span class="sxs-lookup"><span data-stu-id="78075-204">Application Roles and Connection Pooling</span></span>  
 <span data-ttu-id="78075-205">После активации роли приложения SQL Server с помощью вызова системной хранимой процедуры `sp_setapprole` контекст безопасности данного соединения сбросить нельзя.</span><span class="sxs-lookup"><span data-stu-id="78075-205">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="78075-206">Однако, если использование пула включено, соединение возвращается в пул и при повторном использовании соединения возникает ошибка.</span><span class="sxs-lookup"><span data-stu-id="78075-206">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="78075-207">Дополнительные сведения см. в статье базы знаний "[ошибки роли приложения SQL с OLE DB пула ресурсов](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)".</span><span class="sxs-lookup"><span data-stu-id="78075-207">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="78075-208">Альтернативы ролям приложений</span><span class="sxs-lookup"><span data-stu-id="78075-208">Application Role Alternatives</span></span>  
 <span data-ttu-id="78075-209">Рекомендуется пользоваться преимуществом новых механизмов безопасности, которые пришли на смену ролям приложения.</span><span class="sxs-lookup"><span data-stu-id="78075-209">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="78075-210">Дополнительные сведения см. [в разделе Создание ролей приложения в SQL Server](../../../../docs/framework/data/adonet/sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="78075-210">For more information, see [Creating Application Roles in SQL Server](../../../../docs/framework/data/adonet/sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="78075-211">См. также</span><span class="sxs-lookup"><span data-stu-id="78075-211">See also</span></span>

- [<span data-ttu-id="78075-212">Объединение подключений в пул</span><span class="sxs-lookup"><span data-stu-id="78075-212">Connection Pooling</span></span>](../../../../docs/framework/data/adonet/connection-pooling.md)
- [<span data-ttu-id="78075-213">SQL Server и ADO.NET</span><span class="sxs-lookup"><span data-stu-id="78075-213">SQL Server and ADO.NET</span></span>](../../../../docs/framework/data/adonet/sql/index.md)
- [<span data-ttu-id="78075-214">Счетчики производительности</span><span class="sxs-lookup"><span data-stu-id="78075-214">Performance Counters</span></span>](../../../../docs/framework/data/adonet/performance-counters.md)
- [<span data-ttu-id="78075-215">Центр разработчиков наборов данных и управляемых поставщиков ADO.NET</span><span class="sxs-lookup"><span data-stu-id="78075-215">ADO.NET Managed Providers and DataSet Developer Center</span></span>](https://go.microsoft.com/fwlink/?LinkId=217917)
