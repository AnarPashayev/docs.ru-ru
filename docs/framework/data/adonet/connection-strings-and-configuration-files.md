---
title: Строки подключения и файлы конфигурации
description: Узнайте, как хранить строки подключения для приложений ADO.NET в файле конфигурации приложения, как рекомендуется для обеспечения безопасности и обслуживания.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 37df2641-661e-407a-a3fb-7bf9540f01e8
ms.openlocfilehash: e2bea3d962998b2778d22e232e7f7062cfda3143
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2020
ms.locfileid: "91148414"
---
# <a name="connection-strings-and-configuration-files"></a><span data-ttu-id="59a9f-103">Строки подключения и файлы конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-103">Connection Strings and Configuration Files</span></span>

<span data-ttu-id="59a9f-104">Внедрение строк соединения в код приложения может привести к появлению уязвимых мест в системе безопасности и проблем с обслуживанием.</span><span class="sxs-lookup"><span data-stu-id="59a9f-104">Embedding connection strings in your application's code can lead to security vulnerabilities and maintenance problems.</span></span> <span data-ttu-id="59a9f-105">Незашифрованные строки подключения, скомпилированные в исходный код приложения, можно просматривать с помощью средства [Ildasm.exe (IL Disassembler)](../../tools/ildasm-exe-il-disassembler.md).</span><span class="sxs-lookup"><span data-stu-id="59a9f-105">Unencrypted connection strings compiled into an application's source code can be viewed using the [Ildasm.exe (IL Disassembler)](../../tools/ildasm-exe-il-disassembler.md) tool.</span></span> <span data-ttu-id="59a9f-106">Кроме того, после изменения строки соединения необходимо перекомпилировать приложение.</span><span class="sxs-lookup"><span data-stu-id="59a9f-106">Moreover, if the connection string ever changes, your application must be recompiled.</span></span> <span data-ttu-id="59a9f-107">По этим причинам рекомендуется хранить строки соединения в файле конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-107">For these reasons, we recommend storing connection strings in an application configuration file.</span></span>  
  
## <a name="working-with-application-configuration-files"></a><span data-ttu-id="59a9f-108">Работа с файлами конфигурации приложения</span><span class="sxs-lookup"><span data-stu-id="59a9f-108">Working with Application Configuration Files</span></span>  

 <span data-ttu-id="59a9f-109">Файлы конфигурации приложения содержат настройки, относящиеся к отдельному приложению.</span><span class="sxs-lookup"><span data-stu-id="59a9f-109">Application configuration files contain settings that are specific to a particular application.</span></span> <span data-ttu-id="59a9f-110">Например, приложение ASP.NET может иметь один или несколько файлов **web.config**, а приложение Windows — дополнительный файл **app.config**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-110">For example, an ASP.NET application can have one or more **web.config** files, and a Windows application can have an optional **app.config** file.</span></span> <span data-ttu-id="59a9f-111">В файлах конфигурации присутствуют общие элементы, хотя имя и расположение любого файла конфигурации в значительной степени зависят от того, где размещается приложение.</span><span class="sxs-lookup"><span data-stu-id="59a9f-111">Configuration files share common elements, although the name and location of a configuration file vary depending on the application's host.</span></span>  
  
### <a name="the-connectionstrings-section"></a><span data-ttu-id="59a9f-112">Раздел connectionStrings</span><span class="sxs-lookup"><span data-stu-id="59a9f-112">The connectionStrings Section</span></span>  

 <span data-ttu-id="59a9f-113">Строки подключения могут храниться в виде пар "ключ/значение" в разделе **connectionStrings** элемента **configuration** файла конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-113">Connection strings can be stored as key/value pairs in the **connectionStrings** section of the **configuration** element of an application configuration file.</span></span> <span data-ttu-id="59a9f-114">Дочерние элементы включают **add**, **clear** и **remove**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-114">Child elements include **add**, **clear**, and **remove**.</span></span>  
  
 <span data-ttu-id="59a9f-115">Следующий фрагмент файла конфигурации демонстрирует схему и синтаксис хранения строки соединения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-115">The following configuration file fragment demonstrates the schema and syntax for storing a connection string.</span></span> <span data-ttu-id="59a9f-116">Атрибут **name** является именем, которое задано для уникальной идентификации строки подключения, чтобы ее можно было получить во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-116">The **name** attribute is a name that you provide to uniquely identify a connection string so that it can be retrieved at run time.</span></span> <span data-ttu-id="59a9f-117">Атрибут **providerName** является неизменяемым именем поставщика данных .NET Framework, которое регистрируется в файле machine.config.</span><span class="sxs-lookup"><span data-stu-id="59a9f-117">The **providerName** is the invariant name of the .NET Framework data provider, which is registered in the machine.config file.</span></span>  
  
```xml  
<?xml version='1.0' encoding='utf-8'?>  
  <configuration>  
    <connectionStrings>  
      <clear />  
      <add name="Name"
       providerName="System.Data.ProviderName"
       connectionString="Valid Connection String;" />  
    </connectionStrings>  
  </configuration>  
```  
  
> [!NOTE]
> <span data-ttu-id="59a9f-118">Можно сохранить часть строки соединения в файле конфигурации и для ее дополнения во время выполнения использовать класс <xref:System.Data.Common.DbConnectionStringBuilder>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-118">You can save part of a connection string in a configuration file and use the <xref:System.Data.Common.DbConnectionStringBuilder> class to complete it at run time.</span></span> <span data-ttu-id="59a9f-119">Это удобно в сценариях, в которых заранее неизвестны элементы строки соединения или желательно не сохранять конфиденциальные данные в файле конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-119">This is useful in scenarios where you do not know elements of the connection string ahead of time, or when you do not want to save sensitive information in a configuration file.</span></span> <span data-ttu-id="59a9f-120">Дополнительные сведения см. в статье [Connection String Builders](connection-string-builders.md) (Построители строк подключения).</span><span class="sxs-lookup"><span data-stu-id="59a9f-120">For more information, see [Connection String Builders](connection-string-builders.md).</span></span>  
  
### <a name="using-external-configuration-files"></a><span data-ttu-id="59a9f-121">Использование внешних файлов конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-121">Using External Configuration Files</span></span>  

 <span data-ttu-id="59a9f-122">Внешние файлы конфигурации представляют собой отдельные файлы, каждый из которых содержит фрагмент файла конфигурации, состоящий из одного раздела.</span><span class="sxs-lookup"><span data-stu-id="59a9f-122">External configuration files are separate files that contain a fragment of a configuration file consisting of a single section.</span></span> <span data-ttu-id="59a9f-123">В таком случае основной файл конфигурации ссылается на внешний файл конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-123">The external configuration file is then referenced by the main configuration file.</span></span> <span data-ttu-id="59a9f-124">Хранение раздела **connectionStrings** в физически отдельном файле становится удобным в ситуациях, когда может потребоваться внесение изменений в строки подключения после развертывания приложения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-124">Storing the **connectionStrings** section in a physically separate file is useful in situations where connection strings may be edited after the application is deployed.</span></span> <span data-ttu-id="59a9f-125">Например, в ASP.NET по умолчанию после изменения файлов конфигурации осуществляется перезапуск домена приложения, что приводит к потере сведений о состоянии.</span><span class="sxs-lookup"><span data-stu-id="59a9f-125">For example, the standard ASP.NET behavior is to restart an application domain when configuration files are modified, which results in state information being lost.</span></span> <span data-ttu-id="59a9f-126">Но изменение внешнего файла конфигурации не вызывает перезапуск приложения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-126">However, modifying an external configuration file does not cause an application restart.</span></span> <span data-ttu-id="59a9f-127">Возможность применения внешних файлов конфигурации не ограничивается ASP.NET; их можно также использовать в приложениях Windows.</span><span class="sxs-lookup"><span data-stu-id="59a9f-127">External configuration files are not limited to ASP.NET; they can also be used by Windows applications.</span></span> <span data-ttu-id="59a9f-128">Кроме того, для ограничения доступа к внешним файлам конфигурации могут использоваться средства обеспечения безопасности доступа к файлам и разрешения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-128">In addition, file access security and permissions can be used to restrict access to external configuration files.</span></span> <span data-ttu-id="59a9f-129">Работа с внешними файлами конфигурации во время выполнения осуществляется в прозрачном режиме и не требует разработки специального кода.</span><span class="sxs-lookup"><span data-stu-id="59a9f-129">Working with external configuration files at run time is transparent, and requires no special coding.</span></span>  
  
 <span data-ttu-id="59a9f-130">Для хранения строк подключения во внешнем файле конфигурации создайте отдельный файл, содержащий единственный раздел **connectionStrings**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-130">To store connection strings in an external configuration file, create a separate file that contains only the **connectionStrings** section.</span></span> <span data-ttu-id="59a9f-131">Не следует включать какие-либо дополнительные элементы, разделы или атрибуты.</span><span class="sxs-lookup"><span data-stu-id="59a9f-131">Do not include any additional elements, sections, or attributes.</span></span> <span data-ttu-id="59a9f-132">В данном примере показан синтаксис внешнего файла конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-132">This example shows the syntax for an external configuration file.</span></span>  
  
```xml  
<connectionStrings>  
  <add name="Name"
   providerName="System.Data.ProviderName"
   connectionString="Valid Connection String;" />  
</connectionStrings>  
```  
  
 <span data-ttu-id="59a9f-133">В основном файле конфигурации приложения для указания полного имени и расположения внешнего файла используется атрибут **configSource**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-133">In the main application configuration file, you use the **configSource** attribute to specify the fully qualified name and location of the external file.</span></span> <span data-ttu-id="59a9f-134">В следующем примере применяется ссылка на внешний файл конфигурации с именем `connections.config`.</span><span class="sxs-lookup"><span data-stu-id="59a9f-134">This example refers to an external configuration file named `connections.config`.</span></span>  
  
```xml  
<?xml version='1.0' encoding='utf-8'?>  
<configuration>  
    <connectionStrings configSource="connections.config"/>  
</configuration>  
```  
  
## <a name="retrieving-connection-strings-at-run-time"></a><span data-ttu-id="59a9f-135">Получение строк соединения во время выполнения</span><span class="sxs-lookup"><span data-stu-id="59a9f-135">Retrieving Connection Strings at Run Time</span></span>  

 <span data-ttu-id="59a9f-136">В .NET Framework 2.0 в пространстве имен <xref:System.Configuration> появились новые классы, упрощающие извлечение строк подключения из файлов конфигурации во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-136">The .NET Framework 2.0 introduced new classes in the <xref:System.Configuration> namespace to simplify retrieving connection strings from configuration files at run time.</span></span> <span data-ttu-id="59a9f-137">Предусмотрена возможность получить строку соединения программным путем по ее имени или по имени поставщика.</span><span class="sxs-lookup"><span data-stu-id="59a9f-137">You can programmatically retrieve a connection string by name or by provider name.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-138">Файл **machine.config** также содержит раздел **connectionStrings**, включающий строку подключения, используемую Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="59a9f-138">The **machine.config** file also contains a **connectionStrings** section, which contains connection strings used by Visual Studio.</span></span> <span data-ttu-id="59a9f-139">При извлечении строк подключения по имени поставщика из файла **app.config** в приложении Windows сначала загружаются строки подключения в **machine.config** , а затем записи из **app.config**. Добавление **clear** сразу после элемента **ConnectionString** удаляет все унаследованные ссылки из структуры данных в памяти, поэтому учитываются только строки подключения, определенные в локальном файле **app.config** .</span><span class="sxs-lookup"><span data-stu-id="59a9f-139">When retrieving connection strings by provider name from the **app.config** file in a Windows application, the connection strings in **machine.config** get loaded first, and then the entries from **app.config**. Adding **clear** immediately after the **connectionStrings** element removes all inherited references from the data structure in memory, so that only the connection strings defined in the local **app.config** file are considered.</span></span>  
  
### <a name="working-with-the-configuration-classes"></a><span data-ttu-id="59a9f-140">Работа с классами конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-140">Working with the Configuration Classes</span></span>  

 <span data-ttu-id="59a9f-141">Начиная с версии .NET Framework 2.0, для работы с файлами конфигурации на локальном компьютере используется класс <xref:System.Configuration.ConfigurationManager>, который заменил устаревший класс <xref:System.Configuration.ConfigurationSettings>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-141">Starting with the .NET Framework 2.0, <xref:System.Configuration.ConfigurationManager> is used when working with configuration files on the local computer, replacing the deprecated <xref:System.Configuration.ConfigurationSettings>.</span></span> <span data-ttu-id="59a9f-142"><xref:System.Web.Configuration.WebConfigurationManager> служит для работы с файлами конфигурации ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="59a9f-142"><xref:System.Web.Configuration.WebConfigurationManager> is used to work with ASP.NET configuration files.</span></span> <span data-ttu-id="59a9f-143">Он создан для работы с файлами конфигурации веб-сервера и предоставляет программный доступ к разделам файла конфигураций, например **system.web**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-143">It is designed to work with configuration files on a Web server, and allows programmatic access to configuration file sections such as **system.web**.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-144">Вызывающему объекту для доступа к файлам конфигурации во время выполнения должны быть предоставлены разрешения. Требуемые разрешения зависят от типа приложения, файла конфигурации и расположения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-144">Accessing configuration files at run time requires granting permissions to the caller; the required permissions depend on the type of application, configuration file, and location.</span></span> <span data-ttu-id="59a9f-145">Дополнительные сведения см. в разделах [Использование классов конфигурации](/previous-versions/aspnet/ms228063(v=vs.100)) и <xref:System.Web.Configuration.WebConfigurationManager> для приложений ASP.NET и <xref:System.Configuration.ConfigurationManager> для приложений Windows.</span><span class="sxs-lookup"><span data-stu-id="59a9f-145">For more information, see [Using the Configuration Classes](/previous-versions/aspnet/ms228063(v=vs.100)) and <xref:System.Web.Configuration.WebConfigurationManager> for ASP.NET applications, and <xref:System.Configuration.ConfigurationManager> for Windows applications.</span></span>  
  
 <span data-ttu-id="59a9f-146">Для получения строк соединения из файлов конфигурации приложения используется <xref:System.Configuration.ConnectionStringSettingsCollection>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-146">You can use the <xref:System.Configuration.ConnectionStringSettingsCollection> to retrieve connection strings from application configuration files.</span></span> <span data-ttu-id="59a9f-147">Этот объект содержит коллекцию объектов <xref:System.Configuration.ConnectionStringSettings>, каждый из которых представляет одну запись в разделе **connectionStrings**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-147">It contains a collection of <xref:System.Configuration.ConnectionStringSettings> objects, each of which represents a single entry in the **connectionStrings** section.</span></span> <span data-ttu-id="59a9f-148">Его свойства сопоставляются с атрибутами строк соединения, что позволяет получить строку соединения, указав имя строки или имя поставщика.</span><span class="sxs-lookup"><span data-stu-id="59a9f-148">Its properties map to connection string attributes, allowing you to retrieve a connection string by specifying the name or the provider name.</span></span>  
  
|<span data-ttu-id="59a9f-149">Свойство</span><span class="sxs-lookup"><span data-stu-id="59a9f-149">Property</span></span>|<span data-ttu-id="59a9f-150">Описание</span><span class="sxs-lookup"><span data-stu-id="59a9f-150">Description</span></span>|  
|--------------|-----------------|  
|<xref:System.Configuration.ConnectionStringSettings.Name%2A>|<span data-ttu-id="59a9f-151">Имя строки соединения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-151">The name of the connection string.</span></span> <span data-ttu-id="59a9f-152">Сопоставляется с атрибутом **name**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-152">Maps to the **name** attribute.</span></span>|  
|<xref:System.Configuration.ConnectionStringSettings.ProviderName%2A>|<span data-ttu-id="59a9f-153">Полное имя поставщика.</span><span class="sxs-lookup"><span data-stu-id="59a9f-153">The fully qualified provider name.</span></span> <span data-ttu-id="59a9f-154">Сопоставляется с атрибутом **providerName**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-154">Maps to the **providerName** attribute.</span></span>|  
|<xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A>|<span data-ttu-id="59a9f-155">Строка подключения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-155">The connection string.</span></span> <span data-ttu-id="59a9f-156">Сопоставляется с атрибутом **connectionString**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-156">Maps to the **connectionString** attribute.</span></span>|  
  
### <a name="example-listing-all-connection-strings"></a><span data-ttu-id="59a9f-157">Пример. Список всех строк соединения</span><span class="sxs-lookup"><span data-stu-id="59a9f-157">Example: Listing All Connection Strings</span></span>  

 <span data-ttu-id="59a9f-158">В этом примере выполняется итерация по <xref:System.Configuration.ConnectionStringSettingsCollection> и отображаются <xref:System.Configuration.ConnectionStringSettings.Name%2A?displayProperty=nameWithType> свойства, <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A?displayProperty=nameWithType> и <xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A?displayProperty=nameWithType> в окне консоли.</span><span class="sxs-lookup"><span data-stu-id="59a9f-158">This example iterates through the <xref:System.Configuration.ConnectionStringSettingsCollection> and displays the <xref:System.Configuration.ConnectionStringSettings.Name%2A?displayProperty=nameWithType>, <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A?displayProperty=nameWithType>, and <xref:System.Configuration.ConnectionStringSettings.ConnectionString%2A?displayProperty=nameWithType> properties in the console window.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-159">Файл System.Configuration.dll не включается в проекты всех типов, поэтому для использования классов конфигурации может потребоваться сформировать на него ссылку.</span><span class="sxs-lookup"><span data-stu-id="59a9f-159">System.Configuration.dll is not included in all project types, and you may need to set a reference to it in order to use the configuration classes.</span></span> <span data-ttu-id="59a9f-160">Имя и расположение файла конфигурации определенного приложения зависит от типа приложения и процесса размещения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-160">The name and location of a particular application configuration file varies by the type of application and the hosting process.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfig#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfig/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfig#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfig/VB/source.vb#1)]  
  
### <a name="example-retrieving-a-connection-string-by-name"></a><span data-ttu-id="59a9f-161">Пример. Извлечение строки соединения по имени</span><span class="sxs-lookup"><span data-stu-id="59a9f-161">Example: Retrieving a Connection String by Name</span></span>  

 <span data-ttu-id="59a9f-162">Данный пример демонстрирует способ получения строки соединения из файла конфигурации путем указания ее имени.</span><span class="sxs-lookup"><span data-stu-id="59a9f-162">This example demonstrates how to retrieve a connection string from a configuration file by specifying its name.</span></span> <span data-ttu-id="59a9f-163">Код создает объект <xref:System.Configuration.ConnectionStringSettings>, сопоставляя указанный входной параметр с именем <xref:System.Configuration.ConfigurationManager.ConnectionStrings%2A>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-163">The code creates a <xref:System.Configuration.ConnectionStringSettings> object, matching the supplied input parameter to the <xref:System.Configuration.ConfigurationManager.ConnectionStrings%2A> name.</span></span> <span data-ttu-id="59a9f-164">Если совпадающее имя не найдено, функция возвращает значение `null` (`Nothing` в Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="59a9f-164">If no matching name is found, the function returns `null` (`Nothing` in Visual Basic).</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfigByName#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByName/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfigByName#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByName/VB/source.vb#1)]  
  
### <a name="example-retrieving-a-connection-string-by-provider-name"></a><span data-ttu-id="59a9f-165">Пример. Извлечение строки соединения по имени поставщика</span><span class="sxs-lookup"><span data-stu-id="59a9f-165">Example: Retrieving a Connection String by Provider Name</span></span>  

 <span data-ttu-id="59a9f-166">В этом примере демонстрируется способ получения строки подключения путем указания неизменяемого имени поставщика в формате *System.Data.ProviderName*.</span><span class="sxs-lookup"><span data-stu-id="59a9f-166">This example demonstrates how to retrieve a connection string by specifying the provider-invariant name in the format *System.Data.ProviderName*.</span></span> <span data-ttu-id="59a9f-167">В коде выполняется итерация по <xref:System.Configuration.ConnectionStringSettingsCollection> и происходит возврат строки соединения для первого найденного <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-167">The code iterates through the <xref:System.Configuration.ConnectionStringSettingsCollection> and returns the connection string for the first <xref:System.Configuration.ConnectionStringSettings.ProviderName%2A> found.</span></span> <span data-ttu-id="59a9f-168">Если имя поставщика не найдено, функция возвращает значение `null` (`Nothing` в Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="59a9f-168">If the provider name is not found, the function returns `null` (`Nothing` in Visual Basic).</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringSettings.RetrieveFromConfigByProvider/VB/source.vb#1)]  
  
## <a name="encrypting-configuration-file-sections-using-protected-configuration"></a><span data-ttu-id="59a9f-169">Шифрование разделов файлов конфигурации с использованием защищенной конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-169">Encrypting Configuration File Sections Using Protected Configuration</span></span>  

 <span data-ttu-id="59a9f-170">В ASP.NET 2.0 появилась новая возможность, *защищенная конфигурация*, с помощью которой можно шифровать в файле конфигурации конфиденциальную информацию.</span><span class="sxs-lookup"><span data-stu-id="59a9f-170">ASP.NET 2.0 introduced a new feature, called *protected configuration*, that enables you to encrypt sensitive information in a configuration file.</span></span> <span data-ttu-id="59a9f-171">Защищенная конфигурация разрабатывалась в первую очередь для ASP.NET, но ее можно также использовать для шифрования разделов файлов конфигурации в приложениях Windows.</span><span class="sxs-lookup"><span data-stu-id="59a9f-171">Although primarily designed for ASP.NET, protected configuration can also be used to encrypt configuration file sections in Windows applications.</span></span> <span data-ttu-id="59a9f-172">Подробное описание возможностей защищенной конфигурации см. в разделе [Шифрование сведений о конфигурации с помощью функции защищенной конфигурации](/previous-versions/aspnet/53tyfkaw(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="59a9f-172">For a detailed description of the protected configuration capabilities, see [Encrypting Configuration Information Using Protected Configuration](/previous-versions/aspnet/53tyfkaw(v=vs.100)).</span></span>  
  
 <span data-ttu-id="59a9f-173">В приведенном ниже фрагменте файла конфигурации показан раздел **connectionStrings** после шифрования.</span><span class="sxs-lookup"><span data-stu-id="59a9f-173">The following configuration file fragment shows the **connectionStrings** section after it has been encrypted.</span></span> <span data-ttu-id="59a9f-174">В разделе **configProtectionProvider** задается поставщик защищенной конфигурации, который используется для шифрования и дешифрования строк подключения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-174">The **configProtectionProvider** specifies the protected configuration provider used to encrypt and decrypt the connection strings.</span></span> <span data-ttu-id="59a9f-175">Раздел **EncryptedData** содержит зашифрованный текст.</span><span class="sxs-lookup"><span data-stu-id="59a9f-175">The **EncryptedData** section contains the cipher text.</span></span>  
  
```xml  
<connectionStrings configProtectionProvider="DataProtectionConfigurationProvider">  
  <EncryptedData>  
    <CipherData>  
      <CipherValue>AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAH2... </CipherValue>  
    </CipherData>  
  </EncryptedData>  
</connectionStrings>  
```  
  
 <span data-ttu-id="59a9f-176">Когда зашифрованная строка подключения извлекается во время выполнения, платформа .NET Framework с помощью указанного поставщика дешифрует значение **CipherValue** и передает его приложению.</span><span class="sxs-lookup"><span data-stu-id="59a9f-176">When the encrypted connection string is retrieved at run time, the .NET Framework uses the specified provider to decrypt the **CipherValue** and make it available to your application.</span></span> <span data-ttu-id="59a9f-177">Нет необходимости создавать дополнительный код для управления процессом дешифрования.</span><span class="sxs-lookup"><span data-stu-id="59a9f-177">You do not need to write any additional code to manage the decryption process.</span></span>  
  
### <a name="protected-configuration-providers"></a><span data-ttu-id="59a9f-178">Поставщики защищенной конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-178">Protected Configuration Providers</span></span>  

 <span data-ttu-id="59a9f-179">Поставщики защищенной конфигурации регистрируются в разделе **configProtectedData** файла **machine.config** на локальном компьютере, как показано в приведенном ниже фрагменте, в котором демонстрируются два поставщика защищенной конфигурации, поставляемые с платформой .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="59a9f-179">Protected configuration providers are registered in the **configProtectedData** section of the **machine.config** file on the local computer, as shown in the following fragment, which shows the two protected configuration providers supplied with the .NET Framework.</span></span> <span data-ttu-id="59a9f-180">Показанные значения были усечены для удобства чтения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-180">The values shown here have been truncated for readability.</span></span>  
  
```xml  
<configProtectedData defaultProvider="RsaProtectedConfigurationProvider">  
  <providers>  
    <add name="RsaProtectedConfigurationProvider"
      type="System.Configuration.RsaProtectedConfigurationProvider" />  
    <add name="DataProtectionConfigurationProvider"
      type="System.Configuration.DpapiProtectedConfigurationProvider" />  
  </providers>  
</configProtectedData>  
```  
  
 <span data-ttu-id="59a9f-181">Можно назначить дополнительные поставщики защищенной конфигурации, добавляя их в файл **machine.config**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-181">You can configure additional protected configuration providers by adding them to the **machine.config** file.</span></span> <span data-ttu-id="59a9f-182">Кроме того, можно создать собственный поставщик защищенной конфигурации путем наследования от абстрактного базового класса <xref:System.Configuration.ProtectedConfigurationProvider>.</span><span class="sxs-lookup"><span data-stu-id="59a9f-182">You can also create your own protected configuration provider by inheriting from the <xref:System.Configuration.ProtectedConfigurationProvider> abstract base class.</span></span> <span data-ttu-id="59a9f-183">В приведенной ниже таблице дано описание двух файлов конфигурации, входящих в платформу .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="59a9f-183">The following table describes the two configuration files included with the .NET Framework.</span></span>  
  
|<span data-ttu-id="59a9f-184">Поставщик</span><span class="sxs-lookup"><span data-stu-id="59a9f-184">Provider</span></span>|<span data-ttu-id="59a9f-185">Описание</span><span class="sxs-lookup"><span data-stu-id="59a9f-185">Description</span></span>|  
|--------------|-----------------|  
|<xref:System.Configuration.RsaProtectedConfigurationProvider>|<span data-ttu-id="59a9f-186">Использует алгоритм RSA для шифрования и расшифровки данных.</span><span class="sxs-lookup"><span data-stu-id="59a9f-186">Uses the RSA encryption algorithm to encrypt and decrypt data.</span></span> <span data-ttu-id="59a9f-187">Алгоритм RSA можно использовать для шифрования с открытым ключом и цифровых сигнатур.</span><span class="sxs-lookup"><span data-stu-id="59a9f-187">The RSA algorithm can be used for both public key encryption and digital signatures.</span></span> <span data-ttu-id="59a9f-188">Он также известен как алгоритм с «открытым ключом» или алгоритм асимметричного шифрования, поскольку в нем используется два разных ключа.</span><span class="sxs-lookup"><span data-stu-id="59a9f-188">It is also known as "public key" or asymmetrical encryption because it employs two different keys.</span></span> <span data-ttu-id="59a9f-189">Для шифрования разделов в файле Web.config и управления ключами шифрования можно использовать [средство регистрации служб IIS ASP.NET (Aspnet_regiis.exe)](/previous-versions/dotnet/netframework-3.5/k6h9cz8h(v=vs.90)).</span><span class="sxs-lookup"><span data-stu-id="59a9f-189">You can use the [ASP.NET IIS Registration Tool (Aspnet_regiis.exe)](/previous-versions/dotnet/netframework-3.5/k6h9cz8h(v=vs.90)) to encrypt sections in a Web.config file and manage the encryption keys.</span></span> <span data-ttu-id="59a9f-190">ASP.NET расшифровывает файл конфигурации при обработке файла.</span><span class="sxs-lookup"><span data-stu-id="59a9f-190">ASP.NET decrypts the configuration file when it processes the file.</span></span> <span data-ttu-id="59a9f-191">Удостоверение приложения ASP.NET должно иметь права на чтение ключа шифрования, который используется для шифрования и расшифровки зашифрованных разделов.</span><span class="sxs-lookup"><span data-stu-id="59a9f-191">The identity of the ASP.NET application must have read access to the encryption key that is used to encrypt and decrypt the encrypted sections.</span></span>|  
|<xref:System.Configuration.DpapiProtectedConfigurationProvider>|<span data-ttu-id="59a9f-192">Использует API-интерфейс защиты данных (DPAPI) для шифрования разделов конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-192">Uses the Windows Data Protection API (DPAPI) to encrypt configuration sections.</span></span> <span data-ttu-id="59a9f-193">Он использует встроенные службы шифрования Windows и может быть настроен для защиты отдельных компьютеров или отдельных учетных записей пользователей.</span><span class="sxs-lookup"><span data-stu-id="59a9f-193">It uses the Windows built-in cryptographic services and can be configured for either machine-specific or user-account-specific protection.</span></span> <span data-ttu-id="59a9f-194">Защиту отдельных компьютеров удобно использовать для нескольких приложений на одном сервере, которым требуется совместное использование данных.</span><span class="sxs-lookup"><span data-stu-id="59a9f-194">Machine-specific protection is useful for multiple applications on the same server that need to share information.</span></span> <span data-ttu-id="59a9f-195">Защиту учетных записей можно использовать со службами, выполняемыми с определенным удостоверением пользователя, например с общей средой размещения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-195">User-account-specific protection can be used with services that run with a specific user identity, such as a shared hosting environment.</span></span> <span data-ttu-id="59a9f-196">Каждое приложение выполняется с отдельным удостоверением, которое ограничивает доступ к ресурсам, например к файлам и базам данных.</span><span class="sxs-lookup"><span data-stu-id="59a9f-196">Each application runs under a separate identity which restricts access to resources such as files and databases.</span></span>|  
  
 <span data-ttu-id="59a9f-197">Оба поставщика обеспечивают надежное шифрование данных.</span><span class="sxs-lookup"><span data-stu-id="59a9f-197">Both providers offer strong encryption of data.</span></span> <span data-ttu-id="59a9f-198">Однако, если планируется использовать один файл конфигурации на нескольких серверах, как в веб-ферме, то только <xref:System.Configuration.RsaProtectedConfigurationProvider> позволяет экспортировать ключи шифрования, применяемые для шифрования данных, и импортировать их в другой сервер.</span><span class="sxs-lookup"><span data-stu-id="59a9f-198">However, if you are planning to use the same encrypted configuration file on multiple servers, such as a Web farm, only the <xref:System.Configuration.RsaProtectedConfigurationProvider> enables you to export the encryption keys used to encrypt the data and import them on another server.</span></span> <span data-ttu-id="59a9f-199">Дополнительные сведения см. в разделе [Импорт и экспорт защищенных контейнеров ключей RSA для конфигурации](/previous-versions/aspnet/yxw286t2(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="59a9f-199">For more information, see [Importing and Exporting Protected Configuration RSA Key Containers](/previous-versions/aspnet/yxw286t2(v=vs.100)).</span></span>  
  
### <a name="using-the-configuration-classes"></a><span data-ttu-id="59a9f-200">Использование классов конфигурации</span><span class="sxs-lookup"><span data-stu-id="59a9f-200">Using the Configuration Classes</span></span>  

 <span data-ttu-id="59a9f-201">Пространство имен <xref:System.Configuration> предоставляет классы для программной обработки параметров конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-201">The <xref:System.Configuration> namespace provides classes to work with configuration settings programmatically.</span></span> <span data-ttu-id="59a9f-202">Класс <xref:System.Configuration.ConfigurationManager> обеспечивает доступ к компьютеру, приложению и пользовательским файлам конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-202">The <xref:System.Configuration.ConfigurationManager> class provides access to machine, application, and user configuration files.</span></span> <span data-ttu-id="59a9f-203">При создании приложения ASP.NET можно использовать <xref:System.Web.Configuration.WebConfigurationManager> класс, который предоставляет те же функциональные возможности, а также обеспечивает доступ к параметрам, уникальным для приложений ASP.NET, например, которые находятся в **\<system.web>** .</span><span class="sxs-lookup"><span data-stu-id="59a9f-203">If you are creating an ASP.NET application, you can use the <xref:System.Web.Configuration.WebConfigurationManager> class, which provides the same functionality while also allowing you to access settings that are unique to ASP.NET applications, such as those found in **\<system.web>**.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-204">Пространство имен <xref:System.Security.Cryptography> содержит классы, которые предоставляют дополнительные возможности шифрования и расшифровки данных.</span><span class="sxs-lookup"><span data-stu-id="59a9f-204">The <xref:System.Security.Cryptography> namespace contains classes that provide additional options for encrypting and decrypting data.</span></span> <span data-ttu-id="59a9f-205">Эти классы можно использовать в том случае, если требуются криптографические службы, недоступные с использованием защищенной конфигурации.</span><span class="sxs-lookup"><span data-stu-id="59a9f-205">Use these classes if you require cryptographic services that are not available using protected configuration.</span></span> <span data-ttu-id="59a9f-206">Некоторые из этих классов являются оболочками для Microsoft CryptoAPI, а другие представляют собой реализации полностью на управляемом коде.</span><span class="sxs-lookup"><span data-stu-id="59a9f-206">Some of these classes are wrappers for the unmanaged Microsoft CryptoAPI, while others are purely managed implementations.</span></span> <span data-ttu-id="59a9f-207">Дополнительные сведения см. в разделе [Службы криптографии](/previous-versions/visualstudio/visual-studio-2008/93bskf9z(v=vs.90)).</span><span class="sxs-lookup"><span data-stu-id="59a9f-207">For more information, see [Cryptographic Services](/previous-versions/visualstudio/visual-studio-2008/93bskf9z(v=vs.90)).</span></span>  
  
### <a name="appconfig-example"></a><span data-ttu-id="59a9f-208">Пример App.config</span><span class="sxs-lookup"><span data-stu-id="59a9f-208">App.config Example</span></span>  

 <span data-ttu-id="59a9f-209">Этот пример демонстрирует переключение шифрования раздела **connectionStrings** в файле **app.config** для приложения Windows.</span><span class="sxs-lookup"><span data-stu-id="59a9f-209">This example demonstrates how to toggle encrypting the **connectionStrings** section in an **app.config** file for a Windows application.</span></span> <span data-ttu-id="59a9f-210">В этом примере процедура принимает имя приложения в качестве аргумента, например, «MyApplication.exe».</span><span class="sxs-lookup"><span data-stu-id="59a9f-210">In this example, the procedure takes the name of the application as an argument, for example, "MyApplication.exe".</span></span> <span data-ttu-id="59a9f-211">Затем файл **app.config** зашифровывается и копируется в папку, которая содержит исполняемый файл с именем MyApplication.exe.config.</span><span class="sxs-lookup"><span data-stu-id="59a9f-211">The **app.config** file will then be encrypted and copied to the folder that contains the executable under the name of "MyApplication.exe.config".</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-212">Строку соединения можно расшифровать только на компьютере, где она была зашифрована.</span><span class="sxs-lookup"><span data-stu-id="59a9f-212">The connection string can only be decrypted on the computer on which it was encrypted.</span></span>  
  
 <span data-ttu-id="59a9f-213">В коде используется метод <xref:System.Configuration.ConfigurationManager.OpenExeConfiguration%2A>, чтобы открыть файл **app.config** для изменения, а метод <xref:System.Configuration.ConfigurationManager.GetSection%2A> возвращает раздел **connectionStrings**.</span><span class="sxs-lookup"><span data-stu-id="59a9f-213">The code uses the <xref:System.Configuration.ConfigurationManager.OpenExeConfiguration%2A> method to open the **app.config** file for editing, and the <xref:System.Configuration.ConfigurationManager.GetSection%2A> method returns the **connectionStrings** section.</span></span> <span data-ttu-id="59a9f-214">Затем код проверяет свойство <xref:System.Configuration.SectionInformation.IsProtected%2A>, вызывая метод <xref:System.Configuration.SectionInformation.ProtectSection%2A> для шифрования раздела, если он не зашифрован.</span><span class="sxs-lookup"><span data-stu-id="59a9f-214">The code then checks the <xref:System.Configuration.SectionInformation.IsProtected%2A> property, calling the <xref:System.Configuration.SectionInformation.ProtectSection%2A> to encrypt the section if it is not encrypted.</span></span> <span data-ttu-id="59a9f-215">Метод <xref:System.Configuration.SectionInformation.UnprotectSection%2A> вызывается для расшифровки раздела.</span><span class="sxs-lookup"><span data-stu-id="59a9f-215">The <xref:System.Configuration.SectionInformation.UnprotectSection%2A> method is invoked to decrypt the section.</span></span> <span data-ttu-id="59a9f-216">Метод <xref:System.Configuration.Configuration.Save%2A> завершает операцию и сохраняет изменения.</span><span class="sxs-lookup"><span data-stu-id="59a9f-216">The <xref:System.Configuration.Configuration.Save%2A> method completes the operation and saves the changes.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="59a9f-217">Для запуска кода необходимо задать ссылку на `System.Configuration.dll` в проекте.</span><span class="sxs-lookup"><span data-stu-id="59a9f-217">You must set a reference to `System.Configuration.dll` in your project for the code to run.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStrings.Encrypt#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStrings.Encrypt/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStrings.Encrypt#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStrings.Encrypt/VB/source.vb#1)]  
  
### <a name="webconfig-example"></a><span data-ttu-id="59a9f-218">Пример Web.config</span><span class="sxs-lookup"><span data-stu-id="59a9f-218">Web.config Example</span></span>  

 <span data-ttu-id="59a9f-219">В этом примере используется метод <xref:System.Web.Configuration.WebConfigurationManager.OpenWebConfiguration%2A> класса `WebConfigurationManager`.</span><span class="sxs-lookup"><span data-stu-id="59a9f-219">This example uses the <xref:System.Web.Configuration.WebConfigurationManager.OpenWebConfiguration%2A> method of the `WebConfigurationManager`.</span></span> <span data-ttu-id="59a9f-220">Обратите внимание, что в этом случае можно задать относительный путь к файлу **Web.config** с использованием символа "тильда".</span><span class="sxs-lookup"><span data-stu-id="59a9f-220">Note that in this case you can supply the relative path to the **Web.config** file by using a tilde.</span></span> <span data-ttu-id="59a9f-221">В коде должна быть ссылка на класс `System.Web.Configuration`.</span><span class="sxs-lookup"><span data-stu-id="59a9f-221">The code requires a reference to the `System.Web.Configuration` class.</span></span>  
  
 [!code-csharp[DataWorks ConnectionStringsWeb.Encrypt#1](../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks ConnectionStringsWeb.Encrypt/CS/source.cs#1)]
 [!code-vb[DataWorks ConnectionStringsWeb.Encrypt#1](../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks ConnectionStringsWeb.Encrypt/VB/source.vb#1)]  
  
 <span data-ttu-id="59a9f-222">Дополнительные сведения о защите приложений ASP.NET см. в статье [Защита веб-сайтов ASP.NET](/previous-versions/aspnet/91f66yxt(v=vs.100)).</span><span class="sxs-lookup"><span data-stu-id="59a9f-222">For more information about securing ASP.NET applications, see [Securing ASP.NET web sites](/previous-versions/aspnet/91f66yxt(v=vs.100)).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="59a9f-223">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="59a9f-223">See also</span></span>

- [<span data-ttu-id="59a9f-224">Построители строк подключения</span><span class="sxs-lookup"><span data-stu-id="59a9f-224">Connection String Builders</span></span>](connection-string-builders.md)
- [<span data-ttu-id="59a9f-225">Защита сведений о подключении</span><span class="sxs-lookup"><span data-stu-id="59a9f-225">Protecting Connection Information</span></span>](protecting-connection-information.md)
- <span data-ttu-id="59a9f-226">[Использование классов конфигурации](/previous-versions/visualstudio/visual-studio-2008/ms228063(v=vs.90))</span><span class="sxs-lookup"><span data-stu-id="59a9f-226">[Using the Configuration Classes](/previous-versions/visualstudio/visual-studio-2008/ms228063(v=vs.90))</span></span>
- [<span data-ttu-id="59a9f-227">Настройка приложений</span><span class="sxs-lookup"><span data-stu-id="59a9f-227">Configuring Apps</span></span>](../../configure-apps/index.md)
- <span data-ttu-id="59a9f-228">[Администрирование веб-сайта ASP.NET](/previous-versions/aspnet/6hy1xzbw(v=vs.100))</span><span class="sxs-lookup"><span data-stu-id="59a9f-228">[ASP.NET Web Site Administration](/previous-versions/aspnet/6hy1xzbw(v=vs.100))</span></span>
- [<span data-ttu-id="59a9f-229">Общие сведения об ADO.NET</span><span class="sxs-lookup"><span data-stu-id="59a9f-229">ADO.NET Overview</span></span>](ado-net-overview.md)
