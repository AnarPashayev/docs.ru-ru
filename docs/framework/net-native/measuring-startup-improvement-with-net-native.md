---
title: Измерение улучшения запуска с машинным кодом .NET
ms.date: 03/30/2017
ms.assetid: c4d25b24-9c1a-4b3e-9705-97ba0d6c0289
ms.openlocfilehash: 5d20fa77ee299065ced406bf8cd531b8c54b6c33
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/15/2020
ms.locfileid: "90540892"
---
# <a name="measuring-startup-improvement-with-net-native"></a><span data-ttu-id="7d166-102">Измерение улучшения запуска с машинным кодом .NET</span><span class="sxs-lookup"><span data-stu-id="7d166-102">Measuring Startup Improvement with .NET Native</span></span>
<span data-ttu-id="7d166-103">.NET Native значительно улучшает время запуска приложений.</span><span class="sxs-lookup"><span data-stu-id="7d166-103">.NET Native significantly improves the launch time of apps.</span></span> <span data-ttu-id="7d166-104">Это улучшение особенно заметно на портативных устройствах малой мощности, а также при сложных приложениях.</span><span class="sxs-lookup"><span data-stu-id="7d166-104">This improvement is particularly noticeable on portable, low-powered devices and with complex apps.</span></span> <span data-ttu-id="7d166-105">Этот раздел поможет вам приступить к работе с основным инструментарием, который необходим для измерения данного улучшения запуска.</span><span class="sxs-lookup"><span data-stu-id="7d166-105">This topic helps you get started with the basic instrumentation needed to measure this startup improvement.</span></span>  
  
 <span data-ttu-id="7d166-106">Для облегчения анализа производительности, платформа.NET Framework и Windows используют платформу трассировки событий для Windows (ETW), которая позволяет приложениям уведомлять средства для работы при возникновении событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-106">To facilitate performance investigations, the .NET Framework and Windows use an event framework called Event Tracing for Windows (ETW) that allows your app to notify tooling when events happen.</span></span> <span data-ttu-id="7d166-107">Затем можно использовать инструмент PerfView для просмотра и анализа событий ЕТW.</span><span class="sxs-lookup"><span data-stu-id="7d166-107">You can then use a tool called PerfView to easily view and analyze of ETW events.</span></span> <span data-ttu-id="7d166-108">В этом разделе объясняется, как:</span><span class="sxs-lookup"><span data-stu-id="7d166-108">This topic explains how to:</span></span>  
  
- <span data-ttu-id="7d166-109">Использовать класс <xref:System.Diagnostics.Tracing.EventSource> для порождения событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-109">Use the <xref:System.Diagnostics.Tracing.EventSource> class to emit events.</span></span>  
  
- <span data-ttu-id="7d166-110">Использовать PerfView для сбора событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-110">Use PerfView to gather those events.</span></span>  
  
- <span data-ttu-id="7d166-111">Использовать PerfView для отображения событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-111">Use PerfView to display those events.</span></span>  
  
## <a name="using-eventsource-to-emit-events"></a><span data-ttu-id="7d166-112">Использование EventSource для порождения событий</span><span class="sxs-lookup"><span data-stu-id="7d166-112">Using EventSource to emit events</span></span>  
 <span data-ttu-id="7d166-113"><xref:System.Diagnostics.Tracing.EventSource>предоставляет базовый класс для создания настраиваемого поставщика событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-113"><xref:System.Diagnostics.Tracing.EventSource> provides a base class from which to create a custom event provider.</span></span> <span data-ttu-id="7d166-114">Как правило, создается подкласс <xref:System.Diagnostics.Tracing.EventSource> и методы `Write*` помещаются в оболочку с вашими собственными методами событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-114">Generally, you create a subclass of <xref:System.Diagnostics.Tracing.EventSource> and wrap the `Write*` methods with your own event methods.</span></span> <span data-ttu-id="7d166-115">Обычно используется единый шаблон для каждого <xref:System.Diagnostics.Tracing.EventSource>.</span><span class="sxs-lookup"><span data-stu-id="7d166-115">A singleton pattern is generally used for each <xref:System.Diagnostics.Tracing.EventSource>.</span></span>  
  
 <span data-ttu-id="7d166-116">Например, в следующем примере класс может использоваться для измерения двух характеристик производительности:</span><span class="sxs-lookup"><span data-stu-id="7d166-116">For example, the class in the following example can be used to measure two performance characteristics:</span></span>  
  
- <span data-ttu-id="7d166-117">времени до вызова конструктора класса `App`.</span><span class="sxs-lookup"><span data-stu-id="7d166-117">The time until the `App` class constructor was called.</span></span>  
  
- <span data-ttu-id="7d166-118">времени до вызова конструктора класса `MainPage`.</span><span class="sxs-lookup"><span data-stu-id="7d166-118">The time until the `MainPage` constructor was called.</span></span>  
  
 [!code-csharp[ProjectN_ETW#1](../../../samples/snippets/csharp/VS_Snippets_CLR/projectn_etw/cs/etw1.cs#1)]  
  
 <span data-ttu-id="7d166-119">Здесь необходимо обратить внимание на несколько моментов.</span><span class="sxs-lookup"><span data-stu-id="7d166-119">There are a few things to notice here.</span></span> <span data-ttu-id="7d166-120">Во-первых, создается единственный элемент в `AppEventSource.Log`.</span><span class="sxs-lookup"><span data-stu-id="7d166-120">First, a singleton is created in `AppEventSource.Log`.</span></span> <span data-ttu-id="7d166-121">Этот экземпляр будет использоваться для ведения журналов.</span><span class="sxs-lookup"><span data-stu-id="7d166-121">That instance will be used for all logging.</span></span> <span data-ttu-id="7d166-122">Во-вторых, каждый метод событий имеет <xref:System.Diagnostics.Tracing.EventAttribute>.</span><span class="sxs-lookup"><span data-stu-id="7d166-122">Second, each event method has an <xref:System.Diagnostics.Tracing.EventAttribute>.</span></span> <span data-ttu-id="7d166-123">Это позволяет средствам для работы связать индекс метода <xref:System.Diagnostics.Tracing.EventSource.WriteEvent%2A> с методом, который был вызван на `AppEventSource`.</span><span class="sxs-lookup"><span data-stu-id="7d166-123">This helps tooling associate the index of the <xref:System.Diagnostics.Tracing.EventSource.WriteEvent%2A> method with the method that was called on `AppEventSource`.</span></span>  
  
 <span data-ttu-id="7d166-124">Обратите внимание, что эти события являются чисто иллюстративными.</span><span class="sxs-lookup"><span data-stu-id="7d166-124">Note that these events are purely illustrative.</span></span> <span data-ttu-id="7d166-125">Большая часть кода приложения будет выполняться после этих событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-125">Most app code will run after these events.</span></span> <span data-ttu-id="7d166-126">Следует понимать, какие события в коде соответствуют взаимодействию с пользователем, измерять их и улучшить их показатели.</span><span class="sxs-lookup"><span data-stu-id="7d166-126">You should understand which events in code correspond to user interactions, measure those, and improve those benchmarks.</span></span> <span data-ttu-id="7d166-127">Кроме того, сами события заносят в журнал только один экземпляр за все время.</span><span class="sxs-lookup"><span data-stu-id="7d166-127">Also, the events themselves log only a single instance in time.</span></span> <span data-ttu-id="7d166-128">Часто бывает полезно иметь пару начала и окончания событий для каждой операции.</span><span class="sxs-lookup"><span data-stu-id="7d166-128">It’s often useful to have paired start and stop events for every operation.</span></span> <span data-ttu-id="7d166-129">При проверке запуска приложения в качестве события запуска, как правило, используется событие "Process/Start" (Запуск процесса), которое порождает операционная система.</span><span class="sxs-lookup"><span data-stu-id="7d166-129">When examining app startup, the start event is generally the "Process/Start" event that the operating system emits.</span></span>  
  
 <span data-ttu-id="7d166-130">Например, предположим, что создается программа чтения RSS-каналов.</span><span class="sxs-lookup"><span data-stu-id="7d166-130">For example, suppose you are creating an RSS reader.</span></span> <span data-ttu-id="7d166-131">Несколько интересных мест для занесения событий в журнал:</span><span class="sxs-lookup"><span data-stu-id="7d166-131">A few interesting locations to log an event are:</span></span>  
  
- <span data-ttu-id="7d166-132">При первом отображении главной страницы.</span><span class="sxs-lookup"><span data-stu-id="7d166-132">When the main page is first rendered.</span></span>  
  
- <span data-ttu-id="7d166-133">При десериализации старой истории RSS из локального хранилища.</span><span class="sxs-lookup"><span data-stu-id="7d166-133">When old RSS stories are deserialized from local storage.</span></span>  
  
- <span data-ttu-id="7d166-134">Когда приложение начинает синхронизацию новых историй.</span><span class="sxs-lookup"><span data-stu-id="7d166-134">When your app begins syncing new stories.</span></span>  
  
- <span data-ttu-id="7d166-135">Когда приложение завершило синхронизацию новых историй.</span><span class="sxs-lookup"><span data-stu-id="7d166-135">When your app has finished syncing new stories.</span></span>  
  
 <span data-ttu-id="7d166-136">Инструментировать приложения очень просто: достаточно вызвать соответствующий метод в производном классе.</span><span class="sxs-lookup"><span data-stu-id="7d166-136">Instrumenting an app is straightforward: Just call the appropriate method on the derived class.</span></span> <span data-ttu-id="7d166-137">С помощью `AppEventSource` из предыдущего примера можно инструментировать приложение следующим образом:</span><span class="sxs-lookup"><span data-stu-id="7d166-137">Using `AppEventSource` from the previous example, you can instrument an app as follows:</span></span>  
  
 [!code-csharp[ProjectN_ETW#2](../../../samples/snippets/csharp/VS_Snippets_CLR/projectn_etw/cs/etw2.cs#2)]  
  
 <span data-ttu-id="7d166-138">После инструментирования приложения можно приступить к сбору событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-138">When the app is instrumented, you’re ready to gather events.</span></span>  
  
## <a name="gathering-events-with-perfview"></a><span data-ttu-id="7d166-139">Сбор событий с PerfView</span><span class="sxs-lookup"><span data-stu-id="7d166-139">Gathering events with PerfView</span></span>  
 <span data-ttu-id="7d166-140">PerfView использует события ЕТW для облегчения выполнения всех видов анализа производительности приложения.</span><span class="sxs-lookup"><span data-stu-id="7d166-140">PerfView uses ETW events to help you do all sorts of performance investigations on your app.</span></span> <span data-ttu-id="7d166-141">Это средство также содержит графический интерфейс настройки, который позволяет включать и выключать ведение журнала для различных типов событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-141">It also includes a configuration GUI that lets you turn logging for different types of events on or off.</span></span> <span data-ttu-id="7d166-142">Средство PerfView предоставляется бесплатно. Его можно скачать из [Центра загрузки Майкрософт](https://www.microsoft.com/download/details.aspx?id=28567).</span><span class="sxs-lookup"><span data-stu-id="7d166-142">PerfView is a free tool and can be downloaded from the [Microsoft Download Center](https://www.microsoft.com/download/details.aspx?id=28567).</span></span> <span data-ttu-id="7d166-143">Дополнительные сведения см. в [обучающих видеороликах по PerfView](https://channel9.msdn.com/Series/PerfView-Tutorial).</span><span class="sxs-lookup"><span data-stu-id="7d166-143">For more information, watch the [PerfView tutorial videos](https://channel9.msdn.com/Series/PerfView-Tutorial).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="7d166-144">PerfView не может использоваться для сбора событий в системах ARM.</span><span class="sxs-lookup"><span data-stu-id="7d166-144">PerfView cannot be used to collect events on ARM systems.</span></span> <span data-ttu-id="7d166-145">Для сбора событий в системах ARM, используйте средство записи производительности Windows (WPR).</span><span class="sxs-lookup"><span data-stu-id="7d166-145">To collect events on ARM systems, use Windows Performance Recorder (WPR).</span></span> <span data-ttu-id="7d166-146">Дополнительные сведения см. в [записи в блоге Вэнса Моррисона](/archive/blogs/vancem/collecting-etwperfview-data-on-an-windows-rt-winrt-arm-surface-device).</span><span class="sxs-lookup"><span data-stu-id="7d166-146">For more information, see [Vance Morrison's blog post](/archive/blogs/vancem/collecting-etwperfview-data-on-an-windows-rt-winrt-arm-surface-device).</span></span>  
  
 <span data-ttu-id="7d166-147">PerfView также можно вызвать из командной строки.</span><span class="sxs-lookup"><span data-stu-id="7d166-147">You can also invoke PerfView from the command line.</span></span> <span data-ttu-id="7d166-148">Чтобы занести в журнал только события своего поставщика, откройте окно командной строки и введите команду:</span><span class="sxs-lookup"><span data-stu-id="7d166-148">To log only the events from your provider, open the Command Prompt window and enter the command:</span></span>  
  
```console
perfview -KernelEvents:Process -OnlyProviders:*MyCompany-MyApp collect outputFile
```  
  
 <span data-ttu-id="7d166-149">где:</span><span class="sxs-lookup"><span data-stu-id="7d166-149">where:</span></span>  
  
 `-KernelEvents:Process`  
 <span data-ttu-id="7d166-150">Указывает, что вам необходимо знать, когда процесс запускается и останавливается.</span><span class="sxs-lookup"><span data-stu-id="7d166-150">Indicates that you want to know when the process starts and stops.</span></span> <span data-ttu-id="7d166-151">Для приложения необходимо событие Process/Start, чтобы оно могло быть вычтено из времени других событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-151">You need the Process/Start event for your app so it can be subtracted from other event times.</span></span>  
  
 `-OnlyProviders:*MyCompany-MyApp`  
 <span data-ttu-id="7d166-152">Отключает других поставщиков, которые PerfView включает по умолчанию и включает поставщика MyCompany MyApp.</span><span class="sxs-lookup"><span data-stu-id="7d166-152">Turns off other providers that PerfView turns on by default, and turns on the MyCompany-MyApp provider.</span></span>  <span data-ttu-id="7d166-153">(Звездочка означает, что это <xref:System.Diagnostics.Tracing.EventSource>.)</span><span class="sxs-lookup"><span data-stu-id="7d166-153">(The asterisk indicates that it is an <xref:System.Diagnostics.Tracing.EventSource>.)</span></span>  
  
 `collect outputFile`  
 <span data-ttu-id="7d166-154">Указывает, что необходимо начать сбор и сохранение данных outputFile.etl.zip.</span><span class="sxs-lookup"><span data-stu-id="7d166-154">Indicates that you want to start collection and save the data to outputFile.etl.zip.</span></span>  
  
 <span data-ttu-id="7d166-155">Выполнение приложения после запуска PerfView.</span><span class="sxs-lookup"><span data-stu-id="7d166-155">Run your app after starting PerfView.</span></span> <span data-ttu-id="7d166-156">Есть несколько моментов, которые необходимо помнить при запуске приложения.</span><span class="sxs-lookup"><span data-stu-id="7d166-156">There are a few things to remember when running your app:</span></span>  
  
- <span data-ttu-id="7d166-157">Используйте построение выпуска, а не отладочное построение.</span><span class="sxs-lookup"><span data-stu-id="7d166-157">Use a release build, not a debug build.</span></span> <span data-ttu-id="7d166-158">Отладочные построения часто содержат проверку дополнительных ошибок и ошибок обработки кода, в результате чего приложение будет работать медленнее, чем ожидалось.</span><span class="sxs-lookup"><span data-stu-id="7d166-158">Debug builds often contain extra error checking and error handling code that can cause your app to run slower than expected.</span></span>  
  
- <span data-ttu-id="7d166-159">Выполнение приложений с подключенным отладчиком влияет на  его производительность.</span><span class="sxs-lookup"><span data-stu-id="7d166-159">Running your app with a debugger attached affects the performance of your app.</span></span>  
  
- <span data-ttu-id="7d166-160">Windows использует несколько стратегий кэширования, чтобы ускорить время запуска приложения.</span><span class="sxs-lookup"><span data-stu-id="7d166-160">Windows uses multiple caching strategies to speed up app launch times.</span></span> <span data-ttu-id="7d166-161">Если ваше приложение кэшировано в памяти и его не нужно загружать с диска, оно запускается быстрее.</span><span class="sxs-lookup"><span data-stu-id="7d166-161">If your app is currently cached in memory and doesn't have to be loaded from disk, it will start faster.</span></span> <span data-ttu-id="7d166-162">Для обеспечения согласованности, запустите и закройте приложение несколько раз перед его измерением.</span><span class="sxs-lookup"><span data-stu-id="7d166-162">To ensure consistency, start and close your app a few times before measuring it.</span></span>  
  
 <span data-ttu-id="7d166-163">После запуска приложения и завершения сбора данных о событиях в PerfView нажмите кнопку **Остановить сбор**.</span><span class="sxs-lookup"><span data-stu-id="7d166-163">When you’ve run your app so that PerfView can collect emitted events, choose the **Stop Collection** button.</span></span> <span data-ttu-id="7d166-164">Как правило, следует остановить сбор перед закрытием приложения, чтобы не получить посторонних событий.</span><span class="sxs-lookup"><span data-stu-id="7d166-164">Generally, you should stop collection before closing your app so you don’t get extraneous events.</span></span> <span data-ttu-id="7d166-165">Тем не менее, если измеряется быстродействия завершения работы или приостановки, будет необходимо продолжить сбор.</span><span class="sxs-lookup"><span data-stu-id="7d166-165">However, if you’re measuring shutdown or suspension performance, you’ll want to continue collection.</span></span>  
  
## <a name="displaying-the-events"></a><span data-ttu-id="7d166-166">Отображение событий</span><span class="sxs-lookup"><span data-stu-id="7d166-166">Displaying the events</span></span>  
 <span data-ttu-id="7d166-167">Чтобы просмотреть уже собранные события, откройте созданный файл .etl или. etl.zip в PerfView и нажмите кнопку **События**.</span><span class="sxs-lookup"><span data-stu-id="7d166-167">To view the events that have already been collected, use PerfView to open the .etl or .etl.zip file you created and choose **Events**.</span></span> <span data-ttu-id="7d166-168">К этому моменту ETW уже соберет информацию о большом количестве событий, в том числе о событиях из других процессов.</span><span class="sxs-lookup"><span data-stu-id="7d166-168">ETW will have collected information about a large number of events, including events from other processes.</span></span> <span data-ttu-id="7d166-169">Чтобы сузить ваш анализ на определенных измерениях, заполните следующие текстовые поля в представлении событий:</span><span class="sxs-lookup"><span data-stu-id="7d166-169">To focus your investigation, complete the following text boxes in the events view:</span></span>  
  
- <span data-ttu-id="7d166-170">В поле **Фильтр процесса** укажите имя приложения (без ".exe").</span><span class="sxs-lookup"><span data-stu-id="7d166-170">In the **Process Filter** box, specify your app name (without ".exe").</span></span>  
  
- <span data-ttu-id="7d166-171">В поле **Фильтр типов событий** укажите `Process/Start | MyCompany-MyApp`.</span><span class="sxs-lookup"><span data-stu-id="7d166-171">In the **Event Types Filter** box, specify `Process/Start | MyCompany-MyApp`.</span></span> <span data-ttu-id="7d166-172">Это задает фильтр событий из MyCompany MyApp и события Windows Kernel/Process/Start (Ядро/процесс/запуск). </span><span class="sxs-lookup"><span data-stu-id="7d166-172">This sets a filter for events from MyCompany-MyApp and the Windows Kernel/Process/Start event.</span></span>  
  
 <span data-ttu-id="7d166-173">Выберите все события, указанные в области слева (CTRL+A), и нажмите клавишу **ВВОД**.</span><span class="sxs-lookup"><span data-stu-id="7d166-173">Select all the events listed in the left pane (Ctrl-A) and choose the **Enter** key.</span></span> <span data-ttu-id="7d166-174">Теперь можно будет видеть метки времени каждого события.</span><span class="sxs-lookup"><span data-stu-id="7d166-174">Now, you should be able to see the timestamps from each event.</span></span> <span data-ttu-id="7d166-175">Эти метки времени измеряются относительно начала трассировки, поэтому следует вычесть время каждого события из времени запуска процесса, чтобы определить время, прошедшее с момента запуска.</span><span class="sxs-lookup"><span data-stu-id="7d166-175">These timestamps are relative to the start of the trace, so you have to subtract the time of each event from the start time of the process to identify the elapsed time since startup.</span></span> <span data-ttu-id="7d166-176">При использовании Ctrl + щелчок для выбора двух меток времени, вы увидите, что разница между ними отображается в строке состояния в нижней части страницы.</span><span class="sxs-lookup"><span data-stu-id="7d166-176">If you use Ctrl+Click to select two timestamps, you'll see the difference between them displayed in the status bar at the bottom of the page.</span></span> <span data-ttu-id="7d166-177">Это позволяет легко увидеть время, прошедшее между любыми двумя событиями, на экране (включая запуск процесса).</span><span class="sxs-lookup"><span data-stu-id="7d166-177">This makes it easy to see the elapsed time between any two events in the display (including process start).</span></span> <span data-ttu-id="7d166-178">Можно открыть контекстное меню представления и выбрать различные полезные параметры, например, экспорт в файлы CSV или открытие Microsoft Excel для сохранения или обработки данных.</span><span class="sxs-lookup"><span data-stu-id="7d166-178">You can open the shortcut menu for the view and select from a number of useful options, like exporting to CSV files or opening Microsoft Excel to save or process the data.</span></span>  
  
 <span data-ttu-id="7d166-179">Повторяя процедуру для исходного приложения и версии, созданной с помощью цепочки инструментов .NET Native, можно сравнить разницу в производительности.</span><span class="sxs-lookup"><span data-stu-id="7d166-179">By repeating the procedure for both your original app and the version you built by using the .NET Native tool chain, you can compare the difference in performance.</span></span>   <span data-ttu-id="7d166-180">.NET Native приложения обычно запускаются быстрее, чем non-.NET собственные приложения.</span><span class="sxs-lookup"><span data-stu-id="7d166-180">.NET Native apps generally start faster than non-.NET Native apps.</span></span> <span data-ttu-id="7d166-181">Если вы заинтересованы в более глубокой информации, то PerfView также может определить части кода, на выполнение которых уходит больше всего времени.</span><span class="sxs-lookup"><span data-stu-id="7d166-181">If you’re interested in digging deeper, PerfView can also identify the parts of your code that are taking the most time.</span></span> <span data-ttu-id="7d166-182">Дополнительные сведения см. в [руководствах по PerfView](https://channel9.msdn.com/Series/PerfView-Tutorial) или в [записи в блоге Вэнса Моррисона](/archive/blogs/vancem/publication-of-the-perfview-performance-analysis-tool).</span><span class="sxs-lookup"><span data-stu-id="7d166-182">For more information, watch the [PerfView tutorials](https://channel9.msdn.com/Series/PerfView-Tutorial) or read [Vance Morrison’s blog entry](/archive/blogs/vancem/publication-of-the-perfview-performance-analysis-tool).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="7d166-183">См. также</span><span class="sxs-lookup"><span data-stu-id="7d166-183">See also</span></span>

- <xref:System.Diagnostics.Tracing.EventSource>
