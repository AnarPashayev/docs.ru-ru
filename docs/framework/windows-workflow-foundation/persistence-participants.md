---
title: Участники сохраняемости
ms.date: 03/30/2017
ms.assetid: f84d2d5d-1c1b-4f19-be45-65b552d3e9e3
ms.openlocfilehash: 0bff6cc8fafb1832dc4d0e33b754fe3adb81dcf6
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "96246112"
---
# <a name="persistence-participants"></a><span data-ttu-id="a4b98-102">Участники сохраняемости</span><span class="sxs-lookup"><span data-stu-id="a4b98-102">Persistence Participants</span></span>

<span data-ttu-id="a4b98-103">Участник сохраняемости может участвовать в операции сохраняемости («Сохранение» или «Загрузка»), запущенной узлом приложения.</span><span class="sxs-lookup"><span data-stu-id="a4b98-103">A persistence participant can participate in a persistence operation (Save or Load) triggered by an application host.</span></span> <span data-ttu-id="a4b98-104">В [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] поставляется с двумя абстрактными классами, **PersistenceParticipant** и **PersistenceIOParticipant**, которые можно использовать для создания участника сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-104">The [!INCLUDE[netfx_current_long](../../../includes/netfx-current-long-md.md)] ships with two abstract classes, **PersistenceParticipant** and **PersistenceIOParticipant**, which you can use to create a persistence participant.</span></span> <span data-ttu-id="a4b98-105">Участник сохраняемости создается как производное от одного из этих классов, реализует методы, представляющие интерес, а затем добавляет экземпляр класса в коллекцию <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> узла <xref:System.ServiceModel.Activities.WorkflowServiceHost>.</span><span class="sxs-lookup"><span data-stu-id="a4b98-105">A persistence participant derives from one of these classes, implements the methods of interest, and then adds an instance of the class to the <xref:System.ServiceModel.Activities.WorkflowServiceHost.WorkflowExtensions%2A> collection on the <xref:System.ServiceModel.Activities.WorkflowServiceHost> .</span></span> <span data-ttu-id="a4b98-106">Узел приложения может искать такие расширения рабочих процессов при сохранении экземпляра рабочего процесса и в нужное время вызывать соответствующие методы для участников сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-106">The application host may look for such workflow extensions when persisting a workflow instance and invoke appropriate methods on the persistence participants at appropriate times.</span></span>  
  
 <span data-ttu-id="a4b98-107">В следующем списке описываются задачи, выполняемые подсистемой сохраняемости на разных стадиях операции сохраняемости (Сохранение).</span><span class="sxs-lookup"><span data-stu-id="a4b98-107">The following list describes the tasks performed by the persistence subsystem in different stages of the Persist (Save) operation.</span></span> <span data-ttu-id="a4b98-108">Участники сохраняемости используются на третей и четвертой стадиях.</span><span class="sxs-lookup"><span data-stu-id="a4b98-108">The persistence participants are used in the third and fourth stages.</span></span> <span data-ttu-id="a4b98-109">Если участник является участником ввода-вывода (участником сохраняемости, который также участвует в операциях ввода-вывода), участник также используется на шестом этапе.</span><span class="sxs-lookup"><span data-stu-id="a4b98-109">If the participant is an I/O participant (a persistence participant that also participates in I/O operations), the participant is also used in the sixth stage.</span></span>  
  
1. <span data-ttu-id="a4b98-110">Собирает встроенные значения, включая состояние рабочего процесса, закладки, сопоставленные переменные и метки времени.</span><span class="sxs-lookup"><span data-stu-id="a4b98-110">Gathers built-in values, including workflow state, bookmarks, mapped variables, and timestamp.</span></span>  
  
2. <span data-ttu-id="a4b98-111">Собирает всех участников сохраняемости, которые были добавлены в коллекцию модулей, связанных с экземпляром рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="a4b98-111">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
3. <span data-ttu-id="a4b98-112">Вызывает метод <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A>, реализуемый всеми участниками сохранения.</span><span class="sxs-lookup"><span data-stu-id="a4b98-112">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.CollectValues%2A> method implemented by all persistence participants.</span></span>  
  
4. <span data-ttu-id="a4b98-113">Вызывает метод <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A>, реализуемый всеми участниками сохранения.</span><span class="sxs-lookup"><span data-stu-id="a4b98-113">Invokes the <xref:System.Activities.Persistence.PersistenceParticipant.MapValues%2A> method implemented by all persistence participants.</span></span>  
  
5. <span data-ttu-id="a4b98-114">Сохраняет рабочий процесс в хранилище сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-114">Persist or save the workflow into the persistence store.</span></span>  
  
6. <span data-ttu-id="a4b98-115">Вызывает <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> метод для всех участников ввода-вывода сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-115">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnSave%2A> method on all of the persistence I/O participants.</span></span> <span data-ttu-id="a4b98-116">Если участник не является участником ввода-вывода, эта задача пропускается.</span><span class="sxs-lookup"><span data-stu-id="a4b98-116">If the participant is not an I/O participant, this task is skipped.</span></span> <span data-ttu-id="a4b98-117">Если эпизод сохраняемости транзакционный, транзакция предоставляется в свойстве Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="a4b98-117">If the persistence episode is transactional, the transaction is provided in Transaction.Current property.</span></span>  
  
7. <span data-ttu-id="a4b98-118">Ждет завершения работы всех участников сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-118">Waits for all persistence participants to complete.</span></span> <span data-ttu-id="a4b98-119">Фиксирует транзакцию, если все участники успешно сохраняют данные экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a4b98-119">If all the participants succeed in persisting instance data, commits the transaction.</span></span>  
  
 <span data-ttu-id="a4b98-120">Участник сохраняемости является производным от класса **PersistenceParticipant** и может реализовывать методы **CollectValues** и **MapValues** .</span><span class="sxs-lookup"><span data-stu-id="a4b98-120">A persistence participant derives from the **PersistenceParticipant** class and may implement the **CollectValues** and **MapValues** methods.</span></span> <span data-ttu-id="a4b98-121">Участник сохраняемого ввода-вывода является производным от класса **PersistenceIOParticipant** и может реализовать метод **бегинонсаве** в дополнение к реализации методов **CollectValues** и **MapValues** .</span><span class="sxs-lookup"><span data-stu-id="a4b98-121">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnSave** method in addition to implementing the **CollectValues** and **MapValues** methods.</span></span>  
  
 <span data-ttu-id="a4b98-122">Каждая следующая стадия начинается только после завершения предыдущей.</span><span class="sxs-lookup"><span data-stu-id="a4b98-122">Each stage is completed before the next stage begins.</span></span> <span data-ttu-id="a4b98-123">Например, значения собираются из **всех** участников сохраняемости на первом этапе.</span><span class="sxs-lookup"><span data-stu-id="a4b98-123">For example, values are collected from **all** persistence participants in the first stage.</span></span> <span data-ttu-id="a4b98-124">На второй стадии все значения, собранные на первой стадии, предоставляются всем участникам сохраняемости для сопоставления.</span><span class="sxs-lookup"><span data-stu-id="a4b98-124">Then all the values collected in the first stage are provided to all persistence participants in the second stage for mapping.</span></span> <span data-ttu-id="a4b98-125">Затем все значения, собранные и сопоставленные на первой и второй стадиях, предоставляются поставщику сохраняемости на третьей стадии и так далее.</span><span class="sxs-lookup"><span data-stu-id="a4b98-125">Then all the values collected and mapped in the first and second stages are provided to the persistence provider in the third stage, and so on.</span></span>  
  
 <span data-ttu-id="a4b98-126">В следующем списке описываются задачи, выполняемые подсистемой сохраняемости на разных стадиях операции загрузки.</span><span class="sxs-lookup"><span data-stu-id="a4b98-126">The following list describes the tasks performed by the persistence subsystem in different stages of the Load operation.</span></span> <span data-ttu-id="a4b98-127">Участники сохраняемости используются на четвертой стадии.</span><span class="sxs-lookup"><span data-stu-id="a4b98-127">The persistence participants are used in the fourth stage.</span></span> <span data-ttu-id="a4b98-128">Участники сохраняемости ввода-вывода (сохраняемые участники, которые также участвуют в операциях ввода-вывода) также используются на третьем этапе.</span><span class="sxs-lookup"><span data-stu-id="a4b98-128">The persistence I/O participants (persistence participants that also participate in I/O operations) are also used in the third stage.</span></span>  
  
1. <span data-ttu-id="a4b98-129">Собирает всех участников сохраняемости, которые были добавлены в коллекцию модулей, связанных с экземпляром рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="a4b98-129">Gathers all persistence participants that were added to the extension collection associated with the workflow instance.</span></span>  
  
2. <span data-ttu-id="a4b98-130">Загружает рабочий процесс из хранилища сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-130">Loads the workflow from the persistence store.</span></span>  
  
3. <span data-ttu-id="a4b98-131">Вызывает для <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> всех участников ввода-вывода сохраняемости и ожидает завершения всех участников сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-131">Invokes the <xref:System.Activities.Persistence.PersistenceIOParticipant.BeginOnLoad%2A> on all persistence I/O participants and waits for all the persistence participants to complete.</span></span> <span data-ttu-id="a4b98-132">Если эпизод сохраняемости транзакционный, транзакция предоставляется в свойстве Transaction.Current.</span><span class="sxs-lookup"><span data-stu-id="a4b98-132">If the persistence episode is transactional, the transaction is provided in Transaction.Current.</span></span>  
  
4. <span data-ttu-id="a4b98-133">Загружает экземпляр рабочего процесса в память на основе данных, извлеченных из хранилища сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-133">Loads the workflow instance in memory based on the data retrieved from the persistence store.</span></span>  
  
5. <span data-ttu-id="a4b98-134">Вызывает <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> на каждом участнике сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="a4b98-134">Invokes <xref:System.Activities.Persistence.PersistenceParticipant.PublishValues%2A> on each persistence participant.</span></span>  
  
 <span data-ttu-id="a4b98-135">Участник сохраняемости является производным от класса **PersistenceParticipant** и может реализовать метод **PublishValues** .</span><span class="sxs-lookup"><span data-stu-id="a4b98-135">A persistence participant derives from the **PersistenceParticipant** class and may implement the **PublishValues** method.</span></span> <span data-ttu-id="a4b98-136">Участник сохраняемого ввода-вывода является производным от класса **PersistenceIOParticipant** и может реализовать метод **бегинонлоад** в дополнение к реализации метода **PublishValues** .</span><span class="sxs-lookup"><span data-stu-id="a4b98-136">A persistence I/O participant derives from the **PersistenceIOParticipant** class and may implement the **BeginOnLoad** method in addition to implementing the **PublishValues** method.</span></span>  
  
 <span data-ttu-id="a4b98-137">При загрузке экземпляра рабочего процесса поставщик сохраняемости создает блокировку для этого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="a4b98-137">When loading a workflow instance the persistence provider creates a lock on that instance.</span></span> <span data-ttu-id="a4b98-138">Это не дает загружать экземпляр более чем одному узлу в конфигурации с несколькими узлами.</span><span class="sxs-lookup"><span data-stu-id="a4b98-138">This prevents the instance from being loaded by more than one host in a multi-node scenario.</span></span> <span data-ttu-id="a4b98-139">При попытке загрузить экземпляр рабочего процесса, который был заблокирован, появляется исключение наподобие следующего: Исключение: «System.ServiceModel.Persistence.InstanceLockException. Не удалось выполнить запрошенную операцию, поскольку не удалось получить блокировку для экземпляра 00000000-0000-0000-0000-000000000000».</span><span class="sxs-lookup"><span data-stu-id="a4b98-139">If you attempt to load a workflow instance that has been locked you will see an exception like the following: The exception " System.ServiceModel.Persistence.InstanceLockException: The requested operation could not complete because the lock for instance '00000000-0000-0000-0000-000000000000' could not be acquired".</span></span> <span data-ttu-id="a4b98-140">Эта ошибка возникает в одной из следующих ситуаций.</span><span class="sxs-lookup"><span data-stu-id="a4b98-140">This error is caused when one of the following occurs:</span></span>  
  
- <span data-ttu-id="a4b98-141">В конфигурации с несколькими узлами экземпляр загружен другим узлом.</span><span class="sxs-lookup"><span data-stu-id="a4b98-141">In a multi-node scenario the instance is loaded by another host.</span></span>  <span data-ttu-id="a4b98-142">Существует несколько способов решить конфликты этих типов: переадресовать обработку в узел (владелец блокировки) и повторить попытку либо выполнить принудительную загрузку, из-за которой другому узлу не удастся сохранить свою работу.</span><span class="sxs-lookup"><span data-stu-id="a4b98-142">There are a few different ways to resolve these types of conflicts: forward the processing to the node which owns the lock and retry, or force the load which will cause the other host to be unable to save their work.</span></span>  
  
- <span data-ttu-id="a4b98-143">В сценарии с одним узлом, если произошел сбой узла.</span><span class="sxs-lookup"><span data-stu-id="a4b98-143">In a single-node scenario and the host crashed.</span></span>  <span data-ttu-id="a4b98-144">При повторном запуске (в результате перезапуска процесса или создания новой фабрики поставщика сохраняемости) узел пытается загрузить экземпляр, все еще заблокированный старым узлом, поскольку срок блокировки еще не истек.</span><span class="sxs-lookup"><span data-stu-id="a4b98-144">When the host starts up again (a process recycle or creating a new persistence provider factory) the new host attempts to load an instance which is still locked by the old host because the lock hasn't expired yet.</span></span>  
  
- <span data-ttu-id="a4b98-145">В сценарии с одним узлом работа рассматриваемого экземпляра была в какой-то момент прервана и был создан новый экземпляр поставщика сохраняемости с другим идентификатором узла.</span><span class="sxs-lookup"><span data-stu-id="a4b98-145">In a single-node scenario and the instance in question was aborted at some point and a new persistence provider instance is created which has a different host ID.</span></span>  
  
 <span data-ttu-id="a4b98-146">Значение времени ожидания блокировки по умолчанию равно 5 минутам, можно указать другое значение времени ожидания при вызове метода <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span><span class="sxs-lookup"><span data-stu-id="a4b98-146">The lock timeout value has a default value of 5 minutes, you can specify a different timeout value when calling <xref:System.ServiceModel.Persistence.PersistenceProvider.Load%2A>.</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="a4b98-147">в этом разделе</span><span class="sxs-lookup"><span data-stu-id="a4b98-147">In This Section</span></span>  
  
- [<span data-ttu-id="a4b98-148">Практическое руководство. Создание настраиваемого участника сохраняемости</span><span class="sxs-lookup"><span data-stu-id="a4b98-148">How to: Create a Custom Persistence Participant</span></span>](how-to-create-a-custom-persistence-participant.md)  
  
## <a name="see-also"></a><span data-ttu-id="a4b98-149">См. также</span><span class="sxs-lookup"><span data-stu-id="a4b98-149">See also</span></span>

- [<span data-ttu-id="a4b98-150">Расширяемость хранилища</span><span class="sxs-lookup"><span data-stu-id="a4b98-150">Store Extensibility</span></span>](store-extensibility.md)
