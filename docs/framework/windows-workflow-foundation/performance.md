---
title: Производительность Windows Workflow Foundation 4
ms.date: 03/30/2017
ms.assetid: 67d2b3e8-3777-49f8-9084-abbb33b5a766
ms.openlocfilehash: c656d1e23c7314cfd7b772faef842296d03e4af1
ms.sourcegitcommit: 005980b14629dfc193ff6cdc040800bc75e0a5a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/14/2019
ms.locfileid: "70989584"
---
# <a name="windows-workflow-foundation-4-performance"></a><span data-ttu-id="9e2d6-102">Производительность Windows Workflow Foundation 4</span><span class="sxs-lookup"><span data-stu-id="9e2d6-102">Windows Workflow Foundation 4 Performance</span></span>

 <span data-ttu-id="9e2d6-103">Корпорация [!INCLUDE[netfx40_long](../../../includes/netfx40-long-md.md)] Майкрософт включает в себя основную редакцию Windows Workflow Foundation (WF) с большой нагрузкой на производительность.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-103">Microsoft [!INCLUDE[netfx40_long](../../../includes/netfx40-long-md.md)] includes a major revision of the Windows Workflow Foundation (WF) with heavy investments in performance.</span></span>  <span data-ttu-id="9e2d6-104">В этой версии имеются значительные изменения по сравнению с предыдущими версиями [!INCLUDE[wf1](../../../includes/wf1-md.md)], поставляемыми в составе платформы .NET Framework 3.0 и [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)].</span><span class="sxs-lookup"><span data-stu-id="9e2d6-104">This new revision introduces significant design changes from the previous versions of [!INCLUDE[wf1](../../../includes/wf1-md.md)] that shipped as part of .NET Framework 3.0 and [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)].</span></span> <span data-ttu-id="9e2d6-105">Переработка множества аспектов от ядра модели программирования и среды выполнения до инструментария позволила значительно повысить производительность и удобство использования.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-105">It has been re-architected from the core of the programming model, runtime, and tooling to greatly improve performance and usability.</span></span> <span data-ttu-id="9e2d6-106">В этом разделе описаны важные характеристики производительности этих версий по сравнению с аналогичными характеристиками предыдущей версии.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-106">This topic shows the important performance characteristics of these revisions and compares them against those of the previous version.</span></span>

 <span data-ttu-id="9e2d6-107">Производительность компонентов отдельных рабочих процессов повысилась за счет разницы в скорости выполнения операций умножения между WF3 и WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-107">Individual workflow component performance has increased by orders of magnitude between WF3 and WF4.</span></span>  <span data-ttu-id="9e2d6-108">Это оставляет зазор между службами, закодированными вручную Windows Communication Foundation (WCF), и службами рабочих процессов WCF, которые могут быть довольно маленькими.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-108">This leaves the gap between hand-coded Windows Communication Foundation (WCF) services and WCF workflow services to be quite small.</span></span>  <span data-ttu-id="9e2d6-109">Время ожидания рабочего процесса в WF4 значительно сократилось.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-109">Workflow latency has been significantly reduced in WF4.</span></span>  <span data-ttu-id="9e2d6-110">Производительность сохранения данных повысилась в 2,5–3,0 раза.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-110">Persistence performance has increased by a factor of 2.5 - 3.0.</span></span>  <span data-ttu-id="9e2d6-111">Заметно снизились издержки при наблюдении за работоспособностью при отслеживании рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-111">Health monitoring by means of workflow tracking has significantly less overhead.</span></span>  <span data-ttu-id="9e2d6-112">Все это делает применение WF4 в приложениях или переход на эту платформу очень привлекательным.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-112">These are compelling reasons to migrate to or adopt WF4 in your applications.</span></span>

## <a name="terminology"></a><span data-ttu-id="9e2d6-113">Терминология</span><span class="sxs-lookup"><span data-stu-id="9e2d6-113">Terminology</span></span>
 <span data-ttu-id="9e2d6-114">Версия [!INCLUDE[wf1](../../../includes/wf1-md.md)], появившаяся в [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)], далее в этом разделе именуется WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-114">The version of [!INCLUDE[wf1](../../../includes/wf1-md.md)] introduced in [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] will be referred to as WF4 for the rest of this topic.</span></span>  [!INCLUDE[wf1](../../../includes/wf1-md.md)]<span data-ttu-id="9e2d6-115">был представлен в .NET 3,0 и содержал несколько небольших редакций [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)] с пакетом обновления 1 (SP1).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-115">was introduced in .NET 3.0 and had a few minor revisions through [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)] SP1.</span></span> <span data-ttu-id="9e2d6-116">Версия [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)] платформы Workflow Foundation далее по тексту именуется WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-116">The [!INCLUDE[netfx35_short](../../../includes/netfx35-short-md.md)] version of Workflow Foundation will be referred to as WF3 for the rest of this topic.</span></span> <span data-ttu-id="9e2d6-117">WF3 поставляется в составе [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] параллельно с WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-117">WF3 is shipped in [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] side-by-side with WF4.</span></span> <span data-ttu-id="9e2d6-118">Дополнительные сведения о миграции артефактов WF3 в WF4 см. в следующих статьях: [Windows Workflow Foundation 4. руководством по миграции](https://go.microsoft.com/fwlink/?LinkID=153313)</span><span class="sxs-lookup"><span data-stu-id="9e2d6-118">For more information about migrating WF3 artifacts to WF4 see: [Windows Workflow Foundation 4 Migration Guide](https://go.microsoft.com/fwlink/?LinkID=153313)</span></span>

 <span data-ttu-id="9e2d6-119">Windows Communication Foundation (WCF) — это унифицированная модель программирования Майкрософт для создания приложений, ориентированных на службы.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-119">Windows Communication Foundation (WCF) is Microsoft’s unified programming model for building service-oriented applications.</span></span> <span data-ttu-id="9e2d6-120">Он впервые появился в составе .NET 3,0 вместе с WF3, и теперь является одним из ключевых компонентов .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-120">It was first introduced as part of .NET 3.0 together with WF3 and now is one of the key components of the .NET Framework.</span></span>

 <span data-ttu-id="9e2d6-121">Windows Server AppFabric - это набор интегрированных технологий, которые упрощают построение, масштабирование и управление составными и веб-приложениями, работающими под управлением IIS.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-121">Windows Server AppFabric is a set of integrated technologies that make it easier to build, scale and manage Web and composite applications that run on IIS.</span></span> <span data-ttu-id="9e2d6-122">В состав этого продукта входят средства для наблюдения за службами и рабочими процессами и управления ими.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-122">It provides tools for monitoring and managing services and workflows.</span></span> <span data-ttu-id="9e2d6-123">Дополнительные сведения см. в статье [Windows Server AppFabric 1,0](https://docs.microsoft.com/previous-versions/appfabric/ff384253(v=azure.10)).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-123">For more information, see [Windows Server AppFabric 1.0](https://docs.microsoft.com/previous-versions/appfabric/ff384253(v=azure.10)).</span></span>

## <a name="goals"></a><span data-ttu-id="9e2d6-124">Цели</span><span class="sxs-lookup"><span data-stu-id="9e2d6-124">Goals</span></span>
 <span data-ttu-id="9e2d6-125">Цель этого раздела - показать характеристики производительности WF4 с данными для различных сценариев.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-125">The goal of this topic is to show the performance characteristics of WF4 with data measured for different scenarios.</span></span> <span data-ttu-id="9e2d6-126">Здесь также предоставлено подробное сравнение WF4 с WF3, которое отражает улучшения, появившиеся в новой версии.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-126">It also provides detailed comparisons between WF4 and WF3, and thus shows the great improvements that have been made in this new revision.</span></span> <span data-ttu-id="9e2d6-127">Сценарии и данные, представленные в этой статье, определяют базовые затраты различных аспектов WF4 и WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-127">The scenarios and data presented in this article quantify the underlying cost of different aspects of WF4 and WF3.</span></span> <span data-ttu-id="9e2d6-128">Эти данные помогут разобраться с характеристиками производительности WF4 и могут оказаться полезными при планировании перехода с WF3 на WF4 или использовании WF4 при разработке новых приложений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-128">This data is useful in understanding the performance characteristics of WF4 and can be helpful in planning migrations from WF3 to WF4 or using WF4 in application development.</span></span> <span data-ttu-id="9e2d6-129">Однако выводы на основе сведений, представленных в этой статье, следует делать с осторожностью.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-129">However, care should be taken in the conclusions drawn from the data presented in this article.</span></span> <span data-ttu-id="9e2d6-130">Производительность приложения составного рабочего процесса в большой степени зависит от его реализации и способа интеграции различных компонентов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-130">The performance of a composite workflow application is highly dependent on how the workflow is implemented and how different components are integrated.</span></span> <span data-ttu-id="9e2d6-131">Для определения параметров производительности каждого приложения необходимо проведение измерений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-131">One must measure each application to determine the performance characteristics of that application.</span></span>

## <a name="overview-of-wf4-performance-enhancements"></a><span data-ttu-id="9e2d6-132">Общие сведения о повышении производительности WF4</span><span class="sxs-lookup"><span data-stu-id="9e2d6-132">Overview of WF4 Performance Enhancements</span></span>
 <span data-ttu-id="9e2d6-133">При проектировании и разработке WF4 были реализованы меры для повышения производительности и масштабируемости, которые описаны в следующих разделах.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-133">WF4 was carefully designed and implemented with high performance and scalability which are described in the following sections.</span></span>

### <a name="wf-runtime"></a><span data-ttu-id="9e2d6-134">Среда выполнения WF</span><span class="sxs-lookup"><span data-stu-id="9e2d6-134">WF Runtime</span></span>
 <span data-ttu-id="9e2d6-135">В основе среды выполнения [!INCLUDE[wf1](../../../includes/wf1-md.md)] лежит асинхронный планировщик, который управляет выполнением действий рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-135">At the core of the [!INCLUDE[wf1](../../../includes/wf1-md.md)] runtime is an asynchronous scheduler that drives the execution of the activities in a workflow.</span></span> <span data-ttu-id="9e2d6-136">Он обеспечивает эффективную, предсказуемую среду выполнения для действия.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-136">It provides a performant, predictable execution environment for activities.</span></span> <span data-ttu-id="9e2d6-137">Среда содержит строго определенный контракт для запуска, продолжения, завершения, отмены, обработки исключений и прогнозируемую потоковую модель.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-137">The environment has a well-defined contract for execution, continuation, completion, cancellation, exceptions, and a predictable threading model.</span></span>

 <span data-ttu-id="9e2d6-138">Планировщик среды выполнения WF4 более эффективен по сравнению с WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-138">In comparison to WF3, the WF4 runtime has a more efficient scheduler.</span></span> <span data-ttu-id="9e2d6-139">Он использует тот же пул потоков ввода-вывода, который используется для WCF, что очень эффективно для выполнения пакетных рабочих элементов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-139">It leverages the same I/O thread pool that is used for WCF, which is very efficient at executing batched work items.</span></span> <span data-ttu-id="9e2d6-140">Внутренняя очередь рабочих элементов оптимизирована для самых распространенных шаблонов использования.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-140">The internal work item scheduler queue is optimized for most common usage patterns.</span></span> <span data-ttu-id="9e2d6-141">Среда выполнения WF4 также управляет состояниями выполнения очень простым способом с минимальной логикой синхронизации и обработки событий, тогда как WF3 зависит от длительной регистрации событий и вызова для выполнения сложной синхронизации переходов между состояниями.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-141">The WF4 runtime also manages the execution states in a very lightweight way with minimal synchronization and event handling logic, while WF3 depends on heavy-weight event registration and invocation to perform complex synchronization for state transitions.</span></span>

### <a name="data-storage-and-flow"></a><span data-ttu-id="9e2d6-142">Хранение и поток данных</span><span class="sxs-lookup"><span data-stu-id="9e2d6-142">Data Storage and Flow</span></span>
 <span data-ttu-id="9e2d6-143">В WF3 данные, связанные с действием, моделируется через свойства зависимостей, которые реализуются типом <xref:System.Windows.DependencyProperty>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-143">In WF3, data associated with an activity is modeled through dependency properties implemented by the type <xref:System.Windows.DependencyProperty>.</span></span> <span data-ttu-id="9e2d6-144">Шаблон свойства зависимостей был введен в Windows Presentation Foundation (WPF).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-144">The dependency property pattern was introduced in Windows Presentation Foundation (WPF).</span></span> <span data-ttu-id="9e2d6-145">В целом этот шаблон стал более гибким и обеспечивает простоту привязки данных и другие возможности пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-145">In general, this pattern is very flexible to support easy data binding and other UI features.</span></span> <span data-ttu-id="9e2d6-146">Однако при этом требуется объявление свойств как статических полей в определении рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-146">However, the pattern requires the properties to be defined as static fields in the workflow definition.</span></span> <span data-ttu-id="9e2d6-147">Когда среда выполнения [!INCLUDE[wf1](../../../includes/wf1-md.md)] устанавливает или возвращает значения свойств, задействуется громоздкая логика поиска.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-147">Whenever the [!INCLUDE[wf1](../../../includes/wf1-md.md)] runtime sets or gets the property values, it involves heavily-weighted look-up logic.</span></span>

 <span data-ttu-id="9e2d6-148">В WF4 используются прозрачные правила видимости, которые значительно повышают эффективность обработки данных в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-148">WF4 uses clear data scoping logic to greatly improve how data is handled in a workflow.</span></span> <span data-ttu-id="9e2d6-149">При этом данные, хранимые внутри действия, отделяются от данных, проходящих через границы действия, за счет разделения двух понятий: переменные и аргументы.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-149">It separates the data stored in an activity from the data that is flowing across the activity boundaries by using two different concepts: variables and arguments.</span></span> <span data-ttu-id="9e2d6-150">Используя четкую иерархическую область для переменных и аргументов «in/out/InOut», сложность использования данных для действий значительно сокращается, и время существования данных также автоматически ограничивается областью действия.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-150">By using a clear hierarchical scope for variables and "In/Out/InOut" arguments, the data usage complexity for activities is dramatically reduced and the lifetime of the data is also automatically scoped.</span></span> <span data-ttu-id="9e2d6-151">В аргументах действий имеются строгие определения сигнатур.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-151">Activities have a well-defined signature described by its arguments.</span></span> <span data-ttu-id="9e2d6-152">Простой проверкой действия можно определить, какие данные оно ожидает получить и какие данные будут получены в результате выполнения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-152">By simply inspecting an activity you can determine what data it expects to receive and what data will be produced by it as the result of its execution.</span></span>

 <span data-ttu-id="9e2d6-153">В WF3 инициализация действий происходила в момент создания рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-153">In WF3 activities were initialized when a workflow was created.</span></span> <span data-ttu-id="9e2d6-154">В WF 4 действия инициализируются только при выполнении соответствующих действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-154">In WF 4 activities are initialized only when the corresponding activities are executing.</span></span> <span data-ttu-id="9e2d6-155">Это позволяет упростить жизненный цикл действия, не выполняя операции Initialize и Uninitialize при создании нового экземпляра рабочего процесса, что также повышает производительность.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-155">This allows a simpler activity lifecycle without performing Initialize/Uninitialize operations when a new workflow instance is created, and thus has achieved more efficiency</span></span>

### <a name="control-flow"></a><span data-ttu-id="9e2d6-156">Поток управления</span><span class="sxs-lookup"><span data-stu-id="9e2d6-156">Control Flow</span></span>
 <span data-ttu-id="9e2d6-157">Как и любой другой язык программирования, [!INCLUDE[wf1](../../../includes/wf1-md.md)] обеспечивает поддержку потока управления выполнением для определений рабочих процессов. Для этого предусмотрен целый набор действий управления выполнением для последовательностей, циклов, ветвления и других операций.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-157">Just as in any programming language, [!INCLUDE[wf1](../../../includes/wf1-md.md)] provides support for control flows for workflow definitions by introducing a set of control flow activities for sequencing, looping, branching and other patterns.</span></span> <span data-ttu-id="9e2d6-158">В WF3, когда возникала необходимость в повторном выполнении некоторого действия, создавался новый контекст выполнения <xref:System.Workflow.ComponentModel.ActivityExecutionContext>, затем действие клонировалось через громоздкую логику сериализации и десериализации на основе объекта <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-158">In WF3, when the same activity needs to be re-executed, a new <xref:System.Workflow.ComponentModel.ActivityExecutionContext> is created and the activity is cloned through a heavy-weight serialization and deserialization logic based on <xref:System.Runtime.Serialization.Formatters.Binary.BinaryFormatter>.</span></span> <span data-ttu-id="9e2d6-159">Как правило, производительность циклических потоков управления была ниже, чем при выполнении последовательности действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-159">Usually the performance for iterative control flows is much slower than executing a sequence of activities.</span></span>

 <span data-ttu-id="9e2d6-160">В WF4 это делается несколько иначе.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-160">WF4 handles this quite differently.</span></span> <span data-ttu-id="9e2d6-161">Берется шаблон действия, и создается новый объект ActivityInstance, который затем добавляется в очередь планировщика.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-161">It takes the activity template, creates a new ActivityInstance object, and adds it to the scheduler queue.</span></span> <span data-ttu-id="9e2d6-162">Этот весь процесс включает только явное создание объектов и является очень легковесным.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-162">This whole process only involves explicit object creation and is very lightweight.</span></span>

### <a name="asynchronous-programming"></a><span data-ttu-id="9e2d6-163">Асинхронное программирование</span><span class="sxs-lookup"><span data-stu-id="9e2d6-163">Asynchronous Programming</span></span>
 <span data-ttu-id="9e2d6-164">Как правило, у приложений производительность и масштабируемость выше при асинхронном программировании долго выполняющихся операций, блокирующих работу остального кода, например операций ввода-вывода или распределенных вычислений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-164">Applications usually have better performance and scalability with asynchronous programming for long running blocking operations such as I/O or distributed computing operations.</span></span> <span data-ttu-id="9e2d6-165">В WF4 предусмотрена поддержка асинхронной работы через базовые типы действий <xref:System.Activities.AsyncCodeActivity>, <xref:System.Activities.AsyncCodeActivity%601>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-165">WF4 provides asynchronous support through base activity types <xref:System.Activities.AsyncCodeActivity>, <xref:System.Activities.AsyncCodeActivity%601>.</span></span> <span data-ttu-id="9e2d6-166">Среда выполнения обеспечивает собственную поддержку асинхронных действий и поэтому может автоматически перевести экземпляр в зону несохраняемости до окончания асинхронной обработки.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-166">The runtime natively understands asynchronous activities and therefore can automatically put the instance in a no-persist zone while the asynchronous work is outstanding.</span></span> <span data-ttu-id="9e2d6-167">От этих типов могут наследоваться пользовательские действия, выполняющие асинхронную обработку без удержания потока планировщика рабочего процесса и не блокируя другие действия, которые могут работать параллельно.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-167">Custom activities can derive from these types to perform asynchronous work without holding the workflow scheduler thread and blocking any activities that may be able to run in parallel.</span></span>

### <a name="messaging"></a><span data-ttu-id="9e2d6-168">Обмен сообщениями</span><span class="sxs-lookup"><span data-stu-id="9e2d6-168">Messaging</span></span>
 <span data-ttu-id="9e2d6-169">Первоначально в WF3 была очень ограниченная поддержка передачи сообщений через внешние события или вызов веб-служб.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-169">Initially WF3 had very limited messaging support through external events or web services invocations.</span></span> <span data-ttu-id="9e2d6-170">В .NET 3,5 рабочие процессы могут быть реализованы как клиенты WCF или предоставлены как службы <xref:System.Workflow.Activities.SendActivity> WCF <xref:System.Workflow.Activities.ReceiveActivity>с помощью и.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-170">In .NET 3.5, workflows could be implemented as WCF clients or exposed as WCF services through <xref:System.Workflow.Activities.SendActivity> and <xref:System.Workflow.Activities.ReceiveActivity>.</span></span> <span data-ttu-id="9e2d6-171">В WF4 концепция программирования обмена сообщениями на основе рабочих процессов была еще более усиливаетсяа благодаря тесной интеграции логики обмена сообщениями WCF с WF.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-171">In WF4, the concept of workflow-based messaging programming has been further strengthened through the tight integration of WCF messaging logic into WF.</span></span>

 <span data-ttu-id="9e2d6-172">Единый конвейер обработки сообщений, предоставляемый в WCF в .NET 4, помогает WF4 службам значительно повысить производительность и масштабируемость, чем WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-172">The unified message processing pipeline provided in WCF in .NET 4 helps WF4 services to have significantly better performance and scalability than WF3.</span></span> <span data-ttu-id="9e2d6-173">Кроме того, WF4 обеспечивает более широкую поддержку программирования передачи сообщений за счет использования модели сложных шаблонов обмена сообщениями (MEP).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-173">WF4 also provides richer messaging programming support that can model complex Message Exchange Patterns (MEPs).</span></span> <span data-ttu-id="9e2d6-174">Разработчик может выбрать либо типизированный контракт службы, который обеспечивает простоту программирования, либо нетипизированный, который избавляет от ресурсоемкой сериализации и поэтому дает более высокую производительность.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-174">Developers can use either typed service contracts to achieve easy programming or un-typed service contracts to achieve better performance without paying serialization costs.</span></span> <span data-ttu-id="9e2d6-175">Поддержка кэширования канала на стороне клиента с помощью класса <xref:System.ServiceModel.Activities.SendMessageChannelCache> в WF4 дает возможность разработчикам создавать быстро работающие приложения с минимальными усилиями.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-175">The client-side channel caching support through the <xref:System.ServiceModel.Activities.SendMessageChannelCache> class in WF4 helps developers build fast applications with minimal effort.</span></span> <span data-ttu-id="9e2d6-176">Дополнительные сведения см. [в разделе изменение уровней общего доступа к кэшу для действий отправки](../wcf/feature-details/changing-the-cache-sharing-levels-for-send-activities.md).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-176">For more information, see [Changing the Cache Sharing Levels for Send Activities](../wcf/feature-details/changing-the-cache-sharing-levels-for-send-activities.md).</span></span>

### <a name="declarative-programming"></a><span data-ttu-id="9e2d6-177">Декларативное программирование</span><span class="sxs-lookup"><span data-stu-id="9e2d6-177">Declarative Programming</span></span>
 <span data-ttu-id="9e2d6-178">WF4 обеспечивает платформу для простого и прозрачного декларативного программирования для моделирования бизнес-процессов и служб.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-178">WF4 provides a clean and simple declarative programming framework to model business processes and services.</span></span> <span data-ttu-id="9e2d6-179">Модель программирования поддерживает полностью декларативное создание действий без побочного кода, что в значительной степени упрощает создание рабочих процессов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-179">The programming model supports fully declarative composition of activities, with no code-beside, greatly simplifying workflow authoring.</span></span> <span data-ttu-id="9e2d6-180">В [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)] платформа декларативного программирования на основе XAML унифицирована в рамках единой сборки System.Xaml.dll и поддерживает как WPF, так и WF.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-180">In [!INCLUDE[netfx40_short](../../../includes/netfx40-short-md.md)], the XAML-based declarative programming framework has been unified into the single assembly System.Xaml.dll to support both WPF and WF.</span></span>

 <span data-ttu-id="9e2d6-181">В WF4 на основе XAML выполняется истинная декларативность, которая позволяет полностью выполнить определение рабочего процесса в разметке XML, действия и типы которой отражаются в .NET.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-181">In WF4, XAML provides a truly declarative experience and allows for the entire definition of the workflow to be defined in XML markup, referencing activities and types built using .NET.</span></span> <span data-ttu-id="9e2d6-182">Этого было трудно добиться в WF3, где использовался формат XOML без включения фонового кода пользовательской логики.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-182">This was difficult to do in WF3 with XOML format without involving custom code-behind logic.</span></span> <span data-ttu-id="9e2d6-183">Новый стек XAML в .NET 4 обеспечивает гораздо более высокую производительность при сериализации и десериализации артефактов рабочих процессов, а также делает декларативное программирование более привлекательным и надежным.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-183">The new XAML-stack in .NET 4 has much better performance in serializing/deserializing workflow artifacts and makes declarative programming more attractive and solid.</span></span>

### <a name="workflow-designer"></a><span data-ttu-id="9e2d6-184">Конструктор рабочих процессов</span><span class="sxs-lookup"><span data-stu-id="9e2d6-184">Workflow Designer</span></span>
 <span data-ttu-id="9e2d6-185">Поддержка полностью декларативного программирования для WF4 очевидным образом предъявляет более высокие требования к производительности на стадии конструирования при обработке больших рабочих процессов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-185">Fully declarative programming support for WF4 explicitly imposes higher requirements for design time performance for large workflows.</span></span> <span data-ttu-id="9e2d6-186">Конструктор рабочих процессов в WF4 гораздо лучше масштабируется во время работы с большими рабочими процессами, чем конструктор для WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-186">The Workflow designer in WF4 has much better scalability for large workflows than that for WF3.</span></span> <span data-ttu-id="9e2d6-187">Имея поддержку виртуализации пользовательского интерфейса, конструктор легко, в течение нескольких секунд, загружает большие проекты, содержащие тысячи действий. В WF3 это было практически невозможно.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-187">With UI virtualization support, the designer can easily load a large workflow of 1000 activities in a few seconds, while it is almost impossible to load a workflow of a few hundred activities with the WF3 designer.</span></span>

## <a name="component-level-performance-comparisons"></a><span data-ttu-id="9e2d6-188">Сравнения производительности на уровне компонентов</span><span class="sxs-lookup"><span data-stu-id="9e2d6-188">Component-level Performance Comparisons</span></span>
 <span data-ttu-id="9e2d6-189">В этом разделе содержатся данные по прямому сравнению отдельных действий в рабочих процессах WF3 и WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-189">This section contains data on direct comparisons between individual activities in WF3 and WF4 workflows.</span></span>  <span data-ttu-id="9e2d6-190">Такие важнейшие аспекты, как сохраняемость, значительно более глубоко влияют на производительность, чем отдельные компоненты действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-190">Key areas like persistence have a more profound impact on performance than the individual activity components.</span></span>  <span data-ttu-id="9e2d6-191">Повышение производительности работы отдельных компонентов в WF4 достаточно важно, поскольку теперь скорость их работы сравнима с логикой, закодированной вручную.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-191">The performance improvements in individual components in WF4 are important though because the components are now fast enough to be compared against hand-coded orchestration logic.</span></span>  <span data-ttu-id="9e2d6-192">Пример, который рассматривается в следующем разделе: "Сценарий композиции служб".</span><span class="sxs-lookup"><span data-stu-id="9e2d6-192">An example of which is covered in the next section: "Service Composition Scenario."</span></span>

### <a name="environment-setup"></a><span data-ttu-id="9e2d6-193">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-193">Environment Setup</span></span>
 ![Настройка среды для измерения производительности рабочего процесса](./media/performance/performance-test-environment.gif)

 <span data-ttu-id="9e2d6-195">На приведенном выше рисунке показана конфигурация компьютера для измерения производительности на уровне компонентов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-195">The above figure shows the machine configuration used for component-level performance measurement.</span></span> <span data-ttu-id="9e2d6-196">Одиночный сервер и пять клиентов соединены через один сетевой интерфейс Ethernet 1 Гбит/с.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-196">A single server and five clients connected over one 1-Gbps Ethernet network interface.</span></span> <span data-ttu-id="9e2d6-197">Для простоты измерений на сервере настроено использование одного двухпроцессорного или четырехпроцессорного ядра под управлением Windows Server 2008 x86.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-197">For easy measurements, the server is configured to use a single core of a dual-proc/quad-core server  running Windows Server 2008 x86.</span></span> <span data-ttu-id="9e2d6-198">Загрузка ЦП поддерживалась на уровне, близком к 100%.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-198">The system CPU utilization is maintained at nearly 100%.</span></span>

### <a name="test-details"></a><span data-ttu-id="9e2d6-199">Сведения о тесте</span><span class="sxs-lookup"><span data-stu-id="9e2d6-199">Test Details</span></span>
 <span data-ttu-id="9e2d6-200"><xref:System.Workflow.Activities.CodeActivity> является простейшим из действий, которые могут быть использованы в рабочем процессе WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-200">The WF3 <xref:System.Workflow.Activities.CodeActivity> is likely the simplest activity that can be used in a WF3 workflow.</span></span>  <span data-ttu-id="9e2d6-201">Действие вызывает метод с фоновым кодом, в котором разработчик размещает свой код.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-201">The activity calls a method in the code-behind that the workflow programmer can put custom code into.</span></span>  <span data-ttu-id="9e2d6-202">В WF4 нет прямого аналога действия <xref:System.Workflow.Activities.CodeActivity>, обеспечивающего такие же возможности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-202">In WF4, there is no direct analog to the WF3 <xref:System.Workflow.Activities.CodeActivity> that provides the same functionality.</span></span>  <span data-ttu-id="9e2d6-203">Обратите внимание, что в WF4 имеется базовый класс <xref:System.Activities.CodeActivity>, который никак не связан с классом <xref:System.Workflow.Activities.CodeActivity> в WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-203">Note that there is a <xref:System.Activities.CodeActivity> base class in WF4 that is not related to the WF3 <xref:System.Workflow.Activities.CodeActivity>.</span></span>  <span data-ttu-id="9e2d6-204">Создателям рабочих процессов рекомендуется создавать пользовательские действия и разрабатывать рабочие процессы только на XAML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-204">Workflow authors are encouraged to create custom activities and build XAML-only workflows.</span></span>  <span data-ttu-id="9e2d6-205">В приведенных ниже тестах действие `Comment` используется вместо пустого <xref:System.Workflow.Activities.CodeActivity> в рабочих процессах WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-205">In the tests below, an activity called `Comment` is used in place of an empty <xref:System.Workflow.Activities.CodeActivity> in WF4 workflows.</span></span>  <span data-ttu-id="9e2d6-206">Действие `Comment` содержит следующий код:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-206">The code in the `Comment` activity is as follows:</span></span>

```csharp
[ContentProperty("Body")]
    public sealed class Comment : CodeActivity
    {
        public Comment()
            : base()
        {
        }

        [DefaultValue(null)]
        public Activity Body
        {
            get;
            set;
        }

        protected override void Execute(CodeActivityContext context)
        {
        }
    }
```

### <a name="empty-workflow"></a><span data-ttu-id="9e2d6-207">Пустой рабочий процесс</span><span class="sxs-lookup"><span data-stu-id="9e2d6-207">Empty Workflow</span></span>
 <span data-ttu-id="9e2d6-208">В этом тесте используется последовательный рабочий процесс без вложенных действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-208">This test uses a sequence workflow with no child activities.</span></span>

### <a name="single-activity"></a><span data-ttu-id="9e2d6-209">Одно действие</span><span class="sxs-lookup"><span data-stu-id="9e2d6-209">Single Activity</span></span>
 <span data-ttu-id="9e2d6-210">Последовательный рабочий процесс, содержащий одно вложенное действие.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-210">The workflow is a sequence workflow containing one child activity.</span></span>  <span data-ttu-id="9e2d6-211">В случае WF3 это действие <xref:System.Workflow.Activities.CodeActivity>, не содержащее кода, либо действие `Comment` в случае WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-211">The activity is a <xref:System.Workflow.Activities.CodeActivity> with no code in the WF3 case and a `Comment` activity in the WF4 case.</span></span>

### <a name="while-with-1000-iterations"></a><span data-ttu-id="9e2d6-212">Цикл while на 1000 итераций</span><span class="sxs-lookup"><span data-stu-id="9e2d6-212">While with 1000 Iterations</span></span>
 <span data-ttu-id="9e2d6-213">Последовательный рабочий процесс содержит одно действие <xref:System.Activities.Statements.While> с одним вложенным действием в цикле, в котором ничего не делается.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-213">The sequence workflow contains one <xref:System.Activities.Statements.While> activity with one child activity in the loop that does not perform any work.</span></span>

### <a name="replicator-compared-to-parallelforeach"></a><span data-ttu-id="9e2d6-214">Сравнение действий Replicator и ParallelForEach</span><span class="sxs-lookup"><span data-stu-id="9e2d6-214">Replicator compared to ParallelForEach</span></span>
 <span data-ttu-id="9e2d6-215">Действие <xref:System.Workflow.Activities.ReplicatorActivity> в WF3 имеет последовательный и параллельный режимы выполнения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-215"><xref:System.Workflow.Activities.ReplicatorActivity> in WF3 has sequential and parallel execution modes.</span></span>  <span data-ttu-id="9e2d6-216">В последовательном режиме производительность действия аналогична производительности <xref:System.Workflow.Activities.WhileActivity>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-216">In sequential mode, the activity’s performance is similar to the <xref:System.Workflow.Activities.WhileActivity>.</span></span>  <span data-ttu-id="9e2d6-217">Действие <xref:System.Workflow.Activities.ReplicatorActivity> лучше всего подходит для параллельного выполнения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-217">The <xref:System.Workflow.Activities.ReplicatorActivity> is most useful for parallel execution.</span></span>  <span data-ttu-id="9e2d6-218">Аналогом этого действия в WF4 является <xref:System.Activities.Statements.ParallelForEach%601>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-218">The WF4 analog for this is the <xref:System.Activities.Statements.ParallelForEach%601> activity.</span></span>

 <span data-ttu-id="9e2d6-219">На следующей схеме показаны рабочие процессы, используемые в данном тесте.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-219">The following diagram shows the workflows used for this test.</span></span> <span data-ttu-id="9e2d6-220">Рабочий процесс WF3 слева, а рабочий процесс WF4 справа.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-220">The WF3 workflow is on the left and the WF4 workflow is on the right.</span></span>

 ![ReplicatorActivity (WF3) и ParallelForEach (WF4)](./media/performance/replicator-parallel-wf3-wf4.gif)

### <a name="sequential-workflow-with-five-activities"></a><span data-ttu-id="9e2d6-222">Последовательный рабочий процесс с пятью действиями</span><span class="sxs-lookup"><span data-stu-id="9e2d6-222">Sequential Workflow with Five Activities</span></span>
 <span data-ttu-id="9e2d6-223">Этот тест показывает эффект последовательного выполнения нескольких действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-223">This test is meant to show the effect of having several activities execute in sequence.</span></span>  <span data-ttu-id="9e2d6-224">В последовательности пять действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-224">There are five activities in the sequence.</span></span>

### <a name="transaction-scope"></a><span data-ttu-id="9e2d6-225">Область транзакции</span><span class="sxs-lookup"><span data-stu-id="9e2d6-225">Transaction Scope</span></span>
 <span data-ttu-id="9e2d6-226">Тест области транзакции немного отличается от других тестов в том плане, что новый экземпляр рабочего процесса не создается в каждой итерации.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-226">The transaction scope test differs from the other tests slightly in that a new workflow instance is not created for every iteration.</span></span>  <span data-ttu-id="9e2d6-227">Вместо этого рабочий процесс структурирован в виде цикла, в котором содержится <xref:System.Activities.Statements.TransactionScope>, содержащий одно действие, которое не работает.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-227">Instead, the workflow is structured with a while loop containing a <xref:System.Activities.Statements.TransactionScope> activity containing a single activity that does no work.</span></span>  <span data-ttu-id="9e2d6-228">Каждый запуск пакета из 50 итераций в цикле while продолжается как одна операция.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-228">Each run of a batch of 50 iterations through the while loop is counted as a single operation.</span></span>

### <a name="compensation"></a><span data-ttu-id="9e2d6-229">Компенсация</span><span class="sxs-lookup"><span data-stu-id="9e2d6-229">Compensation</span></span>
 <span data-ttu-id="9e2d6-230">Рабочий процесс WF3 содержит единственное компенсируемое действие `WorkScope`.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-230">The WF3 workflow has a single compensatable activity named `WorkScope`.</span></span>  <span data-ttu-id="9e2d6-231">Это действие просто реализует интерфейс <xref:System.Workflow.ComponentModel.ICompensatableActivity>:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-231">The activity simply implements the <xref:System.Workflow.ComponentModel.ICompensatableActivity> interface:</span></span>

```csharp
class WorkScope :
        CompositeActivity, ICompensatableActivity
    {
        public WorkScope() : base() { }

        public WorkScope(string name)
        {
            this.Name = name;
        }

        public ActivityExecutionStatus Compensate(
            ActivityExecutionContext executionContext)
        {
            return ActivityExecutionStatus.Closed;
        }
    }
```

 <span data-ttu-id="9e2d6-232">Обработчик ошибок предназначен для `WorkScope` действия.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-232">The fault handler targets the `WorkScope` activity.</span></span> <span data-ttu-id="9e2d6-233">Рабочий процесс WF4 не менее прост.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-233">The WF4 workflow is equally simplistic.</span></span>  <span data-ttu-id="9e2d6-234"><xref:System.Activities.Statements.CompensableActivity> имеет основной код и обработчик компенсации.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-234">A <xref:System.Activities.Statements.CompensableActivity> has a body and a compensation handler.</span></span>  <span data-ttu-id="9e2d6-235">Далее в последовательности выполняется явная компенсация.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-235">An explicit compensate is next in the sequence.</span></span>  <span data-ttu-id="9e2d6-236">Действие текста и действие обработчика компенсации - пустые реализации:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-236">The body activity and compensation handler activity are both empty implementations:</span></span>

```csharp
public sealed class CompensableActivityEmptyCompensation : CodeActivity
    {
        public CompensableActivityEmptyCompensation()
            : base() { }

        public Activity Body { get; set; }

        protected override void Execute(CodeActivityContext context) { }
    }
    public sealed class CompensableActivityEmptyBody : CodeActivity
    {
        public CompensableActivityEmptyBody()
            : base() { }

        public Activity Body { get; set; }

        protected override void Execute(CodeActivityContext context) { }
    }
```

<span data-ttu-id="9e2d6-237">На следующей диаграмме показан базовый рабочий процесс компенсации.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-237">The following diagram shows the basic compensation workflow.</span></span> <span data-ttu-id="9e2d6-238">Рабочий процесс WF3 слева, а рабочий процесс WF4 справа.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-238">The WF3 workflow is on the left and the WF4 workflow is on the right.</span></span>

![Рабочие процессы WF3 и WF4 Basic компенсация](./media/performance/basic-compensation-workflows-wf3-wf4.gif)

### <a name="performance-test-results"></a><span data-ttu-id="9e2d6-240">Результаты теста производительности</span><span class="sxs-lookup"><span data-stu-id="9e2d6-240">Performance Test Results</span></span>

 ![Таблица, показывающая данные о результатах теста производительности](./media/performance/performance-test-data.gif)

 ![Гистограмма, сравнивающая WF3 и WF4 данные тестирования производительности](./media/performance/performance-test-chart.gif)

 <span data-ttu-id="9e2d6-243">Все тесты измеряются в рабочих процессах в секунду, за исключением теста области транзакции.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-243">All tests are measured in workflows per second with the exception of the transaction scope test.</span></span>  <span data-ttu-id="9e2d6-244">Исходя из вышесказанного, производительность среды выполнения [!INCLUDE[wf1](../../../includes/wf1-md.md)] улучшилась в равной мере в разных областях, особенно в тех, где требуется многократное выполнение одного и того же действия (например, в цикле).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-244">As can be seen above, the [!INCLUDE[wf1](../../../includes/wf1-md.md)] runtime performance has improved across the board, especially in areas that require multiple executions of the same activity like the while loop.</span></span>

## <a name="service-composition-scenario"></a><span data-ttu-id="9e2d6-245">Сценарий композиции служб</span><span class="sxs-lookup"><span data-stu-id="9e2d6-245">Service Composition Scenario</span></span>
 <span data-ttu-id="9e2d6-246">Как показано в предыдущем разделе "Сравнение производительности на уровне компонентов", произошло значительное снижение издержек между WF3 и WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-246">As is shown in the previous section, "Component-level Performance Comparisons," there has been a significant reduction in overhead between WF3 and WF4.</span></span>  <span data-ttu-id="9e2d6-247">Службы рабочих процессов WCF теперь могут почти соответствовать производительности служб WCF, написанных вручную, но все еще обладают всеми преимуществами [!INCLUDE[wf1](../../../includes/wf1-md.md)] среды выполнения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-247">WCF workflow services can now almost match the performance of hand-coded WCF services but still have all the benefits of the [!INCLUDE[wf1](../../../includes/wf1-md.md)] runtime.</span></span>  <span data-ttu-id="9e2d6-248">Этот сценарий тестирования сравнивает службу WCF со службой рабочего процесса WCF в WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-248">This test scenario compares a WCF service against a WCF workflow service in WF4.</span></span>

### <a name="online-store-service"></a><span data-ttu-id="9e2d6-249">Служба интернет-магазина</span><span class="sxs-lookup"><span data-stu-id="9e2d6-249">Online Store Service</span></span>
 <span data-ttu-id="9e2d6-250">Одной из достоинств Windows Workflow Foundation является возможность создания процессов с помощью нескольких служб.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-250">One of the strengths of Windows Workflow Foundation is the ability to compose processes using several services.</span></span>  <span data-ttu-id="9e2d6-251">Например, имеется служба интернет-магазина, которая координирует два вызова служб при размещении заказа.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-251">For this example, there is an online store service that orchestrates two service calls to purchase an order.</span></span>  <span data-ttu-id="9e2d6-252">На первом этапе производится проверка заказа с помощью службы проверки заказа.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-252">The first step is to validate the order using an Order Validating Service.</span></span>  <span data-ttu-id="9e2d6-253">На втором этапе производится заполнение заказа с помощью службы склада.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-253">The second step is to fill the order using a Warehouse Service.</span></span>

 <span data-ttu-id="9e2d6-254">Обе серверные службы - проверки заказа и склада - одинаковы в обоих тестах.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-254">The two backend services, Order Validating Service and Warehouse Service, remain the same for both tests.</span></span>  <span data-ttu-id="9e2d6-255">Изменяющийся компонент - служба интернет-магазина, которая выполняет координацию.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-255">The part that changes is the Online Store Service that performs the orchestration.</span></span>  <span data-ttu-id="9e2d6-256">В одном случае служба написана вручную как служба WCF.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-256">In one case, the service is hand-coded as a WCF service.</span></span>  <span data-ttu-id="9e2d6-257">В другом случае служба записывается как служба рабочего процесса WCF в WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-257">For the other case, the service is written as a WCF workflow service in WF4.</span></span> <span data-ttu-id="9e2d6-258">Функции, относящиеся к [!INCLUDE[wf1](../../../includes/wf1-md.md)], например отслеживание сохраняемости, для этого теста будут отключены.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-258">[!INCLUDE[wf1](../../../includes/wf1-md.md)]-specific features like tracking and persistence are turned off for this test.</span></span>

### <a name="environment"></a><span data-ttu-id="9e2d6-259">Среда</span><span class="sxs-lookup"><span data-stu-id="9e2d6-259">Environment</span></span>
![Настройка среды для измерения производительности](./media/performance/performance-test-environment.gif)

 <span data-ttu-id="9e2d6-261">Клиентские запросы поступают к службе интернет-магазина по протоколу HTTP от множества компьютеров.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-261">Client requests are made to the Online Store Service via HTTP from multiple computers.</span></span>  <span data-ttu-id="9e2d6-262">Все три службы размещены на одном компьютере.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-262">A single computer hosts all three services.</span></span>  <span data-ttu-id="9e2d6-263">Транспортный уровень между службой интернет-магазина и серверными службами - TCP или HTTP.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-263">The transport layer between the Online Store Service and the backend services is TCP or HTTP.</span></span>  <span data-ttu-id="9e2d6-264">Измерения операций производятся по числу обработанных вызовов `PurchaseOrder` к службе интернет-магазина.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-264">The measurement of operations/second is based on the number of completed `PurchaseOrder` calls made to the Online Store Service.</span></span>  <span data-ttu-id="9e2d6-265">Пул каналов - новая возможность, появившаяся в WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-265">Channel pooling is a new feature available in WF4.</span></span>  <span data-ttu-id="9e2d6-266">В WCF-части этой тестовой Организации пул каналов не предоставляется, поэтому в службе интерактивного магазина использовалась ручная реализация простого способа объединения в пул.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-266">In the WCF portion of this test channel pooling is not provided out of the box so a hand-coded implementation of a simple pooling technique was used in the Online Store Service.</span></span>

### <a name="performance"></a><span data-ttu-id="9e2d6-267">Производительность</span><span class="sxs-lookup"><span data-stu-id="9e2d6-267">Performance</span></span>
![Гистограмма с производительностью службы Интернет-магазина](./media/performance/online-store-performance-graph.gif)

 <span data-ttu-id="9e2d6-269">Соединение с серверными службами по протоколу TCP без пула каналов приведет к тому, что пропускная способность службы [!INCLUDE[wf1](../../../includes/wf1-md.md)] снизится на 17,2 %.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-269">Connecting to backend TCP services without channel pooling, the [!INCLUDE[wf1](../../../includes/wf1-md.md)] service has a 17.2% impact on throughput.</span></span>  <span data-ttu-id="9e2d6-270">При наличии пула каналов снижение составит около 23,8 %.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-270">With channel pooling, the penalty is about 23.8%.</span></span>  <span data-ttu-id="9e2d6-271">Для HTTP это влияние гораздо меньше: 4,3% без пула и 8,1% с пулом.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-271">For HTTP, the impact is much less: 4.3% without pooling and 8.1% with pooling.</span></span>  <span data-ttu-id="9e2d6-272">Также важно отметить, что наличие пула каналов дает мало преимуществ при использовании HTTP.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-272">It is also important to note that the channel pooling provides very little benefit when using HTTP.</span></span>

 <span data-ttu-id="9e2d6-273">Несмотря на то что в этом тесте среда выполнения WF4 имеет дополнительную нагрузку на службу WCF, она может рассматриваться как наихудший случай.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-273">While there is overhead from the WF4 runtime compared with a hand-coded WCF service in this test, it could be considered a worst-case scenario.</span></span>  <span data-ttu-id="9e2d6-274">Две серверные службы в этом тесте выполняют очень небольшую работу.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-274">The two backend services in this test do very little work.</span></span>  <span data-ttu-id="9e2d6-275">В реальном полнофункциональном сценарии эти службы будут выполнять более ресурсоемкие операции - обращаться к базе данных, что делает нагрузку на транспортный слой менее важной.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-275">In a real end-to-end scenario, these services would perform more expensive operations like database calls, making the performance impact of the transport layer less important.</span></span>  <span data-ttu-id="9e2d6-276">Это и новые функции, которые доступны в WF4, превращает Workflow Foundation в отличный выбор при создании служб координации.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-276">This plus the benefits of the features available in WF4 makes Workflow Foundation a viable choice for creating orchestration services.</span></span>

## <a name="key-performance-considerations"></a><span data-ttu-id="9e2d6-277">Важные замечания о производительности</span><span class="sxs-lookup"><span data-stu-id="9e2d6-277">Key Performance Considerations</span></span>
 <span data-ttu-id="9e2d6-278">Все функциональные области в этом разделе, за исключением взаимодействия, сильно изменились в WF4 по сравнению с WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-278">The feature areas in this section, with the exception of interop, have dramatically changed between WF3 and WF4.</span></span>  <span data-ttu-id="9e2d6-279">Это оказало влияние как на конструирование приложений рабочих процессов, так и на производительность.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-279">This affects the design of workflow applications as well as the performance.</span></span>

#### <a name="workflow-activation-latency"></a><span data-ttu-id="9e2d6-280">Задержки активации рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="9e2d6-280">Workflow Activation Latency</span></span>
 <span data-ttu-id="9e2d6-281">В приложении службы рабочего процесса WCF задержка запуска нового рабочего процесса или загрузки существующего рабочего процесса важна, так как она может быть заблокирована.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-281">In a WCF workflow service application, the latency for starting a new workflow or loading an existing workflow is important as it can be blocking.</span></span>  <span data-ttu-id="9e2d6-282">В данном проверочном варианте производится измерение узла WF3 XOML в сравнении с узлом WF4 XAMLX в типичном сценарии.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-282">This test case measures a WF3 XOML host against a WF4 XAMLX host in a typical scenario.</span></span>

##### <a name="environment-setup"></a><span data-ttu-id="9e2d6-283">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-283">Environment Setup</span></span>
 ![Настройка среды для тестов задержек и пропускной способности](./media/performance/latency-throughput-environment-setup.gif)

##### <a name="test-setup"></a><span data-ttu-id="9e2d6-285">Настройка теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-285">Test Setup</span></span>
 <span data-ttu-id="9e2d6-286">В сценарии клиентский компьютер обращается к службе рабочего процесса WCF с помощью корреляции на основе контекста.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-286">In the scenario, a client computer contacts a WCF workflow service using context-based correlation.</span></span>  <span data-ttu-id="9e2d6-287">Корреляция контекста требует специальной привязки контекста и использует заголовок контекста или файл cookie для связывания сообщений с нужным экземпляром рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-287">Context correlation requires a special context binding and uses a context header or cookie to relate messages to the correct workflow instance.</span></span>  <span data-ttu-id="9e2d6-288">Преимущество в производительности объясняется тем, что идентификатор корреляции располагается в заголовке сообщения, поэтому не требуется синтаксический анализ его текста.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-288">It has a performance benefit in that the correlation Id is located in the message header so the message body does not need to be parsed.</span></span>

 <span data-ttu-id="9e2d6-289">Служба создаст новый рабочий процесс с запросом и отправит ответ немедленно, чтобы измерение задержки не включало в себя время, затрачиваемое на выполнение рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-289">The service will create a new workflow with the request and send an immediate response so that the measurement of latency does not include the time spent running the workflow.</span></span>  <span data-ttu-id="9e2d6-290">Рабочий процесс WF3 представляет собой XOML с фоновым кодом, а рабочий процесс WF4 полностью описан на XAML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-290">The WF3 workflow is XOML with a code-behind and the WF4 workflow is entirely XAML.</span></span>  <span data-ttu-id="9e2d6-291">Рабочий процесс WF4 выглядит следующим образом:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-291">The WF4 workflow looks like this:</span></span>

 ![Рабочий процесс области корреляции WF4](./media/performance/wf4-correlationscope-workflow.gif)

 <span data-ttu-id="9e2d6-293">Действие <xref:System.ServiceModel.Activities.Receive> создает экземпляр рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-293">The <xref:System.ServiceModel.Activities.Receive> activity creates the workflow instance.</span></span>  <span data-ttu-id="9e2d6-294">Значение, переданное в полученном сообщении, повторяется в ответном сообщении.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-294">A value passed in the received message is echoed in the reply message.</span></span>  <span data-ttu-id="9e2d6-295">Последовательность после ответа содержит оставшуюся часть рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-295">A sequence following the reply contains the rest of the workflow.</span></span>  <span data-ttu-id="9e2d6-296">В приведенном выше примере показано только одно действие комментария.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-296">In the above case, only one comment activity is shown.</span></span>  <span data-ttu-id="9e2d6-297">Число действий комментариев изменено, чтобы имитировать сложный рабочий процесс.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-297">The number of comment activities is changed to simulate workflow complexity.</span></span>  <span data-ttu-id="9e2d6-298">Действие комментария эквивалентно действию WF3 <xref:System.Workflow.Activities.CodeActivity>, которое ничего не делает.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-298">A comment activity is equivalent to a WF3 <xref:System.Workflow.Activities.CodeActivity> that performs no work.</span></span> <span data-ttu-id="9e2d6-299">Дополнительные сведения о действии Comment см. в разделе "Сравнение производительности на уровне компонентов" ранее в этой статье.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-299">For more information about the comment activity, see the "Component-level Performance Comparison" section earlier in this article.</span></span>

##### <a name="test-results"></a><span data-ttu-id="9e2d6-300">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-300">Test Results</span></span>

 <span data-ttu-id="9e2d6-301">Холодный и теплый задержка для служб рабочих процессов WCF:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-301">Cold and warm latency for WCF workflow services:</span></span>

 ![Гистограмма с нехолодной и теплой задержкой для служб рабочих процессов WCF с использованием WF3 и WF4](./media/performance/latency-results-graph.gif)

 <span data-ttu-id="9e2d6-303">На предыдущей диаграмме холодный означает случай, когда для данного рабочего процесса отсутствует существующий <xref:System.ServiceModel.WorkflowServiceHost> .</span><span class="sxs-lookup"><span data-stu-id="9e2d6-303">In the previous chart, cold refers to the case where there is not an existing <xref:System.ServiceModel.WorkflowServiceHost> for the given workflow.</span></span>  <span data-ttu-id="9e2d6-304">Другими словами, «холодная» задержка - это когда рабочий процесс используется в первый раз и для его компиляции нужен XOML или XAML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-304">In other words, cold latency is when the workflow is being used for the first time and the XOML or XAML needs to be compiled.</span></span>  <span data-ttu-id="9e2d6-305">«Теплая» задержка - это время, необходимое для создания нового экземпляра рабочего процесса, когда его тип уже скомпилирован.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-305">Warm latency is the time to create a new workflow instance when the workflow type has already been compiled.</span></span>  <span data-ttu-id="9e2d6-306">При использовании WF4 сложность рабочего процесса почти не влияет на результат, но при использовании WF3 линейно возрастает.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-306">The complexity of the workflow makes very little difference in the WF4 case but has a linear progression in the WF3 case.</span></span>

#### <a name="correlation-throughput"></a><span data-ttu-id="9e2d6-307">Пропускная способность корреляции</span><span class="sxs-lookup"><span data-stu-id="9e2d6-307">Correlation Throughput</span></span>
 <span data-ttu-id="9e2d6-308">В WF4 появилась новая функция корреляции на основе содержимого.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-308">WF4 introduces a new content-based correlation feature.</span></span>  <span data-ttu-id="9e2d6-309">В WF3 реализована только корреляция на основе контекста.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-309">WF3 provided only context-based correlation.</span></span>  <span data-ttu-id="9e2d6-310">Корреляция на основе контекста может быть выполнена только для конкретных привязок канала WCF.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-310">Context-based correlation could only be done over specific WCF channel bindings.</span></span>  <span data-ttu-id="9e2d6-311">Идентификатор рабочего потока при использовании этих привязок вставляется в заголовок сообщения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-311">The workflow Id is inserted into the message header when using these bindings.</span></span>  <span data-ttu-id="9e2d6-312">Среда выполнение WF3 может определить рабочий процесс только по этому идентификатору.  В корреляции на основе содержимого автор рабочего процесса может получить ключ корреляции на основе релевантных данных, например по номеру счета или идентификатору клиента.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-312">The WF3 runtime could only identify a workflow by its Id.  With content-based correlation, the workflow author can create a correlation key out of a relevant piece of data like an account number or customer Id.</span></span>

 <span data-ttu-id="9e2d6-313">Корреляция на основе контекста работает быстрее, так как ее ключ находится в заголовке.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-313">Context-based correlation has a performance advantage in that the correlation key is located in the message header.</span></span>  <span data-ttu-id="9e2d6-314">Поэтому его можно считать из сообщения без десериализации и копирования сообщения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-314">The key can be read from the message without de-serialization/message-copying.</span></span>  <span data-ttu-id="9e2d6-315">В корреляции на основе содержимого ключ хранится в теле сообщения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-315">In content-based correlation, the correlation key is stored in the message body.</span></span>  <span data-ttu-id="9e2d6-316">Его получение производится через выражение XPath.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-316">An XPath expression is used to locate the key.</span></span>  <span data-ttu-id="9e2d6-317">Затраты на такую обработку зависят от размера сообщения, глубины расположения ключа в нем и от числа ключей.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-317">The cost of this extra processing depends on the size of the message, depth of the key in the body, and the number of keys.</span></span>  <span data-ttu-id="9e2d6-318">Данный тест сравнивает корреляцию на основе содержимого и на основе контекста, а также показывает снижение производительности при использовании нескольких ключей.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-318">This test compares context- and content-based correlation and also shows the performance degradation when using multiple keys.</span></span>

#### <a name="environment-setup"></a><span data-ttu-id="9e2d6-319">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-319">Environment Setup</span></span>
![Настройка среды для теста производительности рабочего процесса](./media/performance/performance-test-environment.gif)

#### <a name="test-setup"></a><span data-ttu-id="9e2d6-321">Настройка теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-321">Test Setup</span></span>
<span data-ttu-id="9e2d6-322">![Тест рабочего процесса пропускной способности корреляции](./media/performance/correlation-throughput-workflow.gif "Настройка тестирования рабочего процесса для пропускной способности корреляции")</span><span class="sxs-lookup"><span data-stu-id="9e2d6-322">![Correlation Throughput Workflow Test](./media/performance/correlation-throughput-workflow.gif "Correlation throughput workflow test setup")</span></span>

 <span data-ttu-id="9e2d6-323">Предыдущий рабочий процесс совпадает с тем, который используется в разделе [сохраняемости](#persistence) .</span><span class="sxs-lookup"><span data-stu-id="9e2d6-323">The previous workflow is the same one used in the [Persistence](#persistence) section.</span></span> <span data-ttu-id="9e2d6-324">Для тестов корреляции без сохранения в среде выполнения не установлен поставщик сохраняемости.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-324">For the correlation tests without persistence, there is no persistence provider installed in the runtime.</span></span> <span data-ttu-id="9e2d6-325">Корреляция выполняется в двух местах: CreateOrder и CompleteOrder.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-325">Correlation occurs in two places: CreateOrder and CompleteOrder.</span></span>

#### <a name="test-results"></a><span data-ttu-id="9e2d6-326">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-326">Test Results</span></span>
<span data-ttu-id="9e2d6-327">![Пропускная способность корреляции](./media/performance/correlation-throughput-graph.gif "Диаграмма пропускной способности корреляции")</span><span class="sxs-lookup"><span data-stu-id="9e2d6-327">![Correlation Throughput](./media/performance/correlation-throughput-graph.gif "Correlation throughput graph")</span></span>

 <span data-ttu-id="9e2d6-328">Этот график показывает снижение производительности в зависимости от количества ключей, используемых в корреляции на основе содержимого.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-328">This graph shows a decrease in performance as the number of keys used in content-based correlation increases.</span></span>  <span data-ttu-id="9e2d6-329">Сходство кривых для TCP и HTTP указывает на издержки, связанные с этими протоколами.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-329">The similarity in the curves between TCP and HTTP indicates the overhead associated with these protocols.</span></span>

#### <a name="correlation-with-persistence"></a><span data-ttu-id="9e2d6-330">Корреляция с сохраняемостью</span><span class="sxs-lookup"><span data-stu-id="9e2d6-330">Correlation with Persistence</span></span>
 <span data-ttu-id="9e2d6-331">В сохраняемом рабочем процессе при корреляции на основе содержимого нагрузка на ЦП переносится со среды выполнения рабочего процесса на базу данных SQL.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-331">With a persisted workflow, the CPU pressure from content-based correlation shifts from the workflow runtime to the SQL database.</span></span>  <span data-ttu-id="9e2d6-332">Хранимые процедуры поставщика сохраняемости SQL выполняют действия по подбору ключей при поиске соответствующего рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-332">The stored procedures in the SQL persistence provider do the work of matching the keys to locate the appropriate workflow.</span></span>

 ![График, демонстрирующий результаты корреляции и сохраняемости](./media/performance/correlation-persistence-graph.gif)

 <span data-ttu-id="9e2d6-334">Корреляция на основе контекста работает быстрее, чем корреляция на основе содержимого.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-334">Context-based correlation is still faster than content-based correlation.</span></span>  <span data-ttu-id="9e2d6-335">Чаще, однако, на производительность влияет сохраняемость, а не корреляция.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-335">However, the difference is less pronounced as persistence has more impact on performance than correlation.</span></span>

### <a name="complex-workflow-throughput"></a><span data-ttu-id="9e2d6-336">Пропускная способность сложного рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="9e2d6-336">Complex Workflow Throughput</span></span>
 <span data-ttu-id="9e2d6-337">Сложность процесса определяется не только по количеству действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-337">The complexity of a workflow is not measured only by the number of activities.</span></span>  <span data-ttu-id="9e2d6-338">Составные действия могут содержать несколько дочерних элементов, а те, в свою очередь, также могут быть составными действиями.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-338">Composite activities can contain many children and those children can also be composite activities.</span></span>  <span data-ttu-id="9e2d6-339">Увеличение числа уровней вложенности приводит к увеличению числа действий, находящихся в состоянии выполнения в текущий момент, а также используемых переменных.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-339">As the number of levels of nesting increases, so does the number of activities that can be currently in the executing state and the number of variables that can be in state.</span></span>  <span data-ttu-id="9e2d6-340">Этот тест сравнивает пропускную способность WF4 при выполнении сложных рабочих процессов по сравнению с WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-340">This test compares throughput between WF3 and WF4 when executing complex workflows.</span></span>

### <a name="test-setup"></a><span data-ttu-id="9e2d6-341">Настройка теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-341">Test Setup</span></span>
 <span data-ttu-id="9e2d6-342">Эти тесты проводились на 4-процессорном компьютере Intel Xeon X5355 с частотой 2,66 ГГц и 4 ГБ памяти под управлением Windows Server 2008 x64.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-342">These tests were executed on an Intel Xeon X5355 @ 2.66GHz 4-way computer with 4GB RAM running Windows Server 2008 x64.</span></span>  <span data-ttu-id="9e2d6-343">Код теста запускался в одном процессе с потоком на ядро, что позволяет добиться 100 % загрузки ЦП.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-343">The test code runs in a single process with one thread per core to reach 100% CPU utilization.</span></span>

 <span data-ttu-id="9e2d6-344">У рабочих процессов, созданных для этого теста, есть две основные переменные: глубина и число действий в каждой из последовательностей.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-344">The workflows generated for this test have two main variables: depth and number of activities in each sequence.</span></span>  <span data-ttu-id="9e2d6-345">Каждый уровень вложенности включает параллельные действия, циклы, решения, присваивания и последовательности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-345">Each depth level includes a parallel activity, while loop, decisions, assignments, and sequences.</span></span>  <span data-ttu-id="9e2d6-346">В приведенном ниже конструкторе WF4 изображена блок-схема верхнего уровня.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-346">In the WF4 designer pictured below, the top-level flow chart is pictured.</span></span>  <span data-ttu-id="9e2d6-347">Каждое действие блок-схемы похоже на основную блок-схему.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-347">Each flowchart activity resembles the main flowchart.</span></span>  <span data-ttu-id="9e2d6-348">Возможно, для отображения этого рабочего процесса удобно будет использовать фрактал, где глубина будет ограничена параметрами теста.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-348">It may be helpful to think of a fractal when picturing this workflow, where the depth is limited to the parameters of the test.</span></span>

 <span data-ttu-id="9e2d6-349">Количество действий в данном тесте определяется глубиной и числом действий в последовательности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-349">The number of activities in a given test is determined by the depth and number of activities per sequence.</span></span>  <span data-ttu-id="9e2d6-350">Следующее уравнение вычисляет число действий в тесте для WF4:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-350">The following equation computes the number of activities in the WF4 test:</span></span>

 ![Уравнение для вычисления количества действий](./media/performance/number-activities-equation.gif)

 <span data-ttu-id="9e2d6-352">Счетчик действий в тесте для WF3 можно вычислить с помощью несколько другого уравнения, поскольку там имеется лишняя последовательность:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-352">The WF3 test’s activity count can be computed with a slightly different equation due to an extra sequence:</span></span>

 ![Уравнение для расчета числа WF3 действий](./media/performance/wf3-number-activities-equation.gif)

 <span data-ttu-id="9e2d6-354">где «d» - глубина, а «a» - число действий в последовательности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-354">Where d is the depth and a is the number of activities per sequence.</span></span>  <span data-ttu-id="9e2d6-355">Логика этих формул заключается в том, что первая константа, умноженная на «a», - это номер последовательности, а вторая константа - постоянное число действий на текущем уровне.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-355">The logic behind these equations is that the first constant, multiplied by a, is the number of sequences and the second constant is the static number of activities in the current level.</span></span>  <span data-ttu-id="9e2d6-356">В каждой блок-схеме имеется три дочерних действия.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-356">There are three flowchart child activities in each flowchart.</span></span>  <span data-ttu-id="9e2d6-357">На нижнем уровне вложенности эти блок-схемы пусты, но на других уровнях они представляют собой копии основной блок-схемы.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-357">At the bottom depth level, these flowcharts are empty but at the other levels they are copies of the main flowchart.</span></span>  <span data-ttu-id="9e2d6-358">Число действий в определении рабочего процесса для каждой вариации теста приведено в следующей таблице.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-358">The number of activities in each test variation’s workflow definition is indicated in the following table:</span></span>

 ![Таблица, показывающая количество действий, используемых в каждом тесте](./media/performance/workflow-variation-compare-table.gif)

 <span data-ttu-id="9e2d6-360">Число действий в определении рабочего процесса резко увеличивается с каждым новым уровнем вложенности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-360">The number of activities in the workflow definition increases sharply with each depth level.</span></span>  <span data-ttu-id="9e2d6-361">Однако в экземпляре данного рабочего процесса выполняется только один путь к каждой точке принятия решений, поэтому фактически выполняется лишь небольшое подмножество действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-361">But only one path per decision point is executed in a given workflow instance, so only a small subset of the actual activities are executed.</span></span>

 ![Блок-схема рабочего процесса сложной пропускной способности](./media/performance/complex-workflow-throughput-workflow.gif)

 <span data-ttu-id="9e2d6-363">Эквивалентный рабочий процесс создан для WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-363">An equivalent workflow was created for WF3.</span></span> <span data-ttu-id="9e2d6-364">В области конструирования конструктора WF3 показан весь рабочий процесс целиком, поэтому он слишком велик для отображения в этом разделе.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-364">The WF3 designer shows the entire workflow in the design area instead of nesting, therefore it is too big to display in this topic.</span></span> <span data-ttu-id="9e2d6-365">Ниже приведен фрагмент рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-365">A snippet of the workflow is shown below.</span></span>

 ![Фрагмент кода блок-схемы рабочего процесса WF3](./media/performance/wf3-workflow-snippet.gif)

 <span data-ttu-id="9e2d6-367">Для использования вложенности в крайних случаях в составе этого теста есть другой рабочий процесс, содержащий 100 вложенных последовательностей.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-367">To exercise nesting in an extreme case, another workflow that is part of this test uses 100 nested sequences.</span></span>  <span data-ttu-id="9e2d6-368">Самая внутренняя последовательность содержит один `Comment` или <xref:System.Workflow.Activities.CodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-368">In the innermost sequence is a single `Comment` or <xref:System.Workflow.Activities.CodeActivity>.</span></span>

 ![Блок-схема вложенной последовательности](./media/performance/nested-sequence-workflow.gif)

 <span data-ttu-id="9e2d6-370">Отслеживание и сохраняемость в этом тесте не используются.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-370">Tracking and persistence are not used as part of this test.</span></span>

### <a name="test-results"></a><span data-ttu-id="9e2d6-371">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-371">Test Results</span></span>
 ![Гистограмма, показывающая результаты пропускной способности](./media/performance/throughput-performance-results.gif)

 <span data-ttu-id="9e2d6-373">Даже в сложных рабочих процессах, содержащих множество действий и уровней вложенности, результаты производительности согласуются с показателями пропускной способности, приведенными выше в этой статье.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-373">Even with complex workflows with lots of depth and a high number of activities, the performance results are consistent with other throughput numbers shown earlier in this article.</span></span>  <span data-ttu-id="9e2d6-374">Пропускная способность WF4 на порядок выше и сравнима с логарифмической шкалой.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-374">WF4’s throughput is orders of magnitude faster and has to be compared on a logarithmic scale.</span></span>

### <a name="memory"></a><span data-ttu-id="9e2d6-375">Память</span><span class="sxs-lookup"><span data-stu-id="9e2d6-375">Memory</span></span>
 <span data-ttu-id="9e2d6-376">Издержки памяти Windows Workflow Foundation измеряются в двух ключевых областях: сложность рабочих процессов и число их определений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-376">The memory overhead of Windows Workflow Foundation is measured in two key areas: workflow complexity and number of workflow definitions.</span></span>  <span data-ttu-id="9e2d6-377">Измерения памяти производились на рабочей станции под управлением 64-разрядной версии Windows 7.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-377">Memory measurements were taken on a Windows 7 64-bit workstation.</span></span>  <span data-ttu-id="9e2d6-378">Существует множество способов получения измерения размера рабочего набора, например Мониторинг счетчиков производительности, опроса среды или использования такого средства, как VMMap, доступного из [VMMap](/sysinternals/downloads/vmmap).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-378">There are many ways to obtain the measurement of working set size such as monitoring performance counters, polling Environment.WorkingSet, or using a tool like VMMap available from [VMMap](/sysinternals/downloads/vmmap).</span></span> <span data-ttu-id="9e2d6-379">Для получения и проверки результатов каждого из тестов использовалось сочетание методов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-379">A combination of methods was used to obtain and verify the results of each test.</span></span>

### <a name="workflow-complexity-test"></a><span data-ttu-id="9e2d6-380">Тест сложности рабочего процесса</span><span class="sxs-lookup"><span data-stu-id="9e2d6-380">Workflow Complexity Test</span></span>
 <span data-ttu-id="9e2d6-381">Тест сложности рабочего процесса определяет разницу рабочих наборов в зависимости от сложности рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-381">The workflow complexity test measures the working set difference based on the complexity of the workflow.</span></span>  <span data-ttu-id="9e2d6-382">Помимо сложных рабочих процессов, которые использовались в предыдущем подразделе, добавлены новые вариации, чтобы реализовать два базовых случая: рабочий процесс с единственным действием и последовательность из 1000 действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-382">In addition to the complex workflows used in the previous section, new variations are added to cover two basic cases: a single activity workflow and a sequence with 1000 activities.</span></span>  <span data-ttu-id="9e2d6-383">Для этих тестов рабочие процессы инициализировались и выполнялись последовательно в цикле в течение минуты.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-383">For these tests the workflows are initialized and executed to completion in a single serial loop for a period of one minute.</span></span>  <span data-ttu-id="9e2d6-384">Каждая вариация теста запускалась трижды. При этом регистрировались средние данные по трем запускам.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-384">Each test variation is run three times and the data recorded is the average of those three runs.</span></span>

 <span data-ttu-id="9e2d6-385">Для двух новых базовых тестов рабочие процессы выглядят следующим образом:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-385">The two new basic tests have workflows that look like those shown below:</span></span>

 ![Сложный рабочий процесс для WF3 и WF4](./media/performance/complex-workflow-wf3-wf4.gif)

 <span data-ttu-id="9e2d6-387">В рабочем процессе WF3, показанном выше, использованы пустые действия <xref:System.Workflow.Activities.CodeActivity>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-387">In the WF3 workflow shown above, empty <xref:System.Workflow.Activities.CodeActivity> activities are used.</span></span>  <span data-ttu-id="9e2d6-388">В приведенном выше рабочем процессе для WF4 используются действия `Comment`.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-388">The WF4 workflow above uses `Comment` activities.</span></span>  <span data-ttu-id="9e2d6-389">Действие `Comment` описано в подразделе «Сравнение производительности на уровне компонентов» выше в данной статье.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-389">The `Comment` activity was described in the Component-level Performance Comparisons section earlier in this article.</span></span>

 ![Гистограмма, на которой показаны сложные объемы памяти рабочего процесса для рабочих процессов WF3 и WF4](./media/performance/complex-memory-usage-wf3-wf4.gif)

 <span data-ttu-id="9e2d6-391">Один из очевидных трендов, которые можно заметить в этом графике, - вложенность оказывает минимальный эффект на использование памяти как в WF3, так и в WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-391">One of the clear trends to notice in this graph is that nesting has relatively minimal impact on memory usage in both WF3 and WF4.</span></span>  <span data-ttu-id="9e2d6-392">В наибольшей степени на использование памяти влияет число действий в рабочем процессе.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-392">The most significant memory impact comes from the number of activities in a given workflow.</span></span>  <span data-ttu-id="9e2d6-393">Исходя из данных последовательности 1000, различия между последовательностью 5 с глубиной сложности 5 и последовательностью 1 с глубиной сложности 7, очевидно, что, когда количество элементов действий приближается к нескольким тысячам, увеличение использования памяти повышается более заметно.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-393">Given the data from the sequence 1000, complex depth 5 sequence 5, and complex depth 7 sequence 1 variations, it is clear that as the number of activities enters the thousands, the memory usage increase becomes more noticeable.</span></span>  <span data-ttu-id="9e2d6-394">В крайнем случае (глубина 7 последовательности 1), где имеется около 29 тысяч действий, WF4 занимает почти на 79 % меньше памяти, чем WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-394">In the extreme case (depth 7 sequence 1) where there are ~29K activities, WF4 is using almost 79% less memory than WF3.</span></span>

### <a name="multiple-workflow-definitions-test"></a><span data-ttu-id="9e2d6-395">Тест нескольких определений рабочих процессов</span><span class="sxs-lookup"><span data-stu-id="9e2d6-395">Multiple Workflow Definitions Test</span></span>
 <span data-ttu-id="9e2d6-396">Измерение памяти, занимаемой определением рабочего процесса, разделено на два отдельных теста, поскольку существуют разные доступные варианты размещения в WF3 и WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-396">Measuring memory per workflow definition is divided into two different tests because of the available options for hosting workflows in WF3 and WF4.</span></span>  <span data-ttu-id="9e2d6-397">Тесты выполняются иначе, чем тест сложности рабочего процесса, поскольку данный рабочий процесс создается и выполняется только один раз для каждого определения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-397">The tests are run in a different manner than the workflow complexity test in that a given workflow is instanced and executed only once per definition.</span></span>  <span data-ttu-id="9e2d6-398">Это обусловлено тем, что определение рабочего процесса и его узел остаются в памяти в течение жизненного цикла домена приложений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-398">This is because the workflow definition and its host remain in memory for the lifetime of the AppDomain.</span></span>  <span data-ttu-id="9e2d6-399">Память, занятая запущенным экземпляром рабочего процесса, будет очищена при следующей сборке мусора.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-399">The memory used by running a given workflow instance should be cleaned up during garbage collection.</span></span>  <span data-ttu-id="9e2d6-400">Руководство по миграции для WF4 содержит более подробные сведения о возможности размещения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-400">The migration guidance for WF4 contains more detailed information on the hosting options.</span></span> <span data-ttu-id="9e2d6-401">Дополнительные сведения см. в [разделе WF Migration Cookbook: Размещение](https://go.microsoft.com/fwlink/?LinkID=153313)рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-401">For more information, see [WF Migration Cookbook: Workflow Hosting](https://go.microsoft.com/fwlink/?LinkID=153313).</span></span>

 <span data-ttu-id="9e2d6-402">Создание множества определений рабочих процессов для данного теста можно выполнить несколькими разными способами.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-402">Creating many workflow definitions for a workflow definition test can be done in several ways.</span></span>  <span data-ttu-id="9e2d6-403">Например, можно создать код для формирования набора из 1000 рабочих процессов, различающихся только именем, и сохранить их в отдельных файлах.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-403">For instance, one could use code generation to create a set of 1000 workflows that are identical except in name and save each of those workflows into separate files.</span></span>  <span data-ttu-id="9e2d6-404">Такой подход был сделан для теста размещения в консоли.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-404">This approach was taken for the console-hosted test.</span></span>  <span data-ttu-id="9e2d6-405">В WF3 для запуска определений рабочих процессов использовался класс <xref:System.Workflow.Runtime.WorkflowRuntime>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-405">In WF3, the <xref:System.Workflow.Runtime.WorkflowRuntime> class was used to run the workflow definitions.</span></span>  <span data-ttu-id="9e2d6-406">В WF4 можно либо с помощью <xref:System.Activities.WorkflowApplication> создать отдельный экземпляр рабочего процесса, либо непосредственно использовать <xref:System.Activities.WorkflowInvoker> для запуска действия аналогично вызову метода.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-406">WF4 can either use <xref:System.Activities.WorkflowApplication> to create a single workflow instance or directly use <xref:System.Activities.WorkflowInvoker> to run the activity as if it were a method call.</span></span>  <span data-ttu-id="9e2d6-407"><xref:System.Activities.WorkflowApplication> - это ведущее приложение для одиночного экземпляра рабочего процесса, которое по возможностям ближе всего соответствует <xref:System.Workflow.Runtime.WorkflowRuntime>, поэтому он использовался в данном тесте.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-407"><xref:System.Activities.WorkflowApplication> is a host of a single workflow instance and has closer feature parity to <xref:System.Workflow.Runtime.WorkflowRuntime> so that was used in this test.</span></span>

 <span data-ttu-id="9e2d6-408">При размещении рабочих процессов в IIS можно с помощью <xref:System.Web.Hosting.VirtualPathProvider> создать новый <xref:System.ServiceModel.WorkflowServiceHost> вместо формирования всех файлов XAMLX или XOML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-408">When hosting workflows in IIS it is possible to use a <xref:System.Web.Hosting.VirtualPathProvider> to create a new <xref:System.ServiceModel.WorkflowServiceHost> instead of generating all of the XAMLX or XOML files.</span></span>  <span data-ttu-id="9e2d6-409"><xref:System.Web.Hosting.VirtualPathProvider> Обработчик обрабатывает входящий запрос и реагирует на «виртуальный файл», который может быть загружен из базы данных, или, в данном случае, в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-409">The <xref:System.Web.Hosting.VirtualPathProvider> handles the incoming request and responds with a "virtual file" that can be loaded from a database or, in this case, generated on the fly.</span></span>  <span data-ttu-id="9e2d6-410">Поэтому нет необходимости создавать 1000 физических файлов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-410">It is therefore unnecessary to create 1000 physical files.</span></span>

 <span data-ttu-id="9e2d6-411">Определения рабочих процессов, используемые в тесте консоли, были простыми последовательными рабочими процессами, содержащими одно действие.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-411">The workflow definitions used in the console test were simple sequential workflows with a single activity.</span></span>  <span data-ttu-id="9e2d6-412">Единичное действие было пустым действием <xref:System.Workflow.Activities.CodeActivity> в случае WF3 и действием `Comment` в случае WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-412">The single activity was an empty <xref:System.Workflow.Activities.CodeActivity> for the WF3 case and a `Comment` activity for the WF4 case.</span></span>  <span data-ttu-id="9e2d6-413">При размещении в IIS использовались рабочие процессы, которые запускаются при получении сообщения и завершаются при отправке ответа:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-413">The IIS-hosted case used workflows that start on receiving a message and end on sending a reply:</span></span>

<span data-ttu-id="9e2d6-414">На следующем рисунке показан рабочий процесс WF3 с ReceiveActivity и рабочий процесс WF4 с шаблоном "запрос-ответ":</span><span class="sxs-lookup"><span data-stu-id="9e2d6-414">The following image shows a WF3 workflow with ReceiveActivity and a WF4 workflow with request/response pattern:</span></span>

 ![Службы рабочих процессов в WF3 и WF4](./media/performance/workflow-receive-activity.gif)

 <span data-ttu-id="9e2d6-416">В следующей таблице показана разница в рабочем множестве между определением одного рабочего процесса и определениями 1001.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-416">The following table shows the delta in working set between a single workflow definition and 1001 definitions:</span></span>

|<span data-ttu-id="9e2d6-417">Варианты размещения</span><span class="sxs-lookup"><span data-stu-id="9e2d6-417">Hosting Options</span></span>|<span data-ttu-id="9e2d6-418">Дельта рабочего множества для WF3</span><span class="sxs-lookup"><span data-stu-id="9e2d6-418">WF3 Working Set Delta</span></span>|<span data-ttu-id="9e2d6-419">Дельта рабочего множества для WF4</span><span class="sxs-lookup"><span data-stu-id="9e2d6-419">WF4 Working Set Delta</span></span>|
|---------------------|---------------------------|---------------------------|
|<span data-ttu-id="9e2d6-420">Рабочие процессы, размещаемые в консольном приложении</span><span class="sxs-lookup"><span data-stu-id="9e2d6-420">Console Application Hosted Workflows</span></span>|<span data-ttu-id="9e2d6-421">18 MB</span><span class="sxs-lookup"><span data-stu-id="9e2d6-421">18 MB</span></span>|<span data-ttu-id="9e2d6-422">9 MB</span><span class="sxs-lookup"><span data-stu-id="9e2d6-422">9 MB</span></span>|
|<span data-ttu-id="9e2d6-423">Службы рабочих процессов, размещаемые в IIS</span><span class="sxs-lookup"><span data-stu-id="9e2d6-423">IIS Hosted Workflow Services</span></span>|<span data-ttu-id="9e2d6-424">446 MB</span><span class="sxs-lookup"><span data-stu-id="9e2d6-424">446 MB</span></span>|<span data-ttu-id="9e2d6-425">364 MB</span><span class="sxs-lookup"><span data-stu-id="9e2d6-425">364 MB</span></span>|

 <span data-ttu-id="9e2d6-426">Определения рабочих процессов размещения в IIS потребляют гораздо больше памяти из-за <xref:System.ServiceModel.WorkflowServiceHost>детальных артефактов службы WCF и логики обработки сообщений, связанной с узлом.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-426">Hosting workflow definitions in IIS consumes much more memory due to the <xref:System.ServiceModel.WorkflowServiceHost>, detailed WCF service artifacts, and the message processing logic associated with the host.</span></span>

 <span data-ttu-id="9e2d6-427">Для размещения в консольном приложении рабочие процессы WF3 реализованы в коде, а не в XOML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-427">For console hosting in WF3 the workflows were implemented in code instead of XOML.</span></span>  <span data-ttu-id="9e2d6-428">В WF4 по умолчанию используется XAML.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-428">In WF4 the default is to use XAML.</span></span>  <span data-ttu-id="9e2d6-429">Код XAML хранится в сборке как внедренный ресурс и компилируется во время выполнения при необходимости обеспечения реализации рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-429">The XAML is stored as an embedded resource in the assembly and compiled during runtime to provide the implementation of the workflow.</span></span>  <span data-ttu-id="9e2d6-430">Есть некоторые издержки, связанные с этим процессом.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-430">There is some overhead associated with this process.</span></span>  <span data-ttu-id="9e2d6-431">Чтобы адекватно сравнить WF3 и WF4, вместо XAML были использованы рабочие процессы в коде.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-431">In order to make a fair comparison between WF3 and WF4, coded workflows were used instead of XAML.</span></span>  <span data-ttu-id="9e2d6-432">Ниже показан пример одного из рабочих процессов WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-432">An example of one of the WF4 workflows is shown below:</span></span>

```csharp
public class Workflow1 : Activity
{
    protected override Func<Activity> Implementation
    {
        get
        {
            return new Func<Activity>(() =>
            {
                return new Sequence
                {
                    Activities = {
                        new Comment()
                    }
                };
            });
        }
        set
        {
            base.Implementation = value;
        }
    }
}
```

 <span data-ttu-id="9e2d6-433">Существует множество других факторов, которые могут повлиять на потребление памяти.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-433">There are many other factors that can affect memory consumption.</span></span> <span data-ttu-id="9e2d6-434">Тот же совет относится и ко всем управляемым программам.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-434">The same advice for all managed programs still applies.</span></span>  <span data-ttu-id="9e2d6-435">В среде размещения в IIS объект <xref:System.ServiceModel.WorkflowServiceHost>, созданный для определения рабочего процесса, остается в памяти до перезапуска пула приложений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-435">In IIS-hosted environments, the <xref:System.ServiceModel.WorkflowServiceHost> object created for a workflow definition stays in memory until the application pool is recycled.</span></span>  <span data-ttu-id="9e2d6-436">Это следует учитывать при написании расширений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-436">This should be kept in mind when writing extensions.</span></span>  <span data-ttu-id="9e2d6-437">Кроме того, лучше всего избегать "глобальных" переменных (переменных, областью действия которых является весь рабочий процесс) и ограничивать область переменных везде, где это возможно.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-437">Also, it is best to avoid "global" variables (variables scoped to the whole workflow) and limit the scope of variables wherever possible.</span></span>

## <a name="workflow-runtime-services"></a><span data-ttu-id="9e2d6-438">Службы среды выполнения рабочих процессов</span><span class="sxs-lookup"><span data-stu-id="9e2d6-438">Workflow Runtime Services</span></span>

### <a name="persistence"></a><span data-ttu-id="9e2d6-439">Сохраняемость</span><span class="sxs-lookup"><span data-stu-id="9e2d6-439">Persistence</span></span>
 <span data-ttu-id="9e2d6-440">И WF3 и WF4 поставляются с поставщиком сохраняемости SQL.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-440">WF3 and WF4 both ship with a SQL persistence provider.</span></span>  <span data-ttu-id="9e2d6-441">Поставщик сохраняемости SQL в WF3 - это простая реализация, которая сериализует экземпляр рабочего процесса и сохраняет его в большом двоичном объекте.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-441">The WF3 SQL persistence provider is a simple implementation that serializes the workflow instance and stores it in a blob.</span></span>  <span data-ttu-id="9e2d6-442">В этом смысле производительность поставщика в большой степени зависит от размера экземпляра рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-442">For this reason, the performance of this provider depends heavily on the size of the workflow instance.</span></span>  <span data-ttu-id="9e2d6-443">В WF3 размер экземпляра может вырасти по разным причинам, как обсуждалось ранее в этом документе.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-443">In WF3, the instance size could increase for many reasons, as is discussed previously in this paper.</span></span>  <span data-ttu-id="9e2d6-444">Многие клиенты решают отказаться от использования поставщика сохраняемости SQL, устанавливаемого по умолчанию, так как сохранение сериализованного экземпляра в базе данных не дает доступа к состоянию рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-444">Many customers choose not to use the default SQL persistence provider because storing a serialized instance in a database gives no visibility into the state of the workflow.</span></span>  <span data-ttu-id="9e2d6-445">Чтобы найти конкретный рабочий процесс, не зная его идентификатора, приходится выполнять десериализацию каждого сохраненного экземпляра и просматривать его содержимое.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-445">In order to find a particular workflow without knowing the workflow id, one would have to deserialize each persisted instance and examine the contents.</span></span>  <span data-ttu-id="9e2d6-446">Многие разработчики предпочитают создавать собственные поставщики сохраняемости, чтобы обойти это препятствие.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-446">Many developers prefer to write their own persistence providers to overcome this obstacle.</span></span>

 <span data-ttu-id="9e2d6-447">В поставщике сохраняемости SQL в WF4 предпринята попытка решить некоторые из этих проблем.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-447">The WF4 SQL persistence provider has tried to address some of these concerns.</span></span>  <span data-ttu-id="9e2d6-448">В таблицах сохраняемости доступна некоторая дополнительная информация, например активные закладки и свойства с возможностью продвижения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-448">The persistence tables expose certain information such as the active bookmarks and promotable properties.</span></span>  <span data-ttu-id="9e2d6-449">Функция корреляции на основе содержимого, появившаяся в WF4, не очень эффективна при сохраняемости SQL в стиле WF3, что приводит к необходимости внесения некоторых изменений в организацию сохраняемых экземпляров рабочих процессов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-449">The new content-based correlation feature in WF4 would not perform well using the WF3 SQL persistence approach, which has driven some change in the organization of the persisted workflow instance.</span></span>  <span data-ttu-id="9e2d6-450">Это усложняет задачу поставщика сохраняемости и приводит к повышению нагрузки на базу данных.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-450">This makes the job of the persistence provider more complex and puts extra stress on the database.</span></span>

### <a name="environment-setup"></a><span data-ttu-id="9e2d6-451">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-451">Environment Setup</span></span>
![Настройка среды для теста производительности рабочего процесса](./media/performance/performance-test-environment.gif)

### <a name="test-setup"></a><span data-ttu-id="9e2d6-453">Настройка теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-453">Test Setup</span></span>
 <span data-ttu-id="9e2d6-454">Поставщик сохраняемости SQL в WF4 работает быстрее, чем поставщик в WF3, даже после оптимизации набора функций и обработки параллелизма.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-454">Even with an improved feature set and better concurrency handling, the SQL persistence provider in WF4 is faster than the provider in WF3.</span></span>  <span data-ttu-id="9e2d6-455">Чтобы продемонстрировать это, ниже сравниваются два рабочих процесса, которые выполняют по сути одинаковые операции в WF3 и WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-455">To showcase this, two workflows that perform essentially the same operations in WF3 and WF4 are compared below.</span></span>

 ![Рабочий процесс сохраняемости в WF3 слева и WF4 справа](./media/performance/persist-workflow-wf3-wf4.gif)

 <span data-ttu-id="9e2d6-457">Оба рабочих процесса создаются при получении сообщения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-457">The two workflows are both created by a received message.</span></span>  <span data-ttu-id="9e2d6-458">После отправки первого ответа рабочие процессы сохраняются.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-458">After sending an initial reply, the workflow is persisted.</span></span>  <span data-ttu-id="9e2d6-459">В случае WF3 для сохранения используется пустой объект <xref:System.Workflow.ComponentModel.TransactionScopeActivity>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-459">In the WF3 case, an empty <xref:System.Workflow.ComponentModel.TransactionScopeActivity> is used to initiate the persistence.</span></span>  <span data-ttu-id="9e2d6-460">То же самое можно было бы сделать в WF3, пометив действие как "сохранить при закрытии".</span><span class="sxs-lookup"><span data-stu-id="9e2d6-460">The same could be achieved in WF3 by marking an activity as "persist on close."</span></span>  <span data-ttu-id="9e2d6-461">Второе, связанное сообщение завершает рабочий процесс.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-461">A second, correlated message completes the workflow.</span></span>  <span data-ttu-id="9e2d6-462">Рабочие процессы сохраняются, но не выгружаются.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-462">The workflows are persisted but not unloaded.</span></span>

### <a name="test-results"></a><span data-ttu-id="9e2d6-463">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-463">Test Results</span></span>
 ![Гистограмма, показывающая сохраняемость пропускной способности](./media/performance/throughput-persistence-graph.gif)

 <span data-ttu-id="9e2d6-465">Когда транспортом между клиентом и средним уровнем является HTTP, сохраняемость в WF4 показывает улучшение в 2,6 раза.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-465">When the transport between client and middle tier is HTTP, persistence in WF4 shows an improvement of 2.6 times.</span></span>  <span data-ttu-id="9e2d6-466">Транспорт TCP обеспечивает повышение этого коэффициента до 3,0 раза.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-466">The TCP transport increases that factor to 3.0 times.</span></span>  <span data-ttu-id="9e2d6-467">Во всех случаях нагрузка на ЦП на среднем уровне - 98 % и выше.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-467">In all cases, CPU utilization on the middle tier is 98% or higher.</span></span>  <span data-ttu-id="9e2d6-468">Причина повышения пропускной способности WF4 - более быстрая работа среды выполнения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-468">The reason that WF4 throughput is greater is due to the faster workflow runtime.</span></span>  <span data-ttu-id="9e2d6-469">Размер сериализованного экземпляра в обоих случаях невелик и поэтому не играет существенной роли в данном случае.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-469">The size of the serialized instance is low for both cases and is not a major contributing element in this situation.</span></span>

 <span data-ttu-id="9e2d6-470">Рабочие процессы WF3 и WF4 в данном тесте используют действие для явного указания момента сохранения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-470">Both the WF3 and WF4 workflows in this test use an activity to explicitly indicate when persistence should occur.</span></span>  <span data-ttu-id="9e2d6-471">Это дает преимущество - сохранение рабочего процесса без его выгрузки.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-471">This has the benefit of persisting the workflow without unloading it.</span></span>  <span data-ttu-id="9e2d6-472">В WF3 сохранение можно выполнить также с помощью функции <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToUnload%2A>, но тогда экземпляр рабочего процесса будет выгружен из памяти.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-472">In WF3, it is also possible to persist using the <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToUnload%2A> feature, but this unloads the workflow instance from memory.</span></span>  <span data-ttu-id="9e2d6-473">Если разработчик, использующий WF3, хочет убедиться в сохранении рабочего процесса в какой-либо точке, то ему необходимо либо изменить определение рабочего процесса, либо позаботиться о выгрузке и повторной загрузке экземпляра рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-473">If a developer using WF3 wants to make sure a workflow persists at certain points, they either have to alter the workflow definition or pay the cost for unloading and re-loading the workflow instance.</span></span>  <span data-ttu-id="9e2d6-474">С помощью новой функции в WF4 это можно сделать без выгрузки: <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToPersist%2A>.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-474">A new feature in WF4 makes it possible to persist without unloading: <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToPersist%2A>.</span></span>  <span data-ttu-id="9e2d6-475">Эта функция позволяет сохранить экземпляр рабочего процесса в фоновом режиме, но оставить в памяти до того момента, пока не будет достигнуто пороговое значение <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToUnload%2A> или не будет возобновлено выполнение.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-475">This feature allows the workflow instance to be persisted on idle but stay in memory until the <xref:System.ServiceModel.Activities.Description.WorkflowIdleBehavior.TimeToUnload%2A> threshold is met or execution is resumed.</span></span>

 <span data-ttu-id="9e2d6-476">Обратите внимание, что поставщик сохраняемости SQL в WF4 выполняет больше работы на уровне базы данных.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-476">Note that the WF4 SQL persistence provider performs more work in the database tier.</span></span>  <span data-ttu-id="9e2d6-477">База данных SQL может стать узким местом, поэтому важно отслеживать нагрузку на ЦП и дисковую подсистему на этом уровне.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-477">The SQL database can become a bottleneck so it is important to monitor the CPU and disk usage there.</span></span>  <span data-ttu-id="9e2d6-478">При выполнении теста производительности приложений рабочих процессов обязательно включите в базе данных SQL следующие счетчики производительности:</span><span class="sxs-lookup"><span data-stu-id="9e2d6-478">Be sure to include the following performance counters from the SQL database when performance testing workflow applications:</span></span>

- <span data-ttu-id="9e2d6-479">Физический\\диск% времени чтения с диска</span><span class="sxs-lookup"><span data-stu-id="9e2d6-479">PhysicalDisk\\%Disk Read Time</span></span>

- <span data-ttu-id="9e2d6-480">Физический\\диск% времени диска</span><span class="sxs-lookup"><span data-stu-id="9e2d6-480">PhysicalDisk\\% Disk Time</span></span>

- <span data-ttu-id="9e2d6-481">Физический\\диск% времени записи диска</span><span class="sxs-lookup"><span data-stu-id="9e2d6-481">PhysicalDisk\\% Disk Write Time</span></span>

- <span data-ttu-id="9e2d6-482">Физический\\диск% AVG. Disk Queue Length</span><span class="sxs-lookup"><span data-stu-id="9e2d6-482">PhysicalDisk\\% Avg. Disk Queue Length</span></span>

- <span data-ttu-id="9e2d6-483">PhysicalDisk\Avg. Disk Read Queue Length</span><span class="sxs-lookup"><span data-stu-id="9e2d6-483">PhysicalDisk\Avg. Disk Read Queue Length</span></span>

- <span data-ttu-id="9e2d6-484">PhysicalDisk\Avg. Disk Write Queue Length</span><span class="sxs-lookup"><span data-stu-id="9e2d6-484">PhysicalDisk\Avg. Disk Write Queue Length</span></span>

- <span data-ttu-id="9e2d6-485">PhysicalDisk\Current Disk Queue Length</span><span class="sxs-lookup"><span data-stu-id="9e2d6-485">PhysicalDisk\Current Disk Queue Length</span></span>

- <span data-ttu-id="9e2d6-486">Сведения о\\процессоре% загруженности процессора</span><span class="sxs-lookup"><span data-stu-id="9e2d6-486">Processor Information\\% Processor Time</span></span>

- <span data-ttu-id="9e2d6-487">SQLServer:Latches\Average Latch Wait Time (ms)</span><span class="sxs-lookup"><span data-stu-id="9e2d6-487">SQLServer:Latches\Average Latch Wait Time (ms)</span></span>

- <span data-ttu-id="9e2d6-488">SQLServer:Latches\Latch Waits/sec</span><span class="sxs-lookup"><span data-stu-id="9e2d6-488">SQLServer:Latches\Latch Waits/sec</span></span>

### <a name="tracking"></a><span data-ttu-id="9e2d6-489">Отслеживание</span><span class="sxs-lookup"><span data-stu-id="9e2d6-489">Tracking</span></span>
 <span data-ttu-id="9e2d6-490">Для отслеживания хода выполнения рабочего процесса можно воспользоваться трассировкой рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-490">Workflow tracking can be used to track the progress of a workflow.</span></span>  <span data-ttu-id="9e2d6-491">Информация, содержащаяся в событиях трассировки, определяется его профилем.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-491">The information that is included in the tracking events is determined by a tracking profile.</span></span>  <span data-ttu-id="9e2d6-492">Чем сложнее профиль трассировки, тем выше ее ресурсоемкость.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-492">The more complex the tracking profile, the more expensive tracking becomes.</span></span>

 <span data-ttu-id="9e2d6-493">В состав WF3 входит служба трассировки на основе SQL.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-493">WF3 shipped with a SQL-based tracking service.</span></span>  <span data-ttu-id="9e2d6-494">Она может работать в пакетном и непакетном режимах.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-494">This service could work in batched and non-batched modes.</span></span>  <span data-ttu-id="9e2d6-495">В непакетном режиме события трассировки записываются напрямую в базу данных.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-495">In non-batched mode, tracking events are written directly to the database.</span></span>  <span data-ttu-id="9e2d6-496">В пакетном режиме они накапливаются в том же пакете, что и состояние экземпляра рабочего процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-496">In batched mode, tracking events are collected into the same batch as the workflow instance state.</span></span>  <span data-ttu-id="9e2d6-497">Пакетный режим характеризуется более высокой производительностью для широкого выбора применений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-497">The batched mode has the best performance for the widest range of workflow designs.</span></span>  <span data-ttu-id="9e2d6-498">Однако пакетный режим может оказать отрицательное влияние на производительность в том случае, если рабочий процесс выполняет множество действий без сохранения и производится трассировка этих действий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-498">However, batching can have a negative performance impact if the workflow runs many activities without persisting and those activities are tracked.</span></span>  <span data-ttu-id="9e2d6-499">Такое часто случается в циклах, и лучший способ избежать этого - укрупнение циклов с включением в них точек сохранения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-499">This would commonly happen in loops and the best way to avoid this scenario is to design large loops to contain a persistence point.</span></span>  <span data-ttu-id="9e2d6-500">Появление в цикле точки сохранения может отрицательно сказаться на производительности, поэтому здесь важно чувство меры.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-500">Introducing a persistence point into a loop can negatively affect performance as well so it is important to measure the costs of each and come up with a balance.</span></span>

 <span data-ttu-id="9e2d6-501">В состав WF4 служба трассировки на основе SQL не входит.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-501">WF4 is not shipped with a SQL tracking service.</span></span>  <span data-ttu-id="9e2d6-502">Запись сведений об отслеживании в базу данных SQL может быть более эффективна с сервера приложений, а не встроена в .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-502">Recording tracking information to a SQL database can be handled better from an application server rather than built into the .NET Framework.</span></span> <span data-ttu-id="9e2d6-503">Поэтому трассировку SQL теперь обрабатывает AppFabric.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-503">Therefore SQL tracking is now handled by AppFabric.</span></span>  <span data-ttu-id="9e2d6-504">Готовый поставщик трассировки в WF4 создан на основе средства отслеживания трассировки событий Windows (ETW).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-504">The out-of-the-box tracking provider in WF4 is based on Event Tracing for Windows (ETW).</span></span>

 <span data-ttu-id="9e2d6-505">Трассировка событий Windows - встроенная в Windows система обработки событий, которая работает на уровне ядра и имеет низкий уровень задержек.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-505">ETW is a kernel-level, low-latency event system built into Windows.</span></span>  <span data-ttu-id="9e2d6-506">В ней реализована модель «поставщик-потребитель», поэтому при трассировке событий нагрузка на систему возникает только в том случае, когда существует реальный потребитель.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-506">It uses a provider/consumer model that makes it possible to only incur the penalty for event tracing when there is actually a consumer.</span></span>  <span data-ttu-id="9e2d6-507">Помимо событий уровня ядра (использование процессора, диска, памяти и сети), многие приложения также задействуют трассировку событий Windows.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-507">In addition to kernel events such as processor, disk, memory, and network usage, many applications leverage ETW as well.</span></span>  <span data-ttu-id="9e2d6-508">События трассировки событий Windows обладают более мощными возможностями, чем счетчики производительности, поскольку события могут быть настроены приложением.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-508">ETW events are more powerful than performance counters in that events can be customized to the application.</span></span>  <span data-ttu-id="9e2d6-509">Событие может содержать текст, например идентификатор рабочего процесса или информационное сообщение.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-509">An event can contain text such as a workflow ID or an informational message.</span></span>  <span data-ttu-id="9e2d6-510">Кроме того, события делятся на категории по битовым маскам и поэтому потребление подмножества событий оказывает меньшее влияние на производительность, чем захват всего потока событий.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-510">Also, events are categorized with bitmasks so that consuming a certain subset of events will have less performance impact than capturing all events.</span></span>

 <span data-ttu-id="9e2d6-511">Подход, предусматривающий использование для трассировки событий Windows вместо SQL, обеспечивает следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-511">Benefits to the approach of using ETW for tracking instead of SQL include:</span></span>

- <span data-ttu-id="9e2d6-512">Сбор событий трассировки можно выделить в отдельный процесс.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-512">Collection of tracking events can be separated to another process.</span></span>  <span data-ttu-id="9e2d6-513">Это дает огромную гибкость при выборе способа их регистрации.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-513">This gives greater flexibility in how the events are recorded.</span></span>

- <span data-ttu-id="9e2d6-514">События отслеживания ETW легко объединяются с событиями ETW WCF или другими поставщиками ETW, например SQL Server или поставщиком ядра.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-514">ETW tracking events are easily combined with the WCF ETW events or other ETW providers such as a SQL Server or kernel provider.</span></span>

- <span data-ttu-id="9e2d6-515">Автору рабочего процесса не нужно вносить в него изменения, чтобы адаптировать к конкретной реализации трассировки, например к службе трассировки SQL для WF3 в пакетном режиме.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-515">Workflow authors do not need to alter a workflow to work better with a particular tracking implementation, such as the WF3 SQL tracking service’s batch mode.</span></span>

- <span data-ttu-id="9e2d6-516">Администратор может включать и выключать трассировку без перезапуска хост-процесса.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-516">An administrator can turn tracking on or off without recycling the host process.</span></span>

 <span data-ttu-id="9e2d6-517">Выигрыш в производительности для отслеживания трассировки событий Windows имеет и обратную сторону.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-517">The performance benefits to ETW tracking come with a drawback.</span></span>  <span data-ttu-id="9e2d6-518">События трассировки событий Windows могут быть потеряны, если система испытывает критическую нехватку ресурсов.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-518">ETW events can be lost if the system is under intense resource pressure.</span></span>  <span data-ttu-id="9e2d6-519">Обработка событий не означает блокировку нормального выполнения программы, поэтому доставка всех событий трассировки событий Windows всем подписчикам не гарантируется.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-519">The processing of events is not meant to block normal program execution and therefore it is not guaranteed that all ETW events will be broadcast to their subscribers.</span></span>  <span data-ttu-id="9e2d6-520">Поэтому трассировка событий Windows отлично подходит для наблюдения за работоспособностью системы, но непригодна для аудита.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-520">This makes ETW tracking great for health monitoring but not suitable for auditing.</span></span>

 <span data-ttu-id="9e2d6-521">Хотя в WF4 нет поставщика трассировки SQL, он есть в AppFabric.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-521">While WF4 does not have a SQL tracking provider, AppFabric does.</span></span>  <span data-ttu-id="9e2d6-522">Методика трассировки SQL, реализованная в AppFabric, предусматривает подписку на события трассировки событий Windows с помощью службы Windows, когда события накапливаются в пакеты и записываются в таблицу SQL, рассчитанную на быструю вставку.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-522">AppFabric’s SQL tracking approach is to subscribe to ETW events with a Windows Service that batches the events and writes them to a SQL table designed for quick inserts.</span></span>  <span data-ttu-id="9e2d6-523">Отдельное задание забирает данные из этой таблицы и формирует на их основе таблицы отчетов, которые можно просмотреть на панели мониторинга AppFabric.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-523">A separate job drains the data from this table and reforms it into reporting tables that can be viewed on the AppFabric dashboard.</span></span>  <span data-ttu-id="9e2d6-524">Это означает, что пакеты событий трассировки обрабатываются независимо от рабочего процесса, из которого они поступили, поэтому не нужно ждать точки сохранения.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-524">This means that a batch of tracking events is handled independent of the workflow it came from and therefore does not have to wait for a persistence point before being recorded.</span></span>

 <span data-ttu-id="9e2d6-525">События трассировки событий Windows могут регистрироваться с помощью таких средств, как logman или xperf.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-525">ETW events can be recorded with tools such as logman or xperf.</span></span>  <span data-ttu-id="9e2d6-526">Компактный файл ETL можно просмотреть с помощью такого средства, как xperfview, или преобразовать в более удобочитаемый формат, например XML, с помощью tracerpt.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-526">The compact ETL file can be viewed with a tool like xperfview or converted to a more readable format, such as XML, with tracerpt.</span></span>  <span data-ttu-id="9e2d6-527">В WF3 единственная возможность получения событий трассировки без базы данных SQL - создание пользовательской службы трассировки.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-527">In WF3, the only option for getting tracking events without a SQL database is to create a custom tracking service.</span></span> <span data-ttu-id="9e2d6-528">Дополнительные сведения о ETW см. в разделе [службы WCF и трассировка событий для Windows](../wcf/samples/wcf-services-and-event-tracing-for-windows.md) и [трассировки событий — приложения Windows](/windows/desktop/etw/event-tracing-portal).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-528">For more information about ETW, see [WCF Services and Event Tracing for Windows](../wcf/samples/wcf-services-and-event-tracing-for-windows.md) and [Event Tracing - Windows applications](/windows/desktop/etw/event-tracing-portal).</span></span>

 <span data-ttu-id="9e2d6-529">Включение отслеживания рабочих процессов может по-разному отразиться на производительности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-529">Enabling workflow tracking will impact performance in varying degrees.</span></span>  <span data-ttu-id="9e2d6-530">В приведенном ниже тесте в качестве потребителя событий трассировки событий Windows используется средство logman, которое записывает их в файл ETL.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-530">The benchmark below uses the logman tool to consume the ETW tracking events and record them to an ETL file.</span></span>  <span data-ttu-id="9e2d6-531">Затраты на трассировку SQL в AppFabric выходят за рамки данной статьи.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-531">The cost of the SQL tracking in AppFabric is not in the scope of this article.</span></span>  <span data-ttu-id="9e2d6-532">В этом тесте показан базовый профиль трассировки, также используемый в AppFabric.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-532">The basic tracking profile, also used in AppFabric, is shown in this benchmark.</span></span>  <span data-ttu-id="9e2d6-533">Кроме того, включены затраты трассировки только для событий мониторинга работоспособности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-533">Also included is the cost of tracking only health monitoring events.</span></span>  <span data-ttu-id="9e2d6-534">Эти события удобно использовать для диагностики проблем и определения средней пропускной способности системы.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-534">These events are useful for troubleshooting problems and determining the average throughput of the system.</span></span>

### <a name="environment-setup"></a><span data-ttu-id="9e2d6-535">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-535">Environment Setup</span></span>
 ![Настройка среды для теста производительности рабочего процесса](./media/performance/performance-test-environment.gif)

### <a name="test-results"></a><span data-ttu-id="9e2d6-537">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-537">Test Results</span></span>

 ![Гистограмма, показывающая затраты на отслеживание рабочих процессов](./media/performance/workflow-tracking-costs.gif)

 <span data-ttu-id="9e2d6-539">Наблюдение за работоспособностью занимает примерно 3 % пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-539">Health monitoring has roughly a 3% impact on throughput.</span></span>  <span data-ttu-id="9e2d6-540">Затраты на обслуживание базового профиля - около 8 %.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-540">The basic profile’s cost is around 8%.</span></span>

## <a name="interop"></a><span data-ttu-id="9e2d6-541">Interop</span><span class="sxs-lookup"><span data-stu-id="9e2d6-541">Interop</span></span>
 <span data-ttu-id="9e2d6-542">WF4 представляет собой почти полностью переписанный [!INCLUDE[wf1](../../../includes/wf1-md.md)], поэтому рабочие процессы и действия WF3 не являются непосредственно совместимыми c WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-542">WF4 is almost a complete rewrite of [!INCLUDE[wf1](../../../includes/wf1-md.md)] and therefore WF3 workflows and activities are not directly compatible with WF4.</span></span>  <span data-ttu-id="9e2d6-543">Многие клиенты, которые заранее применяют Windows Workflow Foundation, будут иметь собственные или сторонние определения рабочих процессов и настраиваемые действия для WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-543">Many customers that adopted Windows Workflow Foundation early will have in-house or third-party workflow definitions and custom activities for WF3.</span></span>  <span data-ttu-id="9e2d6-544">Одним из способов облегчить переход на WF4 является использование действия Interop, которое способно выполнять действия WF3 в рабочих процессах WF4.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-544">One way to ease the transition to WF4 is to use the Interop activity, which can execute WF3 activities from within a WF4 workflow.</span></span>  <span data-ttu-id="9e2d6-545">Рекомендуется использовать действие <xref:System.Activities.Statements.Interop> только при необходимости.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-545">It is recommended that the <xref:System.Activities.Statements.Interop> activity only be used when necessary.</span></span> <span data-ttu-id="9e2d6-546">Дополнительные сведения о миграции в WF4 см. в [руководстве по миграции WF4](https://go.microsoft.com/fwlink/?LinkID=153313).</span><span class="sxs-lookup"><span data-stu-id="9e2d6-546">For more information about migrating to WF4 check out the [WF4 Migration Guidance](https://go.microsoft.com/fwlink/?LinkID=153313).</span></span>

### <a name="environment-setup"></a><span data-ttu-id="9e2d6-547">Настройка среды</span><span class="sxs-lookup"><span data-stu-id="9e2d6-547">Environment Setup</span></span>
 ![Настройка среды для теста производительности рабочего процесса](./media/performance/performance-test-environment.gif)

### <a name="test-results"></a><span data-ttu-id="9e2d6-549">Результаты теста</span><span class="sxs-lookup"><span data-stu-id="9e2d6-549">Test Results</span></span>
 
<span data-ttu-id="9e2d6-550">В следующей таблице показаны результаты выполнения рабочего процесса, содержащего пять действий в последовательности в различных конфигурациях.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-550">The following table shows the results of running a workflow containing five activities in a sequence in various configurations.</span></span>

|<span data-ttu-id="9e2d6-551">Тест</span><span class="sxs-lookup"><span data-stu-id="9e2d6-551">Test</span></span>|<span data-ttu-id="9e2d6-552">Пропускная способность (рабочих процессов/сек)</span><span class="sxs-lookup"><span data-stu-id="9e2d6-552">Throughput (workflows/sec)</span></span>|
|----------|-----------------------------------|
|<span data-ttu-id="9e2d6-553">Последовательность WF3 в среде выполнения WF3</span><span class="sxs-lookup"><span data-stu-id="9e2d6-553">WF3 Sequence in WF3 runtime</span></span>|<span data-ttu-id="9e2d6-554">1,576</span><span class="sxs-lookup"><span data-stu-id="9e2d6-554">1,576</span></span>|
|<span data-ttu-id="9e2d6-555">Последовательность WF3 в среде выполнения WF4 через действие Interop</span><span class="sxs-lookup"><span data-stu-id="9e2d6-555">WF3 Sequence in WF4 runtime using Interop</span></span>|<span data-ttu-id="9e2d6-556">2 745</span><span class="sxs-lookup"><span data-stu-id="9e2d6-556">2,745</span></span>|
|<span data-ttu-id="9e2d6-557">Последовательность WF4</span><span class="sxs-lookup"><span data-stu-id="9e2d6-557">WF4 Sequence</span></span>|<span data-ttu-id="9e2d6-558">153 582</span><span class="sxs-lookup"><span data-stu-id="9e2d6-558">153,582</span></span>|

 <span data-ttu-id="9e2d6-559">Имеется заметное повышение производительности при использовании Interop по сравнению с простым WF3.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-559">There is a notable performance increase to using Interop over straight WF3.</span></span>  <span data-ttu-id="9e2d6-560">Тем не менее по сравнению с действиями WF4 повышение незначительно.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-560">However, when compared against WF4 activities, the increase is negligible.</span></span>

## <a name="summary"></a><span data-ttu-id="9e2d6-561">Сводка</span><span class="sxs-lookup"><span data-stu-id="9e2d6-561">Summary</span></span>
 <span data-ttu-id="9e2d6-562">Крупные вложения в повышение производительности для WF4 окупаются во многих важных областях.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-562">Heavy investments in performance for WF4 have paid off in many crucial areas.</span></span>  <span data-ttu-id="9e2d6-563">Производительность отдельных компонентов рабочих процессов в WF4 в ряде случаев в сотни раз выше, чем в WF3, благодаря более экономной среде выполнения [!INCLUDE[wf1](../../../includes/wf1-md.md)].</span><span class="sxs-lookup"><span data-stu-id="9e2d6-563">Individual workflow component performance is in some cases hundreds of times faster in WF4 compared to WF3 due to a leaner [!INCLUDE[wf1](../../../includes/wf1-md.md)] runtime.</span></span>  <span data-ttu-id="9e2d6-564">Показатели задержки также значительно лучше.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-564">Latency numbers are significantly better as well.</span></span>  <span data-ttu-id="9e2d6-565">Это означает, что снижение производительности в [!INCLUDE[wf1](../../../includes/wf1-md.md)] сравнении с написанием вручную служб оркестрации WCF очень мало, учитывая преимущества использования [!INCLUDE[wf1](../../../includes/wf1-md.md)].</span><span class="sxs-lookup"><span data-stu-id="9e2d6-565">This means the performance penalty for using [!INCLUDE[wf1](../../../includes/wf1-md.md)] as opposed to hand-coding WCF orchestration services is very small considering the added benefits of using [!INCLUDE[wf1](../../../includes/wf1-md.md)].</span></span>  <span data-ttu-id="9e2d6-566">Производительность сохранения данных повысилась в 2,5–3,0 раза.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-566">Persistence performance has increased by a factor of 2.5 - 3.0.</span></span>  <span data-ttu-id="9e2d6-567">Наблюдение за работоспособностью при применении трассировки рабочего процесса имеет очень малые издержки.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-567">Health monitoring by means of workflow tracking now has very little overhead.</span></span>  <span data-ttu-id="9e2d6-568">Для тех, кто планирует переход с WF3 на WF4, имеется широкий выбор руководств по миграции.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-568">A comprehensive set of migration guides are available for those that are considering moving from WF3 to WF4.</span></span>  <span data-ttu-id="9e2d6-569">Все это делает WF4 привлекательным выбором для написания сложных приложений.</span><span class="sxs-lookup"><span data-stu-id="9e2d6-569">All of this should make WF4 an attractive option for writing complex applications.</span></span>
