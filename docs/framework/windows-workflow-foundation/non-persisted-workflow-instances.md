---
title: Экземпляры нематериализованного рабочего процесса
ms.date: 03/30/2017
ms.assetid: 5e01af77-6b14-4964-91a5-7dfd143449c0
ms.openlocfilehash: 315d791585ace6ce4adf281abbba0a4c8c72d75a
ms.sourcegitcommit: d6e27023aeaffc4b5a3cb4b88685018d6284ada4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/09/2019
ms.locfileid: "67663048"
---
# <a name="non-persisted-workflow-instances"></a>Экземпляры нематериализованного рабочего процесса

При создании нового экземпляра рабочего процесса, состояние которого сохраняется в <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore>, узел службы создает запись для этой службы в хранилище экземпляров. Затем при первом сохранении экземпляра рабочего процесса <xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> сохраняет текущее состояние экземпляра. Если рабочий процесс размещен в службе активации Windows, данные развертывания службы также записываются в хранилище экземпляров при первом сохранении экземпляра.

До тех пор, пока экземпляр рабочего процесса не сохранен, он находится в **несохраняемый** состояния. Если экземпляр рабочего процесса находится в этом состоянии, его нельзя восстановить после очистки домена приложения, ошибки узла или сбоя в работе компьютера.

## <a name="the-non-persisted-state"></a>Несохраняемое состояние

Несохраненные устойчивые экземпляры рабочего процесса остаются в несохраняемом состоянии в следующих случаях.

- Сбой узла службы происходит до первого сохранения экземпляра рабочего процесса. Экземпляр рабочего процесса остается в хранилище экземпляров. Не выполняется восстановление этого экземпляра. Если поступает связанное сообщение, экземпляр рабочего процесса вновь становится активным.

- Экземпляр рабочего процесса формирует исключение до его первого сохранения. В зависимости от возвращаемого <xref:System.Activities.UnhandledExceptionAction> выполняется следующий сценарий:

  - <xref:System.Activities.UnhandledExceptionAction> имеет значение <xref:System.Activities.UnhandledExceptionAction.Abort>: Когда происходит исключение, сведения о развертывании службы записываются в хранилище экземпляров и экземпляр рабочего процесса выгружается из памяти. Экземпляр рабочего процесса остается в несохраняемом состоянии и не может быть выгружен.

  - <xref:System.Activities.UnhandledExceptionAction> имеет значение <xref:System.Activities.UnhandledExceptionAction.Cancel> или <xref:System.Activities.UnhandledExceptionAction.Terminate>: При возникновении исключения, сведения о развертывании службы записываются в хранилище экземпляров и состояние экземпляра действия имеет значение <xref:System.Activities.ActivityInstanceState.Closed>.

Чтобы свести к минимуму риск возникновения невыгруженных несохраняемых экземпляров рабочих процессов, рекомендуется сохранять рабочие процессы на ранних этапах жизненного цикла.

## <a name="detection-and-removal-of-non-persisted-instances"></a>Обнаружение и удаление несохраняемых экземпляров

<xref:System.Activities.DurableInstancing.SqlWorkflowInstanceStore> не удаляет из хранилища экземпляров несохраняемые экземпляры рабочих процессов. Также не удаляются владельцы блокировок, срок действия которых истек и с которыми связаны несохраняемые экземпляры рабочих процессов.

Администратору рекомендуется выполнять регулярную проверку хранилища экземпляров на наличие несохраняемых экземпляров. Администраторы могут удалять эти экземпляры из хранилища экземпляров, если известно, что этот рабочий процесс не будет получать связанные сообщения. Например, если экземпляр находился в базе данных в течение нескольких месяцев и известно, что стандартное время существования жизненного цикла рабочего процесса составляет несколько дней, можно с уверенностью предположить, что это инициализированный экземпляр, в котором произошел сбой.

При поиске несохраняемых экземпляров в хранилище экземпляров рабочих процессов SQL можно использовать следующие SQL-запросы:

- Этот запрос найдет все сохраненные экземпляры и вернет для них идентификаторы и время создания (сохраняется во времени в формате UTC).

  ```sql
  select InstanceId, CreationTime
      from [System.Activities.DurableInstancing].[Instances]
      where IsInitialized = 0
  ```

- Этот запрос найдет все несохраненные и незагруженные экземпляры и вернет для них идентификаторы и время создания (сохраняется во времени в формате UTC).

  ```sql
  select InstanceId, CreationTime
      from [System.Activities.DurableInstancing].[Instances]
      where IsInitialized = 0
          and CurrentMachine is NULL
  ```

- Этот запрос найдет все приостановленные и несохраненные экземпляры и вернет для них идентификаторы, время создания (сохраняется во времени в формате UTC), причину приостановления и имя исключения.

  ```sql
  select InstanceId, CreationTime, SuspensionReason, SuspensionExceptionName
      from [System.Activities.DurableInstancing].[Instances]
      where IsInitialized = 0
          and IsSuspended = 1
  ```

При удалении несохраненных экземпляров будьте крайне внимательны. Как правило, несохраненные экземпляры, созданные <xref:System.ServiceModel.Activities.WorkflowServiceHost>, которые были отложены или не загружены, можно удалять без осложнений. Эти конкретные экземпляры можно удалить из хранилища путем их удаления из представления `[System.Activities.DurableInstancing].[Instances]` с помощью следующей команды SQL, указав правильный идентификатор экземпляра.

```sql
delete [System.Activities.DurableInstancing].[Instances]
    where InstanceId=’078a9bc4-ada5-4f9e-8cce-b0eb0009995f’
```

> [!WARNING]
> Не рекомендуется удалять все несохраненные экземпляры, поскольку к ним относятся экземпляры, которые были недавно созданы и которые еще не были сохранены.
