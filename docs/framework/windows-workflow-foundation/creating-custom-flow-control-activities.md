---
title: Создание пользовательских действий управления потоком
ms.date: 03/30/2017
ms.assetid: 27f409f6-2d1d-4cfb-9765-93eb2ad667d5
ms.openlocfilehash: f457e6f8cefd7183ca20cb449adf1ac15d7bde79
ms.sourcegitcommit: 2701302a99cafbe0d86d53d540eb0fa7e9b46b36
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/28/2019
ms.locfileid: "64647148"
---
# <a name="creating-custom-flow-control-activities"></a>Создание пользовательских действий управления потоком
.NET Framework содержит различные действия управления потоком, которые работают так же, чтобы абстрактные программные структуры (такие как <xref:System.Activities.Statements.Flowchart>) или стандартные программные инструкции (такие как <xref:System.Activities.Statements.If>). В этом разделе обсуждается архитектура одного из образцов проектов, [ForEach неуниверсальные](./samples/non-generic-foreach.md).  
  
## <a name="creating-the-custom-class"></a>Создание пользовательского класса  
 Так как неуниверсальному классу ForEach необходимо планировать дочерние действия, он должен быть производным от <xref:System.Activities.NativeActivity>, поскольку действия, производные от <xref:System.Workflow.Activities.CodeActivity>, не имеют этой функциональной возможности.  
  
```  
public sealed class ForEach : NativeActivity  
    {  
```  
  
 Пользовательский класс требует, чтобы это действие использовало несколько элементов для хранения данных и для обеспечения возможности выполнять дочерние действия этого действия. К этим элементам относятся следующие:  
  
- `valueEnumerator`: Не являющиеся открытыми <xref:System.Activities.Variable%601> типа <xref:System.Collections.IEnumerator> используется для итерации по коллекции элементов. Это элемент имеет тип <xref:System.Activities.Variable%601>, так как он используется внутри действия, а не является аргументом или открытым свойством, которые использовались бы в том случае, если бы объект имел происхождение за пределами действия.  
  
- `OnChildComplete`: Открытый <xref:System.Activities.CompletionCallback> свойство, которое выполняется при завершении каждого дочернего. Этот элемент представляет собой свойство CLR, так как его значение не изменяется для различных экземпляров действия.  
  
- `Values`: Коллекция входных данных, используемая для итераций дочернего действия. Это элемент типа <xref:System.Activities.InArgument%601>, так как данные находятся за пределами действия, но ожидается, что содержимое коллекции не будет меняться во время выполнения действия. Если бы для действия было необходимо обеспечить изменяемость элементов коллекции во время выполнения действия (например, добавление или удаление действий), этот элемент был бы определен как <xref:System.Activities.ActivityAction>, которое затем вычислялось бы при каждом обращении, чтобы изменения были доступны для действия.  
  
- `Body`: Этот элемент определяет, что действие должно выполняться для каждого элемента в `Values` коллекции. Этот элемент определен как <xref:System.Activities.ActivityAction>, поэтому он вычисляется при каждом обращении к нему.  
  
- `Execute`: Этот метод использует `InternalExecute`, `OnForEachComplete`, и `GetStateAndExecute` необщедоступные члены для планирования выполнения и назначения обработчика завершения дочернего действия, определенные в элементе Body.  
  
- `CacheMetadata`: Этот элемент предоставляет среде выполнения сведения, необходимые для выполнения операции. По умолчанию метод `CacheMetadata` действия сообщает среде выполнения обо всех открытых элементах действия, но, поскольку в этом действии для некоторых функций используются закрытые элементы, он должен сообщать среде выполнения о существовании этих элементов. В этом случае функция `CacheMetadata` переопределяется, чтобы обеспечить доступ к закрытому элементу `valueEnumerator`. Этот элемент также создает аргумент для значений для этого действия, чтобы их можно было передавать действию во время выполнения.
