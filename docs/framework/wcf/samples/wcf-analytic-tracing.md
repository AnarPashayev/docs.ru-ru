---
title: Аналитическая трассировка WCF
ms.date: 03/30/2017
ms.assetid: 6029c7c7-3515-4d36-9d43-13e8f4971790
ms.openlocfilehash: ef636a672d9384e8e3d658f0488cfaadb8d293e4
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79183221"
---
# <a name="wcf-analytic-tracing"></a>Аналитическая трассировка WCF
Этот пример демонстрирует, как добавить свои собственные события трассировки в поток аналитических следов, [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]которые Windows Communication Foundation (WCF) пишет В ETW в . Аналитически отслеживаемые события предназначены для упрощения добавления видимости в службы без ущерба для производительности. В этом примере <xref:System.Diagnostics.Eventing?displayProperty=nameWithType> показано, как использовать AI для записи событий, которые интегрируются с службами WCF.  
  
 Для получения дополнительной <xref:System.Diagnostics.Eventing?displayProperty=nameWithType> информации <xref:System.Diagnostics.Eventing?displayProperty=nameWithType>об AIS см.  
  
 Чтобы узнать больше о отслеживании событий в Windows, [см.](https://docs.microsoft.com/archive/msdn-magazine/2007/april/event-tracing-improve-debugging-and-performance-tuning-with-etw)  
  
## <a name="disposing-eventprovider"></a>Удаление EventProvider  
 В этом образце используется класс <xref:System.Diagnostics.Eventing.EventProvider?displayProperty=nameWithType>, который реализует <xref:System.IDisposable?displayProperty=nameWithType>. При реализации отслеживания для службы WCF, вполне <xref:System.Diagnostics.Eventing.EventProvider>вероятно, что вы можете использовать ресурсы 'для жизни службы. По этой причине, а также для удобочитаемости, этот образец никогда не удаляет упакованный <xref:System.Diagnostics.Eventing.EventProvider>. Если по какой-либо причине ваша служба имеет другие требования для трассировки и вы должны удалить этот ресурс, то вы должны изменить этот пример в соответствии с подходящими рекомендациями по удалению неуправляемых ресурсов. Для получения дополнительной информации об утилизации неуправляемых ресурсов [см.](https://docs.microsoft.com/dotnet/standard/garbage-collection/implementing-dispose)  
  
## <a name="self-hosting-vs-web-hosting"></a>Сравнение резидентного размещения с размещением на веб-сервере  
 Для веб-сервисов аналитические следы WCF предоставляют поле под названием "HostReference", которое используется для идентификации службы, испускающей следы. В этой модели могут участвовать расширяемые пользовательские трассировки, а в данном образце демонстрируются рекомендации, как это сделать. Формат ссылки веб-хоста, когда символ "&#124;" трубы на самом деле появляется в резкей строки может быть любой из следующих:  
  
- Если приложение находится не в корне.  
  
     \<SiteName \<>ApplicationVirtualPath>&#124;\< \<ServiceVirtualPath>&#124;ServiceName>  
  
- Если приложение находится в корне.  
  
     \<SiteName \<>&#124;ServiceVirtualPath>&#124;\<ServiceName>  
  
 Для самостоятельных сервисов аналитические следы WCF не заполняют поле "HostReference". В этом образце класс `WCFUserEventProvider` ведет себя согласованно при использовании резидентной службой.  
  
## <a name="custom-event-details"></a>Данные пользовательских событий  
 Манифест wCF ETW Event Provider определяет три события, которые предназначены для испускаемых авторами служб wCF из кода обслуживания. В следующей таблице приведена разбивка этих трех событий.  
  
|Событие|Описание|Идентификатор события|  
|-----------|-----------------|--------------|  
|UserDefinedInformationEventOccurred|Это событие выдается, когда в службе происходит что-то примечательное, что не является проблемой. Например, можно выдать событие после успешного вызова базы данных.|301|  
|UserDefinedWarningOccurred|Это событие выдается, когда возникает проблема, которая в будущем может привести к сбою. Например, можно выдавать событие предупреждения, когда вызов базы данных завершается неудачей, но удалось выполнить восстановление, переключившись на резервное хранилище данных.|302|  
|UserDefinedErrorOccurred|Это событие выдается, когда служба не ведет себя, как положено. Например, можно выдавать событие, если вызов базы данных завершается неудачей и данные не удалось получить из другого источника.|303|  
  
#### <a name="to-use-this-sample"></a>Использование этого образца  
  
1. Используя Visual Studio 2012, откройте файл решений WCFAnalyticTracingExtensibility.sln.  
  
2. Для построения решения нажмите CTRL+SHIFT+B.  
  
3. Чтобы запустить решение, нажмите клавиши CTRL+F5.  
  
     В веб-браузере нажмите **Calculator.svc**. В браузере должен появиться URI WSDL-документа для службы. Скопируйте этот URI.  
  
4. Выполнить тестовый клиент WCF (WcfTestClient.exe).  
  
     Тестовый клиент WCF (WcfTestClient.exe) `\<Visual Studio 2012 Install Dir>\Common7\IDE\WcfTestClient.exe`находится по адресу . По умолчанию Visual Studio 2012 установить dir является `C:\Program Files\Microsoft Visual Studio 10.0`.  
  
5. В тестовом клиенте WCF добавьте услугу, выбрав **файл,** а затем **добавьте услугу.**  
  
     Добавьте адрес конечной точки в поле ввода.  
  
6. Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно.  
  
     Услуга ICalculator добавляется в левую панель в рамках **проектов «Мой сервис».**  
  
7. Откройте приложение просмотра событий.  
  
     Прежде чем выступить в службу, запустите Event Viewer и убедитесь, что журнал событий прослушивает события, испущенные из службы WCF.  
  
8. Из меню **«Пуск»** выберите **Административные инструменты,** а затем **зритель событий.** Включить **журналы analytic** и **Debug.**  
  
9. В представлении дерева в Event Viewer перейдите в журналы **событий,** **приложения и службы,** **Microsoft,** **Windows,** а затем **приложения Server-Applications.** Право нажмите **приложение Server-Приложения**, выберите **Просмотр**, а затем **показать аналитические и debug журналы**.  
  
     Убедитесь, что **опция Show Analytic и Debug Logs проверена.** Включить **аналитический** журнал.  
  
     В представлении дерева в Event Viewer перейдите в журналы **событий,** **приложения и службы,** **Microsoft,** **Windows,** **Application Server-Applications,** а затем **аналитические**. Нажмите правой кнопкой **аналитический** и выберите **Включить журнал**.  
  
10. Проверьте службу с помощью тестового клиента WCF.  
  
    1. В тестовом клиенте WCF дважды щелкните **прибавку ()** под узлом сервиса ICalculator.  
  
         Метод **Добавить ()** отображается в правом стене с двумя параметрами.  
  
    2. Введите 2 для первого параметра и 3 для второго.  
  
    3. Нажмите **Наймите Вызвать** метод.  
  
11. Перейдите к окну **Event Viewer,** которое вы уже открыли. Перейдите к **просмотру событий,** **приложениям и журналам служб,** **Microsoft,** **Windows,** **Приложения Сервер-Приложения**.  
  
12. Нажмите справа на **аналитический** узлы и выберите **Refresh**.  
  
     События появятся в области справа.  
  
13. Найдите событие с идентификатором 303 и щелкните его дважды, чтобы открыть его и ознакомиться с его содержимым.  
  
     Это событие было испущено методом `Add()` службы ICalculator и имеет полезную нагрузку, равную "2'3"5".  
  
#### <a name="to-clean-up-optional"></a>Очистка (необязательно)  
  
1. Откройте **Средство просмотра событий**.  
  
2. Перейдите к **просмотру событий,** **журналам приложений и служб,** **Microsoft,** **Windows,** а затем **application-Server-Applications**. Нажмите правой кнопкой **аналитический** и выберите **отключить журнал**.  
  
3. Перейдите к **просмотру событий,** **приложениям и службам Журналы**, **Microsoft**, **Windows**, **приложения-сервер-приложения**, а затем **аналитические**. Нажмите правой кнопкой **аналитический** и выберите **Clear Log**.  
  
4. Нажмите **Clear,** чтобы очистить события.  
  
## <a name="known-issue"></a>Известная проблема  
 Существует известная проблема в **Viewer событий,** где он может не расшифровать события ETW. Вы можете увидеть сообщение об ошибке, в \<которое говорится: "Описание идентификатора событий id> из источника Microsoft-Windows-Application Server-Applications не может быть найдено. Компонент, вызывающий это событие, не установлен на локальном компьютере или установка повреждена. Вы можете установить или отремонтировать компонент на локальном компьютере." Если вы столкнулись с этой ошибкой, выберите **Обновление** из меню **«Действия».** Теперь декодирование события должно выполняться правильно.  
  
> [!IMPORTANT]
> Образцы уже могут быть установлены на компьютере. Перед продолжением проверьте следующий каталог (по умолчанию).  
>
> `<InstallDrive>:\WF_WCF_Samples`  
>
> Если этого каталога не существует, перейдите в [Windows Communication Foundation (WCF) и Windows Workflow Foundation (WF) Образцы для .NET Framework 4,](https://www.microsoft.com/download/details.aspx?id=21459) чтобы загрузить все Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] образцы. Этот образец расположен в следующем каталоге.  
>
> `<InstallDrive>:\WF_WCF_Samples\WCF\Basic\Management\ETWTrace`  
  
## <a name="see-also"></a>См. также раздел

- [Образцы наблюдения за AppFabric](https://docs.microsoft.com/previous-versions/appfabric/ff383407(v=azure.10))
