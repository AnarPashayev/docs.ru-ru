---
title: Аналитическая трассировка WCF
ms.date: 03/30/2017
ms.assetid: 6029c7c7-3515-4d36-9d43-13e8f4971790
ms.openlocfilehash: 9ed89bdbe2469a96f2a959c9fda8442e80b6f7ec
ms.sourcegitcommit: 558d78d2a68acd4c95ef23231c8b4e4c7bac3902
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59332317"
---
# <a name="wcf-analytic-tracing"></a>Аналитическая трассировка WCF
Этот образец демонстрирует способы добавления собственных событий трассировки событий в поток трассировки, которые записывает трассировки событий Windows в Windows Communication Foundation (WCF) [!INCLUDE[netfx_current_long](../../../../includes/netfx-current-long-md.md)]. Аналитически отслеживаемые события предназначены для упрощения добавления видимости в службы без ущерба для производительности. В этом примере показано, как использовать <xref:System.Diagnostics.Eventing?displayProperty=nameWithType> API писать события, которые интегрируются со службами WCF.  
  
 Дополнительные сведения о <xref:System.Diagnostics.Eventing?displayProperty=nameWithType> API, см. в разделе <xref:System.Diagnostics.Eventing?displayProperty=nameWithType>.  
  
 Дополнительные сведения о трассировке событий в Windows, см. в разделе [улучшение отладки и настройки производительности с помощью ETW](https://go.microsoft.com/fwlink/?LinkId=166488).  
  
## <a name="disposing-eventprovider"></a>Удаление EventProvider  
 В этом образце используется класс <xref:System.Diagnostics.Eventing.EventProvider?displayProperty=nameWithType>, который реализует <xref:System.IDisposable?displayProperty=nameWithType>. При реализации трассировки для службы WCF, вполне вероятно, что вы можете использовать <xref:System.Diagnostics.Eventing.EventProvider>его ресурсы в течение времени существования службы. По этой причине, а также для удобочитаемости, этот образец никогда не удаляет упакованный <xref:System.Diagnostics.Eventing.EventProvider>. Если по какой-либо причине ваша служба имеет другие требования для трассировки и вы должны удалить этот ресурс, то вы должны изменить этот пример в соответствии с подходящими рекомендациями по удалению неуправляемых ресурсов. Дополнительные сведения об удалении неуправляемых ресурсов, см. в разделе [реализация метода Dispose](https://go.microsoft.com/fwlink/?LinkId=166436).  
  
## <a name="self-hosting-vs-web-hosting"></a>Резидентное размещение в сравнении с размещением на веб-узле  
 Для служб, размещенных на веб сервере трассировки WCF предоставляют поле, с именем «HostReference», который используется для идентификации службы, выдающей трассировки. В этой модели могут участвовать расширяемые пользовательские трассировки, а в данном образце демонстрируются рекомендации, как это сделать. Формат веб-узел ссылки, когда канал "&#124;" имеется символ в результате строка может принимать одно из следующих:  
  
-   Если приложение находится не в корне.  
  
     \<SiteName>\<ApplicationVirtualPath>&#124;\<ServiceVirtualPath>&#124;\<ServiceName>  
  
-   Если приложение находится в корне.  
  
     \<SiteName>&#124;\<ServiceVirtualPath>&#124;\<ServiceName>  
  
 Для резидентных служб трассировки WCF не заполняют поле «HostReference». В этом образце класс `WCFUserEventProvider` ведет себя согласованно при использовании резидентной службой.  
  
## <a name="custom-event-details"></a>Данные пользовательских событий  
 Манифест поставщика событий ETW WCF определяет три события, которые предназначены для выдачи авторами службы WCF в коде службы. В следующей таблице приведена разбивка этих трех событий.  
  
|событие|Описание|Идентификатор события|  
|-----------|-----------------|--------------|  
|UserDefinedInformationEventOccurred|Это событие выдается, когда в службе происходит что-то примечательное, что не является проблемой. Например, можно выдать событие после успешного вызова базы данных.|301|  
|UserDefinedWarningOccurred|Это событие выдается, когда возникает проблема, которая в будущем может привести к сбою. Например, можно выдавать событие предупреждения, когда вызов базы данных завершается неудачей, но удалось выполнить восстановление, переключившись на резервное хранилище данных.|302|  
|UserDefinedErrorOccurred|Это событие выдается, когда служба не ведет себя, как положено. Например, можно выдавать событие, если вызов базы данных завершается неудачей и данные не удалось получить из другого источника.|303|  
  
#### <a name="to-use-this-sample"></a>Использование этого образца  
  
1. С помощью Visual Studio 2012, откройте файл решения WCFAnalyticTracingExtensibility.sln.  
  
2. Для построения решения нажмите CTRL+SHIFT+B.  
  
3. Чтобы запустить решение, нажмите клавиши CTRL+F5.  
  
     В веб-браузере, щелкните **Calculator.svc**. В браузере должен появиться URI WSDL-документа для службы. Скопируйте этот URI.  
  
4. Запустите тестовый клиент WCF (WcfTestClient.exe).  
  
     Тестовый клиент WCF (WcfTestClient.exe) расположен в `\<Visual Studio 2012 Install Dir>\Common7\IDE\WcfTestClient.exe`. Каталог установки Visual Studio 2012 по умолчанию является `C:\Program Files\Microsoft Visual Studio 10.0`.  
  
5. В тестовом клиенте WCF, добавьте службу, выбрав **файл**, а затем **добавить службу**.  
  
     Добавьте адрес конечной точки в поле ввода.  
  
6. Нажмите кнопку **ОК** чтобы закрыть диалоговое окно.  
  
     Служба ICalculator будет добавлена в области слева в разделе **Мои проекты служб**.  
  
7. Откройте приложение просмотра событий.  
  
     Перед запуском службы запустите средство просмотра событий и убедитесь, что в журнал событий прослушивает событий отслеживания от службы WCF.  
  
8. Из **запустить** меню, выберите **Администрирование**, а затем **средство просмотра событий**. Включить **аналитический** и **Отладка** журналы.  
  
9. В представлении в виде дерева в средстве просмотра событий перейдите к **средство просмотра событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, а затем **Сервер приложений-приложения**. Щелкните правой кнопкой мыши **Application Server-Applications**выберите **представление**, а затем **Отобразить аналитический и отладочный журналы**.  
  
     Убедитесь, что **Отобразить аналитический и отладочный журналы** флажок. Включить **аналитический** журнала.  
  
     В представлении в виде дерева в средстве просмотра событий перейдите к **средство просмотра событий**, **журналы приложений и служб**, **Microsoft**, **Windows**,  **Сервер приложений-приложения**, а затем **аналитической**. Щелкните правой кнопкой мыши **аналитический** и выберите **включить журнал**.  
  
10. Проверьте службу с помощью тестового клиента WCF.  
  
    1.  В тестовом клиенте WCF дважды щелкните **Add()** в узле службы ICalculator.  
  
         **Add()** метод отображается в правой области с двумя параметрами.  
  
    2.  Введите 2 для первого параметра и 3 для второго.  
  
    3.  Нажмите кнопку **Invoke** для вызова метода.  
  
11. Перейдите к **средство просмотра событий** окно, которое уже открыто. Перейдите к **средство просмотра событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, **приложения Серверные приложения**.  
  
12. Щелкните правой кнопкой мыши **аналитический** узел и выберите **обновить**.  
  
     События появятся в области справа.  
  
13. Найдите событие с идентификатором 303 и щелкните его дважды, чтобы открыть его и ознакомиться с его содержимым.  
  
     Это событие было выдано `Add()` метода службы ICalculator и его полезная нагрузка равна «2 + 3 = 5».  
  
#### <a name="to-clean-up-optional"></a>Очистка (необязательно)  
  
1. Откройте **средство просмотра событий**.  
  
2. Перейдите к **средство просмотра событий**, **журналы приложений и служб**, **Microsoft**, **Windows**, а затем  **Application-Server-Applications**. Щелкните правой кнопкой мыши **аналитический** и выберите **отключить журнал**.  
  
3. Перейдите к **средство просмотра событий**, **журналы приложений и служб**, **Microsoft**, **Windows**,  **Application-Server-Applications**, а затем **аналитической**. Щелкните правой кнопкой мыши **аналитический** и выберите **очистить журнал**.  
  
4. Нажмите кнопку **снимите** очистить события.  
  
## <a name="known-issue"></a>Известная проблема  
 Имеется известная проблема в **средство просмотра событий** ошибкой декодирования событий трассировки событий Windows. Может появиться сообщение об ошибке: «Описание идентификатора события \<идентификатор > из источника, не удается найти Microsoft-Windows-Application Server-Applications. Возможно, компонент, вызывающий это событие, не установлен на локальном компьютере, либо установка повреждена. Можно установить или исправить компонент локального компьютера.» Если эта ошибка возникает, выберите **обновить** из **действия** меню. Теперь декодирование события должно выполняться правильно.  
  
> [!IMPORTANT]
>  Образцы уже могут быть установлены на компьютере. Перед продолжением проверьте следующий каталог (по умолчанию).  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  Если этот каталог не существует, перейдите к [Windows Communication Foundation (WCF) и образцы Windows Workflow Foundation (WF) для .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) для загрузки всех Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] примеры. Этот образец расположен в следующем каталоге.  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Basic\Management\ETWTrace`  
  
## <a name="see-also"></a>См. также

- [Образцы наблюдения за AppFabric](https://go.microsoft.com/fwlink/?LinkId=193959)
