---
title: Образец безопасности при обнаружении
ms.date: 03/30/2017
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
ms.openlocfilehash: e956b9f8162d55891233a3ab664b05658d50eeab
ms.sourcegitcommit: 558d78d2a68acd4c95ef23231c8b4e4c7bac3902
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/09/2019
ms.locfileid: "59318407"
---
# <a name="discovery-security-sample"></a>Образец безопасности при обнаружении
В спецификации Discovery не требуется защищенность конечных точек, участвующих в процессе обнаружения. Включение функций безопасности для сообщений обнаружения обеспечивает защиту от атак различного типа (изменение сообщений, отказ в обслуживании, воспроизведение, подделка пакетов). В этом образце реализованы пользовательские каналы, которые вычисляют и проверяют сигнатуры сообщений в компактном формате (описан в разделе 8.2 спецификации WS-Discovery). Образец поддерживает [спецификацию Discovery 2005](https://go.microsoft.com/fwlink/?LinkId=177912) и [версии 1.1](https://go.microsoft.com/fwlink/?LinkId=179677).  
  
 Пользовательские каналы применяются после существующего стека каналов для конечных точек обнаружения и объявления. Таким образом, заголовок сигнатуры применяется к каждому отправляемому сообщению. В получаемых сообщениях проверяется сигнатура, и сообщения, где сигнатура не совпадает или отсутствует, отбрасываются. Для подписания и проверки сообщений в образце применяются сертификаты.  
  
## <a name="discussion"></a>Обсуждение  
 Платформа WCF дает большие возможности для расширения и позволяет пользователям настраивать каналы нужным образом. В образце реализуется элемент защищенной привязки обнаружения, который создает защищенные каналы. В защищенных каналах проверяются сигнатуры сообщений, которые добавляются поверх текущего стека.  
  
 Элемент защищенной привязки создает защищенные фабрики каналов и прослушиватели каналов.  
  
## <a name="secure-channel-factory"></a>Защищенная фабрика каналов  
 Защищенная фабрика каналов создает выходные или дуплексные каналы, которые добавляют в заголовки сообщений компактную сигнатуру. Компактный формат сигнатуры применяется, чтобы сохранить минимальный размер сообщения. В следующем примере показана структура компактной сигнатуры.  
  
```xml  
<d:Security ... >   
  [<d:Sig Scheme="xs:anyURI"   
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"   
          Sig="xs:base64Binary"   
          ... />]?  
  ...   
</d:Security>  
```  
  
> [!NOTE]
>  Элемент `PrefixList` добавлен в версии 2008 протокола Discovery.  
  
 Для вычисления сигнатуры в образце определяются развернутые элементы сигнатуры. Создается XML-сигнатура (`SignedInfo`) с использованием префикса пространства имен `ds` согласно спецификации WS-Discovery. В сигнатуре содержатся ссылки на текст и все заголовки в пространствах имен обнаружения и адресации. Это исключает незаконное изменение заголовков и текста. Каждый упоминаемый элемент преобразуется с помощью исключительной канонизации (http://www.w3.org/2001/10/xml-exc-c14n# ), а затем вычисляется значение хэш-кода SHA-1 (http://www.w3.org/2000/09/xmldsig#sha1 ). Исходя из всех указанных элементов и их значения хэш-кода, подпись значение вычисляется с помощью алгоритма RSA (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).  
  
 Сообщения подписываются сертификатом, указанным клиентом. Место хранения, имя и имя темы сертификата должны указываться при создании элемента привязки. Элемент `KeyId` в компактной сигнатуре представляет идентификатор ключа маркера подписания и служит идентификатором ключа субъекта (SKI) для маркера подписания либо (если SKI не существует) хэшем SHA-1 для открытого ключа маркера подписания.  
  
## <a name="secure-channel-listener"></a>Прослушиватель защищенного канала  
 Прослушиватель защищенного канала создает входные или дуплексные каналы, которые проверяют компактную сигнатуру в полученных сообщениях. В ходе проверки сигнатуры элемент `KeyId`, указанный в компактной сигнатуре, присоединенной к сообщению, используется для выбора сертификата из указанного хранилища. Если в сообщении отсутствует сигнатура или сигнатура не проходит проверку, то сообщение удаляется. Для использования защищенной привязки в образце определяется фабрика, которая создает пользовательские конечные точки <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> и <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> с добавленным элементом защищенной привязки обнаружения. Такие защищенные конечные точки можно использовать в прослушивателях объявлений об обнаружении и службах, поддерживающих обнаружение.  
  
## <a name="sample-details"></a>Подробные сведения об образце  
 В образец входит библиотека и 4 консольных приложения.  
  
-   **DiscoverySecurityChannels**: Библиотека, предоставляет безопасную привязку. Библиотека вычисляет и проверяет компактную сигнатуру для исходящих и входящих сообщений.  
  
-   **Служба**. Доступ к контракту ICalculatorService, резидентной службы. Служба помечена как доступная для обнаружения. Пользователь указывает данные сертификата, используемого для подписания сообщения, указывая место хранения, имя и имя темы или другой уникальный идентификатор сертификата, а также хранилище, где находятся сертификаты клиента (сертификаты, используемые для проверки сигнатуры входящих сообщений). С учетом этих данных создается и используется точка UdpDiscoveryEndpoint с функциями безопасности.  
  
-   **Клиент**: Этот класс выполняет обнаружение ICalculatorService и вызывает методы в службе. Здесь также создается точка <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> с функциями безопасности,которая используется для подписания и проверки сообщений.  
  
-   **AnnouncementListener**: Локальная служба, которая прослушивает объявления сетевой и автономный режим и использует защищенную конечную точку объявления.  
  
> [!NOTE]
>  Если файл Setup.bat запускается несколько раз, то диспетчер сертификатов предлагает выбрать сертификат для использования, поскольку обнаруживается несколько сертификатов. В этом случае следует прервать работу Setup.bat и запустить файл Cleanup.bat, поскольку уже созданы повторяющиеся сертификаты. Cleanup.bat также предлагает выбрать сертификат для удаления. Выберите сертификат из списка и продолжайте выполнение Cleanup.bat, пока не останется ни одного сертификата.  
  
#### <a name="to-use-this-sample"></a>Использование этого образца  
  
1. Запустите скрипт Setup.bat из командной строки разработчика для Visual Studio. Для подписания и проверки сообщений в образце применяются сертификаты. Скрипт создает сертификаты, запуская программу Makecert.exe, а затем устанавливает их, запуская программу Certmgr.exe. Скрипт необходимо запускать с правами администратора.  
  
2. Чтобы построить и запустить образец, откройте файл Security.sln в Visual Studio и выберите **перестроить все**. Обновите свойства решения, чтобы запустить несколько проектов: выберите **запустить** для всех проектов, кроме DiscoverySecureChannels. Запустите решение обычным образом.  
  
3. После завершения работы образца выполните скрипт Cleanup.bat, который удаляет сертификаты, созданные для этого образца.  
  
> [!IMPORTANT]
>  Образцы уже могут быть установлены на компьютере. Перед продолжением проверьте следующий каталог (по умолчанию).  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  Если этот каталог не существует, перейдите к [Windows Communication Foundation (WCF) и образцы Windows Workflow Foundation (WF) для .NET Framework 4](https://go.microsoft.com/fwlink/?LinkId=150780) для загрузки всех Windows Communication Foundation (WCF) и [!INCLUDE[wf1](../../../../includes/wf1-md.md)] примеры. Этот образец расположен в следующем каталоге.  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
