---
title: Фильтры сообщений
ms.date: 03/30/2017
helpviewer_keywords:
- routing [WCF], message filters
ms.assetid: cb33ba49-8b1f-4099-8acb-240404a46d9a
ms.openlocfilehash: fc4656a76894eb3a844bc9f2187847fd9eff0ffe
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61786002"
---
# <a name="message-filters"></a><span data-ttu-id="11a16-102">Фильтры сообщений</span><span class="sxs-lookup"><span data-stu-id="11a16-102">Message Filters</span></span>
<span data-ttu-id="11a16-103">Чтобы обеспечить маршрутизацию на основе содержимого, служба маршрутизации использует реализации класса <xref:System.ServiceModel.Dispatcher.MessageFilter>, которые проверяют такие разделы сообщения, как адрес, имя конечной точки или инструкция XPath.</span><span class="sxs-lookup"><span data-stu-id="11a16-103">To implement content-based routing, the Routing Service uses <xref:System.ServiceModel.Dispatcher.MessageFilter> implementations that inspect specific sections of a message, such as the address, endpoint name, or a specific XPath statement.</span></span> <span data-ttu-id="11a16-104">Если ни один из фильтров, предоставляемых платформой [!INCLUDE[netfx_current_short](../../../../includes/netfx-current-short-md.md)], не подходит, можно создать пользовательский фильтр, написав реализацию базового класса <xref:System.ServiceModel.Dispatcher.MessageFilter>.</span><span class="sxs-lookup"><span data-stu-id="11a16-104">If none of the message filters provided with [!INCLUDE[netfx_current_short](../../../../includes/netfx-current-short-md.md)] meet your needs, you can create a custom filter by creating a new implementation of the base <xref:System.ServiceModel.Dispatcher.MessageFilter> class.</span></span>  
  
 <span data-ttu-id="11a16-105">При настройке службы маршрутизации, необходимо определить элементы фильтра (<xref:System.ServiceModel.Routing.Configuration.FilterElement> объекты), описывающие тип **MessageFilter** и все дополнительные данные, необходимые для создания фильтра, такие как строковые значения для поиска для сообщения.</span><span class="sxs-lookup"><span data-stu-id="11a16-105">When configuring the Routing Service, you must define filter elements (<xref:System.ServiceModel.Routing.Configuration.FilterElement> objects) that describe the type of **MessageFilter** and any supporting data required to create the filter, such as specific string values to search for within the message.</span></span> <span data-ttu-id="11a16-106">Обратите внимание, что создание элементов фильтров подразумевает только создание отдельных фильтров сообщений. Для фильтров, занимающихся вычислением и маршрутизацией сообщений, необходимо также определить таблицу фильтров (<xref:System.ServiceModel.Routing.Configuration.FilterTableEntryCollection>).</span><span class="sxs-lookup"><span data-stu-id="11a16-106">Note that creating the filter elements only defines the individual message filters; to use the filters to evaluate and route messages you must also define a filter table (<xref:System.ServiceModel.Routing.Configuration.FilterTableEntryCollection>).</span></span>  
  
 <span data-ttu-id="11a16-107">Каждая запись в таблице фильтров указывает на элемент фильтра и клиентскую конечную точку, в которую производится перенаправление сообщения при обнаружении соответствия.</span><span class="sxs-lookup"><span data-stu-id="11a16-107">Each entry in the filter table references a filter element and specifies the client endpoint that a message will be routed to if the message matches the filter.</span></span> <span data-ttu-id="11a16-108">В записи таблицы фильтров можно также задать коллекцию резервных конечных точек (<xref:System.ServiceModel.Routing.Configuration.BackupEndpointCollection>), содержащую список конечных точек, в которые сообщение передается в случае возникновения ошибки при отправке сообщения в основную конечную точку.</span><span class="sxs-lookup"><span data-stu-id="11a16-108">The filter table entries also allow you to specify a collection of backup endpoints (<xref:System.ServiceModel.Routing.Configuration.BackupEndpointCollection>), which defines a list of endpoints that the message will be transmitted to in the event of a transmission failure when sending to the primary endpoint.</span></span> <span data-ttu-id="11a16-109">Эти конечные точки перебираются в указанном порядке до тех пор, пока передача сообщения не будет выполнена успешно.</span><span class="sxs-lookup"><span data-stu-id="11a16-109">These endpoints will be tried in the order specified until one succeeds.</span></span>  
  
## <a name="message-filters"></a><span data-ttu-id="11a16-110">Фильтры сообщений</span><span class="sxs-lookup"><span data-stu-id="11a16-110">Message Filters</span></span>  
 <span data-ttu-id="11a16-111">Фильтры сообщений, используемые службой маршрутизации, предоставляют основные функции выделения сообщений, например вычисление имени конечной точки, в которую отправлено сообщение, действие SOAP, а также адрес или префикс адреса, по которому отправлено сообщение.</span><span class="sxs-lookup"><span data-stu-id="11a16-111">The message filters used by the Routing Service provide common message selection functionality, such as evaluating the name of the endpoint that a message was sent to, the SOAP action, or the address or address prefix that the message was sent to.</span></span> <span data-ttu-id="11a16-112">Фильтры могут быть объединены по условию `AND`, то есть сообщение будет передано в конечную точку только в случае, если выполняются оба условия.</span><span class="sxs-lookup"><span data-stu-id="11a16-112">Filters can also be joined with an `AND` condition, so that messages will only be routed to an endpoint if the message matches both filters.</span></span> <span data-ttu-id="11a16-113">Можно создать пользовательский фильтр, создав новую реализацию класса <xref:System.ServiceModel.Dispatcher.MessageFilter>.</span><span class="sxs-lookup"><span data-stu-id="11a16-113">You can also create custom filters by creating your own implementation of <xref:System.ServiceModel.Dispatcher.MessageFilter>.</span></span>  
  
 <span data-ttu-id="11a16-114">В следующей таблице приведены значения <xref:System.ServiceModel.Routing.Configuration.FilterType>, используемые службой маршрутизации, классы, реализующие соответствующие фильтры сообщений, а также обязательные параметры <xref:System.ServiceModel.Routing.Configuration.FilterElement.FilterData%2A>.</span><span class="sxs-lookup"><span data-stu-id="11a16-114">The following table lists the <xref:System.ServiceModel.Routing.Configuration.FilterType> used by the Routing Service, the class that implements the specific message filter, and the required <xref:System.ServiceModel.Routing.Configuration.FilterElement.FilterData%2A> parameters.</span></span>  
  
|<span data-ttu-id="11a16-115">Тип фильтра</span><span class="sxs-lookup"><span data-stu-id="11a16-115">Filter  Type</span></span>|<span data-ttu-id="11a16-116">Описание</span><span class="sxs-lookup"><span data-stu-id="11a16-116">Description</span></span>|<span data-ttu-id="11a16-117">Значение данных фильтра</span><span class="sxs-lookup"><span data-stu-id="11a16-117">Filter Data Meaning</span></span>|<span data-ttu-id="11a16-118">Пример фильтра</span><span class="sxs-lookup"><span data-stu-id="11a16-118">Example Filter</span></span>|  
|------------------|-----------------|-------------------------|--------------------|  
|<span data-ttu-id="11a16-119">Действие</span><span class="sxs-lookup"><span data-stu-id="11a16-119">Action</span></span>|<span data-ttu-id="11a16-120">Использует класс <xref:System.ServiceModel.Dispatcher.ActionMessageFilter> для поиска сообщений, содержащих определенное действие.</span><span class="sxs-lookup"><span data-stu-id="11a16-120">Uses the <xref:System.ServiceModel.Dispatcher.ActionMessageFilter> class to match messages containing a specific action.</span></span>|<span data-ttu-id="11a16-121">Действие, по которому производится фильтрация.</span><span class="sxs-lookup"><span data-stu-id="11a16-121">The action to filter upon.</span></span>|<span data-ttu-id="11a16-122">\<filter name="action1" filterType="Action" filterData="http://namespace/contract/operation" /></span><span class="sxs-lookup"><span data-stu-id="11a16-122">\<filter name="action1" filterType="Action" filterData="http://namespace/contract/operation" /></span></span>|  
|<span data-ttu-id="11a16-123">EndpointAddress</span><span class="sxs-lookup"><span data-stu-id="11a16-123">EndpointAddress</span></span>|<span data-ttu-id="11a16-124">Использует <xref:System.ServiceModel.Dispatcher.EndpointAddressMessageFilter> класса, с помощью <xref:System.ServiceModel.Dispatcher.EndpointAddressMessageFilter.IncludeHostNameInComparison%2A>  ==  `true` для поиска сообщений, содержащих определенный адрес.</span><span class="sxs-lookup"><span data-stu-id="11a16-124">Uses the <xref:System.ServiceModel.Dispatcher.EndpointAddressMessageFilter> class, with <xref:System.ServiceModel.Dispatcher.EndpointAddressMessageFilter.IncludeHostNameInComparison%2A> == `true` to match messages containing a specific address.</span></span>|<span data-ttu-id="11a16-125">Адрес, по которому будет выполняться фильтрация (в поле «Кому»).</span><span class="sxs-lookup"><span data-stu-id="11a16-125">The address to filter upon (in the To header).</span></span>|<span data-ttu-id="11a16-126">\<filter name="address1" filterType="EndpointAddress" filterData="http://host/vdir/s.svc/b"  /></span><span class="sxs-lookup"><span data-stu-id="11a16-126">\<filter name="address1" filterType="EndpointAddress" filterData="http://host/vdir/s.svc/b"  /></span></span>|  
|<span data-ttu-id="11a16-127">EndpointAddressPrefix</span><span class="sxs-lookup"><span data-stu-id="11a16-127">EndpointAddressPrefix</span></span>|<span data-ttu-id="11a16-128">Использует <xref:System.ServiceModel.Dispatcher.PrefixEndpointAddressMessageFilter> класса, с помощью <xref:System.ServiceModel.Dispatcher.PrefixEndpointAddressMessageFilter.IncludeHostNameInComparison%2A>  ==  `true` для поиска сообщений, содержащих определенный префикс адреса.</span><span class="sxs-lookup"><span data-stu-id="11a16-128">Uses the <xref:System.ServiceModel.Dispatcher.PrefixEndpointAddressMessageFilter> class, with <xref:System.ServiceModel.Dispatcher.PrefixEndpointAddressMessageFilter.IncludeHostNameInComparison%2A> == `true` to match messages containing a specific address prefix.</span></span>|<span data-ttu-id="11a16-129">Адрес, по которому будет выполняться фильтрация с использованием самого длинного совпадающего префикса.</span><span class="sxs-lookup"><span data-stu-id="11a16-129">The address to filter upon using longest prefix matching.</span></span>|<span data-ttu-id="11a16-130">\<filter name="prefix1" filterType="EndpointAddressPrefix" filterData="http://host/" /></span><span class="sxs-lookup"><span data-stu-id="11a16-130">\<filter name="prefix1" filterType="EndpointAddressPrefix" filterData="http://host/" /></span></span>|  
|<span data-ttu-id="11a16-131">и</span><span class="sxs-lookup"><span data-stu-id="11a16-131">And</span></span>|<span data-ttu-id="11a16-132">Использует класс <xref:System.ServiceModel.Dispatcher.StrictAndMessageFilter>, который всегда проверяет оба условия перед возвратом результата.</span><span class="sxs-lookup"><span data-stu-id="11a16-132">Uses the <xref:System.ServiceModel.Dispatcher.StrictAndMessageFilter> class that always evaluates both conditions before returning.</span></span>|<span data-ttu-id="11a16-133">параметр filterData не используется; Вместо этого filter1 и filter2 содержат имена соответствующих фильтров сообщений (также в таблице), которые должны быть **AND**ed вместе.</span><span class="sxs-lookup"><span data-stu-id="11a16-133">filterData is not used; instead filter1 and filter2 have the names of the corresponding message filters (also in the table), which should be **AND**ed together.</span></span>|<span data-ttu-id="11a16-134">\<filter name="and1" filterType="And" filter1="address1" filter2="action1" /></span><span class="sxs-lookup"><span data-stu-id="11a16-134">\<filter name="and1" filterType="And" filter1="address1" filter2="action1" /></span></span>|  
|<span data-ttu-id="11a16-135">Другой</span><span class="sxs-lookup"><span data-stu-id="11a16-135">Custom</span></span>|<span data-ttu-id="11a16-136">Определяемый пользователем тип, который расширяет класс <xref:System.ServiceModel.Dispatcher.MessageFilter> и имеет конструктор, принимающий строку.</span><span class="sxs-lookup"><span data-stu-id="11a16-136">A user-defined type that extends the <xref:System.ServiceModel.Dispatcher.MessageFilter> class and has a constructor taking a string.</span></span>|<span data-ttu-id="11a16-137">Атрибут customType является полным именем типа для создаваемого класса. Параметр filterData - строка, передаваемая конструктору при создании фильтра.</span><span class="sxs-lookup"><span data-stu-id="11a16-137">The customType attribute is the fully qualified type name of the class to create; filterData is the string to pass to the constructor when creating the filter.</span></span>|<span data-ttu-id="11a16-138">\<filter name="custom1" filterType="Custom" customType="CustomAssembly.CustomMsgFilter, CustomAssembly" filterData="Custom Data" /></span><span class="sxs-lookup"><span data-stu-id="11a16-138">\<filter name="custom1" filterType="Custom" customType="CustomAssembly.CustomMsgFilter, CustomAssembly" filterData="Custom Data" /></span></span>|  
|<span data-ttu-id="11a16-139">EndpointName</span><span class="sxs-lookup"><span data-stu-id="11a16-139">EndpointName</span></span>|<span data-ttu-id="11a16-140">Использует класс <xref:System.ServiceModel.Dispatcher.EndpointNameMessageFilter> для поиска сообщений на основе имени конечной точки службы, в которую они поступили.</span><span class="sxs-lookup"><span data-stu-id="11a16-140">Uses the <xref:System.ServiceModel.Dispatcher.EndpointNameMessageFilter> class to match messages based on the name of the service endpoint they arrived on.</span></span>|<span data-ttu-id="11a16-141">Имя конечной точки службы, например: «serviceEndpoint1».</span><span class="sxs-lookup"><span data-stu-id="11a16-141">The name of the service endpoint, for example: "serviceEndpoint1".</span></span>  <span data-ttu-id="11a16-142">Это должна быть одна из конечных точек, представленных в службе Routing Service.</span><span class="sxs-lookup"><span data-stu-id="11a16-142">This should be one of the endpoints exposed on the Routing Service.</span></span>|<span data-ttu-id="11a16-143">\<filter name="stock1" filterType="Endpoint" filterData="SvcEndpoint" /></span><span class="sxs-lookup"><span data-stu-id="11a16-143">\<filter name="stock1" filterType="Endpoint" filterData="SvcEndpoint" /></span></span>|  
|<span data-ttu-id="11a16-144">MatchAll</span><span class="sxs-lookup"><span data-stu-id="11a16-144">MatchAll</span></span>|<span data-ttu-id="11a16-145">Использует класс <xref:System.ServiceModel.Dispatcher.MatchAllMessageFilter>.</span><span class="sxs-lookup"><span data-stu-id="11a16-145">Uses the <xref:System.ServiceModel.Dispatcher.MatchAllMessageFilter> class.</span></span> <span data-ttu-id="11a16-146">Этот фильтр находит все поступившие сообщения.</span><span class="sxs-lookup"><span data-stu-id="11a16-146">This filter matches all arriving messages.</span></span>|<span data-ttu-id="11a16-147">Параметр filterData не используется.</span><span class="sxs-lookup"><span data-stu-id="11a16-147">filterData is not used.</span></span> <span data-ttu-id="11a16-148">Этот фильтр всегда находит все поступившие сообщения.</span><span class="sxs-lookup"><span data-stu-id="11a16-148">This filter will always match all messages.</span></span>|<span data-ttu-id="11a16-149">\<filter name="matchAll1" filterType="MatchAll" /></span><span class="sxs-lookup"><span data-stu-id="11a16-149">\<filter name="matchAll1" filterType="MatchAll" /></span></span>|  
|<span data-ttu-id="11a16-150">XPath</span><span class="sxs-lookup"><span data-stu-id="11a16-150">XPath</span></span>|<span data-ttu-id="11a16-151">Использует класс <xref:System.ServiceModel.Dispatcher.XPathMessageFilter> для поиска сообщений по запросу XPath.</span><span class="sxs-lookup"><span data-stu-id="11a16-151">Uses the <xref:System.ServiceModel.Dispatcher.XPathMessageFilter> class to match specific XPath queries within the message.</span></span>|<span data-ttu-id="11a16-152">Запрос XPath, используемый при сопоставлении сообщений.</span><span class="sxs-lookup"><span data-stu-id="11a16-152">The XPath query to use when matching messages.</span></span>|<span data-ttu-id="11a16-153">\<filter name="XPath1" filterType="XPath" filterData="//ns:element" /></span><span class="sxs-lookup"><span data-stu-id="11a16-153">\<filter name="XPath1" filterType="XPath" filterData="//ns:element" /></span></span>|  
  
 <span data-ttu-id="11a16-154">В следующем примере определяются записи фильтра, использующие фильтры сообщений XPath, EndpointName и PrefixEndpointAddress.</span><span class="sxs-lookup"><span data-stu-id="11a16-154">The following example defines filter entries that use the XPath, EndpointName, and PrefixEndpointAddress message filters.</span></span> <span data-ttu-id="11a16-155">В этом примере также показано применение пользовательского фильтра для записей RoundRobinFilter1 и RoundRobinFilter2.</span><span class="sxs-lookup"><span data-stu-id="11a16-155">This example also demonstrates using a custom filter for the RoundRobinFilter1 and RoundRobinFilter2 entries.</span></span>  
  
```xml  
<filters>  
     <filter name="XPathFilter" filterType="XPath"   
             filterData="/s12:Envelope/s12:Header/custom:RoundingCalculator = 1"/>  
     <filter name="EndpointNameFilter" filterType="EndpointName"   
             filterData="calculatorEndpoint"/>  
     <filter name="PrefixAddressFilter" filterType="PrefixEndpointAddress"   
             filterData="http://localhost/routingservice/router/rounding/"/>  
     <filter name="RoundRobinFilter1" filterType="Custom"   
             customType="RoutingServiceFilters.RoundRobinMessageFilter,   
             RoutingService" filterData="group1"/>  
     <filter name="RoundRobinFilter2" filterType="Custom"   
             customType="RoutingServiceFilters.RoundRobinMessageFilter,   
             RoutingService" filterData="group1"/>  
</filters>  
```  
  
> [!NOTE]
>  <span data-ttu-id="11a16-156">Простого определения фильтра недостаточно для того, чтобы он использовался для поиска сообщений.</span><span class="sxs-lookup"><span data-stu-id="11a16-156">Simply defining a filter does not cause messages to be evaluated against the filter.</span></span> <span data-ttu-id="11a16-157">Фильтр необходимо добавить в таблицу фильтров, которая связана с конечной точкой службы, доступной службе маршрутизации.</span><span class="sxs-lookup"><span data-stu-id="11a16-157">The filter must be added to a filter table, which is then associated with the service endpoint exposed by the Routing Service.</span></span>  
  
### <a name="namespace-table"></a><span data-ttu-id="11a16-158">Таблица пространств имен</span><span class="sxs-lookup"><span data-stu-id="11a16-158">Namespace Table</span></span>  
 <span data-ttu-id="11a16-159">При использовании фильтра XPath размер данных фильтра, содержащих запрос XPath, может оказаться весьма большим из-за использования пространств имен.</span><span class="sxs-lookup"><span data-stu-id="11a16-159">When using an XPath filter, the filter data that contains the XPath query can become extremely large due to the use of namespaces.</span></span> <span data-ttu-id="11a16-160">Чтобы избежать этого, служба маршрутизации предусматривает возможность определения собственных префиксов с помощью таблицы пространств имен.</span><span class="sxs-lookup"><span data-stu-id="11a16-160">To alleviate this problem the Routing Service provides the ability to define your own namespace prefixes by using the namespace table.</span></span>  
  
 <span data-ttu-id="11a16-161">Эта таблица представляет собой коллекцию объектов <xref:System.ServiceModel.Routing.Configuration.NamespaceElement>, в которой определены префиксы часто используемых пространств имен, которые могут быть использованы в XPath.</span><span class="sxs-lookup"><span data-stu-id="11a16-161">The namespace table is a collection of <xref:System.ServiceModel.Routing.Configuration.NamespaceElement> objects that defines the namespace prefixes for common namespaces that can be used in an XPath.</span></span> <span data-ttu-id="11a16-162">Ниже приведены пространства имен по умолчанию и их префиксы, содержащиеся в таблице пространств имен.</span><span class="sxs-lookup"><span data-stu-id="11a16-162">The following are the default namespaces and namespace prefixes that are contained in the namespace table.</span></span>  
  
|<span data-ttu-id="11a16-163">Префикс</span><span class="sxs-lookup"><span data-stu-id="11a16-163">Prefix</span></span>|<span data-ttu-id="11a16-164">Пространство имен</span><span class="sxs-lookup"><span data-stu-id="11a16-164">Namespace</span></span>|  
|------------|---------------|  
|<span data-ttu-id="11a16-165">s11</span><span class="sxs-lookup"><span data-stu-id="11a16-165">s11</span></span>|`http://schemas.xmlsoap.org/soap/envelope`|  
|<span data-ttu-id="11a16-166">s12</span><span class="sxs-lookup"><span data-stu-id="11a16-166">s12</span></span>|`http://www.w3.org/2003/05/soap-envelope`|  
|<span data-ttu-id="11a16-167">wsaAugust2004</span><span class="sxs-lookup"><span data-stu-id="11a16-167">wsaAugust2004</span></span>|`http://schemas.xmlsoap.org/ws/2004/08/addressing`|  
|<span data-ttu-id="11a16-168">wsa10</span><span class="sxs-lookup"><span data-stu-id="11a16-168">wsa10</span></span>|`http://www.w3.org/2005/08/addressing`|  
|<span data-ttu-id="11a16-169">sm</span><span class="sxs-lookup"><span data-stu-id="11a16-169">sm</span></span>|`http://schemas.microsoft.com/serviceModel/2004/05/xpathfunctions`|  
|<span data-ttu-id="11a16-170">tempuri</span><span class="sxs-lookup"><span data-stu-id="11a16-170">tempuri</span></span>|`http://tempuri.org`|  
|<span data-ttu-id="11a16-171">ser</span><span class="sxs-lookup"><span data-stu-id="11a16-171">ser</span></span>|`http://schemas.microsoft.com/2003/10/Serialization`|  
  
 <span data-ttu-id="11a16-172">Если известны пространства имен, которые будут использоваться в запросах XPath, их можно добавить в таблицу пространств имен вместе с уникальными префиксами, которые затем можно использовать в запросах XPath вместо полных пространств имен.</span><span class="sxs-lookup"><span data-stu-id="11a16-172">When you know that you will be using a specific namespace in your XPath queries, you can add it to the namespace table along with a unique namespace prefix and use the prefix in any XPath query instead of the full namespace.</span></span> <span data-ttu-id="11a16-173">В следующем примере определяется префикс «custom» для пространства имен `"http://my.custom.namespace"`, который затем используется в запросе XPath, содержащемся в filterData.</span><span class="sxs-lookup"><span data-stu-id="11a16-173">The following example defines a prefix of "custom" for the namespace `"http://my.custom.namespace"`, which is then used in the XPath query contained in filterData.</span></span>  
  
```xml  
<namespaceTable>  
     <add prefix="custom" namespace="http://my.custom.namespace/"/>  
</namespaceTable>  
<filters>  
     <filter name="XPathFilter" filterType="XPath" filterData="/s12:Envelope/s12:Header/custom:RoundingCalculator = 1"/>  
</filters>  
```  
  
## <a name="filter-tables"></a><span data-ttu-id="11a16-174">Таблицы фильтров</span><span class="sxs-lookup"><span data-stu-id="11a16-174">Filter Tables</span></span>  
 <span data-ttu-id="11a16-175">Поскольку каждый элемент фильтра определяет логическое сравнение, которое может быть применено к сообщению, таблица фильтров обеспечивает сопоставление между элементом фильтра и целевой клиентской конечной точкой.</span><span class="sxs-lookup"><span data-stu-id="11a16-175">While each filter element defines a logical comparison that can be applied to a message, the filter table provides the association between the filter element and the destination client endpoint.</span></span> <span data-ttu-id="11a16-176">Таблица фильтров является именованной коллекцией объектов <xref:System.ServiceModel.Routing.Configuration.FilterTableEntryElement>, определяющих сопоставление между фильтром, основной целевой конечной точкой и списком альтернативных резервных конечных точек.</span><span class="sxs-lookup"><span data-stu-id="11a16-176">A filter table is a named collection of <xref:System.ServiceModel.Routing.Configuration.FilterTableEntryElement> objects that define the association between a filter, a primary destination endpoint, and a list of alternative backup endpoints.</span></span> <span data-ttu-id="11a16-177">Записи таблицы фильтров также позволяют указывать необязательные приоритеты для каждого из условий фильтрации.</span><span class="sxs-lookup"><span data-stu-id="11a16-177">The filter table entries also allow you to specify an optional priority for each filter condition.</span></span> <span data-ttu-id="11a16-178">В следующем примере определяются два фильтра, а затем определяется таблица фильтров, которая сопоставляет каждый из фильтров с целевой конечной точкой.</span><span class="sxs-lookup"><span data-stu-id="11a16-178">The following example defines two filters and then defines a filter table that associates each filter with a destination endpoint.</span></span>  
  
```xml  
<routing>  
     <filters>  
       <filter name="AddAction" filterType="Action" filterData="Add" />  
       <filter name="SubtractAction" filterType="Action" filterData="Subtract" />  
     </filters>  
     <filterTables>  
       <table name="routingTable1">  
         <filters>  
           <add filterName="AddAction" endpointName="Addition" />  
           <add filterName="SubtractAction" endpointName="Subtraction" />  
         </filters>  
       </table>  
     </filterTables>      
</routing>  
```  
  
### <a name="filter-evaluation-priority"></a><span data-ttu-id="11a16-179">Приоритет вычисления фильтров</span><span class="sxs-lookup"><span data-stu-id="11a16-179">Filter Evaluation Priority</span></span>  
 <span data-ttu-id="11a16-180">По умолчанию все записи таблицы фильтров вычисляются одновременно. После этого производится передача сообщения в конечные точки, сопоставленные с каждой совпадающей записью фильтра.</span><span class="sxs-lookup"><span data-stu-id="11a16-180">By default, all entries in the filter table are evaluated simultaneously, and the message being evaluated is routed to the endpoint(s) associated with each matching filter entry.</span></span> <span data-ttu-id="11a16-181">Если сразу несколько фильтров вернули значение `true`, а сообщение является односторонним или дуплексным, оно передается в конечные точки, соответствующие всем этим фильтрам.</span><span class="sxs-lookup"><span data-stu-id="11a16-181">If multiple filters evaluate to `true`, and the message is one-way or duplex, the message is multicast to the endpoints for all matching filters.</span></span> <span data-ttu-id="11a16-182">Сообщения типа «запрос-ответ» не могут быть переданы нескольким конечным точкам, поскольку клиенту должен быть возвращен всего один ответ.</span><span class="sxs-lookup"><span data-stu-id="11a16-182">Request-reply messages cannot be multicast because only one reply can be returned to the client.</span></span>  
  
 <span data-ttu-id="11a16-183">Более сложную логику маршрутизации можно реализовать, задав приоритеты для каждого из фильтров. Первым делом служба маршрутизации будет отрабатывать все фильтры, имеющие наивысший уровень приоритета.</span><span class="sxs-lookup"><span data-stu-id="11a16-183">More complex routing logic can be implemented by specifying priority levels for each filter; the Routing Service evaluates all filters at the highest priority level first.</span></span> <span data-ttu-id="11a16-184">Если сообщение соответствует фильтру этого уровня, то фильтры более низких уровней не вычисляются.</span><span class="sxs-lookup"><span data-stu-id="11a16-184">If a message matches a filter of this level, no filters of a lower priority are processed.</span></span> <span data-ttu-id="11a16-185">Например, поступившее одностороннее сообщение сначала вычисляется по всем фильтрам с приоритетом 2.</span><span class="sxs-lookup"><span data-stu-id="11a16-185">For example, an incoming one-way message is first evaluated against all filters with a priority of 2.</span></span> <span data-ttu-id="11a16-186">Ни одному из фильтров этого уровня сообщение не соответствует, поэтому далее сообщение проверяется по фильтрам уровня 1.</span><span class="sxs-lookup"><span data-stu-id="11a16-186">The message does not match any filter at this priority level, so next the message is compared against filters with a priority of 1.</span></span> <span data-ttu-id="11a16-187">Сообщение соответствует двум фильтрам с приоритетом 1, и, поскольку это однонаправленное сообщение, оно будет направлено в обе целевые конечные точки.</span><span class="sxs-lookup"><span data-stu-id="11a16-187">Two priority 1 filters match the message, and because it is a one-way message it is routed to both destination endpoints.</span></span>  <span data-ttu-id="11a16-188">Поскольку найдено соответствие с фильтрами с приоритетом 1, вычисление фильтров уровня 0 не производится.</span><span class="sxs-lookup"><span data-stu-id="11a16-188">Because a match was found among the priority 1 filters, no filters of priority 0 are evaluated.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="11a16-189">Если приоритеты не заданы, то используется уровень 0.</span><span class="sxs-lookup"><span data-stu-id="11a16-189">If no priority is specified, the default priority of 0 is used.</span></span>  
  
 <span data-ttu-id="11a16-190">В следующем примере определена таблица фильтров, в которой для фильтров заданы приоритеты 2, 1 и 0.</span><span class="sxs-lookup"><span data-stu-id="11a16-190">The following example defines a filter table that specifies priorities of 2, 1, and 0 for the filters referenced in the table.</span></span>  
  
```xml  
<filterTables>  
     <filterTable name="filterTable1">  
          <add filterName="XPathFilter" endpointName="roundingCalcEndpoint"   
               priority="2"/>  
          <add filterName="EndpointNameFilter" endpointName="regularCalcEndpoint"   
               priority="1"/>  
          <add filterName="PrefixAddressFilter" endpointName="roundingCalcEndpoint"   
               priority="1"/>  
          <add filterName="MatchAllMessageFilter" endpointName="defaultCalcEndpoint"   
               priority="0"/>  
     </filterTable>  
</filterTables>  
```  
  
 <span data-ttu-id="11a16-191">В предыдущем примере, если сообщение соответствует фильтру XPathFilter, то оно будет перенаправлено в конечную точку roundingCalcEndpoint, а все остальные фильтры в таблице не будут вычисляться, поскольку имеют более низкий уровень приоритета.</span><span class="sxs-lookup"><span data-stu-id="11a16-191">In the preceding example, if a message matches the XPathFilter, it will be routed to the roundingCalcEndpoint and no further filters in the table will be evaluated because all other filters are of a lower priority.</span></span> <span data-ttu-id="11a16-192">Однако, если сообщение не соответствует фильтру XPathFilter, будет производиться его вычисление на соответствие всем фильтрам следующего уровня - EndpointNameFilter и PrefixAddressFilter.</span><span class="sxs-lookup"><span data-stu-id="11a16-192">However, if the message does not match the XPathFilter it will then be evaluated against all filters of the next lower priority, EndpointNameFilter and PrefixAddressFilter.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="11a16-193">По возможности используйте монопольные фильтры вместо указания приоритетов, поскольку это может отрицательно сказаться на производительности.</span><span class="sxs-lookup"><span data-stu-id="11a16-193">When possible, use exclusive filters instead of specifying a priority because priority evaluation can result in performance degradation.</span></span>  
  
### <a name="backup-lists"></a><span data-ttu-id="11a16-194">Резервные списки</span><span class="sxs-lookup"><span data-stu-id="11a16-194">Backup Lists</span></span>  
 <span data-ttu-id="11a16-195">Для каждого фильтра в таблице фильтров может быть указан резервный список, который представляет собой именованную коллекцию конечных точек (<xref:System.ServiceModel.Routing.Configuration.BackupEndpointCollection>).</span><span class="sxs-lookup"><span data-stu-id="11a16-195">Each filter in the filter table can optionally specify a backup list, which is a named collection of endpoints (<xref:System.ServiceModel.Routing.Configuration.BackupEndpointCollection>).</span></span> <span data-ttu-id="11a16-196">В этой коллекции содержится упорядоченный список конечных точек, в которые будет передано сообщение в случае возникновении события <xref:System.ServiceModel.CommunicationException> при его отправке в основную конечную точку, указанную в параметре <xref:System.ServiceModel.Routing.Configuration.FilterTableEntryElement.EndpointName%2A>.</span><span class="sxs-lookup"><span data-stu-id="11a16-196">This collection contains an ordered list of endpoints that the message will be transmitted to in the event of a <xref:System.ServiceModel.CommunicationException> when sending to the primary endpoint specified in <xref:System.ServiceModel.Routing.Configuration.FilterTableEntryElement.EndpointName%2A>.</span></span> <span data-ttu-id="11a16-197">В следующем примере определяется резервный список с именем «backupServiceEndpoints», который содержит две конечные точки.</span><span class="sxs-lookup"><span data-stu-id="11a16-197">The following example defines a backup list named "backupServiceEndpoints" that contains two endpoints.</span></span>  
  
```xml  
<filterTables>  
     <filterTable name="filterTable1">  
          <add filterName="MatchAllFilter1" endpointName="Destination" backupList="backupEndpointList"/>  
     </filterTable>  
</filterTables>  
<backupLists>  
     <backupList name="backupEndpointList">  
          <add endpointName="backupServiceQueue" />  
          <add endpointName="alternateServiceQueue" />  
     </backupList>  
</backupLists>  
```  
  
 <span data-ttu-id="11a16-198">В приведенном выше примере отправка в основную конечную точку «Destination» в случае сбоя служба маршрутизации попытается повторить отправку каждой конечной точки в последовательности, они перечислены, отправляя в backupServiceQueue и впоследствии отправки в alternateServiceQueue, если не удается отправить в backupServiceQueue.</span><span class="sxs-lookup"><span data-stu-id="11a16-198">In the preceding example, if a send to the primary endpoint "Destination" fails, the Routing Service will try sending to each endpoint in the sequence they are listed, first sending to backupServiceQueue and subsequently sending to alternateServiceQueue if the send to backupServiceQueue fails.</span></span> <span data-ttu-id="11a16-199">Если отправка сообщения завершилась ошибкой для всех конечных точек, возвращается ошибка.</span><span class="sxs-lookup"><span data-stu-id="11a16-199">If all backup endpoints fail, a fault is returned.</span></span>
