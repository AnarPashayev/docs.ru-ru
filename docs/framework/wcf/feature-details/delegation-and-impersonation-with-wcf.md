---
title: Делегирование и олицетворение с использованием WCF
description: Узнайте о методах олицетворения и делегирования, которые использует WCF для ограничения клиентского доступа к ресурсам домена службы.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- impersonation [WCF]
- delegation [WCF]
ms.assetid: 110e60f7-5b03-4b69-b667-31721b8e3152
ms.openlocfilehash: 91e7ea8df5c32329f0eb8d12943ce5f816ff0e5a
ms.sourcegitcommit: 27a15a55019f6b5f2733961738babe94aec0def3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/15/2020
ms.locfileid: "90557597"
---
# <a name="delegation-and-impersonation-with-wcf"></a><span data-ttu-id="814b0-103">Делегирование и олицетворение с использованием WCF</span><span class="sxs-lookup"><span data-stu-id="814b0-103">Delegation and Impersonation with WCF</span></span>
<span data-ttu-id="814b0-104">*Олицетворение* - это стандартная техника, которую службы используют для ограничения клиентского доступа к ресурсам домена службы.</span><span class="sxs-lookup"><span data-stu-id="814b0-104">*Impersonation* is a common technique that services use to restrict client access to a service domain's resources.</span></span> <span data-ttu-id="814b0-105">В роли ресурсов домена службы могут выступать ресурсы компьютера, например локальные файлы (олицетворение), или ресурсы, расположенные на другом компьютере, например общая папка (делегирование).</span><span class="sxs-lookup"><span data-stu-id="814b0-105">Service domain resources can either be machine resources, such as local files (impersonation), or a resource on another machine, such as a file share (delegation).</span></span> <span data-ttu-id="814b0-106">Пример приложения см. в разделе [Impersonating the Client](../samples/impersonating-the-client.md).</span><span class="sxs-lookup"><span data-stu-id="814b0-106">For a sample application, see [Impersonating the Client](../samples/impersonating-the-client.md).</span></span> <span data-ttu-id="814b0-107">Пример использования олицетворения см. в разделе [How to: Impersonate a Client on a Service](../how-to-impersonate-a-client-on-a-service.md).</span><span class="sxs-lookup"><span data-stu-id="814b0-107">For an example of how to use impersonation, see [How to: Impersonate a Client on a Service](../how-to-impersonate-a-client-on-a-service.md).</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="814b0-108">Следует иметь в виду, что при олицетворении клиента в службе служба выполняется с учетными данными клиента, которые могут иметь более высокий уровень разрешений, чем серверный процесс.</span><span class="sxs-lookup"><span data-stu-id="814b0-108">Be aware that when impersonating a client on a service, the service runs with the client's credentials, which may have higher privileges than the server process.</span></span>  
  
## <a name="overview"></a><span data-ttu-id="814b0-109">Обзор</span><span class="sxs-lookup"><span data-stu-id="814b0-109">Overview</span></span>  
 <span data-ttu-id="814b0-110">Обычно клиенты вызывают службы, чтобы платформа службы выполнила какие-либо действия от имени клиента.</span><span class="sxs-lookup"><span data-stu-id="814b0-110">Typically, clients call a service to have the service perform some action on the client’s behalf.</span></span> <span data-ttu-id="814b0-111">Олицетворение позволяет службе выступать в качестве клиента при выполнении такого действия.</span><span class="sxs-lookup"><span data-stu-id="814b0-111">Impersonation allows the service to act as the client while performing the action.</span></span> <span data-ttu-id="814b0-112">Делегирование позволяет внешней службе перенаправить запрос клиента внутренней службе таким образом, чтобы внутренняя служба также могла олицетворять клиент.</span><span class="sxs-lookup"><span data-stu-id="814b0-112">Delegation allows a front-end service to forward the client’s request to a back-end service in such a way that the back-end service can also impersonate the client.</span></span> <span data-ttu-id="814b0-113">Олицетворение чаще всего используется, чтобы проверить, имеет ли клиент разрешение на выполнение определенного действия, а делегирование позволяет передать возможности олицетворения, в том числе удостоверение клиента, внутренней службе.</span><span class="sxs-lookup"><span data-stu-id="814b0-113">Impersonation is most commonly used as a way of checking whether a client is authorized to perform a particular action, while delegation is a way of flowing impersonation capabilities, along with the client’s identity, to a back-end service.</span></span> <span data-ttu-id="814b0-114">Делегирование - это функция домена Windows, которую можно использовать при проверке подлинности Kerberos.</span><span class="sxs-lookup"><span data-stu-id="814b0-114">Delegation is a Windows domain feature that can be used when Kerberos-based authentication is performed.</span></span> <span data-ttu-id="814b0-115">Делегирование отличается от потока работы с удостоверениями, а поскольку делегирование позволяет олицетворять клиент даже при отсутствии пароля клиента, эта операция обладает гораздо более широкими правами.</span><span class="sxs-lookup"><span data-stu-id="814b0-115">Delegation is distinct from identity flow and, because delegation transfers the ability to impersonate the client without possession of the client’s password, it is a much higher privileged operation than identity flow.</span></span>  
  
 <span data-ttu-id="814b0-116">Для олицетворения и делегирования у клиента должно быть удостоверение Windows.</span><span class="sxs-lookup"><span data-stu-id="814b0-116">Both impersonation and delegation require that the client have a Windows identity.</span></span> <span data-ttu-id="814b0-117">Если у клиента нет удостоверения Windows, единственным решением является передача удостоверения клиента второй службе.</span><span class="sxs-lookup"><span data-stu-id="814b0-117">If a client does not possess a Windows identity, then the only option available is to flow the client’s identity to the second service.</span></span>  
  
## <a name="impersonation-basics"></a><span data-ttu-id="814b0-118">Основные принципы олицетворения</span><span class="sxs-lookup"><span data-stu-id="814b0-118">Impersonation Basics</span></span>  
 <span data-ttu-id="814b0-119">Windows Communication Foundation (WCF) поддерживает олицетворение для различных клиентских учетных данных.</span><span class="sxs-lookup"><span data-stu-id="814b0-119">Windows Communication Foundation (WCF) supports impersonation for a variety of client credentials.</span></span> <span data-ttu-id="814b0-120">В этом разделе описана поддержка модели служб для олицетворения вызывающего объекта во время реализации метода службы.</span><span class="sxs-lookup"><span data-stu-id="814b0-120">This topic describes service model support for impersonating the caller during the implementation of a service method.</span></span> <span data-ttu-id="814b0-121">Также рассматриваются распространенные сценарии развертывания, включающие олицетворение и параметры безопасности SOAP и WCF в этих сценариях.</span><span class="sxs-lookup"><span data-stu-id="814b0-121">Also discussed are common deployment scenarios involving impersonation and SOAP security and WCF options in these scenarios.</span></span>  
  
 <span data-ttu-id="814b0-122">В этом разделе основное внимание уделяется олицетворению и делегированию в WCF при использовании безопасности SOAP.</span><span class="sxs-lookup"><span data-stu-id="814b0-122">This topic focuses on impersonation and delegation in WCF when using SOAP security.</span></span> <span data-ttu-id="814b0-123">Вы также можете использовать олицетворение и делегирование в WCF при использовании безопасности транспорта, как описано в разделе [использование олицетворения с защитой транспорта](using-impersonation-with-transport-security.md).</span><span class="sxs-lookup"><span data-stu-id="814b0-123">You can also use impersonation and delegation with WCF when using transport security, as described in [Using Impersonation with Transport Security](using-impersonation-with-transport-security.md).</span></span>  
  
## <a name="two-methods"></a><span data-ttu-id="814b0-124">Два метода</span><span class="sxs-lookup"><span data-stu-id="814b0-124">Two Methods</span></span>  
 <span data-ttu-id="814b0-125">Безопасность WCF SOAP имеет два различных метода для выполнения олицетворения.</span><span class="sxs-lookup"><span data-stu-id="814b0-125">WCF SOAP security has two distinct methods for performing impersonation.</span></span> <span data-ttu-id="814b0-126">Выбор используемого метода зависит от привязки.</span><span class="sxs-lookup"><span data-stu-id="814b0-126">The method used depends on the binding.</span></span> <span data-ttu-id="814b0-127">Первый - олицетворение на основании маркера Windows, получаемого из интерфейса поставщика поддержки безопасности (SSPI) или при проверке подлинности Kerberos, который затем кэшируется службой.</span><span class="sxs-lookup"><span data-stu-id="814b0-127">One is impersonation from a Windows token obtained from the Security Support Provider Interface (SSPI) or Kerberos authentication, which is then cached on the service.</span></span> <span data-ttu-id="814b0-128">Второй метод - олицетворение на основании маркера Windows, получаемого из расширений Kerberos, имеющих общее имя *Service-for-User* (S4U).</span><span class="sxs-lookup"><span data-stu-id="814b0-128">The second is impersonation from a Windows token obtained from the Kerberos extensions, collectively called *Service-for-User* (S4U).</span></span>  
  
### <a name="cached-token-impersonation"></a><span data-ttu-id="814b0-129">Олицетворение с использованием кэшированного маркера</span><span class="sxs-lookup"><span data-stu-id="814b0-129">Cached Token Impersonation</span></span>  
 <span data-ttu-id="814b0-130">Для олицетворения с использованием кэшированного маркера используются следующие элементы:</span><span class="sxs-lookup"><span data-stu-id="814b0-130">You can perform cached-token impersonation with the following:</span></span>  
  
- <span data-ttu-id="814b0-131">привязки<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>и <xref:System.ServiceModel.NetTcpBinding> , а также учетные данные клиента Windows;</span><span class="sxs-lookup"><span data-stu-id="814b0-131"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a Windows client credential.</span></span>  
  
- <span data-ttu-id="814b0-132">привязка<xref:System.ServiceModel.BasicHttpBinding> , у которой <xref:System.ServiceModel.BasicHttpSecurityMode> имеет значение <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> , или любая другая стандартная привязка, с помощью которой клиент представляет имя пользователя, которое служба может сопоставить с действительной учетной записью Windows;</span><span class="sxs-lookup"><span data-stu-id="814b0-132"><xref:System.ServiceModel.BasicHttpBinding> with a <xref:System.ServiceModel.BasicHttpSecurityMode> set to the <xref:System.ServiceModel.BasicHttpSecurityMode.TransportWithMessageCredential> credential, or any other standard binding where the client presents a user name credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="814b0-133">любая привязка <xref:System.ServiceModel.Channels.CustomBinding> , использующая учетные данные клиента Windows, где свойство `requireCancellation` имеет значение `true`.</span><span class="sxs-lookup"><span data-stu-id="814b0-133">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` set to `true`.</span></span> <span data-ttu-id="814b0-134">(Свойство доступно в следующих классах: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters> , <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters> и <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters> .) Если для привязки используется безопасный диалог, для свойства также должно быть `requireCancellation` задано значение `true` .</span><span class="sxs-lookup"><span data-stu-id="814b0-134">(The property is available on the following classes: <xref:System.ServiceModel.Security.Tokens.SecureConversationSecurityTokenParameters>, <xref:System.ServiceModel.Security.Tokens.SslSecurityTokenParameters>, and <xref:System.ServiceModel.Security.Tokens.SspiSecurityTokenParameters>.) If a secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
- <span data-ttu-id="814b0-135">любая привязка <xref:System.ServiceModel.Channels.CustomBinding> , в которой клиент представляет имя пользователя.</span><span class="sxs-lookup"><span data-stu-id="814b0-135">Any <xref:System.ServiceModel.Channels.CustomBinding> where the client presents a user name credential.</span></span> <span data-ttu-id="814b0-136">При использовании в привязке безопасного обмена данными свойство `requireCancellation` также должно иметь значение `true`.</span><span class="sxs-lookup"><span data-stu-id="814b0-136">If secure conversation is used on the binding, it must also have the `requireCancellation` property set to `true`.</span></span>  
  
### <a name="s4u-based-impersonation"></a><span data-ttu-id="814b0-137">Олицетворение на базе S4U</span><span class="sxs-lookup"><span data-stu-id="814b0-137">S4U-Based Impersonation</span></span>  
 <span data-ttu-id="814b0-138">Для олицетворения на базе S4U используются следующие элементы:</span><span class="sxs-lookup"><span data-stu-id="814b0-138">You can perform S4U-based impersonation with the following:</span></span>  
  
- <span data-ttu-id="814b0-139">привязка<xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>или <xref:System.ServiceModel.NetTcpBinding> с учетными данными сертификата клиента, которые служба может сопоставить с действительной учетной записью Windows;.</span><span class="sxs-lookup"><span data-stu-id="814b0-139"><xref:System.ServiceModel.WSHttpBinding>, <xref:System.ServiceModel.WSDualHttpBinding>, and <xref:System.ServiceModel.NetTcpBinding> with a certificate client credential that the service can map to a valid Windows account.</span></span>  
  
- <span data-ttu-id="814b0-140">любая привязка <xref:System.ServiceModel.Channels.CustomBinding> , использующая учетные данные клиента Windows, где свойство `requireCancellation` имеет значение `false`;</span><span class="sxs-lookup"><span data-stu-id="814b0-140">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a Windows client credential with the `requireCancellation` property set to `false`.</span></span>  
  
- <span data-ttu-id="814b0-141">любая привязка <xref:System.ServiceModel.Channels.CustomBinding> , использующая имя пользователя или учетные данные клиента Windows, а также безопасный обмен данными, где свойство `requireCancellation` имеет значение `false`.</span><span class="sxs-lookup"><span data-stu-id="814b0-141">Any <xref:System.ServiceModel.Channels.CustomBinding> that uses a user name or Windows client credential and secure conversation with the `requireCancellation` property set to `false`.</span></span>  
  
 <span data-ttu-id="814b0-142">Уровень олицетворения клиента службой зависит от привилегий, доступных учетной записи при попытке олицетворения, используемого типа олицетворения и, возможно, от уровня олицетворения, разрешенного клиентом.</span><span class="sxs-lookup"><span data-stu-id="814b0-142">The extent to which the service can impersonate the client depends on the privileges the service account holds when it attempts impersonation, the type of impersonation used, and possibly the extent of impersonation the client permits.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-143">Если клиент и служба выполняются на одном компьютере и клиент выполняется от имени системной учетной записи (например, `Local System` или `Network Service`), клиент невозможно олицетворить, если установлен безопасный сеанс с маркерами контекста безопасности с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="814b0-143">When the client and service are running on the same computer and the client is running under a system account (for example, `Local System` or `Network Service`), the client cannot be impersonated when a secure session is established with stateful Security Context tokens.</span></span> <span data-ttu-id="814b0-144">Приложения Windows Form и консольные приложения обычно выполняются от имени учетной записи находящегося в системе пользователя, поэтому эту учетную запись можно олицетворять по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="814b0-144">A Windows Form or console application typically runs under the currently logged-in account, so that account can be impersonated by default.</span></span> <span data-ttu-id="814b0-145">Однако если клиент является страницей ASP.NET и эта страница размещается в IIS 6,0 или IIS 7,0, то клиент по `Network Service` умолчанию работает под учетной записью.</span><span class="sxs-lookup"><span data-stu-id="814b0-145">However, when the client is an ASP.NET page and that page is hosted in IIS 6.0 or IIS 7.0, then the client does run under the `Network Service` account by default.</span></span> <span data-ttu-id="814b0-146">Все предоставляемые системой привязки, поддерживающие защищенные сеансы, по умолчанию используют маркеры контекста безопасности с отслеживанием состояния.</span><span class="sxs-lookup"><span data-stu-id="814b0-146">All of the system-provided bindings that support secure sessions use a stateless security context token (SCT) by default.</span></span> <span data-ttu-id="814b0-147">Однако если клиент является ASP.NET страницей и используются безопасные сеансы с отслеживанием состояния, клиент не сможет выполнить олицетворение.</span><span class="sxs-lookup"><span data-stu-id="814b0-147">However, if the client is an ASP.NET page, and secure sessions with stateful SCTs are used, the client cannot be impersonated.</span></span> <span data-ttu-id="814b0-148">Дополнительные сведения об использовании СКТС с отслеживанием состояния в безопасном сеансе см. в разделе [инструкции. Создание маркера контекста безопасности для безопасного сеанса](how-to-create-a-security-context-token-for-a-secure-session.md).</span><span class="sxs-lookup"><span data-stu-id="814b0-148">For more information about using stateful SCTs in a secure session, see [How to: Create a Security Context Token for a Secure Session](how-to-create-a-security-context-token-for-a-secure-session.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-declarative-model"></a><span data-ttu-id="814b0-149">Олицетворение в методе службы: декларативная модель</span><span class="sxs-lookup"><span data-stu-id="814b0-149">Impersonation in a Service Method: Declarative Model</span></span>  
 <span data-ttu-id="814b0-150">Большинство сценариев олицетворения предполагают выполнение метода службы в контексте вызывающего объекта.</span><span class="sxs-lookup"><span data-stu-id="814b0-150">Most impersonation scenarios involve executing the service method in the caller context.</span></span> <span data-ttu-id="814b0-151">WCF предоставляет функцию олицетворения, которая делает это простым, позволяя пользователю указать требование олицетворения в <xref:System.ServiceModel.OperationBehaviorAttribute> атрибуте.</span><span class="sxs-lookup"><span data-stu-id="814b0-151">WCF provides an impersonation feature that makes this easy to do by allowing the user to specify the impersonation requirement in the <xref:System.ServiceModel.OperationBehaviorAttribute> attribute.</span></span> <span data-ttu-id="814b0-152">Например, в следующем коде инфраструктура WCF олицетворяет вызывающий объект перед выполнением `Hello` метода.</span><span class="sxs-lookup"><span data-stu-id="814b0-152">For example, in the following code, the WCF infrastructure impersonates the caller before executing the `Hello` method.</span></span> <span data-ttu-id="814b0-153">Все попытки обратиться к собственным ресурсам внутри метода `Hello` окажутся успешными только в том случае, если список управления доступом (ACL) ресурса дает права на доступ вызывающему объекту.</span><span class="sxs-lookup"><span data-stu-id="814b0-153">Any attempt to access native resources inside the `Hello` method succeed only if the access control list (ACL) of the resource allows the caller access privileges.</span></span> <span data-ttu-id="814b0-154">Чтобы включить олицетворение, присвойте свойству <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> одно из значений перечисления <xref:System.ServiceModel.ImpersonationOption> : <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> или <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, как показано в следующем примере.</span><span class="sxs-lookup"><span data-stu-id="814b0-154">To enable impersonation, set the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property to one of the <xref:System.ServiceModel.ImpersonationOption> enumeration values, either <xref:System.ServiceModel.ImpersonationOption.Required?displayProperty=nameWithType> or <xref:System.ServiceModel.ImpersonationOption.Allowed?displayProperty=nameWithType>, as shown in the following example.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-155">Если у службы имеется больше прав, чем у удаленного клиента, то используются учетные данные службы, если свойство <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> имеет значение <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span><span class="sxs-lookup"><span data-stu-id="814b0-155">When a service has higher credentials than the remote client, the credentials of the service are used if the <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A> property is set to <xref:System.ServiceModel.ImpersonationOption.Allowed>.</span></span> <span data-ttu-id="814b0-156">Это значит, что если пользователь с более узкими правами предоставляет свои учетные данные, то метод выполняется с более широкими правами службы, и пользователь получает доступ к ресурсам, доступ к которым он бы сам получить не смог.</span><span class="sxs-lookup"><span data-stu-id="814b0-156">That is, if a low-privileged user provides its credentials, a higher-privileged service executes the method with the credentials of the service, and can use resources that the low-privileged user would otherwise not be able to use.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#1)]
 [!code-vb[c_ImpersonationAndDelegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#1)]  
  
 <span data-ttu-id="814b0-157">Инфраструктура WCF может олицетворять вызывающий объект только в том случае, если вызывающий объект прошел проверку подлинности с учетными данными, которые можно сопоставить с учетной записью пользователя Windows.</span><span class="sxs-lookup"><span data-stu-id="814b0-157">The WCF infrastructure can impersonate the caller only if the caller is authenticated with credentials that can be mapped to a Windows user account.</span></span> <span data-ttu-id="814b0-158">Если служба настроена на прохождение проверки подлинности с использованием учетных данных, которые невозможно сопоставить с учетной записью Windows, метод службы не выполняется.</span><span class="sxs-lookup"><span data-stu-id="814b0-158">If the service is configured to authenticate using a credential that cannot be mapped to a Windows account, the service method is not executed.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-159">В Windows XP олицетворение завершается сбоем, если создается SCT с отслеживанием состояния, что приводит к созданию <xref:System.InvalidOperationException> .</span><span class="sxs-lookup"><span data-stu-id="814b0-159">On Windows XP, impersonation fails if a stateful SCT is created, resulting in an <xref:System.InvalidOperationException>.</span></span> <span data-ttu-id="814b0-160">Дополнительные сведения см. в разделе [неподдерживаемые сценарии](unsupported-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="814b0-160">For more information, see [Unsupported Scenarios](unsupported-scenarios.md).</span></span>  
  
## <a name="impersonation-in-a-service-method-imperative-model"></a><span data-ttu-id="814b0-161">Олицетворение в методе службы: императивная модель</span><span class="sxs-lookup"><span data-stu-id="814b0-161">Impersonation in a Service Method: Imperative Model</span></span>  
 <span data-ttu-id="814b0-162">Иногда вызывающему объекту требуется олицетворять не весь метод службы, а лишь его часть.</span><span class="sxs-lookup"><span data-stu-id="814b0-162">Sometimes a caller does not need to impersonate the entire service method to function, but for only a portion of it.</span></span> <span data-ttu-id="814b0-163">В этом случае необходимо получить удостоверение Windows вызывающего объекта внутри метода службы и императивно выполнить олицетворение.</span><span class="sxs-lookup"><span data-stu-id="814b0-163">In this case, obtain the Windows identity of the caller inside the service method and imperatively perform the impersonation.</span></span> <span data-ttu-id="814b0-164">Для этого необходимо с помощью свойства <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> объекта <xref:System.ServiceModel.ServiceSecurityContext> возвратить экземпляр класса <xref:System.Security.Principal.WindowsIdentity> и вызвать метод <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> перед использованием этого экземпляра.</span><span class="sxs-lookup"><span data-stu-id="814b0-164">Do this by using the <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> property of the <xref:System.ServiceModel.ServiceSecurityContext> to return an instance of the <xref:System.Security.Principal.WindowsIdentity> class and calling the <xref:System.Security.Principal.WindowsIdentity.Impersonate%2A> method before using the instance.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-165">Не забудьте использовать `Using` инструкцию Visual Basic или `using` инструкцию C# для автоматической отмены действия олицетворения.</span><span class="sxs-lookup"><span data-stu-id="814b0-165">Be sure to use the Visual Basic`Using` statement or the C# `using` statement to automatically revert the impersonation action.</span></span> <span data-ttu-id="814b0-166">Если вы не используете оператор или используете язык программирования, отличный от Visual Basic или C#, не забудьте вернуть уровень олицетворения.</span><span class="sxs-lookup"><span data-stu-id="814b0-166">If you do not use the statement, or if you use a programming language other than Visual Basic or C#, be sure to revert the impersonation level.</span></span> <span data-ttu-id="814b0-167">В противном случае возникнет угроза атаки типа «отказ в обслуживании» или «несанкционированное получение прав».</span><span class="sxs-lookup"><span data-stu-id="814b0-167">Failure to do this can form the basis for denial of service and elevation of privilege attacks.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#2)]
 [!code-vb[c_ImpersonationAndDelegation#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#2)]  
  
## <a name="impersonation-for-all-service-methods"></a><span data-ttu-id="814b0-168">Олицетворение для всех методов службы</span><span class="sxs-lookup"><span data-stu-id="814b0-168">Impersonation for All Service Methods</span></span>  
 <span data-ttu-id="814b0-169">В некоторых случаях требуется выполнять в контексте вызывающего объекта все методы службы.</span><span class="sxs-lookup"><span data-stu-id="814b0-169">In some cases, you must perform all the methods of a service in the caller’s context.</span></span> <span data-ttu-id="814b0-170">Вместо явного включения этой функции для каждого метода в отдельности можно воспользоваться классом <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span><span class="sxs-lookup"><span data-stu-id="814b0-170">Instead of explicitly enabling this feature on a per-method basis, use the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>.</span></span> <span data-ttu-id="814b0-171">Как показано в следующем фрагменте кода, установите свойство <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> равным `true`.</span><span class="sxs-lookup"><span data-stu-id="814b0-171">As shown in the following code, set the <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A> property to `true`.</span></span> <span data-ttu-id="814b0-172">Объект <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> извлекается из коллекции расширений функциональности класса <xref:System.ServiceModel.ServiceHost> .</span><span class="sxs-lookup"><span data-stu-id="814b0-172">The <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior> is retrieved from the collections of behaviors of the <xref:System.ServiceModel.ServiceHost> class.</span></span> <span data-ttu-id="814b0-173">Также обратите внимание, что свойство `Impersonation` объекта <xref:System.ServiceModel.OperationBehaviorAttribute> , применяемого к каждому из методов, тоже должно иметь значение <xref:System.ServiceModel.ImpersonationOption.Allowed> или <xref:System.ServiceModel.ImpersonationOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="814b0-173">Also note that the `Impersonation` property of the <xref:System.ServiceModel.OperationBehaviorAttribute> applied to each method must also be set to either <xref:System.ServiceModel.ImpersonationOption.Allowed> or <xref:System.ServiceModel.ImpersonationOption.Required>.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#3)]
 [!code-vb[c_ImpersonationAndDelegation#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#3)]  
  
 <span data-ttu-id="814b0-174">В следующей таблице описывается поведение WCF для всех возможных сочетаний функций `ImpersonationOption` и `ImpersonateCallerForAllServiceOperations` .</span><span class="sxs-lookup"><span data-stu-id="814b0-174">The following table describes WCF behavior for all possible combinations of `ImpersonationOption` and `ImpersonateCallerForAllServiceOperations`.</span></span>  
  
|`ImpersonationOption`|`ImpersonateCallerForAllServiceOperations`|<span data-ttu-id="814b0-175">Поведение</span><span class="sxs-lookup"><span data-stu-id="814b0-175">Behavior</span></span>|  
|---------------------------|------------------------------------------------|--------------|  
|<span data-ttu-id="814b0-176">Обязательно</span><span class="sxs-lookup"><span data-stu-id="814b0-176">Required</span></span>|<span data-ttu-id="814b0-177">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-177">n/a</span></span>|<span data-ttu-id="814b0-178">WCF олицетворяет вызывающего</span><span class="sxs-lookup"><span data-stu-id="814b0-178">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="814b0-179">Допускается</span><span class="sxs-lookup"><span data-stu-id="814b0-179">Allowed</span></span>|<span data-ttu-id="814b0-180">false</span><span class="sxs-lookup"><span data-stu-id="814b0-180">false</span></span>|<span data-ttu-id="814b0-181">WCF не олицетворяет вызывающего</span><span class="sxs-lookup"><span data-stu-id="814b0-181">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="814b0-182">Допускается</span><span class="sxs-lookup"><span data-stu-id="814b0-182">Allowed</span></span>|<span data-ttu-id="814b0-183">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-183">true</span></span>|<span data-ttu-id="814b0-184">WCF олицетворяет вызывающего</span><span class="sxs-lookup"><span data-stu-id="814b0-184">WCF impersonates the caller</span></span>|  
|<span data-ttu-id="814b0-185">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="814b0-185">NotAllowed</span></span>|<span data-ttu-id="814b0-186">false</span><span class="sxs-lookup"><span data-stu-id="814b0-186">false</span></span>|<span data-ttu-id="814b0-187">WCF не олицетворяет вызывающего</span><span class="sxs-lookup"><span data-stu-id="814b0-187">WCF does not impersonate the caller</span></span>|  
|<span data-ttu-id="814b0-188">NotAllowed</span><span class="sxs-lookup"><span data-stu-id="814b0-188">NotAllowed</span></span>|<span data-ttu-id="814b0-189">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-189">true</span></span>|<span data-ttu-id="814b0-190">Disallowed.</span><span class="sxs-lookup"><span data-stu-id="814b0-190">Disallowed.</span></span> <span data-ttu-id="814b0-191">(Создается исключение <xref:System.InvalidOperationException> .)</span><span class="sxs-lookup"><span data-stu-id="814b0-191">(An <xref:System.InvalidOperationException> is thrown.)</span></span>|  
  
## <a name="impersonation-level-obtained-from-windows-credentials-and-cached-token-impersonation"></a><span data-ttu-id="814b0-192">Уровень олицетворения, получаемый на основании учетных данных Windows, и олицетворение с использованием кэшированного маркера</span><span class="sxs-lookup"><span data-stu-id="814b0-192">Impersonation Level Obtained from Windows Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="814b0-193">В некоторых сценариях при использовании учетных данных клиента Windows клиент может лишь частично управлять уровнем олицетворения в службе.</span><span class="sxs-lookup"><span data-stu-id="814b0-193">In some scenarios the client has partial control over the level of impersonation the service performs when a Windows client credential is used.</span></span> <span data-ttu-id="814b0-194">Один из таких сценариев имеет место, когда клиент задает уровень олицетворения Anonymous.</span><span class="sxs-lookup"><span data-stu-id="814b0-194">One scenario occurs when the client specifies an Anonymous impersonation level.</span></span> <span data-ttu-id="814b0-195">Второй сценарий имеет место при олицетворении с использованием кэшированного маркера.</span><span class="sxs-lookup"><span data-stu-id="814b0-195">The other occurs when performing impersonation with a cached token.</span></span> <span data-ttu-id="814b0-196">Для этого задается свойство <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> класса <xref:System.ServiceModel.Security.WindowsClientCredential> , к которому происходит обращение как к свойству универсального класса <xref:System.ServiceModel.ChannelFactory%601> .</span><span class="sxs-lookup"><span data-stu-id="814b0-196">This is done by setting the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property of the <xref:System.ServiceModel.Security.WindowsClientCredential> class, which is accessed as a property of the generic <xref:System.ServiceModel.ChannelFactory%601> class.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-197">Задание уровня олицетворения Anonymous приводит к тому, что клиент входит в систему службы анонимно.</span><span class="sxs-lookup"><span data-stu-id="814b0-197">Specifying an impersonation level of Anonymous causes the client to log on to the service anonymously.</span></span> <span data-ttu-id="814b0-198">Поэтому служба должна разрешать анонимный вход независимо от того, будет ли выполняться олицетворение.</span><span class="sxs-lookup"><span data-stu-id="814b0-198">The service must therefore allow anonymous logons, regardless of whether impersonation is performed.</span></span>  
  
 <span data-ttu-id="814b0-199">Клиент может установить один из следующих уровней олицетворения: <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>или <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="814b0-199">The client can specify the impersonation level as <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, <xref:System.Security.Principal.TokenImpersonationLevel.Identification>, <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, or <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="814b0-200">При этом создается только маркер на заданном уровне, как показано в следующем фрагменте кода.</span><span class="sxs-lookup"><span data-stu-id="814b0-200">Only a token at the specified level is produced, as shown in the following code.</span></span>  
  
 [!code-csharp[c_ImpersonationAndDelegation#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_impersonationanddelegation/cs/source.cs#4)]
 [!code-vb[c_ImpersonationAndDelegation#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_impersonationanddelegation/vb/source.vb#4)]  
  
 <span data-ttu-id="814b0-201">В следующей таблице показаны уровни олицетворения, получаемые службой при олицетворении с использованием кэшированного маркера.</span><span class="sxs-lookup"><span data-stu-id="814b0-201">The following table specifies the impersonation level the service obtains when impersonating from a cached token.</span></span>  
  
|<span data-ttu-id="814b0-202">Значение `AllowedImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="814b0-202">`AllowedImpersonationLevel` value</span></span>|<span data-ttu-id="814b0-203">У службы есть `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="814b0-203">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="814b0-204">Служба и клиент поддерживают делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-204">Service and client are capable of delegation</span></span>|<span data-ttu-id="814b0-205">Кэшированный маркер `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="814b0-205">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="814b0-206">Анонимные</span><span class="sxs-lookup"><span data-stu-id="814b0-206">Anonymous</span></span>|<span data-ttu-id="814b0-207">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-207">Yes</span></span>|<span data-ttu-id="814b0-208">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-208">n/a</span></span>|<span data-ttu-id="814b0-209">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-209">Impersonation</span></span>|  
|<span data-ttu-id="814b0-210">Анонимные</span><span class="sxs-lookup"><span data-stu-id="814b0-210">Anonymous</span></span>|<span data-ttu-id="814b0-211">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-211">No</span></span>|<span data-ttu-id="814b0-212">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-212">n/a</span></span>|<span data-ttu-id="814b0-213">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-213">Identification</span></span>|  
|<span data-ttu-id="814b0-214">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-214">Identification</span></span>|<span data-ttu-id="814b0-215">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-215">n/a</span></span>|<span data-ttu-id="814b0-216">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-216">n/a</span></span>|<span data-ttu-id="814b0-217">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-217">Identification</span></span>|  
|<span data-ttu-id="814b0-218">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-218">Impersonation</span></span>|<span data-ttu-id="814b0-219">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-219">Yes</span></span>|<span data-ttu-id="814b0-220">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-220">n/a</span></span>|<span data-ttu-id="814b0-221">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-221">Impersonation</span></span>|  
|<span data-ttu-id="814b0-222">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-222">Impersonation</span></span>|<span data-ttu-id="814b0-223">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-223">No</span></span>|<span data-ttu-id="814b0-224">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-224">n/a</span></span>|<span data-ttu-id="814b0-225">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-225">Identification</span></span>|  
|<span data-ttu-id="814b0-226">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-226">Delegation</span></span>|<span data-ttu-id="814b0-227">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-227">Yes</span></span>|<span data-ttu-id="814b0-228">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-228">Yes</span></span>|<span data-ttu-id="814b0-229">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-229">Delegation</span></span>|  
|<span data-ttu-id="814b0-230">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-230">Delegation</span></span>|<span data-ttu-id="814b0-231">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-231">Yes</span></span>|<span data-ttu-id="814b0-232">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-232">No</span></span>|<span data-ttu-id="814b0-233">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-233">Impersonation</span></span>|  
|<span data-ttu-id="814b0-234">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-234">Delegation</span></span>|<span data-ttu-id="814b0-235">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-235">No</span></span>|<span data-ttu-id="814b0-236">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-236">n/a</span></span>|<span data-ttu-id="814b0-237">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-237">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-user-name-credentials-and-cached-token-impersonation"></a><span data-ttu-id="814b0-238">Уровень олицетворения, получаемый на основании учетных данных имени пользователя, и олицетворение с использованием кэшированного маркера</span><span class="sxs-lookup"><span data-stu-id="814b0-238">Impersonation Level Obtained from User Name Credentials and Cached Token Impersonation</span></span>  
 <span data-ttu-id="814b0-239">Передавая службе имя пользователя и пароль, клиент позволяет WCF войти в систему от имени этого пользователя, что эквивалентно присвоению `AllowedImpersonationLevel` свойству значения <xref:System.Security.Principal.TokenImpersonationLevel.Delegation> .</span><span class="sxs-lookup"><span data-stu-id="814b0-239">By passing the service its user name and password, a client enables WCF to log on as that user, which is equivalent to setting the `AllowedImpersonationLevel` property to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span> <span data-ttu-id="814b0-240">(Объект `AllowedImpersonationLevel` доступен в <xref:System.ServiceModel.Security.WindowsClientCredential> <xref:System.ServiceModel.Security.HttpDigestClientCredential> классах и.) В следующей таблице приводится уровень олицетворения, полученный при получении службой учетных данных имени пользователя.</span><span class="sxs-lookup"><span data-stu-id="814b0-240">(The `AllowedImpersonationLevel` is available on the <xref:System.ServiceModel.Security.WindowsClientCredential> and <xref:System.ServiceModel.Security.HttpDigestClientCredential> classes.) The following table provides the impersonation level obtained when the service receives user name credentials.</span></span>  
  
|`AllowedImpersonationLevel`|<span data-ttu-id="814b0-241">У службы есть `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="814b0-241">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="814b0-242">Служба и клиент поддерживают делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-242">Service and client are capable of delegation</span></span>|<span data-ttu-id="814b0-243">Кэшированный маркер `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="814b0-243">Cached token `ImpersonationLevel`</span></span>|  
|---------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="814b0-244">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-244">n/a</span></span>|<span data-ttu-id="814b0-245">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-245">Yes</span></span>|<span data-ttu-id="814b0-246">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-246">Yes</span></span>|<span data-ttu-id="814b0-247">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-247">Delegation</span></span>|  
|<span data-ttu-id="814b0-248">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-248">n/a</span></span>|<span data-ttu-id="814b0-249">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-249">Yes</span></span>|<span data-ttu-id="814b0-250">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-250">No</span></span>|<span data-ttu-id="814b0-251">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-251">Impersonation</span></span>|  
|<span data-ttu-id="814b0-252">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-252">n/a</span></span>|<span data-ttu-id="814b0-253">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-253">No</span></span>|<span data-ttu-id="814b0-254">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-254">n/a</span></span>|<span data-ttu-id="814b0-255">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-255">Identification</span></span>|  
  
## <a name="impersonation-level-obtained-from-s4u-based-impersonation"></a><span data-ttu-id="814b0-256">Уровень олицетворения при олицетворении на базе S4U</span><span class="sxs-lookup"><span data-stu-id="814b0-256">Impersonation Level Obtained from S4U-Based Impersonation</span></span>  
  
|<span data-ttu-id="814b0-257">У службы есть `SeTcbPrivilege`</span><span class="sxs-lookup"><span data-stu-id="814b0-257">Service has `SeTcbPrivilege`</span></span>|<span data-ttu-id="814b0-258">У службы есть `SeImpersonatePrivilege`</span><span class="sxs-lookup"><span data-stu-id="814b0-258">Service has `SeImpersonatePrivilege`</span></span>|<span data-ttu-id="814b0-259">Служба и клиент поддерживают делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-259">Service and client are capable of delegation</span></span>|<span data-ttu-id="814b0-260">Кэшированный маркер `ImpersonationLevel`</span><span class="sxs-lookup"><span data-stu-id="814b0-260">Cached token `ImpersonationLevel`</span></span>|  
|----------------------------------|------------------------------------------|--------------------------------------------------|---------------------------------------|  
|<span data-ttu-id="814b0-261">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-261">Yes</span></span>|<span data-ttu-id="814b0-262">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-262">Yes</span></span>|<span data-ttu-id="814b0-263">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-263">n/a</span></span>|<span data-ttu-id="814b0-264">Олицетворение</span><span class="sxs-lookup"><span data-stu-id="814b0-264">Impersonation</span></span>|  
|<span data-ttu-id="814b0-265">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-265">Yes</span></span>|<span data-ttu-id="814b0-266">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-266">No</span></span>|<span data-ttu-id="814b0-267">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-267">n/a</span></span>|<span data-ttu-id="814b0-268">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-268">Identification</span></span>|  
|<span data-ttu-id="814b0-269">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-269">No</span></span>|<span data-ttu-id="814b0-270">Недоступно</span><span class="sxs-lookup"><span data-stu-id="814b0-270">n/a</span></span>|<span data-ttu-id="814b0-271">Н/Д</span><span class="sxs-lookup"><span data-stu-id="814b0-271">n/a</span></span>|<span data-ttu-id="814b0-272">Определение</span><span class="sxs-lookup"><span data-stu-id="814b0-272">Identification</span></span>|  
  
## <a name="mapping-a-client-certificate-to-a-windows-account"></a><span data-ttu-id="814b0-273">Сопоставление сертификата клиента с учетной записью Windows</span><span class="sxs-lookup"><span data-stu-id="814b0-273">Mapping a Client Certificate to a Windows Account</span></span>  
 <span data-ttu-id="814b0-274">Клиент может выполнить свою проверку подлинности в службе с использованием сертификата, чтобы служба сама сопоставила клиент с существующей учетной записью в Active Directory.</span><span class="sxs-lookup"><span data-stu-id="814b0-274">It is possible for a client to authenticate itself to a service using a certificate, and to have the service map the client to an existing account through Active Directory.</span></span> <span data-ttu-id="814b0-275">В следующем примере XML-кода показано, как настроить службы для сопоставления сертификата.</span><span class="sxs-lookup"><span data-stu-id="814b0-275">The following XML shows how to configure the service to map the certificate.</span></span>  
  
```xml  
<behaviors>  
  <serviceBehaviors>  
    <behavior name="MapToWindowsAccount">  
      <serviceCredentials>  
        <clientCertificate>  
          <authentication mapClientCertificateToWindowsAccount="true" />  
        </clientCertificate>  
      </serviceCredentials>  
    </behavior>  
  </serviceBehaviors>  
</behaviors>  
```  
  
 <span data-ttu-id="814b0-276">В следующем примере кода показано, как настроить службу.</span><span class="sxs-lookup"><span data-stu-id="814b0-276">The following code shows how to configure the service.</span></span>  
  
```csharp
// Create a binding that sets a certificate as the client credential type.  
WSHttpBinding b = new WSHttpBinding();  
b.Security.Message.ClientCredentialType = MessageCredentialType.Certificate;  
  
// Create a service host that maps the certificate to a Windows account.  
Uri httpUri = new Uri("http://localhost/Calculator");  
ServiceHost sh = new ServiceHost(typeof(HelloService), httpUri);  
sh.Credentials.ClientCertificate.Authentication.MapClientCertificateToWindowsAccount = true;  
```  
  
## <a name="delegation"></a><span data-ttu-id="814b0-277">Делегирование</span><span class="sxs-lookup"><span data-stu-id="814b0-277">Delegation</span></span>  
 <span data-ttu-id="814b0-278">Чтобы выполнить делегирование внутренней службе, служба должна выполнить многоступенчатую (SSPI без резервной проверки подлинности NTLM) проверку подлинности или прямую проверку подлинности Kerberos во внутренней службе, используя удостоверение Windows клиента.</span><span class="sxs-lookup"><span data-stu-id="814b0-278">To delegate to a back-end service, a service must perform Kerberos multi-leg (SSPI without NTLM fallback) or Kerberos direct authentication to the back-end service using the client’s Windows identity.</span></span> <span data-ttu-id="814b0-279">Для делегирования внутренней службе создайте объект <xref:System.ServiceModel.ChannelFactory%601> и канал, а затем используйте этот канал для взаимодействия при олицетворении клиента.</span><span class="sxs-lookup"><span data-stu-id="814b0-279">To delegate to a back-end service, create a <xref:System.ServiceModel.ChannelFactory%601> and a channel, and then communicate through the channel while impersonating the client.</span></span> <span data-ttu-id="814b0-280">При такой модели делегирования расстояние, на котором внутренняя служба может располагаться относительно внешней службы, зависит от уровня олицетворения, полученного внешней службой.</span><span class="sxs-lookup"><span data-stu-id="814b0-280">With this form of delegation, the distance at which the back-end service can be located from the front-end service depends on the impersonation level achieved by the front-end service.</span></span> <span data-ttu-id="814b0-281">Если уровень олицетворения равен <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, внешняя и внутренняя службы должны выполняться на одном компьютере.</span><span class="sxs-lookup"><span data-stu-id="814b0-281">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>, the front-end and back-end services must be running on the same machine.</span></span> <span data-ttu-id="814b0-282">Если уровень олицетворения равен <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, внешняя и внутренняя службы могут выполняться как на различных компьютерах, так и на одном компьютере.</span><span class="sxs-lookup"><span data-stu-id="814b0-282">When the impersonation level is <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>, the front-end and back-end services can be on separate machines or on the same machine.</span></span> <span data-ttu-id="814b0-283">Для включения олицетворения уровня делегирования необходимо, чтобы политика домена Windows разрешала делегирование.</span><span class="sxs-lookup"><span data-stu-id="814b0-283">Enabling delegation-level impersonation requires that Windows domain policy be configured to permit delegation.</span></span> <span data-ttu-id="814b0-284">Дополнительные сведения о настройке поддержки делегирования в Active Directory см. в разделе [Включение делегированной проверки подлинности](/previous-versions/windows/it-pro/windows-server-2003/cc780217(v=ws.10)).</span><span class="sxs-lookup"><span data-stu-id="814b0-284">For more information about configuring Active Directory for delegation support, see [Enabling Delegated Authentication](/previous-versions/windows/it-pro/windows-server-2003/cc780217(v=ws.10)).</span></span>  
  
> [!NOTE]
> <span data-ttu-id="814b0-285">Если клиент проходит проверку подлинности во внешней службе с использованием имени пользователя и пароля, соответствующих учетной записи Windows во внутренней службе, внешняя служба может пройти проверку подлинности во внутренней службе, используя имя пользователя и пароль клиента.</span><span class="sxs-lookup"><span data-stu-id="814b0-285">When a client authenticates to the front-end service using a user name and password that correspond to a Windows account on the back-end service, the front-end service can authenticate to the back-end service by reusing the client’s user name and password.</span></span> <span data-ttu-id="814b0-286">Это особенно мощная форма потока обработки удостоверений, поскольку передача имени пользователя и пароля внутренней службе позволяет этой службе выполнять олицетворение; однако в этом случае невозможно делегирование, так как не использует проверка подлинности Kerberos.</span><span class="sxs-lookup"><span data-stu-id="814b0-286">This is a particularly powerful form of identity flow, because passing user name and password to the back-end service enables the back-end service to perform impersonation, but it does not constitute delegation because Kerberos is not used.</span></span> <span data-ttu-id="814b0-287">Действие элементов управления делегированием службы каталогов Active Directory не распространяется на проверку подлинности имени пользователя и пароля.</span><span class="sxs-lookup"><span data-stu-id="814b0-287">Active Directory controls on delegation do not apply to user name and password authentication.</span></span>  
  
### <a name="delegation-ability-as-a-function-of-impersonation-level"></a><span data-ttu-id="814b0-288">Возможность делегирования как функция уровня олицетворения</span><span class="sxs-lookup"><span data-stu-id="814b0-288">Delegation Ability as a Function of Impersonation Level</span></span>  
  
|<span data-ttu-id="814b0-289">Уровень олицетворения</span><span class="sxs-lookup"><span data-stu-id="814b0-289">Impersonation level</span></span>|<span data-ttu-id="814b0-290">Служба может выполнять делегирование между процессами</span><span class="sxs-lookup"><span data-stu-id="814b0-290">Service can perform cross-process delegation</span></span>|<span data-ttu-id="814b0-291">Служба может выполнять делегирование между компьютерами</span><span class="sxs-lookup"><span data-stu-id="814b0-291">Service can perform cross-machine delegation</span></span>|  
|-------------------------|---------------------------------------------------|---------------------------------------------------|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Identification>|<span data-ttu-id="814b0-292">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-292">No</span></span>|<span data-ttu-id="814b0-293">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-293">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Impersonation>|<span data-ttu-id="814b0-294">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-294">Yes</span></span>|<span data-ttu-id="814b0-295">нет</span><span class="sxs-lookup"><span data-stu-id="814b0-295">No</span></span>|  
|<xref:System.Security.Principal.TokenImpersonationLevel.Delegation>|<span data-ttu-id="814b0-296">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-296">Yes</span></span>|<span data-ttu-id="814b0-297">Да</span><span class="sxs-lookup"><span data-stu-id="814b0-297">Yes</span></span>|  
  
 <span data-ttu-id="814b0-298">В следующем примере кода показано, как использовать делегирование.</span><span class="sxs-lookup"><span data-stu-id="814b0-298">The following code example demonstrates how to use delegation.</span></span>  
  
 [!code-csharp[c_delegation#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_delegation/cs/source.cs#1)]
 [!code-vb[c_delegation#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_delegation/vb/source.vb#1)]  
  
### <a name="how-to-configure-an-application-to-use-constrained-delegation"></a><span data-ttu-id="814b0-299">Настройка приложения для использования ограниченного делегирования</span><span class="sxs-lookup"><span data-stu-id="814b0-299">How to Configure an Application to Use Constrained Delegation</span></span>  
 <span data-ttu-id="814b0-300">Для использования ограниченного делегирования необходимо предварительно настроить отправитель, получатель и контроллер домена.</span><span class="sxs-lookup"><span data-stu-id="814b0-300">Before you can use constrained delegation, the sender, receiver, and the domain controller must be configured to do so.</span></span> <span data-ttu-id="814b0-301">Ниже перечислены операции по включению ограниченного делегирования.</span><span class="sxs-lookup"><span data-stu-id="814b0-301">The following procedure lists the steps that enable constrained delegation.</span></span> <span data-ttu-id="814b0-302">Дополнительные сведения о различиях между делегированием и ограниченным делегированием см. в части раздела [Расширения Kerberos Windows Server 2003](/previous-versions/windows/it-pro/windows-server-2003/cc738207(v=ws.10)) , посвященной ограниченному делегированию.</span><span class="sxs-lookup"><span data-stu-id="814b0-302">For details about the differences between delegation and constrained delegation, see the portion of [Windows Server 2003 Kerberos Extensions](/previous-versions/windows/it-pro/windows-server-2003/cc738207(v=ws.10)) that discusses constrained discussion.</span></span>  
  
1. <span data-ttu-id="814b0-303">На контроллере домена снимите флажок **Учетная запись важна и не может быть делегирована** для учетной записи, от имени которой выполняется клиентское приложение.</span><span class="sxs-lookup"><span data-stu-id="814b0-303">On the domain controller, clear the **Account is sensitive and cannot be delegated** check box for the account under which the client application is running.</span></span>  
  
2. <span data-ttu-id="814b0-304">На контроллере домена установите флажок **Учетная запись доверена для делегирования** для учетной записи, от имени которой выполняется клиентское приложение.</span><span class="sxs-lookup"><span data-stu-id="814b0-304">On the domain controller, select the **Account is trusted for delegation** check box for the account under which the client application is running.</span></span>  
  
3. <span data-ttu-id="814b0-305">На контроллере домена настройте компьютер промежуточного уровня, чтобы он был доверен для делегирования. Для этого установите параметр **Доверять компьютеру делегирование** .</span><span class="sxs-lookup"><span data-stu-id="814b0-305">On the domain controller, configure the middle tier computer so that it is trusted for delegation, by clicking the **Trust computer for delegation** option.</span></span>  
  
4. <span data-ttu-id="814b0-306">На контроллере домена настройте компьютер промежуточного уровня, чтобы он использовал ограниченное делегирование. Для этого установите параметр **Этот компьютер доверенный для делегирования указанных служб** .</span><span class="sxs-lookup"><span data-stu-id="814b0-306">On the domain controller, configure the middle tier computer to use constrained delegation, by clicking the **Trust this computer for delegation to specified services only** option.</span></span>  
  
 <span data-ttu-id="814b0-307">Более подробные инструкции по настройке ограниченного делегирования см. в разделе [Смена протокола Kerberos и ограниченное делегирование](/previous-versions/windows/it-pro/windows-server-2003/cc739587(v=ws.10)).</span><span class="sxs-lookup"><span data-stu-id="814b0-307">For more detailed instructions about configuring constrained delegation, see [Kerberos Protocol Transition and Constrained Delegation](/previous-versions/windows/it-pro/windows-server-2003/cc739587(v=ws.10)).</span></span>
  
## <a name="see-also"></a><span data-ttu-id="814b0-308">См. также</span><span class="sxs-lookup"><span data-stu-id="814b0-308">See also</span></span>

- <xref:System.ServiceModel.OperationBehaviorAttribute>
- <xref:System.ServiceModel.OperationBehaviorAttribute.Impersonation%2A>
- <xref:System.ServiceModel.ImpersonationOption>
- <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A>
- <xref:System.ServiceModel.ServiceSecurityContext>
- <xref:System.Security.Principal.WindowsIdentity>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior>
- <xref:System.ServiceModel.Description.ServiceAuthorizationBehavior.ImpersonateCallerForAllOperations%2A>
- <xref:System.ServiceModel.ServiceHost>
- <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ChannelFactory%601>
- <xref:System.Security.Principal.TokenImpersonationLevel.Identification>
- [<span data-ttu-id="814b0-309">Использование олицетворения при обеспечении безопасности транспорта</span><span class="sxs-lookup"><span data-stu-id="814b0-309">Using Impersonation with Transport Security</span></span>](using-impersonation-with-transport-security.md)
- [<span data-ttu-id="814b0-310">Олицетворение клиента</span><span class="sxs-lookup"><span data-stu-id="814b0-310">Impersonating the Client</span></span>](../samples/impersonating-the-client.md)
- [<span data-ttu-id="814b0-311">Практическое руководство. Олицетворение клиента в рамках службы</span><span class="sxs-lookup"><span data-stu-id="814b0-311">How to: Impersonate a Client on a Service</span></span>](../how-to-impersonate-a-client-on-a-service.md)
- [<span data-ttu-id="814b0-312">Служебное средство ServiceModel Metadata Utility Tool (Svcutil.exe)</span><span class="sxs-lookup"><span data-stu-id="814b0-312">ServiceModel Metadata Utility Tool (Svcutil.exe)</span></span>](../servicemodel-metadata-utility-tool-svcutil-exe.md)
