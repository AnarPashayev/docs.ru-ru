---
title: Идентификация и проверка подлинности службы
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- authentication [WCF], specifying the identity of a service
ms.assetid: a4c8f52c-5b30-45c4-a545-63244aba82be
ms.openlocfilehash: 6c12c3aadf53f9fddef2f0b0124994db15565cb5
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/09/2020
ms.locfileid: "84600378"
---
# <a name="service-identity-and-authentication"></a>Идентификация и проверка подлинности службы
*Удостоверение конечной точки* службы — это значение, созданное на языке WSDL. Это значение распространяется по всем клиентам и используется для проверки подлинности службы. После того как клиент инициирует связь с конечной точкой и служба пройдет проверку подлинности на клиенте, клиент сравнивает значение удостоверения конечной точки с действительным значением, возвращенным процессом проверки подлинности конечной точки. Если значения совпадают, значит клиент связался с ожидаемой конечной точкой службы. Эта функция действует как защита от *фишинга* , предотвращая перенаправление клиента на конечную точку, размещенную в вредоносной службе.  
  
 Пример приложения, демонстрирующий настройку удостоверения, см. в разделе [Пример удостоверения службы](../samples/service-identity-sample.md). Дополнительные сведения о конечных точках и адресах конечных точек см. в разделе [адреса](endpoint-addresses.md).  
  
> [!NOTE]
> При использовании NT LanMan (NTLM) для проверки подлинности удостоверение службы не проверяется, так как в NTLM проверка подлинности сервера клиентом не поддерживается. NTLM используется, когда компьютеры входят в рабочую группу Windows или при работе в старых версиях Windows, не поддерживающих проверку подлинности Kerberos.  
  
 Когда клиент инициирует безопасный канал для отправки сообщения в службу, инфраструктура Windows Communication Foundation (WCF) проверяет подлинность службы и отправляет сообщение только в том случае, если удостоверение службы совпадает с удостоверением, указанным в адресе конечной точки, используемом клиентом.  
  
 Обработка удостоверений включает следующие этапы.  
  
- Во время проектирования разработчик клиента определяет удостоверение службы на основе метаданных конечной точки (передаваемых через WSDL).  
  
- Во время выполнения клиентское приложение проверяет утверждения учетных данных безопасности службы, прежде чем пересылать ей какие-либо сообщения.  
  
 Обработка идентификаций на клиенте аналогична проверке подлинности клиента в службе. Защищенная служба не выполняет код до тех пор, пока не будет проведена проверка подлинности учетных данных клиента. Аналогично, клиент не отправляет сообщения службе до тех пор, пока не будет проведена проверка подлинности учетных данных службы, исходя из заранее известной информации на основе метаданных службы.  
  
 Свойство <xref:System.ServiceModel.EndpointAddress.Identity%2A> класса <xref:System.ServiceModel.EndpointAddress> представляет удостоверение службы, вызываемой клиентом. Служба публикует свойство <xref:System.ServiceModel.EndpointAddress.Identity%2A> в своих метаданных. Когда разработчик клиента запускает [средство служебной программы метаданных ServiceModel (Svcutil. exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) для конечной точки службы, созданная конфигурация содержит значение <xref:System.ServiceModel.EndpointAddress.Identity%2A> Свойства службы. Инфраструктура WCF (если она настроена с защитой) проверяет, что служба использует указанный идентификатор.  
  
> [!IMPORTANT]
> Метаданные содержат ожидаемое удостоверение службы, поэтому рекомендуется передавать метаданные службы через защищенные средства, например путем создания конечной точки HTTPS для службы. Дополнительные сведения см. [в разделе как защитить конечные точки метаданных](how-to-secure-metadata-endpoints.md).  
  
## <a name="identity-types"></a>Типы удостоверений  
 Служба может предоставлять шесть типов удостоверений. Каждый тип удостоверения соответствует элементу, который может содержаться в элементе `<identity>` в конфигурации. Используемый тип зависит от сценария и требований службы к безопасности. Типы удостоверений описаны в приведенной ниже таблице.  
  
|Тип удостоверения|Описание|Типичный сценарий|  
|-------------------|-----------------|----------------------|  
|Служба доменных имен (DNS)|Этот элемент следует использовать с сертификатами X.509 или учетными записями Windows. Он сравнивает DNS-имя, указанное в учетных данных, со значением, указанным в этом элементе.|Проверка DNS позволяет использовать сертификаты с DNS-именами или именами субъектов. Если сертификат повторно выдан с тем же DNS-именем или именем субъекта, тогда проверка удостоверения по-прежнему действительна. При повторной выдаче сертификата он получает новый ключ RSA, однако при этом сохраняется то же DNS-имя или имя субъекта. Это означает, что клиентам не нужно обновлять в удостоверении информацию о службе.|  
|Сертификат. Используется по умолчанию, если параметру `ClientCredentialType` присвоено значение "Certificate".|Этот элемент задает значение сертификата X.509 в кодировке Base64 для сравнения с клиентом.<br /><br /> Этот элемент также используется при использовании CardSpace в качестве учетных данных для проверки подлинности службы.|Этот элемент ограничивает проверку подлинности одним сертификатом на основе значения отпечатка. Это обеспечивает более строгую проверку подлинности, поскольку значения отпечатков уникальны. При этом следует учитывать следующее: если сертификат был повторно выдан с тем же именем субъекта, у него тем не менее будет новый отпечаток. Следовательно, клиенты могут проверить службу только в том случае, когда известен новый отпечаток. Дополнительные сведения о поиске отпечатка сертификата см. в разделе [как получить отпечаток сертификата](how-to-retrieve-the-thumbprint-of-a-certificate.md).|  
|Ссылка на сертификат|Идентичен описанному выше типу "Сертификат". Однако этот элемент позволяет задавать имя сертификата и сохранять расположение, из которого нужно получать сертификат.|Аналогичен описанному выше сценарию для типа "Сертификат".<br /><br /> Преимущество в том, что есть возможность изменить расположение хранилища сертификатов.|  
|RSA|Этот элемент задает значение ключа RSA для сравнения с клиентом. Он аналогичен типу "Сертификат", однако вместо использования отпечатка сертификата используется ключ RSA сертификата.|Проверка RSA позволяет ограничить проверку подлинности одним сертификатом с использованием его ключа RSA. Это позволяет выполнять более строгую проверку подлинности определенного ключа RSA, однако если значение ключа RSA будет изменено, служба больше не будет работать с существующими клиентами.|  
|Имя участника-пользователя (UPN). Используется по умолчанию, если параметру `ClientCredentialType` присвоено значение "Windows" и процесс службы выполняется не под одной из системных учетных записей.|Этот элемент задает имя участника-пользователя, под которым выполняется служба. См. раздел протокол и удостоверение Kerberos [При переопределении удостоверения службы для проверки подлинности](../extending/overriding-the-identity-of-a-service-for-authentication.md).|Это обеспечивает выполнение службы под определенной учетной записью пользователя Windows. В качестве учетной записи может использоваться либо учетная запись текущего пользователя, либо служба, запущенная под учетной записью определенного пользователя.<br /><br /> Для этого параметра используется безопасность Windows Kerberos, если служба выполняется под учетной записью домена в среде Active Directory.|  
|Имя участника-службы. Используется по умолчанию, если параметру `ClientCredentialType` присвоено значение "Windows" и процесс службы выполняется под одной из системных учетных записей: LocalService, LocalSystem или NetworkService.|Этот элемент задает имя участника-службы, связанное с учетной записью службы. См. раздел протокол и удостоверение Kerberos [При переопределении удостоверения службы для проверки подлинности](../extending/overriding-the-identity-of-a-service-for-authentication.md).|Это обеспечивает идентификацию службы с помощью имени участника-службы и определенной учетной записи Windows, связанной с этим именем.<br /><br /> Для связывания учетной записи компьютера для учетной записи пользователя службы можно воспользоваться средством Setspn.exe.<br /><br /> Этот параметр использует безопасность Windows Kerberos, если служба выполняется под одной из системных учетных записей или под учетной записью домена, с которой связано имя участника-службы, при условии что компьютер входит в домен в среде Active Directory.|  
  
## <a name="specifying-identity-at-the-service"></a>Задание удостоверения в службе  
 Как правило, нет необходимости задавать удостоверение в службе, поскольку выбор типа учетных данных клиента определяет тип удостоверения, предоставляемого в метаданных службы. Дополнительные сведения о переопределении или указании удостоверения службы см. [в разделе Переопределение удостоверения службы для проверки подлинности](../extending/overriding-the-identity-of-a-service-for-authentication.md).  
  
## <a name="using-the-identity-element-in-configuration"></a>Использование \<identity> элемента в конфигурации  
 Если изменить тип учетных данных клиента в привязке, ранее показанной сертификату `Certificate,` созданный WSDL будет содержать сериализованный сертификат X.509 в кодировке Base64, соответствующий значению удостоверения, как показано в следующем примере кода. Используется по умолчанию для всех типов учетных данных клиентов, за исключением Windows.  

 Можно изменить значение удостоверения службы по умолчанию или изменить тип удостоверения с помощью `<identity>` элемента в конфигурации или задав удостоверение в коде. В следующем коде конфигурации задается идентификатор DNS со значением `contoso.com`.  

## <a name="setting-identity-programmatically"></a>Задание удостоверения программным способом  
 Службе не нужно явно указывать удостоверение, так как WCF автоматически определяет ее. Однако WCF позволяет указать удостоверение в конечной точке, если это необходимо. В приведенном ниже примере кода добавляется новая конечная точка службы с определенным идентификатором DNS.  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="specifying-identity-at-the-client"></a>Назначение удостоверения в клиенте  
 Во время разработки клиентский разработчик обычно использует [средство служебной программы метаданных ServiceModel (Svcutil. exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md) для создания конфигурации клиента. Созданный файл конфигурации (предназначенный для использования клиентом) содержит удостоверение сервера. Например, приведенный ниже код создан на основе службы, в которой задан идентификатор DNS, как показано в предыдущем примере. Обратите внимание, что значение удостоверения конечной точки клиента совпадает с соответствующим значением службы. В этом случае, когда клиент получает учетные данные Windows (Kerberos) для службы, он ожидает значение `contoso.com`.  

 Если вместо Windows сертификат в службе задан в качестве клиентского типа учетных данных, тогда ожидается, что свойство DNS будет иметь значение `contoso.com`. (Если же свойство DNS имеет значение `null`, имя субъекта сертификата должно иметь значение `contoso.com`.)  
  
#### <a name="using-a-specific-value-for-identity"></a>Использование определенного значения для удостоверения  
 В приведенном ниже файле конфигурации клиента показано, каким образом в качестве удостоверения службы может ожидаться использование определенного значения. В приведенном ниже примере клиент может связываться с двумя конечными точками. Первая конечная точка определяется отпечатком сертификата, а вторая – ключом RSA сертификата. Другими словами, сертификатом, содержащим только пару открытого и закрытого ключей, который не был издан доверенным центром.  

## <a name="identity-checking-at-run-time"></a>Проверка удостоверения во время выполнения  
 Во время проектирования разработчик клиента определяет удостоверение сервера с помощью его метаданных. Во время выполнения проверка удостоверения выполняется перед вызовом конечных точек в службе.  
  
 Значение удостоверения привязано к типу проверки подлинности, указанному в метаданных; другими словами, к типу учетных данных, используемому в службе.  
  
 Если в канале настроена проверка подлинности с использованием протокола SSL на уровне сообщений или транспортном уровне с сертификатами X.509, действительны следующие значения удостоверения.  
  
- DNS. WCF гарантирует, что сертификат, предоставленный при подтверждении SSL, содержит атрибут DNS или `CommonName` (CN), равный значению, указанному в удостоверении DNS на клиенте. Обратите внимание, что эти проверки выполняются в дополнение к определению действительности сертификата сервера. По умолчанию WCF проверяет, что сертификат сервера выдан доверенным корневым центром сертификации.  
  
- Сертификат. Во время подтверждения SSL WCF гарантирует, что удаленная конечная точка предоставит точное значение сертификата, указанное в удостоверении.  
  
- Ссылка на сертификат. Аналогичен значению "Сертификат".  
  
- RSA. Во время подтверждения SSL, WCF гарантирует, что удаленная конечная точка предоставляет точный ключ RSA, указанный в удостоверении.  
  
 Если служба выполняет проверку подлинности с использованием протокола SSL на уровне сообщений или транспортном уровне с учетными данными Windows и согласует учетные данные, следующие значения удостоверения являются действительными.  
  
- DNS. Согласование проходит имя участника-службы, так что DNS-имя может быть проверено. Имя участника-службы указывается в формате `host/<dns name>`.  
  
- Имя участника-службы. Возвращается явное имя участника-службы, например `host/myservice`.  
  
- Имя участника-пользователя. Имя участника-пользователя учетной записи службы. Имя участника-пользователя — в формате `username` @ `domain` . Например, при выполнении службы под учетной записью пользователя может использоваться такое имя участника-пользователя, как `username@contoso.com`.  
  
 Назначать удостоверение программным путем (с использованием свойства <xref:System.ServiceModel.EndpointAddress.Identity%2A>) не обязательно. Если удостоверение не задано и используется тип учетных данных клиента Windows, по умолчанию имени участника-службы назначается значение, соответствующее имени узла в адресе конечной точки службы с префиксом "host/". Если удостоверение задано и в качестве типа учетных данных клиента применяется сертификат, по умолчанию используется значение `Certificate`. Это относится к безопасности как на уровне сообщений, так и на транспортном уровне.  
  
## <a name="identity-and-custom-bindings"></a>Удостоверение и пользовательские привязки  
 Поскольку удостоверение службы зависит от используемого типа привязки, при создании пользовательской привязки убедитесь, что передается требуемое удостоверение. Например, в приведенном ниже примере кода передаваемое удостоверение несовместимо с типом безопасности, поскольку удостоверение для привязки начальной загрузки защищенного диалога не соответствует удостоверению для привязки на конечной точке. Привязка защищенного диалога назначает идентификатор DNS, тогда как <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement> назначает удостоверение имени участника-пользователя или участника-службы.  
  
 [!code-csharp[C_Identity#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#8)]
 [!code-vb[C_Identity#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#8)]  
  
 Дополнительные сведения о правильном стеке элементов привязки для пользовательской привязки см. в разделе [Создание определяемых пользователем привязок](../extending/creating-user-defined-bindings.md). Дополнительные сведения о создании пользовательской привязки с помощью см <xref:System.ServiceModel.Channels.SecurityBindingElement> . в разделе [инструкции. Создание SecurityBindingElement для указанного режима проверки подлинности](how-to-create-a-securitybindingelement-for-a-specified-authentication-mode.md).  
  
## <a name="see-also"></a>Дополнительно

- [Практическое руководство. Создание пользовательской привязки с использованием элемента SecurityBindingElement](how-to-create-a-custom-binding-using-the-securitybindingelement.md)
- [Практическое руководство. Создание SecurityBindingElement для заданного режима проверки подлинности](how-to-create-a-securitybindingelement-for-a-specified-authentication-mode.md)
- [Практическое руководство. Создание пользовательского средства проверки идентификации клиентов](../extending/how-to-create-a-custom-client-identity-verifier.md)
- [Выбор типа учетных данных](selecting-a-credential-type.md)
- [Работа с сертификатами](working-with-certificates.md)
- [Служебное средство ServiceModel Metadata Utility Tool (Svcutil.exe)](../servicemodel-metadata-utility-tool-svcutil-exe.md)
- [Создание пользовательских привязок](../extending/creating-user-defined-bindings.md)
- [Практическое руководство. Получение отпечатка сертификата](how-to-retrieve-the-thumbprint-of-a-certificate.md)
