---
title: Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 9e891c6a-d960-45ea-904f-1a00e202d61a
ms.openlocfilehash: 2f15bf569da6127d6c9d27be255590ce3784d7a5
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59174620"
---
# <a name="using-dead-letter-queues-to-handle-message-transfer-failures"></a><span data-ttu-id="378c4-102">Использование очередей недоставленных сообщений для обработки сбоев при передаче сообщений</span><span class="sxs-lookup"><span data-stu-id="378c4-102">Using Dead-Letter Queues to Handle Message Transfer Failures</span></span>
<span data-ttu-id="378c4-103">Сообщения в очереди могут вызвать сбой доставки.</span><span class="sxs-lookup"><span data-stu-id="378c4-103">Queued messages can fail delivery.</span></span> <span data-ttu-id="378c4-104">Сообщения, во время доставки которых произошел сбой, записываются в очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-104">These failed messages are recorded in a dead-letter queue.</span></span> <span data-ttu-id="378c4-105">Сбой доставки может быть вызван такими причинами, как сбои сети, удаленная очередь, заполнение очереди, сбой проверки подлинности или сбой доставки по времени.</span><span class="sxs-lookup"><span data-stu-id="378c4-105">The failed delivery can be caused by reasons such as network failures, a deleted queue, a full queue, authentication failure, or a failure to deliver on time.</span></span>  
  
 <span data-ttu-id="378c4-106">Сообщения могут длительное время оставаться в очереди, если принимающее приложение не считывает их из очереди за отведенное время.</span><span class="sxs-lookup"><span data-stu-id="378c4-106">Queued messages can remain in the queue for a long time if the receiving application does not read them from the queue in a timely fashion.</span></span> <span data-ttu-id="378c4-107">Такое поведение может не быть свойственно чувствительным к времени сообщениям.</span><span class="sxs-lookup"><span data-stu-id="378c4-107">This behavior may not be appropriate for time-sensitive messages.</span></span> <span data-ttu-id="378c4-108">Критичные к времени сообщения имеют свойство срок жизни (TTL), заданное в привязке с очередью, которое указывает, насколько долго сообщения могут находиться в очереди до истечения срока действия.</span><span class="sxs-lookup"><span data-stu-id="378c4-108">Time-sensitive messages have a Time to Live (TTL) property set in the queued binding, which indicates how long the messages can be in the queue before they must expire.</span></span> <span data-ttu-id="378c4-109">Просроченные сообщения отправляются в специальную очередь, называемую очередью недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-109">Expired messages are sent to a special queue called the dead-letter queue.</span></span> <span data-ttu-id="378c4-110">Сообщения могут быть помещены в очередь недоставленных сообщений и по другим причинам, таким как превышение квоты очереди или сбой проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="378c4-110">Messages can also be put in a dead-letter queue for other reasons, such as exceeding a queue quota or because of authentication failure.</span></span>  
  
 <span data-ttu-id="378c4-111">Обычно для прочтения сообщений из очереди недоставленных сообщений и причин сбоя приложения записывают компенсирующую логику.</span><span class="sxs-lookup"><span data-stu-id="378c4-111">Generally, applications write compensation logic to read messages from the dead-letter queue and failure reasons.</span></span> <span data-ttu-id="378c4-112">Компенсирующая логика зависит от причины сбоя.</span><span class="sxs-lookup"><span data-stu-id="378c4-112">The compensation logic depends on the cause of the failure.</span></span> <span data-ttu-id="378c4-113">Например, в случае сбоя проверки подлинности можно исправить сертификат, прикрепленный к сообщению, и отправить сообщение повторно.</span><span class="sxs-lookup"><span data-stu-id="378c4-113">For example, in the case of authentication failure, you can correct the certificate attached with the message and resend the message.</span></span> <span data-ttu-id="378c4-114">Если сбой доставки произошел по причине достижения квоты целевой очереди, можно повторить попытку отправки в надежде, что проблема с квотой была устранена.</span><span class="sxs-lookup"><span data-stu-id="378c4-114">If delivery failed because the target queue quota was reached, you can reattempt delivery in the hope that the quota problem was resolved.</span></span>  
  
 <span data-ttu-id="378c4-115">Большинство систем организации очереди имеют общесистемную очередь недоставленных сообщений, в которой хранятся все сообщения данной системы, во время доставки которых произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="378c4-115">Most queuing systems have a system-wide dead-letter queue where all failed messages from that system are stored.</span></span> <span data-ttu-id="378c4-116">Очередь сообщений (MSMQ) имеет две общесистемные очереди недоставленных сообщений: общесистемная очередь недоставленных транзакционных сообщений, в которой хранятся сообщения, по причине сбоя не доставленные в транзакционную очередь, и общесистемная очередь недоставленных нетранзакционных сообщений, в которой хранятся сообщения, по причине сбоя не доставленные в нетранзакционную очередь.</span><span class="sxs-lookup"><span data-stu-id="378c4-116">Message Queuing (MSMQ) provides two system-wide dead-letter queues: a transactional system-wide dead-letter queue that stores messages that failed delivery to the transactional queue and a non-transactional system-wide dead-letter queue that stores messages that failed delivery to the non-transactional queue.</span></span> <span data-ttu-id="378c4-117">Если два клиента отправляют сообщения в двух разных служб, и поэтому разные очереди в WCF совместно используют одну службу MSMQ для отправки, то это может быть смесь сообщений в очереди недоставленных сообщений-системы.</span><span class="sxs-lookup"><span data-stu-id="378c4-117">If two clients are sending messages to two different services, and therefore different queues in WCF are sharing the same MSMQ service to send, then it is possible to have a mix of messages in the system dead-letter queue.</span></span> <span data-ttu-id="378c4-118">Это не всегда оптимально.</span><span class="sxs-lookup"><span data-stu-id="378c4-118">This is not always optimal.</span></span> <span data-ttu-id="378c4-119">В некоторых случаях (по соображениям безопасности, например), может быть нежелательно, чтобы один клиент прочел сообщения другого клиента из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-119">In several cases (security, for example), you may not want one client to read another client's messages from a dead-letter queue.</span></span> <span data-ttu-id="378c4-120">При использовании общей очереди недоставленных сообщений клиенты также вынуждены просматривать всю очередь, чтобы найти отправленное ими сообщение, что, в зависимости от количества сообщений в очереди недоставленных сообщений, может оказаться чрезмерно дорого.</span><span class="sxs-lookup"><span data-stu-id="378c4-120">A shared dead-letter queue also requires clients to browse through the queue to find a message that they sent, which can be prohibitively expensive based on the number of messages in the dead-letter queue.</span></span> <span data-ttu-id="378c4-121">Таким образом, в WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` и MSMQ на [!INCLUDE[wv](../../../../includes/wv-md.md)] предоставляют пользовательскую очередь недоставленных сообщений-(иногда называют в очередь недоставленных сообщений-конкретного приложения).</span><span class="sxs-lookup"><span data-stu-id="378c4-121">Therefore, in WCF`NetMsmqBinding`, `MsmqIntegrationBinding,` and MSMQ on [!INCLUDE[wv](../../../../includes/wv-md.md)] provide a custom dead-letter queue (sometimes referred to as an application-specific dead-letter queue).</span></span>  
  
 <span data-ttu-id="378c4-122">Пользовательская очередь недоставленных сообщений обеспечивает изоляцию между клиентами, использующими для отправки сообщений одну службу MSMQ.</span><span class="sxs-lookup"><span data-stu-id="378c4-122">The custom dead-letter queue provides isolation between clients that share the same MSMQ service to send messages.</span></span>  
  
 <span data-ttu-id="378c4-123">На [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] и [!INCLUDE[wxp](../../../../includes/wxp-md.md)], Windows Communication Foundation (WCF) предоставляет очередь недоставленных всей системы для всех клиентских приложений в очереди.</span><span class="sxs-lookup"><span data-stu-id="378c4-123">On [!INCLUDE[ws2003](../../../../includes/ws2003-md.md)] and [!INCLUDE[wxp](../../../../includes/wxp-md.md)], Windows Communication Foundation (WCF) provides a system-wide dead-letter queue for all queued client applications.</span></span> <span data-ttu-id="378c4-124">На [!INCLUDE[wv](../../../../includes/wv-md.md)], WCF предоставляет очередь недоставленных сообщений для каждого приложения в очереди клиента.</span><span class="sxs-lookup"><span data-stu-id="378c4-124">On [!INCLUDE[wv](../../../../includes/wv-md.md)], WCF provides a dead-letter queue for each queued client application.</span></span>  
  
## <a name="specifying-use-of-the-dead-letter-queue"></a><span data-ttu-id="378c4-125">Указание использования очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="378c4-125">Specifying Use of the Dead-Letter Queue</span></span>  
 <span data-ttu-id="378c4-126">Очередь недоставленных сообщений находится в диспетчере очереди отправляющего приложения.</span><span class="sxs-lookup"><span data-stu-id="378c4-126">A dead-letter queue is in the queue manager of the sending application.</span></span> <span data-ttu-id="378c4-127">В диспетчере очереди хранятся сообщения с истекшим сроком или сообщения, во время передачи или доставки которых произошел сбой.</span><span class="sxs-lookup"><span data-stu-id="378c4-127">It stores messages that have expired or that have failed transfer or delivery.</span></span>  
  
 <span data-ttu-id="378c4-128">Привязка имеет следующие свойства очереди недоставленных писем.</span><span class="sxs-lookup"><span data-stu-id="378c4-128">The binding has the following dead-letter queue properties:</span></span>  
  
-   <xref:System.ServiceModel.MsmqBindingBase.DeadLetterQueue%2A>  
  
-   <xref:System.ServiceModel.MsmqBindingBase.CustomDeadLetterQueue%2A>  
  
## <a name="reading-messages-from-the-dead-letter-queue"></a><span data-ttu-id="378c4-129">Чтение сообщений из очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="378c4-129">Reading Messages from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="378c4-130">Приложение, которое считывает сообщения из очереди недоставленных сообщений-аналогичен службы WCF, которая считывает из очереди приложения, за исключением следующих незначительных отличий:</span><span class="sxs-lookup"><span data-stu-id="378c4-130">An application that reads messages out of a dead-letter queue is similar to a WCF service that reads from an application queue, except for the following minor differences:</span></span>  
  
-   <span data-ttu-id="378c4-131">Для чтения сообщений из системной очереди недоставленных транзакционных сообщений универсальный код ресурса (URI) должен иметь вид net.msmq://localhost/system$;DeadXact.</span><span class="sxs-lookup"><span data-stu-id="378c4-131">To read messages from a system transactional dead-letter queue, the Uniform Resource Identifier (URI) must be of the form: net.msmq://localhost/system$;DeadXact.</span></span>  
  
-   <span data-ttu-id="378c4-132">Для чтения сообщений из системной очереди недоставленных нетранзакционных сообщений код URI должен иметь вид net.msmq://localhost/system$;DeadLetter.</span><span class="sxs-lookup"><span data-stu-id="378c4-132">To read messages from a system non-transactional dead-letter queue, the URI must be of the form: net.msmq://localhost/system$;DeadLetter.</span></span>  
  
-   <span data-ttu-id="378c4-133">Для чтения сообщений из пользовательской очереди недоставленных, код URI должен иметь вид: NET.MSMQ://localhost/Private/\<*custom-dlq-name*> где *custom-dlq-name* имя пользовательского очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-133">To read messages from a custom dead-letter queue, the URI must be of the form:net.msmq://localhost/private/\<*custom-dlq-name*> where *custom-dlq-name* is the name of the custom dead-letter queue.</span></span>  
  
 <span data-ttu-id="378c4-134">Дополнительные сведения о том, как адрес очереди см. в разделе [конечных точек служб и адресация очереди](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span><span class="sxs-lookup"><span data-stu-id="378c4-134">For more information about how to address queues, see [Service Endpoints and Queue Addressing](../../../../docs/framework/wcf/feature-details/service-endpoints-and-queue-addressing.md).</span></span>  
  
 <span data-ttu-id="378c4-135">Стек WCF на стороне получателя соответствует адресам, которые служба прослушивает адрес из сообщения.</span><span class="sxs-lookup"><span data-stu-id="378c4-135">The WCF stack on the receiver matches addresses that the service is listening on with the address on the message.</span></span> <span data-ttu-id="378c4-136">Если адреса совпадают, сообщение отправляется, если нет - не отправляется.</span><span class="sxs-lookup"><span data-stu-id="378c4-136">If the addresses match, the message is dispatched; if not, the message is not dispatched.</span></span> <span data-ttu-id="378c4-137">Это может создать проблемы при чтении сообщений из очереди недоставленных сообщений, поскольку сообщения в очереди недоставленных сообщений обычно адресованы не службе и не службе очереди отправленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-137">This can cause problems when reading from the dead-letter queue, because messages in the dead-letter queue are typically addressed to the service and not the dead-letter queue service.</span></span> <span data-ttu-id="378c4-138">Поэтому для чтения службой сообщений из очереди недоставленных сообщений необходима установка фильтра по адресу `ServiceBehavior`, которая дает команду стеку считать совпадающими все сообщения в очереди независимо от адресата.</span><span class="sxs-lookup"><span data-stu-id="378c4-138">Therefore, the service reading from the dead-letter queue must install an address filter `ServiceBehavior` that instructs the stack to match all messages in the queue independently of the addressee.</span></span> <span data-ttu-id="378c4-139">В частности, нужно добавить `ServiceBehavior` при помощи параметра <xref:System.ServiceModel.AddressFilterMode.Any>в службу, считывающую сообщения из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-139">Specifically, you must add a `ServiceBehavior` with the <xref:System.ServiceModel.AddressFilterMode.Any> parameter to the service reading messages from the dead-letter queue.</span></span>  
  
## <a name="poison-message-handling-from-the-dead-letter-queue"></a><span data-ttu-id="378c4-140">Обработка подозрительных сообщений из очереди недоставленных сообщений</span><span class="sxs-lookup"><span data-stu-id="378c4-140">Poison Message Handling from the Dead-Letter Queue</span></span>  
 <span data-ttu-id="378c4-141">При некоторых условиях в очередях недоставленных сообщений возможна обработка подозрительных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-141">Poison message handling is available on dead-letter queues, with some conditions.</span></span> <span data-ttu-id="378c4-142">Поскольку создать вложенные очереди из системных очередей нельзя, `ReceiveErrorHandling` при прочтении из системной очереди недоставленных сообщений не может быть установлен в значение `Move`.</span><span class="sxs-lookup"><span data-stu-id="378c4-142">Because you cannot create sub-queues from system queues, when reading from the system dead-letter queue, the `ReceiveErrorHandling` cannot be set to `Move`.</span></span> <span data-ttu-id="378c4-143">Обратите внимание, что при чтении сообщений из пользовательской очереди недоставленных сообщений могут использоваться вложенные очереди, и, таким образом, `Move` является подходящим средством удаления подозрительного сообщения.</span><span class="sxs-lookup"><span data-stu-id="378c4-143">Note that if you are reading from a custom dead-letter queue, you can have sub-queues and, therefore, `Move` is a valid disposition for the poison message.</span></span>  
  
 <span data-ttu-id="378c4-144">Если `ReceiveErrorHandling` установлен в значение `Reject`, подозрительные сообщения при чтении из пользовательской очереди недоставленных сообщений помещаются в системную очередь недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-144">When `ReceiveErrorHandling` is set to `Reject`, when reading from the custom dead letter queue, the poison message is put in the system dead-letter queue.</span></span> <span data-ttu-id="378c4-145">При чтении из системной очереди недоставленных сообщений сообщение отбрасывается (удаляется).</span><span class="sxs-lookup"><span data-stu-id="378c4-145">If reading from the system dead-letter queue, the message is dropped (purged).</span></span> <span data-ttu-id="378c4-146">При возврате из системной очереди недоставленных сообщений в MSMQ сообщение отбрасывается (удаляется).</span><span class="sxs-lookup"><span data-stu-id="378c4-146">A reject from a system dead-letter queue in MSMQ drops (purges) the message.</span></span>  
  
## <a name="example"></a><span data-ttu-id="378c4-147">Пример</span><span class="sxs-lookup"><span data-stu-id="378c4-147">Example</span></span>  
 <span data-ttu-id="378c4-148">В приведенном ниже примере показано, как создавать очередь недоставленных сообщений и как использовать ее для обработки просроченных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-148">The following example shows how to create a dead-letter queue and how to use it to process expired messages.</span></span> <span data-ttu-id="378c4-149">Пример основан на примере в [как: Обмен сообщениями с конечными точками WCF в очереди](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span><span class="sxs-lookup"><span data-stu-id="378c4-149">The example is based on the example in [How to: Exchange Queued Messages with WCF Endpoints](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md).</span></span> <span data-ttu-id="378c4-150">В приведенном ниже примере показано, как писать клиентский код для службы обработки заказов, в которой используется очередь недоставленных сообщений для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="378c4-150">The following example shows how to write the client code to the order processing service that uses a dead-letter queue for each application.</span></span> <span data-ttu-id="378c4-151">В примере также показано, как обрабатывать сообщения из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-151">The example also shows how to process messages from the dead-letter queue.</span></span>  
  
 <span data-ttu-id="378c4-152">В следующем примере показан код для клиента, задающего очередь недоставленных сообщений для каждого приложения.</span><span class="sxs-lookup"><span data-stu-id="378c4-152">The following is code for a client that specifies a dead-letter queue for each application.</span></span>  
  
 [!code-csharp[S_DeadLetter#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/client.cs#1)]
 [!code-vb[S_DeadLetter#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/client.vb#1)]  
  
 <span data-ttu-id="378c4-153">В следующем примере показан код для файла конфигурации клиента.</span><span class="sxs-lookup"><span data-stu-id="378c4-153">The following is code for the client configuration file.</span></span>  

 <span data-ttu-id="378c4-154">В следующем примере показан код для службы обработки сообщений из очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-154">The following is code for a service processing messages from a dead-letter queue.</span></span>  
  
 [!code-csharp[S_DeadLetter#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_deadletter/cs/dlservice.cs#3)]
 [!code-vb[S_DeadLetter#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/s_deadletter/vb/dlservice.vb#3)]  
  
 <span data-ttu-id="378c4-155">В следующем примере показан код для файла конфигурации службы очереди недоставленных сообщений.</span><span class="sxs-lookup"><span data-stu-id="378c4-155">The following is code for the dead-letter queue service configuration file.</span></span>  

## <a name="see-also"></a><span data-ttu-id="378c4-156">См. также</span><span class="sxs-lookup"><span data-stu-id="378c4-156">See also</span></span>

- [<span data-ttu-id="378c4-157">Общие сведения об очередях</span><span class="sxs-lookup"><span data-stu-id="378c4-157">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)
- [<span data-ttu-id="378c4-158">Практическое руководство. Обмен сообщениями в очереди с конечными точками WCF</span><span class="sxs-lookup"><span data-stu-id="378c4-158">How to: Exchange Queued Messages with WCF Endpoints</span></span>](../../../../docs/framework/wcf/feature-details/how-to-exchange-queued-messages-with-wcf-endpoints.md)
- [<span data-ttu-id="378c4-159">Обработка подозрительных сообщений</span><span class="sxs-lookup"><span data-stu-id="378c4-159">Poison Message Handling</span></span>](../../../../docs/framework/wcf/feature-details/poison-message-handling.md)
