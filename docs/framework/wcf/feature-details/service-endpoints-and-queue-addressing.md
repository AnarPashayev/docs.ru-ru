---
title: Конечные точки служб и адресация очереди
ms.date: 03/30/2017
ms.assetid: 7d2d59d7-f08b-44ed-bd31-913908b83d97
ms.openlocfilehash: 4064b13b00d44f90a372df5364406fb16c1da9fd
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59172527"
---
# <a name="service-endpoints-and-queue-addressing"></a>Конечные точки служб и адресация очереди
В этом разделе рассматриваются принципы обращения клиентов к службам, выполняющим чтение из очередей, и сопоставления конечных точек служб с очередями. Напоминаем ниже приведена схема классического Windows Communication Foundation (WCF) в очереди развертывания приложения.  
  
 ![В очереди схемы приложения](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg "распределенных очереди Значной")  
  
 Чтобы отправить службе сообщение, клиент адресует это сообщение целевой очереди. Чтобы прочитать сообщение из очереди, служба задает целевую очередь в качестве своего адреса прослушивания. Адресация в WCF основан на универсальный код ресурса URI хотя имена очередей сообщений (MSMQ) не основаны на URI. Поэтому крайне важно понимать принципы адресации к очередям, созданные в MSMQ, с помощью WCF.  
  
## <a name="msmq-addressing"></a>Адресация к очереди сообщений MSMQ  
 В MSMQ очереди обозначаются с помощью путей и имен форматов. Путь указывает имя узла и `QueueName`. Также можно добавить `Private$` между именем узла и `QueueName`, чтобы указать частную очередь, не опубликованную в службе каталогов Active Directory.  
  
 Имена путей сопоставляются именам «FormatName», чтобы определить дополнительные аспекты адреса, включая протокол передачи данных диспетчера маршрутизации и очереди. Диспетчер очередей поддерживает два протокола передачи данных: собственный протокол MSMQ и протокол SRMP.  
  
 Дополнительные сведения о пути и формат имен очередей MSMQ, см. в разделе [сведения об очередях сообщений](https://go.microsoft.com/fwlink/?LinkId=94837).  
  
## <a name="netmsmqbinding-and-service-addressing"></a>NetMsmqBinding и адресация к службе  
 При адресации сообщения службе выбирается схема из URI (в зависимости от транспорта, используемого для передачи данных). Каждый транспорт в WCF имеет уникальную схему. Схема должна отражать тип транспорта, используемого для передачи данных. Например: net.tcp, net.pipe, HTTP и т. п.  
  
 Транспорт очередей MSMQ в WCF предоставляет схему net.msmq. Любое сообщение, адресованное с помощью схемы net.msmq, отправляется с помощью `NetMsmqBinding` через транспортный канал очередей MSMQ.  
  
 Адресация очереди в WCF основан на следующем шаблоне:  
  
 NET.MSMQ: / / \< *имя узла*> / [закрытый /] \< *имя очереди*>  
  
 Здесь:  
  
-   \<*Имя узла*> — имя компьютера, на котором размещена целевая очередь.  
  
-   [private] - необязательный элемент. Используется при адресации к целевой очереди, которая является частной. При адресации к общей очереди не допускается указывать «private». Обратите внимание, что, в отличие от путей MSMQ знак «$» отсутствует в форме WCF URI.  
  
-   \<*Имя очереди*> — имя очереди. Имя очереди также может относиться к вложенной очереди. Таким образом \< *имя очереди*> = \< *name-of-queue*> [; *имя вложенной очереди*].  
  
 Пример 1. Чтобы устранить частной очереди PurchaseOrders, размещенной на компьютере ABC.adatum.com, URI будет net.msmq://abc.adatum.com/private/PurchaseOrders.  
  
 Example2: Для адресации к общей очереди AccountsPayable, размещенной на компьютере DEF.adatum.com, URI будет net.msmq://def.adatum.com/AccountsPayable.  
  
 Адрес очереди используется прослушивателем как код URI прослушивания, из которого выполняется чтение сообщений. Другими словами, адрес очереди подобен порту прослушивания сокета TCP.  
  
 Конечная точка, выполняющая чтение из очереди, должна указывать адрес очереди с помощью указанной выше схемы при открывании узла службы (ServiceHost). Примеры, см. в разделе [Net привязки MSMQ](../../../../docs/framework/wcf/samples/net-msmq-binding.md).  
  
### <a name="multiple-contracts-in-a-queue"></a>Несколько контрактов в очереди  
 Сообщения в очереди могут реализовывать различные контракты. В данном случае для успешного чтения и обработки сообщений особенно важно, чтобы выполнялось одно из следующих требований:  
  
-   Укажите конечную точку для службы, реализующей все контракты. Этот способ является рекомендуемым.  
  
-   Укажите несколько конечных точек с различными контрактами, но убедитесь, что во всех конечных точках используется один и тот же объект `NetMsmqBinding`. Логика отправки сообщений в модели ServiceModel использует тот же цикл обработки сообщений, считывающий сообщения из транспортного канала для отправки, что в конечном итоге приводит к демультиплексированию сообщений на различные конечные точки на основе контракта. Для пары «URI прослушивания/привязка» создается цикл обработки сообщений. Адрес очереди используется прослушивателем в очереди как URI прослушивания. Использование одного объекта привязки всеми конечными точками обеспечивает использование одного цикла обработки сообщений для чтения сообщения и его демультиплексирования на соответствующие конечные точки на основе контракта.  
  
### <a name="srmp-messaging"></a>Обмен сообщениями SRMP  
 Как указано выше, можно использовать протокол SRMP для передачи между очередями. Этот прием обычно используется, когда транспорт HTTP передает сообщения между очередью передачи и целевой очередью.  
  
 Чтобы воспользоваться протоколом SRMP, адресуйте сообщения с помощью схемы URI net.msmq, как указано выше, и укажите один из двух протоколов (SRMP или защищенный SRMP) в свойстве `QueueTransferProtocol` элемента `NetMsmqBinding`.  
  
 Указать свойство `QueueTransferProtocol` можно только при отправке. Оно указывает, какой именно протокол передачи между очередями используется клиентом.  
  
### <a name="using-active-directory"></a>Использование Active Directory  
 В очереди сообщений MSMQ предусмотрена поддержка интеграции с Active Directory. Чтобы установить MSMQ с интеграцией с Active Directory, компьютер должен быть частью домена Windows. Active Directory используется для публикации очередей для обнаружения; называемых *общих очередей*. При адресации к очереди можно разрешить ее (т. е. узнать ее идентификатор) с помощью Active Directory. Это похоже на разрешение IP-адреса сетевого имени с помощью службы доменных имен (DNS). Свойство `UseActiveDirectory` элемента `NetMsmqBinding` принадлежит к типу Boolean и указывает, должен ли канал в очереди использовать Active Directory для разрешения URI очереди. По умолчанию для этого свойства установлено значение `false`. Если свойству `UseActiveDirectory` задано значение `true`, то канал в очереди преобразует URI вида net.msmq:// в имя формата с помощью Active Directory.  
  
 Свойство `UseActiveDirectory` имеет значение только для клиента, отправляющего сообщение, поскольку оно используется для разрешения адреса очереди при отправке сообщений.  
  
### <a name="mapping-netmsmq-uri-to-message-queuing-format-names"></a>Сопоставление URI net.msmq именам форматов MSMQ  
 Канал в очереди обрабатывает сопоставление предоставленного ему имени URI net.msmq именам форматов MSMQ. В следующей таблице приведены общие правила их сопоставления.  
  
|Адрес очереди WCF, основанный на URI|Используется свойство Active Directory|Свойство протокола передачи между очередями|Результирующие имена форматов MSMQ|  
|----------------------------------|-----------------------------------|--------------------------------------|---------------------------------|  
|NET.MSMQ://\<имя_компьютера >/private/abc|False (по умолчанию)|Native (по умолчанию)|DIRECT=OS:имя_компьютера\private$\abc|  
|NET.MSMQ://\<имя_компьютера >/private/abc|False|SRMP|DIRECT =http://machine/msmq/private$/ abc|  
|NET.MSMQ://\<имя_компьютера >/private/abc|True|машинный код;|PUBLIC=guid (идентификатор GUID очереди)|  
  
### <a name="reading-messages-from-the-dead-letter-queue-or-the-poison-message-queue"></a>Чтение сообщений из очереди недоставленных сообщений или из очереди подозрительных сообщений  
 Для чтения сообщений из очереди подозрительных сообщений, являющейся вложенной очередью целевой очереди, откройте `ServiceHost`, указав адрес вложенной очереди.  
  
 Пример Это служба, которая считывает из очереди подозрительных сообщений частной очереди PurchaseOrders с локального компьютера позволит устранить net.msmq://localhost/private/PurchaseOrders;poison.  
  
 Для чтения сообщений из системной очереди недоставленных транзакционных сообщений код URI должен иметь следующий вид: net.msmq://localhost/system$;DeadXact.  
  
 Для чтения сообщений из системной очереди недоставленных нетранзакционных сообщений код URI должен иметь следующий вид: net.msmq://localhost/system$;DeadLetter.  
  
 При использовании пользовательской очереди недоставленных сообщений обратите внимание, что эта очередь должна находиться на локальном компьютере. Таким образом, код URI очереди недоставленных сообщений быть только таким:  
  
 NET.MSMQ: //localhost/ [закрытый /] \< *custom-очередь недоставленных сообщений буквы — имя очереди*>.  
  
 Службы WCF проверяет, что все полученные сообщения адресованы в определенную очередь, в который он прослушивает. Если очередь назначения сообщения не соответствует очереди, в которой оно содержится, служба не обрабатывает сообщение. Если служба прослушивает очередь недоставленных сообщений, эту проблему необходимо решить обязательно, поскольку сообщения в такой очереди всегда адресованы в другое расположение. Для чтения сообщений из очереди недоставленных или подозрительных сообщений необходимо использовать `ServiceBehavior` и параметр <xref:System.ServiceModel.AddressFilterMode.Any>. Например, см. в разделе [очереди недоставленных сообщений](../../../../docs/framework/wcf/samples/dead-letter-queues.md).  
  
## <a name="msmqintegrationbinding-and-service-addressing"></a>MsmqIntegrationBinding и адресация к службе  
 `MsmqIntegrationBinding` используется для обмена информацией с традиционными приложениями MSMQ. Чтобы упростить взаимодействие с существующими приложениями MSMQ, WCF поддерживает только формат-имя и адресации. Таким образом, сообщения, отправленные с помощью этой привязки, должны соответствовать следующей схеме URI:  
  
 msmq.formatname:\<*MSMQ-format-name*>>  
  
 MSMQ-формат имя имеет форму, указанную для MSMQ в [сведения об очередях сообщений](https://go.microsoft.com/fwlink/?LinkId=94837).  
  
 Обратите внимание, что можно использовать только прямые имена форматов, а также открытые и закрытые имена форматов (требуется интеграция Active Directory) при получении сообщений из очереди с помощью `MsmqIntegrationBinding`. Впрочем, рекомендуется использовать прямые имена форматов. Например, в системе [!INCLUDE[wv](../../../../includes/wv-md.md)] использование любых других имен форматов приводит к ошибке, поскольку система пытается открыть вложенную очередь, что возможно только с использованием прямых имен форматов.  
  
 При адресации к SRMP с помощью `MsmqIntegrationBinding` не требуется добавлять /msmq/ к прямому имени формата для отправки с помощью служб IIS. Пример: При адресации очереди протокола abc, с помощью SRMP вместо DIRECT =http://adatum.com/msmq/private$/ abc следует использовать DIRECT =http://adatum.com/private$/ abc.  
  
 Обратите внимание, что нельзя использовать адресацию net.msmq:// вместе с `MsmqIntegrationBinding`. Так как `MsmqIntegrationBinding` поддерживает произвольный MSMQ формат имени адресацию, можно использовать службы WCF, использующей эту привязку для использования многоадресной рассылки и распространения списка функций в MSMQ. Единственное исключение: необходимо указать `CustomDeadLetterQueue` при использовании `MsmqIntegrationBinding`. Требуемая форма: net.msmq://, как и при указании с помощью `NetMsmqBinding`.  
  
## <a name="see-also"></a>См. также

- [Размещение веб-узлов в приложении, использующем очереди](../../../../docs/framework/wcf/feature-details/web-hosting-a-queued-application.md)
