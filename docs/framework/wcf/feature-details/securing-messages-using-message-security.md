---
title: Защита сообщений с использованием средств обеспечения безопасности сообщений
ms.date: 03/30/2017
ms.assetid: a17ebe67-836b-4c52-9a81-2c3d58e225ee
ms.openlocfilehash: 1098057042c0842161258fd081d3ee63e82b4c5f
ms.sourcegitcommit: 2e95559d957a1a942e490c5fd916df04b39d73a9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2019
ms.locfileid: "72395705"
---
# <a name="securing-messages-using-message-security"></a><span data-ttu-id="d4b42-102">Защита сообщений с использованием средств обеспечения безопасности сообщений</span><span class="sxs-lookup"><span data-stu-id="d4b42-102">Securing Messages Using Message Security</span></span>
<span data-ttu-id="d4b42-103">В этом разделе обсуждается безопасность сообщений WCF при использовании <xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="d4b42-103">This section discusses WCF message security when using <xref:System.ServiceModel.NetMsmqBinding>.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="d4b42-104">Перед чтением этого раздела рекомендуется ознакомиться с [основными понятиями безопасности](../../../../docs/framework/wcf/feature-details/security-concepts.md).</span><span class="sxs-lookup"><span data-stu-id="d4b42-104">Before reading through this topic, it is recommended that you read [Security Concepts](../../../../docs/framework/wcf/feature-details/security-concepts.md).</span></span>  
  
 <span data-ttu-id="d4b42-105">На следующем рисунке представлена концептуальная модель обмена данными в очереди с помощью WCF.</span><span class="sxs-lookup"><span data-stu-id="d4b42-105">The following illustration provides a conceptual model of queued communication using WCF.</span></span> <span data-ttu-id="d4b42-106">Для объяснения принципов безопасности транспорта</span><span class="sxs-lookup"><span data-stu-id="d4b42-106">This illustration and terminology are used to explain</span></span>  
  
 <span data-ttu-id="d4b42-107">используются следующие терминология и рисунки.</span><span class="sxs-lookup"><span data-stu-id="d4b42-107">transport security concepts.</span></span>  
  
 <span data-ttu-id="d4b42-108">![Диаграмма приложений в очереди](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg "Схема распределенной очереди")</span><span class="sxs-lookup"><span data-stu-id="d4b42-108">![Queued Application Diagram](../../../../docs/framework/wcf/feature-details/media/distributed-queue-figure.jpg "Distributed-Queue-Figure")</span></span>  
  
 <span data-ttu-id="d4b42-109">При отправке сообщений в очереди с помощью WCF сообщение WCF прикрепляется в качестве тела сообщения MSMQ.</span><span class="sxs-lookup"><span data-stu-id="d4b42-109">When sending queued messages using WCF, the WCF message is attached as a body of the Message Queuing (MSMQ) message.</span></span> <span data-ttu-id="d4b42-110">В то время как безопасность транспорта обеспечивает безопасность всего сообщения MSMQ, безопасность сообщений (или протокол SOAP) обеспечивает безопасность только тела сообщения MSMQ.</span><span class="sxs-lookup"><span data-stu-id="d4b42-110">While transport security secures the entire MSMQ message, message (or SOAP) security only secures the body of the MSMQ message.</span></span>  
  
 <span data-ttu-id="d4b42-111">Ключевым принципом безопасности сообщений является обеспечение безопасности сообщения клиентом для принимающего приложения (службы), в отличие от безопасности транспорта, когда клиент обеспечивает безопасность сообщения для целевой очереди.</span><span class="sxs-lookup"><span data-stu-id="d4b42-111">The key concept of message security is that the client secures the message for the receiving application (service), unlike transport security where the client secures the message for the Target Queue.</span></span> <span data-ttu-id="d4b42-112">Таким образом, служба MSMQ не играет никакой части при защите сообщения WCF с помощью безопасности сообщений.</span><span class="sxs-lookup"><span data-stu-id="d4b42-112">As such, MSMQ plays no part when securing the WCF message using message security.</span></span>  
  
 <span data-ttu-id="d4b42-113">Безопасность сообщений WCF добавляет заголовки безопасности в сообщение WCF, которое интегрируется с существующими инфраструктурами безопасности, например сертификатом или протоколом Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d4b42-113">WCF message security adds security headers to the WCF message that integrate with existing security infrastructures, such as a certificate or the Kerberos protocol.</span></span>  
  
## <a name="message-credential-type"></a><span data-ttu-id="d4b42-114">Типы учетных данных сообщений</span><span class="sxs-lookup"><span data-stu-id="d4b42-114">Message Credential Type</span></span>  
 <span data-ttu-id="d4b42-115">С помощью безопасности сообщений служба и клиент могут предоставить учетные данные для двусторонней проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="d4b42-115">Using message security, the service and client can present credentials to authenticate each another.</span></span> <span data-ttu-id="d4b42-116">Включить безопасность сообщений можно, установив для режима <xref:System.ServiceModel.NetMsmqBinding.Security%2A> значение `Message` или `Both` (то есть использование и безопасности транспорта, и безопасности сообщений).</span><span class="sxs-lookup"><span data-stu-id="d4b42-116">You can select message security by setting the <xref:System.ServiceModel.NetMsmqBinding.Security%2A> mode to `Message` or `Both` (that is, use both transport security and message security).</span></span>  
  
 <span data-ttu-id="d4b42-117">Служба может использовать свойство <xref:System.ServiceModel.ServiceSecurityContext.Current%2A> для проверки учетных данных, подтверждающих подлинность клиента.</span><span class="sxs-lookup"><span data-stu-id="d4b42-117">The service can use the <xref:System.ServiceModel.ServiceSecurityContext.Current%2A> property to inspect the credential used to authenticate the client.</span></span> <span data-ttu-id="d4b42-118">Это свойство также может использоваться на последующих этапах авторизации, применяемых службой.</span><span class="sxs-lookup"><span data-stu-id="d4b42-118">This can also be used for further authorization checks that the service chooses to implement.</span></span>  
  
 <span data-ttu-id="d4b42-119">В этом разделе описываются различные типы учетных данных и их использование с очередями.</span><span class="sxs-lookup"><span data-stu-id="d4b42-119">This section explains the different credential types and how to use them with queues.</span></span>  
  
### <a name="certificate"></a><span data-ttu-id="d4b42-120">Сертификат</span><span class="sxs-lookup"><span data-stu-id="d4b42-120">Certificate</span></span>  
 <span data-ttu-id="d4b42-121">Этот тип учетных данных сертификата использует сертификат X.509 для идентификации службы и клиента.</span><span class="sxs-lookup"><span data-stu-id="d4b42-121">The certificate credential type uses an X.509 certificate to identify the service and the client.</span></span>  
  
 <span data-ttu-id="d4b42-122">В типичном сценарии доверенный центр сертификации издает действительный сертификат для клиента и службы.</span><span class="sxs-lookup"><span data-stu-id="d4b42-122">In a typical scenario, the client and the service are issued a valid certificate by a trusted certification authority.</span></span> <span data-ttu-id="d4b42-123">Затем устанавливается соединение, клиент проверяет допустимость службы, обращаясь к ее сертификату для определения ее надежности.</span><span class="sxs-lookup"><span data-stu-id="d4b42-123">Then the connection is established, the client authenticates the validity of the service using the service's certificate to decide whether it can trust the service.</span></span> <span data-ttu-id="d4b42-124">Аналогичным образом служба обращается к сертификату клиента для проверки надежности клиента.</span><span class="sxs-lookup"><span data-stu-id="d4b42-124">Similarly, the service uses the client's certificate to validate the client trust.</span></span>  
  
 <span data-ttu-id="d4b42-125">Так как очереди отключены от сети, клиент и служба могут быть не подключены к сети одновременно.</span><span class="sxs-lookup"><span data-stu-id="d4b42-125">Given the disconnected nature of queues, the client and the service may not be online at the same time.</span></span> <span data-ttu-id="d4b42-126">В таком случае клиент и служба должны обмениваться сертификатами по внештатному каналу.</span><span class="sxs-lookup"><span data-stu-id="d4b42-126">As such, the client and service have to exchange certificates out-of-band.</span></span> <span data-ttu-id="d4b42-127">В частности, на основании наличия сертификата службы (который может быть привязан к центру сертификации) в доверенном хранилище клиент должен заключить, что взаимодействие осуществляется с нужной службой.</span><span class="sxs-lookup"><span data-stu-id="d4b42-127">In particular, the client, by virtue of holding the service's certificate (which can be chained to a certification authority) in its trusted store, must trust that it is communicating with the correct service.</span></span> <span data-ttu-id="d4b42-128">Для проверки подлинности клиента служба использует сертификат X.509, прикрепленный к сообщению, для сопоставления его сертификату проверки подлинности клиента в хранилище.</span><span class="sxs-lookup"><span data-stu-id="d4b42-128">For authenticating the client, the service uses the X.509 certificate attached with the message to matches it with the certificate in its store to verify the authenticity of the client.</span></span> <span data-ttu-id="d4b42-129">Аналогичным образом сертификат должен быть привязан к центру сертификации.</span><span class="sxs-lookup"><span data-stu-id="d4b42-129">Again, the certificate must be chained to a certification authority.</span></span>  
  
 <span data-ttu-id="d4b42-130">На компьютере под управлением Windows имеется несколько типов хранилищ сертификатов.</span><span class="sxs-lookup"><span data-stu-id="d4b42-130">On a computer running Windows, certificates are held in several kinds of stores.</span></span> <span data-ttu-id="d4b42-131">Дополнительные сведения о различных хранилищах см. в разделе [хранилища сертификатов](https://go.microsoft.com/fwlink/?LinkId=87787).</span><span class="sxs-lookup"><span data-stu-id="d4b42-131">For more information about the different stores, see [Certificate stores](https://go.microsoft.com/fwlink/?LinkId=87787).</span></span>  
  
### <a name="windows"></a><span data-ttu-id="d4b42-132">Windows</span><span class="sxs-lookup"><span data-stu-id="d4b42-132">Windows</span></span>  
 <span data-ttu-id="d4b42-133">Тип учетных данных сообщений Windows использует протокол Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d4b42-133">Windows message credential type uses the Kerberos protocol.</span></span>  
  
 <span data-ttu-id="d4b42-134">Протокол Kerberos является механизмом обеспечения безопасности, проверяющим подлинность пользователей в домене и позволяющим пользователям, прошедшим проверку подлинности, устанавливать защищенные контексты с другими сущностями в домене.</span><span class="sxs-lookup"><span data-stu-id="d4b42-134">The Kerberos protocol is a security mechanism that authenticates users on a domain and allows the authenticated users to establish secure contexts with other entities on a domain.</span></span>  
  
 <span data-ttu-id="d4b42-135">Проблема, возникающая при применении протокола Kerberos для взаимодействия с использованием очереди, заключается в том, что билеты с учетной записью клиента, выдаваемые центром распространения ключей (KDC), имеют относительно короткое время существования.</span><span class="sxs-lookup"><span data-stu-id="d4b42-135">The problem with using the Kerberos protocol for queued communication is that the tickets that contain client identity that the Key Distribution Center (KDC) distributes are relatively short-lived.</span></span> <span data-ttu-id="d4b42-136">*Время существования* связано с билетом Kerberos, указывающим на допустимость билета.</span><span class="sxs-lookup"><span data-stu-id="d4b42-136">A *lifetime* is associated with the Kerberos ticket that indicates the validity of the ticket.</span></span> <span data-ttu-id="d4b42-137">Поэтому в случае большой задержки нельзя быть уверенным в том, что маркер еще действителен для службы, выполняющей проверку подлинности клиента.</span><span class="sxs-lookup"><span data-stu-id="d4b42-137">As such, given high latency, you cannot be sure that the token is still valid for the service that authenticates the client.</span></span>  
  
 <span data-ttu-id="d4b42-138">Обратите внимание, что при использовании этого типа учетных данных служба должна запускаться из учетной записи службы (SERVICE).</span><span class="sxs-lookup"><span data-stu-id="d4b42-138">Note that when using this credential type, the service must be running under the SERVICE account.</span></span>  
  
 <span data-ttu-id="d4b42-139">Протокол Kerberos используется по умолчанию при выборе учетных данных сообщения.</span><span class="sxs-lookup"><span data-stu-id="d4b42-139">The Kerberos protocol is used by default when choosing message credential.</span></span>
  
### <a name="username-password"></a><span data-ttu-id="d4b42-140">Имя пользователя и пароль</span><span class="sxs-lookup"><span data-stu-id="d4b42-140">Username Password</span></span>  
 <span data-ttu-id="d4b42-141">С помощью этого свойства клиент может проверить подлинность сервера, используя имя пользователя и пароль в заголовке безопасности сообщения.</span><span class="sxs-lookup"><span data-stu-id="d4b42-141">Using this property, the client can authenticate to the server using a username password in the security header of the message.</span></span>  
  
### <a name="issuedtoken"></a><span data-ttu-id="d4b42-142">IssuedToken</span><span class="sxs-lookup"><span data-stu-id="d4b42-142">IssuedToken</span></span>  
 <span data-ttu-id="d4b42-143">Клиент может обратиться к службе маркеров безопасности для получения прикрепляемого к сообщению маркера, с помощью которого служба может проверить подлинность клиента.</span><span class="sxs-lookup"><span data-stu-id="d4b42-143">The client can use the security token service to issue a token that can then be attached to the message for the service to authenticate the client.</span></span>  
  
## <a name="using-transport-and-message-security"></a><span data-ttu-id="d4b42-144">Использование безопасности транспорта и сообщений</span><span class="sxs-lookup"><span data-stu-id="d4b42-144">Using Transport and Message Security</span></span>  
 <span data-ttu-id="d4b42-145">При применении одновременно и безопасности транспорта, и безопасности сообщений для обеспечения безопасности сообщения как на уровне транспорта, так и на уровне сообщений SOAP должен использоваться один и тот же сертификат.</span><span class="sxs-lookup"><span data-stu-id="d4b42-145">When using both transport security and message security, the certificate used to secure the message both at the transport and the SOAP message level must be the same.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d4b42-146">См. также</span><span class="sxs-lookup"><span data-stu-id="d4b42-146">See also</span></span>

- [<span data-ttu-id="d4b42-147">Защита сообщений с использованием средств обеспечения безопасности транспорта</span><span class="sxs-lookup"><span data-stu-id="d4b42-147">Securing Messages Using Transport Security</span></span>](../../../../docs/framework/wcf/feature-details/securing-messages-using-transport-security.md)
- [<span data-ttu-id="d4b42-148">Безопасность сообщений при использовании очереди сообщений</span><span class="sxs-lookup"><span data-stu-id="d4b42-148">Message Security over Message Queuing</span></span>](../../../../docs/framework/wcf/samples/message-security-over-message-queuing.md)
- [<span data-ttu-id="d4b42-149">Основные понятия безопасности</span><span class="sxs-lookup"><span data-stu-id="d4b42-149">Security Concepts</span></span>](../../../../docs/framework/wcf/feature-details/security-concepts.md)
- [<span data-ttu-id="d4b42-150">Защита служб и клиентов</span><span class="sxs-lookup"><span data-stu-id="d4b42-150">Securing Services and Clients</span></span>](../../../../docs/framework/wcf/feature-details/securing-services-and-clients.md)
