---
title: Ограничение распространения сообщений
ms.date: 03/30/2017
ms.assetid: 8b5ec4b8-1ce9-45ef-bb90-2c840456bcc1
ms.openlocfilehash: d09a2be4a59a08a4bddbb1e0f4d038cd2c5ff3e2
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59130225"
---
# <a name="limiting-message-distribution"></a>Ограничение распространения сообщений
Одноранговый канал представляет собой широковещательную сетку. Его базовая модель рассылки заключается в том, что каждое сообщение, отправленное любым участником сетки, доставляется всем остальным участникам этой сетки. Этот принцип идеально подходит для ситуаций, когда каждое сообщение, созданное участником сетки, представляет ценность для всех остальных участников (например, участников чата). Впрочем, для многих приложений иногда требуется ограничить распределение сообщений. Например, если к сетке присоединяется новый участник, которому требуется извлечь последнее из сообщений, отправленных через сетку, этот запрос не требуется рассылать всем участникам сетки. Можно ограничить доставку запроса ближайшими соседями или отфильтровывать сообщения, созданные локально. Также можно отправлять сообщения отдельным узлам сетки. В этом разделе рассматривается управление пересылкой сообщений через сетку с помощью счетчика числа прыжков, фильтра распространения сообщений, локального фильтра или прямого подключения и приводятся общие рекомендации по выбору подхода.  
  
## <a name="hop-counts"></a>Число прыжков  
 Понятие `PeerHopCount` аналогично понятию "срок жизни", используемому в протоколе IP. Значение `PeerHopCount` привязывается к экземпляру сообщения. Оно указывает, сколько раз следует перенаправить сообщение, прежде чем отбросить его. Каждый раз, когда клиент однорангового канала получает сообщение, он проверяет, указано ли значение `PeerHopCount` для этого сообщения. Если оно указано, клиент уменьшает значение числа прыжков на единицу, прежде чем перенаправить сообщение на соседние узлы. Если клиент получает сообщение с нулевым числом прыжков, он обрабатывает сообщение, но не перенаправляет его соседям.  
  
 Сообщению можно задать количество прыжков, добавив `PeerHopCount` в качестве атрибута применимого свойства или поля при реализации класса сообщения. Можно задать определенное значение числа прыжков перед отправкой сообщения в сетку. Таким образом, при необходимости можно ограничить распределение сообщений по сетке с помощью числа прыжков, потенциально избежав ненужного дублирования сообщения. Эта функция полезна в случаях, когда сетка содержит большое количество избыточных данных, а также при отправке сообщений соседям, находящихся на ближайших узлах или в пределах нескольких прыжков.  
  
-   Фрагменты кода и сопутствующие сведения см. в разделе [Блог разработчиков одноранговых каналов](https://go.microsoft.com/fwlink/?LinkID=114531).  
  
## <a name="message-propagation-filter"></a>Фильтр распространения сообщений  
 Фильтр `MessagePropagationFilter` можно использовать для настраиваемого управления рассылкой сообщений, особенно если распространение определяется содержанием сообщения или другими конкретными сценариями. Для каждого сообщения, проходящего через узел, фильтр принимает решение о его дальнейшем распространении. Это относится к сообщениям, получаемым от других узлов сетки, а также к создаваемым с помощью приложения. Фильтр имеет доступ к самому сообщению и к информации о его источнике, а потому решения о перенаправлении или удалении этого сообщения можно основывать на информации, доступной во всей полноте.  
  
 <xref:System.ServiceModel.PeerMessagePropagationFilter> - базовый абстрактный класс с единственной функцией <xref:System.ServiceModel.PeerMessagePropagationFilter.ShouldMessagePropagate%2A>. Первый аргумент при вызове метода передает полную копию сообщения. Никакие изменения, внесенные в сообщение, не влияют на фактическое сообщение. Последний аргумент при вызове метода указывает источник сообщения (`PeerMessageOrigination.Local` или `PeerMessageOrigination.Remote`). Конкретные реализации этого метода должны возвращать константу из перечисления <xref:System.ServiceModel.PeerMessagePropagation>, указывающую, что сообщение необходимо перенаправить локальному приложению (`Local`), удаленным клиентам (`Remote`), и тому и другим (`LocalAndRemote`) или ни тому ни другим (`None`). Этот фильтр можно применить, обратившись к соответствующему объекту `PeerNode` и указав экземпляр производного класса фильтра распространения в свойстве `PeerNode.MessagePropagationFilter`. Прежде чем открыть одноранговый канал, убедитесь, что фильтр подключен.  
  
-   Фрагменты кода и сопутствующие сведения см. в разделе [Блог разработчиков одноранговых каналов](https://go.microsoft.com/fwlink/?LinkID=114532).  
  
## <a name="contacting-an-individual-node-in-the-mesh"></a>Обращение к одному из узлов сетки  
 Можно обратиться к одному из узлов сетки, настроив локальный фильтр или прямое подключение.  
  
 Если каждый узел сетки имеет отдельный идентификатор, можно указать идентификатор целевого узла при реализации сообщения. Можно настроить локальный фильтр, реализовав в контракте сообщения функцию, выдающую сообщение текущему узлу только в том случае, если его идентификатор соответствует заданному в качестве целевого. Сообщение передается по сетке, что избавляет от излишней нагрузке по настройке нового подключения. Впрочем, теряется эффективность, поскольку сообщение передается по сетке множество раз. Этот способ достаточно эффективен для отправки сообщений отдельным участникам сетки, если объем этих сообщений не слишком велик и частота их отправки умерена.  
  
 Для длительных передач больших объемов данных предпочтительно использовать прямые подключения. Можно отправить по сетке информацию о подключении, а затем настроить прямое подключение для отправки и приема сообщений.  
  
## <a name="choosing-an-approach-for-limiting-message-distribution"></a>Выбор способа ограничения распределения сообщений  
 Если необходимо ограничить распределение сообщений, следует продумать следующие вопросы:  
  
-   **Кто** требуется доставить сообщение? Только на соседний узел? На узел в другой части сетки? На половину узлов сетки?  
  
-   **Как часто** будут отправляться сообщения?  
  
-   Какие из **пропускной способности** будет использовать это сообщение?  
  
 Ответы на эти вопросы помогут определить, какой подход следует использовать: счетчик числа прыжков, фильтр распространения сообщений, локальный фильтр или прямое подключение. Ниже приведены рекомендации общего характера.  
  
-   **Кто**  
  
    -   *Отдельный узел*:  Локальный фильтр или прямое подключение.  
  
    -   *Соседние узлы в определенном радиусе*:  PeerHopCount.  
  
    -   *Сложные подмножество сетки*:  MessagePropagationFilter.  
  
-   **Как часто**  
  
    -   *Очень часто*:  Прямое подключение, PeerHopCount, MessagePropagationFilter.  
  
    -   *Время от времени*:  Локальный фильтр.  
  
-   **Использование пропускной способности**  
  
    -   *Высокий уровень*:  Прямое подключение, менее использовать MessagePropagationFilter или локальный фильтр.  
  
    -   *Низкий*:  Прямое подключение, скорее всего не требуется.  
  
## <a name="see-also"></a>См. также

- [Создание приложения одноранговых каналов](../../../../docs/framework/wcf/feature-details/building-a-peer-channel-application.md)
