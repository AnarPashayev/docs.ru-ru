---
title: Практическое руководство. Включение потоковой передачи
description: Узнайте, как включить потоковые сообщения в WCF, а не переданные по умолчанию буферизованные передачи, которые должны быть полностью получены перед обработкой.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 6ca2cf4b-c7a1-49d8-a79b-843a90556ba4
ms.openlocfilehash: 538fd8634094aa6fbf097ddb94469d7bca749a63
ms.sourcegitcommit: 358a28048f36a8dca39a9fe6e6ac1f1913acadd5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/23/2020
ms.locfileid: "85247030"
---
# <a name="how-to-enable-streaming"></a><span data-ttu-id="bf501-103">Практическое руководство. Включение потоковой передачи</span><span class="sxs-lookup"><span data-stu-id="bf501-103">How to: Enable Streaming</span></span>
<span data-ttu-id="bf501-104">Windows Communication Foundation (WCF) может передавать сообщения с помощью буферизованной или потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="bf501-104">Windows Communication Foundation (WCF) can send messages using either buffered or streamed transfers.</span></span> <span data-ttu-id="bf501-105">По умолчанию используется режим буферизованной передачи, в случае которого сообщение должно быть доставлено полностью, прежде чем получатель сможет его прочитать.</span><span class="sxs-lookup"><span data-stu-id="bf501-105">In the default buffered-transfer mode, a message must be completely delivered before a receiver can read it.</span></span> <span data-ttu-id="bf501-106">При использовании режима потоковой передачи получатель может начать обработку сообщения до того, как оно будет доставлено полностью.</span><span class="sxs-lookup"><span data-stu-id="bf501-106">In streaming transfer mode, the receiver can begin to process the message before it is completely delivered.</span></span> <span data-ttu-id="bf501-107">Режим потоковой передачи полезно использовать при большой длине передаваемых данных, которые могут обрабатываться последовательно.</span><span class="sxs-lookup"><span data-stu-id="bf501-107">The streaming mode is useful when the information that is passed is lengthy and can be processed serially.</span></span> <span data-ttu-id="bf501-108">Режим потоковой передачи также может быть полезен, когда размер сообщения слишком велик для выполнения полной буферизации.</span><span class="sxs-lookup"><span data-stu-id="bf501-108">Streaming mode is also useful when the message is too large to be entirely buffered.</span></span>  
  
 <span data-ttu-id="bf501-109">Для включения потоковой передачи необходимо соответствующим образом определить контракт операции `OperationContract` и включить потоковую передачу на транспортном уровне.</span><span class="sxs-lookup"><span data-stu-id="bf501-109">To enable streaming, define the `OperationContract` appropriately and enable streaming at the transport level.</span></span>  
  
### <a name="to-stream-data"></a><span data-ttu-id="bf501-110">Потоковая передача данных</span><span class="sxs-lookup"><span data-stu-id="bf501-110">To stream data</span></span>  
  
1. <span data-ttu-id="bf501-111">Для выполнения потоковой передачи контракт операции `OperationContract` для службы должен удовлетворять двум требованиям.</span><span class="sxs-lookup"><span data-stu-id="bf501-111">To stream data, the `OperationContract` for the service must satisfy two requirements:</span></span>  
  
    1. <span data-ttu-id="bf501-112">Параметр, в котором содержатся данные для потоковой передачи, должен быть единственным в методе.</span><span class="sxs-lookup"><span data-stu-id="bf501-112">The parameter that holds the data to be streamed must be the only parameter in the method.</span></span> <span data-ttu-id="bf501-113">Например, если требуется выполнить потоковую передачу входного сообщения, операция должна иметь точно один входной параметр.</span><span class="sxs-lookup"><span data-stu-id="bf501-113">For example, if the input message is the one to be streamed, the operation must have exactly one input parameter.</span></span> <span data-ttu-id="bf501-114">Аналогично, если требуется выполнить потоковую передачу выходного сообщения, операция должна иметь точно один выходной параметр или возвращать значение.</span><span class="sxs-lookup"><span data-stu-id="bf501-114">Similarly, if the output message is to be streamed, the operation must have either exactly one output parameter or a return value.</span></span>  
  
    2. <span data-ttu-id="bf501-115">Параметр и возвращаемое значение должны принадлежать по крайней мере к одному из следующих типов: <xref:System.IO.Stream>, <xref:System.ServiceModel.Channels.Message> или <xref:System.Xml.Serialization.IXmlSerializable>.</span><span class="sxs-lookup"><span data-stu-id="bf501-115">At least one of the types of the parameter and return value must be either <xref:System.IO.Stream>, <xref:System.ServiceModel.Channels.Message>, or <xref:System.Xml.Serialization.IXmlSerializable>.</span></span>  
  
     <span data-ttu-id="bf501-116">Ниже приведен пример контракта для потоковой передачи данных.</span><span class="sxs-lookup"><span data-stu-id="bf501-116">The following is an example of a contract for streamed data.</span></span>  
  
     [!code-csharp[c_HowTo_EnableStreaming#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming/cs/service.cs#1)]
     [!code-vb[c_HowTo_EnableStreaming#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howto_enablestreaming/vb/service.vb#1)]  
  
     <span data-ttu-id="bf501-117">Операция `GetStream` получает часть буферизованных входных данных в качестве строки (`string`), которая является буферизованной, и возвращает объект `Stream`, который является потоковым.</span><span class="sxs-lookup"><span data-stu-id="bf501-117">The `GetStream` operation receives some buffered input data as a `string`, which is buffered, and returns a `Stream`, which is streamed.</span></span> <span data-ttu-id="bf501-118">И наоборот, `UploadStream` принимает объект `Stream` (потоковый) и возвращает объект `bool` (буферизованный).</span><span class="sxs-lookup"><span data-stu-id="bf501-118">Conversely `UploadStream` takes in a `Stream` (streamed) and returns a `bool` (buffered).</span></span> <span data-ttu-id="bf501-119">`EchoStream` принимает и возвращает объект `Stream` и является примером операции, в которой как входное, так и выходное сообщения являются потоковыми.</span><span class="sxs-lookup"><span data-stu-id="bf501-119">`EchoStream` takes and returns `Stream` and is an example of an operation whose input and output messages are both streamed.</span></span> <span data-ttu-id="bf501-120">Наконец, `GetReversedStream` не принимает никакие данные и возвращает объект `Stream` (потоковый).</span><span class="sxs-lookup"><span data-stu-id="bf501-120">Finally, `GetReversedStream` takes no inputs and returns a `Stream` (streamed).</span></span>  
  
2. <span data-ttu-id="bf501-121">Потоковая передача должна быть включена в привязке.</span><span class="sxs-lookup"><span data-stu-id="bf501-121">Streaming must be enabled on the binding.</span></span> <span data-ttu-id="bf501-122">Задаваемое свойство `TransferMode` может принимать одно из следующих значений.</span><span class="sxs-lookup"><span data-stu-id="bf501-122">You set a `TransferMode` property, which can take one of the following values:</span></span>  
  
    1. <span data-ttu-id="bf501-123">`Buffered`,</span><span class="sxs-lookup"><span data-stu-id="bf501-123">`Buffered`,</span></span>  
  
    2. <span data-ttu-id="bf501-124">`Streamed`. Обеспечивает потоковую передачу в обоих направлениях.</span><span class="sxs-lookup"><span data-stu-id="bf501-124">`Streamed`, which enables streaming communication in both directions.</span></span>  
  
    3. <span data-ttu-id="bf501-125">`StreamedRequest`. Обеспечивает только потоковую передачу запроса.</span><span class="sxs-lookup"><span data-stu-id="bf501-125">`StreamedRequest`, which enables streaming the request only.</span></span>  
  
    4. <span data-ttu-id="bf501-126">`StreamedResponse`. Обеспечивает только потоковую передачу ответа.</span><span class="sxs-lookup"><span data-stu-id="bf501-126">`StreamedResponse`, which enables streaming the response only.</span></span>  
  
     <span data-ttu-id="bf501-127">`BasicHttpBinding` предоставляет свойство `TransferMode` в привязке, как делают `NetTcpBinding` и `NetNamedPipeBinding`.</span><span class="sxs-lookup"><span data-stu-id="bf501-127">The `BasicHttpBinding` exposes the `TransferMode` property on the binding, as does `NetTcpBinding` and `NetNamedPipeBinding`.</span></span> <span data-ttu-id="bf501-128">Свойство `TransferMode` можно также задать в элементе привязки транспорта и использовать в пользовательской привязке.</span><span class="sxs-lookup"><span data-stu-id="bf501-128">The `TransferMode` property can also be set on the transport binding element and used in a custom binding.</span></span>  
  
     <span data-ttu-id="bf501-129">В следующих примерах показано, как задать свойство `TransferMode` с помощью кода и путем изменения файла конфигурации.</span><span class="sxs-lookup"><span data-stu-id="bf501-129">The following samples show how to set `TransferMode` by code and by changing the configuration file.</span></span> <span data-ttu-id="bf501-130">В обоих примерах для свойства `maxReceivedMessageSize` задается значение 64 МБ, определяющее максимальный размер принимаемых сообщений.</span><span class="sxs-lookup"><span data-stu-id="bf501-130">The samples also both set the `maxReceivedMessageSize` property to 64 MB, which places a cap on the maximum allowable size of messages on receive.</span></span> <span data-ttu-id="bf501-131">По умолчанию для свойства `maxReceivedMessageSize` задано значение 64 КБ, которое обычно слишком мало для сценариев потоковой передачи.</span><span class="sxs-lookup"><span data-stu-id="bf501-131">The default `maxReceivedMessageSize` is 64 KB, which is usually too low for streaming scenarios.</span></span> <span data-ttu-id="bf501-132">Это параметр квоты необходимо задавать в соответствии с максимальным размером сообщений, получение которых ожидается приложением.</span><span class="sxs-lookup"><span data-stu-id="bf501-132">Set this quota setting as appropriate depending on the maximum size of messages your application expects to receive.</span></span> <span data-ttu-id="bf501-133">Также обратите внимание, что свойство `maxBufferSize` контролирует максимальный размер буферизуемых данных; для него требуется задать соответствующее значение.</span><span class="sxs-lookup"><span data-stu-id="bf501-133">Also note that `maxBufferSize` controls the maximum size that is buffered, and set it appropriately.</span></span>  
  
    1. <span data-ttu-id="bf501-134">В следующем фрагменте конфигурации из примера показано задание для свойства `TransferMode` значения потоковой передачи в привязке `basicHttpBinding` и пользовательской привязке HTTP.</span><span class="sxs-lookup"><span data-stu-id="bf501-134">The following configuration snippet from the sample shows setting the `TransferMode` property to streaming on the `basicHttpBinding` and a custom HTTP binding.</span></span>  
  
         [!code-xml[c_HowTo_EnableStreaming#103](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming/common/app.config#103)]
  
    2. <span data-ttu-id="bf501-135">В следующем фрагменте кода показано задание для свойства `TransferMode` значения потоковой передачи в привязке `basicHttpBinding` и пользовательской привязке HTTP.</span><span class="sxs-lookup"><span data-stu-id="bf501-135">The following code snippet shows setting the `TransferMode` property to streaming on the `basicHttpBinding` and a custom HTTP binding.</span></span>  
  
         [!code-csharp[c_HowTo_EnableStreaming_code#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming_code/cs/c_howto_enablestreaming_code.cs#2)]
         [!code-vb[c_HowTo_EnableStreaming_code#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howto_enablestreaming_code/vb/c_howto_enablestreaming_code.vb#2)]  
  
    3. <span data-ttu-id="bf501-136">В следующем фрагменте кода показано задание для свойства `TransferMode` значения потоковой передачи в пользовательской привязке TCP.</span><span class="sxs-lookup"><span data-stu-id="bf501-136">The following code snippet shows setting the `TransferMode` property to streaming on a custom TCP binding.</span></span>  
  
         [!code-csharp[c_HowTo_EnableStreaming_code#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming_code/cs/c_howto_enablestreaming_code.cs#3)]
         [!code-vb[c_HowTo_EnableStreaming_code#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howto_enablestreaming_code/vb/c_howto_enablestreaming_code.vb#3)]  
  
3. <span data-ttu-id="bf501-137">Операции `GetStream`, `UploadStream` и `EchoStream` выполняют передачу данных непосредственно из файла или сохранение полученных данных непосредственно в файл.</span><span class="sxs-lookup"><span data-stu-id="bf501-137">The operations `GetStream`, `UploadStream`, and `EchoStream` all deal with sending data directly from a file or saving received data directly to a file.</span></span> <span data-ttu-id="bf501-138">Следующий код относится к `GetStream`.</span><span class="sxs-lookup"><span data-stu-id="bf501-138">The following code is for `GetStream`.</span></span>  
  
     [!code-csharp[c_HowTo_EnableStreaming#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming/cs/service.cs#4)]
     [!code-vb[c_HowTo_EnableStreaming#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howto_enablestreaming/vb/service.vb#4)]  
  
### <a name="writing-a-custom-stream"></a><span data-ttu-id="bf501-139">Создание пользовательского потока</span><span class="sxs-lookup"><span data-stu-id="bf501-139">Writing a custom stream</span></span>  
  
1. <span data-ttu-id="bf501-140">Для специальной обработки каждого фрагмента потока данных во время его отправки или получения необходимо создать производный класс на основе класса <xref:System.IO.Stream>.</span><span class="sxs-lookup"><span data-stu-id="bf501-140">To do special processing on each chunk of a data stream as it is being sent or received, derive a custom stream class from <xref:System.IO.Stream>.</span></span> <span data-ttu-id="bf501-141">В следующем примере кода пользовательского потока используется метод `GetReversedStream` и класс `ReverseStream`.</span><span class="sxs-lookup"><span data-stu-id="bf501-141">As an example of a custom stream, the following code contains a `GetReversedStream` method and a `ReverseStream` class-.</span></span>  
  
     <span data-ttu-id="bf501-142">Метод `GetReversedStream` создает и возвращает новый экземпляр класса `ReverseStream`.</span><span class="sxs-lookup"><span data-stu-id="bf501-142">`GetReversedStream` creates and returns a new instance of `ReverseStream`.</span></span> <span data-ttu-id="bf501-143">Фактическая обработка происходит, когда система считывает данные из объекта `ReverseStream`.</span><span class="sxs-lookup"><span data-stu-id="bf501-143">The actual processing happens as the system reads from the `ReverseStream` object.</span></span> <span data-ttu-id="bf501-144">Метод `ReverseStream.Read` считывает фрагмент байтов из исходного файла, обращает их, а затем возвращает байты, представленные в обратном порядке.</span><span class="sxs-lookup"><span data-stu-id="bf501-144">The `ReverseStream.Read` method reads a chunk of bytes from the underlying file, reverses them, then returns the reversed bytes.</span></span> <span data-ttu-id="bf501-145">Этот метод не обращает все содержимое файла; он обращает один фрагмент байтов за раз.</span><span class="sxs-lookup"><span data-stu-id="bf501-145">This method does not reverse the entire file content; it reverses one chunk of bytes at a time.</span></span> <span data-ttu-id="bf501-146">В этом примере показано, как можно выполнить потоковую обработку во время чтения или записи содержимого из потока.</span><span class="sxs-lookup"><span data-stu-id="bf501-146">This example shows how you can perform stream processing as the content is being read to or written from the stream.</span></span>  
  
     [!code-csharp[c_HowTo_EnableStreaming#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_howto_enablestreaming/cs/service.cs#2)]
     [!code-vb[c_HowTo_EnableStreaming#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_howto_enablestreaming/vb/service.vb#2)]  
  
## <a name="see-also"></a><span data-ttu-id="bf501-147">См. также</span><span class="sxs-lookup"><span data-stu-id="bf501-147">See also</span></span>

- [<span data-ttu-id="bf501-148">Большие наборы данных и потоковая передача</span><span class="sxs-lookup"><span data-stu-id="bf501-148">Large Data and Streaming</span></span>](large-data-and-streaming.md)
- [<span data-ttu-id="bf501-149">STREAM</span><span class="sxs-lookup"><span data-stu-id="bf501-149">Stream</span></span>](../samples/stream.md)
