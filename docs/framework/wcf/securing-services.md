---
title: Защита служб
ms.date: 03/30/2017
helpviewer_keywords:
- configuration [WCF], securing services
- WCF security
- WCF, security
ms.assetid: f0ecc6f7-f4b5-42a4-9cb1-b02e28e26620
ms.openlocfilehash: 65d4f2858c2be4c2a6872f96ef3739bb16253d74
ms.sourcegitcommit: 5b6d778ebb269ee6684fb57ad69a8c28b06235b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/08/2019
ms.locfileid: "59157681"
---
# <a name="securing-services"></a>Защита служб
Безопасность службы Windows Communication Foundation (WCF) состоит из двух основных требований: безопасность передачи и авторизации. (Третье требование, аудит событий безопасности, описанной в [аудит](../../../docs/framework/wcf/feature-details/auditing-security-events.md).) Вкратце, для обеспечения безопасности передачи должна быть выполнена проверка подлинности (проверка идентификации как службы, так и клиента) и обеспечены конфиденциальность (шифрование сообщений) и целостность (цифровая подпись для обнаружения подделки). Авторизация - это управление доступом к ресурсам, например разрешение чтение файла только привилегированным пользователям. С помощью функций WCF, два основных требования легко реализуются.  
  
 За исключением элемента <xref:System.ServiceModel.BasicHttpBinding> класс (или [ \<basicHttpBinding >](../../../docs/framework/configure-apps/file-schema/wcf/basichttpbinding.md) элемент в конфигурации), обеспечение безопасности передачи включено по умолчанию для всех предопределенных привязок. В подразделах данного раздела рассматриваются два основных сценария: обеспечение безопасности передачи и авторизации в службе интрасети, размещенной в IIS, а также обеспечение безопасности передачи и авторизации в службе, размещенной в IIS.  
  
> [!NOTE]
>  В Windows XP Home проверка подлинности Windows не поддерживается. Поэтому не следует запускать службу в этой системе.  
  
## <a name="security-basics"></a>Общие сведения о безопасности  
 Средства обеспечения безопасности полагаются на *учетные данные*. Учетные данные удостоверяют, что сущность является тем, за кого она себя выдает. ( *Сущности* может быть человека, процесс программного обеспечения, компания или все, что можно авторизовать.) Например, клиент службы делает *утверждения* из *удостоверений*, и учетные данные подтверждают некоторым способом, утверждение. В типовом сценарии происходит обмен учетными данными. Сначала служба делает утверждение своей идентификации и подтверждает его клиенту с помощью учетных данных. И наоборот, клиент делает утверждение идентификации и представляет учетные данные службе. Если обе стороны доверяют учетным данным друг друга, может быть установлен *контекст безопасности* , в котором осуществляется конфиденциальный обмен сообщениями, и все сообщения подписываются для защиты их целостности. После того как служба устанавливает идентификацию клиента, она может сопоставить утверждения в учетных данных с *ролью* или *членством* в группе. В каждом случае, используя роль или группу, к которой относится клиент, служба *разрешает* клиенту выполнять ограниченный набор операций, основанных на привилегиях роли или группы.  
  
## <a name="windows-security-mechanisms"></a>Механизмы безопасности Windows  
 Если клиент и компьютер службы находятся в домене Windows, который требует, чтобы и клиент, и компьютер службы регистрировались в сети, учетные данные предоставляются инфраструктурой Windows. В этом случае учетные данные создаются, когда пользователь компьютера регистрируется в сети. Каждый пользователь и каждый компьютер в сети должны быть проверены на принадлежность к доверенному набору пользователей и компьютеров. В системе Windows каждый такой пользователь и компьютер называются также *участниками безопасности*.  
  
 В домене Windows, поддерживаемом контроллером *Kerberos* , контроллер Kerberos использует схему, основанную на предоставлении билетов каждому участнику безопасности. Билетам, предоставляемым этим контроллером, доверяют другие предоставляющие билеты средства в системе. Всякий раз когда сущность пытается выполнить некоторую операцию или получить доступ к *ресурсу* (например, файлу или каталогу на компьютере), билет проверяется на его действительность и в случае успешного прохождения проверки участнику предоставляется другой билет для операции. Этот метод предоставления билетов более эффективен, чем попытка проверить участника для каждой операции.  
  
 Более старый и менее безопасный механизм, используемый в доменах Windows, - NT LAN Manager (NTLM). В случаях, когда использовать Kerberos невозможно (обычно вне домена Windows, например в рабочей группе), в качестве альтернативы можно применять NTLM. Механизм NTLM доступен также в качестве варианта обеспечения безопасности для IIS.  
  
 В системе Windows авторизация осуществляется посредством назначения каждого компьютера и пользователя ряду ролей и групп. Например, каждый компьютер Windows должен настраиваться и управляться лицом (или группой лиц) в роли *администратора*. Другая роль - *пользователь*. Она имеет намного более ограниченный набор прав. Помимо роли, пользователи назначаются группам. Группа позволяет нескольким пользователям выполнять действия в одной и той же роли. Следовательно, фактически компьютер Windows администрируется путем назначения пользователей группам. Например, несколько пользователей могут быть назначены группе пользователей компьютера, и намного более ограниченный набор пользователей может быть назначен группе администраторов. На локальном компьютере администратор может также создавать новые группы и назначать других пользователей (или даже другие группы) группе.  
  
 На компьютере под управлением Windows можно защитить каждую папку в каталоге, т. е. можно выбрать папку и управлять тем, кто может обращаться к файлам, а также тем, можно ли копировать тот или иной файл или (в наиболее привилегированном случае) изменить файл, удалить файл либо добавить файлы в папку. Это называется управлением доступом, а механизм для такого управления - списком управления доступом (ACL). При создании ACL можно назначить привилегии доступа любой группе или группам, а также отдельным членам домена.  
  
 Инфраструктура WCF позволяет использовать эти механизмы безопасности Windows. Следовательно, если создается служба, которая развертывается в интрасети, и клиентами этой службы являются только члены домена Windows, безопасность легко обеспечить. В домен могут входить только допустимые пользователи. После входа пользователей контроллер Kerberos разрешает каждому пользователю устанавливать безопасные контексты с любым другим компьютером или приложением. На локальном компьютере можно легко создать группы, и при защите конкретных папок эти группы можно использовать для назначения привилегий доступа на этом компьютере.  
  
## <a name="implementing-windows-security-on-intranet-services"></a>Реализация безопасности Windows в службах интрасети  
 Чтобы защитить приложение, работающее только в домене Windows, можно использовать параметры безопасности по умолчанию привязки <xref:System.ServiceModel.WSHttpBinding> или <xref:System.ServiceModel.NetTcpBinding> . По умолчанию любой пользователь в том же домене Windows доступ к службам WCF. Поскольку такие пользователи зарегистрированы в сети, они являются доверенными. Сообщения между службой и клиентом шифруются в целях конфиденциальности и подписываются в целях целостности. Дополнительные сведения о том, как создать службу, которая использует безопасность Windows, см. в разделе [как: Защита службы с учетными данными Windows](../../../docs/framework/wcf/how-to-secure-a-service-with-windows-credentials.md).  
  
### <a name="authorization-using-the-principalpermissionattribute-class"></a>Авторизация с использованием класса PrincipalPermissionAttribute  
 Если необходимо ограничить доступ к ресурсам на компьютере, проще всего использовать класс <xref:System.Security.Permissions.PrincipalPermissionAttribute> . Этот атрибут позволяет ограничить вызов операций службы, требуя, чтобы пользователь находился в заданной группе Windows или имел заданную роль Windows или был особым пользователем. Дополнительные сведения см. в разделе [Как Ограничение доступа с использованием класса PrincipalPermissionAttribute](../../../docs/framework/wcf/how-to-restrict-access-with-the-principalpermissionattribute-class.md).  
  
### <a name="impersonation"></a>Олицетворение  
 Для управления доступом к ресурсам можно также использовать другой механизм, называемый олицетворением. По умолчанию служба, размещенная в IIS, работает под идентификатором учетной записи ASPNET. Учетная запись ASPNET может иметь доступ только к ресурсам, использовать которые она имеет право. Однако для папки можно задать ACL, чтобы исключить учетную запись службы ASPNET, но разрешить доступ к папке некоторым другим идентификаторам. Тогда встает вопрос, как разрешить этим пользователям доступ к папке, если для учетной записи ASPNET такой доступ не разрешен? Ответ - воспользоваться олицетворением, с помощью которого службе разрешается использовать учетные данные клиента для доступа к конкретному ресурсу. Другим примером служит доступ к базе данных SQL Server, обращаться к которой имеют право только определенные пользователи. Дополнительные сведения об использовании олицетворения см. в разделе [как: Олицетворение клиента в службе](../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md) и [делегирование и олицетворение](../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).  
  
## <a name="security-on-the-internet"></a>Безопасность в Интернете  
 Для обеспечения безопасности в Интернете необходимо выполнение тех же требований, что и для обеспечения безопасности в интрасети. Служба должна представить свои учетные данные, чтобы подтвердить свою подлинность, а клиенты должны подтвердить свою идентификацию службе. Проверив идентификацию клиента, служба может управлять доступом этого клиента к ресурсам. Однако из-за разнородности Интернета представляемые учетные данные отличаются от учетных данных, используемых в домене Windows. Контроллер Kerberos осуществляет проверку подлинности пользователей в домене, используя билеты для учетных данных, а в Интернете службы и клиенты полагаются на один из нескольких других способов представления учетных данных. Целью данной статьи, однако является представить общий подход, позволяющий создать службу WCF, доступной в Интернете.  
  
### <a name="using-iis-and-aspnet"></a>Использование IIS и ASP.NET  
 Требования безопасности в Интернете и механизмы устранения связанных с безопасностью проблем не являются новыми. IIS является веб-сервер корпорации Майкрософт через Интернет и имеет множество функций безопасности, устраняющих такие проблемы; Кроме того [!INCLUDE[vstecasp](../../../includes/vstecasp-md.md)] включает в себя функции безопасности, которые могут использоваться службами WCF. Чтобы воспользоваться преимуществами этих функций безопасности, разместить службу WCF в IIS.  
  
#### <a name="using-aspnet-membership-and-role-providers"></a>Использование поставщиков членства и ролей ASP.NET  
 ASP.NET содержит поставщик членства и ролей. Поставщик - это база данных пар "имя пользователя – пароль" для проверки подлинности вызывающих, которая также позволяет задавать привилегии доступа каждого вызывающего. С WCF можно легко использовать существующий поставщик членства и ролей через конфигурацию. Пример приложения, где демонстрируется такое использование, см. в примере [Membership and Role Provider](../../../docs/framework/wcf/samples/membership-and-role-provider.md) .  
  
### <a name="credentials-used-by-iis"></a>Учетные данные, используемые IIS  
 В отличие от домена Windows, поддерживаемого контроллером Kerberos, Интернет - это среда без отдельного контроллера для управления миллионами пользователей, входящими в систему в любое время. Вместо этого учетные данные в Интернете чаще всего представляются в виде сертификатов X.509 (называемых также сертификатами SSL). Эти сертификаты обычно издаются *центром сертификации*, которым может быть сторонняя компания, гарантирующая подлинность сертификата и лица, для которого он издан. Чтобы представить службу в Интернете, необходимо также предоставить такой доверенный сертификат для проверки подлинности службы.  
  
 При этом возникает вопрос, как получить такой сертификат? Один из способов: при готовности развернуть службу и приобрести для нее сертификат следует обратиться в сторонний центр сертификации, например Authenticode или VeriSign. Тем не менее если вы являетесь на стадии разработки с помощью WCF и еще не готова для фиксации приобретение сертификата, предусмотрены средства и методы для создания сертификатов X.509, который можно использовать для имитации развертывания в рабочей среде. Дополнительные сведения см. в разделе [работа с сертификатами](../../../docs/framework/wcf/feature-details/working-with-certificates.md).  
  
## <a name="security-modes"></a>Режимы безопасности  
 Программирование безопасности WCF влечет за собой несколько точек принятия важных решений. Один из самых главных вопросов - выбор *режима безопасности*. Два основных режима безопасности - *транспортный режим* и *режим сообщений*.  
  
 Третий режим, в котором объединяется семантика двух основных режимов, - *режим транспорта с учетными данными сообщений*.  
  
 Режим безопасности определяет способ защиты сообщений. Каждый вариант имеет свои преимущества и недостатки, описанные ниже. Дополнительные сведения о задании режима безопасности см. в разделе [как: Настройка режима безопасности](../../../docs/framework/wcf/how-to-set-the-security-mode.md).  
  
#### <a name="transport-mode"></a>транспортный режим  
 Между сетевым и прикладным уровнями находится несколько уровней. Одним из таких уровней является *транспортный* уровень *,* который управляет передачей сообщений между конечными точками. Для случае это только требуется, что вы понимаете, что WCF использует несколько транспортных протоколов, каждый из которых может защищать передачу сообщений. (Дополнительные сведения о службах см. в разделе [транспортов](../../../docs/framework/wcf/feature-details/transports.md).)  
  
 Обычно используемым протоколом является протокол HTTP; другой применяемый протокол - TCP. Каждый из этих протоколов может защищать передачу сообщений с помощью механизма (или механизмов), ориентированного на конкретный протокол. Например, протокол HTTP защищается с помощью протокола SSL поверх HTTP, обычно называемого "HTTPS". Таким образом, если для обеспечения безопасности выбирается транспортный режим, используется механизм, определяемый протоколом. Например, если выбирается класс <xref:System.ServiceModel.WSHttpBinding> и в качестве его режима безопасности задается Transport, в качестве механизма безопасности выбирается протокол SSL поверх HTTP (HTTPS). Преимущество транспортного режима в том, что он более эффективен, чем режим сообщений, поскольку средства обеспечения безопасности интегрируются на относительно низком уровне. При использовании транспортного режима механизм безопасности должен быть реализован в соответствии со спецификацией транспорта, и, таким образом, сообщения могут безопасно передаваться только от точки к точке по транспортному каналу.  
  
#### <a name="message-mode"></a>режим сообщений  
 В отличие от транспортного режима, в режиме сообщений безопасность обеспечивается включением в каждое сообщение данных безопасности. С помощью заголовков безопасности XML и SOAP в каждое сообщение включаются учетные данные и другие данные, необходимые для обеспечения целостности и конфиденциальности сообщения. Каждое сообщение содержит данные безопасности, что приводит к снижению производительности, поскольку каждое сообщение должно обрабатываться индивидуально. (В транспортном режиме защищается транспортный уровень, и все сообщения передаются свободно.) Однако безопасность сообщений имеет одно преимущество над безопасностью транспорта: более высокая гибкость, т. е. требования безопасности не определяются транспортом. Для защиты сообщения можно использовать любой тип учетных данных клиента. (В транспортном режиме тип учетных данных клиента, который можно использовать, определяется транспортным протоколом.)  
  
#### <a name="transport-with-message-credentials"></a>Транспорт с учетными данными сообщений  
 В третьем режиме объединяются лучшие характеристики режима безопасности транспорта и режима безопасности сообщений. В этом режиме средства обеспечения безопасности транспорта используются для эффективного обеспечения конфиденциальности и целостности каждого сообщения. В то же время каждое сообщение содержит свои учетные данные, позволяющие проверить его подлинность. С проверкой подлинности может быть также выполнена авторизация. В результате проверки подлинности отправителя может быть предоставлен (или отклонен) доступ к ресурсам в соответствии с идентификацией отправителя.  
  
## <a name="specifying-the-client-credential-type-and-credential-value"></a>Задание типа учетных данных клиента и значения учетных данных  
 После выбора режима безопасности можно также задать тип учетных данных клиента. Тип учетных данных клиента определяет, какой тип учетных данных клиент должен использовать для подтверждения своей подлинности серверу.  
  
 Однако тип учетных данных клиента требуется не во всех сценариях. Служба подтверждает свою подлинность клиенту с помощью протокола SSL поверх HTTP (HTTPS). В ходе такой проверки подлинности клиенту в процессе, называемом *согласованием*, передается сертификат службы. Транспорт, защищенный с помощью SSL, гарантирует конфиденциальность всех сообщений.  
  
 В случае создания службы, которая требует проверки подлинности клиента, выбор типа учетных данных клиента зависит от выбранных транспорта и режима. Например, при использовании транспорта HTTP и выборе транспортного режима возможны несколько вариантов выбора - Basic, Digest и другие. (Дополнительные сведения об этих типы учетных данных, см. в разделе [Understanding HTTP Authentication](../../../docs/framework/wcf/feature-details/understanding-http-authentication.md).)  
  
 В случае создания службы в домене Windows, которая будет доступна только другим пользователям сети, проще всего использовать тип учетных данных клиента Windows. Однако может также потребоваться обеспечить службу сертификатом. Это показано в [как: Укажите значения учетных данных клиента](../../../docs/framework/wcf/how-to-specify-client-credential-values.md).  
  
#### <a name="credential-values"></a>Значения учетных данных  
 *Значение учетных данных* - это фактические учетные данные, используемые службой. После задания типа учетных данных может также потребоваться настроить службу с фактическими учетными данными. Если выбран тип Windows (и служба будет работать в домене Windows), фактическое значение учетных данных не задается.  
  
## <a name="identity"></a>идентификации  
 В WCF термин *удостоверений* имеет разные значения для сервера и клиента. Вкратце, при запуске службы идентификация назначается контексту безопасности после проверки подлинности. Чтобы просмотреть фактическую идентификацию, проверьте свойства <xref:System.ServiceModel.ServiceSecurityContext.WindowsIdentity%2A> и <xref:System.ServiceModel.ServiceSecurityContext.PrimaryIdentity%2A> класса <xref:System.ServiceModel.ServiceSecurityContext> . Дополнительные сведения см. в разделе [Как Анализ контекста безопасности](../../../docs/framework/wcf/how-to-examine-the-security-context.md).  
  
 В отличие от этого, на клиенте идентификация используется для проверки службы. Во время разработки разработчик клиента может настроить [ \<удостоверений >](../../../docs/framework/configure-apps/file-schema/wcf/identity.md) элемента значение, полученное от службы. Во время выполнения клиент проверяет значение элемента, сравнивая его с фактической идентификацией службы. В случае отрицательного результата проверки клиент завершает взаимодействие. Значением может быть имя участника-пользователя, если служба работает под удостоверением конкретного пользователя, или имя участника-службы, если служба работает под учетной записью компьютера. Дополнительные сведения см. в разделе [службы идентификации и проверки подлинности](../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md). Учетными данными может быть также сертификат или поле в сертификате, которое идентифицирует этот сертификат.  
  
## <a name="protection-levels"></a>Уровни защиты  
 Свойство `ProtectionLevel` встречается в нескольких классах атрибутов (например, в классах <xref:System.ServiceModel.ServiceContractAttribute> и <xref:System.ServiceModel.OperationContractAttribute> ). Уровень защиты - это значение, которое определяет для сообщений (или частей сообщений), поддерживающих службу, подписываются ли они, подписываются и шифруются или отправляются без подписи и шифровки. Дополнительные сведения о свойстве см. в разделе [уровень защиты понимание](../../../docs/framework/wcf/understanding-protection-level.md)и примеры программирования см. в разделе [как: Установка свойства ProtectionLevel](../../../docs/framework/wcf/how-to-set-the-protectionlevel-property.md). Дополнительные сведения о проектировании контракта службы с `ProtectionLevel` в контексте, см. в разделе [Designing Service Contracts](../../../docs/framework/wcf/designing-service-contracts.md).  
  
## <a name="see-also"></a>См. также

- <xref:System.ServiceModel>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.ServiceContractAttribute>
- <xref:System.ServiceModel.OperationContractAttribute>
- [Идентификация и проверка подлинности службы](../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md)
- [Основные сведения об уровне защиты](../../../docs/framework/wcf/understanding-protection-level.md)
- [Делегирование и олицетворение](../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)
- [Создание контрактов служб](../../../docs/framework/wcf/designing-service-contracts.md)
- [Безопасность](../../../docs/framework/wcf/feature-details/security.md)
- [Общие сведения о безопасности](../../../docs/framework/wcf/feature-details/security-overview.md)
- [Практическое руководство. Установка свойства ProtectionLevel](../../../docs/framework/wcf/how-to-set-the-protectionlevel-property.md)
- [Практическое руководство. Защита службы с использованием учетных данных Windows](../../../docs/framework/wcf/how-to-secure-a-service-with-windows-credentials.md)
- [Практическое руководство. Задание режима безопасности](../../../docs/framework/wcf/how-to-set-the-security-mode.md)
- [Практическое руководство. Указание типа учетных данных клиента](../../../docs/framework/wcf/how-to-specify-the-client-credential-type.md)
- [Практическое руководство. Ограничение доступа с использованием класса PrincipalPermissionAttribute](../../../docs/framework/wcf/how-to-restrict-access-with-the-principalpermissionattribute-class.md)
- [Практическое руководство. Олицетворение клиента в рамках службы](../../../docs/framework/wcf/how-to-impersonate-a-client-on-a-service.md)
- [Практическое руководство. Анализ контекста безопасности](../../../docs/framework/wcf/how-to-examine-the-security-context.md)
