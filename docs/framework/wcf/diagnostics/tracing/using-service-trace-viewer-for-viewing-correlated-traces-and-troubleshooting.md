---
title: Использование программы Service Trace Viewer для просмотра скоррелированных трассировок и устранения неполадок
ms.date: 03/30/2017
ms.assetid: 05d2321c-8acb-49d7-a6cd-8ef2220c6775
ms.openlocfilehash: e1cd1443e96e7195127cb95e7ef1b2c4d6d9c176
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/09/2020
ms.locfileid: "84587759"
---
# <a name="using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting"></a><span data-ttu-id="eb5b3-102">Использование программы Service Trace Viewer для просмотра скоррелированных трассировок и устранения неполадок</span><span class="sxs-lookup"><span data-stu-id="eb5b3-102">Using Service Trace Viewer for Viewing Correlated Traces and Troubleshooting</span></span>

<span data-ttu-id="eb5b3-103">В этом разделе описываются формат данных трассировки, способ просмотра этих данных, а также подходы, в которых используется программа Service Trace Viewer для устранения неполадок приложения.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-103">This topic describes the format of trace data, how to view it, and approaches that use the Service Trace Viewer to troubleshoot your application.</span></span>

## <a name="using-the-service-trace-viewer-tool"></a><span data-ttu-id="eb5b3-104">Использование программы Service Trace Viewer</span><span class="sxs-lookup"><span data-stu-id="eb5b3-104">Using the Service Trace Viewer Tool</span></span>

<span data-ttu-id="eb5b3-105">Средство просмотра трассировки службы Windows Communication Foundation (WCF) помогает сопоставлять Диагностические трассировки, созданные прослушивателями WCF, для выявления причины ошибки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-105">The Windows Communication Foundation (WCF) Service Trace Viewer tool helps you correlate diagnostic traces produced by WCF listeners to locate the root cause of an error.</span></span> <span data-ttu-id="eb5b3-106">Это средство позволяет легко просматривать, группировать и фильтровать трассировки, чтобы можно было диагностировать, устранять и проверять проблемы со службами WCF.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-106">The tool gives you a way to easily view, group, and filter traces so that you can diagnose, repair and verify issues with WCF services.</span></span> <span data-ttu-id="eb5b3-107">Дополнительные сведения об использовании этого средства см. в разделе [Service Trace Viewer Tool (SvcTraceViewer. exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-107">For more information about using this tool, see [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="eb5b3-108">В этом разделе содержатся снимки [экрана трассировки,](../../samples/tracing-and-message-logging.md) созданные при просмотре с помощью [средства Service Trace Viewer (SvcTraceViewer. exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-108">This topic contains screenshots of traces generated by running the [Tracing and Message Logging](../../samples/tracing-and-message-logging.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span> <span data-ttu-id="eb5b3-109">Показывается, как интерпретировать содержимое трассировки, действия и взаимосвязь между ними, а также как анализировать большое количество трассировок при устранении неполадок.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-109">This topic demonstrates how to understand trace content, activities and their correlation, and how to analyze large numbers of traces when troubleshooting.</span></span>

## <a name="viewing-trace-content"></a><span data-ttu-id="eb5b3-110">Просмотр содержимого трассировки</span><span class="sxs-lookup"><span data-stu-id="eb5b3-110">Viewing Trace Content</span></span>

<span data-ttu-id="eb5b3-111">Событие трассировки содержит следующие наиболее важные сведения:</span><span class="sxs-lookup"><span data-stu-id="eb5b3-111">A trace event contains the following most significant information:</span></span>

- <span data-ttu-id="eb5b3-112">имя действия, если задано;</span><span class="sxs-lookup"><span data-stu-id="eb5b3-112">Activity name when set.</span></span>

- <span data-ttu-id="eb5b3-113">время создания;</span><span class="sxs-lookup"><span data-stu-id="eb5b3-113">Emission time.</span></span>

- <span data-ttu-id="eb5b3-114">уровень трассировки;</span><span class="sxs-lookup"><span data-stu-id="eb5b3-114">Trace level.</span></span>

- <span data-ttu-id="eb5b3-115">Имя источника трассировки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-115">Trace source name.</span></span>

- <span data-ttu-id="eb5b3-116">имя процесса;</span><span class="sxs-lookup"><span data-stu-id="eb5b3-116">Process name.</span></span>

- <span data-ttu-id="eb5b3-117">идентификатор потока;</span><span class="sxs-lookup"><span data-stu-id="eb5b3-117">Thread id.</span></span>

- <span data-ttu-id="eb5b3-118">Уникальный идентификатор трассировки — URL-адрес, указывающий на назначение в Документация Майкрософт, из которого можно получить дополнительные сведения, связанные с трассировкой.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-118">A unique trace identifier, which is a URL that points to a destination in Microsoft Docs, from which you can obtain more information related to the trace.</span></span>

 <span data-ttu-id="eb5b3-119">Все это можно увидеть в верхней правой панели средства просмотра трассировки служб или в разделе **Основные сведения** в форматированном представлении нижней правой панели при выборе трассировки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-119">All of these can be seen in the upper right panel in the Service Trace Viewer, or in the **Basic Information** section in the formatted view of the lower-right panel when selecting a trace.</span></span>

> [!NOTE]
> <span data-ttu-id="eb5b3-120">Если клиент и служба установлены на одном и том же компьютере, то будут присутствовать трассировки для обоих приложений.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-120">If the client and the service are on the same machine, the traces for both applications will be present.</span></span> <span data-ttu-id="eb5b3-121">Их можно фильтровать с помощью столбца **имя процесса** .</span><span class="sxs-lookup"><span data-stu-id="eb5b3-121">These can be filtered using the **Process Name** column.</span></span>

<span data-ttu-id="eb5b3-122">Кроме того, в форматированном представлении отображаются также описание трассировки и дополнительные подробные сведения, если они доступны.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-122">In addition, the formatted view also provides a description for the trace and additional detailed information when available.</span></span> <span data-ttu-id="eb5b3-123">Дополнительные подробные сведения могут включать тип и сообщение исключения, стеки вызовов, действие сообщения, поля "от/к" и другую информацию об исключении.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-123">The latter can include exception type and message, call stacks, message action, from/to fields, and other exception information.</span></span>

<span data-ttu-id="eb5b3-124">В представлении XML имеются следующие важные теги xml:</span><span class="sxs-lookup"><span data-stu-id="eb5b3-124">In the XML view, useful xml tags include the following:</span></span>

- <span data-ttu-id="eb5b3-125">`<SubType>` (уровень трассировки);</span><span class="sxs-lookup"><span data-stu-id="eb5b3-125">`<SubType>` (trace level).</span></span>

- <span data-ttu-id="eb5b3-126">`<TimeCreated>`.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-126">`<TimeCreated>`.</span></span>

- <span data-ttu-id="eb5b3-127">`<Source>` (имя источника трассировки);</span><span class="sxs-lookup"><span data-stu-id="eb5b3-127">`<Source>` (trace source name).</span></span>

- <span data-ttu-id="eb5b3-128">`<Correlation>` (идентификатор действия, заданный при создании трассировки);</span><span class="sxs-lookup"><span data-stu-id="eb5b3-128">`<Correlation>` (activity id set when emitting the trace).</span></span>

- <span data-ttu-id="eb5b3-129">`<Execution>` (процесс и идентификатор потока);</span><span class="sxs-lookup"><span data-stu-id="eb5b3-129">`<Execution>` (process and thread id).</span></span>

- <span data-ttu-id="eb5b3-130">`<Computer>`.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-130">`<Computer>`.</span></span>

- <span data-ttu-id="eb5b3-131">`<ExtendedData>`, включая `<Action>`, `<MessageID>` и `<ActivityId>`, установленные в заголовке сообщения при отправке сообщения.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-131">`<ExtendedData>`, including `<Action>`, `<MessageID>` and the `<ActivityId>` set in the message header when sending a message.</span></span>

<span data-ttu-id="eb5b3-132">При анализе трассировки "Передано сообщение по каналу" отображаются следующие сведения.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-132">If you examine the "Sent a message over a channel" trace, you may see the following content.</span></span>

```xml
<E2ETraceEvent xmlns="http://schemas.microsoft.com/2004/06/E2ETraceEvent">
   <System xmlns="http://schemas.microsoft.com/2004/06/windows/eventlog/system">
      <EventID>262163</EventID>
      <Type>3</Type>
      <SubType Name="Information">0</SubType>
      <Level>8</Level>
      <TimeCreated SystemTime="2006-08-04T18:45:30.8491051Z" />
      <Source Name="System.ServiceModel" />
       <Correlation ActivityID="{27c6331d-8998-43aa-a382-03239013a6bd}"/>
       <Execution ProcessName="client" ProcessID="1808" ThreadID="1" />
       <Channel />
       <Computer>TEST1</Computer>
   </System>
   <ApplicationData>
       <TraceData>
          <DataItem>
             <TraceRecord xmlns="http://schemas.microsoft.com/2004/10/E2ETraceEvent/TraceRecord" Severity="Information">
                 <TraceIdentifier>http://msdn.microsoft.com/library/System.ServiceModel.Channels.MessageSent.aspx</TraceIdentifier>
                 <Description>Sent a message over a channel.</Description>
                 <AppDomain>client.exe</AppDomain>
                 <Source>System.ServiceModel.Channels.ClientFramingDuplexSessionChannel/35191196</Source>
                <ExtendedData xmlns="http://schemas.microsoft.com/2006/08/ServiceModel/MessageTransmitTraceRecord">

                  <MessageProperties>
                     <AllowOutputBatching>False</AllowOutputBatching>
                  </MessageProperties>
                  <MessageHeaders>
                     <Action d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">http://Microsoft.ServiceModel.Samples/ICalculator/Multiply</Action>
                     <MessageID xmlns="http://www.w3.org/2005/08/addressing">urn:uuid:7c6670d8-4c9c-496e-b6a0-2ceb6db35338</MessageID>
                     <ActivityId CorrelationId="b02e2189-0816-4387-980c-dd8e306440f5" xmlns="http://schemas.microsoft.com/2004/09/ServiceModel/Diagnostics">27c6331d-8998-43aa-a382-03239013a6bd</ActivityId>
                     <ReplyTo xmlns="http://www.w3.org/2005/08/addressing">
                        <Address>http://www.w3.org/2005/08/addressing/anonymous</Address>
                    </ReplyTo>
                    <To d4p1:mustUnderstand="1" xmlns:d4p1="http://www.w3.org/2003/05/soap-envelope" xmlns="http://www.w3.org/2005/08/addressing">net.tcp://localhost/servicemodelsamples/service</To>
                  </MessageHeaders>
                  <RemoteAddress>net.tcp://localhost/servicemodelsamples/service</RemoteAddress>
                </ExtendedData>
            </TraceRecord>
          </DataItem>
       </TraceData>
   </ApplicationData>
</E2ETraceEvent>
```

## <a name="servicemodel-e2e-tracing"></a><span data-ttu-id="eb5b3-133">Трассировка ServiceModel E2E</span><span class="sxs-lookup"><span data-stu-id="eb5b3-133">ServiceModel E2E Tracing</span></span>

<span data-ttu-id="eb5b3-134">Если `System.ServiceModel` источник трассировки задан с параметром, отличным `switchValue` от OFF, `ActivityTracing` WCF создает действия и передает данные для обработки WCF.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-134">When the `System.ServiceModel` trace source is set with a `switchValue` other than Off, and `ActivityTracing`, WCF creates activities and transfers for WCF processing.</span></span>

<span data-ttu-id="eb5b3-135">Действие - это логический блок обработки, объединяющий все связанные с ним трассировки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-135">An activity is a logical unit of processing that groups all traces related to that processing unit.</span></span> <span data-ttu-id="eb5b3-136">Например, для каждого запроса можно определить одно действие.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-136">For example, you can define one activity for each request.</span></span> <span data-ttu-id="eb5b3-137">Перенаправления создают причинно-следственную связь между действиями внутри конечных точек.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-137">Transfers create a causal relationship between activities within endpoints.</span></span> <span data-ttu-id="eb5b3-138">Распространение идентификатора действия позволяет соотносить действия в разных конечных точках.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-138">Propagating the activity ID enables you to relate activities across endpoints.</span></span> <span data-ttu-id="eb5b3-139">Это можно сделать, задав `propagateActivity` = `true` в конфигурации в каждой конечной точке.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-139">This can be done by setting `propagateActivity`=`true` in configuration at every endpoint.</span></span> <span data-ttu-id="eb5b3-140">Действия, перенаправления и распространение позволяют выполнить корреляцию ошибок.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-140">Activities, transfers, and propagation allow you to perform error correlation.</span></span> <span data-ttu-id="eb5b3-141">Это ускоряет выявление первопричины ошибки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-141">In this way, you can find the root cause of an error more quickly.</span></span>

<span data-ttu-id="eb5b3-142">На клиенте для каждого вызова объектной модели создается одно действие WCF (например, открытие ChannelFactory, добавление, разделение и т. д.). Каждый вызов операции обрабатывается в действии "действие процесса".</span><span class="sxs-lookup"><span data-stu-id="eb5b3-142">On the client, one WCF activity is created for each object model call (for example, Open ChannelFactory, Add, Divide, and so on.) Each of the operation calls is processed in a "Process Action" activity.</span></span>

<span data-ttu-id="eb5b3-143">На следующем снимке экрана, извлеченном из примера " [Трассировка и регистрация сообщений](../../samples/tracing-and-message-logging.md) ", на левой панели отображается список действий, созданных в процессе клиента, отсортированных по времени создания.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-143">In the following screenshot, extracted from the [Tracing and Message Logging](../../samples/tracing-and-message-logging.md) sample the left panel displays the list of activities created in the client process, sorted by creation time.</span></span> <span data-ttu-id="eb5b3-144">Ниже приведен хронологический список действий.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-144">The following is a chronological list of activities:</span></span>

- <span data-ttu-id="eb5b3-145">Создана фабрика каналов (ClientBase).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-145">Constructed the channel factory (ClientBase).</span></span>

- <span data-ttu-id="eb5b3-146">Открыта фабрика каналов.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-146">Opened the channel factory.</span></span>

- <span data-ttu-id="eb5b3-147">Обработано действие Add.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-147">Processed the Add action.</span></span>

- <span data-ttu-id="eb5b3-148">Установлен безопасный сеанс (это ПРОИЗОШЛО по первому запросу) и обработаны три ответных сообщения инфраструктуры безопасности: RST, RSTR, SCT (Process message 1, 2, 3).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-148">Set up the Secure Session (this OCCURRED on the first request) and processed three security infrastructure response messages: RST, RSTR, SCT (Process message 1, 2, 3).</span></span>

- <span data-ttu-id="eb5b3-149">Обработаны запросы "Вычесть", "Умножить" и "Разделить".</span><span class="sxs-lookup"><span data-stu-id="eb5b3-149">Processed the Subtract, Multiply, and Divide requests.</span></span>

- <span data-ttu-id="eb5b3-150">Закрыта фабрика каналов, в результате чего закрыт безопасный сеанс и обработана отмена ответа на сообщение безопасности.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-150">Closed the channel factory, and doing so closed the Secure session and processed the security message response Cancel.</span></span>

 <span data-ttu-id="eb5b3-151">Сообщения инфраструктуры безопасности видны из-за привязки wsHttpBinding.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-151">We see the security infrastructure messages because of the wsHttpBinding.</span></span>

> [!NOTE]
> <span data-ttu-id="eb5b3-152">В WCF мы видим сообщения об ответах, которые изначально обрабатывались в отдельном действии (обработать сообщение), прежде чем сопоставлять их с соответствующим действием действия процесса, которое включает сообщение запроса посредством перемещения.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-152">In WCF, we show response messages being processed initially in a separate activity (Process message) before we correlate them to the corresponding Process Action activity that includes the request message, through a transfer.</span></span> <span data-ttu-id="eb5b3-153">Это происходит для сообщений инфраструктуры и асинхронных запросов из-за необходимости проверки сообщения, чтения заголовка с идентификатором activityId и идентификации существующего действия Process Action с помощью этого идентификатора для корреляции с ним.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-153">This happens for infrastructure messages and asynchronous requests and is due to the fact that we must inspect the message, read the activityId header, and identify the existing Process Action activity with that id to correlate to it.</span></span> <span data-ttu-id="eb5b3-154">Для синхронных запросов ответ блокируется и поэтому известно, к какому действию Process Action относится ответ.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-154">For synchronous requests, we are blocking for the response and hence know which Process action the response relates to.</span></span>

<span data-ttu-id="eb5b3-155">На следующем рисунке показаны действия клиента WCF, указанные в списке время создания (левая панель) и вложенные действия и трассировки (верхняя правая панель):</span><span class="sxs-lookup"><span data-stu-id="eb5b3-155">The following image shows WCF client activities listed by creation time (left panel) and their nested activities and traces (upper right panel):</span></span>

![Снимок экрана, показывающий действия клиента WCF, перечисленные по времени создания.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-activities-creation-time.gif)

<span data-ttu-id="eb5b3-157">Когда на левой панели выбирается действие, на верхней правой панели отображаются вложенные действия и трассировки,</span><span class="sxs-lookup"><span data-stu-id="eb5b3-157">When we select an activity in the left panel, we can see nested activities and traces on the upper right panel.</span></span> <span data-ttu-id="eb5b3-158">т. е. это уменьшенное иерархическое представление списка действий слева на основе выбранного родительского действия.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-158">Therefore, this is a reduced hierarchical view of the list of activities on the left, based on the selected parent activity.</span></span> <span data-ttu-id="eb5b3-159">Поскольку первым сделанным запросом является выбранное действие Process action Add, это действие содержит действие Set Up Secure Session (перенаправление в, перенаправление назад от) и трассировки фактической обработки действия Add.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-159">Because the selected Process action Add is the first request made, this activity contains the Set Up Secure Session activity (transfer to, transfer back from), and traces for the actual processing of the Add action.</span></span>

<span data-ttu-id="eb5b3-160">Если дважды щелкнуть действие обработка добавить действие на левой панели, можно увидеть графическое представление действий клиента WCF, связанных с добавлением.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-160">If we double click the Process action Add activity in the left panel, we can see a graphical representation of the client WCF activities related to Add.</span></span> <span data-ttu-id="eb5b3-161">Первое действие слева - корневое действие (0000), являющееся действием по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-161">The first activity on the left is the root activity (0000), which is the default activity.</span></span> <span data-ttu-id="eb5b3-162">WCF передает внешние действия.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-162">WCF transfers out of the ambient activity.</span></span> <span data-ttu-id="eb5b3-163">Если это не определено, WCF передает данные из 0000.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-163">If this is not defined, WCF transfers out of 0000.</span></span> <span data-ttu-id="eb5b3-164">В данном случае второе действие, Process Action Add, выполняет перенаправление из действия 0.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-164">Here, the second activity, Process Action Add, transfers out of 0.</span></span> <span data-ttu-id="eb5b3-165">Затем следует действие Setup Secure Session.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-165">Then we see Setup Secure Session.</span></span>

<span data-ttu-id="eb5b3-166">На следующем рисунке показано представление графа действий клиента WCF, а именно активность окружающей среды (здесь 0), действие обработки и настройка безопасного сеанса.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-166">The following image shows a graph view of WCF client activities, specifically Ambient Activity (here 0), Process action, and Set Up Secure Session:</span></span>

![Диаграмма в средстве просмотра трассировки, показывающая внешние действия и действие обработки.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-activities-graph-ambient-process.gif)

<span data-ttu-id="eb5b3-168">На верхней правой панели отображаются все трассировки, связанные с действием Process Action Add.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-168">On the upper right panel, we can see all traces related to the Process Action Add activity.</span></span> <span data-ttu-id="eb5b3-169">В частности, передано сообщение запроса ("Передано сообщение по каналу") и в том же действии принят ответ ("Получено сообщение по каналу").</span><span class="sxs-lookup"><span data-stu-id="eb5b3-169">Specifically, we have sent the request message ("Sent a message over a channel") and received the response ("Received a message over a channel") in the same activity.</span></span> <span data-ttu-id="eb5b3-170">Это показано на следующей диаграмме.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-170">This is shown in the following graph.</span></span> <span data-ttu-id="eb5b3-171">Для ясности действие Set up Secure Session на диаграмме свернуто.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-171">For clarity, the Set up Secure Session activity is collapsed in the graph.</span></span>

<span data-ttu-id="eb5b3-172">На следующем рисунке показан список трассировок для действия "Обработка действия".</span><span class="sxs-lookup"><span data-stu-id="eb5b3-172">The following image shows a list of traces for the Process Action activity.</span></span> <span data-ttu-id="eb5b3-173">Мы отправим запрос и получаем ответ в том же действии.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-173">We send the request and receive the response in the same activity.</span></span>

![Снимок экрана: средство просмотра трассировки с отображением списка трассировок для действия "Обработка действия"](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/process-action-traces.gif)

<span data-ttu-id="eb5b3-175">Здесь мы загружаем трассировку клиента только для ясности, но трассировки службы (сообщения запроса и сообщения ответа) отображаются в том же действии, если они также загружены в средство и для которых `propagateActivity` было задано значение `true.` это показано на более позднем рисунке.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-175">Here, we load client traces only for clarity, but service traces (request message received and response message sent) appear in the same activity if they are also loaded in the tool and `propagateActivity` was set to `true.` This is shown in a later illustration.</span></span>

<span data-ttu-id="eb5b3-176">В службе модель действий сопоставляется с концепциями WCF следующим образом:</span><span class="sxs-lookup"><span data-stu-id="eb5b3-176">On the service, the activity model maps to the WCF concepts as follows:</span></span>

1. <span data-ttu-id="eb5b3-177">Создается и открывается ServiceHost (при этом может создаваться несколько действий, связанных с основным приложением, например, в случае использования средств обеспечения безопасности).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-177">We construct and open a ServiceHost (this may create several host-related activities, for instance, in the case of security).</span></span>

2. <span data-ttu-id="eb5b3-178">Создается действие Listen At для каждого прослушивателя в ServiceHost (с перенаправлениями в действие Open ServiceHost и из этого действия).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-178">We create a Listen At activity for each listener in the ServiceHost (with transfers in and out of Open ServiceHost).</span></span>

3. <span data-ttu-id="eb5b3-179">Когда прослушиватель обнаруживает запрос на соединение, инициированный клиентом, он передается действию "Receive Bytes", в котором обрабатываются все байты, отправленные клиентом.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-179">When the listener detects a communication request initiated by the client, it transfers to a "Receive Bytes" activity, in which all bytes sent from the client are processed.</span></span> <span data-ttu-id="eb5b3-180">В этом действии можно увидеть любые ошибки соединения, которые произошли во время взаимодействия между клиентом и службой.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-180">In this activity, we can see any connection errors that have happened during the client-service interaction.</span></span>

4. <span data-ttu-id="eb5b3-181">Для каждого полученного набора байтов, который соответствует сообщению, мы обработаем эти байты в действии "обработка сообщения", где мы создаем объект сообщения WCF.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-181">For each set of bytes that is received that corresponds to a message, we process these bytes in a "Process Message" activity, where we create the WCF Message object.</span></span> <span data-ttu-id="eb5b3-182">В этом действии отображаются ошибки, связанные с неправильным конвертом или неверно сформированным сообщением.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-182">In this activity, we see errors related to a bad envelope or a malformed message.</span></span>

5. <span data-ttu-id="eb5b3-183">Когда сообщение сформировано, выполняется перенаправление в действие Process Action.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-183">Once the message is formed, we transfer to a Process Action activity.</span></span> <span data-ttu-id="eb5b3-184">Если для `propagateActivity` задано значение `true` и на клиенте, и в службе, это действие имеет тот же идентификатор, что определен в клиенте и описан ранее.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-184">If `propagateActivity` is set to `true` on both the client and service, this activity has the same id as the one defined in the client, and described previously.</span></span> <span data-ttu-id="eb5b3-185">С этого этапа мы начнем использовать преимущества прямой корреляции между конечными точками, так как все трассировки, созданные в WCF, связанные с запросом, находятся в том же действии, включая обработку ответного сообщения.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-185">From this stage we start to benefit from direct correlation across endpoints, because all traces emitted in WCF that are related to the request are in that same activity, including the response message processing.</span></span>

6. <span data-ttu-id="eb5b3-186">Для необработанного действия мы создадим действие "выполнить код пользователя", чтобы изолировать трассировки, созданные в пользовательском коде, из тех, которые были созданы в WCF.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-186">For out-of-process action, we create an "Execute user code" activity to isolate traces emitted in user code from the ones emitted in WCF.</span></span> <span data-ttu-id="eb5b3-187">В предыдущем примере трассировка "служба отправляет ответ на добавление ответа" создается в действии "выполнение кода пользователя", а не в действии, распространенном клиентом, если применимо.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-187">In the preceding example, the "Service sends Add response" trace is emitted in the "Execute User code" activity not in the activity propagated by the client, if applicable.</span></span>

<span data-ttu-id="eb5b3-188">На приведенной ниже иллюстрации первое действие слева - корневое действие (0000), являющееся действием по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-188">In the illustration that follows, the first activity on the left is the root activity (0000), which is the default activity.</span></span> <span data-ttu-id="eb5b3-189">Следующие три действия предназначены для того, чтобы открыть ServiceHost.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-189">The next three activities are to open the ServiceHost.</span></span> <span data-ttu-id="eb5b3-190">Действие в столбце 5 - прослушиватель, а остальные действия (6 – 8) описывают обработку сообщения системой WCF - от обработки байтов до активации пользовательского кода.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-190">The activity in column 5 is the listener, and the remaining activities (6 to 8) describe the WCF processing of a message, from bytes processing to user code activation.</span></span>

<span data-ttu-id="eb5b3-191">На следующем рисунке показано представление действий службы WCF в графе:</span><span class="sxs-lookup"><span data-stu-id="eb5b3-191">The following image shows a graph view of WCF service activities:</span></span>

![Снимок экрана средства просмотра трассировки с отображением списка действий службы WCF](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-service-activities.gif)

<span data-ttu-id="eb5b3-193">На следующем снимке экрана показаны действия для клиента и службы и выделено действие Process Action Add во всех процессах (оранжевым цветом).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-193">The following screenshot shows the activities for both the client and service, and highlights the Process Action Add activity across processes (orange).</span></span> <span data-ttu-id="eb5b3-194">Стрелки связывают сообщения запроса и ответа, отправленные и полученные клиентом и службой.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-194">Arrows relate the request and response messages sent and received by the client and service.</span></span> <span data-ttu-id="eb5b3-195">Трассировки действия Process Action разделены в процессах на диаграмме, но в верхней правой панели показаны как часть одного действия.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-195">The traces of Process Action are separated across processes in the graph, but shown as part of the same activity in the upper-right panel.</span></span> <span data-ttu-id="eb5b3-196">В этой панели отображаются трассировки клиента для отправленных сообщений, после которых следуют трассировки службы для полученных и обработанных сообщений.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-196">In this panel, we can see client traces for sent messages followed by service traces for received and processed messages.</span></span>

<span data-ttu-id="eb5b3-197">На следующих изображениях показано представление графика как для клиента WCF, так и для действий службы.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-197">The following images shows a graph view of both WCF client and service activities</span></span>

![Граф из средства просмотра трассировки, отображающего как клиент WCF, так и действия службы.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/wcf-client-service-activities.gif)

<span data-ttu-id="eb5b3-199">В следующем сценарии с ошибками соотносятся трассировки ошибок и предупреждений в службе и на клиенте.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-199">In the following error scenario, error and warning traces at the service and client are related.</span></span> <span data-ttu-id="eb5b3-200">Сначала вызывается исключение в пользовательском коде службы (крайнее правое зеленое действие, которое включает трассировку предупреждений для исключения "Служба не может обработать этот запрос в пользовательском коде").</span><span class="sxs-lookup"><span data-stu-id="eb5b3-200">An exception is first thrown in user code on the service (right-most green activity that includes a warning trace for the exception "The service cannot process this request in user code.").</span></span> <span data-ttu-id="eb5b3-201">Когда клиенту отправляется ответ, снова создается трассировка предупреждений, чтобы указать на наличие сообщения о сбое (розовое действие слева).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-201">When the response is sent to the client, a warning trace is again emitted to denote the fault message (left pink activity).</span></span> <span data-ttu-id="eb5b3-202">Затем клиент закрывает свой клиент WCF (желтое действие внизу слева), в результате чего соединение со службой прерывается.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-202">The client then closes its WCF client (yellow activity on the lower-left side), which aborts the connection to the service.</span></span> <span data-ttu-id="eb5b3-203">Служба вызывает ошибку (самое длинное розовое действие справа).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-203">The service throws an error (longest pink activity on the right).</span></span>

<span data-ttu-id="eb5b3-204">![Использование средства просмотра трассировки](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span><span class="sxs-lookup"><span data-stu-id="eb5b3-204">![Using the Trace Viewer](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span></span>

<span data-ttu-id="eb5b3-205">Корреляция ошибок в службе и на клиенте</span><span class="sxs-lookup"><span data-stu-id="eb5b3-205">Error correlation across the service and client</span></span>

<span data-ttu-id="eb5b3-206">Образец, использованный для создания этих трассировок, представляет собой последовательность синхронных запросов, использующих привязку wsHttpBinding.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-206">The sample used to generate these traces is a series of synchronous requests using the wsHttpBinding.</span></span> <span data-ttu-id="eb5b3-207">Для сценариев без обеспечения безопасности или с асинхронными запросами, где действие Process Action выполняет операции начала и окончания, составляющие асинхронный вызов, и показывает перенаправления в действие обратного вызова, диаграмма будет несколько иной.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-207">There are deviations from this graph for scenarios without security, or with asynchronous requests, where the Process Action activity encompasses the begin and end operations that constitute the asynchronous call, and shows transfers to a callback activity.</span></span> <span data-ttu-id="eb5b3-208">Дополнительные сведения о дополнительных сценариях см. [в разделе Сценарии сквозной трассировки](end-to-end-tracing-scenarios.md).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-208">For more information about additional scenarios, see [End-To-End Tracing Scenarios](end-to-end-tracing-scenarios.md).</span></span>

## <a name="troubleshooting-using-the-service-trace-viewer"></a><span data-ttu-id="eb5b3-209">Выявление неполадок с помощью программы Service Trace Viewer</span><span class="sxs-lookup"><span data-stu-id="eb5b3-209">Troubleshooting Using the Service Trace Viewer</span></span>

<span data-ttu-id="eb5b3-210">При загрузке файлов трассировки в программу Service Trace Viewer можно выбрать любое красное или желтое действие на левой панели, чтобы выявить причину неполадки в приложении.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-210">When you load trace files in the Service Trace Viewer Tool, you can select any red or yellow activity on the left panel to track down the cause of a problem in your application.</span></span> <span data-ttu-id="eb5b3-211">Действие 000 обычно имеет необработанные исключения, которые достигают пользователя.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-211">The 000 activity typically has unhandled exceptions that bubble up to the user.</span></span>

<span data-ttu-id="eb5b3-212">На следующем рисунке показано, как выбрать действие красного или желтого цвета для выявления корня проблемы.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-212">The following image shows how to select a red or yellow activity to locate the root of a problem.</span></span>
<span data-ttu-id="eb5b3-213">![Снимок экрана с красным или желтыми действиями для поиска корня проблемы.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/service-trace-viewer.gif)</span><span class="sxs-lookup"><span data-stu-id="eb5b3-213">![Screenshot of red or yellow activities for locating the root of a problem.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/service-trace-viewer.gif)</span></span>

<span data-ttu-id="eb5b3-214">На верхней правой панели можно проанализировать трассировки, связанные с действием, выбранным на левой панели.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-214">On the upper right panel, you can examine traces for the activity you selected on the left.</span></span> <span data-ttu-id="eb5b3-215">Затем можно просмотреть красные или желтые трассировки в этой панели и увидеть, как они коррелируются.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-215">You can then examine red or yellow traces in that panel and see how they are correlated.</span></span> <span data-ttu-id="eb5b3-216">На приведенной выше диаграмме видны трассировки предупреждений для клиента и службы в одном действии Process Action.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-216">In the preceding graph, we see warning traces both for the client and service in the same Process Action activity.</span></span>

<span data-ttu-id="eb5b3-217">Если эти трассировки не позволяют выяснить первопричину ошибки, можно использовать диаграмму, дважды щелкнув выбранное действие на левой панели (здесь Process Action).</span><span class="sxs-lookup"><span data-stu-id="eb5b3-217">If these traces do not provide you with the root cause of the error, you can utilize the graph by double-clicking the selected activity on the left panel (here Process action).</span></span> <span data-ttu-id="eb5b3-218">При этом отображается диаграмма со связанными действиями.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-218">The graph with related activities is then displayed.</span></span> <span data-ttu-id="eb5b3-219">Затем можно развернуть связанные действия (щелкнув знак "+"), чтобы найти первую выданную трассировку красным или желтым цветом в связанном действии.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-219">You can then expand related activities (by clicking the "+" signs) to find the first emitted trace in red or yellow in a related activity.</span></span> <span data-ttu-id="eb5b3-220">Сохраняйте развернутыми действия, которые произошли непосредственно перед представляющей интерес красной или желтой трассировкой, следя за перенаправлениями в связанные действия или потоками сообщений через конечные точки, пока не выясните основную причину неполадки.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-220">Keep expanding the activities that happened just before the red or yellow trace of interest, following transfers to related activities or message flows across endpoints, until you track the root cause of the problem.</span></span>

<span data-ttu-id="eb5b3-221">![Использование средства просмотра трассировки](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span><span class="sxs-lookup"><span data-stu-id="eb5b3-221">![Using the Trace Viewer](media/wcfc-e2etrace9s.gif "wcfc_e2etrace9s")</span></span>

<span data-ttu-id="eb5b3-222">Развертывание действий для выяснения основной причины неполадки</span><span class="sxs-lookup"><span data-stu-id="eb5b3-222">Expanding activities to track the root cause of a problem</span></span>

<span data-ttu-id="eb5b3-223">Если трассировка `ActivityTracing` ServiceModel отключена, а трассировка ServiceModel включена, можно увидеть трассировки ServiceModel, созданные в действии 0000.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-223">If ServiceModel `ActivityTracing` is off but ServiceModel tracing is on, you can see ServiceModel traces emitted in the 0000 activity.</span></span> <span data-ttu-id="eb5b3-224">Однако в этом случае требуется больше усилий, чтобы понять корреляцию этих трассировок.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-224">However, this requires more effort to understand the correlation of these traces.</span></span>

<span data-ttu-id="eb5b3-225">Если включено ведение журнала сообщений, можно использовать вкладку сообщений, чтобы увидеть, на какое сообщение повлияла ошибка.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-225">If Message Logging is enabled, you can use the Message Tab to see which message is impacted by the error.</span></span> <span data-ttu-id="eb5b3-226">При двойном щелчке красного или желтого сообщения появляется графическое представление связанных действий.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-226">By double-clicking a message in red or yellow, you can see the graph view of the related activities.</span></span> <span data-ttu-id="eb5b3-227">Эти действия наиболее тесно связаны с запросом, где произошла ошибка.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-227">These activities are the ones most closely related to the request where an error happened.</span></span>

![Снимок экрана средства просмотра трассировки с включенным ведением журнала сообщений.](./media/using-service-trace-viewer-for-viewing-correlated-traces-and-troubleshooting/message-logging-enabled.gif)

<span data-ttu-id="eb5b3-229">Чтобы начать устранение неполадок, можно также выбрать трассировку сообщений красного или желтого цвета и дважды щелкнуть ее для отслеживания основной причины.</span><span class="sxs-lookup"><span data-stu-id="eb5b3-229">To start troubleshooting, you can also pick a red or yellow message trace and double click it to track the root cause.</span></span>

## <a name="see-also"></a><span data-ttu-id="eb5b3-230">Дополнительно</span><span class="sxs-lookup"><span data-stu-id="eb5b3-230">See also</span></span>

- [<span data-ttu-id="eb5b3-231">Сценарии сквозной трассировки</span><span class="sxs-lookup"><span data-stu-id="eb5b3-231">End-To-End Tracing Scenarios</span></span>](end-to-end-tracing-scenarios.md)
- [<span data-ttu-id="eb5b3-232">Программа Service Trace Viewer (SvcTraceViewer.exe)</span><span class="sxs-lookup"><span data-stu-id="eb5b3-232">Service Trace Viewer Tool (SvcTraceViewer.exe)</span></span>](../../service-trace-viewer-tool-svctraceviewer-exe.md)
- [<span data-ttu-id="eb5b3-233">Трассировка</span><span class="sxs-lookup"><span data-stu-id="eb5b3-233">Tracing</span></span>](index.md)
