---
title: Настройка трассировки
ms.date: 03/30/2017
helpviewer_keywords:
- tracing [WCF]
ms.assetid: 82922010-e8b3-40eb-98c4-10fc05c6d65d
ms.openlocfilehash: b433263cc4d72b6418cf75c278316444c83ada8c
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2019
ms.locfileid: "69933509"
---
# <a name="configuring-tracing"></a>Настройка трассировки
В этом разделе описывается, как включить трассировку, настроить создание трассировки источниками трассировки и задать уровни трассировки, задать распространение и трассировку действий для поддержки сквозной корреляции трассировки, а также настроить доступ прослушивателей трассировки к трассировкам.  
  
 Рекомендации по параметрам трассировки в рабочей или отладочной среде см. в разделе [Рекомендуемые параметры для трассировки и ведения журнала сообщений](../../../../../docs/framework/wcf/diagnostics/tracing/recommended-settings-for-tracing-and-message-logging.md).  
  
> [!IMPORTANT]
> В Windows 8, чтобы приложение могло создавать журналы трассировки, необходимо запустить его с расширенными правами доступа (запуск от имени администратора).  
  
## <a name="enabling-tracing"></a>Включение трассировки  
 Windows Communication Foundation (WCF) выводит следующие данные для диагностической трассировки:  
  
- Трассировки основных этапов процесса по всем компонентам приложений, таких как вызовы операций, исключения кода, предупреждения и прочие значительные события обработки.  
  
- События ошибок Windows при сбоях возможности трассировки. См. раздел [ведение журнала событий](../../../../../docs/framework/wcf/diagnostics/event-logging/index.md).  
  
 Трассировка WCF построена поверх <xref:System.Diagnostics>. Чтобы воспользоваться трассировкой, необходимо определить источники трассировки в файле конфигурации или в коде. WCF определяет источник трассировки для каждой сборки WCF. Источник `System.ServiceModel` трассировки — это наиболее общий источник трассировки WCF, который записывает этапы обработки в стеке связи WCF, от ввода/вывода транспорта до ввода/вывода пользовательского кода. Источник трассировки `System.ServiceModel.MessageLogging` записывает все сообщения, проходящие через систему.  
  
 По умолчанию трассировка отключена. Чтобы активировать трассировку, необходимо создать прослушиватель трассировки и установить уровень трассировки, отличный от "Выкл.", для выбранного источника трассировки в конфигурации. в противном случае WCF не создает никакие трассировки. Если прослушиватель не указан, трассировка автоматически отключается. Если прослушиватель определен, но уровень не указан, по умолчанию устанавливается уровень «Off», при котором трассировка не создается.  
  
 При использовании точек расширения WCF, таких как пользовательские вызывающие операции, следует создавать собственные трассировки. Это связано с тем, что при реализации точки расширяемости WCF больше не может создавать стандартные трассировки в пути по умолчанию. Если поддержка трассировки вручную путем создания трассировки не реализована, можно не увидеть ожидаемые трассировки.  
  
 Трассировку можно настроить, внеся изменения в файл конфигурации приложения: Web.config (для веб-приложений) или Appname.exe.config (для резидентных приложений). Ниже приводится пример подобного изменения. Дополнительные сведения об этих параметрах см. в разделе "Настройка прослушивателей трассировки для использования трассировок".  
  
```xml  
<configuration>  
   <system.diagnostics>  
      <sources>  
            <source name="System.ServiceModel"   
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
            <listeners>  
               <add name="traceListener"   
                   type="System.Diagnostics.XmlWriterTraceListener"   
                   initializeData= "c:\log\Traces.svclog" />  
            </listeners>  
         </source>  
      </sources>  
   </system.diagnostics>  
</configuration>  
```  
  
> [!NOTE]
> Чтобы изменить файл конфигурации проекта службы WCF в Visual Studio, щелкните правой кнопкой мыши файл конфигурации приложения — Web. config для веб-приложений или имя_приложения. exe. config для самостоятельно размещенного приложения в **Обозреватель решений**. Затем выберите пункт изменить пункт контекстного меню для **настройки WCF** . Запускается [средство редактора конфигурации (SvcConfigEditor. exe)](../../../../../docs/framework/wcf/configuration-editor-tool-svcconfigeditor-exe.md), которое позволяет изменять параметры конфигурации для служб WCF с помощью графического пользовательского интерфейса.  
  
## <a name="configuring-trace-sources-to-emit-traces"></a>Настройка создания трассировки источниками трассировки  
 WCF определяет источник трассировки для каждой сборки. Трассировки, созданные в пределах сборки, доступны прослушивателям, определенным для этого источника. Определяются следующие источники трассировки:  
  
- System. ServiceModel: Записывает в журнал все этапы обработки WCF, при каждом считывании конфигурации, обработке сообщения, обработке безопасности, отправке сообщения в пользовательском коде и т. д.  
  
- System. ServiceModel. Мессажелоггинг: Записывает в журнал все сообщения, которые проходят через систему.  
  
- System.IdentityModel.  
  
- System.ServiceModel.Activation.  
  
- System. IO. log: Ведение журнала для интерфейса .NET Framework файловая система CLFS (CLFS).  
  
- System. Runtime. Serialization: Регистрируется при чтении или записи объектов.  
  
- CardSpace.  
  
 Можно настроить все источники трассировки так, чтобы они использовали один и тот же (общий) прослушиватель, как показано в следующем примере конфигурации.  
  
```xml  
<configuration>  
    <system.diagnostics>  
        <sources>  
            <source name="System.ServiceModel"   
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="CardSpace">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IO.Log">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.Runtime.Serialization">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IdentityModel">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
        </sources>  
  
        <sharedListeners>  
            <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="c:\log\Traces.svclog" />  
        </sharedListeners>  
    </system.diagnostics>  
</configuration>  
```  
  
 Кроме того, можно добавить пользовательские источники трассировки, создающие трассировки пользовательского кода, как показано в следующем примере.  
  
```xml  
<system.diagnostics>  
   <sources>  
       <source name="UserTraceSource" switchValue="Warning, ActivityTracing" >  
          <listeners>  
              <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="C:\logs\UserTraces.svclog" />  
          </listeners>  
       </source>  
   </sources>  
   <trace autoflush="true" />   
</system.diagnostics>  
```  
  
 Дополнительные сведения о создании определяемых пользователем источников трассировки см. в разделе [Расширение трассировки](../../../../../docs/framework/wcf/samples/extending-tracing.md).  
  
## <a name="configuring-trace-listeners-to-consume-traces"></a>Настройка потребления трассировки прослушивателями трассировки  
 Во время выполнения веб-каналы WCF отслеживают данные в прослушиватели, которые обрабатывают данные. WCF предоставляет несколько предопределенных прослушивателей для <xref:System.Diagnostics>, которые отличаются в формате, используемом для вывода. Можно добавлять пользовательские типы прослушивателей.  
  
 С помощью `add` можно задать имя и тип прослушивателя трассировки, который требуется использовать. В данном примере конфигурации создается прослушиватель с именем `traceListener` и добавляется стандартный прослушиватель трассировки .NET Framework (`System.Diagnostics.XmlWriterTraceListener`) в качестве типа, который требуется использовать. Для каждого источника можно добавить любое количество прослушивателей трассировки. Если прослушиватель трассировки выполняет трассировку в файл, необходимо указать расположение и имя выходного файла в файле конфигурации. Для этого необходимо указать имя файла для этого прослушивателя в качестве значения для `initializeData`. Если имя файла не указано, используется случайное имя, сгенерированное на основе используемого типа прослушивателя. Если используется <xref:System.Diagnostics.XmlWriterTraceListener>, создается имя файла без расширения. Если реализовать пользовательский прослушиватель, с помощью этого атрибута также можно получать другие данные инициализации, помимо имени файла. Например, с его помощью можно указать идентификатор базы данных.  
  
 Пользовательский прослушиватель трассировки можно настроить так, чтобы он отправлял трассировку по сети, например в удаленную базу данных. Разработчику приложения следует обеспечить надлежащее управление доступом к журналам трассировки на удаленном компьютере.  
  
 Также можно настроить прослушиватель трассировки программно. Дополнительные сведения см. в разделе [Практическое руководство. Создание и инициализация прослушивателей](https://go.microsoft.com/fwlink/?LinkId=94648) трассировки и [Создание пользовательского](https://go.microsoft.com/fwlink/?LinkId=96239)прослушивателя TraceListener.  
  
> [!CAUTION]
>  Поскольку прослушиватель `System.Diagnostics.XmlWriterTraceListener` не является потокобезопасным, источник трассировки может монопольно блокировать ресурсы при выводе трассировки. Если несколько потоков выводят трассировку в источник трассировки, использующий (согласно заданным настройкам) этот прослушиватель, может возникнуть состязание за ресурсы, что приводит к существенному падению производительности. Чтобы устранить эту проблему, реализуйте потокобезопасный пользовательский прослушиватель.  
  
## <a name="trace-level"></a>Уровень трассировки  
 Уровень трассировки контролируется параметром `switchValue` источника трассировки. Доступные уровни трассировки приведены в следующей таблице.  
  
|Уровень трассировки|Характер отслеживаемых событий|Содержимое отслеживаемых событий|Отслеживаемые события|Целевая категория пользователей|  
|-----------------|----------------------------------|-----------------------------------|--------------------|-----------------|  
|Off|Н/Д|Н/Д|Трассировки не создаются.|Н/Д|  
|Critical|"Отрицательные" события: события, которые указывают на непредвиденную обработку или состояние ошибки.||В журнал заносятся необработанные исключения, в том числе следующие:<br /><br /> -OutOfMemoryException<br />-ThreadAbortException (среда CLR вызывает любой Среадабортексцептионхандлер)<br />-StackOverflowException (не может быть перехвачен)<br />-ConfigurationErrorsException<br />-SEHException<br />— Ошибки запуска приложения<br />— События FailFast<br />-Зависание системы<br />— Подозрительные сообщения: трассировки сообщений, вызывающие сбой приложения.|Администраторы<br /><br /> Разработчики приложений|  
|Error|"Отрицательные" события: события, которые указывают на непредвиденную обработку или состояние ошибки.|Возникло непредвиденное состояние обработки. Приложению не удалось выполнить задачу требуемым образом. Впрочем, приложение все еще работает.|Все исключения заносятся в журнал.|Администраторы<br /><br /> Разработчики приложений|  
|Предупреждение|"Отрицательные" события: события, которые указывают на непредвиденную обработку или состояние ошибки.|Возникла (или может возникнуть) проблема, но приложение все же работает надлежащим образом. Впрочем, его правильное выполнение может прекратиться.|— Приложение получает больше запросов, чем разрешает его параметры регулирования.<br />-Принимающая очередь приближается к максимальному настроенному объему.<br />-Превышено время ожидания.<br />— Учетные данные отклоняются.|Администраторы<br /><br /> Разработчики приложений|  
|Сведения|"Положительные" события: события, помечающие успешные вехи|Успешно пройденные важные этапы выполнения приложения, вне зависимости от того, правильно ли работает приложение.|Как правило, создаются сообщения, полезные для мониторинга и диагностики состояния системы, измерений производительности или профилирования. Эту информацию можно использовать для планирования загрузки и управления производительностью.<br /><br /> — Каналы создаются.<br />— Прослушиватели конечной точки созданы.<br />— Сообщение переходит/оставляет транспорт.<br />— Токен безопасности извлекается.<br />— Чтение параметра конфигурации.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|Verbose|"Положительные" события: события, помечающие успешные вехи.|Создаются события низкого уровня как для пользовательского кода, так и для обслуживания.|Как правило, этот уровень можно использовать для отладки или оптимизации приложения.<br /><br /> -Понятный заголовок сообщения.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|ActivityTracing||События переходов между действиями по обработке и компонентами.|Этот уровень позволяет администраторам и разработчикам коррелировать приложения из одного домена приложений.<br /><br /> — Трассировка для границ действий, таких как запуск и завершение.<br />— Трассировки для передачи.|Все|  
|Все||Приложение может работать надлежащим образом. Создаются все события.|Все вышеперечисленные события.|Все|  
  
 Каждый уровень трассировки от Verbose до Critical включает все вышестоящие уровни, за исключением уровня "Off". Например, если прослушиватель прослушивает уровень Warning, он получает трассировки, имеющие уровень Critical, Error и Warning. Уровень All включает в себя все события уровней от Verbose до Critical, а также события ActivityTracing (прослеживание действий).  
  
> [!CAUTION]
>  Уровни Information, Verbose и ActivityTracing создают большое количество трассировок, что может негативно сказаться на производительности в отношении обработки сообщений, если все доступные ресурсы компьютера использованы.  
  
## <a name="configuring-activity-tracing-and-propagation-for-correlation"></a>Настройка распространения и трассировки действий для корреляции  
 Для атрибута `activityTracing` можно задать значение `switchValue`, чтобы включить трассировку действий, создающую трассировку для границ действий и передач в пределах конечных точек.  
  
> [!NOTE]
> При использовании определенных функций расширения в WCF вы можете получить <xref:System.NullReferenceException> , когда включена трассировка действий. Чтобы устранить эту проблему, проверьте файл конфигурации своего приложения: атрибут `switchValue` для соответствующего источника трассировки не должен иметь значение `activityTracing`.  
  
 Атрибут `propagateActivity` указывает, должно ли действие распространяться на другие конечные точки, участвующие в обмене сообщениями. Если присвоить ему значение `true`, можно с помощью файлов трассировки, созданных любыми двумя конечными точками, проследить прохождение набора трассировок от одной конечной точки до набора трассировок на другой конечной точке.  
  
 Дополнительные сведения о трассировке и распространении действий см. в разделе [распространение](../../../../../docs/framework/wcf/diagnostics/tracing/propagation.md).  
  
 Как `propagateActivity` , `ActivityTracing` так и логические значения применяются к System. ServiceModel TraceSource. `ActivityTracing` Значение также применяется к любому источнику трассировки, включая WCF или определяемые пользователем.  
  
 Атрибут `propagateActivity` нельзя использовать для пользовательских источников трассировок. Для распространения идентификатора действия пользовательского кода необходимо убедиться, что ServiceModel `ActivityTracing` не задано, тогда как ServiceModel `propagateActivity` имеет значение `true`.  
  
## <a name="see-also"></a>См. также

- [Трассировка](../../../../../docs/framework/wcf/diagnostics/tracing/index.md)
- [Администрирование и диагностика](../../../../../docs/framework/wcf/diagnostics/index.md)
- [Практическое руководство. Создание и инициализация прослушивателей трассировки](https://go.microsoft.com/fwlink/?LinkId=94648)
- [Создание настраиваемого прослушивателя трассировки](https://go.microsoft.com/fwlink/?LinkId=96239)
