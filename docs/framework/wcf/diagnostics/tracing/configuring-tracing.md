---
title: Настройка трассировки
ms.date: 03/30/2017
helpviewer_keywords:
- tracing [WCF]
ms.assetid: 82922010-e8b3-40eb-98c4-10fc05c6d65d
ms.openlocfilehash: aca3b5c54bff9c2b4c5380c04dd0da162215b088
ms.sourcegitcommit: 79b0dd8bfc63f33a02137121dd23475887ecefda
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/01/2020
ms.locfileid: "80523312"
---
# <a name="configuring-tracing"></a>Настройка трассировки
В этом разделе описывается, как включить трассировку, настроить создание трассировки источниками трассировки и задать уровни трассировки, задать распространение и трассировку действий для поддержки сквозной корреляции трассировки, а также настроить доступ прослушивателей трассировки к трассировкам.  
  
 Для отслеживания рекомендаций настроек в среде производства или отладки обратитесь к [Рекомендуемые настройки для отслеживания и отслеживания сообщений.](../../../../../docs/framework/wcf/diagnostics/tracing/recommended-settings-for-tracing-and-message-logging.md)  
  
> [!IMPORTANT]
> В Windows 8, чтобы приложение могло создавать журналы трассировки, необходимо запустить его с расширенными правами доступа (запуск от имени администратора).  
  
## <a name="enabling-tracing"></a>Включение трассировки  
 Фонд связи Windows (WCF) выводит следующие данные для отслеживания:  
  
- Трассировки основных этапов процесса по всем компонентам приложений, таких как вызовы операций, исключения кода, предупреждения и прочие значительные события обработки.  
  
- События ошибок Windows при сбоях возможности трассировки. Смотрите [журнал событий](../../../../../docs/framework/wcf/diagnostics/event-logging/index.md).  
  
 Отслеживание WCF построено <xref:System.Diagnostics>на вершине . Чтобы воспользоваться трассировкой, необходимо определить источники трассировки в файле конфигурации или в коде. WCF определяет источник трассировки для каждой сборки WCF. Источник `System.ServiceModel` трассировки является наиболее общим источником следов WCF и записывает вехи обработки в стеже связи WCF, от входа/выезда транспорта до входа/оставляющего пользовательского кода. Источник трассировки `System.ServiceModel.MessageLogging` записывает все сообщения, проходящие через систему.  
  
 По умолчанию трассировка отключена. Чтобы активировать трассировку, необходимо создать слушателя трассировки и установить уровень трассировки, кроме "Off" для выбранного источника трассировки в конфигурации; в противном случае WCF не генерирует никаких следов. Если прослушиватель не указан, трассировка автоматически отключается. Если прослушиватель определен, но уровень не указан, по умолчанию устанавливается уровень «Off», при котором трассировка не создается.  
  
 Если вы используете точки разгибаемости WCF, такие как пользовательские операции invokers, вы должны излучать свои собственные следы. Это связано с тем, что при реализации точки расширяемости WCF больше не может излучать стандартные следы в пути по умолчанию. Если поддержка трассировки вручную путем создания трассировки не реализована, можно не увидеть ожидаемые трассировки.  
  
 Трассировку можно настроить, внеся изменения в файл конфигурации приложения: Web.config (для веб-приложений) или Appname.exe.config (для резидентных приложений). Ниже приводится пример подобного изменения. Для получения дополнительной информации об этих настройках см.  
  
```xml  
<configuration>  
   <system.diagnostics>  
      <sources>  
         <source name="System.ServiceModel"
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
            <listeners>  
               <add name="traceListener"
                   type="System.Diagnostics.XmlWriterTraceListener"
                   initializeData= "c:\log\Traces.svclog" />  
            </listeners>  
         </source>  
      </sources>  
   </system.diagnostics>  
</configuration>  
```  
  
> [!NOTE]
> Чтобы отсеять файл конфигурации проекта службы WCF в Visual Studio, нажмите правона нажатие файла конфигурации приложения — либо Web.config для веб-приложений, либо Appname.exe.config для самостоятельно госприложения в **Solution Explorer.** Затем выберите элемент контекстного меню **конфигурации Edit WCF.** Это запускает [инструмент редактора конфигурации (SvcConfigEditor.exe),](../../../../../docs/framework/wcf/configuration-editor-tool-svcconfigeditor-exe.md)который позволяет изменять настройки конфигурации для служб WCF с помощью графического пользовательского интерфейса.  
  
## <a name="configuring-trace-sources-to-emit-traces"></a>Настройка создания трассировки источниками трассировки  
 WCF определяет источник трассировки для каждой сборки. Трассировки, созданные в пределах сборки, доступны прослушивателям, определенным для этого источника. Определяются следующие источники трассировки:  
  
- System.ServiceModel: Регистрирует все этапы обработки WCF, когда считывается конфигурация, сообщение обрабатывается в транспорте, обработке безопасности, отправке сообщения в коде пользователя и так далее.  
  
- System.ServiceModel.MessageLogging: записывает в журнал все сообщения, проходящие через систему.  
  
- System.IdentityModel.  
  
- System.ServiceModel.Activation.  
  
- System.IO.Log: средство ведения журнала для интерфейса платформы .NET Framework для системы CLFS.  
  
- System.Runtime.Serialization: регистрирует в журнале чтение и запись объектов.  
  
- CardSpace.  
  
 Можно настроить все источники трассировки так, чтобы они использовали один и тот же (общий) прослушиватель, как показано в следующем примере конфигурации.  
  
```xml  
<configuration>  
    <system.diagnostics>  
        <sources>  
            <source name="System.ServiceModel"
                    switchValue="Information, ActivityTracing"  
                    propagateActivity="true">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="CardSpace">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IO.Log">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.Runtime.Serialization">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
            <source name="System.IdentityModel">  
                <listeners>  
                    <add name="xml" />  
                </listeners>  
            </source>  
        </sources>  
  
        <sharedListeners>  
            <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="c:\log\Traces.svclog" />  
        </sharedListeners>  
    </system.diagnostics>  
</configuration>  
```  
  
 Кроме того, можно добавить пользовательские источники трассировки, создающие трассировки пользовательского кода, как показано в следующем примере.  
  
```xml  
<system.diagnostics>  
   <sources>  
       <source name="UserTraceSource" switchValue="Warning, ActivityTracing" >  
          <listeners>  
              <add name="xml"  
                 type="System.Diagnostics.XmlWriterTraceListener"  
                 initializeData="C:\logs\UserTraces.svclog" />  
          </listeners>  
       </source>  
   </sources>  
   <trace autoflush="true" />
</system.diagnostics>  
```  
  
 Для получения дополнительной информации о создании определенных пользователем источников трассировки [см.](../../../../../docs/framework/wcf/samples/extending-tracing.md)  
  
## <a name="configuring-trace-listeners-to-consume-traces"></a>Настройка потребления трассировки прослушивателями трассировки  
 Во время выполнения WCF передает слушателям данные, обрабатываемые данными. WCF предоставляет несколько <xref:System.Diagnostics>предопределенных слушателей для , которые отличаются в формате, который они используют для вывода. Можно добавлять пользовательские типы прослушивателей.  
  
 С помощью `add` можно задать имя и тип прослушивателя трассировки, который требуется использовать. В данном примере конфигурации создается прослушиватель с именем `traceListener` и добавляется стандартный прослушиватель трассировки .NET Framework (`System.Diagnostics.XmlWriterTraceListener`) в качестве типа, который требуется использовать. Для каждого источника можно добавить любое количество прослушивателей трассировки. Если прослушиватель трассировки выполняет трассировку в файл, необходимо указать расположение и имя выходного файла в файле конфигурации. Для этого необходимо указать имя файла для этого прослушивателя в качестве значения для `initializeData`. Если имя файла не указано, используется случайное имя, сгенерированное на основе используемого типа прослушивателя. Если используется <xref:System.Diagnostics.XmlWriterTraceListener>, создается имя файла без расширения. Если реализовать пользовательский прослушиватель, с помощью этого атрибута также можно получать другие данные инициализации, помимо имени файла. Например, с его помощью можно указать идентификатор базы данных.  
  
 Пользовательский прослушиватель трассировки можно настроить так, чтобы он отправлял трассировку по сети, например в удаленную базу данных. Разработчику приложения следует обеспечить надлежащее управление доступом к журналам трассировки на удаленном компьютере.  
  
 Также можно настроить прослушиватель трассировки программно. Для получения дополнительной информации, [см. Как: Создать и искоренять trace слушателей](../../../debug-trace-profile/how-to-create-and-initialize-trace-listeners.md) и [создание пользовательских TraceListener](https://docs.microsoft.com/archive/msdn-magazine/2006/april/clr-inside-out-extending-system-diagnostics).  
  
> [!CAUTION]
> Поскольку прослушиватель `System.Diagnostics.XmlWriterTraceListener` не является потокобезопасным, источник трассировки может монопольно блокировать ресурсы при выводе трассировки. Если несколько потоков выводят трассировку в источник трассировки, использующий (согласно заданным настройкам) этот прослушиватель, может возникнуть состязание за ресурсы, что приводит к существенному падению производительности. Чтобы устранить эту проблему, реализуйте потокобезопасный пользовательский прослушиватель.  
  
## <a name="trace-level"></a>Уровень трассировки  
 Уровень трассировки контролируется параметром `switchValue` источника трассировки. Доступные уровни трассировки приведены в следующей таблице.  
  
|Уровень трассировки|Характер отслеживаемых событий|Содержимое отслеживаемых событий|Отслеживаемые события|Целевая категория пользователей|  
|-----------------|----------------------------------|-----------------------------------|--------------------|-----------------|  
|Выкл.|Н/Д|Н/Д|Трассировки не создаются.|Н/Д|  
|Critical|"Отрицательные" события: события, указывающие на неожиданную обработку или условие ошибки.||В журнал заносятся необработанные исключения, в том числе следующие:<br /><br /> - OutOfMemoryИсключение<br />- ThreadAbortException (CLR вызывает любой ThreadAbortExceptionHandler)<br />- StackOverflowException (не может быть пойман)<br />- КонфигурацияОшибки Исключение<br />- SEH Исключение<br />- Ошибки начала приложения<br />- Failfast события<br />- Система зависает<br />- Ядовитые сообщения: следы сообщений, которые вызывают сбой приложения.|Администраторы<br /><br /> Разработчики приложений|  
|Error|"Отрицательные" события: события, указывающие на неожиданную обработку или условие ошибки.|Возникло непредвиденное состояние обработки. Приложению не удалось выполнить задачу требуемым образом. Впрочем, приложение все еще работает.|Все исключения заносятся в журнал.|Администраторы<br /><br /> Разработчики приложений|  
|Предупреждение|"Отрицательные" события: события, указывающие на неожиданную обработку или условие ошибки.|Возникла (или может возникнуть) проблема, но приложение все же работает надлежащим образом. Впрочем, его правильное выполнение может прекратиться.|- Приложение получает больше запросов, чем позволяют его настройки регулирования.<br />- Очередь получения близка к максимально настроенной емкости.<br />- Тайм-аут превышен.<br />- Полномочия отклоняются.|Администраторы<br /><br /> Разработчики приложений|  
|Сведения|«Позитивные» события: события, знаменующие успешные вехи|Успешно пройденные важные этапы выполнения приложения, вне зависимости от того, правильно ли работает приложение.|Как правило, создаются сообщения, полезные для мониторинга и диагностики состояния системы, измерений производительности или профилирования. Эту информацию можно использовать для планирования загрузки и управления производительностью.<br /><br /> - Создаются каналы.<br />- Создаются конечные слушатели.<br />- Сообщение входит/ оставляет транспорт.<br />- Маркер безопасности извлекается.<br />- Настройка конфигурации читается.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|Подробный|«Позитивные» события: события, которые знаменуют успешные вехи.|Создаются события низкого уровня как для пользовательского кода, так и для обслуживания.|Как правило, этот уровень можно использовать для отладки или оптимизации приложения.<br /><br /> - Понятый заголовок сообщения.|Администраторы<br /><br /> Разработчики приложений<br /><br /> Разработчики программных продуктов.|  
|ActivityTracing||События переходов между действиями по обработке и компонентами.|Этот уровень позволяет администраторам и разработчикам коррелировать приложения из одного домена приложений.<br /><br /> - Следы границ активности, такие как начало/остановка.<br />- Следы для трансферов.|All|  
|All||Приложение может работать надлежащим образом. Создаются все события.|Все вышеперечисленные события.|All|  
  
 Каждый уровень трассировки от Verbose до Critical включает все вышестоящие уровни, за исключением уровня "Off". Например, если прослушиватель прослушивает уровень Warning, он получает трассировки, имеющие уровень Critical, Error и Warning. Уровень All включает в себя все события уровней от Verbose до Critical, а также события ActivityTracing (прослеживание действий).  
  
> [!CAUTION]
> Уровни Information, Verbose и ActivityTracing создают большое количество трассировок, что может негативно сказаться на производительности в отношении обработки сообщений, если все доступные ресурсы компьютера использованы.  
  
## <a name="configuring-activity-tracing-and-propagation-for-correlation"></a>Настройка распространения и трассировки действий для корреляции  
 Для атрибута `activityTracing` можно задать значение `switchValue`, чтобы включить трассировку действий, создающую трассировку для границ действий и передач в пределах конечных точек.  
  
> [!NOTE]
> При использовании определенных функций размножемости в WCF можно получить <xref:System.NullReferenceException> возможность отслеживания активности. Чтобы устранить эту проблему, проверьте файл конфигурации своего приложения: атрибут `switchValue` для соответствующего источника трассировки не должен иметь значение `activityTracing`.  
  
 Атрибут `propagateActivity` указывает, должно ли действие распространяться на другие конечные точки, участвующие в обмене сообщениями. Если присвоить ему значение `true`, можно с помощью файлов трассировки, созданных любыми двумя конечными точками, проследить прохождение набора трассировок от одной конечной точки до набора трассировок на другой конечной точке.  
  
 Для получения дополнительной информации о отслеживании деятельности и распространении, [см.](../../../../../docs/framework/wcf/diagnostics/tracing/propagation.md)  
  
 И `propagateActivity` `ActivityTracing` значения Boolean применяются к System.ServiceModel TraceSource. Значение `ActivityTracing` также применяется к любому источнику трассировки, включая WCF или пользовательские источники.  
  
 Атрибут `propagateActivity` нельзя использовать для пользовательских источников трассировок. Для распространения идентификатора действия пользовательского кода необходимо убедиться, что ServiceModel `ActivityTracing` не задано, тогда как ServiceModel `propagateActivity` имеет значение `true`.  
  
## <a name="see-also"></a>См. также

- [Трассировка](../../../../../docs/framework/wcf/diagnostics/tracing/index.md)
- [Администрирование и диагностика](../../../../../docs/framework/wcf/diagnostics/index.md)
- [Практическое руководство. Создание и инициализация прослушивателей трассировки](../../../debug-trace-profile/how-to-create-and-initialize-trace-listeners.md)
- [Создание пользовательского прослушивателя трассировки](https://docs.microsoft.com/archive/msdn-magazine/2006/april/clr-inside-out-extending-system-diagnostics)
