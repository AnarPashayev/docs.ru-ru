---
title: Счетчики производительности WCF
ms.date: 03/30/2017
helpviewer_keywords:
- performance counters [WCF]
ms.assetid: f559b2bd-ed83-4988-97a1-e88f06646609
ms.openlocfilehash: 31c5b386d707aa49cd36d536f1c8b419eb74a658
ms.sourcegitcommit: 0be8a279af6d8a43e03141e349d3efd5d35f8767
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/18/2019
ms.locfileid: "59087863"
---
# <a name="wcf-performance-counters"></a>Счетчики производительности WCF
Windows Communication Foundation (WCF) включает в себя большой набор счетчиков производительности с помощью которых можно измерять производительность приложения.  
  
## <a name="enabling-performance-counters"></a>Включение счетчиков производительности  
 Счетчики производительности для службы WCF через файл конфигурации app.config службы WCF, можно включить следующим образом:  
  
```xml  
<configuration>  
    <system.serviceModel>  
        <diagnostics performanceCounters="All" />  
    </system.serviceModel>  
</configuration>  
```  
  
 Атрибут `performanceCounters` можно настроить так, чтобы включать определенный тип счетчиков производительности. Допустимы следующие значения:  
  
-   Все: Включены счетчики всех категорий (ServiceModelService, ServiceModelEndpoint и ServiceModelOperation).  
  
-   ServiceOnly Включены только счетчики категории ServiceModelService. Это значение по умолчанию.  
  
-   OFF: Счетчики производительности ServiceModel * отключены.  
  
 Если вы хотите включить счетчики производительности для всех приложений WCF, можно поместить параметры конфигурации в файле Machine.config.  См. в разделе **увеличение объема памяти для счетчиков производительности** приведенном ниже разделе Дополнительные сведения о настройке достаточного объема памяти для счетчиков производительности на компьютере.  
  
 При использовании точки расширения WCF, например средства вызова пользовательских операций, необходимо также создавать свои собственные счетчики производительности. Это потому, что если реализована точка расширяемости, WCF не сможет создавать стандартные данные счетчиков производительности в пути по умолчанию. Если поддержка трассировки вручную путем создания счетчика производительности не реализована, можно не увидеть ожидаемые данные счетчика производительности.  
  
 Также счетчики производительности можно включить в коде следующим образом.  
  
```  
using System.Configuration;  
using System.ServiceModel.Configuration;  
using System.ServiceModel.Diagnostics;  
Configuration config = ConfigurationManager.OpenExeConfiguration(  
    ConfigurationUserLevel.None);  
ServiceModelSectionGroup sg = ServiceModelSectionGroup.GetSectionGroup(config);  
sg.Diagnostic.PerformanceCounters = PerformanceCounterScope.All;  
config.Save();  
```  
  
## <a name="viewing-performance-data"></a>Просмотр данных производительности  
 Чтобы просмотреть данные, полученные от счетчиков производительности, можно использовать системный монитор (Perfmon.exe), поставляемый вместе с Windows. Это средство можно запустить, выбрав **запустить**и нажмите кнопку **запуска** и тип `perfmon.exe` в диалоговом окне.  
  
> [!NOTE]
>  Экземпляры счетчиков производительности могут быть выпущены до того, как диспетчер конечной точки обработает последние сообщения. Это может привести к тому, что данные производительности для некоторых сообщений не будут получены.  
  
## <a name="increasing-memory-size-for-performance-counters"></a>Увеличение объема памяти для счетчиков производительности  
 WCF использует отдельную общую память для категорий счетчиков производительности.  
  
 По умолчанию объем отдельной общей памяти составляет четвертую часть от объема глобальной памяти счетчиков производительности. По умолчанию объем глобальной памяти счетчиков производительности составляет 524 288 байт. Таким образом три категории счетчиков производительности WCF имеют размер по умолчанию — примерно 128 КБ. В зависимости от характеристик среды выполнения приложений WCF на компьютере, память счетчиков производительности может быть исчерпана. В этом случае WCF записывает ошибку в журнале событий приложений. Содержимое ошибки указывает, что счетчик производительности не был загружен, и запись содержит исключение «System.InvalidOperationException: Просмотра файла пользовательских счетчиков не хватает памяти.» Если включена трассировка на уровне ошибок, этот сбой также трассируется. Если память счетчиков производительности исчерпана, продолжение работы приложений WCF с включенными счетчиками производительности может отрицательно сказаться на производительности. Если вы обладаете правами администратора данного компьютера, настройте его так, чтобы выделить достаточно памяти для поддержки максимального количества счетчиков производительности, которые могут существовать в любое время.  
  
 Можно изменить объем памяти счетчиков производительности для категорий WCF в реестре. Для этого необходимо добавить новое значение DWORD с именем `FileMappingSize` в три следующих расположения и задать для него требуемое значение в байтах. Перезагрузите компьютер, чтобы эти изменения вступили в силу.  
  
-   HKLM\System\CurrentControlSet\Services\ServiceModelEndpoint 4.0.0.0\Performance  
  
-   HKLM\System\CurrentControlSet\Services\ServiceModelOperation 4.0.0.0\Performance  
  
-   HKLM\System\CurrentControlSet\Services\ServiceModelService 4.0.0.0\Performance  
  
 Если множество объектов (например, ServiceHost) удаляется, но ожидает сборки мусора, счетчик производительности `PrivateBytes` регистрирует необычно большое количество объектов. Чтобы устранить эту проблему, можно либо добавить собственные счетчики, относящиеся к приложению, либо использовать атрибут `performanceCounters`, чтобы включить только счетчики уровня службы.  
  
## <a name="types-of-performance-counters"></a>Типы счетчиков производительности  
 Счетчики производительности группируются по трем различным уровням: Служба, конечная точка и операция.  
  
 Можно использовать инструментарий WMI, чтобы получить имя экземпляра счетчика производительности. Например, примененная к объекту директива  
  
-   Имя экземпляра счетчика службы можно получить с помощью WMI [службы](../../../../../docs/framework/wcf/diagnostics/wmi/service.md) свойства «CounterInstanceName» экземпляра.  
  
-   Имя экземпляра счетчика конечной точки можно получить с помощью WMI [конечной точки](../../../../../docs/framework/wcf/diagnostics/wmi/endpoint.md) свойства «CounterInstanceName» экземпляра.  
  
-   Имя экземпляра счетчика операций можно получить с помощью WMI [конечной точки](../../../../../docs/framework/wcf/diagnostics/wmi/endpoint.md) метода «GetOperationCounterInstanceName» экземпляра.  
  
 Дополнительные сведения о WMI см. в разделе [с помощью Windows Management Instrumentation для диагностики](../../../../../docs/framework/wcf/diagnostics/wmi/index.md).  
  
### <a name="service-performance-counters"></a>Счетчики производительности службы  
 Счетчики производительности службы измеряют поведение службы в целом, их можно использовать для диагностики производительности всей службы. Их можно просмотреть с помощью системного монитора, выбрав объект производительности `ServiceModelService 4.0.0.0`. Экземпляры именуются по следующей схеме:  
  
```  
ServiceName@ServiceBaseAddress  
```  
  
 Счетчик в области действия службы агрегируется из счетчика в коллекции конечных точек.  
  
 Значение счетчиков производительности для создания экземпляра службы увеличивается при создании нового InstanceContext. Обратите внимание, что новый InstanceContext создается даже при получении неактивирующего сообщения (с существующей службой) или при подключении к экземпляру из одного сеанса, завершении сеанса и последующем повторном подключении из другого сеанса.  
  
### <a name="endpoint-performance-counters"></a>Счетчики производительности конечных точек  
 Счетчики производительности конечных точек позволяют просматривать данные о том, как именно конечная точка принимает сообщения. Их можно просмотреть с помощью системного монитора, выбрав объект производительности `ServiceModelEndpoint 4.0.0.0`. Экземпляры именуются по следующей схеме:  
  
```  
(ServiceName).(ContractName)@(endpoint listener address)  
```  
  
 Данные аналогичны данным, собираемым для отдельных операций, но агрегируются только на конечной точке.  
  
 Счетчик в области действия конечной точки агрегируется из счетчиков в коллекции операций.  
  
> [!NOTE]
>  Если две конечные точки имеют идентичные имена контрактов и адреса, они сопоставляются с одним и тем же экземпляром счетчика.  
  
### <a name="operation-performance-counters"></a>Счетчики производительности операций  
 Счетчики производительности операций можно просмотреть с помощью системного монитора, выбрав объект производительности `ServiceModelOperation 4.0.0.0`. Каждая операция содержит отдельный экземпляр. Следовательно, если указанный контракт имеет 10 операций, 10 экземпляров счетчика операций связаны с этим контрактом. Экземпляры объекта именуются по следующей схеме:  
  
```  
(ServiceName).(ContractName).(OperationName)@(first endpoint listener address)  
```  
  
 Этот счетчик позволяет измерить, как используется вызов и насколько успешно выполняется операция.  
  
 Если счетчики видимы в нескольких областях, данные, полученные из более высокой области, агрегируются с данными, полученными из более низких областей. Например, `Calls` в конечной точке представляет сумму всех вызовов операций в конечной точке. `Calls` в службе представляет сумму все вызовов всех конечных точек в службе.  
  
> [!NOTE]
>  При наличии одинаковых имен операций в контракте можно получить только экземпляры одного счетчика для обоих операций.  
  
## <a name="programming-the-wcf-performance-counters"></a>Программирование счетчиков производительности WCF  
 Несколько файлов устанавливаются в папке установки пакета SDK, таким образом, счетчики производительности WCF можно обращаться программно. Ниже приводится список этих файлов.  
  
-   _ServiceModelEndpointPerfCounters.vrg  
  
-   _ServiceModelOperationPerfCounters.vrg  
  
-   _ServiceModelServicePerfCounters.vrg  
  
-   _SMSvcHostPerfCounters.vrg  
  
-   _TransactionBridgePerfCounters.vrg  
  
 Дополнительные сведения о том, как получить доступ к счетчикам программным образом см. в разделе [программная архитектура счетчика производительности](https://go.microsoft.com/fwlink/?LinkId=95179).  
  
## <a name="see-also"></a>См. также

- [Администрирование и диагностика](../../../../../docs/framework/wcf/diagnostics/index.md)
