---
title: Переопределение идентификатора службы для проверки подлинности
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: d613a22b-07d7-41a4-bada-1adc653b9b5d
ms.openlocfilehash: 5649ef4cc05c9c16b1f8f626ba5e2e584b0e52eb
ms.sourcegitcommit: 7980a91f90ae5eca859db7e6bfa03e23e76a1a50
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/14/2020
ms.locfileid: "81278916"
---
# <a name="override-the-identity-of-a-service-for-authentication"></a>Переопределение идентификации службы аутентификации

Как правило, нет необходимости задавать удостоверение в службе, поскольку выбор типа учетных данных клиента определяет тип удостоверения, предоставляемого в метаданных службы. Например, следующий код конфигурации использует [ \<элемент wsHttpBinding>](../../configure-apps/file-schema/wcf/wshttpbinding.md) и устанавливает `clientCredentialType` атрибут windows.  

 В следующем фрагменте WSDL (Web Services Description Language) показано удостоверение для ранее определенной конечной точки. В этом примере служба работает как самохпарняющийсяusername@contoso.comсервис под определенной учетной записью пользователя () и, следовательно, имя пользователя (UPN) содержит имя учетной записи. UPN также известен как имя пользователя, вскакиваемое в домене Windows.  

 Для примера приложения, демонстрирующего [Service Identity Sample](../samples/service-identity-sample.md)настройку идентификации, см. Для получения дополнительной информации об идентификации [службы](../feature-details/service-identity-and-authentication.md)см.  
  
## <a name="kerberos-authentication-and-identity"></a>Проверка подлинности Kerberos и удостоверение  
 По умолчанию, когда служба настроена на использование учетных данных Windows, элемент [ \<идентификационных>,](../../configure-apps/file-schema/wcf/identity.md) содержащий [ \<>mainName или](../../configure-apps/file-schema/wcf/userprincipalname.md) [ \<>элемент службы,](../../configure-apps/file-schema/wcf/serviceprincipalname.md) генерируется в WSDL. Если служба работает под `LocalSystem` `LocalService`,или `NetworkService` учетной записью, основное имя службы (SPN) генерируется по умолчанию в виде `host/` \< *хост-мгосля*>, поскольку эти учетные записи имеют доступ к данным SPN компьютера. Если служба работает под другой учетной записью, Windows Communication Foundation (WCF) генерирует UPN в \<виде имен *пользователя*>@<*domainName*`>`. Это происходит потому, что проверка подлинности Kerberos требует предоставления клиенту имени участника-пользователя или имени участника-службы для проверки подлинности службы.  
  
 Вы также можете использовать инструмент [Setspn](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc731241(v=ws.10)?redirectedfrom=MSDN) для регистрации дополнительного SPN с учетной записью службы в домене. В этом случае имя участника-службы можно использовать в качестве удостоверения службы. Для получения дополнительной информации [Setspn Overview](https://docs.microsoft.com/previous-versions/windows/it-pro/windows-server-2003/cc773257(v=ws.10))об этом инструменте см.  
  
> [!NOTE]
> Чтобы использовать тип учетных данных Windows без согласования, учетная запись пользователя службы должна иметь доступ к имени участника службы (SPN), зарегистрированному с доменом Active Directory. Это можно сделать следующими способами:  
  
- Используйте учетную запись NetworkService или LocalSystem для запуска службы. Поскольку эти учетные записи имеют доступ к машине SPN, которая устанавливается при присоединении машины к домену Active Directory, WCF автоматически генерирует соответствующий элемент SPN внутри конечной точки службы в метаданных службы (WSDL).  
  
- Запустите службу из любой учетной записи домена Active Directory. В данном случае с помощью служебного средства Setspn.exe необходимо установить имя участника-службы для этой учетной записи домена. Как только вы создадите SPN для учетной записи службы, настройте WCF, чтобы опубликовать этот SPN клиентам службы через ее метаданные (WSDL). Для этого нужно настроить удостоверение конечной точки для предоставляемой конечной точки в файле конфигурации приложения или в коде.  
  
 Для получения дополнительной информации о SPNs, протоколе Kerberos и Active Directory [см.](https://docs.microsoft.com/previous-versions/msp-n-p/ff649429(v=pandp.10))  
  
### <a name="when-spn-or-upn-equals-the-empty-string"></a>Если имя участника-службы или имя участника-пользователя равно пустой строке  
 Если задать имя участника-службы или имя участника-пользователя равным пустой строке, возможны разные варианты развития событий в зависимости от используемых уровня безопасности и режима проверки подлинности.  
  
- Если используется безопасность на уровне транспорта, выбирается проверка подлинности по протоколу NT LanMan (NTLM).  
  
- Если используется безопасность на уровне сообщения, при проверке подлинности в зависимости от используемого режима проверки подлинности может произойти сбой.  
  
- Если вы `spnego` используете `AllowNtlm` режим и `false`атрибут установлен, проверка подлинности не удается.  
  
- Если вы `spnego` используете `AllowNtlm` режим и `true`атрибут установлен, проверка подлинности не удается, если UPN пуст, но успешно, если SPN пуст.  
  
- При использовании протокола Kerberos напрямую (этот процесс также известен как "одноступенчатая" проверка) происходит сбой проверки подлинности.  
  
### <a name="use-the-identity-element-in-configuration"></a>Используйте \<элемент идентификации> в конфигурации  
 Если вы измените тип учетных данных клиента в `Certificate`привязке, ранее показанной, то сгенерированный WSDL содержит серийный сертификат Base64 X.509 для значения идентификации, указанного в следующем коде. Используется по умолчанию для всех типов учетных данных клиентов, за исключением Windows.  

 Вы можете изменить значение итог службы по умолчанию или `identity` изменить тип итог, используя элемент <> в конфигурации или установив идентификацию в коде. В следующем коде конфигурации задается идентификатор DNS со значением `contoso.com`.  

### <a name="set-identity-programmatically"></a>Установить идентичность программно  
 Служба не обязана явно указывать личность, поскольку WCF автоматически определяет ее. Тем не менее, WCF позволяет указать личность на конечную точку, если это необходимо. В приведенном ниже примере кода добавляется новая конечная точка службы с определенным идентификатором DNS.  
  
 [!code-csharp[C_Identity#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_identity/cs/source.cs#5)]
 [!code-vb[C_Identity#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_identity/vb/source.vb#5)]  
  
## <a name="see-also"></a>См. также раздел

- [Практическое руководство. Создание пользовательского средства проверки идентификации клиентов](how-to-create-a-custom-client-identity-verifier.md)
- [Идентификация и проверка подлинности службы](../feature-details/service-identity-and-authentication.md)
