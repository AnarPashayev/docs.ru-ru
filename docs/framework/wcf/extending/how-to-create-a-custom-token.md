---
title: Практическое руководство. Создание пользовательского токена
description: Узнайте, как создать настраиваемый маркер безопасности в WCF с помощью класса SecurityToken и как интегрировать его с поставщиком маркеров безопасности и средством проверки подлинности.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- SecurityTokenParameters class
- security [WCF], creating custom tokens
- WSSecurityTokenSerializer class
- SecurityToken class
ms.assetid: 6d892973-1558-4115-a9e1-696777776125
ms.openlocfilehash: e0d80fe2433d894ef1f9e110e9090701dc305d8e
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "96266757"
---
# <a name="how-to-create-a-custom-token"></a><span data-ttu-id="e6ad4-103">Практическое руководство. Создание пользовательского токена</span><span class="sxs-lookup"><span data-stu-id="e6ad4-103">How to: Create a Custom Token</span></span>

<span data-ttu-id="e6ad4-104">В этом разделе показано, как создать пользовательский маркер безопасности с помощью класса <xref:System.IdentityModel.Tokens.SecurityToken> и интегрировать его с поставщиком пользовательских маркеров безопасности и структурой проверки подлинности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-104">This topic shows how to create a custom security token using the <xref:System.IdentityModel.Tokens.SecurityToken> class, and how to integrate it with a custom security token provider and authenticator.</span></span> <span data-ttu-id="e6ad4-105">Полный пример кода см. в примере [пользовательского маркера](../samples/custom-token.md) .</span><span class="sxs-lookup"><span data-stu-id="e6ad4-105">For a complete code example see the [Custom Token](../samples/custom-token.md) sample.</span></span>  
  
 <span data-ttu-id="e6ad4-106">*Маркер безопасности* — это, по сути, элемент XML, который используется платформой безопасности Windows Communication Foundation (WCF) для представления утверждений об отправителе в сообщении SOAP.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-106">A *security token* is essentially an XML element that is used by the Windows Communication Foundation (WCF) security framework to represent claims about a sender inside the SOAP message.</span></span> <span data-ttu-id="e6ad4-107">Безопасность WCF предоставляет различные маркеры для режимов проверки подлинности, предоставляемых системой.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-107">WCF security provides various tokens for system-provided authentication modes.</span></span> <span data-ttu-id="e6ad4-108">Примером является маркер безопасности X.509, представленный классом <xref:System.IdentityModel.Tokens.X509SecurityToken>, или маркер безопасности Username, представленный классом <xref:System.IdentityModel.Tokens.UserNameSecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-108">Examples include an X.509 certificate security token represented by the <xref:System.IdentityModel.Tokens.X509SecurityToken> class or a Username security token represented by the <xref:System.IdentityModel.Tokens.UserNameSecurityToken> class.</span></span>  
  
 <span data-ttu-id="e6ad4-109">Иногда режим проверки подлинности или учетные данные не поддерживаются указанными типами.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-109">Sometimes an authentication mode or credential is not supported by the provided types.</span></span> <span data-ttu-id="e6ad4-110">В этом случае необходимо создать пользовательский маркер безопасности, чтобы предоставить XML-представление пользовательских учетных данных в сообщение SOAP.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-110">In that case, it is necessary to create a custom security token to provide an XML representation of the custom credential inside the SOAP message.</span></span>  
  
 <span data-ttu-id="e6ad4-111">В следующих процедурах показано, как создать пользовательский маркер безопасности и как интегрировать его с инфраструктурой безопасности WCF.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-111">The following procedures show how to create a custom security token and how to integrate it with the WCF security infrastructure.</span></span> <span data-ttu-id="e6ad4-112">В этом разделе создается маркер кредитной карты, который используется для передачи информации о кредитной карте на сервер.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-112">This topic creates a credit card token that is used to pass information about the client's credit card to the server.</span></span>  
  
 <span data-ttu-id="e6ad4-113">Дополнительные сведения о пользовательских учетных данных и диспетчере маркеров безопасности см. в разделе [Пошаговое руководство. Создание настраиваемых учетных данных клиента и службы](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-113">For more information about custom credentials and security token manager, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
 <span data-ttu-id="e6ad4-114">Сведения о дополнительных классах, представляющих маркеры безопасности, см. в описании пространства имен <xref:System.IdentityModel.Tokens>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-114">See the <xref:System.IdentityModel.Tokens> namespace for more classes that represent security tokens.</span></span>  
  
## <a name="procedures"></a><span data-ttu-id="e6ad4-115">Процедуры</span><span class="sxs-lookup"><span data-stu-id="e6ad4-115">Procedures</span></span>  

 <span data-ttu-id="e6ad4-116">Клиентскому приложению необходимо предоставить возможность указания данных кредитной карты для инфраструктуры безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-116">A client application must be provided with a way to specify credit card information for the security infrastructure.</span></span> <span data-ttu-id="e6ad4-117">Эти данные делаются доступными приложению с помощью класса учетных данных клиента.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-117">This information is made available to the application by a custom client credentials class.</span></span> <span data-ttu-id="e6ad4-118">Первым шагом является создание класса для представления данных кредитной карты для пользовательских учетных данных клиента.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-118">The first step is to create a class to represent the credit card information for custom client credentials.</span></span>  
  
#### <a name="to-create-a-class-that-represents-credit-card-information-inside-client-credentials"></a><span data-ttu-id="e6ad4-119">Создание класса, представляющего данные кредитной карты в учетных данных клиента</span><span class="sxs-lookup"><span data-stu-id="e6ad4-119">To create a class that represents credit card information inside client credentials</span></span>  
  
1. <span data-ttu-id="e6ad4-120">Определите новый класс, представляющий данные кредитной карты для приложения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-120">Define a new class that represents the credit card information for the application.</span></span> <span data-ttu-id="e6ad4-121">В следующем примере создается класс с именем `CreditCardInfo`.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-121">The following example names the class `CreditCardInfo`.</span></span>  
  
2. <span data-ttu-id="e6ad4-122">Добавьте в класс соответствующие свойства, чтобы разрешить приложению указывать данные, необходимые для пользовательского маркера.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-122">Add appropriate properties to the class to allow an application set the necessary information required for the custom token.</span></span> <span data-ttu-id="e6ad4-123">В этом примере класс имеет три свойства: `CardNumber`, `CardIssuer` и `ExpirationDate`.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-123">In this example, the class has three properties: `CardNumber`, `CardIssuer`, and `ExpirationDate`.</span></span>  
  
     [!code-csharp[c_CustomToken#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#4)]
     [!code-vb[c_CustomToken#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#4)]  
  
 <span data-ttu-id="e6ad4-124">Затем необходимо создать класс, представляющий пользовательский маркер безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-124">Next, a class that represents the custom security token must be created.</span></span> <span data-ttu-id="e6ad4-125">Этот класс используется поставщиками маркеров безопасности, средством проверки подлинности и классами сериализатора для передачи сведений о маркере безопасности в инфраструктуру безопасности WCF и из нее.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-125">This class is used by the security token provider, authenticator, and serializer classes to pass information about the security token to and from the WCF security infrastructure.</span></span>  
  
#### <a name="to-create-a-custom-security-token-class"></a><span data-ttu-id="e6ad4-126">Создание класса пользовательского маркера безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-126">To create a custom security token class</span></span>  
  
1. <span data-ttu-id="e6ad4-127">Определите новый класс, производный от класса <xref:System.IdentityModel.Tokens.SecurityToken>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-127">Define a new class derived from the <xref:System.IdentityModel.Tokens.SecurityToken> class.</span></span> <span data-ttu-id="e6ad4-128">В этом примере создается класс с именем `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-128">This example creates a class named `CreditCardToken`.</span></span>  
  
2. <span data-ttu-id="e6ad4-129">Переопределите свойство <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-129">Override the <xref:System.IdentityModel.Tokens.SecurityToken.Id%2A> property.</span></span> <span data-ttu-id="e6ad4-130">Это свойство используется для получения локального идентификатора маркера безопасности, используемого для указания XML-представления маркера безопасности из других элементов в сообщении SOAP.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-130">This property is used to get the local identifier of the security token that is used to point to the security token XML representation from other elements inside the SOAP message.</span></span> <span data-ttu-id="e6ad4-131">В этом примере идентификатор маркера может быть передан в качестве параметра конструктора или новый случайный идентификатор может создаваться при каждом создании экземпляра маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-131">In this example, a token identifier can be either passed to it as a constructor parameter or a new random one is generated every time a security token instance is created.</span></span>  
  
3. <span data-ttu-id="e6ad4-132">Реализуйте свойство <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-132">Implement the <xref:System.IdentityModel.Tokens.SecurityToken.SecurityKeys%2A> property.</span></span> <span data-ttu-id="e6ad4-133">Это свойство возвращает коллекцию ключей безопасности, представляемую экземпляром маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-133">This property returns a collection of security keys that the security token instance represents.</span></span> <span data-ttu-id="e6ad4-134">Такие ключи могут использоваться WCF для подписывания или шифрования частей сообщения SOAP.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-134">Such keys can be used by WCF to sign or encrypt parts of the SOAP message.</span></span> <span data-ttu-id="e6ad4-135">В этом примере маркер безопасности кредитной карты не может содержать какие-либо ключи безопасности, поэтому реализация всегда возвращает пустую коллекцию.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-135">In this example, the credit card security token cannot contain any security keys; therefore, the implementation always returns an empty collection.</span></span>  
  
4. <span data-ttu-id="e6ad4-136">Переопределите свойства <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> и <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-136">Override the <xref:System.IdentityModel.Tokens.SecurityToken.ValidFrom%2A> and <xref:System.IdentityModel.Tokens.SecurityToken.ValidTo%2A> properties.</span></span> <span data-ttu-id="e6ad4-137">Эти свойства используются WCF для определения допустимости экземпляра маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-137">These properties are used by WCF to determine the validity of the security token instance.</span></span> <span data-ttu-id="e6ad4-138">В этом примере для маркера безопасности кредитной карты задана только дата истечения срока действия, поэтому свойство `ValidFrom` возвращает объект <xref:System.DateTime>, представляющий дату и время создания экземпляра.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-138">In this example, the credit card security token has only an expiration date, so the `ValidFrom` property returns a <xref:System.DateTime> that represents the date and time of the instance creation.</span></span>  
  
     [!code-csharp[c_CustomToken#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#1)]
     [!code-vb[c_CustomToken#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#1)]  
  
 <span data-ttu-id="e6ad4-139">После создания нового типа маркера безопасности необходимо реализовать класс <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-139">When a new security token type is created, it requires an implementation of the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span> <span data-ttu-id="e6ad4-140">Реализация используется в конфигурации элемента привязки безопасности для представления нового типа маркера.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-140">The implementation is used in the security binding element configuration to represent the new token type.</span></span> <span data-ttu-id="e6ad4-141">Класс параметров маркера безопасности служит в качестве шаблона, который используется для сопоставления фактического маркера безопасности при обработке сообщения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-141">The security token parameters class serves as a template that is used to match the actual security token instance to when a message is processed.</span></span> <span data-ttu-id="e6ad4-142">Шаблон предоставляет дополнительные свойства, которые могут использоваться приложением для задания критериев, которым должен соответствовать маркер безопасности, чтобы его можно было использовать и проверять на подлинность.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-142">The template provides additional properties that an application can use to specify criteria that the security token must match to be used or authenticated.</span></span> <span data-ttu-id="e6ad4-143">В следующем примере не добавляются дополнительные свойства, поэтому при поиске в инфраструктуре WCF экземпляра токена безопасности, используемого или для проверки, сопоставляется только тип маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-143">The following example does not add any additional properties, so only the security token type is matched when the WCF infrastructure searches for a security token instance to use or to validate.</span></span>  
  
#### <a name="to-create-a-custom-security-token-parameters-class"></a><span data-ttu-id="e6ad4-144">Создание класса параметров пользовательского маркера безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-144">To create a custom security token parameters class</span></span>  
  
1. <span data-ttu-id="e6ad4-145">Определите новый класс, производный от класса <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-145">Define a new class derived from the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters> class.</span></span>  
  
2. <span data-ttu-id="e6ad4-146">Выполните метод <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-146">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CloneCore%2A> method.</span></span> <span data-ttu-id="e6ad4-147">Скопируйте все внутренние поля, определенные в классе (при их наличии).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-147">Copy all internal fields defined in your class, if any.</span></span> <span data-ttu-id="e6ad4-148">В этом примере дополнительные поля не определены.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-148">This example does not define any additional fields.</span></span>  
  
3. <span data-ttu-id="e6ad4-149">Реализуйте свойство <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A>, доступное только для чтения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-149">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientAuthentication%2A> read-only property.</span></span> <span data-ttu-id="e6ad4-150">Это свойство возвращает значение `true`, если тип маркера безопасности, представленный данным классом, можно использовать для проверки подлинности клиента при подключении к службе.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-150">This property returns `true` if the security token type represented by this class can be used to authenticate a client to a service.</span></span> <span data-ttu-id="e6ad4-151">В этом примере маркер безопасности кредитной карты можно использовать для проверки подлинности клиента при подключении к службе.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-151">In this example, the credit card security token can be used to authenticate a client to a service.</span></span>  
  
4. <span data-ttu-id="e6ad4-152">Реализуйте свойство <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A>, доступное только для чтения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-152">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsServerAuthentication%2A> read-only property.</span></span> <span data-ttu-id="e6ad4-153">Это свойство возвращает значение `true`, если тип маркера безопасности, представленный данным классом, можно использовать для проверки подлинности службы при подключении клиента.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-153">This property returns `true` if the security token type represented by this class can be used to authenticate a service to a client.</span></span> <span data-ttu-id="e6ad4-154">В этом примере маркер безопасности кредитной карты нельзя использовать для проверки подлинности службы при подключении клиента.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-154">In this example, the credit card security token cannot be used to authenticate a service to a client.</span></span>  
  
5. <span data-ttu-id="e6ad4-155">Реализуйте свойство <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A>, доступное только для чтения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-155">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.SupportsClientWindowsIdentity%2A> read-only property.</span></span> <span data-ttu-id="e6ad4-156">Это свойство возвращает значение `true`, если тип маркера безопасности, представленный данным классом, можно сопоставить с учетной записью Windows.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-156">This property returns `true` if the security token type represented by this class can be mapped to a Windows account.</span></span> <span data-ttu-id="e6ad4-157">В этом случае результат проверки подлинности будет представлен экземпляром класса <xref:System.Security.Principal.WindowsIdentity>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-157">If so, the authentication result is represented by a <xref:System.Security.Principal.WindowsIdentity> class instance.</span></span> <span data-ttu-id="e6ad4-158">В этом примере маркер нельзя сопоставить с учетной записью Windows.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-158">In this example, the token cannot be mapped to a Windows account.</span></span>  
  
6. <span data-ttu-id="e6ad4-159">Выполните метод <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-159">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.CreateKeyIdentifierClause%28System.IdentityModel.Tokens.SecurityToken%2CSystem.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle%29> method.</span></span> <span data-ttu-id="e6ad4-160">Этот метод вызывается платформой безопасности WCF, когда требуется ссылка на экземпляр маркера безопасности, представленный этим классом параметров токена безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-160">This method is called by WCF security framework when it requires a reference to the security token instance represented by this security token parameters class.</span></span> <span data-ttu-id="e6ad4-161">Фактический экземпляр маркера безопасности и объект <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle>, определяющий тип запрашиваемой ссылки, передаются данному методу в качестве аргументов.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-161">Both the actual security token instance and <xref:System.ServiceModel.Security.Tokens.SecurityTokenReferenceStyle> that specifies the type of the reference that is being requested are passed to this method as arguments.</span></span> <span data-ttu-id="e6ad4-162">В этом примере маркером безопасности кредитной карты поддерживаются только внутренние ссылки.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-162">In this example, only internal references are supported by the credit card security token.</span></span> <span data-ttu-id="e6ad4-163">Класс <xref:System.IdentityModel.Tokens.SecurityToken> предоставляет возможность создания внутренних ссылок, поэтому для реализации не требуется дополнительный код.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-163">The <xref:System.IdentityModel.Tokens.SecurityToken> class has functionality to create internal references; therefore, the implementation does not require additional code.</span></span>  
  
7. <span data-ttu-id="e6ad4-164">Выполните метод <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-164">Implement the <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters.InitializeSecurityTokenRequirement%28System.IdentityModel.Selectors.SecurityTokenRequirement%29> method.</span></span> <span data-ttu-id="e6ad4-165">Этот метод вызывается WCF для преобразования экземпляра класса параметров токена безопасности в экземпляр <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> класса.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-165">This method is called by WCF to convert the security token parameters class instance into an instance of the <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> class.</span></span> <span data-ttu-id="e6ad4-166">Результат используется поставщиками маркеров безопасности для создания соответствующего экземпляра маркера безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-166">The result is used by security token providers to create the appropriate security token instance.</span></span>  
  
     [!code-csharp[c_CustomToken#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#2)]
     [!code-vb[c_CustomToken#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#2)]  
  
 <span data-ttu-id="e6ad4-167">Токены безопасности передаются в сообщениях SOAP. Для этого требуется механизм трансляции между представлением токена безопасности, хранимого в памяти, и представлением для передачи по каналу связи.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-167">Security tokens are transmitted inside SOAP messages, which requires a translation mechanism between the in-memory security token representation and the on-the-wire representation.</span></span> <span data-ttu-id="e6ad4-168">Для выполнения этой задачи WCF использует сериализатор маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-168">WCF uses a security token serializer to accomplish this task.</span></span> <span data-ttu-id="e6ad4-169">К каждому пользовательскому маркеру должен прилагаться сериализатор, который обеспечивает сериализацию и десериализацию пользовательского маркера безопасности из сообщения SOAP.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-169">Every custom token must be accompanied by a custom security token serializer that can serialize and deserialize the custom security token from the SOAP message.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="e6ad4-170">Производные ключи включены по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-170">Derived keys are enabled by default.</span></span> <span data-ttu-id="e6ad4-171">Если создать настраиваемый маркер безопасности и использовать его в качестве основного маркера, то WCF наследует ключ из него.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-171">If you create a custom security token and use it as the primary token, WCF derives a key from it.</span></span> <span data-ttu-id="e6ad4-172">При этом она вызывает сериализатор пользовательских маркеров безопасности, чтобы записать <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> для пользовательского маркера безопасности при сериализации `DerivedKeyToken` для передачи по каналу связи.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-172">While doing so, it calls the custom security token serializer to write the <xref:System.IdentityModel.Tokens.SecurityKeyIdentifierClause> for the custom security token while serializing the `DerivedKeyToken` to the wire.</span></span> <span data-ttu-id="e6ad4-173">При десериализации маркера в точке назначения сериализатор `DerivedKeyToken` ожидает `SecurityTokenReference` как дочерний элемент верхнего уровня, расположенный под сериализатором.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-173">On the receiving end, when deserializing the token off the wire, the `DerivedKeyToken` serializer expects a `SecurityTokenReference` element as the top-level child under itself.</span></span> <span data-ttu-id="e6ad4-174">Если сериализатор пользовательских маркеров безопасности не добавил элемент `SecurityTokenReference` при сериализации своего типа предложения, возникает исключение.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-174">If the custom security token serializer did not add a `SecurityTokenReference` element while serializing its clause type, an exception is thrown.</span></span>  
  
#### <a name="to-create-a-custom-security-token-serializer"></a><span data-ttu-id="e6ad4-175">Создание сериализатора пользовательских маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-175">To create a custom security token serializer</span></span>  
  
1. <span data-ttu-id="e6ad4-176">Определите новый класс, производный от класса <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-176">Define a new class derived from the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer> class.</span></span>  
  
2. <span data-ttu-id="e6ad4-177">Переопределите метод <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29>, основанный на объекте <xref:System.Xml.XmlReader> для чтения потока XML.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-177">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanReadTokenCore%28System.Xml.XmlReader%29> method, which relies on an <xref:System.Xml.XmlReader> to read the XML stream.</span></span> <span data-ttu-id="e6ad4-178">Этот метод возвращает значение `true`, если реализация сериализатора может десериализовать маркер безопасности при наличии его текущего элемента.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-178">The method returns `true` if the serializer implementation can deserialize the security token based given its current element.</span></span> <span data-ttu-id="e6ad4-179">В этом примере данный метод проверяет, задано ли для XML-элемента средства чтения XML правильное имя и пространство имен.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-179">In this example, this method checks whether the XML reader's current XML element has the correct element name and namespace.</span></span> <span data-ttu-id="e6ad4-180">В случае отрицательного результата для обработки XML-элемента вызывается базовая реализация данного метода.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-180">If it does not, it calls the base class implementation of this method to handle the XML element.</span></span>  
  
3. <span data-ttu-id="e6ad4-181">Переопределите метод <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-181">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.ReadTokenCore%28System.Xml.XmlReader%2CSystem.IdentityModel.Selectors.SecurityTokenResolver%29> method.</span></span> <span data-ttu-id="e6ad4-182">Этот метод считывает содержимое XML маркера безопасности и создает для него представление, хранимое в памяти.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-182">This method reads the XML content of the security token and constructs the appropriate in-memory representation for it.</span></span> <span data-ttu-id="e6ad4-183">Если метод не распознает XML-элемент, на котором основано переданное средство чтения XML, он вызывает реализацию базового класса для обработки предоставленных системой типов маркеров.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-183">If it does not recognize the XML element on which the passed-in XML reader is standing, it calls the base class implementation to process the system-provided token types.</span></span>  
  
4. <span data-ttu-id="e6ad4-184">Переопределите метод <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-184">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.CanWriteTokenCore%28System.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="e6ad4-185">Этот метод возвращает значение `true`, если он может преобразовать хранимое в памяти представление маркера (переданное в качестве аргумента) в XML-представление.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-185">This method returns `true` if it can convert the in-memory token representation (passed in as an argument) to the XML representation.</span></span> <span data-ttu-id="e6ad4-186">Если преобразование невозможно, он вызывает реализацию базового класса.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-186">If it cannot convert, it calls the base class implementation.</span></span>  
  
5. <span data-ttu-id="e6ad4-187">Переопределите метод <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-187">Override the <xref:System.ServiceModel.Security.WSSecurityTokenSerializer.WriteTokenCore%28System.Xml.XmlWriter%2CSystem.IdentityModel.Tokens.SecurityToken%29> method.</span></span> <span data-ttu-id="e6ad4-188">Этот метод преобразует хранимое в памяти представление маркера безопасности в XML-представление.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-188">This method converts an in-memory security token representation into an XML representation.</span></span> <span data-ttu-id="e6ad4-189">Если преобразование невозможно, он вызывает реализацию базового класса.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-189">If the method cannot convert, it calls the base class implementation.</span></span>  
  
     [!code-csharp[c_CustomToken#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#3)]
     [!code-vb[c_CustomToken#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#3)]  
  
 <span data-ttu-id="e6ad4-190">После выполнения четырех вышеуказанных процедур следует интегрировать пользовательский маркер безопасности с поставщиком маркеров безопасности, структурой проверки подлинности маркеров безопасности, диспетчером маркеров безопасности, а также с учетными данными клиента и службы.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-190">After completing the four previous procedures, integrate the custom security token with the security token provider, authenticator, manager, and client and service credentials.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-provider"></a><span data-ttu-id="e6ad4-191">Интеграция пользовательского маркера безопасности с поставщиком маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-191">To integrate the custom security token with a security token provider</span></span>  
  
1. <span data-ttu-id="e6ad4-192">Поставщик маркеров безопасности создает, изменяет (при необходимости) и возвращает экземпляр маркера.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-192">The security token provider creates, modifies (if necessary), and returns an instance of the token.</span></span> <span data-ttu-id="e6ad4-193">Чтобы создать пользовательский поставщик для пользовательского маркера безопасности, создайте класс, наследуемый от класса <xref:System.IdentityModel.Selectors.SecurityTokenProvider>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-193">To create a custom provider for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenProvider> class.</span></span> <span data-ttu-id="e6ad4-194">В следующем примере переопределяется метод <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> для возврата экземпляра `CreditCardToken`.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-194">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenProvider.GetTokenCore%2A> method to return an instance of the `CreditCardToken`.</span></span> <span data-ttu-id="e6ad4-195">Дополнительные сведения о настраиваемых поставщиках маркеров безопасности см. [в разделе как создать настраиваемый поставщик маркеров безопасности](how-to-create-a-custom-security-token-provider.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-195">For more information about custom security token providers, see [How to: Create a Custom Security Token Provider](how-to-create-a-custom-security-token-provider.md).</span></span>  
  
     [!code-csharp[c_CustomToken#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#6)]
     [!code-vb[c_CustomToken#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#6)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-authenticator"></a><span data-ttu-id="e6ad4-196">Интеграция пользовательского маркера безопасности со структурой проверки подлинности маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-196">To integrate the custom security token with a security token authenticator</span></span>  
  
1. <span data-ttu-id="e6ad4-197">Структура проверки подлинности маркеров безопасности проверяет содержимое маркера безопасности при его извлечении из сообщения.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-197">The security token authenticator validates the content of the security token when it is extracted from the message.</span></span> <span data-ttu-id="e6ad4-198">Чтобы создать пользовательскую структуру проверки подлинности для пользовательского маркера безопасности, создайте класс, наследуемый от класса <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-198">To create a custom authenticator for the custom security token, create a class that inherits from the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator> class.</span></span> <span data-ttu-id="e6ad4-199">В следующем примере демонстрируется метод переопределения <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-199">The following example overrides the <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator.ValidateTokenCore%2A> method.</span></span> <span data-ttu-id="e6ad4-200">Дополнительные сведения о настраиваемых средствах проверки подлинности маркеров безопасности см. [в разделе как создать настраиваемую проверку подлинности маркеров безопасности](how-to-create-a-custom-security-token-authenticator.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-200">For more information about custom security token authenticators, see [How to: Create a Custom Security Token Authenticator](how-to-create-a-custom-security-token-authenticator.md).</span></span>  
  
     [!code-csharp[c_CustomToken#7](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#7)]
     [!code-vb[c_CustomToken#7](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#7)]  
  
     [!code-csharp[c_CustomToken#12](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#12)]
     [!code-vb[c_CustomToken#12](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#12)]  
  
#### <a name="to-integrate-the-custom-security-token-with-a-security-token-manager"></a><span data-ttu-id="e6ad4-201">Интеграция пользовательского маркера безопасности с диспетчером маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-201">To integrate the custom security token with a security token manager</span></span>  
  
1. <span data-ttu-id="e6ad4-202">Диспетчер маркеров безопасности создает соответствующие экземпляры поставщика, структуры проверки подлинности и сериализатора маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-202">The security token manager creates the appropriate token provider, security authenticator, and token serializer instances.</span></span> <span data-ttu-id="e6ad4-203">Чтобы создать диспетчер пользовательских маркеров, создайте класс, наследуемый от класса <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-203">To create a custom token manager, create a class that inherits from the <xref:System.ServiceModel.ClientCredentialsSecurityTokenManager> class.</span></span> <span data-ttu-id="e6ad4-204">Основные методы класса используют <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> для создания соответствующего поставщика и клиента или учетных данных службы.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-204">The primary methods of the class use a <xref:System.IdentityModel.Selectors.SecurityTokenRequirement> to create the appropriate provider and client or service credentials.</span></span> <span data-ttu-id="e6ad4-205">Дополнительные сведения о настраиваемых диспетчерах маркеров безопасности см. в разделе [Пошаговое руководство. Создание настраиваемых учетных данных клиента и службы](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-205">For more information about custom security token managers, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#8](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#8)]
     [!code-vb[c_CustomToken#8](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#8)]  
  
     [!code-csharp[c_CustomToken#9](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#9)]
     [!code-vb[c_CustomToken#9](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#9)]  
  
#### <a name="to-integrate-the-custom-security-token-with-custom-client-and-service-credentials"></a><span data-ttu-id="e6ad4-206">Интеграция пользовательского маркера безопасности с пользовательскими учетными данными клиента и службы</span><span class="sxs-lookup"><span data-stu-id="e6ad4-206">To integrate the custom security token with custom client and service credentials</span></span>  
  
1. <span data-ttu-id="e6ad4-207">Учетные данные клиента и службы необходимо добавить для предоставления интерфейса API приложению, чтобы обеспечить возможность указания данных пользовательского маркера, которые используются инфраструктурой пользовательских маркеров безопасности, предварительно созданной для предоставления и проверки подлинности содержимого пользовательских маркеров безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-207">The custom client and service credentials must be added to provide an API for the application to allow specifying custom token information that is used by the custom security token infrastructure created previously to provide and authenticate the custom security token content.</span></span> <span data-ttu-id="e6ad4-208">В следующих образцах показано, как это можно сделать.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-208">The following samples show how this can be done.</span></span> <span data-ttu-id="e6ad4-209">Дополнительные сведения о настраиваемых учетных данных клиента и службы см. в разделе [Пошаговое руководство. Создание настраиваемых учетных данных клиента и службы](walkthrough-creating-custom-client-and-service-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-209">For more information about custom client and service credentials, see [Walkthrough: Creating Custom Client and Service Credentials](walkthrough-creating-custom-client-and-service-credentials.md).</span></span>  
  
     [!code-csharp[c_CustomToken#10](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#10)]
     [!code-vb[c_CustomToken#10](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#10)]  
  
     [!code-csharp[c_customToken#11](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#11)]
     [!code-vb[c_customToken#11](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#11)]  
  
 <span data-ttu-id="e6ad4-210">Класс параметров настраиваемого маркера безопасности, созданный ранее, используется для информирования платформы безопасности WCF о том, что при взаимодействии со службой должен использоваться настраиваемый маркер безопасности.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-210">The custom security token parameters class created previously is used to tell the WCF security framework that a custom security token must be used when communicating with a service.</span></span> <span data-ttu-id="e6ad4-211">В следующей процедуре показано, как это можно сделать.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-211">The following procedure shows how this can be done.</span></span>  
  
#### <a name="to-integrate-the-custom-security-token-with-the-binding"></a><span data-ttu-id="e6ad4-212">Интеграция пользовательского маркера безопасности с привязкой</span><span class="sxs-lookup"><span data-stu-id="e6ad4-212">To integrate the custom security token with the binding</span></span>  
  
1. <span data-ttu-id="e6ad4-213">Класс параметров пользовательского маркера безопасности необходимо задать в одной из коллекций параметров маркера, предоставляемых классом <xref:System.ServiceModel.Channels.SecurityBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-213">The custom security token parameters class must be specified in one of the token parameters collections that are exposed on the <xref:System.ServiceModel.Channels.SecurityBindingElement> class.</span></span> <span data-ttu-id="e6ad4-214">В следующем примере используется коллекция, возвращаемая методом `SignedEncrypted`.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-214">The following example uses the collection returned by `SignedEncrypted`.</span></span> <span data-ttu-id="e6ad4-215">Код добавляет пользовательский маркер кредитной карты в каждое сообщение, передаваемое клиентом службе; при этом содержимое автоматически подписывается и шифруется.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-215">The code adds the credit card custom token to every message sent from the client to the service with its content automatically signed and encrypted.</span></span>  
  
     [!code-csharp[c_CustomToken#13](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_customtoken/cs/source.cs#13)]
     [!code-vb[c_CustomToken#13](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_customtoken/vb/source.vb#13)]  
  
 <span data-ttu-id="e6ad4-216">В этом разделе показаны различные фрагменты кода, необходимые для реализации и использования пользовательского токена.</span><span class="sxs-lookup"><span data-stu-id="e6ad4-216">This topic shows the various pieces of code necessary to implement and use a custom token.</span></span> <span data-ttu-id="e6ad4-217">Чтобы просмотреть полный пример того, как все эти фрагменты кода соответствуют друг другу, см. [Пользовательский токен](../samples/custom-token.md).</span><span class="sxs-lookup"><span data-stu-id="e6ad4-217">To see a complete example of how all these pieces of code fit together see, [Custom Token](../samples/custom-token.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="e6ad4-218">См. также</span><span class="sxs-lookup"><span data-stu-id="e6ad4-218">See also</span></span>

- <xref:System.IdentityModel.Tokens.SecurityToken>
- <xref:System.ServiceModel.Security.Tokens.SecurityTokenParameters>
- <xref:System.ServiceModel.Security.WSSecurityTokenSerializer>
- <xref:System.IdentityModel.Selectors.SecurityTokenProvider>
- <xref:System.IdentityModel.Selectors.SecurityTokenAuthenticator>
- <xref:System.IdentityModel.Policy.IAuthorizationPolicy>
- <xref:System.IdentityModel.Selectors.SecurityTokenRequirement>
- <xref:System.IdentityModel.Selectors.SecurityTokenManager>
- <xref:System.ServiceModel.Description.ClientCredentials>
- <xref:System.ServiceModel.Description.ServiceCredentials>
- <xref:System.ServiceModel.Channels.SecurityBindingElement>
- [<span data-ttu-id="e6ad4-219">Пошаговое руководство. Создание пользовательских учетных данных для клиента и службы</span><span class="sxs-lookup"><span data-stu-id="e6ad4-219">Walkthrough: Creating Custom Client and Service Credentials</span></span>](walkthrough-creating-custom-client-and-service-credentials.md)
- [<span data-ttu-id="e6ad4-220">Практическое руководство. Создание пользовательской структуры проверки подлинности маркера безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-220">How to: Create a Custom Security Token Authenticator</span></span>](how-to-create-a-custom-security-token-authenticator.md)
- [<span data-ttu-id="e6ad4-221">Практическое руководство. Создание поставщика пользовательских маркеров безопасности</span><span class="sxs-lookup"><span data-stu-id="e6ad4-221">How to: Create a Custom Security Token Provider</span></span>](how-to-create-a-custom-security-token-provider.md)
