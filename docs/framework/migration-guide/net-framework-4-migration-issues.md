---
title: Проблемы при переходе на .NET Framework 4
ms.date: 05/02/2017
helpviewer_keywords:
- .NET Framework 4, migration
- application compatibility
ms.assetid: df478548-8c05-4de2-8ba7-adcdbe1c2a60
ms.openlocfilehash: d3966ff15e06baf293ea02dad031bd5849b4a20f
ms.sourcegitcommit: 559fcfbe4871636494870a8b716bf7325df34ac5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/30/2019
ms.locfileid: "73126046"
---
# <a name="net-framework-4-migration-issues"></a>Проблемы при переходе на .NET Framework 4

В этом разделе описываются проблемы при переходе между .NET Framework 3.5 с пакетом обновления 1 (SP1) и .NET Framework 4, в том числе исправления, изменения для соответствия стандартам и обеспечения безопасности, а также изменения, внесенные на основе отзывов пользователей. Большинство изменений не требуют каких-либо программных изменений в ваших приложениях. Случаи, требующие изменений, описаны в столбце "Рекомендованные изменения" таблицы.

Этот раздел описывает изменения в следующих областях.

- [ASP.NET и Интернет](#aspnet-and-web)

- [Ядро](#core)

- [Данные](#data)

- [Windows Communication Foundation (WCF)](#windows-communication-foundation-wcf)

- [Windows Presentation Foundation (WPF)](#windows-presentation-foundation-wpf)

- [XML](#xml)

Более общий обзор рассмотренных в этом разделе проблем см. в разделе [Руководство по миграции на .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ff657133%28v=vs.100%29).

Сведения о новых возможностях см. в разделе [Новые возможности .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms171868%28v=vs.100%29).

## <a name="aspnet-and-web"></a>ASP.NET и Интернет

Пространства имен: <xref:System.Web>, <xref:System.Web.Mobile>, <xref:System.Web.Security>, <xref:System.Web.UI.WebControls>; сборки: System.Web (в System.Web.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Файлы описания браузеров** | Файлы описания браузеров обновлены: теперь они включают сведения о новых и обновленных браузерах и устройствах. Устаревшие браузеры и устройства (например, Netscape Navigator) удалены; добавлены новые браузеры и устройства (например, Google Chrome и Apple iPhone).<br><br>Если ваше приложение содержит пользовательские описания браузеров, унаследованные от одного из удаленных описаний браузеров, произойдет ошибка.<br><br>Объект <xref:System.Web.HttpBrowserCapabilities> (предоставляемый свойством `Request.Browse` страницы) управляется файлами описания браузеров. Поэтому информация, возвращаемая при обращении к свойству этого объекта в ASP.NET 4, может отличаться от информации, возвращаемой в более ранней версии ASP.NET. | Если в вашем приложении используются старые файлы описания браузеров, их можно скопировать из следующей папки:<br><br>*Windows\\Microsoft.NET\\Framework\\v2.0.50727\\CONFIG\\Browsers*<br><br>Скопируйте файлы в соответствующую папку *\\CONFIG\\Browsers* для ASP.NET 4. После копирования файлов запустите программу командной строки [Aspnet_regbrowsers.exe](https://docs.microsoft.com/previous-versions/dotnet/netframework-3.5/ms229858(v=vs.90)). Дополнительные сведения см. на веб-сайте [https://www.asp.net/mobile](/aspnet/mobile/overview). |
| **Дочерние приложения, работающие под управлением нескольких версий ASP.NET** | Приложения ASP.NET 4, которые настроены как дочерние для приложений, использующих предыдущие версии ASP.NET, могут не запускаться из-за ошибок конфигурации или компиляции. Конкретная ошибка зависит от того, где выполняется приложение — в IIS 6.0 или в IIS 7 либо IIS 7.5. | Чтобы система конфигурации правильно распознавала приложение ASP.NET 4, можно внести изменения в файлы конфигурации затронутых приложений. Сведения об изменениях, которые необходимо внести, см. в разделе ASP.NET 4 Child Applications Fail to Start When Under ASP.NET 2.0 or ASP.NET 3.5 Applications ("Дочерние приложения ASP.NET 4 не запускаются, если родительскими приложениями являются приложения ASP.NET 2.0 или ASP.NET 3.5") статьи [ASP.NET 4 Breaking Changes](/aspnet/whitepapers/aspnet4/breaking-changes) ("Критические изменения в ASP.NET 4"). |
| **Изменения ClientID** | Новый параметр `clientIDMode` в ASP.NET 4 позволяет задать способ создания платформой ASP.NET атрибута `id` для HTML-элементов. В более ранних версиях ASP.NET поведение по умолчанию соответствовало значению `AutoID` параметра `clientIDMode`. Теперь значение по умолчанию — `Predictable`. Дополнительные сведения см. в разделе [Идентификация элементов управления Web Forms](https://docs.microsoft.com/previous-versions/aspnet/1d04y8ss%28v=vs.100%29). | Если для обновления приложения с версии ASP.NET 2.0 или ASP.NET 3.5 используется Visual Studio, средство автоматически добавит в файл Web.config параметр, сохраняющий поведение предыдущих версий платформы .NET Framework. Однако если вы обновляете приложение путем изменения пула приложения в IIS, задавая .NET Framework 4 как целевую платформу, ASP.NET использует новый режим по умолчанию. Чтобы отключить новый режим идентификатора клиента, добавьте в файл Web.config следующий параметр:<br><br>`<pages clientIDMode="AutoID" />` |
| **Управление доступом для кода (CAS)** | Функции NET ASP.NET 2.0, добавленные в ASP.NET 3.5, используют модель управления доступом для кода .NET Framework 1.1 и .NET Framework 2.0. Однако реализация управления доступом для кода в ASP.NET 4 значительно усовершенствована. В результате приложения ASP.NET с частичным доверием, которые зависят от выполнения доверенного кода в глобальном кэше сборок, могут давать сбой с различными исключениями безопасности. Приложения с частичным доверием, которые зависят от расширенных изменений в политике разграничения доступа кода компьютера, также могут давать сбои и создавать исключения безопасности. | Поведение приложений ASP.NET 4 с частичным доверием можно изменить на поведение версий ASP.NET 1.1 и 2.0, используя новый атрибут `legacyCasModel` в элементе конфигурации `trust`, как показано в следующем примере:<br><br>`<trust level= "Medium" legacyCasModel="true" />`<br><br>Внимание! Возврат к более старой модели управления доступом для кода может привести к снижению уровня безопасности.<br><br>Дополнительные сведения о новой модели управления доступом для кода в ASP.NET 4 см. в разделе [Управление доступом для кода для приложения ASP.NET 4](https://docs.microsoft.com/previous-versions/dd984947(v=vs.100)). |
| **Файлы конфигурации** | Корневые файлы конфигурации (machine.config и корневой файл Web.config) для .NET Framework и ASP.NET 4 обновлены и теперь включают большую часть стандартных сведений конфигурации, которые в ASP.NET 3.5 находились в файлах Web.config приложения. Так как системы конфигурации управляемых служб IIS 7 и IIS 7.5 очень сложны, выполнение приложений ASP.NET 3.5 на платформе ASP.NET 4 и с IIS 7 или IIS 7.5 может привести к ошибкам ASP.NET или ошибкам IIS. | Обновите приложения ASP.NET 3.5 до ASP.NET 4 с помощью средств обновления проектов в Visual Studio. Visual Studio 2010 автоматически изменяет файл Web.config приложения ASP.NET 3.5 так, чтобы он включал в себя соответствующие параметры для ASP.NET 4.<br><br>Однако приложения ASP.NET 3.5 можно запускать, используя .NET Framework 4, без повторной компиляции. В таком случае может потребоваться вручную изменить файл Web.config приложения перед его запуском на платформе .NET Framework 4 и с IIS 7 или IIS 7.5. Конкретное изменение, которое требуется внести, зависит от сочетания вашего программного обеспечения с учетом пакетов обновления. Сведения о возможных сочетаниях программного обеспечения, на которые влияет данное изменение, и о том, как разрешить проблемы, связанные с определенными сочетаниями, см. в разделе Configuration Errors Related to New ASP.NET 4 Root Configuration ("Ошибки конфигурации, связанные с новой корневой конфигурацией ASP.NET 4") статьи [ASP.NET 4 Breaking Changes](/aspnet/whitepapers/aspnet4/breaking-changes) ("Критические изменения в ASP.NET 4"). |
| **Отрисовка элементов управления** | В более ранних версиях ASP.NET некоторые элементы управления создавали разметку, которую нельзя было отключить. В ASP.NET 4 по умолчанию такой тип разметки больше не создается. Изменения касаются перечисленных ниже элементов управления.<br><br>* Элементы управления `Image` и `ImageButton` больше не отрисовывают атрибут `border="0"`.<br>* Класс `BaseValidator` и проверочные элементы управления, производные от него, по умолчанию больше не отрисовывают текст красного цвета.<br>* Элемент управления `HtmlForm` не отрисовывает атрибут `name`.<br>* Элемент управления `Table` больше не отрисовывает атрибут `border="0"`.<br><br>Элементы управления, не предназначенные для пользовательского ввода (например, элемент управления `Label`), больше не отрисовывают атрибут `disabled="disabled"`, если свойство `Enabled` имеет значение `false` (или если этот параметр унаследован ими от контейнерного элемента управления). | Если вы используете Visual Studio для обновления своего приложения с версии ASP.NET 2.0 или ASP.NET 3.5, средство автоматически добавляет в файл Web.config параметр, сохраняющий традиционную отрисовку. Однако если вы обновляете приложение путем изменения пула приложений в IIS, задавая .NET Framework 4 как целевую платформу, ASP.NET использует новый режим отрисовки по умолчанию. Чтобы отключить новый режим отрисовки, добавьте в файл Web.config следующий параметр:<br><br>`<pages controlRenderingCompatibilityVersion="3.5" />` |
| **Обработчики событий в документах по умолчанию** | ASP.NET 4 отображает значение атрибута `action` HTML-элемента `form` как пустую строку, когда запрос обращен к URL-адресу без расширения, с которым сопоставлен документ по умолчанию. В более ранних выпусках ASP.NET запрос к `http://contoso.com` привел бы к запросу к Default.aspx. В этом документе открывающий тег `form` отображался бы, как показано в следующем примере:<br><br>`<form action="Default.aspx" />`<br><br>В ASP.NET 4 запрос к `http://contoso.com` также приводит к запросу к Default.aspx, но ASP.NET теперь отображает открывающий HTML-тег `form`, как показано в следующем примере:<br><br>`<form action="" />`<br><br>Когда атрибут `action` является пустой строкой, объект `DefaultDocumentModule` служб IIS создает дочерний запрос к Default.aspx. В большинстве случаев этот дочерний запрос прозрачен для кода приложения и страница Default.aspx запускается нормально. Однако возможное взаимодействие между управляемым кодом и интегрированным режимом IIS 7 или IIS 7.5 может привести к тому, что управляемые ASPX-страницы перестанут работать корректно во время выполнения дочернего запроса. При выполнении описанных ниже условий дочерний запрос к ASPX-документу по умолчанию приведет к ошибке или неожиданному поведению.<br><br>* На ASPX-странице, отправляемой браузеру, атрибут `action` элемента `form` имеет значение "".<br>* Форма отправляется обратно платформе ASP.NET.<br>* Управляемый HTTP-модуль считывает некоторую часть тела сущности, например `Request.Form` или `Request.Params`. Это приводит к тому, что тело сущности запроса POST считывается в управляемую память. В результате тело сущности становится недоступным для модулей машинного кода, запущенных в интегрированном режиме IIS 7 или IIS 7.5.<br>* Объект `DefaultDocumentModule` служб IIS со временем выполняется и создает дочерний запрос к документу Default.aspx. Однако так как тело сущности уже было считано частью управляемого кода, тело сущности для отправки в дочерний запрос отсутствует.<br>* При выполнении HTTP-конвейера для дочернего запроса обработчик ASPX-файлов запускается на этапе выполнения обработчика.<br><br>Так как тела сущности нет, нет и переменных формы и состояния просмотра. Поэтому нет информации, позволяющей обработчику ASPX-страницы определить, какое событие должно вызываться (если такое событие имеется). В результате для соответствующей ASPX-страницы ни один из обработчиков событий обратной передачи не выполняется. | Сведения о том, как обойти проблемы, которые могут возникнуть в результате этого изменения, см. в разделе Event Handlers Might Not Be Not Raised in a Default Document in IIS 7 or IIS 7.5 Integrated Mode ("Обработчики событий могут не вызываться в документе по умолчанию в интегрированном режиме IIS 7 или IIS 7.5") статьи [ASP.NET 4 Breaking Changes](/aspnet/whitepapers/aspnet4/breaking-changes) ("Критические изменения в ASP.NET 4"). |
| **Алгоритм хэширования** | ASP.NET использует как алгоритм шифрования, так и алгоритм хэширования для обеспечения безопасности данных, например файлов cookie проверки подлинности форм и состояния просмотра. По умолчанию ASP.NET 4 использует алгоритм <xref:System.Security.Cryptography.HMACSHA256> для операций хэширования файлов cookie и состояния просмотра. В более ранних версиях ASP.NET использовался более старый алгоритм <xref:System.Security.Cryptography.HMACSHA1>. | При запуске приложений, использующих как ASP.NET 2.0, так и ASP.NET 4, если данные, такие как файлы cookie проверки подлинности форм, должны использоваться разными версиями .NET Framework, необходимо настроить веб-приложение ASP.NET 4 так, чтобы в нем применялся более старый алгоритм <xref:System.Security.Cryptography.HMACSHA1>. Для этого в файл Web.config нужно добавить следующий параметр:<br><br>`<machineKey validation="SHA1" />` |
| **Размещение элементов управления в Internet Explorer** | Элементы управления Windows Forms можно больше не размещать в Internet Explorer, так как существуют более предпочтительные решения для размещения элементов управления в веб-приложениях. Поэтому сборки IEHost.dll и IEExec.exe удалены из платформы .NET Framework. | Для разработки пользовательских элементов управления в веб-приложениях можно использовать указанные ниже технологии.<br><br>* Можно создать приложение Silverlight и настроить его для работы вне браузера. Дополнительные сведения см. в разделе [Out-of-Browser Support](https://docs.microsoft.com/previous-versions/windows/silverlight/dotnet-windows-silverlight/dd550721%28v=vs.95%29) ("Поддержка вне браузера").<br>* Можно создать XAML-приложение браузера (XBAP), чтобы воспользоваться возможностями WPF (на клиентских компьютерах должна быть установлена платформа .NET Framework). Дополнительные сведения см. в разделе [Общие сведения о приложениях браузера WPF XAML](../wpf/app-development/wpf-xaml-browser-applications-overview.md). |
| **Методы HtmlEncode и UrlEncode** | Методы `HtmlEncode` и `UrlEncode` классов <xref:System.Web.HttpUtility> и <xref:System.Web.HttpServerUtility> обновлены и теперь кодируют символ одинарной кавычки (') указанным ниже образом.<br><br>* Метод `HtmlEncode` кодирует экземпляры одинарной кавычки как `&#39;`.<br>* Метод `UrlEncode` кодирует экземпляры одинарной кавычки как `%27`. | Просмотрите в коде места, где используются методы `HtmlEncode` и `UrlEncode`, и убедитесь в том, что изменение кодирования не повлияет на ваше приложение. |
| **Ошибки HttpException в приложениях ASP.NET 2.0** | После включения ASP.NET 4 в IIS 6 приложения ASP.NET 2.0, работающие в IIS 6 (в Windows Server 2003 или Windows Server 2003 R2), могут вызывать ошибки наподобие следующей: `System.Web.HttpException: Path '/[yourApplicationRoot]/eurl.axd/[Value]' was not found.` | * Если ASP.NET 4 не требуется для работы веб-сайта, измените сопоставление сайта для использования ASP.NET 2.0.<br><br>-или-<br><br>* Если ASP.NET 4 требуется для запуска веб-сайта, переместите любые дочерние виртуальные каталоги ASP.NET 2.0 на другой веб-сайт, который сопоставлен с ASP.NET 2.0.<br><br>-или-<br><br>* Отключите URL-адреса без расширений. Дополнительные сведения см. в разделе ASP.NET 2.0 Applications Might Generate HttpException Errors That Reference eurl.axd ("Приложения ASP.NET 2.0 могут вызывать ошибки HttpException, в которых указывается eurl.axd") статьи [ASP.NET 4 Breaking Changes](/aspnet/whitepapers/aspnet4/breaking-changes) ("Критические изменения в ASP.NET 4"). |
| **Типы членства** | Некоторые типы (например, <xref:System.Web.Security.MembershipProvider>), используемые в членстве ASP.NET, перемещены из сборки System.Web.dll в сборку System.Web.ApplicationServices.dll. Типы были перемещены для устранения проблемы зависимостей уровней архитектуры между типами в клиенте и в расширенных SKU платформы .NET Framework. | Библиотеки классов, обновленные с предыдущих версий ASP.NET и использующие перемещенные типы членства, могут не компилироваться при использовании в проекте ASP.NET 4. В этом случае добавьте в сборку System.Web.ApplicationServices.dll ссылку из проекта библиотеки классов. |
| **Изменения в элементе управления Menu** | Изменения, внесенные в элемент управления <xref:System.Web.UI.WebControls.Menu>, приводят к описанному ниже поведению.<br><br>* Если для <xref:System.Web.UI.WebControls.MenuRenderingMode> задано значение `List` или для <xref:System.Web.UI.WebControls.MenuRenderingMode> задано значение `Default` и для <xref:System.Web.Configuration.PagesSection.ControlRenderingCompatibilityVersion> — значение `4.0` или выше, свойство <xref:System.Web.UI.WebControls.MenuItem.PopOutImageUrl> не действует.<br>* Если путь, заданный в свойствах <xref:System.Web.UI.WebControls.Menu.StaticPopOutImageUrl%2A> и <xref:System.Web.UI.WebControls.Menu.DynamicPopOutImageUrl>, содержит обратную косую черту (\\), изображения не отрисовываются. (В предыдущих версиях ASP.NET путь мог содержать обратную косую черту.) | * Вместо задания свойства <xref:System.Web.UI.WebControls.MenuItem.PopOutImageUrl> для отдельных пунктов меню задайте свойство <xref:System.Web.UI.WebControls.Menu.StaticPopOutImageUrl%2A> или <xref:System.Web.UI.WebControls.Menu.DynamicPopOutImageUrl> родительского элемента управления <xref:System.Web.UI.WebControls.Menu>.<br><br>-или-<br><br>Для <xref:System.Web.UI.WebControls.MenuRenderingMode> задайте значение `Table` либо для <xref:System.Web.UI.WebControls.MenuRenderingMode> задайте значение `Default` и для <xref:System.Web.Configuration.PagesSection.ControlRenderingCompatibilityVersion> — значение `3.5`. Эти параметры предписывают элементу управления <xref:System.Web.UI.WebControls.Menu> использовать структуру на основе таблицы HTML, которую он использовал в предыдущих версиях ASP.NET.<br>* Если путь в свойстве <xref:System.Web.UI.WebControls.Menu.StaticPopOutImageUrl%2A> или <xref:System.Web.UI.WebControls.Menu.DynamicPopOutImageUrl> содержит обратную косую черту (\\), замените ее на обычную косую черту (/). |
| **Мобильная сборка в файле Web.config** | В предыдущих версиях ASP.NET ссылка на сборку System.Web.Mobile.dll была включена в корневой файл Web.config раздела `assemblies` в `system.web`/`compilation`. Для повышения производительности ссылка на эту сборку удалена.<br><br>Примечание. Сборка System.Web.Mobile.dll и мобильные элементы управления ASP.NET включены в ASP.NET 4, но использовать их не рекомендуется. | Если требуется использовать типы из этой сборки, добавьте ссылку на нее в корневой файл Web.config или в файл Web.config приложения. |
| **Кэширование выходных данных** | В ASP.NET 1.0 ошибка приводила к тому, что кэшированные страницы с параметром кэша выходных данных `Location="ServerAndClient"` создавали HTTP-заголовок `Vary:*` в ответе. Таким образом, клиентские браузеры получали указание никогда не кэшировать такую страницу локально. В ASP.NET 1.1 был добавлен метод <xref:System.Web.HttpCachePolicy.SetOmitVaryStar%2A>, который можно было вызвать для подавления заголовка `Vary:*`. Однако отчеты об ошибках позволяют предположить, что разработчики не знают о поведении метода `SetOmitVaryStar`.<br><br>В ASP.NET 4 HTTP-заголовок `Vary:*` больше не создается для ответов, задающих следующую директиву:<br><br>`<%@ OutputCache Location="ServerAndClient" %>`<br><br>Поэтому метод <xref:System.Web.HttpCachePolicy.SetOmitVaryStar%2A> больше не требуется для подавления заголовка `Vary:*`. В приложениях, в которых атрибут `Location` имеет значение ServerAndClient, страницы можно будет кэшировать в браузере, не вызывая метод <xref:System.Web.HttpCachePolicy.SetOmitVaryStar%2A>. | Если страницы в приложении должны создавать заголовок `Vary:*`, следует вызвать метод <xref:System.Web.HttpResponse.AppendHeader%2A>, как показано в следующем примере:<br><br>`System.Web.HttpResponse.AppendHeader("Vary","*");`<br><br>Кроме того, можно изменить значение атрибута `Location` кэширования выходных данных на Server. |
| **Разбор страниц** | Анализатор веб-страниц ASP.NET (ASPX-файлов) и пользовательских элементов управления (ASCX-файлов) в ASP.NET 4 работает строже, чем в предыдущих версиях ASP.NET, и помечает флагом недопустимости больше разметки, чем в предыдущих версиях. | Проанализируйте сообщения об ошибках, появляющиеся при выполнении страницы, и исправьте ошибки, возникающие из-за недопустимой разметки. |
| **Типы Passport** | Поддержка Passport, встроенная в ASP.NET 2.0, устарела и теперь не обеспечивается из-за изменений в службе Passport (теперь используется пакет SDK Live ID). Поэтому типы, связанные со службой Passport в пространстве имен <xref:System.Web.Security>, теперь помечены атрибутом `ObsoleteAttribute`. | Измените код, в котором используются типы Passport в пространстве имен <xref:System.Web.Security> (например, <xref:System.Web.Security.PassportIdentity>), так, чтобы в нем использовался [пакет SDK](https://go.microsoft.com/fwlink/?LinkId=106346). |
| **Сведения PathInfo в свойстве FilePath** | ASP.NET 4 больше не включает значение `PathInfo` в возвращаемые значения таких свойств, как <xref:System.Web.HttpRequest.FilePath>, <xref:System.Web.HttpRequest.AppRelativeCurrentExecutionFilePath> и <xref:System.Web.HttpRequest.CurrentExecutionFilePath>. Вместо этого сведения `PathInfo` доступны в свойстве <xref:System.Web.HttpRequest.PathInfo>. Рассмотрим следующий фрагмент URL-адреса:<br><br>`/testapp/Action.mvc/SomeAction`<br><br>В более ранних версиях ASP.NET свойства <xref:System.Web.HttpRequest> имели бы следующие значения:<br><br>* <xref:System.Web.HttpRequest.FilePath>: `/testapp/Action.mvc/SomeAction`<br>* <xref:System.Web.HttpRequest.PathInfo>: (пусто)<br><br>В ASP.NET 4 свойства <xref:System.Web.HttpRequest> вместо этого имеют следующие значения:<br><br>* <xref:System.Web.HttpRequest.FilePath>: `/testapp/Action.mvc`<br>* <xref:System.Web.HttpRequest.PathInfo>: `SomeAction` | Найдите места в коде, где для получения сведений о пути используются свойства класса <xref:System.Web.HttpRequest>. Измените код в соответствии с изменением способа получения сведений о пути. |
| **Проверка запросов** | Чтобы улучшить проверку запросов, проверка запроса ASP.NET теперь вызывается раньше в жизненном цикле запроса. В результате проверка запросов выполняется для запросов, предназначенных не для ASPX-файлов, а, например, для вызовов веб-служб и для пользовательских обработчиков. Проверка запросов также будет активна при выполнении пользовательских HTTP-модулей в конвейере обработки запросов.<br><br>В результате этого изменения запросы ресурсов, отличных от ASPX-файлов, могут приводить к ошибкам проверки запросов. Выполнение пользовательского кода в конвейере запросов (например, пользовательских HTTP-модулей) также может приводить к ошибкам проверки запросов. | Если необходимо, чтобы проверка запроса выполнялась только для ASPX-страниц, можно вернуться к старому поведению, задав в файле веб-конфигурации следующий параметр:<br><br>`<httpRuntime requestValidationMode="2.0" />`<br><br>Предупреждение: В случае возврата к старому поведению убедитесь, что весь код в существующих обработчиках и модулях, а также другой пользовательский код выполняют проверки на предмет потенциально опасных входных данных HTTP, которые могут представлять векторы атак XSS. |
| **Routing** | Если вы создаете веб-сайт на базе файловой системы в Visual Studio 2010 и он находится в папке, в имени которой есть точка (.), маршрутизация URL-адресов не будет работать надежно. От некоторых виртуальных путей будет возвращаться ошибка HTTP 404. Причина в том, что Visual Studio 2010 запускает сервер Visual Studio Development Server, используя неправильный путь к корневому виртуальному каталогу. | * На странице **Свойства** веб-сайта на базе файловой системы измените значение атрибута **Виртуальный путь** на "/".<br><br>-или-<br><br>* Создайте проект веб-приложения вместо проекта веб-сайта. В проектах веб-приложений такой проблемы не существует, и маршрутизация URL-адресов работает, даже если в имени папки проекта есть точка.<br><br>-или-<br><br>* Создайте веб-сайт на базе HTTP, размещенный в IIS. Веб-сайты, размещенные в IIS, могут содержать точки в виртуальном пути и в имени папки файла проекта. |
| **Сайты SharePoint** | При попытке запустить веб-сайт ASP.NET 4, который развернут как дочерний элемент веб-сайта SharePoint, содержащего настраиваемый уровень частичного доверия с именем `WSS_Minimal`, появляется следующее сообщение об ошибке:<br><br>`Could not find permission set named 'ASP.Net'.` | В настоящее время нет версий SharePoint, совместимых с ASP.NET. Поэтому не следует пытаться запустить веб-сайт ASP.NET 4 как дочерний элемент веб-сайта SharePoint. |
| **Стандарты XHTML 1.1** | Чтобы обеспечить соответствие стандартам XHTML 1.1 для новых веб-сайтов, элементы управления ASP.NET в .NET Framework 4 создают код HTML, соответствующий XHTML 1.1. Такая отрисовка включается следующим параметром в элементе `<system.Web>` файла Web.config:<br><br>`<pages controlRenderingCompatibilityVersion="4.0"/>`<br><br>По умолчанию параметр имеет значение 4.0. В веб-проектах, обновленных от Visual Studio 2008 до более новой версии, этот параметр имеет значение 3.5 для совместимости. | Отсутствует. |

## <a name="core"></a>Ядро

### <a name="general-features"></a>Общие возможности

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **CardSpace** | Компонент Windows CardSpace больше не включается в платформу .NET Framework; он предоставляется отдельно. | Скачайте Windows CardSpace из [Центра загрузки Майкрософт](https://go.microsoft.com/fwlink/?LinkId=199868). |
| **Файлы конфигурации** | Внесены исправления в отношении доступа платформы .NET Framework к файлам конфигурации приложений. | Если файл конфигурации приложения имеет имя *имя_приложения.config*, переименуйте его в файл *имя_приложения.exe.config*. Например, переименуйте файл *MyApp.config* в файл *MyApp.exe.config*. |
| **Компилятор кода C#** | Классы `Compiler`, `CompilerError` и `ErrorLevel`, которые находились в пространстве имен <xref:Microsoft.CSharp>, больше не доступны, и их сборка (cscompmgd.dll) больше не включается в платформу .NET Framework. | Используйте класс <xref:System.CodeDom.Compiler.CodeDomProvider> и другие классы в пространстве имен <xref:System.CodeDom.Compiler>. Дополнительные сведения см. в разделе [Использование CodeDOM](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/y2k85ax6%28v=vs.100%29). |
| **Размещение** (неуправляемый интерфейс API) | Чтобы улучшить возможности размещения, некоторые API активации размещения стали нерекомендуемыми. Функции внутрипроцессного параллельного выполнения позволяют приложению загружать и запускать несколько версий .NET Framework в одном процессе. Например, можно запускать приложения, которые загружают надстройки (или компоненты), созданные на основе .NET Framework 2.0 с пакетом обновления 1 (SP1) и .NET Framework 4, в одном и том же процессе. Более старые компоненты продолжают использовать более раннюю версию платформы .NET Framework, а новые компоненты используют ее новую версию. | Используйте конфигурацию, описанную в разделе [Внутрипроцессное параллельное выполнение](../deployment/in-process-side-by-side-execution.md). |
| **Новая модель безопасности** | Политика разграничения доступа кода отключена и заменена упрощенной моделью, как описано в разделе [Изменения системы безопасности в платформе .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/dd233103%28v=vs.100%29). | Если ваши приложения зависят от управления доступом для кода, могут потребоваться изменения. Дополнительные сведения см. в разделе [Совместимость политики разграничения доступа кода и ее миграция](../misc/code-access-security-policy-compatibility-and-migration.md). |

### <a name="date-and-time"></a>Дата и время

Пространство имен: <xref:System>; сборка: mscorlib (в mscorlib.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Летнее время** | Для соответствия системным часам свойства времени (такие как <xref:System.TimeZoneInfo.Local> и <xref:System.DateTime.Now>) теперь используют правила операционной системы вместо других данных .NET Framework для перехода на летнее время. | Отсутствует. |
| **Форматирование строк** | Для поддержки форматирования, учитывающего язык и региональные параметры, структура <xref:System.TimeSpan> содержит новые перегрузки методов `ToString`, `Parse` и `TryParse`, а также новые методы `ParseExact` и `TryParseExact`. | Отсутствует. |

### <a name="globalization"></a>Глобализация

Список новых нейтральных и специальных наборов языков и региональных параметров см. в разделе [Новые возможности глобализации и локализации](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/dd997383%28v=vs.100%29).

Пространство имен: <xref:System.Globalization>; сборка: mscorlib (в mscorlib.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Имена языков и региональных параметров** | Перечисленные ниже изменения имен затрагивают немецкий, мальдивский и африканские языки и региональные параметры.<br><br>* <xref:System.Globalization.CultureAndRegionInfoBuilder.CurrencyEnglishName>: имя валюты для немецкого (Швейцария) языка и региональных параметров (de-CH) изменилось с sFr. на Fr.<br>* <xref:System.Globalization.DateTimeFormatInfo.LongDatePattern>: шаблон полной даты для мальдивского языка и региональных параметров (dv-MV) изменился с "дд/мммм/гггг" на "дд/мм/гггг".<br>* <xref:System.Globalization.DateTimeFormatInfo.PMDesignator>: обозначение времени после полудня. для языка и региональных параметров африкаанс (Южно-Африканская Республика) (af-ZA) изменилось с nm на PM. | Обратите внимание на изменения в именах языков и региональных параметров. |
| **Параметр кода языка (LCID)** | Для соответствия ожидаемому поведению в параметрах сервера автоматизации среда CLR больше не передает текущие язык и региональные параметры для параметра `LCID` в неуправляемые приложения на основе модели COM. Вместо этого для языка и региональных параметров передается 1033 (en-us). | Изменения необходимы только для собственных приложений, требующих определенного языка и региональных параметров. |
| **Устаревшие типы языка и региональных параметров** | Типы языка и региональных параметров <xref:System.Globalization.CultureTypes> и <xref:System.Globalization.CultureTypes> теперь являются устаревшими.<br><br>Для обратной совместимости поле <xref:System.Globalization.CultureTypes> теперь возвращает нейтральные и определенные языки и региональные параметры, которые были включены в более ранние версии .NET Framework, а поле <xref:System.Globalization.CultureTypes> теперь возвращает пустой список. | Используйте другие значения перечисления <xref:System.Globalization.CultureTypes>. |
| **Получение языка и региональных параметров** | Начиная с Windows 7, платформа .NET Framework 4 извлекает информацию о языке и региональных параметрах из операционной системы, вместо того чтобы хранить эти данные у себя. Кроме того, .NET Framework синхронизирует с Windows сведения о сортировке и регистре. | Отсутствует. |
| **Стандарты Юникода 5.1** | Платформа .NET Framework теперь поддерживает все символы Юникода 5.1 (добавлено примерно 1400 символов). Добавленные символы включают в себя новые символы, стрелки, диакритические знаки, пунктуационные и математические символы, ККЯ-штрихи, идеографические символы, дополнительные числовые знаки языков малаялам и телугу, различные символы бирманской, латинской, арабской, греческой, монгольской и кириллической письменности. Следующие новые виды письменности поддерживаются в Юникоде 5.1: суданская, лепча, ол-чики, ваи, саураштра, кайя ли, реджангская, гурмухи, ория, тамильская, телугу, малаялам и чамская. | Отсутствует. |

### <a name="exceptions"></a>Исключения

Пространство имен: <xref:System>, <xref:System.Runtime.ExceptionServices>; сборка: mscorlib (в mscorlib.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Исключения, касающиеся поврежденного состояния процесса** | Среда CLR больше не передает обработчику исключений в управляемом коде исключения, касающиеся поврежденного состояния процесса. | Эти исключения указывают, что состояние процесса повреждено. Запускать приложение в этом состоянии не рекомендуется.<br><br>Дополнительные сведения см. в разделе <xref:System.Runtime.ExceptionServices.HandleProcessCorruptedStateExceptionsAttribute> и в записи [Обработка исключений поврежденного состояния](https://go.microsoft.com/fwlink/?LinkID=179681) блога "Среда CLR вдоль и поперек". |
| **Исключения подсистемы выполнения** | Класс <xref:System.ExecutionEngineException> теперь является устаревшим, так как перехватываемое исключение позволяет продолжать выполнение нестабильного процесса. Это изменение увеличивает предсказуемость и надежность в среде выполнения. | Используйте класс <xref:System.InvalidOperationException> для обозначения состояния. |

### <a name="reflection"></a>Отражение

Пространство имен: <xref:System.Reflection>; сборка: mscorlib (в mscorlib.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Хэш-алгоритмы для сборок** | Свойство <xref:System.Reflection.AssemblyName.HashAlgorithm> теперь возвращает <xref:System.Configuration.Assemblies.AssemblyHashAlgorithm>, так как среда выполнения не знает хэш-алгоритма сборки, на которую указывает ссылка, если сборка не загружена. (Это касается использования данного свойства в сборке, на которую указывает ссылка, например в сборке, возвращаемой методом <xref:System.Reflection.Assembly.GetReferencedAssemblies%2A>.) | Отсутствует. |
| **Загрузка сборок** | Для предотвращения избыточной загрузки сборок и сохранения виртуального адресного пространства среда CLR теперь загружает сборки, используя только функцию `MapViewOfFile` Win32. Кроме того, больше не вызывается функция `LoadLibrary`.<br><br>Это изменение влияет на диагностические приложения указанным ниже образом.<br><br>* Коллекция <xref:System.Diagnostics.ProcessModuleCollection> больше не будет содержать какие-либо модули из библиотеки классов (DLL-файла), как после вызова `Process.GetCurrentProcess().Modules`.<br>* Приложениям Win32, использующим функцию `EnumProcessModules`, не будут видны все управляемые модули в списке. | Отсутствует. |
| **Объявляющий тип** | Свойство <xref:System.Type.DeclaringType> теперь корректно возвращает значение NULL, если тип не имеет объявляющего типа. | Отсутствует. |
| **Делегаты** | Делегат теперь создает исключение <xref:System.ArgumentNullException> вместо исключения <xref:System.NullReferenceException> при передаче значения NULL в конструктор делегата. | Убедитесь в том, что при обработке исключений перехватываются исключения <xref:System.ArgumentNullException>. |
| **Изменение местоположения глобального кэша сборок** | Для сборок .NET Framework 4 глобальный кэш сборок перемещен из каталога Windows (%WINDIR%) в подкаталог Microsoft.Net ( *%WINDIR%\\Microsoft.Net*). Сборки более ранних версий остаются в старом каталоге.<br><br>Неуправляемое перечисление [ASM_CACHE_FLAGS](../unmanaged-api/fusion/asm-cache-flags-enumeration.md) содержит новый флаг `ASM_CACHE_ROOT_EX`. Этот флаг получает местоположение кэша для сборок .NET Framework 4, которые могут быть получены функцией [GetCachePath](../unmanaged-api/fusion/getcachepath-function.md). | Нет, если приложения не используют явные пути к сборкам, что не рекомендуется. |
| **Средство глобального кэша сборок** | Средство [Gacutil.exe (программа глобального кэша сборок)](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ex0ss12c%28v=vs.100%29) больше не поддерживает средство просмотра подключаемого модуля оболочки. | Отсутствует. |

### <a name="interoperability"></a>Взаимодействие

Пространство имен: <xref:System.Runtime.InteropServices>; сборка: mscorlib (в mscorlib.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Длина буфера** (неуправляемый интерфейс API) | Для экономии памяти функциональность параметра `pBufferLengthOffset` метода [ICorProfilerInfo2::GetStringLayout](../unmanaged-api/profiling/icorprofilerinfo2-getstringlayout-method.md) изменена так, чтобы соответствовать параметру `pStringLengthOffset`. Оба параметра теперь указывают на расположение смещения длины строки. Длина буфера удалена из представления строкового класса. | Измените части, зависящие от длины буфера. |
| **JIT-отладка** | Чтобы упростить регистрацию для JIT-отладки, отладчик .NET Framework теперь использует только раздел реестра AeDebug, управляющий поведением JIT-отладки для машинного кода. Это изменение имеет указанные ниже последствия.<br><br>* Теперь нельзя регистрировать два разных отладчика для управляемого и машинного кода.<br>* Теперь нельзя автоматически запускать отладчик для неинтерактивного процесса, но можно предложить пользователю интерактивный процесс.<br>* Если не удается запустить отладчик или нет зарегистрированного отладчика, который должен быть запущен, уведомление больше не выводится.<br>* Политики автоматического запуска, зависящие от интерактивности приложения, больше не поддерживаются. | Скорректируйте операции отладки согласно требованиям. |
| **Вызов неуправляемого кода** | Чтобы улучшить производительность при взаимодействии с неуправляемым кодом, некорректные соглашения о вызовах в вызове неуправляемого кода теперь приводят к сбою приложения. В более ранних версиях слой маршалинга разрешал такие ошибки вверх по стеку. | При отладке приложений в Microsoft Visual Studio вы получите оповещения о таких ошибках и сможете исправить их.<br><br>Если у вас есть двоичные файлы, которые невозможно обновить, можно включить элемент [\<NetFx40_PInvokeStackResilience>](../configure-apps/file-schema/runtime/netfx40-pinvokestackresilience-element.md) в файл конфигурации приложения, чтобы ошибки вызовов разрешались вверх по стеку, как в более ранних версиях. Однако это может повлиять на производительность приложения. |
| **Удаленные интерфейсы** (неуправляемый интерфейс API) | Чтобы не вводить в заблуждение разработчиков, перечисленные ниже интерфейсы были удалены. Причина удаления в том, что они не обеспечивали никаких полезных сценариев времени выполнения и среда CLR не предоставляла и не принимала никаких реализаций.<br><br>* **INativeImageINativeImageDependency**<br>* **INativeImageInstallInfo**<br>* **INativeImageEvaluate**<br>* **INativeImageConverter**<br>* **ICorModule**<br>* **IMetaDataConverter** | Отсутствует. |

## <a name="data"></a>Data

В этом разделе описаны проблемы с миграцией при использовании наборов данных и клиентов SQL, Entity Framework, LINQ to SQL и серверов данных WCF (ранее называвшихся службами данных ADO.NET).

### <a name="dataset-and-sql-client"></a>Набор данных и клиент SQL

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

Пространства имен: <xref:System.Data>, <xref:System.Data.Objects.DataClasses>, <xref:System.Data.SqlClient>; сборки: System.Data (в System.Data.dll), System.Data.Entity (в System.Data.Entity.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Сценарии POCO** | Для более удобного использования в сценариях POCO интерфейс <xref:System.Data.Objects.DataClasses.IRelatedEnd> теперь имеет новые методы. Они принимают объект <xref:System.Object> вместо сущности <xref:System.Data.Objects.DataClasses.IEntityWithRelationships> в качестве параметра. |
| **Редактирование строк** | Метод <xref:System.Collections.IList.IndexOf%2A>, реализованный классом <xref:System.Data.DataView>, теперь правильно возвращает значение редактируемой строки, а не значение –1. |
| **События** | Событие <xref:System.Data.DataRowView.PropertyChanged> теперь вызывается, когда строка находится в измененном состоянии и вызван метод <xref:System.Data.DataRow.RejectChanges%2A>. Благодаря этому изменению стало проще создавать элементы управления пользовательского интерфейса, предоставляющие содержимое объекта <xref:System.Data.DataSet>. |
| **Исключения** | Когда подключение не установлено или не открыто, метод <xref:System.Data.SqlClient.SqlCommand.Prepare%2A> теперь вызывает исключение <xref:System.InvalidOperationException> вместо исключения <xref:System.NullReferenceException>. |
| **Сопоставление представлений** | Ошибки сопоставления представлений запросов теперь перехватываются во время разработки; во время выполнения теперь не создается исключение <xref:System.NullReferenceException>.<br><br>Проверка сопоставления теперь перехватывает ошибку, когда два набора ассоциаций в концептуальной схеме (CSDL) сопоставлены с одним столбцом. |
| **Транзакции** | Если приложение попытается выполнить оператор применительно к подключению после завершения транзакции (в том числе прерванной транзакции или отката), будет создано исключение <xref:System.InvalidOperationException>. Более ранние версии не создавали исключение и позволяли выполнять дополнительные команды, даже если транзакция была прервана. |

### <a name="entity-framework"></a>Entity Framework

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

Пространства имен: <xref:System.Data>, <xref:System.Data.Objects>, <xref:System.Data.Objects.DataClasses>; сборка: System.Data.Entity (в System.Data.Entity.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Объекты сущностей** | Установлена равнозначность между методом <xref:System.Data.Objects.ObjectContext.Detach%2A> и состоянием объекта сущности при вызове метода <xref:System.Data.Objects.ObjectContext.SaveChanges%2A>. Повышение согласованности предотвращает возникновение неожиданных исключений. |
| **Entity SQL** | Улучшены правила разрешения идентификаторов в Entity SQL.<br><br>Анализатор Entity SQL теперь имеет улучшенную логику для разрешения составных идентификаторов. |
| **Структурные заметки** | Entity Framework теперь распознает структурные заметки. |
| **Запросы** | Запросов коснулись перечисленные ниже усовершенствования.<br><br>* Запрос `GroupBy` с использованием ключа NULL для пустой коллекции не приведет к возврату каких-либо строк независимо от наличия в запросе дополнительных указаний.<br>* Созданный код SQL в запросах LINQ и Entity-SQL теперь по умолчанию обрабатывает строковые параметры как значения, не имеющие кодировку Юникод. |

### <a name="linq-to-sql"></a>LINQ to SQL

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

Пространства имен: <xref:System.Data.Linq>; сборка: System.Data.Linq (в System.Data.Linq.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **События** | Коллекция <xref:System.Data.Linq.EntitySet%601> теперь вызывает событие <xref:System.Data.Linq.EntitySet%601.ListChanged> для операций добавления и удаления не только когда коллекция <xref:System.Data.Linq.EntitySet%601> загружается, но и когда она выгружается. |
| **Запросы** | `Skip(0)` больше не игнорируется в запросах LINQ to SQL. В результате запросы, в которых есть этот метод, могут вести себя по-другому. Например, в некоторых случаях требуется предложение `OrderBy` со `Skip(0)`, и, если предложение `OrderBy` не было включено, запрос теперь будет вызывать исключение <xref:System.NotSupportedException>. |

### <a name="wcf-data-services"></a>Службы данных WCF

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

Пространства имен: <xref:System.Data.Services>, <xref:System.Data.Services.Client>, <xref:System.Data.Services.Common>, <xref:System.Data.Services.Providers>; сборки: System.Data.Services (в System.Data.Services.dll), System.Data.Services.Client (в System.Data.Services.Client.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Пакетное двоичное содержимое** | Службы WCF Data Services теперь поддерживают пакетное двоичное содержимое в запросах и ответах. |
| **Перехватчики изменений** | Перехватчики изменений теперь выполняются для запроса на удаление.<br><br>Перехватчик изменений — это метод, выполняемый каждый раз, когда сервер получает запрос на изменение сущности в наборе сущностей. Он выполняется до выполнения входящего запроса. Перехватчик изменений предоставляет доступ к изменяемой сущности и выполняемой операции. |
| **Исключения** | Перечисленные ниже условия теперь вызывают более полезные исключения вместо исключения <xref:System.NullReferenceException>.<br><br>* При истечении времени ожидания для вызова службы данных возникает исключение <xref:System.ServiceProcess.TimeoutException>.<br>* При неправильном запросе службы данных вызывается исключение <xref:System.Data.Services.Client.DataServiceRequestException>.<br><br>Измените в приложениях обработку исключений, чтобы новые исключения перехватывались. |
| **Заголовки** | Заголовков коснулись перечисленные ниже усовершенствования.<br><br>* Службы WCF Data Services теперь корректно отклоняют заголовок `eTag`, значение которого не задано.<br>* Службы WCF Data Services теперь возвращают ошибку и не выполняют запрос на удаление запроса на ссылку, если в запросе есть заголовок `if-*`.<br>* Службы WCF Data Services теперь возвращают клиенту ошибку в формате (Atom, JSON), который клиент указал в заголовке Accept. |
| **Модуль чтения JSON** | Модуль чтения JSON (JavaScript Object Notation — нотация объектов JavaScript) теперь корректно возвращает ошибку при чтении одиночного escape-символа обратной косой черты (\\) во время обработки полезных нагрузок JSON, отправленных в службу данных WCF. |
| **Слияния** | Перечисления <xref:System.Data.Services.Client.MergeOption> коснулись перечисленные ниже усовершенствования.<br><br>* Параметр слияния <xref:System.Data.Services.Client.MergeOption> больше не изменяет сущность в клиенте в результате последующего ответа службы данных.<br>* Параметр <xref:System.Data.Services.Client.MergeOption> теперь согласован между динамическим SQL и обновлениями на основе хранимых процедур. |
| **Запросы** | Метод <xref:System.Data.Services.DataService%601.OnStartProcessingRequest%2A> теперь вызывается перед обработкой запроса, обращенного к службам данных. Это позволяет обеспечить правильную работу запроса для служб <xref:System.Data.Services.Providers.ServiceOperation>. |
| **Потоки** | Службы WCF Data Services больше не закрывают базовый поток для операций чтения и записи. |
| **Универсальные коды ресурсов (URI)** | Экранирование кодов URI клиентом служб WCF Data Services исправлено. |

## <a name="windows-communication-foundation-wcf"></a>Windows Communication Foundation (WCF)

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Файлы конфигурации** | Чтобы обеспечить наследование поведения в иерархии файлов конфигурации, WCF теперь поддерживает слияние по нескольким файлам конфигурации.<br><br>Модель наследования конфигурации расширена и теперь позволяет пользователям определять поведение, которое будет применено ко всем службам, запущенным на компьютере.<br><br>Могут произойти изменения поведения, если есть несколько вариантов поведения с одинаковыми именами на различных уровнях иерархии. |
| **Размещение службы** | Элемент конфигурации `<serviceHostingEnvironment>` больше нельзя задавать на уровне службы, добавляя атрибут `allowDefinition="MachineToApplication"` в определение элемента.<br><br>Задание элемента `<serviceHostingEnvironment>` на уровне службы технически некорректно и приводит к нарушению целостности поведения. |

## <a name="windows-presentation-foundation-wpf"></a>Windows Presentation Foundation (WPF)

### <a name="applications"></a>Приложения

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Controls>; сборка: PresentationFramework (в PresentationFramework.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Обработка исключений** | Чтобы как можно раньше обнаруживать ошибки, WPF создает исключение <xref:System.Reflection.TargetInvocationException> и задает свойство <xref:System.Exception.InnerException> для критических исключений, таких как <xref:System.NullReferenceException>, <xref:System.OutOfMemoryException>, <xref:System.StackOverflowException> и <xref:System.Security.SecurityException>, вместо того чтобы перехватывать исходное исключение. | Отсутствует. |
| **Связанные ресурсы** | Чтобы облегчить связывание, файлы ресурсов (например, изображения), расположенные не в структуре папки проекта, используют как идентификатор ресурса полный путь к файлу ресурсов вместо простого имени файла. Приложение будет иметь возможность найти эти файлы во время выполнения. | Отсутствует. |
| **Приложения с частичным доверием** | По соображениям безопасности приложения на основе Windows, использующие частичное доверие и содержащие элемент управления <xref:System.Windows.Controls.WebBrowser> или элемент управления <xref:System.Windows.Controls.Frame>, который содержит HTML, вызывают исключение <xref:System.Security.SecurityException> при создании этого элемента управления.<br><br>Браузерные приложения будут вызывать исключение и выводить сообщение, если выполняются все перечисленные ниже условия.<br><br>* Приложение работает в Firefox.<br>* Приложение запускается в режиме частичного доверия в зоне Интернета с ненадежных сайтов.<br>* В приложении имеется элемент управления <xref:System.Windows.Controls.WebBrowser> или <xref:System.Windows.Controls.Frame>, содержащий HTML.<br><br>Следует отметить, что это не относится к приложениям, запускаемым с надежных сайтов или из зоны интрасети. | В браузерных приложениях можно смягчить последствия этого изменения, выполнив одно из следующих действий:<br><br>* запускать приложение в режиме полного доверия;<br>* попросить клиентов добавить сайт приложения в зону надежных сайтов;<br>* попросить клиентов запускать приложение в Internet Explorer. |
| **Словари ресурсов** | Чтобы улучшить словари ресурсов на уровне темы и предотвратить их изменение, фиксируемые ресурсы, определенные в словаре ресурсов и объединенные в словарь на уровне темы, теперь всегда помечаются как фиксированные и не могут изменяться. Это ожидаемое поведение для фиксируемых ресурсов. | Приложения, изменяющие ресурс, определенный в объединенном словаре на уровне темы, должны клонировать ресурс и изменять копию. Кроме того, можно пометить ресурс как `x:Shared="false"`, чтобы словарь <xref:System.Windows.ResourceDictionary> создавал копию каждый раз, когда ресурс запрашивается. |
| **Windows 7** | Чтобы приложения WPF лучше работали в Windows 7, были внесены указанные ниже изменения для исправления поведения окна.<br><br>* Состояния закрепления и жестов теперь работают предсказуемо в соответствии с действиями пользователей.<br>* Команды панели задач **Окна каскадом, Отображать окна стопкой** и **Отображать окна рядом** теперь дают правильный результат и обновляют соответствующие свойства.<br>* Свойства `Top`, `Left`, `Width` и `Height` для открытого во весь экран или свернутого окна теперь содержат правильные сведения о расположении для восстановления окна в зависимости от монитора. | Отсутствует. |
| **Стиль и прозрачность Windows** | Исключение <xref:System.InvalidOperationException> создается при попытке задать для свойства <xref:System.Windows.Window.WindowStyle> значение, отличное от <xref:System.Windows.WindowStyle>, если свойство <xref:System.Windows.Window.AllowsTransparency> имеет значение `true`, а <xref:System.Windows.WindowState> имеет значение <xref:System.Windows.WindowState>. | Если требуется изменить значение свойства <xref:System.Windows.Window.WindowStyle>, когда свойство <xref:System.Windows.Window.AllowsTransparency> имеет значение `true`, можно вызвать функцию `SetWindowLongPtr` Win32. |
| **Средство просмотра XPS** | В WPF не входит пакет Microsoft XML Paper Specification Essentials Pack (XPSEP). XPSEP включается в Windows 7 и Windows Vista.<br><br>На компьютере с ОС Windows XP, на котором не установлена платформа .NET Framework 3.5 с пакетом обновления 1 (SP1), печать с помощью интерфейса API WPF, отличного от того, что используется в <xref:System.Windows.Controls.PrintDialog>, будет зависеть от WINSPOOL. Не будет сообщено о некоторых возможностях принтера, и некоторые параметры принтера не будут применяться во время печати. | При необходимости установите [пакет Microsoft XML Paper Specification Essentials Pack](https://go.microsoft.com/fwlink/?LinkId=178895). |

### <a name="controls"></a>Элементы управления

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Controls>, <xref:System.Windows.Data>, <xref:System.Windows.Input>; сборки: PresentationFramework (в PresentationFramework.dll), PresentationCore (в PresentationCore.dll), WindowsBase (в WindowsBase.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Диалоговые окна** | Для увеличения надежности метод <xref:Microsoft.Win32.CommonDialog.ShowDialog%2A> вызывается в том же потоке, где был создан элемент управления <xref:Microsoft.Win32.FileDialog>. | Элемент управления <xref:Microsoft.Win32.FileDialog> должен создаваться в том же потоке, где вызывается метод <xref:Microsoft.Win32.CommonDialog.ShowDialog%2A>. |
| **Плавающие окна** | Чтобы исправить логику восстановления фокуса, которая приводит к ошибочной повторной активации плавающего окна (в результате окно появляется как модальное диалоговое окно), восстановление фокуса теперь не выполняется, если объект не является дочерним объектом окна. | Отсутствует. |
| **Элементы коллекции** | Когда элемент перемещается или добавляется в базовую коллекцию, он появляется в представлении <xref:System.Windows.Data.CollectionView> в том же относительном расположении, как если бы представление <xref:System.Windows.Data.CollectionView> не сортировалось. Это обеспечивает согласованность между расположением элемента в коллекции и в связанном представлении <xref:System.Windows.Data.CollectionView>. | Используйте метод <xref:System.Windows.Controls.ItemContainerGenerator.ContainerFromItem%2A> или <xref:System.Windows.Data.CollectionView.IndexOf%2A> для поиска расположения элемента в объекте <xref:System.Windows.Data.CollectionView>, вместо того чтобы полагаться на фиксированное расположение элемента. |
| **Макеты** | Чтобы избежать ненужного повторного создания макетов, изменение свойства <xref:System.Windows.Controls.Page.ShowsNavigationUI> больше не делает макет недействительным и не вызывает передачу другого макета. | Если вы предполагаете, что изменение свойства <xref:System.Windows.Controls.Page.ShowsNavigationUI> приведет к передаче другого макета, вызовите метод <xref:System.Windows.UIElement.InvalidateVisual%2A> после задания этого свойства. |
| **Меню** | Чтобы текст ClearType мог использоваться во всплывающих меню, внесены изменения в класс <xref:System.Windows.Controls.ControlTemplate> и в элемент управления <xref:System.Windows.Controls.MenuItem>, а также в другие элементы управления. | Приложения не должны опираться на визуальную структуру шаблонов элементов управления. Частью открытого контракта являются только именованные части шаблона <xref:System.Windows.Controls.ControlTemplate>. Если приложение должно найти конкретный объект в шаблоне <xref:System.Windows.Controls.ControlTemplate>, следует выполнять поиск по визуальному дереву, а не полагаться на фиксированное расположение объекта в дереве. |
| **Навигация** | Если объект <xref:System.Windows.Controls.Frame> непосредственно переходит в расположение, свойство <xref:System.Windows.Navigation.NavigatingCancelEventArgs.IsNavigationInitiator> принимает значение `true` после первого перехода. Это изменение предотвращает возникновение дополнительных событий при выполнении сценариев запуска. | Отсутствует. |
| **Всплывающие окна** | Теперь во время передачи макета делегат <xref:System.Windows.Controls.Primitives.CustomPopupPlacementCallback> может вызываться не один раз, а несколько. | Если делегат <xref:System.Windows.Controls.Primitives.CustomPopupPlacementCallback> рассчитывает положение объекта <xref:System.Windows.Controls.Primitives.Popup> на основе его предыдущего расположения, значение должно пересчитываться только в том случае, если изменились параметры `popupSize`, `targetSize` или `offset`. |
| **Значения свойств** | Метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> теперь позволяет задать для свойства действующее значение, хотя он продолжает учитывать привязку, стиль или триггер, влияющие на свойство. | Создатели элементов управления должны использовать метод <xref:System.Windows.DependencyObject.SetCurrentValue%2A> всякий раз, когда значение свойства изменяется в результате побочного эффекта какого-либо другого действия, в том числе операции пользователя. |
| **Текстовые поля** | По соображениям безопасности методы <xref:System.Windows.Forms.TextBoxBase.Copy%2A> и <xref:System.Windows.Forms.TextBoxBase.Cut%2A> завершаются ошибкой без оповещения при вызове с частичным доверием.<br><br>Кроме того, программное выполнение свойства <xref:System.Windows.Input.ApplicationCommands.Copy> или <xref:System.Windows.Input.ApplicationCommands.Cut> для элемента управления, наследующего от класса <xref:System.Windows.Controls.Primitives.TextBoxBase>, будет блокировано при частичном доверии. Однако вызванные пользователем команды копирования и вырезания, например нажатие кнопки, свойство <xref:System.Windows.Controls.Primitives.ButtonBase.Command> которой привязано к одной из этих команд, будут работать. Стандартное копирование и вырезание с помощью сочетания клавиш или контекстного меню будет работать как до введения режима частичного доверия. | Свяжите команды <xref:System.Windows.Input.ApplicationCommands.Copy> или <xref:System.Windows.Input.ApplicationCommands.Cut> с действием, инициированным пользователем, например нажатием кнопки. |

### <a name="graphics"></a>Графика

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Controls>, <xref:System.Windows.Data>, <xref:System.Windows.Input>, <xref:System.Windows.Media.Effects>; сборки: PresentationFramework (в PresentationFramework.dll), PresentationCore (в PresentationCore.dll), WindowsBase (в WindowsBase.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Эффекты для точечных рисунков** | В целях повышения производительности класс <xref:System.Windows.Media.Effects.BitmapEffect> и классы, наследующие от класса <xref:System.Windows.Media.Effects.BitmapEffect>, отключены, хотя формально присутствуют. Эффект будет отрисовываться с помощью конвейера отрисовки с аппаратным ускорением, если выполняются указанные ниже условия.<br><br>* Приложение использует <xref:System.Windows.Media.Effects.DropShadowBitmapEffect> или <xref:System.Windows.Media.Effects.BlurBitmapEffect> со свойством радиуса, имеющим значение менее 100 DIU.<br>* Видеоадаптер компьютера, на котором работает приложение, поддерживает построитель текстуры 2.0.<br><br>Если перечисленные условия не удовлетворяются, объект <xref:System.Windows.Media.Effects.BitmapEffect> не произведет какого-либо действия.<br><br>Кроме того, Visual Studio создаст предупреждение компилятора при обнаружении объекта <xref:System.Windows.Media.Effects.BitmapEffect> или его подкласса.<br><br>Метод <xref:System.Windows.Media.DrawingContext.PushEffect%2A> помечен как устаревший. | Прекратите использование устаревшего класса <xref:System.Windows.Media.Effects.BitmapEffect> и его производных классов и воспользуйтесь новыми классами, производными от <xref:System.Windows.Media.Effects.Effect>: <xref:System.Windows.Media.Effects.BlurEffect>, <xref:System.Windows.Media.Effects.DropShadowEffect> и <xref:System.Windows.Media.Effects.ShaderEffect>.<br><br>Кроме того, вы можете создавать собственные эффекты, наследуя от класса <xref:System.Windows.Media.Effects.ShaderEffect>. |
| **Кадры растрового изображения** | Клонированные объекты <xref:System.Windows.Media.Imaging.BitmapFrame> теперь получают события <xref:System.Windows.Media.Imaging.BitmapSource.DownloadProgress>, <xref:System.Windows.Media.Imaging.BitmapSource.DownloadCompleted> и <xref:System.Windows.Media.Imaging.BitmapSource.DownloadFailed>. Это обеспечивает корректную работу для изображений, скачиваемых из Интернета и применяемых к элементу управления <xref:System.Windows.Controls.Image> с помощью класса <xref:System.Windows.Style>.<br><br>Изменение поведения будет заметно только в том случае, если все следующие утверждения истинны:<br><br>* имеется подписка на событие <xref:System.Windows.Media.Imaging.BitmapSource.DownloadProgress>, <xref:System.Windows.Media.Imaging.BitmapSource.DownloadCompleted> или <xref:System.Windows.Media.Imaging.BitmapSource.DownloadFailed>;<br>* источником <xref:System.Windows.Media.Imaging.BitmapFrame> является Интернет;<br>* объект <xref:System.Windows.Media.Imaging.BitmapFrame> клонирован, когда скачивание еще выполняется. | Проверьте отправителя в обработчике событий и выполните действие, только если отправителем является исходный объект <xref:System.Windows.Media.Imaging.BitmapFrame>. |
| **Декодирование изображений** | Чтобы обеспечить обязательную обработку исключения <xref:System.IO.IOException> при невозможности декодировать изображение, класс <xref:System.Windows.Media.Imaging.BitmapSource> создает событие <xref:System.Windows.Media.Imaging.BitmapSource.DecodeFailed>, когда не удается декодировать изображение. | Удалите обработку исключений для <xref:System.IO.IOException> и используйте событие <xref:System.Windows.Media.Imaging.BitmapSource.DecodeFailed> для обнаружения ошибок при декодировании. |

### <a name="input"></a>Входные данные

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Controls>, <xref:System.Windows.Data>, <xref:System.Windows.Input>; сборки: PresentationFramework (в PresentationFramework.dll), PresentationCore (в PresentationCore.dll), WindowsBase (в WindowsBase.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Привязка экземпляров команд** | Чтобы предоставить механизм для привязки экземпляров команд на основе модели представления к действиям ввода на основе представления, класс <xref:System.Windows.Input.InputBinding> теперь наследует от класса <xref:System.Windows.Freezable> вместо класса <xref:System.Windows.DependencyObject>. Перечисленные ниже свойства теперь являются свойствами зависимостей.<br><br>* <xref:System.Windows.Input.InputBinding.Command><br>* <xref:System.Windows.Input.InputBinding.CommandParameter><br>* <xref:System.Windows.Input.InputBinding.CommandTarget><br><br>Это изменение имеет указанные ниже последствия.<br><br>* Объект <xref:System.Windows.Input.InputBinding> теперь фиксируется после регистрации, вместо того чтобы оставаться изменяемым.<br>* Отсутствует доступ к объектам <xref:System.Windows.Input.InputBinding> на уровне экземпляра из нескольких потоков в связи с ограничениями класса <xref:System.Windows.DependencyObject>.<br>* Нельзя изменять привязки ввода на уровне класса после их регистрации в связи с ограничениями класса <xref:System.Windows.Freezable>.<br>* Нельзя задавать привязки ввода для экземпляров команд, созданных в модели представления. | Создайте отдельные экземпляры класса <xref:System.Windows.Input.InputBinding> в отдельных потоках, если привязки должны быть изменяемыми, или фиксируйте их в противном случае. Не изменяйте статическую привязку <xref:System.Windows.Input.InputBinding> уровня класса после того, как она зарегистрирована. |
| **Приложения для браузеров** | WPF-приложения для браузера (XBAP) теперь обрабатывают ключевые события как отдельные приложения WPF, поэтому объекты получают перенаправляемые ключевые события в правильном порядке. | Отсутствует. |
| **Неработающие сочетания клавиш** | WPF не показывает неработающие клавиши, которые не производят видимых символов, но указывает, что для создания символа эту клавишу следует нажать вместе со следующей буквенной клавишей. События ввода с клавиатуры, например событие <xref:System.Windows.Input.Keyboard.KeyDownEvent>, сообщают, когда клавиша является нерабочей, задавая для свойства <xref:System.Windows.Input.KeyEventArgs.Key> значение <xref:System.Windows.Input.Key>. Как правило, это ожидаемое поведение, так как в приложениях обычно не предусмотрена реакция на ввод с клавиатуры, создающий комбинированный символ. | Приложения, которые должны считывать клавиши, бывшие частью комбинированных символов, могут получить скрытую клавишу, используя свойство <xref:System.Windows.Input.KeyEventArgs.DeadCharProcessedKey>. |
| **Диспетчер фокуса** | Когда в метод <xref:System.Windows.Input.FocusManager.GetFocusedElement(System.Windows.DependencyObject)?displayProperty=nameWithType> передается элемент, имеющий присоединенное свойство [IsFocusScope](xref:System.Windows.Input.FocusManager.IsFocusScope%2A) со значением `true`, этот метод возвращает последний элемент, на котором находился фокус клавиатуры в пределах этой области фокуса, тогда и только тогда, когда возвращаемый элемент принадлежит тому же объекту <xref:System.Windows.PresentationSource>, что и элемент, переданный в метод. | Отсутствует. |

### <a name="ui-automation"></a>Автоматизация пользовательского интерфейса

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Automation.Peers>, <xref:System.Windows.Automation.Provider>, <xref:System.Windows.Controls>, <xref:System.Windows.Data>, <xref:System.Windows.Input>; сборки: PresentationFramework (в PresentationFramework.dll), PresentationCore (в PresentationCore.dll), UIAutomationProvider (в UIAutomationProvider.dll), WindowsBase (в WindowsBase.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Иерархия классов представлений** | Классы <xref:System.Windows.Automation.Peers.TreeViewAutomationPeer> и <xref:System.Windows.Automation.Peers.TreeViewItemAutomationPeer> наследуются от <xref:System.Windows.Automation.Peers.ItemsControlAutomationPeer>, а не от <xref:System.Windows.Automation.Peers.FrameworkElementAutomationPeer>. | Если наследование производится от классов <xref:System.Windows.Automation.Peers.TreeViewItemAutomationPeer> и метод <xref:System.Windows.Automation.Peers.TreeViewItemAutomationPeer.GetChildrenCore%2A> переопределяется, рассмотрите возможность возврата объекта, который наследуется от нового класса <xref:System.Windows.Automation.Peers.TreeViewDataItemAutomationPeer>. |
| **Контейнеры вне экрана** | Для исправления неправильно возвращаемого значения метод <xref:System.Windows.Automation.Peers.UIElementAutomationPeer.IsOffscreenCore%2A> теперь корректно возвращает значение `false` для контейнеров элементов, которые при прокрутке находятся вне области видимости. Кроме того, на значение метода не влияют помехи со стороны других окон или видимость элемента на определенном мониторе. | Отсутствует. |
| **Меню и дочерние объекты** | Чтобы обеспечить автоматизацию пользовательского интерфейса для меню, содержащих дочерние объекты, отличные от объектов <xref:System.Windows.Controls.MenuItem>, метод <xref:System.Windows.Automation.Peers.MenuItemAutomationPeer.GetChildrenCore%2A> теперь возвращает объект <xref:System.Windows.Automation.Peers.AutomationPeer> дочернего объекта <xref:System.Windows.UIElement> вместо объекта <xref:System.Windows.Automation.Peers.MenuItemAutomationPeer>. | Отсутствует. |
| **Новые интерфейсы и сборка** | Чтобы обеспечить работу новых функций автоматизации пользовательского интерфейса, были добавлены следующие интерфейсы:<br><br>* <xref:System.Windows.Automation.Provider.IItemContainerProvider><br>* <xref:System.Windows.Automation.Provider.ISynchronizedInputProvider><br>* <xref:System.Windows.Automation.Provider.IVirtualizedItemProvider> | В любой проект, в котором выполняется сборка одноранговых классов автоматизации WPF, должна быть добавлена явная ссылка на файл UIAutomationProvider.dll. |
| **Бегунки** | Метод <xref:System.Windows.Automation.Peers.ThumbAutomationPeer.GetClassNameCore%2A> возвращает значение вместо NULL. Поэтому такие элементы управления, как <xref:System.Windows.Controls.GridSplitter>, наследующие от класса <xref:System.Windows.Controls.Primitives.Thumb>, будут передавать имя в модель автоматизации пользовательского интерфейса. | Отсутствует. |
| **Виртуальные элементы** | Для повышения производительности метод <xref:System.Windows.Automation.Peers.UIElementAutomationPeer.GetChildrenCore%2A> возвращает только дочерние объекты, действительно присутствующие в визуальном дереве, вместо всех дочерних объектов независимо от того, являются ли они виртуальными. | Используйте класс <xref:System.Windows.Automation.ItemContainerPattern> для перебора всех элементов объекта <xref:System.Windows.Automation.Peers.ItemsControlAutomationPeer>. |

### <a name="xaml"></a>XAML

Пространства имен: <xref:System.Windows>, <xref:System.Windows.Controls>, <xref:System.Windows.Data>, <xref:System.Windows.Input>, <xref:System.Windows.Markup>; сборки: PresentationFramework (в PresentationFramework.dll), PresentationCore (в PresentationCore.dll), WindowsBase (в WindowsBase.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) | Рекомендованные изменения |
| ------- | ------------------------ | ------------------- |
| **Расширение разметки** | WPF теперь всегда правильно использует значение из метода <xref:System.Windows.Markup.MarkupExtension.ProvideValue%2A> вместо возврата объекта <xref:System.Windows.Markup.MarkupExtension> в некоторых случаях, когда расширение разметки используется для задания свойства или для создания элемента в коллекции. В некоторых случаях расширение разметки может возвращать себя. | Если ваше приложение обращается к ресурсу, возвращавшему в более ранних версиях объект <xref:System.Windows.Markup.MarkupExtension>, создайте ссылку на объект, возвращаемый из метода <xref:System.Windows.Markup.MarkupExtension.ProvideValue%2A>, вместо объекта <xref:System.Windows.Markup.MarkupExtension>. |
| **Разбор атрибутов** | Атрибуты в языке XAML теперь могут иметь только одну точку. Примеры допустимых строк:<br><br>`<Button Background="Red"/>` (точек нет)<br><br>`<Button Button.Background = "Red"/>` (одна точка)<br><br>Пример строки, ставшей недопустимой:<br><br>`<Button Control.Button.Background = "Red"/>` (более одной точки) | Исправьте атрибуты XAML, содержащие более одной точки. |

## <a name="xml"></a>XML

В приведенной ниже таблице описаны усовершенствования функций, с которыми ранее были связаны ограничения или другие проблемы.

### <a name="schema-and-transforms"></a>Схема и преобразования

Пространства имен: <xref:System.Xml.Linq>, <xref:System.Xml.Schema>, <xref:System.Xml.XPath>; сборки: System.Xml (в System.Xml.dll), System.Xml.Linq (в System.Xml.Linq.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Схемы-хамелеоны** | Чтобы предотвратить повреждение данных, схемы-хамелеоны теперь правильно клонируются, когда добавляются с несколькими схемами.<br><br>Схемы-хамелеоны — это схемы, не имеющие целевого пространства имен. Когда они включаются в другой XSD-файл, они принимают целевое пространство имен схемы, в которую они импортируются. Часто они используются для включения в схему распространенных типов. |
| **Функции ID** | [Функция id](/sql/xquery/functions-on-sequences-id) XSLT теперь возвращает правильное значение вместо NULL при передаче объекта <xref:System.Xml.XmlReader> в XLST.<br><br>Если пользователь создавал объект <xref:System.Xml.XmlReader> из класса LINQ to XML с помощью метода <xref:System.Xml.Linq.XNode.CreateReader%2A> и этот объект <xref:System.Xml.XmlReader> был передан в XSLT, все экземпляры функции `id` в XSLT ранее возвращали NULL. Для функции `id` это не является разрешенным возвращаемым значением. |
| **Атрибут пространства имен** | Во избежание повреждения данных объект <xref:System.Xml.XPath.XPathNavigator> теперь возвращает локальное имя атрибута `x:xmlns` правильно. |
| **Объявления пространств имен** | Объект <xref:System.Xml.XmlReader> в поддереве больше не создает дублирующиеся объявления пространства имен в одном XML-элементе. |
| **Проверка схемы** | Чтобы избежать ошибочной проверки схемы, класс <xref:System.Xml.Schema.XmlSchemaSet> обеспечивает корректную и непротиворечивую компиляцию схем XSD. Схемы могут включать в себя другие схемы. Например, `A.xsd` может включать схему `B.xsd`, которая может включать `C.xsd`. Компиляция любой из указанных схем приводит к обходу этого графа зависимостей. |
| **Функции скрипта** | [Функция function-available](https://msdn.microsoft.com/library/ms256124(v=vs.110).aspx) больше не возвращает неправильное значение `false`, когда функция на самом деле доступна. |
| **Универсальные коды ресурсов (URI)** | Метод <xref:System.Xml.Linq.XElement.Load%2A> теперь возвращает правильный код BaseURI в запросах LINQ. |

### <a name="validation"></a>Проверка

Пространства имен: <xref:System.Xml.Linq>, <xref:System.Xml.Schema>, <xref:System.Xml.XPath>; сборки: System.Xml (в System.Xml.dll), System.Xml.Linq (в System.Xml.Linq.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Сопоставители пространств имен** | Метод <xref:System.Xml.XmlReader.ReadContentAs%2A> больше не игнорирует переданный ему сопоставитель <xref:System.Xml.IXmlNamespaceResolver>.<br><br>В более ранних версиях указанный сопоставитель пространств имен игнорировался; вместо него использовался <xref:System.Xml.XmlReader>. |
| **Пробел** | Для предотвращения потери данных при создании средства чтения метод <xref:System.Xml.XmlReader.Create%2A> больше не отбрасывает имеющий значение пробел.<br><br>Проверка XML распознает режим смешанного содержимого, когда текст может идти вперемешку с XML-разметкой. В смешанном режиме все пробелы являются значимыми и должны приниматься во внимание. |

### <a name="writing"></a>Запись

Пространства имен: <xref:System.Xml.Linq>, <xref:System.Xml.Schema>, <xref:System.Xml.XPath>; сборки: System.Xml (в System.Xml.dll), System.Xml.Linq (в System.Xml.Linq.dll)

| Функция | Отличия от версии 3.5 с пакетом обновления 1 (SP1) |
| ------- | ------------------------ |
| **Ссылки на сущности** | Во избежание повреждения данных ссылки на сущности больше не преобразуются дважды в атрибутах XML.<br><br>Если пользователь пытался записать сущность в атрибут `xmlns` либо в атрибут `xml:lang` или `xml:space` с помощью метода <xref:System.Xml.XmlWriter.WriteEntityRef%2A>, на выходе сущность преобразовывалась дважды, что приводило к повреждению данных. |
| **Обработка новых строк** | Во избежание повреждения данных объекты <xref:System.Xml.XmlWriter> учитывают параметр <xref:System.Xml.NewLineHandling>. |

## <a name="see-also"></a>См. также

- [Новые типы и члены в .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ff641764%28v=vs.100%29)
- [Руководство по миграции на .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ff657133%28v=vs.100%29)
- [Новые возможности .NET Framework 4](https://docs.microsoft.com/previous-versions/dotnet/netframework-4.0/ms171868%28v=vs.100%29)
- [Совместимость версий в .NET Framework](version-compatibility.md)
- [Перенос решений Office на платформу .NET Framework 4](/visualstudio/vsto/migrating-office-solutions-to-the-dotnet-framework-4-or-later)
- [Устаревшие классы библиотеки классов .NET Framework](../whats-new/whats-obsolete.md)
