---
title: WSTrustChannelFactory и WSTrustChannel
ms.date: 03/30/2017
ms.assetid: 96cec467-e963-4132-b18b-7d0b3a2e979f
author: BrucePerlerMS
ms.openlocfilehash: ecc62292b2b064219127c369f43141a31ffe606d
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "61780072"
---
# <a name="wstrustchannelfactory-and-wstrustchannel"></a>WSTrustChannelFactory и WSTrustChannel
Если вы уже знакомы с платформой Windows Communication Foundation (WCF), значит вам также известно, что клиент WCF уже включает возможности федерации. Путем настройки клиента WCF с привязкой <xref:System.ServiceModel.WSFederationHttpBinding> или аналогичной пользовательской привязкой можно включить федеративную проверку подлинности для службы.

 WCF получает токен, скрытно выданный службой маркеров безопасности (STS), и использует его в целях проверки подлинности в службе. Единственным ограничением при таком подходе является отсутствие возможности отслеживать взаимодействие клиента с сервером. WCF автоматически создает токен безопасности запроса для службы STS на основе параметров выданного токена в привязке. Это означает, что клиент не может изменять параметры токена безопасности запроса для каждого запроса, проверять ответ токена безопасности запроса для получения таких сведений, как отображаемые утверждения, или кэшировать токен для последующего использования.

 В настоящее время клиент WCF способен выполнять основные сценарии федерации. Тем не менее один из основных сценариев, поддерживаемых Windows Identity Foundation (WIF), подразумевает контроль над токеном безопасности запроса на уровне, на котором WCF не позволяет легко осуществлять его. По этой причине в WIF добавлены функции, обеспечивающие более тщательный контроль над взаимодействием со службой STS.

 WIF поддерживает следующие сценарии федерации:

- использование клиента WCF без зависимостей WIF в целях проверки подлинности в федеративной службе;

- включение WIF в клиенте WCF для вставки элемента ActAs или OnBehalfOf в токен безопасности запроса для службы STS;

- использование WIF для получения токена от службы STS и настройки клиента WCF для проверки подлинности с данным токеном. Дополнительные сведения см. в описании примера [ClaimsAwareWebService](https://go.microsoft.com/fwlink/?LinkID=248406).

 Первый вариант — говорит само за себя: Существующие клиенты WCF будут продолжать работать с проверяющими сторонами WIF и серверами службы токенов безопасности. В данном же разделе рассматриваются два других сценария.

## <a name="enhancing-an-existing-wcf-client-with-actas--onbehalfof"></a>Расширение возможностей существующего клиента WCF за счет элементов ActAs и OnBehalfOf
В типичном сценарии делегирования удостоверения клиент обращается к службе среднего уровня, которая, в свою очередь, обращается к серверной службе. Служба среднего уровня действует в качестве клиента или от его лица.

> [!TIP]
> В чем различие между ActAs и OnBehalfOf?
>
> С точки зрения протокола WS-Trust:
>
> 1. Элемент токена безопасности запроса ActAs указывает, что запрашивающей стороне необходим токен, содержащий утверждения о двух различных объектах: о запрашивающей стороне и внешнем объекте, представленном токеном в элементе ActAs.
> 2. Элемент токена безопасности запроса OnBehalfOf указывает, что запрашивающей стороне необходим токен, содержащий утверждения только об одном объекте: о внешнем объекте, представленном токеном в элементе OnBehalfOf.
>
> Функция ActAs обычно используется в сценариях с комплексным делегированием, в которых окончательный получатель выпущенного токена может изучить всю цепочку делегирования и получить сведения не только о клиенте, но и о всех посредниках. Это позволяет осуществлять управление доступом, проводить аудит и выполнять ряд других задач на основе всей цепочки делегирования удостоверений. Функция ActAs обычно используется в многоуровневых системах для проверки подлинности и передачи сведений об удостоверениях между уровнями без отправки этих сведений на уровень приложения или бизнес-логики.
>
> Функция OnBehalfOf используется в тех сценариях, где необходимо только удостоверение исходного клиента; эта функция фактически эквивалентна олицетворению удостоверения в Windows. При использовании функции OnBehalfOf окончательный получатель выпущенного токена видит только утверждения об исходном клиенте, а сведения о посредниках не сохраняются. Одним из основных шаблонов использования функции OnBehalfOf является шаблон прокси-сервера, при котором клиент получает доступ к службе STS не напрямую, а через прокси-шлюз. Прокси-шлюз выполняет проверку подлинности вызывающей стороны и вносит сведения о ней в элемент OnBehalfOf сообщения токена безопасности запроса, который затем отправляется на обработку в службу STS. Итоговый токен содержит только утверждения, связанные с клиентом прокси-сервера, поэтому прокси-сервер абсолютно прозрачен для получателя выпущенного маркера. Обратите внимание на то, что WIF не поддерживает \<wsse:SecurityTokenReference> и \<wsa:EndpointReferences> в качестве дочерних элементов \<wst:OnBehalfOf>. В спецификации WS-Trust предусмотрено три способа идентификации исходной запрашивающей стороны (от имени которой действует прокси-сервер). Эти особые значения приведены ниже.
>
> - Ссылка на токен безопасности. Ссылка на токен, полученная из сообщения или извлеченная из потока данных).
> - Ссылка на конечную точку. Используется в качестве ключа для поиска данных в потоке данных.
> - Токен безопасности. Непосредственно идентифицирует запрашивающую сторону.
>
> WIF поддерживает только маркеры безопасности, как зашифрованные, так и незашифрованные, в качестве непосредственного дочернего элемента \<wst:OnBehalfOf>.

 Эти данные передаются издателю WS-Trust с использованием элементов токена ActAs и OnBehalfOf в токене безопасности запроса.

 WCF предоставляет точку расширяемости в привязке, которая позволяет добавлять произвольные XML-элементы в токен безопасности запроса. Однако в связи с тем, что точка расширяемости соединена с привязкой, в сценариях, в которых необходимо различное содержимое токена безопасности запроса для различных вызовов, клиент должен заново создаваться для каждого вызова, что приводит к снижению производительности. WIF использует методы расширения класса `ChannelFactory`, которые позволяют разработчикам добавлять любые токены, полученные из потока данных, к токену безопасности запроса. В приведенном ниже примере кода показано, как получить токен, представляющий клиент (например, X.509, имя пользователя или токен SAML), и присоединить его к токену безопасности запроса, который отправляется издателю.

```csharp
IHelloService serviceChannel = channelFactory.CreateChannelActingAs<IHelloService>(clientSamlToken);
serviceChannel.Hello("Hi!");
```

 WIF предоставляет указанные ниже преимущества.

- Токен безопасности запроса может быть изменен для отдельного канала; поэтому службам среднего уровня больше не требуется заново создавать фабрику каналов для каждого клиента, что способствует увеличению производительности.

- Эта платформа работает с клиентами WCF, что позволяет без труда обновлять существующие службы среднего уровня WCF, обеспечивающие семантику делегирования удостоверений.

 Однако возможность отслеживать взаимодействие клиента со службой STS по-прежнему отсутствует. В третьем сценарии этот вопрос будет рассмотрен подробно.

## <a name="communicating-directly-with-an-issuer-and-using-the-issued-token-to-authenticate"></a>Непосредственная связь с издателем и использование выданного токена для проверки подлинности
Для некоторых более сложных сценариев недостаточно простого расширения клиента WCF. Разработчики, работающие только с WCF, как правило, используют контракты Message In/Message Out и вручную обеспечивают анализ ответа издателя на стороне клиента.

В WIF добавлены классы <xref:System.ServiceModel.Security.WSTrustChannelFactory> и <xref:System.ServiceModel.Security.WSTrustChannel>, позволяющие клиенту обращаться непосредственно к издателю WS-Trust. Классы <xref:System.ServiceModel.Security.WSTrustChannelFactory> и <xref:System.ServiceModel.Security.WSTrustChannel> позволяют строго типизированным объектам токена безопасности запроса и ответа токена безопасности запроса передаваться между клиентом и издателем, как показано в приведенном ниже примере кода.

```csharp
WSTrustChannelFactory trustChannelFactory = new WSTrustChannelFactory(stsBinding, stsAddress);
WSTrustChannel channel = (WSTrustChannel) trustChannelFactory.CreateChannel();
RequestSecurityToken rst = new RequestSecurityToken(RequestTypes.Issue);
rst.AppliesTo = new EndpointAddress(serviceAddress);
RequestSecurityTokenResponse rstr = null;
SecurityToken token = channel.Issue(rst, out rstr);
```

Обратите внимание, что параметр `out` в методе <xref:System.ServiceModel.Security.WSTrustChannel.Issue%2A> разрешает доступ к ответу токена безопасности запроса для проверки на стороне клиента.

На данный момент вы видели только как для получения маркера. Токен, возвращаемый из объекта <xref:System.ServiceModel.Security.WSTrustChannel>, представляет собой токен `GenericXmlSecurityToken`, содержащий все данные, необходимые для проверки подлинности проверяющей стороной. В приведенном ниже примере кода показано, как используется этот токен.

```csharp
IHelloService serviceChannel = channelFactory.CreateChannelWithIssuedToken<IHelloService>( token );
serviceChannel.Hello("Hi!");
```

Метод расширения <xref:System.ServiceModel.ChannelFactory%601.CreateChannelWithIssuedToken%2A> в объекте `ChannelFactory` сообщает WIF о том, что получен токен без привязки, а также о том, что необходимо завершить обычный вызов WCF издателя и вместо этого использовать полученный токен в целях проверки подлинности проверяющей стороной. Такой подход имеет следующие преимущества:

- полный контроль над процессом выдачи токенов;

- поддержка использования ActAs и OnBehalfOf путем непосредственной настройки этих свойств в исходящем токене безопасности запроса;

- возможность динамического принятия решений о доверии на стороне клиента с учетом содержимого в ответе токена безопасности запроса;

- возможность кэширования и повторного использования токена, возвращенного методом <xref:System.ServiceModel.Security.WSTrustChannel.Issue%2A>;

- возможность использования <xref:System.ServiceModel.Security.WSTrustChannelFactory> и <xref:System.ServiceModel.Security.WSTrustChannel> для управления кэшированием канала, ошибками и семантикой восстановления в соответствии с рекомендациями WCF.

## <a name="see-also"></a>См. также

- [Возможности WIF](../../../docs/framework/security/wif-features.md)