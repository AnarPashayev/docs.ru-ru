---
title: Защита правил кодирования для неуправляемого кода
ms.date: 03/30/2017
helpviewer_keywords:
- code security, unmanaged code
- unmanaged code, securing
- security [.NET Framework], unmanaged code
- secure coding, unmanaged code
ms.assetid: a8d15139-d368-4c9c-a747-ba757781117c
author: mairaw
ms.author: mairaw
ms.openlocfilehash: 867157b329218b79c8cc1255b2158bbe83666531
ms.sourcegitcommit: 289e06e904b72f34ac717dbcc5074239b977e707
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/17/2019
ms.locfileid: "71045367"
---
# <a name="secure-coding-guidelines-for-unmanaged-code"></a><span data-ttu-id="b775e-102">Защита правил кодирования для неуправляемого кода</span><span class="sxs-lookup"><span data-stu-id="b775e-102">Secure Coding Guidelines for Unmanaged Code</span></span>
<span data-ttu-id="b775e-103">Части библиотечного кода необходимо осуществлять вызовы неуправляемого кода (например, интерфейсов API машинного кода, таких как Win32).</span><span class="sxs-lookup"><span data-stu-id="b775e-103">Some library code needs to call into unmanaged code (for example, native code APIs, such as Win32).</span></span> <span data-ttu-id="b775e-104">Так как при этом не работает система безопасности управляемого кода, необходимо соблюдать соответствующие меры предосторожности.</span><span class="sxs-lookup"><span data-stu-id="b775e-104">Because this means going outside the security perimeter for managed code, due caution is required.</span></span> <span data-ttu-id="b775e-105">Если код является нейтральным с точки зрения безопасности, то он, как и любой вызывающий его код, должен иметь разрешение неуправляемого кода (<xref:System.Security.Permissions.SecurityPermission> с указанием флага <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> ).</span><span class="sxs-lookup"><span data-stu-id="b775e-105">If your code is security-neutral, both your code and any code that calls it must have unmanaged code permission (<xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> flag specified).</span></span>  
  
 <span data-ttu-id="b775e-106">Однако часто нецелесообразно предоставлять вызывающему коду столь широкие полномочия.</span><span class="sxs-lookup"><span data-stu-id="b775e-106">However, it is often unreasonable for your caller to have such powerful permissions.</span></span> <span data-ttu-id="b775e-107">В этих случаях доверенный код может выступать в качестве посредника, аналогично управляемой оболочке или библиотечному коду, описанному в разделе [Безопасность кода программы-оболочки](../misc/securing-wrapper-code.md).</span><span class="sxs-lookup"><span data-stu-id="b775e-107">In such cases, your trusted code can be the go-between, similar to the managed wrapper or library code described in [Securing Wrapper Code](../misc/securing-wrapper-code.md).</span></span> <span data-ttu-id="b775e-108">Если базовая функциональность неуправляемого кода полностью безопасна, к нему можно предоставить прямой доступ. В противном случае сначала нужно осуществить проверку безопасности (требование).</span><span class="sxs-lookup"><span data-stu-id="b775e-108">If the underlying unmanaged code functionality is totally safe, it can be directly exposed; otherwise, a suitable permission check (demand) is required first.</span></span>  
  
 <span data-ttu-id="b775e-109">Если код вызывает неуправляемый код, но не требует разрешений от вызывающих объектов на доступ к неуправляемому коду, необходимо утвердить эти права.</span><span class="sxs-lookup"><span data-stu-id="b775e-109">When your code calls into unmanaged code but you do not want to require your callers to have permission to access unmanaged code, you must assert that right.</span></span> <span data-ttu-id="b775e-110">Такое утверждение блокирует обход стека в кадре.</span><span class="sxs-lookup"><span data-stu-id="b775e-110">An assertion blocks the stack walk at your frame.</span></span> <span data-ttu-id="b775e-111">Будьте внимательны, чтобы при этом не создать брешь в системе безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-111">You must be careful that you do not create a security hole in this process.</span></span> <span data-ttu-id="b775e-112">Обычно это означает, что необходимо затребовать соответствующее разрешение у вызывающих объектов, а затем использовать неуправляемый код для выполнения исключительно тех действий, на которые у вызывающего объекта есть разрешение.</span><span class="sxs-lookup"><span data-stu-id="b775e-112">Usually, this means that you must demand a suitable permission of your callers and then use unmanaged code to perform only what that permission allows and no more.</span></span> <span data-ttu-id="b775e-113">В некоторых случаях (например, для функции запроса текущего времени) можно предоставлять вызывающим объектам прямой доступ к неуправляемому коду без использования каких-либо проверок безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-113">In some cases (for example, a get time-of-day function), unmanaged code can be directly exposed to callers without any security checks.</span></span> <span data-ttu-id="b775e-114">В любом случае код, использующий приведенный выше способ, должен отвечать за обеспечение безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-114">In any case, any code that asserts must take responsibility for security.</span></span>  
  
 <span data-ttu-id="b775e-115">Так как любой управляемый код, который предоставляет доступ к машинному коду, является потенциальной мишенью для атаки со стороны вредоносного кода, определение того, какой неуправляемый код можно безопасно использовать и каким именно образом, требует внимательнейшего отношения.</span><span class="sxs-lookup"><span data-stu-id="b775e-115">Because any managed code that provides a code path into native code is a potential target for malicious code, determining which unmanaged code can be safely used and how it must be used requires extreme care.</span></span> <span data-ttu-id="b775e-116">В целом, никогда не следует предоставлять прямой доступ к неуправляемому коду частично доверенным вызывающим объектам.</span><span class="sxs-lookup"><span data-stu-id="b775e-116">Generally, unmanaged code should never be directly exposed to partially trusted callers.</span></span> <span data-ttu-id="b775e-117">Существуют два основных аспекта при рассмотрении безопасности использования неуправляемого кода в библиотеках, которые могут вызываться частично доверенным кодом.</span><span class="sxs-lookup"><span data-stu-id="b775e-117">There are two primary considerations in evaluating the safety of unmanaged code use in libraries that are callable by partially trusted code:</span></span>  
  
- <span data-ttu-id="b775e-118">**Функциональность**.</span><span class="sxs-lookup"><span data-stu-id="b775e-118">**Functionality**.</span></span> <span data-ttu-id="b775e-119">Обеспечивает ли неуправляемый API безопасную функциональность, которая не позволяет вызывающим объектам осуществлять потенциально небезопасные операции?</span><span class="sxs-lookup"><span data-stu-id="b775e-119">Does the unmanaged API provide functionality that does not allow callers to perform potentially dangerous operations?</span></span> <span data-ttu-id="b775e-120">Управление доступом для кода использует разрешения для доступа к ресурсам, поэтому следует проверить, использует ли API файлы, пользовательский интерфейс, потоки или что-либо еще, позволяющее получить доступ к защищенной информации.</span><span class="sxs-lookup"><span data-stu-id="b775e-120">Code access security uses permissions to enforce access to resources, so consider whether the API uses files, a user interface, or threading, or whether it exposes protected information.</span></span> <span data-ttu-id="b775e-121">Если это происходит, управляемый код, который является оболочкой для рассматриваемого API, должен требовать необходимые разрешения.</span><span class="sxs-lookup"><span data-stu-id="b775e-121">If it does, the managed code wrapping it must demand the necessary permissions before allowing it to be entered.</span></span> <span data-ttu-id="b775e-122">Кроме того, доступ к памяти должен быть типобезопасным, хотя и отсутствует защита с использованием разрешений.</span><span class="sxs-lookup"><span data-stu-id="b775e-122">Additionally, while not protected by a permission, memory access must be confined to strict type safety.</span></span>  
  
- <span data-ttu-id="b775e-123">**Проверка параметров**.</span><span class="sxs-lookup"><span data-stu-id="b775e-123">**Parameter checking**.</span></span> <span data-ttu-id="b775e-124">Часто используемым способом атаки является передача неожиданных значений параметров методам API, реализованным в виде неуправляемого кода, с целью вызвать их функционирование непредусмотренным образом.</span><span class="sxs-lookup"><span data-stu-id="b775e-124">A common attack passes unexpected parameters to exposed unmanaged code API methods in an attempt to cause them to operate out of specification.</span></span> <span data-ttu-id="b775e-125">Переполнение буфера с помощью значения индекса или смещения вне допустимого диапазона — типичный пример такого рода атак, наряду с применением параметров, использующих ошибки в базовом коде.</span><span class="sxs-lookup"><span data-stu-id="b775e-125">Buffer overruns using out-of-range index or offset values are one common example of this type of attack, as are any parameters that might exploit a bug in the underlying code.</span></span> <span data-ttu-id="b775e-126">Таким образом, даже если интерфейс API, представляющий собой неуправляемый код, функционально безопасен (после выполнения всех необходимых требований) для частично доверенных вызывающих объектов, управляемый код должен также досконально проверять правильность параметров, чтобы гарантировать невозможность вызовов со стороны вредоносного кода, использующего оболочку управляемого кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-126">Thus, even if the unmanaged code API is functionally safe (after necessary demands) for partially trusted callers, managed code must also check parameter validity exhaustively to ensure that no unintended calls are possible from malicious code using the managed code wrapper layer.</span></span>  
  
## <a name="using-suppressunmanagedcodesecurityattribute"></a><span data-ttu-id="b775e-127">Использование атрибута SuppressUnmanagedCodeSecurityAttribute</span><span class="sxs-lookup"><span data-stu-id="b775e-127">Using SuppressUnmanagedCodeSecurityAttribute</span></span>  
 <span data-ttu-id="b775e-128">Использование утверждения и последующего вызова неуправляемого кода может влиять на производительность.</span><span class="sxs-lookup"><span data-stu-id="b775e-128">There is a performance aspect to asserting and then calling unmanaged code.</span></span> <span data-ttu-id="b775e-129">При каждом таком вызове система безопасности автоматически требует разрешение неуправляемого кода, что приводит каждый раз к обходу стека.</span><span class="sxs-lookup"><span data-stu-id="b775e-129">For every such call, the security system automatically demands unmanaged code permission, resulting in a stack walk each time.</span></span> <span data-ttu-id="b775e-130">Если используется утверждение и сразу же вызывается неуправляемый код, обход стека не имеет смысла: стек состоит из вашего утверждения и вызова неуправляемого кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-130">If you assert and immediately call unmanaged code, the stack walk can be meaningless: it consists of your assert and your unmanaged code call.</span></span>  
  
 <span data-ttu-id="b775e-131">К точкам входа неуправляемого кода можно применить настраиваемый атрибут <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> , чтобы отключить обычную проверку безопасности, которая требует указания разрешения <xref:System.Security.Permissions.SecurityPermission> с <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> .</span><span class="sxs-lookup"><span data-stu-id="b775e-131">A custom attribute called <xref:System.Security.SuppressUnmanagedCodeSecurityAttribute> can be applied to unmanaged code entry points to disable the normal security check that demands <xref:System.Security.Permissions.SecurityPermission> with the <xref:System.Security.Permissions.SecurityPermissionFlag.UnmanagedCode> permission specified.</span></span> <span data-ttu-id="b775e-132">При этом следует соблюдать особую осторожность, так как создается открытая точка доступа к неуправляемому коду, не предусматривающая проверок безопасности во время выполнения.</span><span class="sxs-lookup"><span data-stu-id="b775e-132">Extreme caution must always be taken when doing this, because this action creates an open door into unmanaged code with no runtime security checks.</span></span> <span data-ttu-id="b775e-133">Следует заметить, что даже если атрибут **SuppressUnmanagedCodeSecurityAttribute** указан, во время JIT-компиляции производится одноразовая проверка с целью подтверждения наличия у непосредственного вызывающего объекта прав вызова неуправляемого кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-133">It should be noted that even with **SuppressUnmanagedCodeSecurityAttribute** applied, there is a one-time security check that happens at just-in-time (JIT) compilation to ensure that the immediate caller has permission to call unmanaged code.</span></span>  
  
 <span data-ttu-id="b775e-134">При использовании атрибута **SuppressUnmanagedCodeSecurityAttribute**необходимо учесть указанные ниже моменты.</span><span class="sxs-lookup"><span data-stu-id="b775e-134">If you use the **SuppressUnmanagedCodeSecurityAttribute**, check the following points:</span></span>  
  
- <span data-ttu-id="b775e-135">Сделайте точку входа в неуправляемый код внутренней или иным образом недоступной извне вашего кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-135">Make the unmanaged code entry point internal or otherwise inaccessible outside your code.</span></span>  
  
- <span data-ttu-id="b775e-136">Любой вызов неуправляемого кода — это возможная брешь в системе безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-136">Any call into unmanaged code is a potential security hole.</span></span> <span data-ttu-id="b775e-137">Убедитесь в том, что ваш код не является лазейкой, через которую вредоносный код может косвенно вызывать неуправляемый код в обход проверки безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-137">Make sure your code is not a portal for malicious code to indirectly call into unmanaged code and avoid a security check.</span></span> <span data-ttu-id="b775e-138">Требуйте разрешения, когда это имеет смысл.</span><span class="sxs-lookup"><span data-stu-id="b775e-138">Demand permissions, if appropriate.</span></span>  
  
- <span data-ttu-id="b775e-139">Используйте соглашение об именовании для того, чтобы явным образом указывать создание небезопасного пути доступа к неуправляемому коду, как описано в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="b775e-139">Use a naming convention to explicitly identify when you are creating a dangerous path into unmanaged code, as described in the section below..</span></span>  
  
## <a name="naming-convention-for-unmanaged-code-methods"></a><span data-ttu-id="b775e-140">Соглашения об именовании для методов неуправляемого кода</span><span class="sxs-lookup"><span data-stu-id="b775e-140">Naming convention for unmanaged code methods</span></span>  
 <span data-ttu-id="b775e-141">Существуют установившиеся и весьма рекомендуемые к использованию соглашения об именовании методов неуправляемого кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-141">A useful and highly recommended convention has been established for naming unmanaged code methods.</span></span> <span data-ttu-id="b775e-142">Все методы неуправляемого кода разделяются на три категории: **safe**, **native**и **unsafe**.</span><span class="sxs-lookup"><span data-stu-id="b775e-142">All unmanaged code methods are separated into three categories: **safe**, **native**, and **unsafe**.</span></span> <span data-ttu-id="b775e-143">Эти ключевые слова можно использовать как имена классов, внутри которых определяются различные виды точек входа в неуправляемый код.</span><span class="sxs-lookup"><span data-stu-id="b775e-143">These keywords can be used as class names within which the various kinds of unmanaged code entry points are defined.</span></span> <span data-ttu-id="b775e-144">В исходном коде эти ключевые слова должны добавляться к именам классов, например `Safe.GetTimeOfDay`, `Native.Xyz`или `Unsafe.DangerousAPI`.</span><span class="sxs-lookup"><span data-stu-id="b775e-144">In source code, these keywords should be added to the class name, as in `Safe.GetTimeOfDay`, `Native.Xyz`, or `Unsafe.DangerousAPI`, for example.</span></span> <span data-ttu-id="b775e-145">Каждое из этих ключевых слов несет важную информацию для разработчиков, использующих данный класс, что раскрывается в таблице ниже.</span><span class="sxs-lookup"><span data-stu-id="b775e-145">Each of these keywords provides useful security information for developers using that class, as described in the following table.</span></span>  
  
|<span data-ttu-id="b775e-146">Ключевое слово</span><span class="sxs-lookup"><span data-stu-id="b775e-146">Keyword</span></span>|<span data-ttu-id="b775e-147">Замечания по безопасности</span><span class="sxs-lookup"><span data-stu-id="b775e-147">Security considerations</span></span>|  
|-------------|-----------------------------|  
|<span data-ttu-id="b775e-148">**safe**</span><span class="sxs-lookup"><span data-stu-id="b775e-148">**safe**</span></span>|<span data-ttu-id="b775e-149">Вызов полностью безопасен, даже если вызывающим объектом является вредоносный код.</span><span class="sxs-lookup"><span data-stu-id="b775e-149">Completely harmless for any code, even malicious code, to call.</span></span> <span data-ttu-id="b775e-150">Код может использоваться так же, как и любой управляемый код.</span><span class="sxs-lookup"><span data-stu-id="b775e-150">Can be used just like other managed code.</span></span> <span data-ttu-id="b775e-151">Например, функция, запрашивающая текущее время, обычно является безопасной.</span><span class="sxs-lookup"><span data-stu-id="b775e-151">For example, a function that gets the time of day is typically safe.</span></span>|  
|<span data-ttu-id="b775e-152">**native**</span><span class="sxs-lookup"><span data-stu-id="b775e-152">**native**</span></span>|<span data-ttu-id="b775e-153">Нейтральный с точки зрения безопасности, то есть неуправляемый код, который для вызова требует разрешение неуправляемого кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-153">Security-neutral; that is, unmanaged code that requires unmanaged code permission to call.</span></span> <span data-ttu-id="b775e-154">Осуществляется проверка безопасности, что предотвращает несанкционированный вызов кода.</span><span class="sxs-lookup"><span data-stu-id="b775e-154">Security is checked, which stops an unauthorized caller.</span></span>|  
|<span data-ttu-id="b775e-155">**unsafe**</span><span class="sxs-lookup"><span data-stu-id="b775e-155">**unsafe**</span></span>|<span data-ttu-id="b775e-156">Потенциально небезопасная точка входа в неуправляемый код с пониженным уровнем безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-156">Potentially dangerous unmanaged code entry point with security suppressed.</span></span> <span data-ttu-id="b775e-157">Разработчикам следует проявлять повышенную осторожность при использовании такого неуправляемого кода и всегда убеждаться в том, что включены другие механизмы защиты, позволяющие уменьшить уязвимость системы безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-157">Developers should use the greatest caution when using such unmanaged code, making sure that other protections are in place to prevent a security vulnerability.</span></span> <span data-ttu-id="b775e-158">Ответственность в этом случае несут разработчики, так как использование этого ключевого слова переопределяет систему безопасности.</span><span class="sxs-lookup"><span data-stu-id="b775e-158">Developers must be responsible, as this keyword overrides the security system.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="b775e-159">См. также</span><span class="sxs-lookup"><span data-stu-id="b775e-159">See also</span></span>

- [<span data-ttu-id="b775e-160">Правила написания безопасного кода</span><span class="sxs-lookup"><span data-stu-id="b775e-160">Secure Coding Guidelines</span></span>](../../standard/security/secure-coding-guidelines.md)
