---
title: Практическое руководство. Получение уведомлений о первом этапе обработки исключений
description: Получение уведомлений о первом этапе обработки исключений в .NET с использованием события FirstChanceException класса AppDomain до того, как общеязыковая среда выполнения начнет поиск обработчиков событий.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- first-chance exception notifications
- exceptions, first chance notifications
ms.assetid: 66f002b8-a97d-4a6e-a503-2cec01689113
ms.openlocfilehash: 0b3150a52a68e078d1052a9894bb652ad35027d0
ms.sourcegitcommit: bc293b14af795e0e999e3304dd40c0222cf2ffe4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2020
ms.locfileid: "96242569"
---
# <a name="how-to-receive-first-chance-exception-notifications"></a><span data-ttu-id="7935a-103">Практическое руководство. Получение уведомлений о первом этапе обработки исключений</span><span class="sxs-lookup"><span data-stu-id="7935a-103">How to: Receive First-Chance Exception Notifications</span></span>

<span data-ttu-id="7935a-104">Событие <xref:System.AppDomain.FirstChanceException> класса <xref:System.AppDomain> позволяет получать уведомления о порождении исключений до того, как среда CLR начнет искать обработчики исключений.</span><span class="sxs-lookup"><span data-stu-id="7935a-104">The <xref:System.AppDomain.FirstChanceException> event of the <xref:System.AppDomain> class lets you receive a notification that an exception has been thrown, before the common language runtime has begun searching for exception handlers.</span></span>

 <span data-ttu-id="7935a-105">Событие возникает на уровне домена приложения.</span><span class="sxs-lookup"><span data-stu-id="7935a-105">The event is raised at the application domain level.</span></span> <span data-ttu-id="7935a-106">Поток выполнения может проходить несколько доменов приложения, поэтому необработанное в одном домене исключение может быть обработано в другом домене.</span><span class="sxs-lookup"><span data-stu-id="7935a-106">A thread of execution can pass through multiple application domains, so an exception that is unhandled in one application domain could be handled in another application domain.</span></span> <span data-ttu-id="7935a-107">Уведомление происходит во всех доменах приложения, добавивших обработчик для этого события, пока исключение не будет обработано.</span><span class="sxs-lookup"><span data-stu-id="7935a-107">The notification occurs in each application domain that has added a handler for the event, until an application domain handles the exception.</span></span>

 <span data-ttu-id="7935a-108">Процедуры и примеры в этой статье демонстрируют, как можно получать уведомления о первичных исключениях в рамках простой программы с одним доменом приложения, а также в созданном пользователем домене приложения.</span><span class="sxs-lookup"><span data-stu-id="7935a-108">The procedures and examples in this article show how to receive first-chance exception notifications in a simple program that has one application domain, and in an application domain that you create.</span></span>

 <span data-ttu-id="7935a-109">Более развернутый пример с несколькими доменами приложения см. в описании события <xref:System.AppDomain.FirstChanceException>.</span><span class="sxs-lookup"><span data-stu-id="7935a-109">For a more complex example that spans several application domains, see the example for the <xref:System.AppDomain.FirstChanceException> event.</span></span>

## <a name="receiving-first-chance-exception-notifications-in-the-default-application-domain"></a><span data-ttu-id="7935a-110">Получение уведомлений о первом этапе обработки исключений в домене приложения по умолчанию</span><span class="sxs-lookup"><span data-stu-id="7935a-110">Receiving First-Chance Exception Notifications in the Default Application Domain</span></span>

 <span data-ttu-id="7935a-111">В представленной ниже процедуре точка входа для приложения, метод `Main()`, запускается в домене приложения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7935a-111">In the following procedure, the entry point for the application, the `Main()` method, runs in the default application domain.</span></span>

#### <a name="to-demonstrate-first-chance-exception-notifications-in-the-default-application-domain"></a><span data-ttu-id="7935a-112">Получение уведомлений о первом этапе обработки исключений в домене приложения по умолчанию</span><span class="sxs-lookup"><span data-stu-id="7935a-112">To demonstrate first-chance exception notifications in the default application domain</span></span>

1. <span data-ttu-id="7935a-113">Определите обработчик событий для события <xref:System.AppDomain.FirstChanceException>, используя лямбда-функцию, и присоедините его к событию.</span><span class="sxs-lookup"><span data-stu-id="7935a-113">Define an event handler for the <xref:System.AppDomain.FirstChanceException> event, using a lambda function, and attach it to the event.</span></span> <span data-ttu-id="7935a-114">В этом примере обработчик событий выводит имя домена приложения, где событие было обработано, а также свойство исключения <xref:System.Exception.Message%2A>.</span><span class="sxs-lookup"><span data-stu-id="7935a-114">In this example, the event handler prints the name of the application domain where the event was handled and the exception's <xref:System.Exception.Message%2A> property.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto_simple#2](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/cs/example.cs#2)]
     [!code-vb[System.AppDomain.FirstChanceException_howto_simple#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/vb/example.vb#2)]

2. <span data-ttu-id="7935a-115">Вызовите исключение и перехватите его.</span><span class="sxs-lookup"><span data-stu-id="7935a-115">Throw an exception and catch it.</span></span> <span data-ttu-id="7935a-116">Еще до того, как среда выполнения найдет обработчик исключений, будет вызвано событие <xref:System.AppDomain.FirstChanceException>, которое отобразит сообщение.</span><span class="sxs-lookup"><span data-stu-id="7935a-116">Before the runtime locates the exception handler, the <xref:System.AppDomain.FirstChanceException> event is raised and displays a message.</span></span> <span data-ttu-id="7935a-117">За ним последует это сообщение, которое отображается обработчиком исключений.</span><span class="sxs-lookup"><span data-stu-id="7935a-117">This message is followed by the message that is displayed by the exception handler.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto_simple#3](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/cs/example.cs#3)]
     [!code-vb[System.AppDomain.FirstChanceException_howto_simple#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/vb/example.vb#3)]

3. <span data-ttu-id="7935a-118">Вызовите исключение, но не перехватывайте его.</span><span class="sxs-lookup"><span data-stu-id="7935a-118">Throw an exception, but do not catch it.</span></span> <span data-ttu-id="7935a-119">Еще до того, как среда выполнения найдет обработчик исключений, будет вызвано событие <xref:System.AppDomain.FirstChanceException>, которое отобразит сообщение.</span><span class="sxs-lookup"><span data-stu-id="7935a-119">Before the runtime looks for an exception handler, the <xref:System.AppDomain.FirstChanceException> event is raised and displays a message.</span></span> <span data-ttu-id="7935a-120">Обработчика исключений нет, поэтому приложение завершит работу.</span><span class="sxs-lookup"><span data-stu-id="7935a-120">There is no exception handler, so the application terminates.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto_simple#4](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/cs/example.cs#4)]
     [!code-vb[System.AppDomain.FirstChanceException_howto_simple#4](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/vb/example.vb#4)]

     <span data-ttu-id="7935a-121">Приведенный ниже (в первых трех шагах этой процедуры) код формирует полное консольное приложение.</span><span class="sxs-lookup"><span data-stu-id="7935a-121">The code that is shown in the first three steps of this procedure forms a complete console application.</span></span> <span data-ttu-id="7935a-122">Выходные данные приложения зависят от имени EXE-файла, потому что имя домена приложения по умолчанию состоит из имени и расширения EXE-файла.</span><span class="sxs-lookup"><span data-stu-id="7935a-122">The output from the application varies, depending on the name of the .exe file, because the name of the default application domain consists of the name and extension of the .exe file.</span></span> <span data-ttu-id="7935a-123">В следующем примере показаны выходные данные.</span><span class="sxs-lookup"><span data-stu-id="7935a-123">See the following for sample output.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto_simple#5](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/cs/example.cs#5)]
     [!code-vb[System.AppDomain.FirstChanceException_howto_simple#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto_simple/vb/example.vb#5)]

## <a name="receiving-first-chance-exception-notifications-in-another-application-domain"></a><span data-ttu-id="7935a-124">Получение уведомлений о первом этапе обработки исключений в другом домене приложения</span><span class="sxs-lookup"><span data-stu-id="7935a-124">Receiving First-Chance Exception Notifications in Another Application Domain</span></span>

 <span data-ttu-id="7935a-125">Если в программе имеется несколько доменов приложения, можно выбирать, какие из них должны получать уведомления.</span><span class="sxs-lookup"><span data-stu-id="7935a-125">If your program contains more than one application domain, you can choose which application domains receive notifications.</span></span>

#### <a name="to-receive-first-chance-exception-notifications-in-an-application-domain-that-you-create"></a><span data-ttu-id="7935a-126">Получение уведомлений о первом этапе обработки исключений в созданном пользователем домене приложения</span><span class="sxs-lookup"><span data-stu-id="7935a-126">To receive first-chance exception notifications in an application domain that you create</span></span>

1. <span data-ttu-id="7935a-127">Определите обработчик событий для события <xref:System.AppDomain.FirstChanceException>.</span><span class="sxs-lookup"><span data-stu-id="7935a-127">Define an event handler for the <xref:System.AppDomain.FirstChanceException> event.</span></span> <span data-ttu-id="7935a-128">В этом примере используется метод `static` (`Shared` в Visual Basic), выводящий имя домена приложения, обработавшего исключение, и свойство <xref:System.Exception.Message%2A> исключения.</span><span class="sxs-lookup"><span data-stu-id="7935a-128">This example uses a `static` method (`Shared` method in Visual Basic) that prints the name of the application domain where the event was handled and the exception's <xref:System.Exception.Message%2A> property.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto#3](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#3)]
     [!code-vb[System.AppDomain.FirstChanceException_howto#3](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#3)]

2. <span data-ttu-id="7935a-129">Создайте домен приложения и добавьте обработчик событий <xref:System.AppDomain.FirstChanceException> для этого домена приложения.</span><span class="sxs-lookup"><span data-stu-id="7935a-129">Create an application domain and add the event handler to the <xref:System.AppDomain.FirstChanceException> event for that application domain.</span></span> <span data-ttu-id="7935a-130">В этом примере домен приложения называется `AD1`.</span><span class="sxs-lookup"><span data-stu-id="7935a-130">In this example, the application domain is named `AD1`.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto#2](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#2)]
     [!code-vb[System.AppDomain.FirstChanceException_howto#2](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#2)]

     <span data-ttu-id="7935a-131">Данное событие можно аналогичным образом обработать в домене приложения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7935a-131">You can handle this event in the default application domain in the same way.</span></span> <span data-ttu-id="7935a-132">Используйте свойство `static` (`Shared` в Visual Basic) с модификатором <xref:System.AppDomain.CurrentDomain%2A?displayProperty=nameWithType> в методе `Main()` для получения ссылки на домен приложения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7935a-132">Use the `static` (`Shared` in Visual Basic) <xref:System.AppDomain.CurrentDomain%2A?displayProperty=nameWithType> property in `Main()` to get a reference to the default application domain.</span></span>

#### <a name="to-demonstrate-first-chance-exception-notifications-in-the-application-domain"></a><span data-ttu-id="7935a-133">Демонстрация уведомлений о первом этапе обработки исключений в домене приложения</span><span class="sxs-lookup"><span data-stu-id="7935a-133">To demonstrate first-chance exception notifications in the application domain</span></span>

1. <span data-ttu-id="7935a-134">Создайте объект `Worker` в домене приложения, созданном в предыдущей процедуре.</span><span class="sxs-lookup"><span data-stu-id="7935a-134">Create a `Worker` object in the application domain that you created in the previous procedure.</span></span> <span data-ttu-id="7935a-135">Класс `Worker` должен быть открытым наследником <xref:System.MarshalByRefObject>, как показано в полном примере в конце статьи.</span><span class="sxs-lookup"><span data-stu-id="7935a-135">The `Worker` class must be public, and must derive from <xref:System.MarshalByRefObject>, as shown in the complete example at the end of this article.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto#4](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#4)]
     [!code-vb[System.AppDomain.FirstChanceException_howto#4](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#4)]

2. <span data-ttu-id="7935a-136">Вызовите метод объекта `Worker`, который создает исключение.</span><span class="sxs-lookup"><span data-stu-id="7935a-136">Call a method of the `Worker` object that throws an exception.</span></span> <span data-ttu-id="7935a-137">В этом примере метод `Thrower` вызывается дважды.</span><span class="sxs-lookup"><span data-stu-id="7935a-137">In this example, the `Thrower` method is called twice.</span></span> <span data-ttu-id="7935a-138">В первый раз аргумент метода равен `true`, в результате чего метод перехватывает собственное исключение самостоятельно.</span><span class="sxs-lookup"><span data-stu-id="7935a-138">The first time, the method argument is `true`, which causes the method to catch its own exception.</span></span> <span data-ttu-id="7935a-139">Во второй раз аргумент равен `false`, и метод `Main()` перехватывает исключение в домене приложения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7935a-139">The second time, the argument is `false`, and the `Main()` method catches the exception in the default application domain.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto#6](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#6)]
     [!code-vb[System.AppDomain.FirstChanceException_howto#6](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#6)]

3. <span data-ttu-id="7935a-140">Поместите в метод `Thrower` код, отвечающий за то, будет ли метод обрабатывать собственное исключение.</span><span class="sxs-lookup"><span data-stu-id="7935a-140">Place code in the `Thrower` method to control whether the method handles its own exception.</span></span>

     [!code-csharp[System.AppDomain.FirstChanceException_howto#5](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#5)]
     [!code-vb[System.AppDomain.FirstChanceException_howto#5](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#5)]

## <a name="example"></a><span data-ttu-id="7935a-141">Пример</span><span class="sxs-lookup"><span data-stu-id="7935a-141">Example</span></span>

 <span data-ttu-id="7935a-142">В следующем примере создается домен приложения `AD1`, после чего для события <xref:System.AppDomain.FirstChanceException> этого домена добавляется обработчик событий.</span><span class="sxs-lookup"><span data-stu-id="7935a-142">The following example creates an application domain named `AD1` and adds an event handler to the application domain's <xref:System.AppDomain.FirstChanceException> event.</span></span> <span data-ttu-id="7935a-143">Затем в этом домене приложения создается экземпляр класса `Worker` и вызывается метод `Thrower`, порождающий исключение <xref:System.ArgumentException>.</span><span class="sxs-lookup"><span data-stu-id="7935a-143">The example creates an instance of the `Worker` class in the application domain, and calls a method named `Thrower` that throws an <xref:System.ArgumentException>.</span></span> <span data-ttu-id="7935a-144">В зависимости от значения аргумента метод либо перехватит исключение, либо не сможет его обработать.</span><span class="sxs-lookup"><span data-stu-id="7935a-144">Depending on the value of its argument, the method either catches the exception or fails to handle it.</span></span>

 <span data-ttu-id="7935a-145">Каждый раз `Thrower` метод вызывает исключение в `AD1`, <xref:System.AppDomain.FirstChanceException> события в `AD1`, и обработчик событий выводит сообщение.</span><span class="sxs-lookup"><span data-stu-id="7935a-145">Each time the `Thrower` method throws an exception in `AD1`, the <xref:System.AppDomain.FirstChanceException> event is raised in `AD1`, and the event handler displays a message.</span></span> <span data-ttu-id="7935a-146">Затем среда выполнения ищет обработчик исключений.</span><span class="sxs-lookup"><span data-stu-id="7935a-146">The runtime then looks for an exception handler.</span></span> <span data-ttu-id="7935a-147">В первом случае он обнаруживается в `AD1`.</span><span class="sxs-lookup"><span data-stu-id="7935a-147">In the first case, the exception handler is found in `AD1`.</span></span> <span data-ttu-id="7935a-148">Во втором случае исключение в `AD1` не обрабатывается и перехватывается только в домене приложения по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="7935a-148">In the second case, the exception is unhandled in `AD1`, and instead is caught in the default application domain.</span></span>

> [!NOTE]
> <span data-ttu-id="7935a-149">Имя домена приложения по умолчанию совпадает с именем исполняемого файла.</span><span class="sxs-lookup"><span data-stu-id="7935a-149">The name of the default application domain is the same as the name of the executable.</span></span>

 <span data-ttu-id="7935a-150">При добавлении обработчика для события <xref:System.AppDomain.FirstChanceException> в домен приложения по умолчанию событие возникает и обрабатывается еще до того, как домен приложения по умолчанию обработает исключение.</span><span class="sxs-lookup"><span data-stu-id="7935a-150">If you add a handler for the <xref:System.AppDomain.FirstChanceException> event to the default application domain, the event is raised and handled before the default application domain handles the exception.</span></span> <span data-ttu-id="7935a-151">Чтобы увидеть, как это происходит, добавьте код на C# `AppDomain.CurrentDomain.FirstChanceException += FirstChanceException;` (в Visual Basic — `AddHandler AppDomain.CurrentDomain.FirstChanceException, FirstChanceException`) в начало метода `Main()`.</span><span class="sxs-lookup"><span data-stu-id="7935a-151">To see this, add the C# code `AppDomain.CurrentDomain.FirstChanceException += FirstChanceException;` (in Visual Basic, `AddHandler AppDomain.CurrentDomain.FirstChanceException, FirstChanceException`) at the beginning of `Main()`.</span></span>

 [!code-csharp[System.AppDomain.FirstChanceException_howto#1](../../../samples/snippets/csharp/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/cs/example.cs#1)]
 [!code-vb[System.AppDomain.FirstChanceException_howto#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR_System/system.appdomain.firstchanceexception_howto/vb/example.vb#1)]

## <a name="see-also"></a><span data-ttu-id="7935a-152">См. также</span><span class="sxs-lookup"><span data-stu-id="7935a-152">See also</span></span>

- <xref:System.AppDomain.FirstChanceException>
