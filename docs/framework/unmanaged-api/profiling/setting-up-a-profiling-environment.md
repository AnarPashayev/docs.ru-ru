---
title: Установка профилирующей среды
ms.date: 03/30/2017
helpviewer_keywords:
- environment variables, profiling API
- profiling API [.NET Framework], setting up environment
- COR_PROFILER environment variable
- Windows Service applications, profiling
- profiling API [.NET Framework], Windows Service applications
- COR_ENABLE_PROFILING environment variable
- profiling API [.NET Framework], enabling
ms.assetid: fefca07f-7555-4e77-be86-3c542e928312
ms.openlocfilehash: 32ebb868ea64a24fba80133b1a0eb539f51cb411
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79176972"
---
# <a name="setting-up-a-profiling-environment"></a><span data-ttu-id="5a3f9-102">Установка профилирующей среды</span><span class="sxs-lookup"><span data-stu-id="5a3f9-102">Setting Up a Profiling Environment</span></span>
> [!NOTE]
> <span data-ttu-id="5a3f9-103">В рамках .NET Framework 4 произошли существенные изменения в профилировании.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-103">There have been substantial changes to profiling in the .NET Framework 4.</span></span>  
  
 <span data-ttu-id="5a3f9-104">При запуске управляемого процесса (приложения или службы) он загружает среду CLR.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-104">When a managed process (application or service) starts, it loads the common language runtime (CLR).</span></span> <span data-ttu-id="5a3f9-105">При инициализации среды CLR она оценивает следующие две переменные среды, чтобы решить, следует ли подключить процесс к профилировщику.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-105">When the CLR is initialized, it evaluates the following two environmental variables to decide whether the process should connect to a profiler:</span></span>  
  
- <span data-ttu-id="5a3f9-106">COR_ENABLE_PROFILING: среда CLR подключается к профилировщику только в том случае, если эта переменная среды существует и имеет значение 1.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-106">COR_ENABLE_PROFILING: The CLR connects to a profiler only if this environment variable exists and is set to 1.</span></span>  
  
- <span data-ttu-id="5a3f9-107">COR_PROFILER: если проверка COR_ENABLE_PROFILING прошла успешно, среда CLR подключается к профилировщику, имеющему этот идентификатор CLSID или ProgID, который должен быть сохранен в реестре ранее.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-107">COR_PROFILER: If the COR_ENABLE_PROFILING check passes, the CLR connects to the profiler that has this CLSID or ProgID, which must have been stored previously in the registry.</span></span> <span data-ttu-id="5a3f9-108">Переменная среды COR_PROFILER задается как строка, как показано в следующих двух примерах.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-108">The COR_PROFILER environment variable is defined as a string, as shown in the following two examples.</span></span>  
  
    ```cpp  
    set COR_PROFILER={32E2F4DA-1BEA-47ea-88F9-C5DAF691C94A}  
    set COR_PROFILER="MyProfiler"  
    ```  
  
 <span data-ttu-id="5a3f9-109">Чтобы выполнить профилирование приложения среды CLR, необходимо задать переменные среды COR_ENABLE_PROFILING и COR_PROFILER перед запуском приложения.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-109">To profile a CLR application, you must set the COR_ENABLE_PROFILING and COR_PROFILER environment variables before you run the application.</span></span> <span data-ttu-id="5a3f9-110">Кроме того, необходимо убедиться, что DLL профилировщика зарегистрирована.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-110">You must also make sure that the profiler DLL is registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5a3f9-111">Начиная с .NET Framework 4, профайлеры не должны быть зарегистрированы.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-111">Starting with the .NET Framework 4, profilers do not have to be registered.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="5a3f9-112">Чтобы использовать версии .NET Framework 2.0, 3.0 и 3.5 в версиях .NET Framework 4 и более поздних версиях, необходимо установить переменную COMPLUS_ProfAPI_ProfilerCompatibilitySetting среды.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-112">To use .NET Framework versions 2.0, 3.0, and 3.5 profilers in the .NET Framework 4 and later versions, you must set the COMPLUS_ProfAPI_ProfilerCompatibilitySetting environment variable.</span></span>  
  
## <a name="environment-variable-scope"></a><span data-ttu-id="5a3f9-113">Область действия переменных среды.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-113">Environment Variable Scope</span></span>  
 <span data-ttu-id="5a3f9-114">Способ установки переменных среды COR_ENABLE_PROFILING и COR_PROFILER будет определять их области действия.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-114">How you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables will determine their scope of influence.</span></span> <span data-ttu-id="5a3f9-115">Вы можете установить эти переменные одним из следующих способов.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-115">You can set these variables in one of the following ways:</span></span>  
  
- <span data-ttu-id="5a3f9-116">Если вы установите переменные в [вызове ICorDebug::CreateProcess,](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) они будут применяться только к приложению, которое вы работаете в данный момент.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-116">If you set the variables in an [ICorDebug::CreateProcess](../../../../docs/framework/unmanaged-api/debugging/icordebug-createprocess-method.md) call, they will apply only to the application that you are running at the time.</span></span> <span data-ttu-id="5a3f9-117">(Они также будут применяться к другим приложениям, запущенным этим приложением, которые наследуют среду.)</span><span class="sxs-lookup"><span data-stu-id="5a3f9-117">(They will also apply to other applications started by that application that inherit the environment.)</span></span>  
  
- <span data-ttu-id="5a3f9-118">Если переменные задаются в окне командной строки, то они будут применяться ко всем приложениям, которые запускаются из этого окна.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-118">If you set the variables in a Command Prompt window, they will apply to all applications that are started from that window.</span></span>  
  
- <span data-ttu-id="5a3f9-119">Если задать переменные на уровне пользователя, они будут применяться ко всем приложениям, запускаемым из проводника.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-119">If you set the variables at the user level, they will apply to all applications that you start with File Explorer.</span></span> <span data-ttu-id="5a3f9-120">Окно командной строки, открытое после установки этих переменных, будет использовать эти параметры среды, как и любое приложение, запущенное из этого окна.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-120">A Command Prompt window that you open after you set the variables will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="5a3f9-121">Чтобы установить переменные среды на уровне пользователя, нажмите на **мой компьютер,** нажмите **«Свойства»,** щелкните вкладку **Advanced,** щелкните **переменные среды**и добавьте переменные в список **переменных пользователя.**</span><span class="sxs-lookup"><span data-stu-id="5a3f9-121">To set environment variables at the user level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, and add the variables to the **User variables** list.</span></span>  
  
- <span data-ttu-id="5a3f9-122">Если задать переменные на уровне компьютера, они будут применяться ко всем приложениям, запускаемым на этом компьютере.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-122">If you set the variables at the computer level, they will apply to all applications that are started on that computer.</span></span> <span data-ttu-id="5a3f9-123">Окно командной строки, открытое на этом компьютере, будет использовать эти параметры среды, как и любое приложение, запущенное из этого окна.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-123">A Command Prompt window that you open on that computer will have these environment settings, and so will any application that you start from that window.</span></span> <span data-ttu-id="5a3f9-124">Это означает, что все управляемые процессы на этом компьютере будут запускаться с вашим профилировщиком.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-124">This means that every managed process on that computer will start with your profiler.</span></span> <span data-ttu-id="5a3f9-125">Чтобы установить переменные среды на уровне компьютера, нажмите на **мой компьютер,** нажмите **«Свойства»,** щелкните вкладку **Advanced,** нажмите **«Переменные среды»,** добавьте переменные в список **переменных Системы,** а затем перезапустите компьютер.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-125">To set environment variables at the computer level, right-click **My Computer**, click **Properties**, click the **Advanced** tab, click **Environment Variables**, add the variables to the **System variables** list, and then restart your computer.</span></span> <span data-ttu-id="5a3f9-126">После перезагрузки эти переменные будут доступны во всей системе.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-126">After restarting, the variables will be available system-wide.</span></span>  
  
 <span data-ttu-id="5a3f9-127">При профилировании службы Windows необходимо перезагрузить компьютер после установки переменных среды и регистрации DLL профилировщика.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-127">If you are profiling a Windows Service, you must restart your computer after you set the environment variables and register the profiler DLL.</span></span> <span data-ttu-id="5a3f9-128">Для получения дополнительной информации об этих соображениях смотрите раздел [Профилирование службы Windows](#windows_service).</span><span class="sxs-lookup"><span data-stu-id="5a3f9-128">For more information about these considerations, see the section [Profiling a Windows Service](#windows_service).</span></span>  
  
## <a name="additional-considerations"></a><span data-ttu-id="5a3f9-129">Дополнительные сведения</span><span class="sxs-lookup"><span data-stu-id="5a3f9-129">Additional Considerations</span></span>  
  
- <span data-ttu-id="5a3f9-130">Класс профилировщика реализует интерфейсы [ICorProfilerCallback](icorprofilercallback-interface.md) и [ICorProfilerCallback2.](icorprofilercallback2-interface.md)</span><span class="sxs-lookup"><span data-stu-id="5a3f9-130">The profiler class implements the [ICorProfilerCallback](icorprofilercallback-interface.md) and [ICorProfilerCallback2](icorprofilercallback2-interface.md) interfaces.</span></span> <span data-ttu-id="5a3f9-131">На платформе .NET Framework версии 2.0 профилировщик должен реализовывать интерфейс `ICorProfilerCallback2`.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-131">In the .NET Framework version 2.0, a profiler must implement `ICorProfilerCallback2`.</span></span> <span data-ttu-id="5a3f9-132">Если это не так, то `ICorProfilerCallback2` не будет загружен.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-132">If it does not, `ICorProfilerCallback2` will not be loaded.</span></span>  
  
- <span data-ttu-id="5a3f9-133">Только один профилировщик может профилировать процесс в каждый момент времени в конкретной среде.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-133">Only one profiler can profile a process at one time in a given environment.</span></span> <span data-ttu-id="5a3f9-134">Можно зарегистрировать два различных профилировщика в разных средах, но каждый из них должен профилировать разные процессы.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-134">You can register two different profilers in different environments, but each must profile separate processes.</span></span> <span data-ttu-id="5a3f9-135">Профилировщик должен быть реализован как внутрипроцессная DLL COM-сервера, назначенная в то же адресное пространство, что и профилируемый процесс.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-135">The profiler must be implemented as an in-process COM server DLL, which is mapped into the same address space as the process that is being profiled.</span></span> <span data-ttu-id="5a3f9-136">Это означает, что профилировщик функционирует внутрипроцессно.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-136">This means that the profiler runs in-process.</span></span> <span data-ttu-id="5a3f9-137">Платформа .NET Framework не поддерживает другие типы COM-сервера.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-137">The .NET Framework does not support any other type of COM server.</span></span> <span data-ttu-id="5a3f9-138">Например, если профилировщику необходимо выполнить мониторинг приложений с удаленного компьютера, он должен реализовать агенты сборщика на каждом компьютере.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-138">For example, if a profiler wants to monitor applications from a remote computer, it must implement collector agents on each computer.</span></span> <span data-ttu-id="5a3f9-139">Эти агенты будут выполнять пакетную обработку результатов и сообщать о них центральному компьютеру коллекции данных.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-139">These agents will batch results and communicate them to the central data collection computer.</span></span>  
  
- <span data-ttu-id="5a3f9-140">Так как профилировщик является COM-объектом, создаваемым в процессе, каждое профилируемое приложение будет иметь собственную копию профилировщика.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-140">Because the profiler is a COM object that is instantiated in-process, each profiled application will have its own copy of the profiler.</span></span> <span data-ttu-id="5a3f9-141">Таким образом, одиночный экземпляр профилировщика не должен обрабатывать данные из нескольких приложений.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-141">Therefore, a single profiler instance does not have to handle data from multiple applications.</span></span> <span data-ttu-id="5a3f9-142">Тем не менее необходимо добавить логику в код ведения журнала профилировщика для предотвращения перезаписи файла журнала другими профилируемыми приложениями.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-142">However, you will have to add logic to the profiler's logging code to prevent log file overwrites from other profiled applications.</span></span>  
  
## <a name="initializing-the-profiler"></a><span data-ttu-id="5a3f9-143">Инициализация профилировщика</span><span class="sxs-lookup"><span data-stu-id="5a3f9-143">Initializing the Profiler</span></span>  
 <span data-ttu-id="5a3f9-144">Когда обе переменные среды проходят проверку, среда CLR  создает экземпляр профилировщика аналогично функции COM `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-144">When both environment variable checks pass, the CLR creates an instance of the profiler in a similar manner to the COM `CoCreateInstance` function.</span></span> <span data-ttu-id="5a3f9-145">Профилировщик не загружается посредством прямого вызова `CoCreateInstance`.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-145">The profiler is not loaded through a direct call to `CoCreateInstance`.</span></span> <span data-ttu-id="5a3f9-146">Таким образом, исключается вызов `CoInitialize`, требующий установки потоковой модели.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-146">Therefore, a call to `CoInitialize`, which requires setting the threading model, is avoided.</span></span> <span data-ttu-id="5a3f9-147">Затем CLR вызывает [ICorProfilerCallback::Первоначальный](icorprofilercallback-initialize-method.md) метод в профайлере.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-147">The CLR then calls the [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) method in the profiler.</span></span> <span data-ttu-id="5a3f9-148">Сигнатура этого метода выглядит следующим образом.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-148">The signature of this method is as follows.</span></span>  
  
```cpp  
HRESULT Initialize(IUnknown *pICorProfilerInfoUnk)  
```  
  
 <span data-ttu-id="5a3f9-149">Профайлер должен `pICorProfilerInfoUnk` запросить указатель интерфейса [ICorProfilerInfo](icorprofilerinfo-interface.md) или [ICorProfilerInfo2](icorprofilerinfo2-interface.md) и сохранить его, чтобы он мог запросить дополнительную информацию позже во время профилирования.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-149">The profiler must query `pICorProfilerInfoUnk` for an [ICorProfilerInfo](icorprofilerinfo-interface.md) or [ICorProfilerInfo2](icorprofilerinfo2-interface.md) interface pointer and save it so that it can request more information later during profiling.</span></span>  
  
## <a name="setting-event-notifications"></a><span data-ttu-id="5a3f9-150">Настройка уведомлений о событиях</span><span class="sxs-lookup"><span data-stu-id="5a3f9-150">Setting Event Notifications</span></span>  
 <span data-ttu-id="5a3f9-151">Затем профайлер называет метод [ICorProfilerInfo::SetEventMask,](icorprofilerinfo-seteventmask-method.md) чтобы указать, какие категории уведомлений он интересует.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-151">The profiler then calls the [ICorProfilerInfo::SetEventMask](icorprofilerinfo-seteventmask-method.md) method to specify which categories of notifications it is interested in.</span></span> <span data-ttu-id="5a3f9-152">Например, если профилировщик интересуют только уведомления вызова-возврата в функциях и уведомления о сборке мусора, то указывается следующее.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-152">For example, if the profiler is interested only in function enter and leave notifications and garbage collection notifications, it specifies the following.</span></span>  
  
```cpp  
ICorProfilerInfo* pInfo;  
pICorProfilerInfoUnk->QueryInterface(IID_ICorProfilerInfo, (void**)&pInfo);  
pInfo->SetEventMask(COR_PRF_MONITOR_ENTERLEAVE | COR_PRF_MONITOR_GC)  
```  
  
 <span data-ttu-id="5a3f9-153">Путем такого задания маски уведомлений профилировщик может ограничить принимаемые уведомления.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-153">By setting the notifications mask in this manner, the profiler can limit which notifications it receives.</span></span> <span data-ttu-id="5a3f9-154">Такой подход помогает пользователю строить простой или специальный профилировщик.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-154">This approach helps the user build a simple or special-purpose profiler.</span></span> <span data-ttu-id="5a3f9-155">Он также сокращает время ЦП, которое тратится на отправку уведомлений, которые профилировщик должен игнорировать.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-155">It also reduces CPU time that would be wasted sending notifications that the profiler would just ignore.</span></span>  
  
 <span data-ttu-id="5a3f9-156">Некоторые события профилировщика являются неизменяемыми.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-156">Certain profiler events are immutable.</span></span> <span data-ttu-id="5a3f9-157">Это означает, что сразу после установки этих событий в обратном вызове `ICorProfilerCallback::Initialize` они не могут быть отключены и новые события не могут быть включены.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-157">This means that as soon as these events are set in the `ICorProfilerCallback::Initialize` callback, they cannot be turned off and new events cannot be turned on.</span></span> <span data-ttu-id="5a3f9-158">Попытки изменить неизменяемое событие приведут к возврату методом `ICorProfilerInfo::SetEventMask` HRESULT с ошибкой.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-158">Attempts to change an immutable event will result in `ICorProfilerInfo::SetEventMask` returning a failed HRESULT.</span></span>  
  
<a name="windows_service"></a>
## <a name="profiling-a-windows-service"></a><span data-ttu-id="5a3f9-159">Профилирование службы Windows</span><span class="sxs-lookup"><span data-stu-id="5a3f9-159">Profiling a Windows Service</span></span>  
 <span data-ttu-id="5a3f9-160">Профилирование службы Windows аналогично профилированию приложения среды CLR.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-160">Profiling a Windows Service is like profiling a common language runtime application.</span></span> <span data-ttu-id="5a3f9-161">Обе операции профилирования включаются посредством переменных среды.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-161">Both profiling operations are enabled through environment variables.</span></span> <span data-ttu-id="5a3f9-162">Поскольку служба Windows запускается при запуске операционной системы, переменные среды, которые рассматривались выше в этом разделе, должны присутствовать и иметь необходимые значения до запуска системы.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-162">Because a Windows Service is started when the operating system starts, the environment variables discussed previously in this topic must already be present and set to the required values before the system starts.</span></span> <span data-ttu-id="5a3f9-163">Кроме того, библиотека DLL профилирования должна уже быть зарегистрирована в системе.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-163">In addition, the profiling DLL must already be registered on the system.</span></span>  
  
 <span data-ttu-id="5a3f9-164">После установки переменных среды COR_ENABLE_PROFILING и COR_PROFILER и регистрации библиотеки DLL профилировщика вы должны перезагрузить компьютер, чтобы служба Windows могла обнаружить эти изменения.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-164">After you set the COR_ENABLE_PROFILING and COR_PROFILER environment variables and register the profiler DLL, you should restart the target computer so that the Windows Service can detect those changes.</span></span>  
  
 <span data-ttu-id="5a3f9-165">Обратите внимание, что эти изменения будут включать профилирование в рамках всей системы.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-165">Note that these changes will enable profiling on a system-wide basis.</span></span> <span data-ttu-id="5a3f9-166">Во избежание профилирования всех последовательно запускаемых управляемых приложений следует удалить переменные среды после перезагрузки целевого компьютера.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-166">To prevent every managed application that subsequently runs from being profiled, you should delete the system environment variables after you restart the target computer.</span></span>  
  
 <span data-ttu-id="5a3f9-167">Этот метод также приводит к профилированию каждого процесса CLR.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-167">This technique also leads to every CLR process getting profiled.</span></span> <span data-ttu-id="5a3f9-168">Профайлер должен добавить логику в свой [ICorProfilerCallback::Инициализация](icorprofilercallback-initialize-method.md) обратного вызова, чтобы определить, представляет ли текущий процесс интерес.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-168">The profiler should add logic to its [ICorProfilerCallback::Initialize](icorprofilercallback-initialize-method.md) callback to detect whether the current process is of interest.</span></span> <span data-ttu-id="5a3f9-169">Если это не так, профилировщик может завершить обратный вызов с ошибкой без выполнения инициализации.</span><span class="sxs-lookup"><span data-stu-id="5a3f9-169">If it is not, the profiler can fail the callback without performing the initialization.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="5a3f9-170">См. также раздел</span><span class="sxs-lookup"><span data-stu-id="5a3f9-170">See also</span></span>

- [<span data-ttu-id="5a3f9-171">Обзор профилирования</span><span class="sxs-lookup"><span data-stu-id="5a3f9-171">Profiling Overview</span></span>](profiling-overview.md)
