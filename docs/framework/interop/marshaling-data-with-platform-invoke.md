---
title: Маршалинг данных при вызове неуправляемого кода
description: Маршалинг данных при вызове платформы в .NET. См. список типов данных, используемых в API-интерфейсах и функциях стиля C и найдите для них эквиваленты управляемых типов .NET.
ms.date: 03/20/2019
dev_langs:
- cpp
helpviewer_keywords:
- platform invoke, marshaling data
- data marshaling, platform invoke
- marshaling, platform invoke
ms.assetid: dc5c76cf-7b12-406f-b79c-d1a023ec245d
ms.openlocfilehash: 27045790780c1eef9537bdf7e52deb579e2b467c
ms.sourcegitcommit: 3824ff187947572b274b9715b60c11269335c181
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/17/2020
ms.locfileid: "84904108"
---
# <a name="marshaling-data-with-platform-invoke"></a><span data-ttu-id="dcb5c-104">Маршалинг данных при вызове неуправляемого кода</span><span class="sxs-lookup"><span data-stu-id="dcb5c-104">Marshaling Data with Platform Invoke</span></span>

<span data-ttu-id="dcb5c-105">Для вызова функций, экспортированных из неуправляемой библиотеки, приложению .NET Framework требуется прототип функции в управляемом коде, представляющий неуправляемую функцию.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-105">To call functions exported from an unmanaged library, a .NET Framework application requires a function prototype in managed code that represents the unmanaged function.</span></span> <span data-ttu-id="dcb5c-106">Чтобы создать прототип, который допускает вызов неуправляемого кода для правильного маршалинга данных, необходимо выполнить указанные ниже действия.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-106">To create a prototype that enables platform invoke to marshal data correctly, you must do the following:</span></span>

- <span data-ttu-id="dcb5c-107">Примените атрибут <xref:System.Runtime.InteropServices.DllImportAttribute> к статической функции или методу в управляемом коде.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-107">Apply the <xref:System.Runtime.InteropServices.DllImportAttribute> attribute to the static function or method in managed code.</span></span>

- <span data-ttu-id="dcb5c-108">Замените неуправляемые типы данных на управляемые.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-108">Substitute managed data types for unmanaged data types.</span></span>

<span data-ttu-id="dcb5c-109">Чтобы создать эквивалентный управляемый прототип путем применения атрибута с необязательными полями и замены неуправляемых типов данных на управляемые, можно использовать документацию, предоставляемую с неуправляемой функцией.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-109">You can use the documentation supplied with an unmanaged function to construct an equivalent managed prototype by applying the attribute with its optional fields and substituting managed data types for unmanaged types.</span></span> <span data-ttu-id="dcb5c-110">Инструкции по применению <xref:System.Runtime.InteropServices.DllImportAttribute> см. в разделе [Использование неуправляемых функций DLL](consuming-unmanaged-dll-functions.md).</span><span class="sxs-lookup"><span data-stu-id="dcb5c-110">For instructions about how to apply the <xref:System.Runtime.InteropServices.DllImportAttribute>, see [Consuming Unmanaged DLL Functions](consuming-unmanaged-dll-functions.md).</span></span>

<span data-ttu-id="dcb5c-111">В этом разделе содержатся примеры, демонстрирующие способы создания прототипов управляемых функций для передачи аргументов и получения значений от функций, экспортируемых из неуправляемых библиотек.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-111">This section provides samples that demonstrate how to create managed function prototypes for passing arguments to and receiving return values from functions exported by unmanaged libraries.</span></span> <span data-ttu-id="dcb5c-112">В примерах также демонстрируется использование атрибута <xref:System.Runtime.InteropServices.MarshalAsAttribute> и класса <xref:System.Runtime.InteropServices.Marshal> для явного маршалинга данных.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-112">The samples also demonstrate when to use the <xref:System.Runtime.InteropServices.MarshalAsAttribute> attribute and the <xref:System.Runtime.InteropServices.Marshal> class to explicitly marshal data.</span></span>

## <a name="platform-invoke-data-types"></a><span data-ttu-id="dcb5c-113">Типы данных в вызове неуправляемого кода</span><span class="sxs-lookup"><span data-stu-id="dcb5c-113">Platform invoke data types</span></span>

<span data-ttu-id="dcb5c-114">Ниже перечислены типы данных, используемые в API Windows и в функциях в стиле C.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-114">The following table lists data types used in the Windows APIs and C-style functions.</span></span> <span data-ttu-id="dcb5c-115">Многие неуправляемые библиотеки содержат функции, передающие эти типы данных в качестве параметров и возвращаемых значений.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-115">Many unmanaged libraries contain functions that pass these data types as parameters and return values.</span></span> <span data-ttu-id="dcb5c-116">В третьем столбце представлены соответствующие встроенные типы значений .NET Framework или классы, используемые в управляемом коде.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-116">The third column lists the corresponding .NET Framework built-in value type or class that you use in managed code.</span></span> <span data-ttu-id="dcb5c-117">В некоторых случаях типы, перечисленные в таблице, можно заменить на типы того же размера.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-117">In some cases, you can substitute a type of the same size for the type listed in the table.</span></span>

|<span data-ttu-id="dcb5c-118">Неуправляемый тип в API Windows</span><span class="sxs-lookup"><span data-stu-id="dcb5c-118">Unmanaged type in Windows APIs</span></span>|<span data-ttu-id="dcb5c-119">Неуправляемый тип языка C</span><span class="sxs-lookup"><span data-stu-id="dcb5c-119">Unmanaged C language type</span></span>|<span data-ttu-id="dcb5c-120">Управляемый тип</span><span class="sxs-lookup"><span data-stu-id="dcb5c-120">Managed type</span></span>|<span data-ttu-id="dcb5c-121">Описание</span><span class="sxs-lookup"><span data-stu-id="dcb5c-121">Description</span></span>|
|--------------------------------|-------------------------------|------------------------|-----------------|
|`VOID`|`void`|<xref:System.Void?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-122">Применяется к функции, которая не возвращает значение.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-122">Applied to a function that does not return a value.</span></span>|
|`HANDLE`|`void *`|<span data-ttu-id="dcb5c-123"><xref:System.IntPtr?displayProperty=nameWithType> или <xref:System.UIntPtr?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-123"><xref:System.IntPtr?displayProperty=nameWithType> or <xref:System.UIntPtr?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-124">32 бита в 32-разрядных операционных системах Windows, 64 бита в 64-разрядных операционных системах Windows.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-124">32 bits on 32-bit Windows operating systems, 64 bits on 64-bit Windows operating systems.</span></span>|
|`BYTE`|`unsigned char`|<xref:System.Byte?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-125">8 бит</span><span class="sxs-lookup"><span data-stu-id="dcb5c-125">8 bits</span></span>|
|`SHORT`|`short`|<xref:System.Int16?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-126">16 бит</span><span class="sxs-lookup"><span data-stu-id="dcb5c-126">16 bits</span></span>|
|`WORD`|`unsigned short`|<xref:System.UInt16?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-127">16 бит</span><span class="sxs-lookup"><span data-stu-id="dcb5c-127">16 bits</span></span>|
|`INT`|`int`|<xref:System.Int32?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-128">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-128">32 bits</span></span>|
|`UINT`|`unsigned int`|<xref:System.UInt32?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-129">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-129">32 bits</span></span>|
|`LONG`|`long`|<xref:System.Int32?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-130">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-130">32 bits</span></span>|
|`BOOL`|`long`|<span data-ttu-id="dcb5c-131"><xref:System.Boolean?displayProperty=nameWithType> или <xref:System.Int32?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-131"><xref:System.Boolean?displayProperty=nameWithType> or <xref:System.Int32?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-132">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-132">32 bits</span></span>|
|`DWORD`|`unsigned long`|<xref:System.UInt32?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-133">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-133">32 bits</span></span>|
|`ULONG`|`unsigned long`|<xref:System.UInt32?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-134">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-134">32 bits</span></span>|
|`CHAR`|`char`|<xref:System.Char?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-135">В кодировке ANSI.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-135">Decorate with ANSI.</span></span>|
|`WCHAR`|`wchar_t`|<xref:System.Char?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-136">В кодировке Юникод.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-136">Decorate with Unicode.</span></span>|
|`LPSTR`|`char *`|<span data-ttu-id="dcb5c-137"><xref:System.String?displayProperty=nameWithType> или <xref:System.Text.StringBuilder?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-137"><xref:System.String?displayProperty=nameWithType> or <xref:System.Text.StringBuilder?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-138">В кодировке ANSI.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-138">Decorate with ANSI.</span></span>|
|`LPCSTR`|`const char *`|<span data-ttu-id="dcb5c-139"><xref:System.String?displayProperty=nameWithType> или <xref:System.Text.StringBuilder?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-139"><xref:System.String?displayProperty=nameWithType> or <xref:System.Text.StringBuilder?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-140">В кодировке ANSI.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-140">Decorate with ANSI.</span></span>|
|`LPWSTR`|`wchar_t *`|<span data-ttu-id="dcb5c-141"><xref:System.String?displayProperty=nameWithType> или <xref:System.Text.StringBuilder?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-141"><xref:System.String?displayProperty=nameWithType> or <xref:System.Text.StringBuilder?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-142">В кодировке Юникод.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-142">Decorate with Unicode.</span></span>|
|`LPCWSTR`|`const wchar_t *`|<span data-ttu-id="dcb5c-143"><xref:System.String?displayProperty=nameWithType> или <xref:System.Text.StringBuilder?displayProperty=nameWithType></span><span class="sxs-lookup"><span data-stu-id="dcb5c-143"><xref:System.String?displayProperty=nameWithType> or <xref:System.Text.StringBuilder?displayProperty=nameWithType></span></span>|<span data-ttu-id="dcb5c-144">В кодировке Юникод.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-144">Decorate with Unicode.</span></span>|
|`FLOAT`|`float`|<xref:System.Single?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-145">32 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-145">32 bits</span></span>|
|`DOUBLE`|`double`|<xref:System.Double?displayProperty=nameWithType>|<span data-ttu-id="dcb5c-146">64 бита</span><span class="sxs-lookup"><span data-stu-id="dcb5c-146">64 bits</span></span>|

<span data-ttu-id="dcb5c-147">Соответствующие типы в Visual Basic, C# и C++ см. в разделе [Общие сведения о библиотеке классов .NET Framework](../../standard/class-library-overview.md#system-namespace).</span><span class="sxs-lookup"><span data-stu-id="dcb5c-147">For corresponding types in Visual Basic, C#, and C++, see the [Introduction to the .NET Framework Class Library](../../standard/class-library-overview.md#system-namespace).</span></span>

## <a name="pinvokelibdll"></a><span data-ttu-id="dcb5c-148">PinvokeLib.dll</span><span class="sxs-lookup"><span data-stu-id="dcb5c-148">PinvokeLib.dll</span></span>

<span data-ttu-id="dcb5c-149">В примере кода ниже определяются функции библиотеки, предоставляемые Pinvoke.dll.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-149">The following code defines the library functions provided by Pinvoke.dll.</span></span> <span data-ttu-id="dcb5c-150">Многие из примеров, описанных в этом разделе, вызывают эту библиотеку.</span><span class="sxs-lookup"><span data-stu-id="dcb5c-150">Many samples described in this section call this library.</span></span>

### <a name="example"></a><span data-ttu-id="dcb5c-151">Пример</span><span class="sxs-lookup"><span data-stu-id="dcb5c-151">Example</span></span>

[!code-cpp[PInvokeLib#1](../../../samples/snippets/cpp/VS_Snippets_CLR/pinvokelib/cpp/pinvokelib.cpp#1)]

[!code-cpp[PInvokeLib#2](../../../samples/snippets/cpp/VS_Snippets_CLR/pinvokelib/cpp/pinvokelib.h#2)]
