---
title: Обнаружение сборок в среде выполнения
ms.date: 03/30/2017
helpviewer_keywords:
- app.config files, assembly locations
- deploying applications [.NET Framework], assembly locations
- application configuration files, locating assemblies
- .NET Framework application deployment, locating assemblies
- locating assemblies
- assemblies [.NET Framework], location
ms.assetid: 772ac6f4-64d2-4cfb-92fd-58096dcd6c34
ms.openlocfilehash: 13e2661b67ba3b717b8917e80118175acb09e756
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/15/2020
ms.locfileid: "79181677"
---
# <a name="how-the-runtime-locates-assemblies"></a>Обнаружение сборок в среде выполнения

Для успешного развертывания приложения .NET Framework необходимо понимать, как среда CLR обнаруживает сборки, из которых состоит приложение, и выполняет привязку к ним. По умолчанию среда выполнения пытается выполнить привязку к той самой версии сборки, с помощью которой было создано приложение. Это поведение по умолчанию можно переопределить с помощью параметров файла конфигурации.

При попытке найти сборку и разрешить ссылку на нее среда CLR выполняет ряд действий. Каждый этап подробно описывается в приведенных ниже разделах. Термин "проверка" часто используется при описании того, как среда выполнения ищет сборки. Под ним понимается набор эвристических правил, используемых для обнаружения сборки на основе ее имени и языка и региональных параметров.

> [!NOTE]
> Сведения о привязке можно просмотреть в файле журнала с помощью [средства просмотра журнала привязок сборки (Fuslogvw.exe)](../tools/fuslogvw-exe-assembly-binding-log-viewer.md), которое включено в Windows SDK.

## <a name="initiating-the-bind"></a>Инициирование привязки

Процесс обнаружения и привязки к сборке начинается, когда среда выполнения пытается разрешить ссылку на другую сборку. Эта ссылка может быть статической или динамической. Компилятор записывает статические ссылки в метаданные манифеста сборки во время сборки. Динамические ссылки создаются в режиме реального времени в результате вызова различных методов, таких как <xref:System.Reflection.Assembly.Load%2A?displayProperty=nameWithType>.

Предпочтительным способом обращения к сборке является использование полной ссылки, включая имя, версию, язык и региональные параметры сборки и токен открытого ключа (при наличии). Среда выполнения использует эти сведения для обнаружения сборки с помощью описанных далее в этом разделе действий. Она использует один и тот же процесс разрешения независимо от того, указывает ли ссылка на статическую или динамическую сборку.

Динамическую ссылку на сборку также можно создать, предоставив вызывающему методу только часть сведений о сборке, например только ее имя. В этом случае сборка ищется только в каталоге приложения. Другие проверки не производятся. Создать частичную ссылку можно с помощью различных методов загрузки сборок, таких как <xref:System.Reflection.Assembly.Load%2A?displayProperty=nameWithType> или <xref:System.AppDomain.Load%2A?displayProperty=nameWithType>.

В заключение можно создать динамическую ссылку, используя метод, такой как <xref:System.Reflection.Assembly.Load%2A?displayProperty=nameWithType>, и предоставить только частичные сведения; затем ссылку полностью определяют с помощью элемента [\<qualifyAssembly>](../configure-apps/file-schema/runtime/qualifyassembly-element.md) в файле конфигурации приложения. Этот элемент позволяет предоставлять полные данные ссылки (имя, версию, язык и региональные параметры и, при наличии, токен открытого ключа) в файле конфигурации приложения, а не в коде. Такой подход можно использовать, если требуется определить полную ссылку на сборку вне каталога приложения или сослаться на сборку в глобальном кэше сборок, используя преимущества определения полной ссылки в файле конфигурации, а не в коде.

> [!NOTE]
> Частичные ссылки этого типа не следует использовать для сборок, которые являются общими для нескольких приложений. Так как параметры конфигурации применяются к приложениям, а не к сборкам, сведения об общей сборке, использующей такой тип частичной ссылки, потребуется включить в файлы конфигурации всех приложений, использующих эту сборку.

Для разрешения ссылки на сборку среда выполнения выполняет указанные ниже действия.

1. [Определяет правильную версию сборки](#step1) , анализируя применимые файлы конфигурации, включая файл конфигурации приложения, файл политики издателя и файл конфигурации компьютера. Если файл конфигурации расположен на удаленном компьютере, сначала среде выполнения нужно найти и скачать файл конфигурации приложения.

2. [Проверяет, выполнялась ли привязка к имени сборки прежде](#step2) , и если да, использует ранее загруженную сборку. Если предыдущий запрос загрузки сборки закончился неудачей, запрос немедленно прерывается без попытки загрузить сборку.

    > [!NOTE]
    > Кэширование ошибок привязки к сборкам появилось в .NET Framework 2.0.

3. [Проверяет глобальный кэш сборок](#step3). Если в нем удается найти сборку, среда выполнения использует ее.

4. [Проверяет наличие сборки](#step4) , выполняя указанные ниже действия.

    1. Если конфигурация и политика издателя не влияют на исходную ссылку и запрос привязки создан с помощью метода <xref:System.Reflection.Assembly.LoadFrom%2A?displayProperty=nameWithType> , среда выполнения пытается найти косвенные упоминания о расположении сборки.

    2. Если база кода находится в файлах конфигурации, среда выполнения проверяет только это расположение. Если происходит сбой проверки, среда выполнения определяет, что запрос привязки не выполнен, и другие проверки не производятся.

    3. Проверяет наличие сборки с помощью эвристических правил, описанных в разделе, посвященном [проверке](#step4). Если сборку не удается найти с помощью проверки, среда выполнения запрашивает предоставление сборки у установщика Windows. Эта операция напоминает функцию установки по запросу.

        > [!NOTE]
        > Если сборки не являются сборками со строгими именами, для них не проводятся ни проверка версии, ни поиск в глобальном кэше сборок.

<a name="step1"></a>

## <a name="step-1-examining-the-configuration-files"></a>Шаг 1. Проверка файлов конфигурации

Поведение привязки сборок можно настроить на разных уровнях, используя три XML-файла:

- файл конфигурации приложения;

- файл политики издателя;

- файл конфигурации компьютера.

Эти файлы имеют одинаковый синтаксис и содержат такие сведения, как перенаправления привязки, расположение кода и режимы привязки для конкретных сборок. Каждый файл конфигурации может содержать [элемент \<assemblyBinding](../configure-apps/file-schema/runtime/assemblybinding-element-for-runtime.md), перенаправляющий процесс привязки. Дочерние элементы [элемента \<assemblyBinding>](../configure-apps/file-schema/runtime/assemblybinding-element-for-runtime.md) включают [элемент \<dependentAssembly>](../configure-apps/file-schema/runtime/dependentassembly-element.md). Дочерние элементы [элемента \<dependentAssembly>](../configure-apps/file-schema/runtime/dependentassembly-element.md) включают [элемент \<assemblyIdentity>](/visualstudio/deployment/assemblyidentity-element-clickonce-deployment), [элемент \<bindingRedirect>](../configure-apps/file-schema/runtime/bindingredirect-element.md) и [элемент \<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md).

> [!NOTE]
> Сведения о конфигурации хранятся во всех трех файлах конфигурации, но не все элементы можно использовать во всех этих файлах. Например, сведения о режиме привязки и частном пути могут находиться только в файле конфигурации приложения. Полный список сведений, которые содержатся в каждом файле, см. в разделе [Настройка приложений с использованием файлов конфигурации](../configure-apps/index.md).

### <a name="application-configuration-file"></a>Файл конфигурации приложения

В первую очередь среда CLR пытается найти в файле конфигурации приложения данные, которые переопределяют сведения о версии, хранящиеся в манифесте вызывающей сборки. Файл конфигурации приложения можно развертывать вместе с приложением, но он не требуется для выполнения приложения. Обычно получение этого файла происходит почти мгновенно, однако если приложение размещено на удаленном компьютере, например при работе с веб-приложением через Internet Explorer, файл конфигурации необходимо скачивать.

В случае клиентских приложений файл конфигурации приложения расположен в том же каталоге, что и исполняемый файл приложения, и имеет такое же базовое имя, но с расширением CONFIG. Например, файл конфигурации для C:\Program Files\Myapp\Myapp.exe называется C:\Program Files\Myapp\Myapp.exe.config. В случае работы через браузер в HTML-файле должен быть элемент **\<link>** , явным образом указывающий на файл конфигурации.

Ниже показан пример кода простого файла конфигурации приложения. В этом примере элемент <xref:System.Diagnostics.TextWriterTraceListener> добавляется в коллекцию <xref:System.Diagnostics.Debug.Listeners%2A> , чтобы включить запись отладочной информации в файл.

```xml
<configuration>
   <system.diagnostics>
      <trace useGlobalLock="false" autoflush="true" indentsize="0">
         <listeners>
            <add name="myListener" type="System.Diagnostics.TextWriterTraceListener, system version=1.0.3300.0, Culture=neutral, PublicKeyToken=b77a5c561934e089" initializeData="c:\myListener.log" />
         </listeners>
      </trace>
   </system.diagnostics>
</configuration>
```

### <a name="publisher-policy-file"></a>Файл политики издателя

Во вторую очередь среда выполнения проверяет файл политики издателя, если он существует. Файлы политики издателя распространяются издателем компонента в виде исправлений или обновлений для общего компонента. Они содержат предоставляемые издателем сведения о совместимости, которые задают ссылки на новые версии сборок. В отличие от файлов конфигурации компьютера и приложения файлы политики издателя хранятся в своей собственной сборке, которая должна быть установлена в глобальном кэше сборок.

Ниже приведен пример файла конфигурации политики издателя.

```xml
<configuration>
    <runtime>
        <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">

            <dependentAssembly>
                <assemblyIdentity name="asm6" publicKeyToken="c0305c36380ba429" />
                <bindingRedirect oldVersion="3.0.0.0" newVersion="2.0.0.0"/>
            </dependentAssembly>

        </assemblyBinding>
    </runtime>
</configuration>
```

Чтобы создать сборку, можно воспользоваться [компоновщиком сборок (Al.exe)](../tools/al-exe-assembly-linker.md) и выполнить команду следующего вида:

```console
Al.exe /link:asm6.exe.config /out:policy.3.0.asm6.dll /keyfile: compatkey.dat /v:3.0.0.0
```

`compatkey.dat` — это файл ключа строгого имени. Эта команда создает сборку со строгим именем, которую можно поместить в глобальный кэш сборок.

> [!NOTE]
> Политика издателя затрагивает все приложения, которые используют общий компонент.

Файл конфигурации политики издателя переопределяет сведения о версии, которые поступают от приложения (то есть из манифеста сборки или из файла конфигурации приложения). Если в файле конфигурации приложения нет оператора перенаправления версии, указанной в манифесте сборки, файл политики издателя переопределяет версию, указанную в манифесте сборки. Однако если такой оператор имеется, политика издателя переопределяет эту версию, а не версию, указанную в манифесте.

Файл политики издателя используется, если общий компонент обновляется и нужно, чтобы все использующие его приложения получили его новую версию. Параметры в файле политики издателя переопределяют параметры в файле конфигурации приложения, если только в файле конфигурации приложения не задан безопасный режим.

#### <a name="safe-mode"></a>Безопасный режим
Файлы политики издателя обычно явным образом устанавливаются как часть пакета обновления или обновления программы. В случае возникновения проблем с обновленным общим компонентом можно проигнорировать изменения в файле политики издателя, используя безопасный режим. Безопасный режим определяется элементом **\<publisherPolicy apply="yes**&#124;**no"/>** , расположенным только в файле конфигурации приложения. Он указывает, следует ли удалять сведения политики издателя из процесса привязки.

Безопасный режим можно задать для всего приложения или для выбранных сборок. То есть можно отключить политику для всех сборок, составляющих приложение, или включить ее для некоторых сборок, отключив для других. Чтобы применить политику издателя на уровне отдельных сборок приложения, установите параметр **\<publisherPolicy apply\=no/>** и с помощью элемента \<**dependentAssembly**> укажите сборки, на которые должно распространяться действие политики. Чтобы применить политику издателя ко всем сборкам приложения, установите параметр **\<publisherPolicy apply\=no/>** без элементов зависимых сборок. Дополнительные сведения о конфигурации см. в разделе [Настройка приложений с использованием файлов конфигурации](../configure-apps/index.md).

### <a name="machine-configuration-file"></a>Файл конфигурации компьютера
Файл конфигурации компьютера среда выполнения проверяет последним. Этот файл с именем Machine.config находится на локальном компьютере в подкаталоге Config корневого каталога, где установлена среда выполнения. С помощью этого файла администраторы могут настраивать ограничения привязки сборок, действующие только на этом компьютере. Параметры в файле конфигурации компьютера имеют приоритет над всеми остальными параметрами. Однако это не означает, что все параметры конфигурации должны быть помещены в этот файл. Версия, определяемая файлом политики администратора, является окончательной и не может быть переопределена. Переопределения, заданные в файле Machine.config, влияют на все приложения. Дополнительные сведения о файлах конфигурации см. в разделе [Настройка приложений с использованием файлов конфигурации](../configure-apps/index.md).

<a name="step2"></a>

## <a name="step-2-checking-for-previously-referenced-assemblies"></a>Шаг 2. Проверка наличия предыдущих ссылок на сборки

Если запрошенная сборка уже запрашивалась в предыдущих вызовах, среда CLR использует уже загруженную сборку. Это может иметь последствия при именовании сборок, составляющих приложение. Подробнее об именовании сборок см. в разделе [Имена сборок](../../standard/assembly/names.md).

Если предыдущий запрос сборки завершился неудачей, последующие вызовы этой сборки немедленно прерываются без попытки загрузить сборку. Начиная с .NET Framework версии 2.0 сбои привязки сборок кэшируются, и кэшированные сведения используются для определения целесообразности попытки загрузить сборку.

> [!NOTE]
> Чтобы вернуться к алгоритму поведения, характерному для .NET Framework версий 1.0 и 1.1, в котором сбои привязки не кэшировались, включите в файл конфигурации [элемент \<disableCachingBindingFailures>](../configure-apps/file-schema/runtime/disablecachingbindingfailures-element.md).

<a name="step3"></a>

## <a name="step-3-checking-the-global-assembly-cache"></a>Шаг 3. Проверка глобального кэша сборок

Для сборок со строгими именами процесс привязки продолжается поиском в глобальном кэше сборок. В глобальном кэше сборок сохраняются сборки, которые могут использоваться на компьютере несколькими приложениями. Все сборки в глобальном кэше сборок должны иметь строгие имена.

<a name="step4"></a>

## <a name="step-4-locating-the-assembly-through-codebases-or-probing"></a>Шаг 4. Обнаружение сборки с помощью базы кода или проверки

После определения правильной версии сборки с помощью сведений в ссылке вызывающей сборки и в файлах конфигурации, а также после проверки в глобальном кэше сборок (только для сборок со строгими именами) среда CLR попытается найти сборку. Процесс поиска расположения сборки включает в себя перечисленные ниже этапы.

1. Если элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md) найден в файле конфигурации приложения, среда выполнения проверяет указанное местоположение. Если найдено совпадение, используется эта сборка, и дальнейший поиск не выполняется. Если сборку не удается обнаружить в этом файле, происходит сбой запроса привязки.

2. Среда выполнения осуществляет проверку наличия связанной сборки, используя правила, описанные далее в этом разделе.

> [!NOTE]
> Если в каталоге имеется несколько версий сборки и требуется сослаться на конкретную версию сборки, необходимо использовать элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md) вместо атрибута `privatePath` элемента [\<probing>](../configure-apps/file-schema/runtime/probing-element.md). Если используется элемент [\<probing>](../configure-apps/file-schema/runtime/probing-element.md), среда выполнения останавливает проверку при первом обнаружении сборки, у которой совпадает упоминаемое в ссылке простое имя сборки независимо от того, является ли совпадение точным или нет. Если совпадение точное, найденная сборка используется. Если совпадение не является точным, проверка прекращается и происходит сбой привязки.

### <a name="locating-the-assembly-through-codebases"></a>Обнаружение сборки с помощью базы кода

Сведения базы кода могут предоставляться с помощью элемента [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md) в файле конфигурации. Эта база кода всегда проверяется, прежде чем среда выполнения переходит к проверке наличия связанной сборки. Если файл политики издателя, содержащий переадресацию конечной версии, содержит также элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), используется этот элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md). Например, если в файле конфигурации приложения указан элемент [\<<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), и файл политики издателя, переопределяющий сведения приложения, также содержит элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), используется элемент [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md) из файла политики издателя.

Если совпадение не найдено в местоположении, заданном элементом [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), запрос привязки завершается неудачей и никакие дополнительные действия не предпринимаются. Если среда выполнения определяет, что сборка соответствует критерию вызывающей сборки, то используется эта сборка. Когда загружается файл, указанный заданным элементом [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), среда выполнения проверяет совпадение имени, версии, языка, региональных параметров и открытого ключа с соответствующими параметрами ссылки вызывающей сборки.

> [!NOTE]
> Связанные сборки вне корневого каталога приложения должны иметь строгие имена и должны быть установлены в глобальном кэше сборок или заданы с помощью элемента [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md).

### <a name="locating-the-assembly-through-probing"></a>Обнаружение сборки с помощью проверки

Если в файле конфигурации приложения нет элемента [\<codeBase>](../configure-apps/file-schema/runtime/codebase-element.md), среда выполнения проверяет наличие сборки, используя следующие четыре критерия.

- Базовая папка приложения, то есть корневой каталог, где выполняется приложение.

- Язык и региональные параметры, то есть атрибут culture сборки, на которую задана ссылка.

- Имя, то есть имя сборки, на которую задана ссылка.

- Атрибут `privatePath` элемента [\<probing>](../configure-apps/file-schema/runtime/probing-element.md), который является определяемым пользователем списком подкаталогов в корневой папке. Это расположение может быть задано в файле конфигурации приложения и в управляемом коде с помощью свойства <xref:System.AppDomainSetup.PrivateBinPath?displayProperty=nameWithType> для домена приложения. При указании в управляемом коде путь `privatePath` управляемого кода проверяется первым. Затем проверяется путь, указанный в файле конфигурации приложения.

#### <a name="probing-the-application-base-and-culture-directories"></a>Проверка базовой папки приложения и каталогов языков и региональных параметров

Среда выполнения всегда начинает проверку с базовой папки приложения, которая может быть URL-адресом или корневым каталогом приложения на компьютере. Если связанная сборка не найдена в базовой папке приложения и не предоставлены сведения о языке и региональных параметрах, среда выполнения осуществляет поиск во всех подкаталогах с именем сборки. В число проверяемых каталогов входят следующие:

- [базовая папка приложения] / [имя сборки].dll

- [базовая папка приложения] / [имя сборки] / [имя сборки].dll

Если указаны сведения о языке и региональных параметрах, проверяются только следующие каталоги:

- [базовая папка приложения] / [язык и региональные параметры] / [имя сборки].dll

- [базовая папка приложения] / [язык и региональные параметры] / [имя сборки] / [имя сборки].dll

#### <a name="probing-with-the-privatepath-attribute"></a>Проверка с помощью атрибута privatePath

Помимо подкаталогов языков и региональных параметров и подкаталогов, называемых по связанной сборке, среда выполнения проверяет также каталоги, задаваемые с помощью атрибута `privatePath` элемента [\<probing>](../configure-apps/file-schema/runtime/probing-element.md). Каталоги, заданные с помощью атрибута `privatePath` , должны быть подкаталогами корневого каталога приложения. Проверяемые каталоги зависят от того, включены ли сведения о языке и региональных параметрах в запрос связанной сборки.

Среда выполнения останавливает проверку при первом обнаружении сборки, у которой совпадает упоминаемое в ссылке простое имя сборки, независимо от того, является ли совпадение точным или нет. Если совпадение точное, найденная сборка используется. Если совпадение не является точным, проверка прекращается и происходит сбой привязки.

Если язык и региональные параметры включены, проверяются следующие каталоги:

- [базовая папка приложения] / [binpath] / [язык и региональные параметры] / [имя сборки].dll

- [базовая папка приложения] / [binpath] / [язык и региональные параметры] / [имя сборки] / [имя сборки].dll

Если язык и региональные параметры не включены, проверяются следующие каталоги:

- [базовая папка приложения] / [binpath] / [имя сборки].dll

- [базовая папка приложения] / [binpath] / [имя сборки] / [имя сборки].dll

#### <a name="probing-examples"></a>Примеры проверки

Заданы следующие сведения:

- Имя сборки, на которую указывает ссылка: myAssembly

- Корневой каталог приложения: `http://www.code.microsoft.com`

- Значение элемента [\<probing>](../configure-apps/file-schema/runtime/probing-element.md) в файле конфигурации: bin

- Язык и региональные параметры: de

Среда выполнения проверяет следующие URL-адреса:

- `http://www.code.microsoft.com/de/myAssembly.dll`

- `http://www.code.microsoft.com/de/myAssembly/myAssembly.dll`

- `http://www.code.microsoft.com/bin/de/myAssembly.dll`

- `http://www.code.microsoft.com/bin/de/myAssembly/myAssembly.dll`

##### <a name="multiple-assemblies-with-the-same-name"></a>Несколько сборок с одинаковыми именами

В примере ниже показано, как настроить несколько сборок с одинаковыми именами.

```xml
<dependentAssembly>
   <assemblyIdentity name="Server" publicKeyToken="c0305c36380ba429" />
   <codeBase version="1.0.0.0" href="v1/Server.dll" />
   <codeBase version="2.0.0.0" href="v2/Server.dll" />
</dependentAssembly>
```

#### <a name="other-locations-probed"></a>Другие проверяемые расположения

Расположение сборки также может быть установлено с помощью текущего контекста привязки. Это часто происходит при использовании метода <xref:System.Reflection.Assembly.LoadFrom%2A?displayProperty=nameWithType> и в сценариях COM-взаимодействия. Если сборка использует метод <xref:System.Reflection.Assembly.LoadFrom%2A> для ссылки на другую сборку, расположение вызывающей сборки считается подсказкой для поиска расположения сборки, на которую задана ссылка. Если удается найти совпадение, эта сборка загружается. Если совпадение не найдено, среда выполнения продолжает поиск в соответствии с семантикой, а затем запрашивает установщик Windows о предоставлении сборки. Если не удается предоставить сборку, соответствующую запросу привязки, создается исключение. Это исключение <xref:System.TypeLoadException> в управляемом коде, если была задана ссылка на тип, или <xref:System.IO.FileNotFoundException> , если загружаемая сборка не найдена.

Например, если сборка Assembly1 ссылается на сборку Assembly2 и сборка Assembly1 была скачана с адреса `http://www.code.microsoft.com/utils`, это расположение считается подсказкой для поиска Assembly2.dll. После этого среда выполнения проверяет наличие сборки в `http://www.code.microsoft.com/utils/Assembly2.dll` и `http://www.code.microsoft.com/utils/Assembly2/Assembly2.dll`. Если сборка Assembly2 не обнаружена ни в одном из этих расположений, среда выполнения отправляет запрос установщику Windows.

## <a name="see-also"></a>См. также

- [Рекомендации для загрузки сборок](best-practices-for-assembly-loading.md)
- [Развертывание](index.md)
