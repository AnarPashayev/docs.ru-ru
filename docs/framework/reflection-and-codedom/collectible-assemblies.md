---
title: Забираемые сборки для динамической генерации типа
description: ''
ms.date: 08/29/2017
helpviewer_keywords:
- reflection, dynamic assembly
- assemblies, collectible
- collectible assemblies, retrieving
ms.openlocfilehash: 02c7048e0321282463aa3558287d1d13c5e4f8d2
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/12/2020
ms.locfileid: "79180547"
---
# <a name="collectible-assemblies-for-dynamic-type-generation"></a>Забираемые сборки для динамической генерации типа

*Забираемые сборки* — это динамические сборки, которые можно выгрузить без выгрузки домена приложения, в котором они были созданы. Всю управляемую и неуправляемую память, используемую забираемой сборкой и содержащимися в ней типами, можно освободить. Сведения, такие как имя сборки, удаляются из внутренних таблиц.

Чтобы включить выгрузку, используйте флаг <xref:System.Reflection.Emit.AssemblyBuilderAccess.RunAndCollect?displayProperty=nameWithType> при создании динамической сборки. Сборка является временной (то есть ее невозможно сохранить), а также на нее распространяются ограничения, описанные в разделе [Ограничения забираемых сборок](#restrictions-on-collectible-assemblies). Общеязыковая среда выполнения (CLR) автоматически выгружает забираемую сборку, когда вы освободите все связанные со сборкой объекты. Во всех прочих отношениях забираемые сборки создаются и используются так же, как и другие динамические сборки.

## <a name="lifetime-of-collectible-assemblies"></a>Время существования забираемых сборок

Время существования забираемой сборки определяется наличием ссылок на содержащиеся в ней типы и объекты, созданные из этих типов. Общеязыковая среда выполнения не выгружает сборку, пока существует хотя бы один из следующих элементов (`T` — любой тип, определенный в сборке):

- Экземпляр `T`.

- Экземпляр массива `T`.

- Экземпляр универсального типа, имеющий `T` в качестве одного из аргументов типа. Сюда входят универсальные коллекции `T`, даже если такая коллекция пуста.

- Экземпляр <xref:System.Type> или <xref:System.Reflection.Emit.TypeBuilder>, представляющий `T`.

   > [!IMPORTANT]
   > Нужно освободить все объекты, представляющие части сборки. <xref:System.Reflection.Emit.ModuleBuilder>, определяющий `T`, хранит ссылку на <xref:System.Reflection.Emit.TypeBuilder>, а объект <xref:System.Reflection.Emit.AssemblyBuilder> хранит ссылку на <xref:System.Reflection.Emit.ModuleBuilder>, поэтому ссылки на эти объекты нужно освободить. Даже наличие <xref:System.Reflection.Emit.LocalBuilder> или <xref:System.Reflection.Emit.ILGenerator>, используемых при создании `T`, препятствует выгрузке.

- Статическая ссылка на `T` со стороны другого динамически определяемого типа `T1`, который все еще доступен выполняющемуся коду. Например, `T1` может наследовать от `T` или `T` может быть типом параметра в методе `T1`.

- **ByRef** для статического поля, который относится к `T`.

- <xref:System.RuntimeTypeHandle>, <xref:System.RuntimeFieldHandle> или <xref:System.RuntimeMethodHandle>, ссылающийся на `T` или на компонент `T`.

- Экземпляр любого объекта отражения, который можно использовать косвенно или напрямую для обращения к объекту <xref:System.Type>, представляющему `T`. Например, объект <xref:System.Type> для `T` можно получить из типа массива с типом элементов `T` или из универсального типа, имеющего аргумент типа `T`.

- Метод `M` в стеке вызовов любого потока, где `M` — это метод `T` или метод уровня модуля, который определен в сборке.

- Делегат для статического метода, который определен в модуле сборки.

Если всего один элемент из этого списка существует только для одного типа или метода в сборке, среда выполнения не может выгрузить сборку.

> [!NOTE]
> Среда выполнения не выгружает сборку, пока не выполнены методы завершения для всех элементов в списке.

В целях отслеживания времени существования сконструированный универсальный тип, например `List<int>` (в C#) или `List(Of Integer)` (в Visual Basic), который создается и используется при генерации забираемой сборки, считается определенным либо в сборке, содержащей определение универсального типа или определение одного из его аргументов типа. Фактически используемая сборка зависит от реализации и может изменяться.

## <a name="restrictions-on-collectible-assemblies"></a>Ограничения забираемых сборок

К забираемым сборкам применяются следующие ограничения:

- **Статические ссылки** Типы в обычной динамической сборке не могут иметь статические ссылки на типы, определяемые в коллекционируемой сборке. Например, если вы определяете обычный тип, наследующий от типа в забираемой сборке, возникает исключение <xref:System.NotSupportedException>. Тип в забираемой сборке может иметь статические ссылки на тип в другой забираемой сборке, но при этом время существования сборки, на которую указывает ссылка, становится равным времени существования сборки с такой ссылкой.

- **COM интероп** Интерфейсы COM не могут быть определены в коллекционной сборке, и никакие экземпляры типов в коллекционной сборке не могут быть преобразованы в объекты COM. Тип в забираемой сборке не может служить в качестве вызываемой оболочки COM (CCW) или вызываемой оболочки времени выполнения (RCW). Однако типы в забираемых сборках могут использовать объекты, реализующие COM-интерфейсы.

- **Платформа вызвать** Методы, у <xref:System.Runtime.InteropServices.DllImportAttribute> которых есть атрибут, не будут компилироваться, когда они объявляются в коллекционируемой сборке. Инструкция <xref:System.Reflection.Emit.OpCodes.Calli?displayProperty=nameWithType> не может использоваться в реализации типа в забираемой сборке, и такие типы невозможно маршалировать в неуправляемый код. Однако вы можете вызывать машинный код с помощью точки входа, объявленной в незабираемой сборке.

- **Маршалинг** Объекты (в частности, делегаты), которые определяются в коллекционных сборках, не могут быть marshaled. Это ограничение действует для всех временных выдаваемых типов.

- **Сборка загрузки** Отражение излучает является единственным механизмом, который поддерживается для загрузки коллекционных сборок. Сборки, загружаемые любым другим образом, выгрузить невозможно.

- **Объекты, связанные с контекстом** Контекстно-статические переменные не поддерживаются. Типы в забираемой сборке не могут расширять <xref:System.ContextBoundObject>. Однако код в забираемых сборках может использовать контекстно привязанные объекты, определенные в другом месте.

- **Потоковые статические данные** Потоковые статические переменные не поддерживаются.

## <a name="see-also"></a>См. также раздел

- [Предоставление динамических методов и сборок](emitting-dynamic-methods-and-assemblies.md)
