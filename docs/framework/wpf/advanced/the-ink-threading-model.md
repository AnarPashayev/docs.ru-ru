---
title: Потоковая модель рукописного ввода
ms.date: 03/30/2017
helpviewer_keywords:
- application user interface thread [WPF]
- stylus plug-in
- ink threading model [WPF]
- ink [WPF], rendering
- pen thread [WPF]
- threading model [WPF]
- rendering ink [WPF]
- dynamic rendering thread [WPF]
- ink collection plug-in
- plug-ins [WPF], for ink
ms.assetid: c85fcad1-cb50-4431-847c-ac4145a35c89
ms.openlocfilehash: 80e7ef202c46a23069766512cf4e67bb21a49564
ms.sourcegitcommit: 9b552addadfb57fab0b9e7852ed4f1f1b8a42f8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62007392"
---
# <a name="the-ink-threading-model"></a><span data-ttu-id="7d112-102">Потоковая модель рукописного ввода</span><span class="sxs-lookup"><span data-stu-id="7d112-102">The Ink Threading Model</span></span>
<span data-ttu-id="7d112-103">Одним из преимуществ рукописного ввода на планшетном ПК является, что его сходство с записи с помощью регулярного пера и бумаги.</span><span class="sxs-lookup"><span data-stu-id="7d112-103">One of the benefits of ink on a Tablet PC is that it feels a lot like writing with a regular pen and paper.</span></span>  <span data-ttu-id="7d112-104">В этой ситуации планшетное перо получать входные данные гораздо быстрее мыши и отображает рукописные данные как записи пользователя.</span><span class="sxs-lookup"><span data-stu-id="7d112-104">To accomplish this, the tablet pen collects input data at a much higher rate than a mouse does and renders the ink as the user writes.</span></span>  <span data-ttu-id="7d112-105">Поток пользовательского интерфейса (UI) приложения недостаточно для сбора данных пера и отрисовка рукописных данных, так как он может быть заблокирован.</span><span class="sxs-lookup"><span data-stu-id="7d112-105">The application's user interface (UI) thread is not sufficient for collecting pen data and rendering ink, because it can become blocked.</span></span>  <span data-ttu-id="7d112-106">Чтобы устранить эту проблему, [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] приложение использует два дополнительных потока, когда пользователь осуществляет рукописный ввод.</span><span class="sxs-lookup"><span data-stu-id="7d112-106">To solve this, a [!INCLUDE[TLA2#tla_winclient](../../../../includes/tla2sharptla-winclient-md.md)] application uses two additional threads when a user writes ink.</span></span>  
  
 <span data-ttu-id="7d112-107">Ниже перечислены потоки, примите участие в сборе и отображении рукописный ввод.</span><span class="sxs-lookup"><span data-stu-id="7d112-107">The following list describes the threads that take part in collecting and rendering digital ink:</span></span>  
  
- <span data-ttu-id="7d112-108">Поток пера - поток, который принимает ввод от пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-108">Pen thread - the thread that takes input from the stylus.</span></span>  <span data-ttu-id="7d112-109">(На самом деле это пул потоков, но в этом разделе он называется пуле потоков пера.)</span><span class="sxs-lookup"><span data-stu-id="7d112-109">(In reality, this is a thread pool, but this topic refers to it as a pen thread.)</span></span>  
  
- <span data-ttu-id="7d112-110">Поток пользовательского интерфейса приложения - поток, который определяет пользовательский интерфейс приложения.</span><span class="sxs-lookup"><span data-stu-id="7d112-110">Application user interface thread - the thread that controls the user interface of the application.</span></span>  
  
- <span data-ttu-id="7d112-111">Поток динамической отрисовки - поток, который отображает рукописные данные при пользователь рисует штрих.</span><span class="sxs-lookup"><span data-stu-id="7d112-111">Dynamic rendering thread - the thread that renders the ink while the user draws a stroke.</span></span> <span data-ttu-id="7d112-112">Поток динамической отрисовки отличается от потока, отображающего другие элементы пользовательского интерфейса для приложения, как упоминалось в Windows Presentation Foundation [потоковая модель](threading-model.md).</span><span class="sxs-lookup"><span data-stu-id="7d112-112">The dynamic rendering thread is different than the thread that renders other UI elements for the application, as mentioned in Window Presentation Foundation [Threading Model](threading-model.md).</span></span>  
  
 <span data-ttu-id="7d112-113">Модель рукописного ввода совпадает ли приложение использует <xref:System.Windows.Controls.InkCanvas> или пользовательский элемент управления, аналогичный показанному на [Создание элемента управления рукописным ввода](creating-an-ink-input-control.md).</span><span class="sxs-lookup"><span data-stu-id="7d112-113">The inking model is the same whether the application uses the <xref:System.Windows.Controls.InkCanvas> or a custom control similar to the one in [Creating an Ink Input Control](creating-an-ink-input-control.md).</span></span>  <span data-ttu-id="7d112-114">Несмотря на то, что в этом разделе обсуждается создание потоков на основе <xref:System.Windows.Controls.InkCanvas>, те же принципы применяются при создании пользовательского элемента управления.</span><span class="sxs-lookup"><span data-stu-id="7d112-114">Although this topic discusses threading in terms of the <xref:System.Windows.Controls.InkCanvas>, the same concepts apply when you create a custom control.</span></span>  
  
## <a name="threading-overview"></a><span data-ttu-id="7d112-115">Работа с потоками Обзор</span><span class="sxs-lookup"><span data-stu-id="7d112-115">Threading Overview</span></span>  
 <span data-ttu-id="7d112-116">На следующей схеме показана модель потоков, когда пользователь рисует штрих:</span><span class="sxs-lookup"><span data-stu-id="7d112-116">The following diagram illustrates the threading model when a user draws a stroke:</span></span>  
  
 <span data-ttu-id="7d112-117">![Потоковая модель во время отрисовки мазка. ](./media/inkthreading-drawingink.png "InkThreading_DrawingInk")</span><span class="sxs-lookup"><span data-stu-id="7d112-117">![Threading model while drawing a stroke.](./media/inkthreading-drawingink.png "InkThreading_DrawingInk")</span></span>  
  
1. <span data-ttu-id="7d112-118">Действия, происходящие во время пользователь рисует штрих</span><span class="sxs-lookup"><span data-stu-id="7d112-118">Actions occurring while the user draws the stroke</span></span>  
  
    1. <span data-ttu-id="7d112-119">Когда пользователь рисует штрих, точки пера поставляются потоке пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-119">When the user draws a stroke, the stylus points come in on the pen thread.</span></span>  <span data-ttu-id="7d112-120">Подключаемые модули пера, включая <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer>примите точки пера в потоке пера и иметь возможность изменить их перед <xref:System.Windows.Controls.InkCanvas> их получает.</span><span class="sxs-lookup"><span data-stu-id="7d112-120">Stylus plug-ins, including the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer>, accept the stylus points on the pen thread and have the chance to modify them before the <xref:System.Windows.Controls.InkCanvas> receives them.</span></span>  
  
    2. <span data-ttu-id="7d112-121"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Отображает точки пера в поток динамической отрисовки.</span><span class="sxs-lookup"><span data-stu-id="7d112-121">The <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> renders the stylus points on the dynamic rendering thread.</span></span> <span data-ttu-id="7d112-122">Это происходит в то же время на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="7d112-122">This happens at the same time as the previous step.</span></span>  
  
    3. <span data-ttu-id="7d112-123"><xref:System.Windows.Controls.InkCanvas> Получает точки пера в потоке пользовательского интерфейса.</span><span class="sxs-lookup"><span data-stu-id="7d112-123">The <xref:System.Windows.Controls.InkCanvas> receives the stylus points on the UI thread.</span></span>  
  
2. <span data-ttu-id="7d112-124">Действия, происходящие после пользователь завершает штрих</span><span class="sxs-lookup"><span data-stu-id="7d112-124">Actions occurring after the user ends the stroke</span></span>  
  
    1. <span data-ttu-id="7d112-125">Когда пользователь заканчивает рисование штриха, <xref:System.Windows.Controls.InkCanvas> создает <xref:System.Windows.Ink.Stroke> и добавляет его к <xref:System.Windows.Controls.InkPresenter>, который статически его отображает.</span><span class="sxs-lookup"><span data-stu-id="7d112-125">When the user finishes drawing the stroke, the <xref:System.Windows.Controls.InkCanvas> creates a <xref:System.Windows.Ink.Stroke> object and adds it to the <xref:System.Windows.Controls.InkPresenter>, which statically renders it.</span></span>  
  
    2. <span data-ttu-id="7d112-126">Поток пользовательского интерфейса оповещает <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> , статически выполняется отрисовка росчерка пера, поэтому <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> удаляет его визуальное представление штриха.</span><span class="sxs-lookup"><span data-stu-id="7d112-126">The UI thread alerts the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> that the stroke is statically rendered, so the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> removes its visual representation of the stroke.</span></span>  
  
## <a name="ink-collection-and-stylus-plug-ins"></a><span data-ttu-id="7d112-127">Сбор рукописных фрагментов и подключаемых модулей пера</span><span class="sxs-lookup"><span data-stu-id="7d112-127">Ink collection and Stylus Plug-ins</span></span>  
 <span data-ttu-id="7d112-128">Каждый <xref:System.Windows.UIElement> имеет <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection>.</span><span class="sxs-lookup"><span data-stu-id="7d112-128">Each <xref:System.Windows.UIElement> has a <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection>.</span></span>  <span data-ttu-id="7d112-129"><xref:System.Windows.Input.StylusPlugIns.StylusPlugIn> Объекты в <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection> получать и изменять точки пера в потоке пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-129">The <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn> objects in the <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection> receive and can modify the stylus points on the pen thread.</span></span> <span data-ttu-id="7d112-130"><xref:System.Windows.Input.StylusPlugIns.StylusPlugIn> Объекты получают точки пера, в соответствии с их порядок в <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection>.</span><span class="sxs-lookup"><span data-stu-id="7d112-130">The <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn> objects receive the stylus points according to their order in the <xref:System.Windows.Input.StylusPlugIns.StylusPlugInCollection>.</span></span>  
  
 <span data-ttu-id="7d112-131">На следующей схеме показана гипотетическую ситуацию где <xref:System.Windows.UIElement.StylusPlugIns%2A> коллекцию <xref:System.Windows.UIElement> содержит `stylusPlugin1`, <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer>, и `stylusPlugin2`в этом порядке.</span><span class="sxs-lookup"><span data-stu-id="7d112-131">The following diagram illustrates the hypothetical situation where the <xref:System.Windows.UIElement.StylusPlugIns%2A> collection of a <xref:System.Windows.UIElement> contains `stylusPlugin1`, a <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer>, and `stylusPlugin2`, in that order.</span></span>  
  
 <span data-ttu-id="7d112-132">![Порядок модулей пера влияет на выходные данные. ](./media/inkthreading-pluginorder.png "InkThreading_PluginOrder")</span><span class="sxs-lookup"><span data-stu-id="7d112-132">![Order of Stylus Plugins affect output.](./media/inkthreading-pluginorder.png "InkThreading_PluginOrder")</span></span>  
  
 <span data-ttu-id="7d112-133">На предыдущей диаграмме происходит следующее поведение:</span><span class="sxs-lookup"><span data-stu-id="7d112-133">In the previous diagram, the following behavior takes place:</span></span>  
  
1. <span data-ttu-id="7d112-134">`StylusPlugin1` изменения значений x и y.</span><span class="sxs-lookup"><span data-stu-id="7d112-134">`StylusPlugin1` modifies the values for x and y.</span></span>  
  
2. <span data-ttu-id="7d112-135"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Получает измененные точки пера и отображает их в поток динамической отрисовки.</span><span class="sxs-lookup"><span data-stu-id="7d112-135"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> receives the modified stylus points and renders them on the dynamic rendering thread.</span></span>  
  
3. <span data-ttu-id="7d112-136">`StylusPlugin2` Получает измененные точки пера и дальнейшие изменения значений x и y.</span><span class="sxs-lookup"><span data-stu-id="7d112-136">`StylusPlugin2` receives the modified stylus points and further modifies the values for x and y.</span></span>  
  
4. <span data-ttu-id="7d112-137">Приложение собирает точки пера и, когда пользователь заканчивает штриха, статически отображает штрих.</span><span class="sxs-lookup"><span data-stu-id="7d112-137">The application collects the stylus points, and, when the user finishes the stroke, statically renders the stroke.</span></span>  
  
 <span data-ttu-id="7d112-138">Предположим, что `stylusPlugin1` ограничивает точки пера в прямоугольник и `stylusPlugin2` переносит точки пера вправо.</span><span class="sxs-lookup"><span data-stu-id="7d112-138">Suppose that `stylusPlugin1` restricts the stylus points to a rectangle and `stylusPlugin2` translates the stylus points to the right.</span></span>  <span data-ttu-id="7d112-139">В приведенном выше сценарии <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> принимает ограниченные, но не перенесенные точки пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-139">In the previous scenario, the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> receives the restricted stylus points, but not the translated stylus points.</span></span>  <span data-ttu-id="7d112-140">Когда пользователь рисует штрих, выполняется отрисовка росчерка пера в границах прямоугольника, но он не доступен для перевода, пока пользователь отрывает перо.</span><span class="sxs-lookup"><span data-stu-id="7d112-140">When the user draws the stroke, the stroke is rendered within the bounds of the rectangle, but the stroke doesn't appear to be translated until the user lifts the pen.</span></span>  
  
### <a name="performing-operations-with-a-stylus-plug-in-on-the-ui-thread"></a><span data-ttu-id="7d112-141">Выполнение операций с помощью пера, подключаемый модуль, в потоке пользовательского интерфейса</span><span class="sxs-lookup"><span data-stu-id="7d112-141">Performing operations with a Stylus Plug-in on the UI thread</span></span>  
 <span data-ttu-id="7d112-142">Так как точные попадания не может выполняться в потоке пера, некоторые элементы могут иногда получать пера, предназначенный для других элементов.</span><span class="sxs-lookup"><span data-stu-id="7d112-142">Because accurate hit-testing cannot be performed on the pen thread, some elements might occasionally receive stylus input intended for other elements.</span></span> <span data-ttu-id="7d112-143">Если требуется, чтобы убедиться в том, правильно направлен входных данных перед выполнением операции, подписаться на и выполнить операцию в <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusDownProcessed%2A>, <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusMoveProcessed%2A>, или <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusUpProcessed%2A> метод.</span><span class="sxs-lookup"><span data-stu-id="7d112-143">If you need to make sure the input was routed correctly before performing an operation, subscribe to and perform the operation in the <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusDownProcessed%2A>, <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusMoveProcessed%2A>, or <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn.OnStylusUpProcessed%2A> method.</span></span> <span data-ttu-id="7d112-144">Эти методы вызываются потоком приложения после точной проверки нажатия.</span><span class="sxs-lookup"><span data-stu-id="7d112-144">These methods are invoked by the application thread after accurate hit-testing has been performed.</span></span> <span data-ttu-id="7d112-145">Чтобы подписаться на эти методы, вызов <xref:System.Windows.Input.StylusPlugIns.RawStylusInput.NotifyWhenProcessed%2A> метод в методе, который генерируется в потоке пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-145">To subscribe to these methods, call the <xref:System.Windows.Input.StylusPlugIns.RawStylusInput.NotifyWhenProcessed%2A> method in the method that occurs on the pen thread.</span></span>  
  
 <span data-ttu-id="7d112-146">На следующей схеме показана связь между потоком пера и поток пользовательского интерфейса по отношению к событиям пера <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn>.</span><span class="sxs-lookup"><span data-stu-id="7d112-146">The following diagram illustrates the relationship between the pen thread and UI thread with respect to the stylus events of a <xref:System.Windows.Input.StylusPlugIns.StylusPlugIn>.</span></span>  
  
 <span data-ttu-id="7d112-147">![Потоковые модели рукописного ввода &#40;пользовательский Интерфейс и перо&#41;](./media/inkthreading-plugincallbacks.png "InkThreading_PluginCallbacks")</span><span class="sxs-lookup"><span data-stu-id="7d112-147">![Ink Threading Models &#40;UI and Pen&#41;](./media/inkthreading-plugincallbacks.png "InkThreading_PluginCallbacks")</span></span>  
  
## <a name="rendering-ink"></a><span data-ttu-id="7d112-148">Отрисовка рукописных данных</span><span class="sxs-lookup"><span data-stu-id="7d112-148">Rendering Ink</span></span>  
 <span data-ttu-id="7d112-149">Когда пользователь рисует штрих, <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> отображает рукописные данные в отдельном потоке, поэтому данные для «поток» от пера даже в том случае, если поток пользовательского интерфейса занят.</span><span class="sxs-lookup"><span data-stu-id="7d112-149">As the user draws a stroke, <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> renders the ink on a separate thread so the ink appears to "flow" from the pen even when the UI thread is busy.</span></span>  <span data-ttu-id="7d112-150"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Строит визуальное дерево на поток динамической отрисовки, так как он собирает точки пера.</span><span class="sxs-lookup"><span data-stu-id="7d112-150">The <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> builds a visual tree on the dynamic rendering thread as it collects stylus points.</span></span>  <span data-ttu-id="7d112-151">Когда пользователь заканчивает штриха, <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> запрашивает получать уведомления, когда приложение выполняет следующего прохода отрисовки.</span><span class="sxs-lookup"><span data-stu-id="7d112-151">When the user finishes the stroke, the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> asks to be notified when the application does the next rendering pass.</span></span>  <span data-ttu-id="7d112-152">После следующего прохода отрисовки, завершения работы приложения <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> очищает его визуального дерева.</span><span class="sxs-lookup"><span data-stu-id="7d112-152">After the application completes the next rendering pass, the <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> cleans up its visual tree.</span></span>  <span data-ttu-id="7d112-153">Следующая диаграмма иллюстрирует этот процесс.</span><span class="sxs-lookup"><span data-stu-id="7d112-153">The following diagram illustrates this process.</span></span>  
  
 <span data-ttu-id="7d112-154">![Рукописный ввод, схема потоков](./media/inkthreading-visualtree.png "InkThreading_VisualTree")</span><span class="sxs-lookup"><span data-stu-id="7d112-154">![Ink threading diagram](./media/inkthreading-visualtree.png "InkThreading_VisualTree")</span></span>  
  
1. <span data-ttu-id="7d112-155">Пользователь начинает штриха.</span><span class="sxs-lookup"><span data-stu-id="7d112-155">The user begins the stroke.</span></span>  
  
    1. <span data-ttu-id="7d112-156"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Создает визуальное дерево.</span><span class="sxs-lookup"><span data-stu-id="7d112-156">The <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> creates the visual tree.</span></span>  
  
2. <span data-ttu-id="7d112-157">Пользователь рисует штрих.</span><span class="sxs-lookup"><span data-stu-id="7d112-157">The user is drawing the stroke.</span></span>  
  
    1. <span data-ttu-id="7d112-158"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Строит визуальное дерево.</span><span class="sxs-lookup"><span data-stu-id="7d112-158">The <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> builds the visual tree.</span></span>  
  
3. <span data-ttu-id="7d112-159">Пользователь завершает штриха.</span><span class="sxs-lookup"><span data-stu-id="7d112-159">The user ends the stroke.</span></span>  
  
    1. <span data-ttu-id="7d112-160"><xref:System.Windows.Controls.InkPresenter> Добавляет штрих в визуальном дереве.</span><span class="sxs-lookup"><span data-stu-id="7d112-160">The <xref:System.Windows.Controls.InkPresenter> adds the stroke to its visual tree.</span></span>  
  
    2. <span data-ttu-id="7d112-161">Уровень интеграции мультимедиа (MIL) статически отображает штрихи.</span><span class="sxs-lookup"><span data-stu-id="7d112-161">The Media Integration Layer (MIL) statically renders the strokes.</span></span>  
  
    3. <span data-ttu-id="7d112-162"><xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> Очищает визуальные элементы.</span><span class="sxs-lookup"><span data-stu-id="7d112-162">The <xref:System.Windows.Input.StylusPlugIns.DynamicRenderer> cleans up the visuals.</span></span>
