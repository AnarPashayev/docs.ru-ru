---
title: Практическое руководство. Диагностика проблем при выполнении заданий печати
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
- cpp
helpviewer_keywords:
- troubleshooting print job problems [WPF]
- print jobs [WPF], troubleshooting
- print jobs [WPF], diagnosing problems
ms.assetid: b081a170-84c6-48f9-a487-5766a8d58a82
ms.openlocfilehash: 181248f69684860fd43648952ef4eb3cced1c0ba
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/22/2019
ms.locfileid: "69944639"
---
# <a name="how-to-diagnose-problematic-print-job"></a><span data-ttu-id="2fe93-102">Практическое руководство. Диагностика проблем при выполнении заданий печати</span><span class="sxs-lookup"><span data-stu-id="2fe93-102">How to: Diagnose Problematic Print Job</span></span>
<span data-ttu-id="2fe93-103">Администраторы сетей часто получают от пользователей жалобы на то, что задания печати не выполняются или выполняются слишком медленно.</span><span class="sxs-lookup"><span data-stu-id="2fe93-103">Network administrators often field complaints from users about print jobs that do not print or print slowly.</span></span> <span data-ttu-id="2fe93-104">Широкий набор свойств задания печати, предоставляемых в API Microsoft .NET Framework, предоставляет средства для быстрой удаленной диагностики заданий печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-104">The rich set of print job properties exposed in the APIs of Microsoft .NET Framework provide a means for performing a rapid remote diagnosis of print jobs.</span></span>  
  
## <a name="example"></a><span data-ttu-id="2fe93-105">Пример</span><span class="sxs-lookup"><span data-stu-id="2fe93-105">Example</span></span>  
 <span data-ttu-id="2fe93-106">Ниже представлены основные этапы создания подобной служебной программы.</span><span class="sxs-lookup"><span data-stu-id="2fe93-106">The major steps for creating this kind of utility are as follows.</span></span>  
  
1. <span data-ttu-id="2fe93-107">Определите, на какое задание печати жалуется пользователь.</span><span class="sxs-lookup"><span data-stu-id="2fe93-107">Identify the print job that the user is complaining about.</span></span> <span data-ttu-id="2fe93-108">Части пользователи не могут указать его точно.</span><span class="sxs-lookup"><span data-stu-id="2fe93-108">Users often cannot do this precisely.</span></span> <span data-ttu-id="2fe93-109">Они могут не знать имена серверов печати или принтеров.</span><span class="sxs-lookup"><span data-stu-id="2fe93-109">They may not know the names of the print servers or printers.</span></span> <span data-ttu-id="2fe93-110">Они могут описывать расположение принтера в терминологии, отличной от той, которая использовалась для <xref:System.Printing.PrintQueue.Location%2A> установки его свойства.</span><span class="sxs-lookup"><span data-stu-id="2fe93-110">They may describe the location of the printer in different terminology than was used in setting its <xref:System.Printing.PrintQueue.Location%2A> property.</span></span> <span data-ttu-id="2fe93-111">В связи с этим будет полезно составить список задач, отправленных пользователем на данный момент.</span><span class="sxs-lookup"><span data-stu-id="2fe93-111">Accordingly, it is a good idea to generate a list of the user's currently submitted jobs.</span></span> <span data-ttu-id="2fe93-112">Если их несколько, определить, какое именно задание вызывает проблемы, позволит взаимодействие между пользователем и системным администратором печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-112">If there is more than one, then communication between the user and the print system administrator can be used to pinpoint the job that is having problems.</span></span> <span data-ttu-id="2fe93-113">Порядок действий при этом следующий:</span><span class="sxs-lookup"><span data-stu-id="2fe93-113">The substeps are as follows.</span></span>  
  
    1. <span data-ttu-id="2fe93-114">Получите список всех серверов печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-114">Obtain a list of all print servers.</span></span>  
  
    2. <span data-ttu-id="2fe93-115">Выполните циклический просмотр всех серверов, чтобы запросить их очереди печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-115">Loop through the servers to query their print queues.</span></span>  
  
    3. <span data-ttu-id="2fe93-116">Для каждого сервера выполните циклический просмотр всех очередей сервера, чтобы запросить их задания.</span><span class="sxs-lookup"><span data-stu-id="2fe93-116">Within each pass of the server loop, loop through all the server's queues to query their jobs</span></span>  
  
    4. <span data-ttu-id="2fe93-117">Для каждого цикла очереди выполните циклический просмотр ее заданий и соберите идентификационные данные заданий, отправленных подавшим жалобу пользователем.</span><span class="sxs-lookup"><span data-stu-id="2fe93-117">Within each pass of the queue loop, loop through its jobs and gather identifying information about those that were submitted by the complaining user.</span></span>  
  
2. <span data-ttu-id="2fe93-118">Обнаружив проблемное задание, изучите соответствующие свойства, чтобы узнать, в чем может быть проблема.</span><span class="sxs-lookup"><span data-stu-id="2fe93-118">When the problematic print job has been identified, examine relevant properties to see what might be the problem.</span></span> <span data-ttu-id="2fe93-119">Например, определите, находится ли задание в состоянии ошибки и не отключился ли обслуживающий очередь принтер от сети перед печатью задания.</span><span class="sxs-lookup"><span data-stu-id="2fe93-119">For example, is job in an error state or did the printer servicing the queue go offline before the job could print?</span></span>  
  
 <span data-ttu-id="2fe93-120">Приведенный ниже код представляет собой последовательность примеров кода.</span><span class="sxs-lookup"><span data-stu-id="2fe93-120">The code below is series of code examples.</span></span> <span data-ttu-id="2fe93-121">Код в первом примере кода содержит циклический просмотр очередей печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-121">The first code example contains the loop through the print queues.</span></span> <span data-ttu-id="2fe93-122">(Шаг 1c выше.) `myPrintQueues` Переменная<xref:System.Printing.PrintQueueCollection> является объектом для текущего сервера печати.</span><span class="sxs-lookup"><span data-stu-id="2fe93-122">(Step 1c above.) The variable `myPrintQueues` is the <xref:System.Printing.PrintQueueCollection> object for the current print server.</span></span>  
  
 <span data-ttu-id="2fe93-123">В начале примера кода выполняется обновление текущего объекта очереди печати с помощью <xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="2fe93-123">The code example begins by refreshing the current print queue object with <xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="2fe93-124">Это гарантирует, что свойства объекта точно отображают состояние физического принтера, который он представляет.</span><span class="sxs-lookup"><span data-stu-id="2fe93-124">This ensures that the object's properties accurately represent the state of the physical printer that it represents.</span></span> <span data-ttu-id="2fe93-125">Затем приложение получает коллекцию заданий печати, находящихся в очереди на печать, с <xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A>помощью.</span><span class="sxs-lookup"><span data-stu-id="2fe93-125">Then the application gets the collection of print jobs currently in the print queue by using <xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A>.</span></span>  
  
 <span data-ttu-id="2fe93-126">Затем приложение просматривает <xref:System.Printing.PrintSystemJobInfo> коллекцию и сравнивает каждое <xref:System.Printing.PrintSystemJobInfo.Submitter%2A> свойство с псевдонимом воданного пользователя.</span><span class="sxs-lookup"><span data-stu-id="2fe93-126">Next the application loops through the <xref:System.Printing.PrintSystemJobInfo> collection and compares each <xref:System.Printing.PrintSystemJobInfo.Submitter%2A> property with the alias of the complaining user.</span></span> <span data-ttu-id="2fe93-127">Если они совпадают, приложение добавляет идентификационные сведения о задании в предоставляемую строку.</span><span class="sxs-lookup"><span data-stu-id="2fe93-127">If they match, the application adds identifying information about the job to the string that will be presented.</span></span> <span data-ttu-id="2fe93-128">(Переменные `userName` и `jobList` инициализируются в приложении на более раннем этапе.)</span><span class="sxs-lookup"><span data-stu-id="2fe93-128">(The `userName` and `jobList` variables are initialized earlier in the application.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#enumeratejobsinqueues)]
 [!code-csharp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#enumeratejobsinqueues)]
 [!code-vb[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#enumeratejobsinqueues)]  
  
 <span data-ttu-id="2fe93-129">В следующем примере кода выбирается приложение с шага 2.</span><span class="sxs-lookup"><span data-stu-id="2fe93-129">The next code example picks up the application at Step 2.</span></span> <span data-ttu-id="2fe93-130">(См. выше.) Проблемное задание обнаружено, и приложение запрашивает данные, которые позволят его идентифицировать.</span><span class="sxs-lookup"><span data-stu-id="2fe93-130">(See above.) The problematic job has been identified and the application prompts for the information that will identify it.</span></span> <span data-ttu-id="2fe93-131">На основе этих сведений создаются <xref:System.Printing.PrintServer>объекты <xref:System.Printing.PrintQueue>, и <xref:System.Printing.PrintSystemJobInfo> .</span><span class="sxs-lookup"><span data-stu-id="2fe93-131">From this information it creates <xref:System.Printing.PrintServer>, <xref:System.Printing.PrintQueue>, and <xref:System.Printing.PrintSystemJobInfo> objects.</span></span>  
  
 <span data-ttu-id="2fe93-132">На этом этапе приложение содержит структуру ветвления, соответствующую двум способам проверки состояния заданий печати:</span><span class="sxs-lookup"><span data-stu-id="2fe93-132">At this point the application contains a branching structure corresponding to the two ways of checking a print job's status:</span></span>  
  
- <span data-ttu-id="2fe93-133">Можно прочитать флаги <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> свойства, имеющего тип <xref:System.Printing.PrintJobStatus>.</span><span class="sxs-lookup"><span data-stu-id="2fe93-133">You can read the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property which is of type <xref:System.Printing.PrintJobStatus>.</span></span>  
  
- <span data-ttu-id="2fe93-134">Можно прочитать каждое соответствующее свойство, <xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> например и. <xref:System.Printing.PrintSystemJobInfo.IsInError%2A></span><span class="sxs-lookup"><span data-stu-id="2fe93-134">You can read each relevant property such as <xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> and <xref:System.Printing.PrintSystemJobInfo.IsInError%2A>.</span></span>  
  
 <span data-ttu-id="2fe93-135">В этом примере демонстрируются оба метода, поэтому пользователю ранее было предложено, какой метод использовать, и ответил "Y", если ему нужно использовать флаги <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> свойства.</span><span class="sxs-lookup"><span data-stu-id="2fe93-135">This example demonstrates both methods, so the user was previously prompted as to which method to use and responded with "Y" if he or she wanted to use the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property.</span></span> <span data-ttu-id="2fe93-136">Ниже представлены подробные сведения об этих двух методах.</span><span class="sxs-lookup"><span data-stu-id="2fe93-136">See below for the details of the two methods.</span></span> <span data-ttu-id="2fe93-137">Наконец, для создания отчетов о возможности печати соответствующего задания в это время суток в приложении используется метод под названием **ReportQueueAndJobAvailability**.</span><span class="sxs-lookup"><span data-stu-id="2fe93-137">Finally, the application uses a method called **ReportQueueAndJobAvailability** to report on whether the job can be printed at this time of day.</span></span> <span data-ttu-id="2fe93-138">Этот метод обсуждается в разделе [Практическое руководство. Определение возможности печати в заданное время суток](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md).</span><span class="sxs-lookup"><span data-stu-id="2fe93-138">This method is discussed in [Discover Whether a Print Job Can Be Printed At This Time of Day](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md).</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#identifyanddiagnoseproblematicjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#identifyanddiagnoseproblematicjob)]
 [!code-vb[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#identifyanddiagnoseproblematicjob)]  
  
 <span data-ttu-id="2fe93-139">Чтобы проверить состояние задания печати с помощью флагов <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> свойства, необходимо проверить каждый соответствующий флаг, чтобы проверить, задан ли он.</span><span class="sxs-lookup"><span data-stu-id="2fe93-139">To check print job status using the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property, you check each relevant flag to see if it is set.</span></span> <span data-ttu-id="2fe93-140">Обычно определить, задан ли один бит в наборе битовых флагов, позволяет логическая операция И с набором флагов в качестве одной операнды и самим флагом в качестве второй.</span><span class="sxs-lookup"><span data-stu-id="2fe93-140">The standard way to see if one bit is set in a set of bit flags is to perform a logical AND operation with the set of flags as one operand and the flag itself as the other.</span></span> <span data-ttu-id="2fe93-141">Поскольку сам флаг имеет только один набор битов, результатом логической операции И может стать максимум установка самого бита.</span><span class="sxs-lookup"><span data-stu-id="2fe93-141">Since the flag itself has only one bit set, the result of the logical AND is that, at most, that same bit is set.</span></span> <span data-ttu-id="2fe93-142">Чтобы определить, установлен ли этот бит, просто сравните результат логической операции И с самим флагом.</span><span class="sxs-lookup"><span data-stu-id="2fe93-142">To find out whether it is or not, just compare the result of the logical AND with the flag itself.</span></span> <span data-ttu-id="2fe93-143">Дополнительные сведения см. в <xref:System.Printing.PrintJobStatus>разделе, [оператор & (C# Reference)](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-)и. <xref:System.FlagsAttribute></span><span class="sxs-lookup"><span data-stu-id="2fe93-143">For more information, see <xref:System.Printing.PrintJobStatus>, the [& Operator (C# Reference)](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-), and <xref:System.FlagsAttribute>.</span></span>  
  
 <span data-ttu-id="2fe93-144">Для каждого атрибута с заданным битом код передает соответствующие данные на экран консоли и иногда предлагает способы реагирования.</span><span class="sxs-lookup"><span data-stu-id="2fe93-144">For each attribute whose bit is set, the code reports this to the console screen and sometimes suggests a way to respond.</span></span> <span data-ttu-id="2fe93-145">(Метод **HandlePausedJob**, который вызывается в случае приостановки задания или очереди, описывается ниже.)</span><span class="sxs-lookup"><span data-stu-id="2fe93-145">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobattributes)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobattributes)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobattributes)]  
  
 <span data-ttu-id="2fe93-146">Чтобы проверить состояние задания печати с помощью отдельных свойств, просто прочтите каждое свойство и, если свойство имеет значение `true`, передайте данные на экран консоли и по возможности предложите способ реагирования.</span><span class="sxs-lookup"><span data-stu-id="2fe93-146">To check print job status using separate properties, you simply read each property and, if the property is `true`, report to the console screen and possibly suggest a way to respond.</span></span> <span data-ttu-id="2fe93-147">(Метод **HandlePausedJob**, который вызывается в случае приостановки задания или очереди, описывается ниже.)</span><span class="sxs-lookup"><span data-stu-id="2fe93-147">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobproperties)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobproperties)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobproperties)]  
  
 <span data-ttu-id="2fe93-148">Метод **HandlePausedJob** позволяет пользователю приложения удаленно возобновлять приостановленные задания.</span><span class="sxs-lookup"><span data-stu-id="2fe93-148">The **HandlePausedJob** method enables the application's user to remotely resume paused jobs.</span></span> <span data-ttu-id="2fe93-149">Поскольку приостановка очереди печати может быть связана именно с этим, метод начинается с запроса решения пользователя о его возобновлении.</span><span class="sxs-lookup"><span data-stu-id="2fe93-149">Because there might be a good reason why the print queue was paused, the method begins by prompting for a user decision about whether to resume it.</span></span> <span data-ttu-id="2fe93-150">Если ответ имеет значение «Y», <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType> вызывается метод.</span><span class="sxs-lookup"><span data-stu-id="2fe93-150">If the answer is "Y", then the <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType> method is called.</span></span>  
  
 <span data-ttu-id="2fe93-151">Затем пользователю предлагается решить, следует ли возобновить само задание печати (на случай, если оно было приостановлено независимо от очереди печати).</span><span class="sxs-lookup"><span data-stu-id="2fe93-151">Next the user is prompted to decide if the job itself should be resumed, just in case it is paused independently of the print queue.</span></span> <span data-ttu-id="2fe93-152">(Сравнение <xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType> и <xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType>.) Если ответ равен «Y», то <xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType> вызывается; в противном случае <xref:System.Printing.PrintSystemJobInfo.Cancel%2A> вызывается.</span><span class="sxs-lookup"><span data-stu-id="2fe93-152">(Compare <xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType> and <xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType>.) If the answer is "Y", then <xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType> is called; otherwise <xref:System.Printing.PrintSystemJobInfo.Cancel%2A> is called.</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#handlepausedjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#handlepausedjob)]
 [!code-vb[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#handlepausedjob)]  
  
## <a name="see-also"></a><span data-ttu-id="2fe93-153">См. также</span><span class="sxs-lookup"><span data-stu-id="2fe93-153">See also</span></span>

- <xref:System.Printing.PrintJobStatus>
- <xref:System.Printing.PrintSystemJobInfo>
- <xref:System.FlagsAttribute>
- <xref:System.Printing.PrintQueue>
- [<span data-ttu-id="2fe93-154">Оператор & (C# Reference)</span><span class="sxs-lookup"><span data-stu-id="2fe93-154">& Operator (C# Reference)</span></span>](../../../csharp/language-reference/operators/bitwise-and-shift-operators.md#logical-and-operator-)
- [<span data-ttu-id="2fe93-155">Документы в WPF</span><span class="sxs-lookup"><span data-stu-id="2fe93-155">Documents in WPF</span></span>](documents-in-wpf.md)
- [<span data-ttu-id="2fe93-156">Общие сведения о печати</span><span class="sxs-lookup"><span data-stu-id="2fe93-156">Printing Overview</span></span>](printing-overview.md)
