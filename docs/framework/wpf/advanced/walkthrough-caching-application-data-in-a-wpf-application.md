---
title: Пошаговое руководство. Кэширование данных приложения WPF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- walkthroughs [WPF], caching
- caching [.NET Framework]
- caching [WPF]
ms.assetid: dac2c9ce-042b-4d23-91eb-28f584415cef
ms.openlocfilehash: 922d91466731b331cc409cc362c4ada2c287916a
ms.sourcegitcommit: 5fb5b6520b06d7f5e6131ec2ad854da302a28f2e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/03/2019
ms.locfileid: "74715890"
---
# <a name="walkthrough-caching-application-data-in-a-wpf-application"></a>Пошаговое руководство. Кэширование данных приложения WPF
Кэширование позволяет хранить данные в памяти для быстрого доступа. При повторном доступе к данным приложения могут получать их из кэша вместо извлечения из исходного источника. Это может повысить производительность и масштабируемость. Кроме того, кэширование обеспечивает доступность данных при временной недоступности источника данных.

 .NET Framework предоставляет классы, позволяющие использовать кэширование в приложениях .NET Framework. Эти классы находятся в пространстве имен <xref:System.Runtime.Caching>.

> [!NOTE]
> Пространство имен <xref:System.Runtime.Caching> является новым в .NET Framework 4. Это пространство имен делает кэширование доступным для всех .NET Framework приложений. В предыдущих версиях .NET Framework кэширование было доступно только в пространстве имен <xref:System.Web> и, следовательно, требовало зависимости от классов ASP.NET.

 В этом пошаговом руководстве показано, как использовать функции кэширования, доступные в .NET Framework в составе [!INCLUDE[TLA#tla_winclient](../../../../includes/tlasharptla-winclient-md.md)] приложения. В этом пошаговом руководстве вы кэшируете содержимое текстового файла.

 В данном пошаговом руководстве представлены следующие задачи:

- Создание проекта приложения WPF.

- Добавление ссылки на .NET Framework 4.

- Инициализация кэша.

- Добавление записи кэша, содержащей содержимое текстового файла.

- Предоставление политики вытеснения для записи кэша.

- Мониторинг пути к кэшированному файлу и уведомление экземпляра кэша об изменениях отслеживаемого элемента.

## <a name="prerequisites"></a>Необходимые компоненты
 Для выполнения данного пошагового руководства требуется:

- Visual Studio 2010.

- Текстовый файл, содержащий небольшой объем текста. (Содержимое текстового файла будет отображаться в окне сообщения.) В коде, показанном в пошаговом руководстве, предполагается, что вы работаете со следующим файлом:

     `c:\cache\cacheText.txt`

     Однако можно использовать любой текстовый файл и внести небольшие изменения в код в этом пошаговом руководстве.

## <a name="creating-a-wpf-application-project"></a>Создание проекта приложения WPF
 Сначала вы создадите проект приложения WPF.

#### <a name="to-create-a-wpf-application"></a>Создание приложения WPF

1. Запустите Visual Studio.

2. В меню **файл** выберите пункт **создать**, а затем щелкните **Новый проект**.

     Откроется диалоговое окно **Новый проект**.

3. В разделе **Установленные шаблоны**выберите язык программирования, который необходимо использовать (**Visual Basic** или **Visual C#** ).

4. В диалоговом окне **Новый проект** выберите **приложение WPF**.

    > [!NOTE]
    > Если шаблон **приложения WPF** не отображается, убедитесь, что выбрана версия .NET Framework, поддерживающая WPF. В диалоговом окне **Новый проект** выберите .NET Framework 4 из списка.

5. В текстовом поле **имя** введите имя проекта. Например, можно ввести **впфкачинг**.

6. Установите флажок **Создать каталог для решения**.

7. Нажмите кнопку **ОК**.

     Конструктор WPF откроется в режиме **конструктора** и отобразит файл MainWindow. XAML. Visual Studio создаст папку **My Project** , файл Application. XAML и файл MainWindow. XAML.

## <a name="targeting-the-net-framework-and-adding-a-reference-to-the-caching-assemblies"></a>Нацеливание на .NET Framework и Добавление ссылки на сборки кэширования
 По умолчанию приложения WPF ориентированы на клиентский профиль .NET Framework 4. Чтобы использовать пространство имен <xref:System.Runtime.Caching> в приложении WPF, приложение должно быть предназначено для .NET Framework 4 (а не для клиентского профиля .NET Framework 4) и должно включать ссылку на пространство имен.

 Поэтому следующим шагом является изменение целевого объекта .NET Framework и Добавление ссылки на пространство имен <xref:System.Runtime.Caching>.

> [!NOTE]
> Процедура изменения целевого объекта .NET Framework отличается в проекте Visual Basic и в визуальном C# проекте.

#### <a name="to-change-the-target-net-framework-in-visual-basic"></a>Изменение целевого .NET Framework в Visual Basic

1. В **обозревателе решений**щелкните правой кнопкой мыши имя проекта и выберите пункт **свойства**.

     Откроется окно свойств приложения.

2. Откройте вкладку **Компиляция**.

3. В нижней части окна щелкните **Дополнительные параметры компиляции...** .

     Откроется диалоговое окно **Дополнительные параметры компилятора** .

4. В списке **Целевая платформа (все конфигурации)** выберите .NET Framework 4. (Не выбирайте .NET Framework 4-клиентский профиль.)

5. Нажмите кнопку **ОК**.

     Откроется диалоговое окно **Изменение целевой рабочей среды**.

6. В диалоговом окне **Изменение целевой платформы** нажмите кнопку **Да**.

     Проект будет закрыт и снова открыт.

7. Добавьте ссылку на сборку Caching, выполнив следующие действия.

    1. В **Обозреватель решений**щелкните правой кнопкой мыши имя проекта и выберите команду **Добавить ссылку**.

    2. Перейдите на вкладку **.NET** , выберите `System.Runtime.Caching`и нажмите кнопку **ОК**.

#### <a name="to-change-the-target-net-framework-in-a-visual-c-project"></a>Изменение целевого .NET Framework в визуальном C# проекте

1. В **Обозреватель решений**щелкните правой кнопкой мыши имя проекта и выберите пункт **свойства**.

     Откроется окно свойств приложения.

2. Перейдите на вкладку **Приложение** .

3. В списке **Целевая платформа** выберите .NET Framework 4. (Не выбирайте **.NET Framework 4-клиентский профиль**.)

4. Добавьте ссылку на сборку Caching, выполнив следующие действия.

    1. Щелкните правой кнопкой мыши папку **ссылки** и выберите команду **Добавить ссылку**.

    2. Перейдите на вкладку **.NET** , выберите `System.Runtime.Caching`и нажмите кнопку **ОК**.

## <a name="adding-a-button-to-the-wpf-window"></a>Добавление кнопки в окно WPF
 Далее предстоит добавить элемент управления Button и создать обработчик событий для `Click` события кнопки. Позже вы добавите код, чтобы при нажатии кнопки содержимое текстового файла кэшируется и отображалось.

#### <a name="to-add-a-button-control"></a>Добавление элемента управления "Кнопка"

1. В **Обозреватель решений**дважды щелкните файл MainWindow. XAML, чтобы открыть его.

2. На **панели элементов**в разделе **Общие элементы управления WPF**перетащите элемент управления `Button` в окно `MainWindow`.

3. В окне **Свойства** задайте для свойства `Content` элемента управления `Button` значение **получить кэш**.

## <a name="initializing-the-cache-and-caching-an-entry"></a>Инициализация кэша и кэширование записи
 Далее предстоит добавить код для выполнения следующих задач:

- Создайте экземпляр класса Cache, то есть будет создан экземпляр нового объекта <xref:System.Runtime.Caching.MemoryCache>.

- Укажите, что кэш использует объект <xref:System.Runtime.Caching.HostFileChangeMonitor> для отслеживания изменений в текстовом файле.

- Чтение текстового файла и кэширование его содержимого в виде записи кэша.

- Отображает содержимое кэшированного текстового файла.

#### <a name="to-create-the-cache-object"></a>Создание объекта Cache

1. Дважды щелкните только что добавленную кнопку, чтобы создать обработчик событий в файле MainWindow.xaml.cs или MainWindow. XAML. vb.

2. В верхней части файла (перед объявлением класса) добавьте следующие операторы `Imports` (Visual Basic) или `using` (C#):

    ```csharp
    using System.Runtime.Caching;
    using System.IO;
    ```

    ```vb
    Imports System.Runtime.Caching
    Imports System.IO
    ```

3. В обработчике событий добавьте следующий код для создания экземпляра объекта кэша:

    ```csharp
    ObjectCache cache = MemoryCache.Default;
    ```

    ```vb
    Dim cache As ObjectCache = MemoryCache.Default
    ```

     Класс <xref:System.Runtime.Caching.ObjectCache> является встроенным классом, который предоставляет кэш объектов в памяти.

4. Добавьте следующий код для чтения содержимого записи кэша с именем `filecontents`:

    ```vb
    Dim fileContents As String = TryCast(cache("filecontents"), String)
    ```

    ```csharp
    string fileContents = cache["filecontents"] as string;
    ```

5. Добавьте следующий код, чтобы проверить, существует ли запись кэша с именем `filecontents`:

    ```vb
    If fileContents Is Nothing Then

    End If
    ```

    ```csharp
    if (fileContents == null)
    {

    }
    ```

     Если указанная запись кэша не существует, необходимо прочитать текстовый файл и добавить его в кэш в качестве записи кэша.

6. В блоке `if/then` добавьте следующий код, чтобы создать новый объект <xref:System.Runtime.Caching.CacheItemPolicy>, указывающий, что срок действия записи кэша истекает через 10 секунд.

    ```vb
    Dim policy As New CacheItemPolicy()
    policy.AbsoluteExpiration = DateTimeOffset.Now.AddSeconds(10.0)
    ```

    ```csharp
    CacheItemPolicy policy = new CacheItemPolicy();
    policy.AbsoluteExpiration = DateTimeOffset.Now.AddSeconds(10.0);
    ```

     Если сведения о вытеснении или истечении срока действия не указаны, значение по умолчанию — <xref:System.Runtime.Caching.ObjectCache.InfiniteAbsoluteExpiration>. Это означает, что срок действия записей кэша никогда не истекает на основе только абсолютного времени. Вместо этого срок действия записей кэша истекает только в случае нехватки памяти. Рекомендуется всегда явно предоставлять либо абсолютный, либо скользящий срок действия.

7. В блоке `if/then` и после кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы создать коллекцию для путей к файлам, которые требуется отслеживать, а также для добавления пути к текстовому файлу в коллекцию:

    ```vb
    Dim filePaths As New List(Of String)()
    filePaths.Add("c:\cache\cacheText.txt")
    ```

    ```csharp
    List<string> filePaths = new List<string>();
    filePaths.Add("c:\\cache\\cacheText.txt");
    ```

    > [!NOTE]
    > Если нужный текстовый файл не `c:\cache\cacheText.txt`, укажите путь, по которому следует использовать текстовый файл.

8. После кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы добавить новый объект <xref:System.Runtime.Caching.HostFileChangeMonitor> в коллекцию мониторов изменений для записи кэша:

    ```vb
    policy.ChangeMonitors.Add(New HostFileChangeMonitor(filePaths))
    ```

    ```csharp
    policy.ChangeMonitors.Add(new HostFileChangeMonitor(filePaths));
    ```

     Объект <xref:System.Runtime.Caching.HostFileChangeMonitor> отслеживает путь к текстовому файлу и уведомляет кэш, если происходят изменения. В этом примере срок действия записи кэша истечет при изменении содержимого файла.

9. После кода, добавленного на предыдущем шаге, добавьте следующий код для чтения содержимого текстового файла:

    ```vb
    fileContents = File.ReadAllText("c:\cache\cacheText.txt") & vbCrLf & DateTime.Now.ToString()
    ```

    ```csharp
    fileContents = File.ReadAllText("c:\\cache\\cacheText.txt") + "\n" + DateTime.Now;
    ```

     Добавлена метка даты и времени, чтобы вы могли увидеть, когда истечет срок действия записи кэша.

10. После кода, добавленного на предыдущем шаге, добавьте следующий код, чтобы вставить содержимое файла в объект кэша в качестве экземпляра <xref:System.Runtime.Caching.CacheItem>:

    ```vb
    cache.Set("filecontents", fileContents, policy)
    ```

    ```csharp
    cache.Set("filecontents", fileContents, policy);
    ```

     Укажите сведения о том, как запись кэша должна быть удалена путем передачи объекта <xref:System.Runtime.Caching.CacheItemPolicy>, созданного ранее в качестве параметра.

11. После блока `if/then` добавьте следующий код для вывода содержимого кэшированного файла в окне сообщения:

    ```vb
    MessageBox.Show(fileContents)
    ```

    ```csharp
    MessageBox.Show(fileContents);
    ```

12. В меню **Сборка** выберите команду **построить впфкачинг** , чтобы выполнить сборку проекта.

## <a name="testing-caching-in-the-wpf-application"></a>Тестирование кэширования в приложении WPF
 Теперь можно протестировать приложение.

#### <a name="to-test-caching-in-the-wpf-application"></a>Тестирование кэширования в приложении WPF

1. Нажмите CTRL+F5, чтобы запустить приложение.

     Откроется окно `MainWindow`.

2. Нажмите кнопку **получить кэш**.

     Кэшированное содержимое из текстового файла отображается в окне сообщения. Обратите внимание на метку времени файла.

3. Закройте окно сообщения и нажмите кнопку **получить кэш** еще раз.

     Метка времени не изменена. Это означает, что отображается кэшированное содержимое.

4. Подождите 10 секунд или более и нажмите кнопку **получить кэш** еще раз.

     На этот раз отображается новая метка времени. Это означает, что политика разрешит срок действия записи кэша и отобразится новое кэшированное содержимое.

5. В текстовом редакторе откройте созданный текстовый файл. Пока не вносите никаких изменений.

6. Закройте окно сообщения и нажмите кнопку **получить кэш** еще раз.

     Обратите внимание на метку времени.

7. Внесите изменения в текстовый файл, а затем сохраните файл.

8. Закройте окно сообщения и нажмите кнопку **получить кэш** еще раз.

     Это окно сообщения содержит обновленное содержимое из текстового файла и новую метку времени. Это означает, что монитор изменений файлов узла удалил запись кэша сразу после изменения файла, несмотря на то, что истек период времени ожидания.

    > [!NOTE]
    > Время вытеснения можно увеличить до 20 секунд или больше, чтобы больше времени можно было внести изменения в файл.

## <a name="code-example"></a>Пример кода
 После завершения этого пошагового руководства код для созданного проекта будет похож на следующий пример.

 [!code-csharp[CachingWPFApplications#1](~/samples/snippets/csharp/VS_Snippets_Wpf/CachingWPFApplications/CSharp/MainWindow.xaml.cs#1)]
 [!code-vb[CachingWPFApplications#1](~/samples/snippets/visualbasic/VS_Snippets_Wpf/CachingWPFApplications/VisualBasic/MainWindow.xaml.vb#1)]

## <a name="see-also"></a>См. также:

- <xref:System.Runtime.Caching.MemoryCache>
- <xref:System.Runtime.Caching.ObjectCache>
- <xref:System.Runtime.Caching>
- [Кэширование в приложениях платформы .NET Framework](../../performance/caching-in-net-framework-applications.md)
