---
title: Безопасность частичного доверия в WPF
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- partial trust security [WPF]
- detecting permissions [WPF]
- security settings for Internet Explorer [WPF]
- partial trust applications [WPF], debugging
- permissions [WPF], managing
- debugging partial trust applications [WPF]
- permissions [WPF], detecting
- feature security requirements [WPF]
- managing permissions [WPF]
ms.assetid: ef2c0810-1dbf-4511-babd-1fab95b523b5
ms.openlocfilehash: ce9341a45b43c4af4543cf473597c273c33701fc
ms.sourcegitcommit: 7bc6887ab658550baa78f1520ea735838249345e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/03/2020
ms.locfileid: "75636553"
---
# <a name="wpf-partial-trust-security"></a>Безопасность частичного доверия в WPF
<a name="introduction"></a> Как правило, интернет-приложениям следует ограничить прямой доступ к критическим системным ресурсам, чтобы избежать злонамеренного повреждения. По умолчанию HTML и языки сценариев на стороне клиента не могут получить доступ к критическим системным ресурсам. Поскольку приложения, размещаемые в браузере Windows Presentation Foundation (WPF), можно запускать из браузера, они должны соответствовать аналогичному набору ограничений. Чтобы обеспечить эти ограничения, WPF использует как разграничение доступа кода (CAS), так и ClickOnce (см. раздел [стратегия безопасности WPF — безопасность платформы](wpf-security-strategy-platform-security.md)). По умолчанию приложения, размещенные в браузере, запрашивают набор разрешений ЦС зоны Интернета, независимо от того, были ли они запущены из Интернета, из локальной интрасети или локального компьютера. Приложения, выполняющиеся с набором разрешений меньшим, чем полный набор, называют выполняющимися с частичным доверием.  
  
 WPF предоставляет широкие возможности поддержки, позволяющие безопасно использовать как можно больше функциональных возможностей при частичном доверии, а также с CAS обеспечивает дополнительную поддержку для программирования с частичным доверием.  
  
 В этом разделе содержатся следующие подразделы.  
  
- [Поддержка частичного доверия функциями WPF](#WPF_Feature_Partial_Trust_Support)  
  
- [Программирование в режиме частичного доверия](#Partial_Trust_Programming)  
  
- [Управление разрешениями](#Managing_Permissions)  
  
<a name="WPF_Feature_Partial_Trust_Support"></a>   
## <a name="wpf-feature-partial-trust-support"></a>Поддержка частичного доверия функциями WPF  
 В следующей таблице перечислены высокоуровневые функции Windows Presentation Foundation (WPF), которые можно использовать в ограничениях набора разрешений зоны Интернета.  
  
 Таблица 1. Функции WPF, которые являются безопасными в режиме частичного доверия  
  
|Область функции|Функция|  
|------------------|-------------|  
|Общие|Окно обозревателя<br /><br /> Доступ к исходному сайту<br /><br /> IsolatedStorage (ограничение 512 КБ)<br /><br /> Поставщики UIAutomation<br /><br /> Система команд<br /><br /> Редакторы метода ввода (IME)<br /><br /> Перо планшетного компьютера и рукописный ввод<br /><br /> Моделирование перетаскивания с помощью событий захвата и перемещения мыши<br /><br /> OpenFileDialog<br /><br /> Десериализация XAML (посредством XamlReader.Load)|  
|Веб-интеграция|Диалоговое окно загрузки браузера<br /><br /> Навигация верхнего уровня, инициированная пользователем<br /><br /> mailto:links<br /><br /> Параметры универсального идентификатора ресурса (URI)<br /><br /> HTTPWebRequest<br /><br /> Содержимое WPF, размещенное в IFRAME<br /><br /> Размещение HTML-страниц одного веб-сайта с помощью Frame<br /><br /> Размещение HTML-страниц одного веб-сайта с помощью WebBrowser<br /><br /> Веб-службы (ASMX-файлы)<br /><br /> Веб-службы (с помощью Windows Communication Foundation)<br /><br /> Создание сценария<br /><br /> Модель DOM|  
|Визуальные элементы|2D- и 3D-графика<br /><br /> Анимация<br /><br /> Мультимедиа (исходный сайт и междоменные)<br /><br /> Обработка изображений/аудио/видео|  
|Чтение|FlowDocument<br /><br /> XPS-документы<br /><br /> Внедренные и системные шрифты<br /><br /> Шрифты CFF и TrueType|  
|Изменение|Проверка орфографии<br /><br /> RichTextBox<br /><br /> Поддержка буфера обмена для обычного текста и рукописного ввода<br /><br /> Вставка, инициированная пользователем<br /><br /> Копирование выделенного содержимого|  
|Элементы управления|Общие элементы управления|  
  
 В этой таблице описаны возможности WPF на высоком уровне. Для получения более подробных сведений Windows SDK документирует разрешения, необходимые для каждого элемента в WPF. Кроме того, следующие функции содержат более подробные сведения, касающиеся выполнения при частичном доверии, включая некоторые особые аспекты.  
  
- [!INCLUDE[TLA2#tla_xaml](../../../includes/tla2sharptla-xaml-md.md)] (см. [Общие сведения о XAML (WPF)](../../desktop-wpf/fundamentals/xaml.md)).  
  
- Всплывающие окна (см. <xref:System.Windows.Controls.Primitives.Popup?displayProperty=nameWithType>).  
  
- Перетаскивание (см. раздел [Общие сведения о перетаскивании](./advanced/drag-and-drop-overview.md)).  
  
- Буфер обмена (см. <xref:System.Windows.Clipboard?displayProperty=nameWithType>).  
  
- Imaging (см. <xref:System.Windows.Controls.Image?displayProperty=nameWithType>).  
  
- Сериализация (см. <xref:System.Windows.Markup.XamlReader.Load%2A?displayProperty=nameWithType>, <xref:System.Windows.Markup.XamlWriter.Save%2A?displayProperty=nameWithType>).  
  
- Диалоговое окно «Открытие файла» (см. <xref:Microsoft.Win32.OpenFileDialog?displayProperty=nameWithType>).  
  
 В следующей таблице описаны функции WPF, которые ненадежны для выполнения в пределах набора разрешений зоны Интернета.  
  
 Таблица 2. Функции WPF, которые не являются безопасными в режиме частичного доверия  
  
|Область функции|Функция|  
|------------------|-------------|  
|Общие|Окно (определенные приложением окна и диалоговые окна)<br /><br /> SaveFileDialog<br /><br /> Файловая система<br /><br /> Доступ к реестру<br /><br /> Перетаскивание<br /><br /> Сериализация XAML (через XamlWriter.Save)<br /><br /> Клиенты UIAutomation<br /><br /> Доступ к исходному окну (HwndHost)<br /><br /> Полная поддержка управления речью<br /><br /> Взаимодействие с Windows Forms|  
|Визуальные элементы|Эффекты для точечных рисунков<br /><br /> Кодирование изображений|  
|Изменение|Буфер обмена формата RTF<br /><br /> Полная поддержка XAML|  
  
<a name="Partial_Trust_Programming"></a>   
## <a name="partial-trust-programming"></a>Программирование в режиме частичного доверия  
 Для приложений XBAP код, превышающий набор разрешений по умолчанию, будет иметь различное поведение в зависимости от зоны безопасности. В некоторых случаях пользователь получит предупреждение при попытке установить приложение. Пользователь может выбрать продолжение или отмену установки. В следующей таблице описаны поведение приложения для каждой зоны безопасности и действия, необходимые для получения приложением полного доверия.  
  
|Зона безопасности|Поведение|Получение полного доверия|  
|-------------------|--------------|------------------------|  
|Локальный компьютер|Автоматическое получение полного доверия|Никакие действия не требуются.|  
|Интрасеть и надежные веб-сайты|Запрос полного доверия|Подпишите приложение XBAP с помощью сертификата, чтобы пользователь видел источник в запросе.|  
|Интернет|Сбой с сообщением "Доверие не оказано"|Подпишите приложение XBAP с помощью сертификата.|  
  
> [!NOTE]
> Поведение, описанное в предыдущей таблице, относится к приложениям XBAP с полным доверием, не следующим модели доверенного развертывания ClickOnce.  
  
 В общем случае код, который может превышать допустимые разрешения, вероятнее всего, является общим кодом, который совместно используется автономными и браузерными приложениями. CAS и WPF предлагают несколько методов для управления этим сценарием.  
  
<a name="Detecting_Permissions_using_CAS"></a>   
### <a name="detecting-permissions-using-cas"></a>Определение разрешений с помощью CAS  
 В некоторых ситуациях общий код в сборках библиотеки может использоваться как автономными приложениями, так и XBAP. В этих случаях код может выполнять функции, которые могут потребовать больше разрешений, чем позволяет набор разрешений, присвоенный приложению. Приложение может определить, имеет ли оно определенные разрешения с помощью Microsoft .NETной безопасности платформы. В частности, он может проверить наличие определенного разрешения, вызвав метод <xref:System.Security.CodeAccessPermission.Demand%2A> на экземпляре требуемого разрешения. Это показано в следующем примере, который содержит код, запрашивающий возможность сохранить файл на локальный диск.  
  
 [!code-csharp[PartialTrustSecurityOverviewSnippets#DetectPermsCODE1](~/samples/snippets/csharp/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/CSharp/FileHandling.cs#detectpermscode1)]
 [!code-vb[PartialTrustSecurityOverviewSnippets#DetectPermsCODE1](~/samples/snippets/visualbasic/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/VisualBasic/FileHandling.vb#detectpermscode1)]  
[!code-csharp[PartialTrustSecurityOverviewSnippets#DetectPermsCODE2](~/samples/snippets/csharp/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/CSharp/FileHandling.cs#detectpermscode2)]
[!code-vb[PartialTrustSecurityOverviewSnippets#DetectPermsCODE2](~/samples/snippets/visualbasic/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/VisualBasic/FileHandling.vb#detectpermscode2)]  
  
 Если приложение не имеет требуемых разрешений, вызов <xref:System.Security.CodeAccessPermission.Demand%2A> выдаст исключение безопасности. В противном случае разрешение будет предоставлено. `IsPermissionGranted` инкапсулирует это поведение и возвращает `true` или `false` соответствующим образом.  
  
<a name="Graceful_Degradation_of_Functionality"></a>   
### <a name="graceful-degradation-of-functionality"></a>Постепенное снижение функциональности  
 Возможность обнаружения у кода разрешений на выполнение действия представляет интерес для кода, который может выполняться из разных зон. Обнаружение зоны — это один из аспектов, однако рекомендуется по возможности предоставить пользователю альтернативу. Например, приложение с полным доверием обычно позволяет пользователям создавать файлы в любом расположении, тогда как приложение с частичным доверием может создавать файлы только в изолированном хранилище. Если код для создания файла существует в сборке, которая совместно используется приложениями с полным доверием (автономными) и приложениями с частичным доверием (размещенными в браузере), и оба приложения должны обеспечивать функцию создания файлов пользователем, общий код должен определить, выполняется ли он в режиме частичного или полного доверия перед созданием файла в соответствующем расположении. Оба варианта демонстрируются в следующем коде.  
  
 [!code-csharp[PartialTrustSecurityOverviewSnippets#DetectPermsGracefulCODE1](~/samples/snippets/csharp/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/CSharp/FileHandlingGraceful.cs#detectpermsgracefulcode1)]
 [!code-vb[PartialTrustSecurityOverviewSnippets#DetectPermsGracefulCODE1](~/samples/snippets/visualbasic/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/VisualBasic/FileHandlingGraceful.vb#detectpermsgracefulcode1)]  
[!code-csharp[PartialTrustSecurityOverviewSnippets#DetectPermsGracefulCODE2](~/samples/snippets/csharp/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/CSharp/FileHandlingGraceful.cs#detectpermsgracefulcode2)]
[!code-vb[PartialTrustSecurityOverviewSnippets#DetectPermsGracefulCODE2](~/samples/snippets/visualbasic/VS_Snippets_Wpf/PartialTrustSecurityOverviewSnippets/VisualBasic/FileHandlingGraceful.vb#detectpermsgracefulcode2)]  
  
 Во многих случаях вы сможете найти альтернативу частичному доверию.  
  
 В управляемой среде, такой как интрасеть, пользовательские управляемые платформы можно установить на клиентской базе в глобальный кэш сборок (GAC). Эти библиотеки могут выполнять код, требующий полного доверия, и ссылаться на них из приложений, которые разрешают только частичное доверие с помощью <xref:System.Security.AllowPartiallyTrustedCallersAttribute> (дополнительные сведения см. в статье [безопасность](security-wpf.md) и [стратегия безопасности WPF — безопасность платформы](wpf-security-strategy-platform-security.md)).  
  
<a name="Browser_Host_Detection"></a>   
### <a name="browser-host-detection"></a>Обнаружение узла браузера  
 Использование CAS для проверки разрешений является подходящим способом, если необходимо проверить на наличие разрешения. Тем не менее эта методика зависит от перехвата исключений в рамках нормальной обработки, что не рекомендуется в общем и может вызывать проблемы производительности. Вместо этого, если приложение браузера XAML (XBAP) выполняется только в песочнице зоны Интернета, можно использовать свойство <xref:System.Windows.Interop.BrowserInteropHelper.IsBrowserHosted%2A?displayProperty=nameWithType>, которое возвращает значение true для приложений браузера XAML (XBAP).  
  
> [!NOTE]
> <xref:System.Windows.Interop.BrowserInteropHelper.IsBrowserHosted%2A> различает только то, работает ли приложение в браузере, а не какой набор разрешений выполняется для приложения.  
  
<a name="Managing_Permissions"></a>   
## <a name="managing-permissions"></a>Управление разрешениями  
 По умолчанию XBAP выполняются с частичным доверием (набор разрешений зоны Интернета по умолчанию). Тем не менее в зависимости от требований приложения можно изменить набор разрешений по умолчанию. Например, если приложение XBAP запускается из локальной интрасети, оно может использовать преимущества расширенного набора разрешений, как показано в следующей таблице.  
  
 Таблица 3. Наборы разрешений LocalIntranet и Internet  
  
|Разрешение|Атрибут|LocalIntranet|Интернет|  
|----------------|---------------|-------------------|--------------|  
|DNS|Доступ к DNS-серверам|Да|Нет|  
|Переменные среды|Чтение|Да|Нет|  
|Диалоговые окна для работы с файлами|Open|Да|Да|  
|Диалоговые окна для работы с файлами|Без ограничений|Да|Нет|  
|Изолированное хранилище|Изоляция сборки по пользователю|Да|Нет|  
|Изолированное хранилище|Неизвестная изоляция|Да|Да|  
|Изолированное хранилище|Неограниченная квота для пользователя|Да|Нет|  
|Носитель|Безопасные аудио-, видеоданные и изображения|Да|Да|  
|Печать|Печать по умолчанию|Да|Нет|  
|Печать|Безопасная печать|Да|Да|  
|Отражение|Вывод|Да|Нет|  
|по безопасности|Выполнение управляемого кода|Да|Да|  
|по безопасности|Утверждение предоставленных разрешений|Да|Нет|  
|Пользовательский интерфейс|Без ограничений|Да|Нет|  
|Пользовательский интерфейс|Безопасные окна верхнего уровня|Да|Да|  
|Пользовательский интерфейс|Собственный буфер обмена|Да|Да|  
|Веб-браузер|Безопасная навигация по фреймам в HTML|Да|Да|  
  
> [!NOTE]
> Вырезание и вставка разрешены только в режиме частичного доверия при инициации пользователем.  
  
 Если вам требуется повысить уровень разрешений, необходимо изменить параметры проекта и манифест приложения ClickOnce. Дополнительные сведения см. в разделе [Общие сведения о приложениях браузера WPF XAML](./app-development/wpf-xaml-browser-applications-overview.md). Следующие документы также могут быть полезны.  
  
- [Mage.exe (средство создания и редактирования манифеста)](../tools/mage-exe-manifest-generation-and-editing-tool.md)  
  
- [MageUI.exe (средство создания и редактирования манифестов, графический клиент)](../tools/mageui-exe-manifest-generation-and-editing-tool-graphical-client.md)  
  
- [Защита приложений ClickOnce](/visualstudio/deployment/securing-clickonce-applications)  
  
 Если XBAP требует полного доверия, можно использовать те же средства для увеличения запрошенных разрешений. Несмотря на то, что приложение XBAP получает полное доверие, если оно установлено и запускается с локального компьютера, из интрасети или из URL-адреса, указанного в списке доверенных или разрешенных сайтов браузера. Если приложение установлено из интрасети или с доверенного сайта, пользователь получит стандартный запрос ClickOnce, уведомляющий о повышенных разрешениях. Пользователь может выбрать продолжение или отмену установки.  
  
 Кроме того, модель доверенного развертывания ClickOnce можно использовать для полностью доверенного развертывания из любой зоны безопасности. Дополнительные сведения см. в разделе [Общие сведения о развертывании доверенных приложений](/visualstudio/deployment/trusted-application-deployment-overview) и [Безопасность](security-wpf.md).  
  
## <a name="see-also"></a>См. также:

- [Security](security-wpf.md)
- [Стратегия безопасности WPF — безопасность платформы](wpf-security-strategy-platform-security.md)
- [Стратегия безопасности WPF — проектирование безопасности](wpf-security-strategy-security-engineering.md)
