---
ms.openlocfilehash: bd656478a55856e676853e57f3e7386ea0aa0211
ms.sourcegitcommit: e02d17b2cf9c1258dadda4810a5e6072a0089aee
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/01/2020
ms.locfileid: "85614825"
---
### <a name="currentculture-is-not-preserved-across-wpf-dispatcher-operations"></a><span data-ttu-id="72853-101">CurrentCulture не сохраняется в операциях диспетчера WPF</span><span class="sxs-lookup"><span data-stu-id="72853-101">CurrentCulture is not preserved across WPF Dispatcher operations</span></span>

#### <a name="details"></a><span data-ttu-id="72853-102">Подробнее</span><span class="sxs-lookup"><span data-stu-id="72853-102">Details</span></span>

<span data-ttu-id="72853-103">Начиная с версии .NET Framework 4.6, изменения <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> или <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>, внесенные в операции <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName>, будут утеряны в конце операции диспетчеризации.</span><span class="sxs-lookup"><span data-stu-id="72853-103">Beginning in the .NET Framework 4.6, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made within a <xref:System.Windows.Threading.Dispatcher?displayProperty=fullName> will be lost at the end of that dispatcher operation.</span></span> <span data-ttu-id="72853-104">Аналогичным образом, изменения <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> и <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>, внесенные за пределами операции Dispatcher, не будут учитываться при выполнении этой операции. С практической точки зрения это означает, что изменения <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> и <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> могут не передаваться между обратными вызовами пользовательского интерфейса WPF и другим кодом приложения WPF. Это связано с изменением в <xref:System.Threading.ExecutionContext?displayProperty=fullName>, в результате которого <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> и <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> сохраняются в контексте выполнения, начиная с приложений, предназначенных для версии .NET Framework 4.6.</span><span class="sxs-lookup"><span data-stu-id="72853-104">Similarly, changes to <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> made outside of a Dispatcher operation may not be reflected when that operation executes.Practically speaking, this means that <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> changes may not flow between WPF UI callbacks and other code in a WPF application.This is due to a change in <xref:System.Threading.ExecutionContext?displayProperty=fullName> that causes <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> to be stored in the execution context beginning with apps targeting the .NET Framework 4.6.</span></span> <span data-ttu-id="72853-105">Операции диспетчеризации WPF сохраняют контекст выполнения, который используется для запуска операции и восстановления предыдущего контекста при завершении операции.</span><span class="sxs-lookup"><span data-stu-id="72853-105">WPF dispatcher operations store the execution context used to begin the operation and restore the previous context when the operation is completed.</span></span> <span data-ttu-id="72853-106">Поскольку <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> и <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> теперь являются частью этого контекста, внесенные в рамках операции диспетчеризации изменения не сохраняются вне этой операции.</span><span class="sxs-lookup"><span data-stu-id="72853-106">Because <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are now part of that context, changes to them within a dispatcher operation are not persisted outside of the operation.</span></span>

#### <a name="suggestion"></a><span data-ttu-id="72853-107">Предложение</span><span class="sxs-lookup"><span data-stu-id="72853-107">Suggestion</span></span>

<span data-ttu-id="72853-108">В приложениях, затронутых данным изменением, можно обойти эту проблему, сохранив <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> или <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> в поле и проверив все тексты операций диспетчеризации (включая обработчики обратного вызова событий пользовательского интерфейса) на установку правильных значений <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> и <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>.</span><span class="sxs-lookup"><span data-stu-id="72853-108">Apps affected by this change may work around it by storing the desired <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> or <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> in a field and checking in all Dispatcher operation bodies (including UI event callback handlers) that the correct <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName> and <xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName> are set.</span></span> <span data-ttu-id="72853-109">Кроме того, поскольку изменение ExecutionContext, являющееся базовым для этого изменения WPF, влияет только на приложения, предназначенные для .NET Framework 4.6 или более поздних версий, это нарушение можно исключить путем нацеливания на .NET Framework 4.5.2. В приложениях, ориентированных на платформу .NET Framework 4.6 или более поздней версии, эту проблему можно обойти, установив следующий параметр совместимости:</span><span class="sxs-lookup"><span data-stu-id="72853-109">Alternatively, because the ExecutionContext change underlying this WPF change only affects apps targeting the .NET Framework 4.6 or newer, this break can be avoided by targeting the .NET Framework 4.5.2.Apps that target .NET Framework 4.6 or later can also work around this by setting the following compatibility switch:</span></span>

<pre><code class="lang-csharp">AppContext.SetSwitch(&quot;Switch.System.Globalization.NoAsyncCurrentCulture&quot;, true);&#13;&#10;</code></pre>

<span data-ttu-id="72853-110">Эта проблема была устранена с помощью WPF в .NET Framework 4.6.2.</span><span class="sxs-lookup"><span data-stu-id="72853-110">This issue has been fixed by WPF in .NET Framework 4.6.2.</span></span> <span data-ttu-id="72853-111">Она также была устранена в .NET Framework версий 4.6 и 4.6.1 посредством [KB 3139549](https://support.microsoft.com/kb/3139549).</span><span class="sxs-lookup"><span data-stu-id="72853-111">It has also been fixed in .NET Frameworks 4.6, 4.6.1 through [KB 3139549](https://support.microsoft.com/kb/3139549).</span></span> <span data-ttu-id="72853-112">Приложения, предназначенные для .NET Framework 4.6 или более поздней версии, автоматически получают правильное поведение в приложениях WPF — <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>) будет сохранено в операциях диспетчера.</span><span class="sxs-lookup"><span data-stu-id="72853-112">Applications targeting .NET Framework 4.6 or later will automatically get the right behavior in WPF applications - <xref:System.Globalization.CultureInfo.CurrentCulture?displayProperty=fullName>/<xref:System.Globalization.CultureInfo.CurrentUICulture?displayProperty=fullName>) would be preserved across Dispatcher operations.</span></span>

| <span data-ttu-id="72853-113">name</span><span class="sxs-lookup"><span data-stu-id="72853-113">Name</span></span>    | <span data-ttu-id="72853-114">Значение</span><span class="sxs-lookup"><span data-stu-id="72853-114">Value</span></span>       |
|:--------|:------------|
| <span data-ttu-id="72853-115">Область</span><span class="sxs-lookup"><span data-stu-id="72853-115">Scope</span></span>   | <span data-ttu-id="72853-116">Дополнительный номер</span><span class="sxs-lookup"><span data-stu-id="72853-116">Minor</span></span>       |
| <span data-ttu-id="72853-117">Version</span><span class="sxs-lookup"><span data-stu-id="72853-117">Version</span></span> | <span data-ttu-id="72853-118">4.6</span><span class="sxs-lookup"><span data-stu-id="72853-118">4.6</span></span>         |
| <span data-ttu-id="72853-119">Type</span><span class="sxs-lookup"><span data-stu-id="72853-119">Type</span></span>    | <span data-ttu-id="72853-120">Изменение целевой платформы</span><span class="sxs-lookup"><span data-stu-id="72853-120">Retargeting</span></span> |
